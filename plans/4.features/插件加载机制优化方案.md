# 插件加载机制优化方案

## 📋 当前实现分析

### 现有方案
1. **开发环境**：使用动态导入 `@plugins/...` 别名加载插件源码
2. **生产环境**：使用 script 标签加载 UMD 格式的构建产物

### 存在的问题

#### 1. 路径解析问题
- Vite 的动态导入（`import()`）默认不支持别名解析
- 使用 `@plugins` 别名可能导致路径解析失败
- 相对路径在动态导入中更可靠

#### 2. 构建格式问题
- UMD 格式需要全局变量，不够优雅
- 依赖外部化可能导致运行时问题
- ES Module 格式更适合现代浏览器

#### 3. 错误处理不足
- 缺少重试机制
- 错误信息不够清晰
- 没有加载状态管理

#### 4. 缺少插件生命周期管理
- 没有插件注册表
- 无法追踪插件加载状态
- 缺少插件卸载机制

## ✅ 优化方案

### 1. 统一使用 ES Modules

**改进点：**
- 开发和生产环境都使用动态导入
- 插件构建使用 ES Module 格式（而不是 UMD）
- 更符合现代前端开发规范

**实现：**
```typescript
// 开发环境：从源码加载
const pluginModule = await import('../../../riveredge-apps/kuaimes/frontend/src/index.tsx');

// 生产环境：从构建产物加载
const pluginModule = await import('/apps/kuaimes/index.es.js');
```

### 2. 改进路径解析

**改进点：**
- 使用相对路径而不是别名
- 添加路径解析函数，统一处理路径转换
- 支持开发和生产环境的路径差异

**实现：**
```typescript
function getPluginSourcePath(pluginCode: string): string {
  // 使用相对路径，从 src/utils/pluginLoader.ts 到 riveredge-apps
  return `../../../riveredge-apps/${pluginCode}/frontend/src/index.tsx`;
}
```

### 3. 添加插件注册表

**改进点：**
- 内存缓存已加载的插件
- 追踪插件加载状态（pending, loading, loaded, error）
- 记录加载时间和错误信息

**实现：**
```typescript
const pluginRegistry = new Map<string, PluginRegistryItem>();

interface PluginRegistryItem {
  application: Application;
  status: PluginLoadStatus;
  routes?: PluginRoute[];
  error?: Error;
  loadTime?: number;
}
```

### 4. 添加错误处理和重试机制

**改进点：**
- 使用 `withRetry` 工具函数实现重试
- 改进错误信息，提供更清晰的提示
- 区分网络错误和代码错误

**实现：**
```typescript
const pluginModule = await withRetry(
  async () => await import(sourcePath),
  {
    maxRetries: 2,
    retryDelay: 500,
    shouldRetry: (error) => {
      return error?.message?.includes('Failed to fetch') || 
             error?.message?.includes('404');
    },
  }
);
```

### 5. 改进插件构建配置

**改进点：**
- 使用 ES Module 格式（`formats: ['es']`）
- 移除 UMD 格式和全局变量
- 简化插件入口文件

**实现：**
```typescript
// vite.config.ts
build: {
  lib: {
    entry: resolve(__dirname, 'src/index.tsx'),
    formats: ['es'], // 使用 ES Module 格式
  },
}
```

## 🔧 实施步骤

### 步骤 1：更新插件加载器
- ✅ 统一使用 ES Modules
- ✅ 改进路径解析
- ✅ 添加插件注册表
- ✅ 添加错误处理和重试机制

### 步骤 2：更新插件构建配置
- ✅ 修改 `vite.config.ts`，使用 ES Module 格式
- ✅ 简化插件入口文件，移除 UMD 相关代码

### 步骤 3：测试验证
- [ ] 测试开发环境插件加载
- [ ] 测试生产环境插件加载
- [ ] 测试错误处理和重试机制
- [ ] 测试插件注册表功能

## 📊 性能优化

### 1. 缓存机制
- 已加载的插件会缓存在内存中
- 避免重复加载相同的插件
- 支持强制重新加载（`forceReload` 参数）

### 2. 懒加载
- 插件只在需要时加载
- 使用 React.lazy 实现代码分割
- 减少初始加载时间

### 3. 错误恢复
- 网络错误自动重试
- 提供清晰的错误信息
- 支持插件卸载和重新加载

## 🎯 未来改进方向

### 1. 插件依赖管理
- 检查插件依赖版本
- 处理插件依赖冲突
- 支持插件依赖注入

### 2. 插件热更新
- 开发环境支持插件热更新
- 生产环境支持插件版本更新
- 实现插件平滑升级

### 3. 插件沙箱
- 隔离插件运行环境
- 限制插件访问权限
- 提供插件 API 白名单

### 4. 插件性能监控
- 监控插件加载时间
- 追踪插件运行时性能
- 提供插件性能报告

## 📝 注意事项

1. **路径解析**：确保相对路径正确，特别是在不同操作系统上
2. **构建产物**：生产环境需要确保插件已构建并部署到正确路径
3. **依赖管理**：确保插件依赖与主应用版本兼容
4. **错误处理**：提供清晰的错误信息，帮助开发者快速定位问题

## 🔍 相关文件

- `riveredge-frontend/src/utils/pluginLoader.ts` - 插件加载器
- `riveredge-frontend/vite.config.ts` - Vite 配置（包含插件路径解析）
- `riveredge-apps/kuaimes/frontend/vite.config.ts` - 插件构建配置
- `riveredge-apps/kuaimes/frontend/src/index.tsx` - 插件入口文件

