# 高级搜索筛选功能设计文档

## 📋 概述

本文档设计**通用的**高级搜索筛选功能，在现有字段搜索基础上，增加符合最佳实践的筛选功能。

**核心特性**：
- ✅ **完全通用**：基于 `columns` 定义自动生成筛选器，适用于所有页面
- ✅ **零配置使用**：默认根据字段类型自动推断筛选器类型和操作符
- ✅ **灵活配置**：支持通过 `columns` 配置自定义筛选行为
- ✅ **向后兼容**：与现有高级搜索功能完全兼容

## 🎯 设计目标

1. **增强搜索能力**：除了字段搜索，提供更灵活的筛选功能
2. **提升用户体验**：提供直观、易用的筛选界面
3. **遵循最佳实践**：参考主流企业级应用的筛选设计
4. **保持一致性**：与现有高级搜索功能保持一致的设计风格
5. **通用性优先**：设计为通用组件，适用于所有业务场景

## 🔍 当前功能分析

### 现有功能
- ✅ 字段搜索（基于 columns 定义）
- ✅ 保存搜索条件
- ✅ 钉住搜索条件
- ✅ 共享搜索条件
- ✅ 拼音搜索支持

### 现有字段类型支持
- 文本输入框（text）
- 选择框（select）
- 日期选择器（date）
- 日期范围选择器（dateRange）
- 自动完成输入框（autoComplete）

## 🎨 筛选功能设计

### 1. 筛选器类型设计

#### 1.1 快速筛选（Quick Filters）
**位置**：高级搜索弹窗顶部，作为独立区域

**功能**：
- 提供常用的筛选选项（如：状态、类型、日期范围等）
- 支持多选和单选
- 支持标签样式展示
- 支持快速清除

**设计示例**（通用示例，适用于任何页面）：
```
┌─────────────────────────────────────┐
│ 快速筛选                              │
├─────────────────────────────────────┤
│ 状态字段: [全部] [选项1] [选项2]      │
│ 类型字段: [全部] [选项A] [选项B]      │
│ 日期字段: [今天] [本周] [本月] [自定义]│
└─────────────────────────────────────┘
```
**说明**：快速筛选选项完全基于 `columns` 中的 `valueEnum` 或 `quickFilterOptions` 配置自动生成，无需硬编码。

#### 1.2 高级筛选（Advanced Filters）
**位置**：高级搜索弹窗主体区域，与字段搜索并列

**功能**：
- 支持复杂的筛选条件组合
- 支持 AND/OR 逻辑组合
- 支持条件分组
- 支持条件拖拽排序

**设计示例**（通用示例，字段列表自动从 `columns` 获取）：
```
┌─────────────────────────────────────┐
│ 高级筛选                              │
├─────────────────────────────────────┤
│ [添加筛选条件]                        │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 条件组 1 (AND)                   │ │
│ │ ┌─────────────────────────────┐ │ │
│ │ │ 字段: [字段名称 ▼]           │ │ │
│ │ │ 操作: [包含 ▼]               │ │ │
│ │ │ 值:   [________]             │ │ │
│ │ │ [删除]                       │ │ │
│ │ └─────────────────────────────┘ │ │
│ │ [添加条件] [添加条件组]          │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```
**说明**：
- 字段列表：自动从 `columns` 中提取所有可筛选字段（`hideInSearch !== true`）
- 操作符列表：根据字段类型（`valueType`）自动推断可用的操作符
- 值输入组件：根据字段类型自动选择合适的输入组件

### 2. 筛选操作符设计

#### 2.1 文本字段操作符
- **包含** (contains) - 模糊匹配
- **等于** (equals) - 精确匹配
- **不等于** (not equals) - 排除匹配
- **开头是** (starts with) - 前缀匹配
- **结尾是** (ends with) - 后缀匹配
- **为空** (is empty) - 空值检查
- **不为空** (is not empty) - 非空检查

#### 2.2 数字字段操作符
- **等于** (equals)
- **不等于** (not equals)
- **大于** (greater than)
- **大于等于** (greater than or equal)
- **小于** (less than)
- **小于等于** (less than or equal)
- **介于** (between) - 范围查询
- **为空** (is empty)
- **不为空** (is not empty)

#### 2.3 日期字段操作符
- **等于** (equals)
- **不等于** (not equals)
- **早于** (before)
- **晚于** (after)
- **介于** (between) - 日期范围
- **今天** (today)
- **本周** (this week)
- **本月** (this month)
- **本年** (this year)
- **为空** (is empty)
- **不为空** (is not empty)

#### 2.4 选择字段操作符
- **等于** (equals) - 单选
- **不等于** (not equals) - 排除单选
- **包含** (contains) - 多选
- **不包含** (not contains) - 排除多选
- **为空** (is empty)
- **不为空** (is not empty)

### 3. 筛选逻辑组合

#### 3.1 条件组（Filter Groups）
- **AND 组**：组内所有条件必须同时满足
- **OR 组**：组内任一条件满足即可
- **嵌套组**：支持条件组嵌套（最多 2 层：顶级组 + 1层嵌套组）

#### 3.2 条件组合示例（通用示例）
```
条件组 1 (AND)
  ├─ 文本字段 包含 "关键词"
  ├─ 选择字段 等于 "选项值"
  └─ 条件组 2 (OR)
      ├─ 日期字段 早于 "2024-01-01"
      └─ 日期字段 晚于 "2024-12-31"
```
**说明**：所有字段和操作符都是基于 `columns` 配置自动生成的，完全通用。

### 4. 筛选器配置

#### 4.1 字段配置扩展
在 columns 定义中扩展筛选配置：

```typescript
interface FilterConfig {
  // 是否启用筛选
  enableFilter?: boolean;
  // 筛选器类型（自动推断或手动指定）
  filterType?: 'text' | 'number' | 'date' | 'select' | 'boolean';
  // 快速筛选选项（用于快速筛选区域）
  quickFilterOptions?: Array<{
    label: string;
    value: any;
    icon?: React.ReactNode;
  }>;
  // 默认筛选操作符
  defaultOperator?: string;
  // 允许的筛选操作符列表
  allowedOperators?: string[];
  // 筛选值转换函数
  filterValueTransform?: (value: any) => any;
}
```

#### 4.2 列配置示例（通用配置）

**基础配置**（自动推断，无需配置）：
```typescript
{
  title: '字段名称',
  dataIndex: 'field_name',
  // 默认自动启用筛选，根据 valueType 自动推断筛选器类型
}
```

**完整配置**（可选，用于自定义行为）：
```typescript
{
  title: '字段名称',
  dataIndex: 'field_name',
  valueType: 'text', // 或 'select', 'date', 'number' 等
  enableFilter: true, // 默认 true，设置为 false 可禁用筛选
  filterType: 'text', // 可选，不设置则根据 valueType 自动推断
  quickFilterOptions: [ // 可选，用于快速筛选区域
    { label: '选项1', value: 'value1' },
    { label: '选项2', value: 'value2' },
  ],
  allowedOperators: ['contains', 'equals', 'starts_with', 'ends_with'], // 可选，限制允许的操作符
  filterValueTransform: (value) => value, // 可选，筛选值转换函数
}
```

**说明**：
- 所有配置项都是**可选的**，组件会根据 `valueType` 自动推断合适的默认值
- 适用于任何业务场景，无需硬编码业务逻辑

### 5. 筛选器 UI 设计

#### 5.1 快速筛选区域
- **布局**：水平排列，支持换行
- **样式**：标签样式，选中状态高亮
- **交互**：点击切换，支持多选
- **清除**：提供"清除全部"按钮

#### 5.2 高级筛选区域
- **布局**：垂直排列，条件组可折叠
- **样式**：卡片样式，条件项清晰分隔
- **交互**：
  - 拖拽排序条件
  - 添加/删除条件
  - 条件组展开/折叠
  - 操作符下拉选择
- **验证**：实时验证筛选条件有效性

#### 5.3 筛选条件项组件
```
┌─────────────────────────────────────┐
│ [字段选择 ▼] [操作符 ▼] [值输入] [×] │
└─────────────────────────────────────┘
```

### 6. 筛选数据模型

#### 6.1 筛选条件数据结构
```typescript
interface FilterCondition {
  id: string; // 条件唯一标识
  field: string; // 字段名
  operator: string; // 操作符
  value: any; // 筛选值
  valueType?: string; // 值类型（用于验证和转换）
}

interface FilterGroup {
  id: string; // 组唯一标识
  logic: 'AND' | 'OR'; // 逻辑关系
  conditions: FilterCondition[]; // 条件列表
  groups?: FilterGroup[]; // 嵌套组（可选）
}

interface FilterConfig {
  groups: FilterGroup[]; // 筛选组列表
  quickFilters?: Record<string, any[]>; // 快速筛选值
}
```

#### 6.2 筛选条件转换
将筛选条件转换为后端 API 参数：

```typescript
function convertFiltersToApiParams(
  filterConfig: FilterConfig,
  columns: ProColumns[]
): Record<string, any> {
  const params: Record<string, any> = {};
  
  // 转换条件组为查询参数
  filterConfig.groups.forEach(group => {
    const groupParams = convertGroupToParams(group, columns);
    Object.assign(params, groupParams);
  });
  
  // 转换快速筛选为查询参数
  if (filterConfig.quickFilters) {
    Object.assign(params, filterConfig.quickFilters);
  }
  
  return params;
}
```

### 7. 筛选功能实现方案

#### 7.1 组件结构
```
QuerySearchModal
├── QuickFilters (快速筛选区域)
│   ├── QuickFilterItem (快速筛选项)
│   └── QuickFilterClear (清除按钮)
├── AdvancedFilters (高级筛选区域)
│   ├── FilterGroup (筛选条件组)
│   │   ├── FilterCondition (筛选条件)
│   │   │   ├── FieldSelector (字段选择器)
│   │   │   ├── OperatorSelector (操作符选择器)
│   │   │   └── ValueInput (值输入组件)
│   │   └── FilterGroupActions (组操作按钮)
│   └── FilterGroupAdd (添加条件组按钮)
└── FilterActions (筛选操作按钮)
    ├── ApplyFilter (应用筛选)
    ├── ClearFilter (清除筛选)
    └── SaveFilter (保存筛选)
```

#### 7.2 状态管理
```typescript
interface FilterState {
  // 快速筛选状态
  quickFilters: Record<string, any[]>;
  // 高级筛选状态
  advancedFilters: FilterGroup[];
  // 当前编辑的条件组
  editingGroupId?: string;
  // 筛选条件验证错误
  validationErrors: Record<string, string>;
}
```

#### 7.3 筛选条件验证
- **字段验证**：确保字段存在且可筛选
- **操作符验证**：确保操作符适用于字段类型
- **值验证**：根据字段类型和操作符验证值格式
- **逻辑验证**：确保条件组逻辑正确

### 8. 筛选功能集成

#### 8.1 与现有搜索功能集成
- **合并搜索和筛选**：将字段搜索和筛选条件合并为统一的查询参数
- **保存筛选条件**：筛选条件可以保存为搜索条件的一部分
- **筛选条件显示**：在表格上方显示当前激活的筛选条件标签

#### 8.2 筛选条件持久化
- **URL 参数**：筛选条件可以序列化为 URL 参数，支持分享和书签
- **本地存储**：筛选条件可以保存到 localStorage
- **服务器存储**：筛选条件可以保存到服务器（与搜索条件一起）

### 9. 用户体验优化

#### 9.1 筛选条件提示
- **字段提示**：显示字段说明和示例值
- **操作符提示**：显示操作符说明和使用场景
- **值提示**：根据字段类型显示输入格式提示

#### 9.2 筛选条件预览
- **实时预览**：显示筛选条件对应的 SQL 查询（开发环境）
- **结果统计**：显示筛选后的结果数量
- **筛选历史**：显示最近使用的筛选条件

#### 9.3 筛选条件管理
- **筛选模板**：保存常用的筛选条件组合为模板
- **筛选导入/导出**：支持筛选条件的导入和导出
- **筛选条件分享**：支持筛选条件的分享链接

### 10. 性能优化

#### 10.1 筛选条件优化
- **条件合并**：合并相同字段的多个条件
- **条件简化**：简化冗余的筛选条件
- **条件缓存**：缓存筛选条件的验证结果

#### 10.2 查询优化
- **索引利用**：确保筛选字段有数据库索引
- **查询优化**：优化筛选条件的 SQL 查询
- **分页优化**：筛选后的分页查询优化

### 11. 实现优先级

#### Phase 1: 基础筛选功能
1. ✅ 快速筛选区域（状态、类型等常用筛选）
2. ✅ 高级筛选条件项（单个条件）
3. ✅ 筛选条件验证
4. ✅ 筛选条件转换为 API 参数

#### Phase 2: 高级筛选功能
1. ⬜ 条件组（AND/OR 逻辑）
2. ⬜ 嵌套条件组
3. ⬜ 条件拖拽排序
4. ⬜ 筛选条件保存

#### Phase 3: 用户体验优化
1. ✅ 筛选条件预览（已实现 FilterPreview 组件）
2. ✅ 筛选模板（通过保存搜索条件实现，筛选条件已集成到保存搜索条件中）
3. ✅ 筛选条件分享（通过保存搜索条件的共享功能实现）
4. ❌ 筛选历史（已移除，统一使用保存搜索条件功能）

### 12. 通用性设计原则

#### 12.1 通用性保证
本筛选功能设计遵循以下通用性原则：

1. **基于配置，而非硬编码**
   - 所有筛选器基于 `columns` 定义自动生成
   - 字段列表、操作符、输入组件都从 `columns` 配置中推断
   - 无需为特定业务场景编写特殊代码

2. **自动推断，零配置使用**
   - 根据 `valueType` 自动推断筛选器类型
   - 根据字段类型自动选择合适的操作符
   - 根据字段类型自动选择合适的输入组件

3. **灵活扩展，支持自定义**
   - 支持通过 `columns` 配置覆盖默认行为
   - 支持自定义筛选器类型和操作符
   - 支持自定义筛选值转换函数

4. **完全独立，无业务耦合**
   - 筛选组件不包含任何业务逻辑
   - 筛选条件转换为通用的 API 参数格式
   - 适用于任何后端 API 结构

#### 12.2 通用性示例

**场景 1：角色管理页面**
```typescript
const columns = [
  { title: '角色名称', dataIndex: 'name', valueType: 'text' },
  { title: '状态', dataIndex: 'is_active', valueType: 'select', valueEnum: {...} },
];
// 自动生成：文本筛选器 + 选择筛选器
```

**场景 2：用户管理页面**
```typescript
const columns = [
  { title: '用户名', dataIndex: 'username', valueType: 'text' },
  { title: '邮箱', dataIndex: 'email', valueType: 'text' },
  { title: '创建时间', dataIndex: 'created_at', valueType: 'date' },
];
// 自动生成：文本筛选器 + 文本筛选器 + 日期筛选器
```

**场景 3：订单管理页面**
```typescript
const columns = [
  { title: '订单号', dataIndex: 'order_no', valueType: 'text' },
  { title: '金额', dataIndex: 'amount', valueType: 'money' },
  { title: '订单日期', dataIndex: 'order_date', valueType: 'dateRange' },
];
// 自动生成：文本筛选器 + 数字筛选器 + 日期范围筛选器
```

**说明**：所有场景使用相同的筛选组件，无需修改代码，只需配置 `columns`。

#### 12.3 通用性验证清单
- ✅ 筛选器类型自动推断（基于 `valueType`）
- ✅ 操作符列表自动生成（基于字段类型）
- ✅ 输入组件自动选择（基于字段类型）
- ✅ 快速筛选选项可配置（通过 `quickFilterOptions`）
- ✅ 筛选条件转换为通用格式（`Record<string, any>`）
- ✅ 无业务逻辑硬编码
- ✅ 适用于所有页面和业务场景

### 13. 技术实现要点

#### 13.1 组件库选择
- **Ant Design Pro Components**：使用 ProForm 系列组件
- **React Hook Form**：使用 React Hook Form 管理表单状态
- **Zustand**：使用 Zustand 管理筛选状态（如果需要全局状态）

#### 12.2 数据流设计
```
用户操作
  ↓
筛选条件状态更新
  ↓
筛选条件验证
  ↓
筛选条件转换为 API 参数
  ↓
调用后端 API
  ↓
更新表格数据
```

#### 12.3 类型安全
- 使用 TypeScript 严格类型检查
- 定义筛选条件的类型接口
- 使用类型守卫验证筛选条件

## 📝 总结

本设计文档提供了高级搜索筛选功能的完整设计方案，包括：

1. **筛选器类型**：快速筛选和高级筛选
2. **操作符设计**：针对不同字段类型的操作符
3. **逻辑组合**：AND/OR 条件组和嵌套组
4. **UI 设计**：直观易用的筛选界面
5. **数据模型**：清晰的筛选条件数据结构
6. **集成方案**：与现有搜索功能的集成
7. **用户体验**：优化用户使用体验
8. **性能优化**：确保筛选功能性能
9. **实现优先级**：分阶段实现计划

该设计方案遵循企业级应用的最佳实践，提供了灵活、强大的筛选功能，同时保持了良好的用户体验。

