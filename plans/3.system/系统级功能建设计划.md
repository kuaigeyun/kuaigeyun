# 系统级功能建设计划

## 📋 概述

本文档详细规划了 RiverEdge SaaS 多组织框架的系统级功能建设，包括功能模块、技术选型、建设顺序和依赖关系。

**建设原则**：
1. **多租户优先**：所有功能必须支持多组织数据隔离
2. **渐进式建设**：按照依赖关系从基础到高级逐步建设
3. **最佳实践**：遵循框架规范和行业最佳实践
4. **可扩展性**：为未来功能扩展预留接口

---

## 🎯 功能模块总览

### 1. 用户管理 ⭐⭐⭐⭐⭐（优先级最高）
- 部门管理
- 职位管理
- 角色管理
- 账户管理
- 菜单管理

### 2. 核心配置 ⭐⭐⭐⭐
- 应用中心
- 站点设置
- 参数设置
- 数据字典
- 编码规则
- 集成设置
- 语言管理
- 自定义字段
- 邀请码管理


### 3. 数据中心 ⭐⭐⭐⭐
- 接口管理（API管理）
- 数据管理
  - 数据源管理
  - 数据集管理
- 文件管理

### 4. 流程管理 ⭐⭐⭐
- 消息管理
  - 消息配置
  - 消息模板
  - 消息推送
- 审批流程
- 定时任务
- 电子记录
- 脚本管理
- 打印模板
- 打印设备

### 5. 个人中心 ⭐⭐⭐
- 个人资料
- 偏好设置
- 我的消息
- 我的任务
  - 我发起的
  - 我的待办
  - 我的已办
  - 我的抄送

### 6. 监控运维 ⭐⭐⭐
- 数据备份
- 操作日志
- 登录日志
- 在线用户

---

## 📦 技术选型与所需库

### 后端技术栈（已确定）

#### 核心框架
- **FastAPI 0.110.0** - Web 框架
- **Tortoise ORM 0.21.1** - ORM 框架
- **PostgreSQL 15+** - 主数据库
- **Redis 7.2+** - 缓存和会话存储
- **Aerich 0.7+** - 数据库迁移工具

#### 认证与安全
- **python-jose** - JWT Token 处理
- **passlib[bcrypt]** - 密码加密（已使用）
- **python-multipart** - 文件上传支持

#### 数据处理
- **Pydantic v2.7.0** - 数据验证
- **pydantic-settings** - 配置管理

#### 工作流编排与任务调度（流程管理核心）
- **Inngest** ⭐ **已选定** - 工作流编排和任务调度平台
  - 支持事件驱动工作流
  - 支持定时任务（cron、interval、date）
  - 支持工作流编排（审批流程、自动化流程）
  - 支持任务重试、错误处理
  - 支持任务监控和日志
  - **替代功能**：
    - ✅ 定时任务（替代 APScheduler）
    - ✅ 审批流程（工作流编排）
    - ✅ 消息推送（事件驱动）
    - ✅ 电子记录（工作流）
    - ✅ 数据备份（定时任务）
    - ✅ 其他自动化流程

#### 消息推送（实时通知）
- **websockets** - WebSocket 支持（实时消息推送）
  - 用于前端实时通知
  - 配合 Inngest 事件驱动

#### 文件管理
- **aiofiles** - 异步文件操作
- **kkFileView** ⭐ **已选定** - 文件预览服务
  - 支持 23+ 种文件格式在线预览
  - 支持 Office 文档、PDF、图片、音视频等
  - 支持在线预览、在线编辑
  - 需要独立部署（Java 服务）
- **python-magic** ⚠️ **可选**（文件类型检测）
- **Pillow** ⚠️ **可选**（图片处理）

#### 打印功能
- **reportlab** ⭐ **推荐**（PDF 生成）
- **weasyprint** ⚠️ **可选**（HTML 转 PDF）
- **pycups** ⚠️ **可选**（Linux 打印支持）

#### 脚本管理
- **PyExecJS** ⭐ **推荐**（JavaScript 执行）
- **lxml** ⚠️ **可选**（XML/HTML 解析）

#### 数据导入导出
- **openpyxl** ⭐ **推荐**（Excel 读写）
- **pandas** ⚠️ **可选**（数据分析，如果数据量大）

#### 日志与监控
- **loguru** - 日志（已使用）
- **prometheus-client** ⚠️ **可选**（指标收集）

### 前端技术栈（已确定）

#### 核心框架
- **React 18.3.1** - UI 框架
- **TypeScript 5.6.3** - 类型系统
- **Vite 5.4.8** - 构建工具

#### UI 组件
- **Ant Design 5.21.4** - UI 组件库
- **Ant Design Pro Components 2.8.2** - Pro 组件

#### 状态管理
- **Zustand 5.0.0** - 状态管理
- **TanStack Query 5.51.1** - 数据获取

#### 路由与表单
- **React Router DOM 6.26.2** - 路由
- **React Hook Form 7.53.0** - 表单管理

#### 流程可视化与设计
- **@ant-design/pro-flow** ⭐ **推荐**（流程图组件，与 Inngest 配合）
  - **定位**：前端可视化组件（"皮"）
  - **作用**：工作流可视化设计、流程图展示
  - **配合**：与 Inngest（后端引擎，"骨"）配合使用
  - **工作方式**：
    - ProFlow 设计工作流 → 转换为 Inngest 工作流配置
    - Inngest 执行工作流 → ProFlow 展示执行状态
- **react-flow** ⚠️ **可选**（如果 ProFlow 不满足需求）

#### 打印预览
- **react-to-print** - 打印功能（已使用）
- **jspdf** - PDF 生成（已使用）
- **html2canvas** - 截图（已使用）

#### 文件上传
- **antd Upload** - 文件上传组件（Ant Design 内置）

#### 消息推送（前端）
- **socket.io-client** ⭐ **推荐**（WebSocket 客户端）
  - 如果后端使用 WebSocket，前端需要对应客户端

---

## 🏗️ 建设顺序与依赖关系

### 阶段一：基础权限体系（优先级最高）⭐⭐⭐⭐⭐

**目标**：建立完整的用户权限管理体系，为后续功能提供权限控制基础。

#### 1.1 角色权限管理（第1优先级）
**依赖**：无（基础功能）

**功能**：
- ✅ 角色模型（Role）
- ✅ 权限模型（Permission）
- ✅ 角色-权限关联（多对多）
- ✅ 用户-角色关联（多对多）
- ✅ 角色管理 API（CRUD）
- ✅ 权限管理 API（查询、分配）

**所需库**：
- 无需额外库（使用 Tortoise ORM 多对多关系）

**建设时间**：1-2 周

**前端页面**：
- 角色管理页面（列表、创建、编辑、删除）
- 权限管理页面（权限树、分配权限）

---

#### 1.2 部门管理（第2优先级）
**依赖**：角色权限管理（需要权限控制）

**功能**：
- 部门模型（Department）
  - 支持树形结构（父子部门）
  - 组织隔离（tenant_id）
- 部门管理 API（CRUD）
- 部门树查询 API

**所需库**：
- 无需额外库（使用 Tortoise ORM 自关联）

**建设时间**：1 周

**前端页面**：
- 部门管理页面（树形列表、创建、编辑、删除、拖拽排序）

---

#### 1.3 职位管理（第3优先级）
**依赖**：部门管理（职位通常属于部门）

**功能**：
- 职位模型（Position）
  - 关联部门（外键）
  - 组织隔离（tenant_id）
- 职位管理 API（CRUD）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 职位管理页面（列表、创建、编辑、删除）

---

#### 1.4 账户管理（第4优先级）
**依赖**：角色权限管理、部门管理、职位管理

**功能**：
- 扩展用户模型（User）
  - 关联部门（外键）
  - 关联职位（外键）
  - 关联角色（多对多）
- 账户管理 API（CRUD、批量操作）
- 账户导入导出

**所需库**：
- openpyxl（Excel 导入导出）

**建设时间**：1-2 周

**前端页面**：
- 账户管理页面（列表、创建、编辑、删除、导入、导出）
- 账户详情页面

---

#### 1.5 菜单管理（第5优先级）⏸️ **暂缓建设**

**状态**：⏸️ **暂缓，等待应用级功能开始建设时再完善**

**暂缓原因**：
- 菜单管理需要等待应用级功能开始建设
- 菜单结构与具体应用功能相关，需要根据实际应用需求设计
- 建议在应用级功能开发时，根据实际菜单需求再设计

**依赖**：权限管理（菜单需要权限控制）

**功能**（待应用级建设时完善）：
- 菜单模型（Menu）
  - 支持树形结构（父子菜单）
  - 关联权限（外键）
  - 组织隔离（tenant_id）
- 菜单管理 API（CRUD、排序）
- 菜单树查询 API

**所需库**：
- 无需额外库

**建设时间**：1 周（待应用级建设时）

**前端页面**（待应用级建设时）：
- 菜单管理页面（树形列表、创建、编辑、删除、拖拽排序）

**建议时机**：
- 应用级功能开始建设时
- 需要定义具体菜单结构时
- 需要配置菜单权限时

---

### 阶段二：核心配置（优先级高）⭐⭐⭐⭐

**目标**：建立系统核心配置功能，为业务功能提供配置基础。

#### 2.1 数据字典（第1优先级）
**依赖**：无（独立功能）

**功能**：
- 数据字典模型（DataDictionary）
  - 字典类型（type）
  - 字典项（items）
  - 组织隔离（tenant_id）
- 数据字典管理 API（CRUD）
- 字典项管理 API（CRUD）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 数据字典管理页面（列表、创建、编辑、删除）
- 字典项管理页面（列表、创建、编辑、删除）

---

#### 2.2 参数设置（第2优先级）
**依赖**：无（独立功能）

**功能**：
- 参数模型（SystemParameter）
  - 参数键（key）
  - 参数值（value）
  - 参数类型（type：string、number、boolean、json）
  - 组织隔离（tenant_id）
- 参数管理 API（CRUD、批量更新）
- 参数缓存（Redis）

**所需库**：
- redis-py（已使用）

**建设时间**：1 周

**前端页面**：
- 参数设置页面（列表、创建、编辑、删除、批量导入）

---

#### 2.3 编码规则（第3优先级）
**依赖**：数据字典（可能需要字典支持）

**功能**：
- 编码规则模型（CodeRule）
  - 规则名称
  - 规则表达式（支持变量、日期、序号等）
  - 组织隔离（tenant_id）
- 编码规则管理 API（CRUD）
- 编码生成服务（根据规则生成编码）

**所需库**：
- 无需额外库（字符串模板处理）

**建设时间**：1-2 周

**前端页面**：
- 编码规则管理页面（列表、创建、编辑、删除、测试生成）

---

#### 2.4 自定义字段（第4优先级）
**依赖**：数据字典（字段类型可能需要字典）

**功能**：
- 自定义字段模型（CustomField）
  - 字段名称
  - 字段类型（text、number、date、select等）
  - 关联表（table_name）
  - 组织隔离（tenant_id）
- 自定义字段管理 API（CRUD）
- 动态字段扩展服务（运行时添加字段）
- 基于 Formily 的动态表单渲染

**所需库**：
- **后端**：无需额外库（使用 JSON 字段存储）
- **前端**：**@formily/core**、**@formily/react**、**@formily/antd-v5** ⭐ **已选定**（动态表单渲染）

**建设时间**：2-3 周

**前端页面**：
- 自定义字段管理页面（列表、创建、编辑、删除）
- 动态表单组件（基于 Formily，在关联表的详情页中使用）

---

#### 2.5 站点设置（第5优先级）
**依赖**：参数设置（站点设置本质是参数）

**功能**：
- 站点设置模型（SiteSettings）
  - 设置项（settings，JSON 字段）
  - 组织隔离（tenant_id）
- 站点设置 API（获取、更新）
- 邀请注册功能
  - 邀请码生成
  - 邀请码验证

**所需库**：
- 无需额外库

**建设时间**：1-2 周

**前端页面**：
- 站点设置页面（表单、保存）
- 邀请注册页面（生成邀请码、查看邀请记录）

---

#### 2.6 语言管理（第6优先级）
**依赖**：无（独立功能）

**功能**：
- 语言模型（Language）
  - 语言代码（code）
  - 语言名称（name）
  - 翻译内容（translations，JSON 字段）
  - 组织隔离（tenant_id）
- 语言管理 API（CRUD）
- 多语言服务（根据语言代码返回翻译）

**所需库**：
- react-i18next（前端已使用）

**建设时间**：1-2 周

**前端页面**：
- 语言管理页面（列表、创建、编辑、删除）
- 翻译管理页面（翻译编辑器）

---

#### 2.7 应用中心（第7优先级）
**依赖**：菜单管理（应用需要菜单）

**功能**：
- 应用模型（Application）
  - 应用名称
  - 应用图标
  - 应用路由
  - 应用权限
  - 组织隔离（tenant_id）
- 应用管理 API（CRUD、启用/禁用）
- 插件式应用加载服务

**所需库**：
- 无需额外库（动态路由加载）

**建设时间**：2-3 周

**前端页面**：
- 应用中心页面（应用列表、启用/禁用、安装/卸载）

---

#### 2.8 集成设置（第8优先级）
**依赖**：参数设置（集成配置本质是参数）

**功能**：
- 集成配置模型（IntegrationConfig）
  - 集成类型（type：OAuth、API、Webhook等）
  - 配置信息（config，JSON 字段）
  - 组织隔离（tenant_id）
- 集成管理 API（CRUD、测试连接）

**所需库**：
- **httpx**（已使用，用于 API 调用）
- **authlib** ⭐ **推荐**（OAuth 集成，可选，仅在需要 OAuth 时安装）

**建设时间**：2-3 周

**前端页面**：
- 集成设置页面（列表、创建、编辑、删除、测试连接）

---

### 阶段三：数据中心（优先级中高）⭐⭐⭐⭐

**目标**：建立数据管理和接口管理功能。

#### 3.1 文件管理（第1优先级）
**依赖**：无（独立功能）

**功能**：
- 文件模型（File）
  - 文件名称
  - 文件路径
  - 文件大小
  - 文件类型
  - 预览 URL（kkFileView 预览地址）
  - 组织隔离（tenant_id）
- 文件管理 API（上传、下载、删除、列表、预览）
- 文件存储服务（本地存储或对象存储）
- kkFileView 集成服务
  - 文件预览 URL 生成
  - 预览权限验证
  - 预览服务健康检查

**所需库**：
- **kkFileView** ⭐ **已选定**（文件预览服务）
  - 支持 23+ 种文件格式
  - 需要独立部署（Java 服务）
  - 提供 HTTP API 接口
- aiofiles（异步文件操作）
- python-magic ⚠️ **可选**（文件类型检测）

**建设时间**：1-2 周

**前端页面**：
- 文件管理页面（文件列表、上传、下载、删除、预览）

---

#### 3.2 接口管理（第2优先级）
**依赖**：无（独立功能）

**功能**：
- 接口模型（API）
  - 接口名称
  - 接口路径
  - 请求方法（GET、POST等）
  - 请求参数（JSON 字段）
  - 响应格式（JSON 字段）
  - 组织隔离（tenant_id）
- 接口管理 API（CRUD、测试调用）
- 接口文档生成（OpenAPI）

**所需库**：
- httpx（已使用，用于接口测试）

**建设时间**：2-3 周

**前端页面**：
- 接口管理页面（列表、创建、编辑、删除、测试调用）
- 接口文档页面（自动生成文档）

---

#### 3.3 数据源管理（第3优先级）
**依赖**：无（独立功能）

**功能**：
- 数据源模型（DataSource）
  - 数据源名称
  - 数据源类型（PostgreSQL、MySQL、MongoDB、API等）
  - 连接配置（config，JSON 字段）
  - 组织隔离（tenant_id）
- 数据源管理 API（CRUD、测试连接）

**所需库**：
- SQLAlchemy ⚠️ **可选**（如果需要支持多种数据库）
- pymongo ⚠️ **可选**（如果需要支持 MongoDB）

**建设时间**：2-3 周

**前端页面**：
- 数据源管理页面（列表、创建、编辑、删除、测试连接）

---

#### 3.4 数据集管理（第4优先级）
**依赖**：数据源管理（数据集需要数据源）

**功能**：
- 数据集模型（Dataset）
  - 数据集名称
  - 关联数据源（外键）
  - 查询语句（SQL 或 API 配置）
  - 组织隔离（tenant_id）
- 数据集管理 API（CRUD、执行查询）

**所需库**：
- pandas ⚠️ **可选**（如果数据量大，需要数据分析）

**建设时间**：2-3 周

**前端页面**：
- 数据集管理页面（列表、创建、编辑、删除、执行查询、预览数据）

---

### 阶段四：流程管理（优先级中）⭐⭐⭐

**目标**：建立流程管理和自动化功能。

#### 4.1 消息管理（第1优先级）
**依赖**：无（独立功能）

**功能**：
- 消息配置模型（MessageConfig）
  - 消息类型（type：邮件、短信、站内信、推送等）
  - 配置信息（config，JSON 字段）
  - 组织隔离（tenant_id）
- 消息模板模型（MessageTemplate）
  - 模板名称
  - 模板内容
  - 模板变量
  - 组织隔离（tenant_id）
- 消息推送服务
  - 邮件发送（SMTP）
  - 短信发送（第三方 API）
  - 站内信
  - 推送通知（WebSocket）

**所需库**：
- aiosmtplib（异步邮件发送）
- websockets（WebSocket 支持）
- socket.io ⚠️ **可选**（如果需要 Socket.IO 协议）

**建设时间**：2-3 周

**前端页面**：
- 消息配置页面（列表、创建、编辑、删除、测试发送）
- 消息模板页面（列表、创建、编辑、删除）
- 消息推送页面（发送消息、查看发送记录）

---

#### 4.2 定时任务（第2优先级）
**依赖**：无（独立功能）

**功能**：
- 定时任务模型（ScheduledTask）
  - 任务名称
  - 任务类型（type：Python 脚本、API 调用等）
  - 触发器配置（cron 表达式或间隔）
  - 任务配置（config，JSON 字段）
  - Inngest 函数 ID（关联 Inngest 函数）
  - 组织隔离（tenant_id）
- 定时任务管理 API（CRUD、启动/停止、执行日志）
- Inngest 集成服务
  - 动态注册 Inngest 函数
  - 任务执行监控
  - 任务日志查询

**所需库**：
- **Inngest** ⭐ **已选定**（替代 APScheduler）
  - 支持 cron、interval、date 触发器
  - 支持任务持久化
  - 支持任务重试和错误处理
  - 支持任务监控和日志

**建设时间**：2-3 周

**前端页面**：
- 定时任务管理页面（列表、创建、编辑、删除、启动/停止、查看日志）

---

#### 4.3 审批流程（第3优先级）
**依赖**：用户管理、消息管理（审批需要通知）

**功能**：
- 审批流程模型（ApprovalProcess）
  - 流程名称
  - Inngest 工作流 ID（关联 Inngest 工作流）
  - 流程节点配置（nodes，JSON 字段）
  - 流程配置（config，JSON 字段）
  - 组织隔离（tenant_id）
- 审批实例模型（ApprovalInstance）
  - 关联流程（外键）
  - Inngest 运行 ID（关联 Inngest 工作流实例）
  - 当前节点
  - 审批状态
  - 组织隔离（tenant_id）
- 审批管理 API（CRUD、提交审批、审批操作）
- Inngest 工作流集成
  - 动态创建工作流
  - 工作流执行监控
  - 工作流状态同步

**所需库**：
- **后端**：
  - **Inngest** ⭐ **已选定**（工作流编排引擎，"骨"）
    - 支持复杂工作流编排
    - 支持条件分支、并行执行
    - 支持工作流状态管理
    - 支持工作流监控和日志
- **前端**：
  - **@ant-design/pro-flow** ⭐ **推荐**（流程图可视化组件，"皮"）
    - 工作流可视化设计
    - 流程图展示
    - 执行状态可视化
    - 与 Inngest 配合：设计 → 配置 → 执行 → 监控

**工作流程**：
1. **设计阶段**：使用 ProFlow 在前端可视化设计审批流程
2. **配置阶段**：将 ProFlow 设计的流程转换为 Inngest 工作流配置
3. **注册阶段**：将工作流配置注册到 Inngest
4. **执行阶段**：Inngest 执行工作流，ProFlow 展示执行状态
5. **监控阶段**：ProFlow 实时展示工作流执行进度和结果

**建设时间**：3-4 周

**前端页面**：
- 审批流程管理页面（流程设计器、列表、创建、编辑、删除）
- 审批实例页面（我发起的、我的待办、我的已办、我的抄送）

---

#### 4.4 电子记录（第4优先级）
**依赖**：文件管理（电子记录可能需要附件）、Inngest（工作流）

**功能**：
- 电子记录模型（ElectronicRecord）
  - 记录名称
  - 记录类型
  - 记录内容（content，JSON 字段）
  - 关联文件（外键）
  - Inngest 工作流 ID（签名、归档流程）
  - 组织隔离（tenant_id）
- 电子记录管理 API（CRUD、签名、归档）
- Inngest 工作流集成
  - 签名工作流
  - 归档工作流
  - 记录生命周期管理

**所需库**：
- **Inngest** ⭐ **已选定**（电子记录工作流）

**建设时间**：2-3 周

**前端页面**：
- 电子记录管理页面（列表、创建、编辑、删除、签名、归档）

---

#### 4.5 脚本管理（第5优先级）
**依赖**：无（独立功能）

**功能**：
- 脚本模型（Script）
  - 脚本名称
  - 脚本类型（type：JavaScript、Python等）
  - 脚本内容
  - 组织隔离（tenant_id）
- 脚本管理 API（CRUD、执行脚本）

**所需库**：
- PyExecJS ⭐ **推荐**（JavaScript 执行）

**建设时间**：1-2 周

**前端页面**：
- 脚本管理页面（列表、创建、编辑、删除、执行、查看结果）

---

#### 4.6 打印模板（第6优先级）
**依赖**：无（独立功能）

**功能**：
- 打印模板模型（PrintTemplate）
  - 模板名称
  - 模板类型（type：PDF、HTML等）
  - 模板内容（HTML 或 JSON）
  - 组织隔离（tenant_id）
- 打印模板管理 API（CRUD、预览、打印）

**所需库**：
- reportlab ⭐ **推荐**（PDF 生成）
- weasyprint ⚠️ **可选**（HTML 转 PDF）

**建设时间**：2-3 周

**前端页面**：
- 打印模板管理页面（列表、创建、编辑、删除、预览、打印）
- 打印模板设计器（可视化设计）

---

#### 4.7 打印设备（第7优先级）
**依赖**：打印模板（打印需要模板）

**功能**：
- 打印设备模型（PrintDevice）
  - 设备名称
  - 设备类型（type：网络打印机、本地打印机等）
  - 设备配置（config，JSON 字段）
  - 组织隔离（tenant_id）
- 打印设备管理 API（CRUD、测试连接）

**所需库**：
- pycups ⚠️ **可选**（Linux 打印支持）

**建设时间**：1-2 周

**前端页面**：
- 打印设备管理页面（列表、创建、编辑、删除、测试连接）

---

### 阶段五：个人中心（优先级中）⭐⭐⭐

**目标**：建立个人中心功能，提升用户体验。

#### 5.1 个人资料（第1优先级）
**依赖**：用户管理（已有用户模型）

**功能**：
- 扩展用户模型（User）
  - 头像（avatar）
  - 个人简介（bio）
  - 联系方式（contact_info，JSON 字段）
- 个人资料 API（获取、更新）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 个人资料页面（表单、上传头像、保存）

---

#### 5.2 偏好设置（第2优先级）
**依赖**：无（独立功能）

**功能**：
- 用户偏好模型（UserPreference）
  - 关联用户（外键）
  - 偏好设置（preferences，JSON 字段）
  - 组织隔离（tenant_id）
- 偏好设置 API（获取、更新）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 偏好设置页面（主题、语言、通知设置等）

---

#### 5.3 我的消息（第3优先级）
**依赖**：消息管理（需要消息系统）

**功能**：
- 用户消息模型（UserMessage）
  - 关联用户（外键）
  - 消息内容
  - 消息类型
  - 已读状态
  - 组织隔离（tenant_id）
- 我的消息 API（获取列表、标记已读、删除）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 我的消息页面（消息列表、查看详情、标记已读、删除）

---

#### 5.4 我的任务（第4优先级）
**依赖**：审批流程（任务来自审批）

**功能**：
- 复用审批实例模型（ApprovalInstance）
- 我的任务 API（我发起的、我的待办、我的已办、我的抄送）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 我的任务页面（任务列表、查看详情、处理任务）

---

### 阶段六：监控运维（优先级中）⭐⭐⭐

**目标**：建立系统监控和运维功能。

#### 6.1 操作日志（第1优先级）
**依赖**：无（独立功能）

**功能**：
- 操作日志模型（OperationLog）
  - 操作用户（外键）
  - 操作类型（type）
  - 操作内容（content）
  - 操作时间
  - 组织隔离（tenant_id）
- 操作日志 API（查询列表、导出）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 操作日志页面（日志列表、筛选、导出）

---

#### 6.2 登录日志（第2优先级）
**依赖**：用户管理（需要用户信息）

**功能**：
- 登录日志模型（LoginLog）
  - 登录用户（外键）
  - 登录IP
  - 登录时间
  - 登录状态（成功/失败）
  - 组织隔离（tenant_id）
- 登录日志 API（查询列表、导出）

**所需库**：
- 无需额外库

**建设时间**：1 周

**前端页面**：
- 登录日志页面（日志列表、筛选、导出）

---

#### 6.3 在线用户（第3优先级）
**依赖**：用户管理、Redis（需要会话存储）

**功能**：
- 在线用户服务（从 Redis 读取会话信息）
- 在线用户 API（获取在线用户列表、强制下线）

**所需库**：
- redis-py（已使用）

**建设时间**：1 周

**前端页面**：
- 在线用户页面（在线用户列表、强制下线）

---

#### 6.4 数据备份（第4优先级）
**依赖**：Inngest（定时备份任务）

**功能**：
- 数据备份模型（DataBackup）
  - 备份名称
  - 备份类型（type：全量、增量）
  - 备份文件路径
  - Inngest 任务 ID（关联备份任务）
  - 组织隔离（tenant_id）
- 数据备份 API（创建备份、恢复备份、备份列表）
- Inngest 定时备份任务
  - 定时全量备份
  - 定时增量备份
  - 备份文件清理（保留策略）

**所需库**：
- **Inngest** ⭐ **已选定**（定时备份任务，替代手动备份）
- pg_dump（PostgreSQL 命令行工具）
- aiofiles（异步文件操作）

**建设时间**：2 周

**前端页面**：
- 数据备份页面（备份列表、创建备份、恢复备份、下载备份）

---

## 📊 建设时间表

### 第一阶段：基础权限体系（6-8 周）
- 角色权限管理：1-2 周
- 部门管理：1 周
- 职位管理：1 周
- 账户管理：1-2 周
- 菜单管理：1 周

### 第二阶段：核心配置（8-12 周）
- 数据字典：1 周
- 参数设置：1 周
- 编码规则：1-2 周
- 自定义字段：2-3 周
- 站点设置：1-2 周
- 语言管理：1-2 周
- 应用中心：2-3 周
- 集成设置：2-3 周

### 第三阶段：数据中心（6-10 周）
- 文件管理：1-2 周
- 接口管理：2-3 周
- 数据源管理：2-3 周
- 数据集管理：2-3 周

### 第四阶段：流程管理（12-18 周）
- 消息管理：2-3 周
- 定时任务：2-3 周
- 审批流程：3-4 周
- 电子记录：2-3 周
- 脚本管理：1-2 周
- 打印模板：2-3 周
- 打印设备：1-2 周

### 第五阶段：个人中心（4 周）
- 个人资料：1 周
- 偏好设置：1 周
- 我的消息：1 周
- 我的任务：1 周

### 第六阶段：监控运维（5 周）
- 操作日志：1 周
- 登录日志：1 周
- 在线用户：1 周
- 数据备份：2 周（使用 Inngest 定时任务）

**总预计时间**：41-57 周（约 10-14 个月）

---

## 🔧 Inngest 集成说明

### Inngest 功能覆盖

**Inngest 已选定作为流程管理核心库，替代以下功能**：

1. ✅ **定时任务**（替代 APScheduler）
   - 支持 cron、interval、date 触发器
   - 支持任务持久化和重试
   - 支持任务监控和日志

2. ✅ **审批流程**（工作流编排）
   - 支持复杂工作流设计
   - 支持条件分支、并行执行
   - 支持工作流状态管理

3. ✅ **消息推送**（事件驱动）
   - 邮件发送工作流
   - 短信发送工作流
   - 站内信推送工作流
   - WebSocket 通知触发

4. ✅ **电子记录**（工作流）
   - 签名工作流
   - 归档工作流
   - 记录生命周期管理

5. ✅ **数据备份**（定时任务）
   - 定时全量备份
   - 定时增量备份
   - 备份文件清理

6. ✅ **AI 融入应用流程**（工作流编排）
   - AI 任务异步处理（长时间运行）
   - AI 任务重试机制（API 调用可能失败）
   - 多步骤 AI 工作流编排（文档分析、内容生成等）
   - 并行 AI 任务处理（多个 AI 模型同时调用）
   - AI 结果后处理和流程触发
   - AI 任务状态管理和监控

### Inngest 集成要点

1. **服务部署**
   - **Inngest 服务器**：独立服务（不是 Python 写的，可能是 Go/TypeScript）
     - **部署方式**：直接运行，不使用 Docker，不使用官方云服务
     - 使用 npm 安装：`npm install -g inngest`
     - 或下载二进制文件直接运行
     - 配置 Inngest 事件服务器（默认端口 8288）
     - 配置 Inngest 数据库（PostgreSQL，数据库名：`easthigh`）

2. **Python SDK 集成**
   - 安装 `inngest` Python SDK（用于编写工作流函数）
   - 在 FastAPI 中注册 Inngest 函数
   - FastAPI 应用与 Inngest 服务器通过 HTTP API 通信
   - 配置事件触发和工作流

3. **多租户支持**
   - 所有 Inngest 函数必须包含 `tenant_id` 参数
   - 工作流执行时自动隔离组织数据
   - 任务监控按组织过滤

4. **错误处理**
   - 配置任务重试策略
   - 配置错误通知
   - 记录任务执行日志

### ProFlow 集成要点

1. **前端组件安装**
   ```bash
   npm install @ant-design/pro-flow
   ```

2. **工作流设计器**
   - 使用 ProFlow 可视化设计工作流
   - 支持节点拖拽、连接线绘制
   - 支持节点属性配置

3. **配置转换**
   - 将 ProFlow 设计转换为 Inngest 工作流配置
   - 保存到数据库
   - 注册到 Inngest

4. **状态展示**
   - 从 Inngest 获取执行状态
   - 在 ProFlow 中高亮当前节点
   - 实时更新执行进度

---

## 🔧 kkFileView 集成说明

### kkFileView 功能覆盖

**kkFileView 已选定作为文件预览服务**：

1. ✅ **文件预览**
   - 支持 23+ 种文件格式
   - 支持 Office 文档（Word、Excel、PPT）
   - 支持 PDF、图片、音视频等
   - 支持在线预览、在线编辑

2. ✅ **预览服务**
   - 独立部署（Java 服务）
   - HTTP API 接口
   - 预览权限控制

### kkFileView 集成要点

1. **服务部署**
   - kkFileView 需要独立部署（Docker 或 Java 服务）
   - 配置预览服务地址
   - 配置预览服务权限

2. **系统集成**
   - 文件上传后生成预览 URL
   - 预览 URL 包含权限验证
   - 预览服务健康检查

3. **多租户支持**
   - 预览 URL 包含组织信息
   - 预览权限按组织隔离
   - 预览日志按组织记录

---

## 🔧 优化建议

### 1. 功能补充

#### 1.1 组织管理补充
- **组织设置**：组织基本信息、Logo、主题色等
- **组织成员管理**：成员邀请、成员权限、成员统计
- **组织数据统计**：组织使用量、成员活跃度等

#### 1.2 安全功能补充
- **密码策略**：密码复杂度、密码过期、密码历史
- **登录安全**：登录失败锁定、IP 白名单、设备管理
- **审计日志**：敏感操作审计、数据变更审计

#### 1.3 通知功能补充
- **通知中心**：统一通知入口、通知分类、通知设置
- **消息推送**：浏览器推送、移动端推送

### 2. 技术优化

#### 2.1 性能优化
- **缓存策略**：数据字典缓存、参数设置缓存、菜单缓存
- **查询优化**：数据库索引优化、查询语句优化
- **前端优化**：代码分割、懒加载、虚拟滚动
- **文件预览优化**：kkFileView 缓存策略、预览服务负载均衡
- **工作流优化**：Inngest 任务并发控制、任务优先级管理

#### 2.2 可扩展性
- **插件系统**：应用插件化、功能插件化
- **API 网关**：统一 API 入口、API 限流、API 监控
- **微服务化**：功能模块微服务化（可选）

### 3. 用户体验优化

#### 3.1 界面优化
- **响应式设计**：移动端适配
- **主题定制**：组织主题色、个人主题偏好
- **国际化**：多语言支持（已有基础）

#### 3.2 交互优化
- **快捷键支持**：常用操作快捷键
- **批量操作**：批量导入、批量导出、批量处理
- **操作引导**：新手引导、功能提示

---

## 📝 实施建议

### 1. 分阶段实施
- **第一阶段**：优先完成基础权限体系，为后续功能提供权限控制基础
- **第二阶段**：完成核心配置，为业务功能提供配置支持
- **第三阶段**：根据业务需求，灵活选择数据中心、流程管理等功能

### 2. 技术选型原则
- **优先使用官方库**：遵循框架规范，优先使用官方推荐的库
- **避免重复造轮子**：使用成熟稳定的第三方库
- **保持技术栈统一**：所有功能使用统一的技术栈

### 3. 代码质量
- **遵循规范**：严格遵循项目代码规范和命名规范
- **完整注释**：所有代码必须包含完整的中文注释
- **测试覆盖**：核心功能测试覆盖率 > 80%

### 4. 文档维护
- **API 文档**：使用 FastAPI 自动生成 API 文档
- **功能文档**：每个功能模块提供详细的功能文档
- **开发文档**：提供开发指南和最佳实践

---

## 🎯 总结

本建设计划详细规划了系统级功能的建设顺序、技术选型和实施建议。建议按照阶段逐步实施，优先完成基础权限体系，然后根据业务需求灵活选择其他功能模块。

**关键成功因素**：
1. **严格遵循框架规范**：确保所有功能符合多租户架构
2. **渐进式建设**：按照依赖关系逐步建设，避免技术债务
3. **代码质量**：保持代码规范、注释完整、测试充分
4. **用户体验**：注重界面设计和交互体验
5. **Inngest 集成**：统一使用 Inngest 处理所有流程相关功能，保持一致性
6. **kkFileView 集成**：统一文件预览体验，支持多种文件格式

---

**最后更新**：2025-01-XX

