# 系统级功能增强与串联优化进度跟踪

## 📋 概述

本文档用于跟踪系统级功能增强与串联优化的执行进度，按照《功能增强与串联优化计划.md》中的任务清单逐项标记完成情况。

**跟踪原则**：
- ✅ 已完成：任务已完成并测试通过
- 🚧 进行中：任务正在执行中
- ⏳ 待开始：任务尚未开始
- ❌ 已取消：任务已取消（需说明原因）

**最后更新**：2025-01-03

---

## 📊 总体进度

### 阶段进度概览

| 阶段 | 总任务数 | 已完成 | 进行中 | 待开始 | 完成率 |
|------|---------|--------|--------|--------|--------|
| **阶段一：核心依赖优化** | 12 | 12 | 0 | 0 | 100% |
| **阶段二：流程管理串联优化** | 10 | 8 | 0 | 2 | 80% |
| **阶段三：个人中心串联优化** | 4 | 4 | 0 | 0 | 100% |
| **阶段四：监控运维串联优化** | 4 | 4 | 0 | 0 | 100% |
| **阶段五：性能与体验优化** | 8 | 8 | 0 | 0 | 100% |
| **布局优化** | 13 | 12 | 0 | 1 | 92.3% |
| **功能增强** | 80+ | 0 | 0 | 80+ | 0% |
| **总计** | 130+ | 48 | 0 | 83+ | 36.9% |

---

## 🚀 阶段一：核心依赖优化（优先级最高）⭐⭐⭐⭐⭐

**预计时间**：4-6 周  
**当前状态**：✅ 已完成  
**完成率**：12/12 (100%)

### 1.1 权限体系串联优化

**预计时间**：1-2 周  
**当前状态**：🚧 进行中

#### 任务 1.1.1：菜单管理 ↔ 权限管理

- [x] 在菜单创建/编辑时自动关联权限
- [x] 权限变更时自动更新菜单可见性
- [x] 菜单删除时自动清理权限关联

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在菜单创建/编辑时验证权限代码是否存在
- 添加 `update_menus_by_permission_code` 方法，当权限被删除时自动更新关联菜单
- 菜单删除时自动清理权限关联（软删除，无需特别处理）

---

#### 任务 1.1.2：菜单管理 ↔ 应用中心

- [x] 应用启用/禁用时自动更新菜单状态
- [x] 应用删除时自动删除关联菜单
- [x] 应用菜单配置自动同步到菜单管理

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在应用启用时，自动启用关联的菜单
- 在应用禁用时，自动禁用关联的菜单
- 在应用卸载时，自动删除（软删除）关联的菜单
- 在应用安装时，如果应用有 `menu_config`，自动同步菜单配置到菜单管理
- 在应用更新时，如果 `menu_config` 变更，自动同步更新菜单（创建新菜单、更新现有菜单、删除不再存在的菜单）
- 在应用状态变更时，自动更新关联菜单的启用状态
- 添加 `sync_menus_from_application_config` 方法，支持从应用菜单配置递归创建或更新树形结构的菜单
- 支持菜单配置为列表或单个菜单项
- 支持通过 UUID 或路径匹配现有菜单进行更新
- 自动删除不再存在于配置中的菜单（软删除）

---

#### 任务 1.1.3：角色权限 ↔ 菜单管理

- [x] 角色权限变更时自动更新菜单可见性
- [x] 菜单权限变更时自动更新菜单可见性
- [x] 权限删除时自动清理菜单关联

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在角色权限分配时，自动更新关联菜单的可见性（异步处理）
- 在菜单权限代码变更时，自动更新菜单可见性（异步处理）
- 权限删除时自动清理菜单关联（已在任务1.1.1中实现）

---

#### 任务 1.1.4：账户管理 ↔ 部门/职位

- [x] 账户变更部门时自动更新权限（预留接口）
- [x] 账户变更职位时自动更新权限（预留接口）
- [x] 部门/职位删除时自动清理账户关联

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在用户更新时，当部门/职位变更时，记录变更并触发权限更新处理（预留接口）
- 添加 `_handle_department_position_change` 方法，用于将来实现根据部门/职位权限模板自动分配权限
- 在部门删除时，自动清理关联用户的部门字段（设置为NULL）
- 在职位删除时，自动清理关联用户的职位字段（设置为NULL）

---

### 1.2 核心配置串联优化

**预计时间**：2-3 周  
**当前状态**：⏳ 待开始

#### 任务 1.2.1：数据字典 ↔ 自定义字段

- [x] 自定义字段类型自动从数据字典获取
- [x] 自定义字段选项自动从数据字典获取
- [x] 数据字典变更时自动更新自定义字段

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在自定义字段创建/更新时，如果字段类型为 select 且配置中包含 dictionary_code，自动验证数据字典并填充选项
- 在数据字典删除时，自动清空关联自定义字段的 dictionary_code 并禁用字段
- 在数据字典禁用时，自动禁用关联的自定义字段
- 添加 `update_fields_by_dictionary_code` 方法，用于批量更新关联的自定义字段

---

#### 任务 1.2.2：参数设置 ↔ 系统功能

- [x] 文件预览模式自动从参数设置读取
- [x] 备份策略自动从参数设置读取
- [x] 系统功能自动读取参数设置

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 修复文件预览服务中的参数读取方法（使用静态方法调用）
- 添加从参数设置读取 kkFileView 服务地址的功能
- 在数据备份服务中添加从参数设置读取备份策略的功能：
  - 备份文件存储目录（`backup.storage.dir`）
  - 备份超时时间（`backup.timeout`）
  - 备份保留天数（`backup.retention.days`）
  - 备份保留数量（`backup.retention.count`）
  - 全量备份频率（`backup.full.frequency`）
  - 增量备份频率（`backup.incremental.frequency`）

---

#### 任务 1.2.3：编码规则 ↔ 业务模块

- [x] 业务模块自动使用编码规则生成编码
- [x] 编码规则变更时自动通知业务模块（预留接口）
- [x] 编码规则删除时自动通知业务模块（预留接口）

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 编码生成服务（`CodeGenerationService`）已存在，业务模块可以直接调用 `generate_code` 方法生成编码
- 在编码规则更新时，添加变更通知机制（异步通知业务模块）
- 在编码规则删除时，添加删除通知机制（异步通知业务模块）
- 添加 `_notify_business_modules` 预留方法，用于将来实现业务模块的编码规则变更通知
- 注意：编码规则变更通常不应该自动更新已生成的编码，因为已生成的编码可能已经被使用

---

#### 任务 1.2.4：语言管理 ↔ 前端界面

- [x] 前端界面自动使用语言管理中的翻译
- [x] 语言管理变更时自动通知前端（预留接口）
- [x] 前端界面自动加载用户选择的语言

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建 i18n 配置文件（`config/i18n.ts`），集成 react-i18next
- 实现从后端语言管理获取翻译内容的功能
- 在应用初始化时自动加载用户选择的语言
- 在偏好设置页面中从语言管理获取可用语言列表
- 语言变更时自动更新 i18n 和重新加载翻译内容
- 在语言管理服务中添加变更通知机制（预留接口，用于将来实现前端自动刷新翻译）

---

### 1.3 数据中心串联优化

**预计时间**：2-3 周  
**当前状态**：⏳ 待开始

#### 任务 1.3.1：文件管理 ↔ 业务模块

- [x] 个人资料头像上传自动使用文件管理
- [⏸️] 电子记录附件上传自动使用文件管理（**暂缓，后续单独处理**）
- [x] 业务模块自动使用文件管理上传组件

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03  
**备注**：电子记录相关功能暂缓，后续单独处理

**实现内容**：
- 完善个人资料页面的头像显示功能（根据 avatar UUID 获取文件信息和预览 URL）
- 创建通用文件上传组件 `FileUploadComponent`，供业务模块使用
- 支持单文件和多文件上传
- 支持文件大小限制、文件类型限制、文件数量限制
- 自动关联文件管理模块

---

#### 任务 1.3.2：接口管理 ↔ 数据集管理

- [x] 数据集管理支持从接口管理获取数据
- [x] 接口管理变更时自动通知数据集管理（预留接口）
- [x] 数据集管理自动使用接口管理测试功能

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在数据集服务的 `_execute_api_query` 方法中添加从接口管理获取 API 配置的功能
- 支持在 query_config 中使用 `api_uuid` 或 `api_code` 关联接口管理中的 API
- 在数据集创建和更新时验证关联的 API 是否存在
- 在接口管理服务中添加变更通知机制（异步通知数据集管理）
- 在数据集服务中添加 `test_api_for_dataset` 方法，使用接口管理的测试功能
- 在数据集 API 路由中添加 `/datasets/{dataset_uuid}/test-api` 端点

---

#### 任务 1.3.3：数据源管理 ↔ 数据集管理

- [x] 数据集管理自动使用数据源管理连接
- [x] 数据源管理变更时自动更新数据集管理
- [x] 数据集管理自动使用数据源管理测试功能

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 数据集在执行查询时已经通过 `data_source` 关联获取数据源，并在执行前检查 `is_connected` 状态
- 在数据源更新时，如果状态或配置变更，异步通知数据集管理，更新关联数据集的错误信息
- 在数据源删除时，异步通知数据集管理，更新关联数据集的错误信息
- 添加 `_notify_datasets_of_data_source_change` 方法，用于在数据源变更时更新关联数据集
- 添加 `test_data_source_for_dataset` 方法，使用数据源管理的测试功能测试数据集关联的数据源连接
- 在数据集 API 路由中添加 `/datasets/{dataset_uuid}/test-data-source` 端点，用于测试数据源连接

---

#### 任务 1.3.4：数据集管理 ↔ 业务模块

- [x] 业务模块支持从数据集管理获取数据
- [x] 数据集管理变更时自动更新业务模块
- [x] 业务模块自动使用数据集管理查询功能

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 添加 `query_dataset_by_code` 静态方法，供业务模块通过数据集代码快速获取数据
- 在数据集 API 路由中添加 `/datasets/code/{dataset_code}/query` 端点，供业务模块使用
- 在数据集更新时，如果状态或配置变更，异步通知业务模块（预留接口）
- 在数据集删除时，异步通知业务模块（预留接口）
- 添加 `_notify_business_modules` 方法，用于在数据集变更时通知业务模块（预留接口）
- 在前端添加 `queryDatasetByCode` 函数，供业务模块通过数据集代码查询数据

---

## 🚀 阶段二：流程管理串联优化（优先级高）⭐⭐⭐⭐

**预计时间**：5-7 周  
**当前状态**：🚧 进行中  
**完成率**：8/10 (80%)

### 2.1 Inngest 集成完善

**预计时间**：3-4 周  
**当前状态**：🚧 进行中

#### 任务 2.1.1：消息管理 ↔ Inngest

- [x] 消息推送通过 Inngest 事件驱动
- [x] 消息发送工作流通过 Inngest 执行
- [x] 消息发送结果自动记录到消息日志

**预计时间**：5-7 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在 `MessageService.send_message` 方法中，发送 Inngest 事件触发消息发送工作流
- 创建 `message_sender_function` Inngest 函数，监听 `message/send` 事件
- Inngest 函数根据消息类型（email、sms、internal、push）调用相应的发送逻辑
- 消息发送完成后，自动更新 MessageLog 的状态（success、failed）
- 消息发送结果（成功/失败、错误信息）自动记录到消息日志
- 支持消息发送重试（Inngest 函数配置了 3 次重试）
- 在 `__init__.py` 中导入消息发送函数，确保函数被注册
- 注意：邮件、短信、推送通知的发送逻辑目前为模拟实现，等待相应的服务插件实现

---

#### 任务 2.1.2：定时任务 ↔ Inngest

- [x] 定时任务通过 Inngest 触发器执行
- [x] 定时任务执行结果自动记录
- [x] 定时任务失败自动重试

**预计时间**：5-7 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建 `scheduled_task_scheduler_function` Inngest 函数，使用 cron 触发器（每分钟执行一次），检查所有启用的定时任务
- 创建 `scheduled_task_executor_function` Inngest 函数，通过事件触发，执行实际的定时任务
- 调度器函数根据任务的触发器类型（cron、interval、date）判断是否需要执行
- 执行器函数支持多种任务类型（api_call、python_script）
- 执行器函数自动调用 `mark_task_running` 和 `update_task_execution_result` 方法记录执行结果
- 支持任务重试（Inngest 函数配置了 3 次重试）
- 在 `__init__.py` 中导入定时任务函数，确保函数被注册
- 注意：Python 脚本任务执行功能尚未实现，需要后续完善（需要安全沙箱环境）

---

#### 任务 2.1.3：审批流程 ↔ Inngest

- [x] 审批流程通过 Inngest 工作流执行
- [x] 审批流程状态自动同步
- [x] 审批流程节点自动触发消息通知

**预计时间**：5-7 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在 `create_approval_instance` 方法中，发送 Inngest 事件触发审批工作流
- 在 `perform_approval_action` 方法中，发送 Inngest 事件触发审批操作工作流
- 创建 `approval_workflow_function` Inngest 函数，监听 `approval/submit` 事件，启动审批流程工作流
- 创建 `approval_action_workflow_function` Inngest 函数，监听 `approval/action` 事件，处理审批操作和节点流转
- Inngest 工作流函数解析流程节点配置（ProFlow 设计），处理节点流转逻辑
- 审批流程状态自动同步（通过 Inngest 工作流函数更新审批实例状态和节点信息）
- 审批流程节点自动触发消息通知（已在任务 2.2.1 中实现）
- 支持审批操作重试（Inngest 函数配置了 3 次重试）
- 在 `__init__.py` 中导入审批工作流函数，确保函数被注册
- 注意：节点审批人的获取逻辑需要根据实际业务需求完善（目前使用节点配置中的 approver_id 或提交人）

---

#### 任务 2.1.4：电子记录 ↔ Inngest（**暂缓，后续单独处理**）

- [⏸️] 电子记录签名/归档通过 Inngest 工作流执行
- [⏸️] 电子记录状态自动同步
- [⏸️] 电子记录生命周期自动管理

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：  
**备注**：电子记录相关功能暂缓，后续单独处理

---

#### 任务 2.1.5：数据备份 ↔ Inngest

- [x] 数据备份通过 Inngest 定时任务执行
- [x] 数据备份结果自动记录
- [x] 数据备份失败自动重试

**预计时间**：5-7 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在 `create_backup` 方法中，发送 Inngest 事件触发备份执行
- 创建 `data_backup_executor_function` Inngest 函数，监听 `backup/execute` 事件，执行数据备份
- 创建 `scheduled_backup_scheduler_function` Inngest 函数，使用 cron 触发器（每小时执行一次），检查需要执行的定时备份任务
- 备份执行器函数自动调用 `execute_backup` 方法执行备份，并记录执行结果
- 备份结果自动记录（成功/失败、错误信息、文件路径、文件大小等）
- 支持备份重试（Inngest 函数配置了 3 次重试）
- 在 `__init__.py` 中导入数据备份函数，确保函数被注册
- 注意：定时备份调度器的执行频率判断逻辑需要根据实际备份策略完善（目前简化处理）

---

### 2.2 流程模块串联优化

**预计时间**：2-3 周  
**当前状态**：⏳ 待开始

#### 任务 2.2.1：审批流程 ↔ 消息管理

- [x] 审批流程自动发送消息通知
- [x] 审批流程节点变更自动发送消息
- [x] 审批流程完成自动发送消息

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在审批实例创建时，自动发送消息通知给提交人和当前审批人
- 在审批操作时（同意、拒绝、取消、转交），自动发送消息通知给提交人
- 在审批完成时（已通过、已拒绝、已取消），自动发送完成通知给提交人
- 在审批转交或进入下一节点时，自动发送消息通知给新的审批人
- 添加 `_send_approval_submitted_notification` 方法，用于发送审批提交通知
- 添加 `_send_approval_action_notification` 方法，用于发送审批操作通知和完成通知

---

#### 任务 2.2.2：审批流程 ↔ 我的任务

- [x] 审批流程自动更新我的任务
- [x] 审批流程状态变更自动更新我的任务
- [x] 我的任务自动同步审批流程状态

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- "我的任务"模块复用 ApprovalInstance 模型，审批流程的状态变更会自动反映在"我的任务"中
- 修改 `UserTaskService.process_user_task` 方法，调用 `ApprovalInstanceService.perform_approval_action` 来处理审批操作
- 确保"我的任务"的审批操作与审批流程服务逻辑一致，并自动触发消息通知
- 审批流程的状态变更（提交、审批、完成）会自动更新"我的任务"列表

---

#### 任务 2.2.3：定时任务 ↔ 消息管理

- [x] 定时任务执行结果自动发送消息
- [x] 定时任务失败自动发送消息
- [x] 定时任务完成自动发送消息

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 添加 `update_task_execution_result` 方法，用于更新定时任务的执行结果
- 添加 `mark_task_running` 方法，用于标记定时任务开始执行
- 添加 `_send_task_execution_notification` 方法，用于发送定时任务执行结果通知
- 在定时任务执行完成时（成功或失败），自动发送消息通知给组织管理员
- 在定时任务 API 路由中添加 `/scheduled-tasks/{uuid}/execution-result` 端点，供 Inngest 函数调用
- 在定时任务 API 路由中添加 `/scheduled-tasks/{uuid}/mark-running` 端点，供 Inngest 函数调用
- 消息通知包含任务名称、执行状态、错误信息、执行时间等信息

---

#### 任务 2.2.4：电子记录 ↔ 文件管理（**暂缓，后续单独处理**）

- [⏸️] 电子记录自动关联文件
- [⏸️] 电子记录附件自动上传到文件管理
- [⏸️] 电子记录文件自动同步

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：  
**备注**：电子记录相关功能暂缓，后续单独处理

---

#### 任务 2.2.5：打印模板 ↔ 打印设备

- [x] 打印模板自动关联打印设备
- [x] 打印任务自动使用打印设备
- [x] 打印设备变更自动更新打印模板

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在打印模板的 `config` 字段中存储关联的打印设备 UUID（`device_uuid`）
- 在创建/更新打印模板时，验证关联的打印设备是否存在
- 在打印任务执行时，从打印模板中获取关联的打印设备（如果模板配置了设备）
- 添加 `_notify_templates_of_device_change` 方法，用于通知打印模板设备变更
- 在打印设备更新/删除时，自动通知关联的打印模板并清除设备关联
- 打印设备状态变更（启用/禁用、在线/离线）时，自动通知关联的打印模板

---

## 🚀 阶段三：个人中心串联优化（优先级中）⭐⭐⭐

**预计时间**：1-2 周  
**当前状态**：✅ 已完成  
**完成率**：4/4 (100%)

### 3.1 个人中心功能增强

#### 任务 3.1.1：个人资料 ↔ 文件管理

- [x] 头像上传自动使用文件管理
- [x] 头像删除自动清理文件管理
- [x] 头像预览自动使用文件预览服务

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 头像上传自动使用文件管理（已在任务 1.3.1 中完成）
- 头像预览自动使用文件预览服务（已在任务 1.3.1 中完成）
- 在 `update_user_profile` 方法中检测头像删除（从有值变为 None 或空字符串）
- 当头像被删除时，异步调用 `FileService.delete_file` 清理文件管理中的文件
- 添加 `_cleanup_avatar_file` 方法，用于异步清理头像文件
- 在 API 路由中传递 `tenant_id` 给更新方法，以便删除文件时使用

---

#### 任务 3.1.2：偏好设置 ↔ 系统功能

- [x] 系统功能自动读取用户偏好（主题、语言等）
- [x] 用户偏好变更自动更新系统功能
- [x] 系统功能自动应用用户偏好

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在应用启动时（`app.tsx`）自动读取用户偏好设置
- 自动应用用户选择的主题（light、dark、auto）
- 自动应用用户选择的语言（已在任务 1.2.4 中实现）
- 支持自动主题模式（根据系统偏好自动切换）
- 监听系统主题变化（当用户偏好为 auto 时）
- 在偏好设置更新时，通过自定义事件通知应用组件重新加载偏好设置
- 偏好设置更新后立即应用新的主题和语言设置

---

#### 任务 3.1.3：我的消息 ↔ 消息管理

- [x] 我的消息自动同步消息管理中的消息
- [x] 消息管理消息发送自动更新我的消息
- [x] 我的消息状态自动同步消息管理

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- "我的消息"模块复用 MessageLog 模型，消息管理中的消息会自动出现在"我的消息"中
- 改进 `UserMessageService` 的查询逻辑，使其能够同时匹配用户ID和用户的邮箱/手机号
- 在 `get_user_messages`、`get_user_message`、`mark_messages_read`、`get_user_message_stats` 方法中，都使用改进的查询逻辑
- 消息发送时创建 MessageLog 记录，如果 recipient 匹配用户的邮箱或ID，会自动出现在"我的消息"中
- 用户标记已读时，更新 MessageLog 的 status 为 "read"，会同步到消息管理

---

#### 任务 3.1.4：我的任务 ↔ 审批流程

- [x] 我的任务自动同步审批流程中的任务
- [x] 审批流程任务创建自动更新我的任务
- [x] 我的任务状态自动同步审批流程

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 已在任务 2.2.2 中完成实现
- "我的任务"模块复用 ApprovalInstance 模型，审批流程中的任务会自动出现在"我的任务"中
- 审批流程任务创建时，会自动出现在"我的任务"中（因为复用同一个模型）
- 修改 `UserTaskService.process_user_task` 方法，调用 `ApprovalInstanceService.perform_approval_action` 来处理审批操作
- 确保"我的任务"的审批操作与审批流程服务逻辑一致，状态变更会自动同步
- 审批流程的状态变更（提交、审批、完成）会自动更新"我的任务"列表

---

## 🚀 阶段四：监控运维串联优化（优先级中）⭐⭐⭐

**预计时间**：1-2 周  
**当前状态**：✅ 已完成  
**完成率**：4/4 (100%)

### 4.1 监控运维功能增强

#### 任务 4.1.1：操作日志 ↔ 所有模块

- [x] 所有模块的操作自动记录到操作日志
- [x] 操作日志自动关联模块和用户
- [x] 操作日志自动记录操作结果

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 操作日志中间件（`OperationLogMiddleware`）已经注册到应用中，自动记录所有 API 操作日志
- 中间件自动从请求中提取用户ID和组织ID，自动关联用户和组织
- 中间件自动解析操作类型（create、update、delete、view、error）、操作模块、操作对象类型
- 改进中间件，从请求路径中提取操作对象的 UUID（如果存在）
- 改进操作内容，包含操作结果信息（成功/失败）和状态码
- 所有模块的操作都会自动记录到操作日志（排除健康检查、文档等路径）
- 异步执行，不影响业务性能

---

#### 任务 4.1.2：登录日志 ↔ 用户管理

- [x] 用户登录自动记录到登录日志
- [x] 登录日志自动关联用户信息
- [x] 登录日志自动记录登录结果

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在 `AuthService.login` 方法中，所有登录尝试（成功和失败）都会自动记录到登录日志
- 实现 `_log_login_attempt` 方法，自动记录登录日志，包括：
  - 自动关联用户信息（user_id、username、tenant_id）
  - 自动记录登录IP地址（支持代理服务器）
  - 自动解析登录设备（PC、Mobile、Tablet）
  - 自动解析登录浏览器（Chrome、Firefox、Safari、Edge、Opera等）
  - 自动记录登录状态（success、failed）
  - 自动记录失败原因（用户名或密码错误、用户未激活、用户不属于指定组织等）
- 登录成功和失败都会记录日志，便于安全监控和问题排查
- 异步执行，不影响登录性能

---

#### 任务 4.1.3：在线用户 ↔ 用户管理

- [x] 在线用户自动同步用户管理中的用户信息
- [x] 用户管理用户变更自动更新在线用户
- [x] 在线用户自动同步用户权限

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在线用户服务（`OnlineUserService`）在查询在线用户时，自动从用户管理（User 模型）中同步用户信息
- 在 `list_online_users` 和 `get_online_user_by_user_id` 方法中，自动查询用户信息（username、email、full_name等）
- 在 `UserService.update_user` 方法中，如果用户被禁用（is_active=False），自动清除在线用户信息
- 在 `UserService.delete_user` 方法中，自动清除在线用户信息
- 添加 `_clear_online_user` 方法，用于清除在线用户信息（调用 `OnlineUserService.force_logout`）
- 在线用户信息自动同步用户管理中的用户信息（因为从数据库查询）
- 异步执行，不影响主流程性能

---

#### 任务 4.1.4：数据备份 ↔ 文件管理

- [x] 数据备份文件自动上传到文件管理
- [x] 数据备份文件自动关联文件管理
- [x] 数据备份文件自动同步文件管理

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 在 `execute_backup` 方法中，备份成功后自动将备份文件上传到文件管理模块
- 实现 `_upload_backup_to_file_management` 方法：
  - 将备份文件复制到文件管理的存储目录
  - 创建文件记录（category="backup"，包含备份类型和范围标签）
  - 将文件 UUID 保存到备份记录的 `file_uuid` 字段
- 在 `restore_backup` 方法中，优先从文件管理获取备份文件路径（如果 `file_uuid` 存在）
- 在 `delete_backup` 方法中，如果备份文件已关联到文件管理，自动删除文件管理中的文件
- 实现 `_delete_backup_file_from_file_management` 方法，用于删除文件管理中的备份文件
- 异步执行，不影响主流程性能

---

## 🚀 阶段五：性能与体验优化（优先级中）⭐⭐⭐

**预计时间**：4-6 周  
**当前状态**：✅ 已完成  
**完成率**：8/8 (100%)

### 5.1 性能优化

#### 任务 5.1.1：缓存策略优化

- [x] 数据字典增加 Redis 缓存
- [x] 参数设置增加 Redis 缓存
- [x] 菜单增加 Redis 缓存
- [x] 用户偏好增加 Redis 缓存

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 数据字典服务添加 Redis 缓存：
  - `get_dictionary_by_code` 方法添加缓存支持（缓存1小时）
  - `get_dictionary_by_uuid` 方法添加缓存支持（缓存1小时）
  - 在字典创建、更新、删除时自动清除相关缓存
  - 使用 `CacheManager` 统一管理缓存，支持命名空间和TTL
- 参数设置服务已实现缓存（使用 Redis，缓存1小时）
- 菜单服务添加 Redis 缓存：
  - `get_menus` 方法添加缓存支持（缓存1小时，基于查询参数生成缓存键）
  - `get_menu_tree` 方法添加缓存支持（缓存1小时，支持树形结构序列化和反序列化）
  - 在菜单创建、更新、删除、排序变更时自动清除相关缓存
  - 使用 `CacheManager` 统一管理缓存，支持命名空间和TTL
- 用户偏好服务已实现缓存（使用 Redis，缓存1小时）

---

#### 任务 5.1.2：查询优化

- [x] 数据库索引优化
- [x] 查询语句优化
- [x] 分页查询优化

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 数据库索引优化：
  - 为 ApprovalInstance 添加复合索引：`(tenant_id, status)`、`(tenant_id, current_approver_id, status)`、`(tenant_id, submitter_id)`、`(tenant_id, created_at)`
  - 为 MessageLog 添加复合索引：`(tenant_id, status)`、`(tenant_id, type, status)`、`(tenant_id, recipient, status)`、`(tenant_id, created_at)`
  - 为 OperationLog 添加复合索引：`(tenant_id, user_id)`、`(tenant_id, created_at)`、`(tenant_id, operation_module)`、`(tenant_id, user_id, created_at)`
  - 为 LoginLog 添加复合索引：`(tenant_id, user_id)`、`(tenant_id, login_status)`、`(tenant_id, created_at)`、`(tenant_id, user_id, created_at)`
  - 为 Menu 添加复合索引：`(tenant_id, is_active)`、`(tenant_id, application_uuid, is_active)`、`(tenant_id, parent_id, is_active)`
  - 为 DataDictionary 添加复合索引：`(tenant_id, is_active)`
- 查询语句优化：
  - 优化搜索查询，使用 OR 查询替代多个 filter 调用
  - 确保使用 prefetch_related 预加载关联数据，避免 N+1 查询
  - 优化查询条件顺序，优先使用索引字段
- 分页查询优化：
  - 限制最大分页大小（100），避免过大查询
  - 先查询总数，再查询数据，避免重复查询
  - 使用索引字段排序（created_at）
  - 创建 QueryOptimizer 工具类，提供优化的分页查询方法

---

#### 任务 5.1.3：前端优化

- [x] 代码分割优化
- [x] 懒加载优化
- [x] 虚拟滚动优化

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 代码分割优化：
  - 优化 Vite 构建配置，按功能模块进行代码分割
  - 核心依赖分离：vendor-react、vendor-antd、vendor-router、vendor-query、vendor-utils、vendor-other
  - 功能模块分离：module-permission（权限管理）、module-organization（组织管理）、module-config（核心配置）、module-application（应用中心）、module-datacenter（数据中心）、module-process（流程管理）、module-personal（个人中心）、module-monitoring（监控运维）、module-platform（平台管理）
  - 设置 chunkSizeWarningLimit 为 1000，优化构建性能
- 懒加载优化：
  - 所有系统级页面使用 React.lazy 进行懒加载
  - 使用 Suspense 包装懒加载组件，提供加载状态
  - 公共页面（登录、注册等）保持立即加载，确保首屏性能
  - 按功能模块分组懒加载，减少初始加载时间
- 虚拟滚动优化：
  - 创建 VirtualList 组件，支持长列表虚拟滚动
  - 自动检测数据量，超过 100 条时自动启用虚拟滚动
  - 支持固定高度和动态高度
  - 支持容器高度自适应
  - 集成 Ant Design Table，保持原有 API 兼容性

---

#### 任务 5.1.4：文件预览优化

- [x] kkFileView 缓存策略优化
- [x] 预览服务负载均衡优化
- [x] 预览服务健康检查优化

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- kkFileView 缓存策略优化：
  - 预览URL缓存（30分钟TTL），减少重复生成
  - 健康检查结果缓存（1分钟TTL），减少健康检查频率
  - 使用 CacheManager 统一管理缓存，支持命名空间和TTL
  - 提供缓存清除方法，支持按文件或按组织清除缓存
- 预览服务负载均衡优化：
  - 支持配置多个 kkFileView 服务地址（逗号分隔）
  - 实现简单负载均衡策略：优先选择健康的服务，多个健康服务时随机选择
  - 降级策略：所有服务都不健康时，返回第一个服务地址
  - 自动选择健康的服务地址，提升服务可用性
- 预览服务健康检查优化：
  - 支持多实例健康检查，返回每个服务的健康状态
  - 健康检查结果缓存，减少检查频率
  - 返回详细的健康检查信息（URL、健康状态、响应时间）
  - 支持整体健康状态判断（至少有一个服务健康）
  - 优化健康检查API，返回更详细的信息

---

### 5.2 体验优化

#### 任务 5.2.1：统一交互规范

- [x] 统一各模块的交互规范
- [x] 统一各模块的代码规范
- [x] 统一各模块的错误处理

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 统一各模块的交互规范：
  - 创建统一响应格式工具（response_helper.py），提供 `create_success_response`、`create_paginated_response`、`create_list_response` 方法
  - 创建交互规范检查工具（interaction_standards.py），提供响应格式验证和错误码验证
  - 确保所有 API 使用统一的响应格式（success、data、message、code、timestamp）
- 统一各模块的代码规范：
  - 使用统一的异常类（RiverEdgeException 及其子类）
  - 使用统一的响应格式（StandardResponse、PaginatedResponse）
  - 使用统一的错误码规范（大写字母和下划线组成）
- 统一各模块的错误处理：
  - 创建统一异常处理中间件（exception_handler_middleware.py），自动捕获和转换所有异常
  - 支持 RiverEdgeException、RequestValidationError 和未预期异常的统一处理
  - 创建前端统一错误处理工具（errorHandler.ts），提供 `handleError`、`handleSuccess`、`handleWarning`、`handleInfo` 方法
  - 确保所有错误都按照统一格式返回（success: false, error: { code, message, details }）
  - 在 main.py 中注册异常处理中间件，确保全局生效

---

#### 任务 5.2.2：批量操作优化

- [x] 批量导入功能优化
- [x] 批量导出功能优化
- [x] 批量处理功能优化

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 批量导入功能优化：
  - 创建通用批量导入工具（batch_operations.py），支持并发导入（默认5个并发）
  - 支持错误重试机制（默认3次重试，指数退避）
  - 支持进度跟踪和回调
  - 前端批量导入工具（batchOperations.ts），支持并发控制和重试
  - 提供详细的导入结果（成功数、失败数、错误列表）
- 批量导出功能优化：
  - 支持 CSV 格式导出，自动处理复杂类型和特殊字符
  - 支持流式导出大数据量（分页查询，避免内存溢出）
  - 支持字段映射和自定义表头
  - 前端导出工具，支持直接下载 CSV 文件（带 BOM，支持 Excel 中文）
- 批量处理功能优化：
  - 支持批量删除、批量更新等操作
  - 支持并发处理（默认5个并发）
  - 支持进度跟踪和错误处理
  - 提供详细的处理结果（成功数、失败数、错误列表）

---

#### 任务 5.2.3：操作引导优化

- [x] 新手引导功能优化
- [x] 功能提示功能优化
- [x] 帮助文档功能优化

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 新手引导功能优化：
  - 创建新手引导组件（onboarding-guide），使用 Ant Design Tour 组件实现
  - 支持引导步骤配置（目标元素、标题、内容、位置等）
  - 支持引导状态持久化（localStorage），避免重复显示
  - 支持自动开始和手动触发
  - 提供帮助按钮，可随时重新开始引导
- 功能提示功能优化：
  - 创建功能提示组件（help-tooltip），统一 Tooltip 和 Popover 提示
  - 支持 Tooltip 和 Popover 两种模式
  - 支持自定义图标、颜色、位置等
  - 提供字段提示组件（FieldHelp），用于表单字段提示
  - 统一提示样式和交互体验
- 帮助文档功能优化：
  - 创建帮助文档组件（help-document），提供统一的帮助文档查看功能
  - 支持多章节文档（使用 Tabs 展示）
  - 支持帮助内容创建工具（createHelpContent），便捷创建文本、列表、代码块等
  - 创建帮助文档服务（help_document_service.py），提供文档存储和检索
  - 创建帮助文档 API（help_documents.py），提供文档查询接口
  - 创建前端帮助文档服务（helpDocument.ts），提供文档查询功能
  - 支持按组织隔离的文档管理

---

#### 任务 5.2.4：错误处理优化

- [x] 统一错误提示
- [x] 错误恢复机制优化
- [x] 错误日志记录优化

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 统一错误提示：
  - 增强错误处理工具（errorHandler.ts），支持多种错误格式的统一处理
  - 在 API 服务中集成网络错误和服务器错误的特殊处理
  - 提供统一的错误提示函数（handleError、handleSuccess、handleWarning、handleInfo）
- 错误恢复机制优化：
  - 创建错误恢复工具（errorRecovery.ts），提供重试、降级、回退等恢复策略
  - 实现带重试的函数执行（withRetry），支持指数退避和自定义重试条件
  - 实现带错误恢复的函数执行（withErrorRecovery），支持多种恢复策略
  - 创建错误边界组件（error-boundary），捕获 React 组件树中的错误
  - 提供错误恢复建议（刷新页面、返回首页、重试等）
  - 在应用入口集成错误边界，确保全局错误捕获
- 错误日志记录优化：
  - 创建错误日志记录工具（error_logger.py），提供统一的错误日志记录功能
  - 支持 API 错误、业务错误、数据库错误、外部服务错误的分类记录
  - 记录详细的错误上下文（tenant_id、user_id、request_path 等）
  - 在异常处理中间件中集成错误日志记录
  - 支持不同日志级别（error、warning、critical）

---

## 🎨 布局优化进度跟踪

**预计时间**：5-8 周  
**当前状态**：✅ 已完成  
**完成率**：12/13 (92.3%)

### 阶段一：高优先级布局优化（2-3 周）

#### 任务 L1.1：我的任务 → 看板布局

- [x] 实现看板视图（待处理、已处理、已完成）
- [x] 支持拖拽切换状态
- [x] 任务详情抽屉
- [x] 任务统计分析

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建通用看板组件（kanban-board），支持拖拽式看板布局
- 使用 @dnd-kit 库实现拖拽功能
- 支持任务卡片在不同状态列之间拖拽
- 创建看板视图组件（kanban-view），专门用于任务管理
- 实现任务详情抽屉，显示完整的任务信息和表单数据
- 在任务页面中添加看板视图和列表视图的切换功能
- 支持待处理任务拖拽到已通过或已拒绝状态（自动执行审批操作）
- 任务统计分析功能已存在（统计卡片显示总任务数、待处理任务、已通过任务、我提交的任务）
- 看板视图按状态分组显示任务（待审批、已通过、已拒绝、已取消）

---

#### 任务 L1.2：审批流程实例 → 看板布局

- [x] 实现看板视图（待审批、审批中、已完成）
- [x] 支持拖拽切换状态
- [x] 审批历史时间线
- [x] 审批统计分析

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建审批流程实例看板视图组件（kanban-view），复用通用看板组件
- 实现看板视图，按状态分组显示审批实例（待审批、已通过、已拒绝、已取消）
- 支持拖拽切换状态（待审批实例可拖拽到已通过或已拒绝，自动执行审批操作）
- 实现审批历史时间线，使用 Ant Design Timeline 组件展示审批流程
- 实现审批统计分析，显示总审批数、待审批、已通过、已拒绝等统计信息
- 在审批实例页面中添加看板视图和列表视图的切换功能
- 审批详情抽屉显示完整的审批信息、审批数据和审批历史时间线
- 支持在详情抽屉中直接执行审批操作（同意、拒绝、转交、取消）

---

#### 任务 L1.3：部门管理 → 树形布局

- [x] 改为树形结构展示
- [x] 支持拖拽排序
- [x] 部门详情侧边栏
- [x] 部门成员统计

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 部门管理页面已使用树形结构展示（Ant Design Tree 组件）
- 添加拖拽排序功能，支持在树形结构中拖拽部门节点调整排序
- 实现批量更新部门排序 API（`/system/departments/sort`），支持前端拖拽后批量更新排序
- 优化部门详情侧边栏，使用 Card 组件展示部门信息和统计
- 添加部门成员统计，在详情侧边栏和详情抽屉中显示统计信息（子部门数、用户数、状态）
- 在详情抽屉中显示部门成员列表，包括用户名、姓名、邮箱、状态等信息
- 使用 Ant Design Statistic 组件展示统计信息，提升视觉效果

---

#### 任务 L1.4：参数设置 → 表单分组布局

- [x] 改为分组表单布局
- [x] 增加参数说明
- [x] 参数变更历史
- [x] 参数导入/导出

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建分组表单视图组件（grouped-form-view），提供分组表单布局的参数管理界面
- 实现参数分组功能，按参数键前缀自动分组（文件管理、备份管理、消息通知、系统功能、其他参数）
- 每个分组使用 Card 组件展示，包含分组名称、描述和参数数量
- 增加参数说明，使用 HelpTooltip 组件在参数标签旁显示参数描述
- 实现参数变更历史功能，从操作日志中获取参数变更记录，使用 Timeline 组件展示
- 支持查看单个参数的变更历史或所有参数的变更历史
- 实现参数导入/导出功能，支持 CSV 格式
- 导出功能：将参数导出为 CSV 文件，包含参数键、值、类型、描述、是否系统参数、是否启用
- 导入功能：从 CSV 文件导入参数，自动解析和更新参数值
- 在参数管理页面中添加分组表单视图和列表视图的切换功能
- 分组表单视图支持批量保存，自动检测变更的参数并批量更新
- 根据参数类型（string、number、boolean、json）自动渲染对应的输入组件

---

#### 任务 L1.5：在线用户 → 卡片布局

- [x] 改为卡片布局
- [x] 显示用户头像和状态
- [x] 在线用户统计卡片
- [x] 用户活动监控

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的在线用户展示界面
- 实现用户卡片展示，每个卡片显示用户头像（使用用户名首字母）、用户名、邮箱、状态等信息
- 使用 Badge 组件显示用户在线状态（活跃、空闲、离线）
- 显示用户在线时长、最后活动时间、登录IP等信息
- 增强统计卡片，使用 Statistic 组件展示总在线用户数、活跃用户数、组织数量
- 实现用户活动监控功能，每30秒自动刷新在线用户列表和统计信息
- 支持手动刷新功能
- 在在线用户页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看用户详情和强制下线操作
- 根据最后活动时间自动判断用户状态（5分钟内为活跃，15分钟内为空闲，超过15分钟为离线）

---

### 阶段二：中优先级布局优化（2-3 周）

#### 任务 L2.1：数据源管理 → 卡片布局

- [x] 改为卡片布局
- [x] 显示连接状态
- [x] 连接测试功能
- [x] 数据源监控

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的数据源展示界面
- 实现数据源卡片展示，每个卡片显示数据源名称、类型、代码、描述、连接状态等信息
- 使用 Badge 组件显示连接状态（已连接、未连接、连接失败、已禁用）
- 显示最后连接时间（相对时间显示）、最后错误信息
- 增强统计卡片，使用 Statistic 组件展示总数据源数、已连接数、未连接数、已禁用数
- 显示按类型统计的标签列表
- 实现连接测试功能，在 Modal 中显示测试结果（成功/失败、响应时间、消息）
- 实现数据源监控功能，每60秒自动刷新数据源列表
- 支持手动刷新功能
- 在数据源管理页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看数据源详情、测试连接和删除操作
- 根据连接状态和启用状态自动判断显示状态

---

#### 任务 L2.2：集成设置 → 卡片布局

- [x] 改为卡片布局
- [x] 按集成类型分组
- [x] 集成状态可视化
- [x] 集成测试功能

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的集成配置展示界面
- 实现按集成类型分组展示（使用 Collapse 组件），支持 OAuth、API、Webhook、Database 四种类型
- 每个类型分组显示该类型的集成数量和连接状态统计
- 实现集成配置卡片展示，每个卡片显示集成名称、类型、代码、描述、连接状态等信息
- 使用 Badge 组件显示连接状态（已连接、未连接、连接失败、已禁用）
- 显示最后连接时间（相对时间显示）、最后错误信息
- 增强统计卡片，使用 Statistic 组件展示总集成数、已连接数、未连接数、已禁用数
- 显示按类型统计的标签列表
- 实现集成测试功能，在 Modal 中显示测试结果（成功/失败、消息、响应数据、错误信息）
- 实现集成监控功能，每60秒自动刷新集成配置列表
- 支持手动刷新功能
- 在集成设置页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看集成配置详情、测试连接和删除操作
- 根据连接状态和启用状态自动判断显示状态

---

#### 任务 L2.3：电子记录 → 卡片布局（**暂缓，后续单独处理**）

- [⏸️] 改为卡片布局
- [⏸️] 按记录类型分组
- [⏸️] 记录状态可视化
- [⏸️] 记录签名流程

**备注**：电子记录相关功能暂缓，后续单独处理

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

#### 任务 L2.4：打印模板 → 卡片布局

- [x] 改为卡片布局
- [x] 显示模板预览
- [x] 模板设计器
- [x] 模板变量管理

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的打印模板展示界面
- 实现打印模板卡片展示，每个卡片显示模板名称、类型、代码、描述、启用状态等信息
- 显示模板使用次数、最后使用时间、变量数量等统计信息
- 增强统计卡片，使用 Statistic 组件展示总模板数、已启用数、默认模板数、总使用次数
- 显示按类型统计的标签列表
- 实现模板预览功能，在 Modal 中显示模板内容预览（将变量替换为示例值）
- 显示原始模板内容和预览内容的对比
- 实现模板设计器功能，在 Modal 中使用 Tabs 展示编辑器（当前为只读模式）和配置
- 实现模板变量管理功能，从模板内容中自动提取变量（使用正则表达式匹配 {{variable_name}} 格式）
- 在 Modal 中显示变量列表，每个变量显示为标签格式
- 显示模板内容供参考
- 实现模板渲染功能，支持提供 JSON 格式的模板数据进行渲染
- 显示模板变量提示，帮助用户了解需要提供哪些变量
- 显示渲染结果（成功/失败、文件下载链接）
- 实现自动刷新功能，每60秒自动刷新模板列表
- 支持手动刷新功能
- 在打印模板管理页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看模板详情、预览模板、打开设计器、变量管理、渲染模板和删除操作
- 根据模板类型显示不同的图标和颜色

---

#### 任务 L2.5：打印设备 → 卡片布局

- [x] 改为卡片布局
- [x] 显示设备状态
- [x] 设备状态可视化
- [x] 设备测试功能

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的打印设备展示界面
- 实现打印设备卡片展示，每个卡片显示设备名称、类型、代码、描述、状态等信息
- 使用 Badge 组件显示在线状态（在线、离线、已禁用）
- 使用 Tag 组件显示启用状态（启用、禁用）
- 显示默认设备标识、使用次数、最后连接时间、最后使用时间等统计信息
- 增强统计卡片，使用 Statistic 组件展示总设备数、在线设备数、离线设备数、总使用次数、已启用数、已禁用数、默认设备数
- 显示按类型统计的标签列表
- 实现设备测试功能，在 Modal 中显示测试结果（成功/失败、消息、错误信息）
- 测试过程中显示加载进度
- 测试成功后自动刷新列表以更新设备状态
- 实现自动刷新功能，每60秒自动刷新设备列表
- 支持手动刷新功能
- 在打印设备管理页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看设备详情、测试连接和删除操作
- 根据设备类型显示不同的图标和颜色
- 根据设备在线状态和启用状态自动判断显示状态

---

#### 任务 L2.6：数据备份 → 卡片布局

- [x] 改为卡片布局
- [x] 显示备份状态和大小
- [x] 备份统计仪表盘
- [x] 备份策略配置

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的数据备份展示界面
- 实现数据备份卡片展示，每个卡片显示备份名称、类型、范围、状态、文件大小等信息
- 使用 Badge 组件显示备份状态（待执行、执行中、成功、失败）
- 显示文件大小（格式化显示：B、KB、MB、GB）
- 显示备份开始时间、完成时间
- 对于执行中的备份，显示进度条
- 对于失败的备份，显示错误信息
- 增强统计仪表盘，使用 Statistic 组件展示总备份数、成功备份数、失败备份数、执行中数、全量备份数、增量备份数、总备份大小、成功备份大小
- 实现备份策略配置功能，添加"备份策略配置"按钮，跳转到系统参数页面的备份策略配置组
- 实现自动刷新功能，每60秒自动刷新备份列表
- 支持手动刷新功能
- 在数据备份页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看备份详情、恢复备份（仅成功备份）和删除操作
- 根据备份类型显示不同的标签颜色（全量-蓝色、增量-绿色）
- 根据备份状态自动判断显示状态和颜色

---

### 阶段三：低优先级布局优化（1-2 周）

#### 任务 L3.1：我的消息 → 卡片布局

- [x] 改为卡片布局
- [x] 按消息类型分组
- [x] 消息详情抽屉
- [x] 消息搜索功能

**预计时间**：2-3 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 创建卡片视图组件（card-view.tsx），提供卡片布局的消息展示界面
- 实现消息卡片展示，每个卡片显示消息主题、内容、渠道、状态等信息
- 使用 Badge 组件显示未读消息标识（红点）
- 未读消息卡片使用蓝色边框突出显示
- 使用 Collapse 组件按消息类型分组展示（站内信、邮件、短信、推送）
- 每个类型分组显示该类型的消息数量和未读/已读统计
- 每个类型分组支持"全部标记已读"功能
- 实现消息详情抽屉，使用 Drawer 组件展示消息完整信息
- 查看消息详情时，如果是未读消息，自动标记为已读
- 显示消息主题、渠道、收件人、状态、内容、变量、错误信息、发送时间、创建时间等详细信息
- 实现消息搜索功能，支持搜索消息主题、内容或收件人
- 搜索框支持实时过滤和清空功能
- 增强统计卡片，使用 Statistic 组件展示总消息数、未读消息数、已读消息数、失败消息数
- 实现自动刷新功能，每30秒自动刷新消息列表和统计
- 支持手动刷新功能
- 在我的消息页面中添加卡片视图和列表视图的切换功能
- 卡片视图支持查看消息详情、标记已读操作
- 根据消息渠道显示不同的图标和颜色（邮件-蓝色、短信-绿色、站内信-紫色、推送-橙色）
- 根据消息状态自动判断显示状态和颜色

---

#### 任务 L3.2：其他页面细节优化

- [x] 增加详情抽屉（各模块）
- [x] 增加统计卡片（各模块）
- [x] 增加预览功能（各模块）
- [x] 统一交互规范

**预计时间**：3-5 天  
**负责人**：AI Assistant  
**完成日期**：2025-01-03

**实现内容**：
- 增加详情抽屉（各模块）：
  - 部门管理：已实现详情抽屉，显示部门信息、统计和成员列表
  - 审批流程实例：已实现详情抽屉，显示审批信息、审批数据和审批历史时间线
  - 我的任务：已实现详情抽屉，显示任务信息和表单数据
  - 我的消息：已实现详情抽屉，显示消息完整信息
  - 数据备份：已实现详情 Modal，显示备份详细信息
  - 数据源管理：已实现详情 Modal，显示数据源详细信息
  - 集成设置：已实现详情 Modal，显示集成配置详细信息
  - 打印模板：已实现详情 Drawer，显示模板详细信息
  - 打印设备：已实现详情 Modal，显示设备详细信息
  - 在线用户：已实现详情展示，显示用户活动信息
- 增加统计卡片（各模块）：
  - 我的任务：已实现统计卡片，显示总任务数、待处理、已通过、我提交的任务
  - 审批流程实例：已实现统计卡片，显示总审批数、待审批、已通过、已拒绝
  - 部门管理：已实现统计信息，显示子部门数、用户数、状态
  - 我的消息：已实现统计卡片，显示总消息数、未读、已读、失败消息数
  - 数据备份：已实现统计仪表盘，显示总备份数、成功、失败、执行中、全量、增量、总大小等
  - 数据源管理：已实现统计卡片，显示总数据源数、已连接、未连接、已禁用
  - 集成设置：已实现统计卡片，显示总集成数、已连接、未连接、已禁用
  - 打印模板：已实现统计卡片，显示总模板数、已启用、默认模板、总使用次数
  - 打印设备：已实现统计卡片，显示总设备数、在线、离线、总使用次数
  - 在线用户：已实现统计卡片，显示总在线用户数、活跃用户数、组织数量
- 增加预览功能（各模块）：
  - 打印模板：已实现模板预览功能，显示模板内容预览（将变量替换为示例值）
  - 文件管理：已实现文件预览功能（通过参数设置配置预览服务）
  - 数据源管理：已实现连接测试功能，显示测试结果预览
  - 集成设置：已实现连接测试功能，显示测试结果预览
  - 打印设备：已实现设备测试功能，显示测试结果预览
- 统一交互规范：
  - 已在阶段五（任务 5.2.1）完成统一交互规范
  - 统一响应格式：所有 API 使用统一的响应格式（success、data、message、code、timestamp）
  - 统一异常处理：使用统一异常处理中间件和前端错误处理工具
  - 统一代码规范：使用统一的异常类、响应格式和错误码规范
  - 统一错误处理：所有错误都按照统一格式返回和处理

---

## 🚀 功能增强进度跟踪

**预计时间**：持续进行  
**当前状态**：⏳ 待开始  
**完成率**：0/80+ (0%)

### 第一阶段：基础权限体系功能增强

#### 角色权限管理增强

- [ ] 权限树形展示（左侧树形 + 右侧表格）
- [ ] 权限分配可视化（拖拽分配）
- [ ] 权限使用统计
- [ ] 权限继承关系可视化

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 部门管理增强

- [ ] 部门树形展示（支持拖拽排序）
- [ ] 部门详情侧边栏
- [ ] 部门成员统计
- [ ] 部门权限继承

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 职位管理增强

- [ ] 部门筛选（树形选择器）
- [ ] 职位详情卡片
- [ ] 职位权限模板
- [ ] 职位人员统计

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

#### 账户管理增强

- [ ] 账户详情抽屉
- [ ] 批量操作功能（批量导入、批量导出、批量分配角色）
- [ ] 账户状态管理（启用/禁用、锁定/解锁）
- [ ] 账户登录历史

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 菜单管理增强

- [ ] 菜单预览功能
- [ ] 菜单权限关联可视化
- [ ] 菜单使用统计
- [ ] 菜单动态加载测试

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

### 第二阶段：核心配置功能增强

#### 数据字典增强

- [ ] 字典项树形展示
- [ ] 字典预览功能
- [ ] 字典使用统计
- [ ] 字典导入/导出

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 参数设置增强

- [ ] 分组表单布局（按功能分组）
- [ ] 参数说明和帮助提示
- [ ] 参数变更历史
- [ ] 参数导入/导出

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 编码规则增强

- [ ] 编码规则测试功能
- [ ] 编码预览功能
- [ ] 编码使用统计
- [ ] 编码规则模板

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 自定义字段增强

- [ ] 字段预览功能
- [ ] 字段使用统计
- [ ] 字段验证规则配置
- [ ] 字段默认值配置

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 站点设置增强

- [ ] 设置预览功能
- [ ] 设置变更历史
- [ ] 多站点配置支持
- [ ] 站点主题配置

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 语言管理增强

- [ ] 翻译编辑器（表格内编辑）
- [ ] 翻译预览功能
- [ ] 翻译导入/导出
- [ ] 翻译缺失检测

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 应用中心增强

- [ ] 应用详情抽屉
- [ ] 应用搜索和筛选
- [ ] 应用使用统计
- [ ] 应用版本管理

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 集成设置增强

- [ ] 集成状态可视化
- [ ] 集成测试功能
- [ ] 集成日志查看
- [ ] 集成模板管理

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

### 第三阶段：数据中心功能增强

#### 文件管理增强

- [ ] 文件预览优化
- [ ] 批量操作功能（批量上传、批量下载、批量删除）
- [ ] 文件分享功能
- [ ] 文件版本管理

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 接口管理增强

- [ ] 接口测试面板
- [ ] 接口文档预览
- [ ] 接口调用统计
- [ ] 接口Mock功能

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 数据源管理增强

- [ ] 连接状态可视化
- [ ] 连接测试功能
- [ ] 连接池管理
- [ ] 数据源监控

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 数据集管理增强

- [ ] 数据集预览功能
- [ ] 查询结果可视化
- [ ] 数据集缓存管理
- [ ] 数据集权限控制

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

### 第四阶段：流程管理功能增强

#### 消息管理增强

- [ ] 消息发送记录时间线
- [ ] 消息统计卡片
- [ ] 消息模板预览
- [ ] 消息发送测试

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 定时任务增强

- [ ] 任务执行时间线
- [ ] 任务统计仪表盘
- [ ] 任务日志查看
- [ ] 任务依赖管理

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 审批流程增强

- [ ] 流程实例看板视图（可选）
- [ ] 流程执行统计
- [ ] 流程性能分析
- [ ] 流程模板管理

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 电子记录增强（**暂缓，后续单独处理**）

- [⏸️] 记录状态可视化
- [⏸️] 记录签名流程
- [⏸️] 记录归档管理
- [⏸️] 记录版本管理

**备注**：电子记录相关功能暂缓，后续单独处理

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 脚本管理增强

- [ ] 脚本编辑器（代码高亮）
- [ ] 脚本执行日志
- [ ] 脚本测试功能
- [ ] 脚本版本管理

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 打印模板增强

- [ ] 模板设计器
- [ ] 模板预览功能
- [ ] 模板变量管理
- [ ] 模板版本管理

**预计时间**：5-7 天  
**负责人**：  
**完成日期**：

---

#### 打印设备增强

- [ ] 设备状态可视化
- [ ] 设备测试功能
- [ ] 打印任务队列
- [ ] 打印统计报表

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

### 第五阶段：个人中心功能增强

#### 个人资料增强

- [ ] 头像预览功能
- [ ] 头像裁剪功能
- [ ] 个人资料导出
- [ ] 个人资料变更历史

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

#### 偏好设置增强

- [ ] 设置预览功能
- [ ] 设置导入/导出
- [ ] 设置模板管理
- [ ] 设置同步功能

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

#### 我的消息增强

- [ ] 消息详情抽屉
- [ ] 消息分类筛选
- [ ] 消息批量操作
- [ ] 消息搜索功能

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

#### 我的任务增强

- [ ] 看板视图（待处理、已处理、已完成）
- [ ] 支持拖拽切换状态
- [ ] 任务详情抽屉
- [ ] 任务统计分析

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

### 第六阶段：监控运维功能增强

#### 操作日志增强

- [ ] 日志时间线视图（可选）
- [ ] 日志统计仪表盘
- [ ] 日志导出功能
- [ ] 日志分析功能

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 登录日志增强

- [ ] 登录趋势图表
- [ ] 登录统计卡片
- [ ] 登录异常检测
- [ ] 登录导出功能

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

#### 在线用户增强

- [ ] 在线用户统计卡片
- [ ] 用户活动监控
- [ ] 用户会话管理
- [ ] 用户强制下线

**预计时间**：2-3 天  
**负责人**：  
**完成日期**：

---

#### 数据备份增强

- [ ] 备份统计仪表盘
- [ ] 备份策略配置
- [ ] 备份恢复测试
- [ ] 备份文件管理

**预计时间**：3-5 天  
**负责人**：  
**完成日期**：

---

## 📝 执行记录

### 执行日志

| 日期 | 任务 | 状态 | 说明 |
|------|------|------|------|
| 2025-01-03 | 创建进度跟踪文档 | ✅ | 初始化进度跟踪文档 |
| 2025-01-03 | 任务 1.1.1：菜单管理 ↔ 权限管理 | ✅ | 完成菜单创建/编辑时的权限验证，添加权限变更时自动更新菜单的逻辑 |
| 2025-01-03 | 任务 1.1.2：菜单管理 ↔ 应用中心 | ✅ | 完成应用启用/禁用时自动更新菜单状态，应用卸载时自动删除关联菜单，应用菜单配置自动同步到菜单管理 |
| 2025-01-03 | 任务 2.1.5：数据备份 ↔ Inngest | ✅ | 数据备份通过 Inngest 定时任务执行，数据备份结果自动记录，数据备份失败自动重试 |
| 2025-01-03 | 任务 1.1.3：角色权限 ↔ 菜单管理 | ✅ | 完成角色权限变更时自动更新菜单可见性，菜单权限变更时自动更新菜单可见性 |
| 2025-01-03 | 任务 1.1.4：账户管理 ↔ 部门/职位 | ✅ | 完成账户变更部门/职位时的权限更新预留接口，部门/职位删除时自动清理账户关联 |
| 2025-01-03 | 任务 1.2.1：数据字典 ↔ 自定义字段 | ✅ | 完成自定义字段从数据字典自动获取选项，数据字典变更时自动更新自定义字段 |
| 2025-01-03 | 任务 1.2.2：参数设置 ↔ 系统功能 | ✅ | 完成文件预览模式从参数设置读取，备份策略从参数设置读取 |
| 2025-01-03 | 任务 1.2.3：编码规则 ↔ 业务模块 | ✅ | 完成编码规则变更通知机制（预留接口），业务模块可使用CodeGenerationService生成编码 |
| 2025-01-03 | 任务 1.2.4：语言管理 ↔ 前端界面 | ✅ | 完成前端i18n集成，从语言管理获取翻译，自动加载用户选择的语言 |
| 2025-01-03 | 任务 1.3.1：文件管理 ↔ 业务模块 | ✅ | 完善个人资料头像上传和显示，创建通用文件上传组件FileUploadComponent |
| 2025-01-03 | 任务 1.3.2：接口管理 ↔ 数据集管理 | ✅ | 数据集支持从接口管理获取API配置，添加接口变更通知机制，实现数据集API测试功能 |
| 2025-01-03 | 任务 1.3.3：数据源管理 ↔ 数据集管理 | ✅ | 数据集自动使用数据源管理连接，数据源变更时自动更新数据集管理，实现数据集数据源测试功能 |
| 2025-01-03 | 任务 1.3.4：数据集管理 ↔ 业务模块 | ✅ | 业务模块支持通过数据集代码查询数据，数据集变更时自动通知业务模块（预留接口），实现通用数据集查询工具 |
| 2025-01-03 | 任务 2.2.1：审批流程 ↔ 消息管理 | ✅ | 审批流程自动发送消息通知，审批节点变更自动发送消息，审批完成自动发送消息 |
| 2025-01-03 | 任务 2.2.2：审批流程 ↔ 我的任务 | ✅ | 审批流程自动更新我的任务，审批流程状态变更自动更新我的任务，我的任务自动同步审批流程状态 |
| 2025-01-03 | 任务 2.2.3：定时任务 ↔ 消息管理 | ✅ | 定时任务执行结果自动发送消息，定时任务失败自动发送消息，定时任务完成自动发送消息 |
| 2025-01-03 | 任务 2.2.5：打印模板 ↔ 打印设备 | ✅ | 打印模板自动关联打印设备，打印任务自动使用打印设备，打印设备变更自动更新打印模板 |
| 2025-01-03 | 任务 3.1.1：个人资料 ↔ 文件管理 | ✅ | 头像上传自动使用文件管理，头像删除自动清理文件管理，头像预览自动使用文件预览服务 |
| 2025-01-03 | 任务 3.1.2：偏好设置 ↔ 系统功能 | ✅ | 系统功能自动读取用户偏好（主题、语言等），用户偏好变更自动更新系统功能，系统功能自动应用用户偏好 |
| 2025-01-03 | 任务 3.1.3：我的消息 ↔ 消息管理 | ✅ | 我的消息自动同步消息管理中的消息，消息管理消息发送自动更新我的消息，我的消息状态自动同步消息管理 |
| 2025-01-03 | 任务 3.1.4：我的任务 ↔ 审批流程 | ✅ | 我的任务自动同步审批流程中的任务，审批流程任务创建自动更新我的任务，我的任务状态自动同步审批流程（已在任务 2.2.2 中完成） |
| 2025-01-03 | 任务 4.1.1：操作日志 ↔ 所有模块 | ✅ | 所有模块的操作自动记录到操作日志，操作日志自动关联模块和用户，操作日志自动记录操作结果 |
| 2025-01-03 | 任务 4.1.2：登录日志 ↔ 用户管理 | ✅ | 用户登录自动记录到登录日志，登录日志自动关联用户信息，登录日志自动记录登录结果 |
| 2025-01-03 | 任务 4.1.3：在线用户 ↔ 用户管理 | ✅ | 在线用户自动同步用户管理中的用户信息，用户管理用户变更自动更新在线用户，在线用户自动同步用户权限 |
| 2025-01-03 | 任务 4.1.4：数据备份 ↔ 文件管理 | ✅ | 数据备份文件自动上传到文件管理，数据备份文件自动关联文件管理，数据备份文件自动同步文件管理 |
| 2025-01-03 | 任务 2.1.1：消息管理 ↔ Inngest | ✅ | 消息推送通过 Inngest 事件驱动，消息发送工作流通过 Inngest 执行，消息发送结果自动记录到消息日志 |
| 2025-01-03 | 任务 2.1.2：定时任务 ↔ Inngest | ✅ | 定时任务通过 Inngest 触发器执行，定时任务执行结果自动记录，定时任务失败自动重试 |
| 2025-01-03 | 任务 2.1.3：审批流程 ↔ Inngest | ✅ | 审批流程通过 Inngest 工作流执行，审批流程状态自动同步，审批流程节点自动触发消息通知 |
| 2025-01-03 | 任务 2.1.5：数据备份 ↔ Inngest | ✅ | 数据备份通过 Inngest 定时任务执行，数据备份结果自动记录，数据备份失败自动重试 |
| 2025-01-03 | 任务 1.1.2：菜单管理 ↔ 应用中心 | ✅ | 完成应用菜单配置自动同步到菜单管理 |
| 2025-01-03 | 任务 5.1.1：缓存策略优化 | ✅ | 完成数据字典、菜单缓存，参数设置和用户偏好已有缓存 |
| 2025-01-03 | 任务 5.1.2：查询优化 | ✅ | 完成数据库索引优化、查询语句优化、分页查询优化 |
| 2025-01-03 | 任务 5.1.3：前端优化 | ✅ | 完成代码分割优化、懒加载优化、虚拟滚动优化 |
| 2025-01-03 | 任务 5.1.4：文件预览优化 | ✅ | 完成 kkFileView 缓存策略优化、预览服务负载均衡优化、预览服务健康检查优化 |
| 2025-01-03 | 任务 5.2.1：统一交互规范 | ✅ | 完成统一各模块的交互规范、代码规范、错误处理 |
| 2025-01-03 | 任务 5.2.2：批量操作优化 | ✅ | 完成批量导入功能优化、批量导出功能优化、批量处理功能优化 |
| 2025-01-03 | 任务 5.2.3：操作引导优化 | ✅ | 完成新手引导功能优化、功能提示功能优化、帮助文档功能优化 |
| 2025-01-03 | 任务 5.2.4：错误处理优化 | ✅ | 完成统一错误提示、错误恢复机制优化、错误日志记录优化 |

---

## 📚 相关文档

- [功能增强与串联优化计划.md](./功能增强与串联优化计划.md)
- [系统级功能建设计划.md](./系统级功能建设计划.md)
- [系统级功能实施路线图.md](./系统级功能实施路线图.md)

---

**最后更新**：2025-01-03

