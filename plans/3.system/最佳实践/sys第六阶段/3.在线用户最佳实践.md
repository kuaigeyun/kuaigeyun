# åœ¨çº¿ç”¨æˆ·æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šåœ¨çº¿ç”¨æˆ·ï¼ˆOnline Usersï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š1 å‘¨  
**ä¾èµ–**ï¼šç”¨æˆ·ç®¡ç†ã€Redisï¼ˆéœ€è¦ä¼šè¯å­˜å‚¨ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- åœ¨çº¿ç”¨æˆ·æŸ¥è¯¢ï¼ˆä» Redis è¯»å–ä¼šè¯ä¿¡æ¯ï¼‰
- ç”¨æˆ·ä¼šè¯ç®¡ç†ï¼ˆæŸ¥çœ‹ä¼šè¯è¯¦æƒ…ã€å¼ºåˆ¶ä¸‹çº¿ï¼‰
- åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ï¼ˆåœ¨çº¿äººæ•°ã€æ´»è·ƒç”¨æˆ·æ•°ï¼‰

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **ä» Redis è¯»å–**ï¼šä» Redis ä¼šè¯ä¸­æå–åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
- âœ… **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒæŸ¥çœ‹ç”¨æˆ·ä¼šè¯è¯¦æƒ…ã€å¼ºåˆ¶ä¸‹çº¿
- âœ… **å®æ—¶ç»Ÿè®¡**ï¼šå®æ—¶ç»Ÿè®¡åœ¨çº¿ç”¨æˆ·æ•°ã€æ´»è·ƒç”¨æˆ·æ•°

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### åœ¨çº¿ç”¨æˆ·å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **ä» Redis è¯»å–ä¼šè¯ä¿¡æ¯ï¼ˆæ¨èï¼‰**

#### æ–¹æ¡ˆä¸€ï¼šä» Redis è¯»å–ä¼šè¯ä¿¡æ¯ â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€æ–°å»ºè¡¨ï¼Œç›´æ¥ä½¿ç”¨ Redis ä¼šè¯æ•°æ®
- âœ… å®æ—¶æ€§å¥½ï¼Œç›´æ¥è¯»å–å½“å‰ä¼šè¯çŠ¶æ€
- âœ… æ€§èƒ½å¥½ï¼ŒRedis æŸ¥è¯¢é€Ÿåº¦å¿«
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆä¼šè¯ä¸­åŒ…å« tenant_idï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰

**åŠ£åŠ¿**ï¼š
- âš ï¸ ä¾èµ– Redis ä¼šè¯å­˜å‚¨æ ¼å¼
- âš ï¸ ä¼šè¯è¿‡æœŸåæ— æ³•æŸ¥è¯¢å†å²åœ¨çº¿ç”¨æˆ·

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… éœ€è¦å®æ—¶æŸ¥çœ‹åœ¨çº¿ç”¨æˆ·
- âœ… éœ€è¦ä¼šè¯ç®¡ç†åŠŸèƒ½
- âœ… éœ€è¦å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

**å®ç°å¤æ‚åº¦**ï¼šâ­ï¼ˆç®€å•ï¼Œ1 å‘¨å¯å®Œæˆï¼‰

---

## ğŸ”§ åç«¯å®ç°

### 1. åˆ›å»º Schema

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/schemas/online_user.py`

```python
"""
åœ¨çº¿ç”¨æˆ· Schema æ¨¡å—

å®šä¹‰åœ¨çº¿ç”¨æˆ·ç›¸å…³çš„ Pydantic Schemaï¼Œç”¨äºæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–ã€‚
"""

from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime


class OnlineUserResponse(BaseModel):
    """åœ¨çº¿ç”¨æˆ·å“åº” Schema"""
    user_id: int = Field(..., description="ç”¨æˆ·ID")
    username: str = Field(..., description="ç”¨æˆ·å")
    email: Optional[str] = Field(None, description="é‚®ç®±")
    tenant_id: int = Field(..., description="ç»„ç»‡ID")
    login_ip: Optional[str] = Field(None, description="ç™»å½•IP")
    login_time: Optional[datetime] = Field(None, description="ç™»å½•æ—¶é—´")
    last_activity_time: Optional[datetime] = Field(None, description="æœ€åæ´»åŠ¨æ—¶é—´")
    session_id: str = Field(..., description="ä¼šè¯ID")


class OnlineUserStatisticsResponse(BaseModel):
    """åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡å“åº” Schema"""
    total: int = Field(..., description="æ€»åœ¨çº¿ç”¨æˆ·æ•°")
    active: int = Field(..., description="æ´»è·ƒç”¨æˆ·æ•°ï¼ˆæœ€è¿‘5åˆ†é’Ÿæœ‰æ´»åŠ¨ï¼‰")
    by_tenant: dict = Field(default_factory=dict, description="æŒ‰ç»„ç»‡ç»Ÿè®¡åœ¨çº¿ç”¨æˆ·æ•°")
```

### 2. åˆ›å»º Service

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/services/online_user_service.py`

```python
"""
åœ¨çº¿ç”¨æˆ·ç®¡ç†æœåŠ¡æ¨¡å—

æä¾›åœ¨çº¿ç”¨æˆ·çš„æŸ¥è¯¢å’Œä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚
"""

from typing import List, Optional
from datetime import datetime, timedelta

from redis import Redis
from soil.infrastructure.cache.cache import get_redis_client
from tree_root.schemas.online_user import OnlineUserResponse, OnlineUserStatisticsResponse
from soil.models.user import User


class OnlineUserService:
    """
    åœ¨çº¿ç”¨æˆ·ç®¡ç†æœåŠ¡ç±»
    
    æä¾›åœ¨çº¿ç”¨æˆ·çš„æŸ¥è¯¢å’Œä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚
    """
    
    @staticmethod
    async def list_online_users(
        tenant_id: Optional[int] = None
    ) -> List[OnlineUserResponse]:
        """
        è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        
        Args:
            tenant_id: ç»„ç»‡IDï¼ˆå¯é€‰ï¼Œå¦‚æœæä¾›åˆ™åªè¿”å›è¯¥ç»„ç»‡çš„åœ¨çº¿ç”¨æˆ·ï¼‰
            
        Returns:
            List[OnlineUserResponse]: åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        """
        redis_client = await get_redis_client()
        online_users = []
        
        # ä» Redis ä¸­è·å–æ‰€æœ‰ä¼šè¯
        # å‡è®¾ä¼šè¯é”®æ ¼å¼ä¸ºï¼šsession:{session_id}
        session_keys = await redis_client.keys("session:*")
        
        for session_key in session_keys:
            try:
                # è·å–ä¼šè¯æ•°æ®
                session_data = await redis_client.get(session_key)
                if not session_data:
                    continue
                
                # è§£æä¼šè¯æ•°æ®ï¼ˆæ ¹æ®å®é™…ä¼šè¯æ ¼å¼è§£æï¼‰
                # å‡è®¾ä¼šè¯æ•°æ®æ ¼å¼ä¸º JSONï¼š{"user_id": 1, "tenant_id": 1, "login_time": "...", ...}
                import json
                session_info = json.loads(session_data)
                
                # è¿‡æ»¤ç»„ç»‡
                if tenant_id and session_info.get("tenant_id") != tenant_id:
                    continue
                
                # è·å–ç”¨æˆ·ä¿¡æ¯
                user_id = session_info.get("user_id")
                if not user_id:
                    continue
                
                user = await User.filter(id=user_id).first()
                if not user:
                    continue
                
                # æ„å»ºåœ¨çº¿ç”¨æˆ·ä¿¡æ¯
                online_user = OnlineUserResponse(
                    user_id=user.id,
                    username=user.username,
                    email=user.email,
                    tenant_id=session_info.get("tenant_id"),
                    login_ip=session_info.get("login_ip"),
                    login_time=datetime.fromisoformat(session_info.get("login_time")) if session_info.get("login_time") else None,
                    last_activity_time=datetime.fromisoformat(session_info.get("last_activity_time")) if session_info.get("last_activity_time") else None,
                    session_id=session_key.replace("session:", "")
                )
                
                online_users.append(online_user)
            except Exception as e:
                # è·³è¿‡æ— æ•ˆä¼šè¯
                continue
        
        return online_users
    
    @staticmethod
    async def get_online_user_by_session_id(
        session_id: str
    ) -> Optional[OnlineUserResponse]:
        """
        æ ¹æ®ä¼šè¯IDè·å–åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
        
        Args:
            session_id: ä¼šè¯ID
            
        Returns:
            Optional[OnlineUserResponse]: åœ¨çº¿ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å› None
        """
        redis_client = await get_redis_client()
        session_key = f"session:{session_id}"
        
        session_data = await redis_client.get(session_key)
        if not session_data:
            return None
        
        # è§£æä¼šè¯æ•°æ®
        import json
        session_info = json.loads(session_data)
        
        user_id = session_info.get("user_id")
        if not user_id:
            return None
        
        user = await User.filter(id=user_id).first()
        if not user:
            return None
        
        return OnlineUserResponse(
            user_id=user.id,
            username=user.username,
            email=user.email,
            tenant_id=session_info.get("tenant_id"),
            login_ip=session_info.get("login_ip"),
            login_time=datetime.fromisoformat(session_info.get("login_time")) if session_info.get("login_time") else None,
            last_activity_time=datetime.fromisoformat(session_info.get("last_activity_time")) if session_info.get("last_activity_time") else None,
            session_id=session_id
        )
    
    @staticmethod
    async def force_logout(
        session_id: str
    ) -> bool:
        """
        å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
        
        Args:
            session_id: ä¼šè¯ID
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸ
        """
        try:
            redis_client = await get_redis_client()
            session_key = f"session:{session_id}"
            
            # åˆ é™¤ä¼šè¯
            await redis_client.delete(session_key)
            
            return True
        except Exception as e:
            return False
    
    @staticmethod
    async def get_online_user_statistics(
        tenant_id: Optional[int] = None
    ) -> OnlineUserStatisticsResponse:
        """
        è·å–åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡
        
        Args:
            tenant_id: ç»„ç»‡IDï¼ˆå¯é€‰ï¼‰
            
        Returns:
            OnlineUserStatisticsResponse: åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
        """
        online_users = await OnlineUserService.list_online_users(tenant_id=tenant_id)
        
        total = len(online_users)
        
        # ç»Ÿè®¡æ´»è·ƒç”¨æˆ·ï¼ˆæœ€è¿‘5åˆ†é’Ÿæœ‰æ´»åŠ¨ï¼‰
        active_threshold = datetime.now() - timedelta(minutes=5)
        active = sum(1 for user in online_users if user.last_activity_time and user.last_activity_time >= active_threshold)
        
        # æŒ‰ç»„ç»‡ç»Ÿè®¡
        by_tenant = {}
        for user in online_users:
            tenant_id_key = str(user.tenant_id)
            by_tenant[tenant_id_key] = by_tenant.get(tenant_id_key, 0) + 1
        
        return OnlineUserStatisticsResponse(
            total=total,
            active=active,
            by_tenant=by_tenant
        )
```

### 3. åˆ›å»º API

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/api/online_users/online_users.py`

```python
"""
åœ¨çº¿ç”¨æˆ·ç®¡ç† API è·¯ç”±

æä¾›åœ¨çº¿ç”¨æˆ·çš„æŸ¥è¯¢å’Œä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚
"""

from typing import Optional, List
from fastapi import APIRouter, Depends, HTTPException, status, Query

from tree_root.schemas.online_user import OnlineUserResponse, OnlineUserStatisticsResponse
from tree_root.services.online_user_service import OnlineUserService
from tree_root.api.deps.deps import get_current_tenant
from soil.api.deps.deps import get_current_user
from soil.models.user import User

router = APIRouter(prefix="/online-users", tags=["OnlineUsers"])


@router.get("", response_model=List[OnlineUserResponse])
async def list_online_users(
    tenant_id: Optional[int] = Query(None, description="ç»„ç»‡IDï¼ˆå¯é€‰ï¼‰"),
    current_user: User = Depends(get_current_user),
    current_tenant_id: int = Depends(get_current_tenant),
):
    """
    è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    
    Args:
        tenant_id: ç»„ç»‡IDï¼ˆå¯é€‰ï¼Œç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ç»„ç»‡ï¼‰
        current_user: å½“å‰ç”¨æˆ·
        current_tenant_id: å½“å‰ç»„ç»‡ID
        
    Returns:
        List[OnlineUserResponse]: åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    """
    # é»˜è®¤åªæŸ¥çœ‹å½“å‰ç»„ç»‡çš„åœ¨çº¿ç”¨æˆ·
    if tenant_id is None:
        tenant_id = current_tenant_id
    
    # TODO: æƒé™æ£€æŸ¥ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ç»„ç»‡çš„åœ¨çº¿ç”¨æˆ·ï¼‰
    
    return await OnlineUserService.list_online_users(tenant_id=tenant_id)


@router.get("/{session_id}", response_model=OnlineUserResponse)
async def get_online_user_by_session_id(
    session_id: str,
    current_user: User = Depends(get_current_user),
):
    """
    æ ¹æ®ä¼šè¯IDè·å–åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
    
    Args:
        session_id: ä¼šè¯ID
        
    Returns:
        OnlineUserResponse: åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
        
    Raises:
        HTTPException: å½“åœ¨çº¿ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
    """
    online_user = await OnlineUserService.get_online_user_by_session_id(session_id)
    
    if not online_user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="åœ¨çº¿ç”¨æˆ·ä¸å­˜åœ¨"
        )
    
    return online_user


@router.delete("/{session_id}", status_code=status.HTTP_204_NO_CONTENT)
async def force_logout(
    session_id: str,
    current_user: User = Depends(get_current_user),
):
    """
    å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
    
    Args:
        session_id: ä¼šè¯ID
        
    Raises:
        HTTPException: å½“å¼ºåˆ¶ä¸‹çº¿å¤±è´¥æ—¶æŠ›å‡º
    """
    success = await OnlineUserService.force_logout(session_id)
    
    if not success:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="å¼ºåˆ¶ä¸‹çº¿å¤±è´¥"
        )


@router.get("/statistics", response_model=OnlineUserStatisticsResponse)
async def get_online_user_statistics(
    tenant_id: Optional[int] = Query(None, description="ç»„ç»‡IDï¼ˆå¯é€‰ï¼‰"),
    current_user: User = Depends(get_current_user),
    current_tenant_id: int = Depends(get_current_tenant),
):
    """
    è·å–åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡
    
    Args:
        tenant_id: ç»„ç»‡IDï¼ˆå¯é€‰ï¼‰
        current_user: å½“å‰ç”¨æˆ·
        current_tenant_id: å½“å‰ç»„ç»‡ID
        
    Returns:
        OnlineUserStatisticsResponse: åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
    """
    # é»˜è®¤åªç»Ÿè®¡å½“å‰ç»„ç»‡çš„åœ¨çº¿ç”¨æˆ·
    if tenant_id is None:
        tenant_id = current_tenant_id
    
    # TODO: æƒé™æ£€æŸ¥ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ç»„ç»‡çš„ç»Ÿè®¡ï¼‰
    
    return await OnlineUserService.get_online_user_statistics(tenant_id=tenant_id)
```

---

## ğŸŒ API è®¾è®¡

### åœ¨çº¿ç”¨æˆ·ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/v1/system/online-users`

**æ¥å£åˆ—è¡¨**ï¼š
1. `GET /` - è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
2. `GET /{session_id}` - æ ¹æ®ä¼šè¯IDè·å–åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
3. `DELETE /{session_id}` - å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
4. `GET /statistics` - è·å–åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### åœ¨çº¿ç”¨æˆ·é¡µé¢

**é¡µé¢è·¯å¾„**ï¼š`pages/system/online-users/list/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å±•ç¤ºï¼ˆUniTableï¼Œæ”¯æŒåˆ†é¡µã€æ’åºï¼‰
2. åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ï¼ˆåœ¨çº¿äººæ•°ã€æ´»è·ƒç”¨æˆ·æ•°ï¼‰
3. ç”¨æˆ·ä¼šè¯è¯¦æƒ…æŸ¥çœ‹ï¼ˆDrawer æˆ– Modalï¼‰
4. å¼ºåˆ¶ä¸‹çº¿ï¼ˆå•ä¸ªç”¨æˆ·ã€æ‰¹é‡ç”¨æˆ·ï¼‰

**å¸ƒå±€è§„èŒƒ**ï¼š
- âœ… ä½¿ç”¨ `UniTable` ç»„ä»¶å±•ç¤ºåˆ—è¡¨
- âœ… ä½¿ç”¨ StatisticCard ç»„ä»¶å±•ç¤ºç»Ÿè®¡ä¿¡æ¯
- âœ… ç”¨æˆ·ä¼šè¯è¯¦æƒ…ä½¿ç”¨ Drawer å±•ç¤º
- âœ… å¼ºåˆ¶ä¸‹çº¿ä½¿ç”¨ Popconfirm ç¡®è®¤

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. Redis ä¼šè¯æ ¼å¼æ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- éœ€è¦äº†è§£å®é™…çš„ Redis ä¼šè¯å­˜å‚¨æ ¼å¼
- ä¼šè¯é”®çš„å‘½åè§„åˆ™å¯èƒ½ä¸åŒï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
- ä¼šè¯æ•°æ®çš„è§£æéœ€è¦æ ¹æ®å®é™…æ ¼å¼å®ç°

### 2. æ€§èƒ½ä¼˜åŒ–æ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- Redis æŸ¥è¯¢åº”è¯¥ä½¿ç”¨æ‰¹é‡æ“ä½œï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
- å¯ä»¥è€ƒè™‘ç¼“å­˜åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œå®šæœŸåˆ·æ–°
- å¤§é‡åœ¨çº¿ç”¨æˆ·æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ†é¡µæŸ¥è¯¢

### 3. ä¼šè¯ç®¡ç†æ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- å¼ºåˆ¶ä¸‹çº¿æ—¶ï¼Œéœ€è¦åˆ é™¤ Redis ä¼šè¯
- ä¼šè¯è¿‡æœŸåï¼Œç”¨æˆ·ä¼šè‡ªåŠ¨ä¸‹çº¿
- éœ€è¦è®°å½•å¼ºåˆ¶ä¸‹çº¿æ“ä½œæ—¥å¿—ï¼ˆå¯é€‰ï¼‰

### 4. å¤šç§Ÿæˆ·æ”¯æŒ

**è¦ç‚¹**ï¼š
- åœ¨çº¿ç”¨æˆ·æŒ‰ç»„ç»‡éš”ç¦»ï¼ˆtenant_idï¼‰
- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ç»„ç»‡çš„åœ¨çº¿ç”¨æˆ·ï¼ˆéœ€è¦æƒé™æ§åˆ¶ï¼‰
- API é»˜è®¤åªè¿”å›å½“å‰ç»„ç»‡çš„åœ¨çº¿ç”¨æˆ·

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md)
- [å»ºè®¾è¿›åº¦.md](./å»ºè®¾è¿›åº¦.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

