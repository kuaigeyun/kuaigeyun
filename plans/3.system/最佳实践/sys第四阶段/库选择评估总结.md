# 第四阶段库选择评估总结

## 📋 概述

本文档汇总第四阶段（流程管理，以 Inngest 为核心）各模块的库选择评估结果。

**核心原则**：
- ✅ **Inngest 是流程管理的核心引擎**，所有流程相关功能都基于 Inngest
- ✅ **统一使用 Inngest** 处理定时任务、工作流编排、事件驱动等功能

---

## 📊 各模块库选择评估

### 1. 消息管理

**结论**：✅ **使用自定义实现 + Inngest 事件驱动**

**核心库**：
- ✅ **Inngest** ⭐ **已选定**（事件驱动、工作流编排）
  - 消息推送通过 Inngest 事件触发
  - 邮件、短信、站内信、推送通知都通过 Inngest 工作流处理
  - 安装：`pip install inngest`
- ✅ **aiosmtplib**（异步邮件发送）
  - 安装：`pip install aiosmtplib`
  - 用于异步发送邮件
- ✅ **websockets**（WebSocket 支持）
  - 安装：`pip install websockets`
  - 用于实时推送通知

**可选库**：
- ⚠️ **socket.io**（Socket.IO 协议，可选）
  - 安装：`pip install python-socketio`
  - 仅在需要 Socket.IO 协议时安装

**前端库**：
- ✅ **socket.io-client**（WebSocket 客户端，可选）
  - 安装：`npm install socket.io-client`
  - 仅在需要 Socket.IO 协议时安装

---

### 2. 定时任务

**结论**：✅ **完全基于 Inngest，替代 APScheduler**

**核心库**：
- ✅ **Inngest** ⭐ **已选定**（定时触发器、任务执行）
  - 替代 APScheduler，所有定时任务都通过 Inngest 执行
  - 支持 cron、interval、date 触发器
  - 支持任务持久化和重试
  - 支持任务监控和日志
  - 安装：`pip install inngest`

**不再使用**：
- ❌ **APScheduler**（已由 Inngest 替代）

---

### 3. 审批流程

**结论**：✅ **使用 Inngest 工作流编排 + ProFlow 可视化**

**核心库**：
- ✅ **Inngest** ⭐ **已选定**（工作流编排引擎，"骨"）
  - 所有审批流程都通过 Inngest 工作流执行
  - 支持复杂工作流编排
  - 支持条件分支、并行执行
  - 支持工作流状态管理
  - 安装：`pip install inngest`
- ✅ **@ant-design/pro-flow** ⭐ **已选定**（流程图可视化组件，"皮"）
  - 工作流可视化设计
  - 流程图展示
  - 执行状态可视化
  - 与 Inngest 配合：设计 → 配置 → 执行 → 监控
  - 安装：`npm install @ant-design/pro-flow`

**工作流程**：
1. **设计阶段**：使用 ProFlow 在前端可视化设计审批流程
2. **配置阶段**：将 ProFlow 设计的流程转换为 Inngest 工作流配置
3. **注册阶段**：将工作流配置注册到 Inngest
4. **执行阶段**：Inngest 执行工作流，ProFlow 展示执行状态
5. **监控阶段**：ProFlow 实时展示工作流执行进度和结果

---

### 4. 电子记录

**结论**：✅ **使用 Inngest 工作流**

**核心库**：
- ✅ **Inngest** ⭐ **已选定**（电子记录工作流）
  - 签名、归档流程都通过 Inngest 工作流执行
  - 记录生命周期管理
  - 安装：`pip install inngest`

---

### 5. 脚本管理

**结论**：✅ **使用自定义实现 + Inngest（可选）**

**核心库**：
- ✅ **PyExecJS** ⭐ **推荐**（JavaScript 执行）
  - 安装：`pip install PyExecJS`
  - 用于执行 JavaScript 脚本

**可选库**：
- ⚠️ **Inngest**（异步脚本执行，可选）
  - 安装：`pip install inngest`
  - 仅在需要异步执行脚本时使用

---

### 6. 打印模板

**结论**：✅ **使用自定义实现 + Inngest（可选）**

**核心库**：
- ✅ **reportlab** ⭐ **推荐**（PDF 生成）
  - 安装：`pip install reportlab`
  - 用于生成 PDF 文档

**可选库**：
- ⚠️ **weasyprint**（HTML 转 PDF，可选）
  - 安装：`pip install weasyprint`
  - 仅在需要 HTML 转 PDF 时安装
- ⚠️ **Inngest**（异步打印任务，可选）
  - 安装：`pip install inngest`
  - 仅在需要异步执行打印任务时使用

---

### 7. 打印设备

**结论**：✅ **使用自定义实现 + Inngest（可选）**

**核心库**：
- ✅ **无需核心库**（打印设备管理主要是配置管理）

**可选库**：
- ⚠️ **pycups**（Linux 打印支持，可选）
  - 安装：`pip install pycups`
  - 仅在 Linux 系统需要打印支持时安装
- ⚠️ **Inngest**（异步打印任务，可选）
  - 安装：`pip install inngest`
  - 仅在需要异步执行打印任务时使用

---

## 📦 依赖安装清单

### 必需依赖

```bash
# Inngest（流程管理核心）
pip install inngest

# 消息管理
pip install aiosmtplib
pip install websockets

# 脚本管理
pip install PyExecJS

# 打印模板
pip install reportlab

# 前端依赖
npm install @ant-design/pro-flow
```

### 可选依赖

```bash
# 消息管理（Socket.IO 协议）
pip install python-socketio
npm install socket.io-client

# 打印模板（HTML 转 PDF）
pip install weasyprint

# 打印设备（Linux 打印支持）
pip install pycups
```

---

## 🎯 技术选型原则

### 1. Inngest 是核心

**原则**：
- ✅ **所有流程相关功能都基于 Inngest**：定时任务、工作流编排、事件驱动
- ✅ **统一使用 Inngest**：不要混用其他任务调度库（如 APScheduler）
- ✅ **Inngest 函数必须包含 tenant_id**：确保多租户隔离
- ✅ **Inngest 工作流状态同步**：工作流执行状态需要同步到数据库

### 2. ProFlow 与 Inngest 配合

**原则**：
- ✅ **ProFlow 是前端可视化组件**：用于设计工作流
- ✅ **Inngest 是后端执行引擎**：用于执行工作流
- ✅ **工作流转换**：ProFlow 设计转换为 Inngest 工作流配置
- ✅ **状态同步**：Inngest 工作流状态同步到前端 ProFlow 展示

### 3. 可选依赖按需安装

**原则**：
- ✅ 核心功能使用必需依赖
- ✅ 高级功能使用可选依赖
- ✅ 根据实际需求决定是否安装可选依赖

---

## 🔧 Inngest 服务部署

### 1. 安装 Inngest

**方式一：使用 npm 全局安装**
```bash
npm install -g inngest
```

**方式二：下载二进制文件**
- 从 Inngest 官网下载对应平台的二进制文件
- 直接运行二进制文件

### 2. 配置 Inngest

**配置文件**：`inngest.config.json`

```json
{
  "event_api": {
    "port": 8288,
    "host": "0.0.0.0"
  },
  "database": {
    "url": "postgresql://user:password@localhost:5432/easthigh",
    "pool_size": 10
  },
  "log_level": "info"
}
```

### 3. 启动 Inngest 服务

```bash
# 使用 npm 安装的版本
inngest dev

# 或使用二进制文件
./inngest dev
```

---

## 📚 相关文档

- [Inngest 集成指南.md](./Inngest集成指南.md)
- [1.消息管理最佳实践.md](./1.消息管理最佳实践.md)
- [2.定时任务最佳实践.md](./2.定时任务最佳实践.md)
- [3.审批流程最佳实践.md](./3.审批流程最佳实践.md)
- [4.电子记录最佳实践.md](./4.电子记录最佳实践.md)
- [5.脚本管理最佳实践.md](./5.脚本管理最佳实践.md)
- [6.打印模板最佳实践.md](./6.打印模板最佳实践.md)
- [7.打印设备最佳实践.md](./7.打印设备最佳实践.md)

---

**最后更新**：2025-01-XX

