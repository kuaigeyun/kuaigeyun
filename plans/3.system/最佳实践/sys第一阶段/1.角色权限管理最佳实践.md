# è§’è‰²æƒé™ç®¡ç†æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šè§’è‰²æƒé™ç®¡ç†ï¼ˆRole & Permission Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­â­â­ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š1-2 å‘¨  
**ä¾èµ–**ï¼šæ— ï¼ˆåŸºç¡€åŠŸèƒ½ï¼Œå…¶ä»–æ¨¡å—ä¾èµ–æ­¤æ¨¡å—ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- è§’è‰²ç®¡ç†ï¼ˆRole CRUDï¼‰
- æƒé™ç®¡ç†ï¼ˆPermission æŸ¥è¯¢ã€åˆ†é…ï¼‰
- è§’è‰²-æƒé™å…³è”ï¼ˆå¤šå¯¹å¤šï¼‰
- ç”¨æˆ·-è§’è‰²å…³è”ï¼ˆå¤šå¯¹å¤šï¼‰
- æƒé™éªŒè¯ä¸­é—´ä»¶

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### Tortoise ORM ç”Ÿæ€æƒé™ç®¡ç†åº“è°ƒç ”ç»“æœ

**ç»“è®º**ï¼šâš ï¸ **Tortoise ORM ç”Ÿæ€ä¸­ç›®å‰æ²¡æœ‰ä¸“é—¨çš„æƒé™ç®¡ç†åº“**

ç»è¿‡è°ƒç ”ï¼ŒTortoise ORM ç”Ÿæ€ç³»ç»Ÿä¸­ï¼š
- âŒ æ²¡æœ‰ç±»ä¼¼ Django Guardian çš„æƒé™ç®¡ç†åº“
- âŒ æ²¡æœ‰ä¸“é—¨ä¸º Tortoise ORM è®¾è®¡çš„ RBAC åº“
- âŒ æ²¡æœ‰ç°æˆçš„æƒé™ç®¡ç†ä¸­é—´ä»¶æˆ–è£…é¥°å™¨

**å› æ­¤ï¼Œå¯é€‰çš„æ–¹æ¡ˆåªæœ‰**ï¼š
1. **è‡ªå®šä¹‰å®ç°**ï¼ˆæ¨èï¼‰
2. **ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ + é€‚é…å±‚**ï¼ˆå¦‚ Casbinï¼‰

---

### æ–¹æ¡ˆå¯¹æ¯”

#### æ–¹æ¡ˆä¸€ï¼šè‡ªå®šä¹‰å®ç° â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸ Tortoise ORM å®Œç¾é›†æˆï¼ˆåŸç”Ÿæ”¯æŒï¼‰
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆtenant_id å­—æ®µï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰
- âœ… å®Œå…¨æ§åˆ¶ï¼Œæ˜“äºå®šåˆ¶å’Œæ‰©å±•
- âœ… æ— éœ€å­¦ä¹ ç¬¬ä¸‰æ–¹åº“çš„è¯­æ³•å’Œæ¦‚å¿µ
- âœ… ç»´æŠ¤æˆæœ¬ä½ï¼Œä»£ç æ¸…æ™°æ˜“æ‡‚

**åŠ£åŠ¿**ï¼š
- âš ï¸ éœ€è¦è‡ªå·±å®ç°æ‰€æœ‰åŠŸèƒ½ï¼ˆä½†åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼‰
- âš ï¸ éœ€è¦è‡ªå·±ç¼–å†™æµ‹è¯•

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æƒé™æ¨¡å‹ç›¸å¯¹ç®€å•ï¼ˆRBACï¼‰
- âœ… éœ€è¦ä¸ç°æœ‰æ¡†æ¶æ·±åº¦é›†æˆ
- âœ… éœ€è¦å®Œå…¨ç¬¦åˆé¡¹ç›®è§„èŒƒ
- âœ… å¤šç§Ÿæˆ·æ˜¯æ ¸å¿ƒéœ€æ±‚

**å®ç°å¤æ‚åº¦**ï¼šâ­â­ï¼ˆä¸­ç­‰ï¼Œ1-2 å‘¨å¯å®Œæˆï¼‰

---

#### æ–¹æ¡ˆäºŒï¼šCasbin + é€‚é…å±‚ â­â­â­ï¼ˆå¯é€‰ï¼‰

**ç®€ä»‹**ï¼šCasbin æ˜¯æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€çš„è®¿é—®æ§åˆ¶åº“ï¼Œæ”¯æŒ RBACã€ABAC ç­‰å¤šç§æ¨¡å‹ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒ Pythonï¼ˆ`python-casbin`ï¼‰
- âœ… æ”¯æŒ RBAC æ¨¡å‹ï¼ˆç¬¦åˆéœ€æ±‚ï¼‰
- âœ… æˆç†Ÿç¨³å®šï¼Œç¤¾åŒºæ´»è·ƒ
- âœ… çµæ´»çš„æƒé™æ¨¡å‹é…ç½®
- âœ… å¦‚æœæœªæ¥éœ€è¦ ABAC ç­‰å¤æ‚æ¨¡å‹ï¼Œæ˜“äºæ‰©å±•

**åŠ£åŠ¿**ï¼š
- âš ï¸ **ä¸ Tortoise ORM é›†æˆéœ€è¦é€‚é…**ï¼ˆCasbin ä¸»è¦é€‚é… SQLAlchemyï¼‰
- âš ï¸ **å¤šç§Ÿæˆ·éš”ç¦»éœ€è¦é¢å¤–é…ç½®**ï¼ˆåœ¨ç­–ç•¥ä¸­æ·»åŠ  tenant_idï¼‰
- âš ï¸ éœ€è¦å­¦ä¹  Casbin çš„æ¨¡å‹è¯­æ³•ï¼ˆ`.conf` å’Œ `.csv` æ–‡ä»¶ï¼‰
- âš ï¸ éœ€è¦ç»´æŠ¤é€‚é…å±‚ä»£ç 
- âš ï¸ å¯èƒ½ä¸ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šç­‰ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤æ‚çš„æƒé™æ¨¡å‹éœ€æ±‚ï¼ˆABACã€å¤šçº§æƒé™ç­‰ï¼‰
- éœ€è¦æ”¯æŒå¤šç§æƒé™æ¨¡å‹
- æƒé™ç­–ç•¥éœ€è¦é¢‘ç¹å˜æ›´
- å›¢é˜Ÿç†Ÿæ‚‰ Casbin

**å®ç°å¤æ‚åº¦**ï¼šâ­â­â­â­ï¼ˆè¾ƒé«˜ï¼Œéœ€è¦é€‚é…å±‚ + å­¦ä¹ æˆæœ¬ï¼‰

**GitHub**ï¼šhttps://github.com/casbin/casbin  
**æ–‡æ¡£**ï¼šhttps://casbin.org/docs/en/overview

---

### æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**æ¨è**ï¼šâœ… **ä½¿ç”¨è‡ªå®šä¹‰å®ç°**

**ç†ç”±**ï¼š
1. âœ… **Tortoise ORM ç”Ÿæ€æ²¡æœ‰ç°æˆçš„æƒé™åº“**ï¼Œä½¿ç”¨ç¬¬ä¸‰æ–¹åº“éœ€è¦é€‚é…å±‚
2. âœ… **RBAC æ¨¡å‹ç›¸å¯¹ç®€å•**ï¼Œè‡ªå®šä¹‰å®ç°æˆæœ¬ä¸é«˜ï¼ˆ1-2 å‘¨ï¼‰
3. âœ… **å¤šç§Ÿæˆ·æ˜¯æ ¸å¿ƒéœ€æ±‚**ï¼Œè‡ªå®šä¹‰å®ç°å¤©ç„¶æ”¯æŒ
4. âœ… **å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒ**ï¼Œä»£ç é£æ ¼ç»Ÿä¸€
5. âœ… **ç»´æŠ¤æˆæœ¬ä½**ï¼Œå›¢é˜Ÿå®Œå…¨æŒæ§ä»£ç 

**å¦‚æœæœªæ¥éœ€è¦å¤æ‚æƒé™æ¨¡å‹**ï¼ˆå¦‚ ABACï¼‰ï¼Œå†è€ƒè™‘è¿ç§»åˆ° Casbinã€‚

---

### Casbin é›†æˆæ–¹æ¡ˆï¼ˆå¦‚æœæœªæ¥éœ€è¦ï¼‰

å¦‚æœæœªæ¥éœ€è¦è¿ç§»åˆ° Casbinï¼Œéœ€è¦ï¼š

1. **å®‰è£…ä¾èµ–**
   ```bash
   pip install casbin
   # æ³¨æ„ï¼šCasbin æ²¡æœ‰ Tortoise ORM é€‚é…å™¨ï¼Œéœ€è¦è‡ªå·±å®ç°
   ```

2. **åˆ›å»º Tortoise ORM é€‚é…å™¨**
   - å®ç° Casbin çš„ Adapter æ¥å£
   - å°† Tortoise ORM æ¨¡å‹è½¬æ¢ä¸º Casbin ç­–ç•¥
   - å®ç°å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆåœ¨ç­–ç•¥ä¸­æ·»åŠ  tenant_idï¼‰

3. **é›†æˆåˆ° FastAPI**
   - åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
   - åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨è£…é¥°å™¨éªŒè¯æƒé™

**æ³¨æ„**ï¼šé›†æˆå¤æ‚åº¦è¾ƒé«˜ï¼Œéœ€è¦è¯„ä¼°æŠ•å…¥äº§å‡ºæ¯”ã€‚

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. è§’è‰²è¡¨ï¼ˆroot_rolesï¼‰

```sql
CREATE TABLE root_roles (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- è§’è‰²åŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,              -- è§’è‰²åç§°
    code VARCHAR(50) NOT NULL,               -- è§’è‰²ä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰
    description TEXT,                        -- è§’è‰²æè¿°
    is_system BOOLEAN DEFAULT FALSE,         -- æ˜¯å¦ç³»ç»Ÿè§’è‰²ï¼ˆç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤ï¼‰
    is_active BOOLEAN DEFAULT TRUE,          -- æ˜¯å¦å¯ç”¨
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_roles_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_roles_tenant_id (tenant_id),
    INDEX idx_root_roles_uuid (uuid),
    INDEX idx_root_roles_code (code),
    INDEX idx_root_roles_created_at (created_at)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… **æ··åˆIDæ–¹æ¡ˆ**ï¼š`id`ï¼ˆè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼Œæ€§èƒ½ä¼˜å…ˆï¼‰+ `uuid`ï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
- âœ… `uuid` å­—æ®µç”¨äºå¯¹å¤–APIï¼Œé¿å…æš´éœ²è‡ªå¢IDï¼ˆå®‰å…¨æ€§ï¼‰
- âœ… `id` å­—æ®µç”¨äºå†…éƒ¨å…³è”å’ŒæŸ¥è¯¢ï¼ˆæ€§èƒ½ï¼‰
- âœ… `code` å­—æ®µç”¨äºç¨‹åºè¯†åˆ«ï¼Œä¸ `name` åˆ†ç¦»ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
- âœ… `is_system` æ ‡è®°ç³»ç»Ÿè§’è‰²ï¼Œé˜²æ­¢è¯¯åˆ 
- âœ… `tenant_id + code` å”¯ä¸€çº¦æŸï¼Œç¡®ä¿ç»„ç»‡å†…è§’è‰²ä»£ç å”¯ä¸€
- âœ… è½¯åˆ é™¤æ”¯æŒï¼ˆ`deleted_at`ï¼‰

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `code` å­—æ®µç”¨äºç¨‹åºè¯†åˆ«ï¼Œä¸ `name` åˆ†ç¦»ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
- âœ… `is_system` æ ‡è®°ç³»ç»Ÿè§’è‰²ï¼Œé˜²æ­¢è¯¯åˆ 
- âœ… `tenant_id + code` å”¯ä¸€çº¦æŸï¼Œç¡®ä¿ç»„ç»‡å†…è§’è‰²ä»£ç å”¯ä¸€
- âœ… è½¯åˆ é™¤æ”¯æŒï¼ˆ`deleted_at`ï¼‰

### 2. æƒé™è¡¨ï¼ˆroot_permissionsï¼‰

```sql
CREATE TABLE root_permissions (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- æƒé™åŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,              -- æƒé™åç§°
    code VARCHAR(100) NOT NULL,               -- æƒé™ä»£ç ï¼ˆå”¯ä¸€ï¼Œæ ¼å¼ï¼šæ¨¡å—:æ“ä½œï¼Œå¦‚ user:createï¼‰
    resource VARCHAR(50) NOT NULL,            -- èµ„æºï¼ˆæ¨¡å—ï¼Œå¦‚ userã€roleã€departmentï¼‰
    action VARCHAR(50) NOT NULL,              -- æ“ä½œï¼ˆå¦‚ createã€readã€updateã€deleteï¼‰
    description TEXT,                        -- æƒé™æè¿°
    
    -- æƒé™ç±»å‹
    permission_type VARCHAR(20) NOT NULL,      -- æƒé™ç±»å‹ï¼šfunctionï¼ˆåŠŸèƒ½æƒé™ï¼‰ã€dataï¼ˆæ•°æ®æƒé™ï¼‰ã€fieldï¼ˆå­—æ®µæƒé™ï¼‰
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_permissions_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_permissions_tenant_id (tenant_id),
    INDEX idx_root_permissions_uuid (uuid),
    INDEX idx_root_permissions_code (code),
    INDEX idx_root_permissions_resource (resource),
    INDEX idx_root_permissions_type (permission_type)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `code` æ ¼å¼ï¼š`èµ„æº:æ“ä½œ`ï¼ˆå¦‚ `user:create`ã€`role:read`ï¼‰
- âœ… `permission_type` åŒºåˆ†åŠŸèƒ½æƒé™ã€æ•°æ®æƒé™ã€å­—æ®µæƒé™
- âœ… `resource` å’Œ `action` åˆ†ç¦»ï¼Œä¾¿äºæŸ¥è¯¢å’Œç»Ÿè®¡
- âœ… `tenant_id + code` å”¯ä¸€çº¦æŸ

### 3. è§’è‰²-æƒé™å…³è”è¡¨ï¼ˆroot_role_permissionsï¼‰

```sql
CREATE TABLE root_role_permissions (
    id SERIAL PRIMARY KEY,
    role_id INTEGER NOT NULL,
    permission_id INTEGER NOT NULL,
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•å’Œçº¦æŸ
    CONSTRAINT uk_root_role_permissions_role_permission UNIQUE (role_id, permission_id),
    INDEX idx_root_role_permissions_role_id (role_id),
    INDEX idx_root_role_permissions_permission_id (permission_id),
    
    -- å¤–é”®
    FOREIGN KEY (role_id) REFERENCES root_roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES root_permissions(id) ON DELETE CASCADE
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… å¤šå¯¹å¤šå…³ç³»è¡¨
- âœ… `role_id + permission_id` å”¯ä¸€çº¦æŸï¼Œé˜²æ­¢é‡å¤åˆ†é…
- âœ… CASCADE åˆ é™¤ï¼Œè§’è‰²æˆ–æƒé™åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å…³è”

### 4. ç”¨æˆ·-è§’è‰²å…³è”è¡¨ï¼ˆroot_user_rolesï¼‰

```sql
CREATE TABLE root_user_roles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•å’Œçº¦æŸ
    CONSTRAINT uk_root_user_roles_user_role UNIQUE (user_id, role_id),
    INDEX idx_root_user_roles_user_id (user_id),
    INDEX idx_root_user_roles_role_id (role_id),
    
    -- å¤–é”®
    FOREIGN KEY (user_id) REFERENCES root_users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES root_roles(id) ON DELETE CASCADE
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… å¤šå¯¹å¤šå…³ç³»è¡¨
- âœ… `user_id + role_id` å”¯ä¸€çº¦æŸï¼Œé˜²æ­¢é‡å¤åˆ†é…
- âœ… CASCADE åˆ é™¤ï¼Œç”¨æˆ·æˆ–è§’è‰²åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å…³è”

---

## ğŸ åç«¯æ¨¡å‹è®¾è®¡

### 1. è§’è‰²æ¨¡å‹ï¼ˆRoleï¼‰

```python
# riveredge-backend/src/tree-root/models/role.py
from tortoise.models import Model
from tortoise import fields
from .base import BaseModel


class Role(BaseModel):
    """
    è§’è‰²æ¨¡å‹
    
    ç”¨äºå®šä¹‰ç³»ç»Ÿä¸­çš„è§’è‰²ï¼Œæ¯ä¸ªè§’è‰²å¯ä»¥å…³è”å¤šä¸ªæƒé™ã€‚
    æ”¯æŒå¤šç»„ç»‡éš”ç¦»ï¼Œæ¯ä¸ªç»„ç»‡å¯ä»¥å®šä¹‰è‡ªå·±çš„è§’è‰²ã€‚
    
    æ³¨æ„ï¼šç»§æ‰¿è‡ª BaseModelï¼Œè‡ªåŠ¨åŒ…å« uuidã€tenant_idã€created_atã€updated_at å­—æ®µã€‚
    """
    id = fields.IntField(pk=True, description="è§’è‰²IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    # uuid å­—æ®µç”± BaseModel æä¾›ï¼Œæ— éœ€é‡å¤å®šä¹‰
    # tenant_id å­—æ®µç”± BaseModel æä¾›ï¼Œæ— éœ€é‡å¤å®šä¹‰
    
    name = fields.CharField(max_length=100, description="è§’è‰²åç§°")
    code = fields.CharField(max_length=50, description="è§’è‰²ä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰")
    description = fields.TextField(null=True, description="è§’è‰²æè¿°")
    is_system = fields.BooleanField(default=False, description="æ˜¯å¦ç³»ç»Ÿè§’è‰²ï¼ˆç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤ï¼‰")
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦å¯ç”¨")
    
    # å¤šå¯¹å¤šå…³ç³»
    permissions = fields.ManyToManyField(
        "models.Permission",
        related_name="roles",
        through="root_role_permissions",
        description="è§’è‰²å…³è”çš„æƒé™"
    )
    
    class Meta:
        table = "root_roles"
        unique_together = [("tenant_id", "code")]
        indexes = [
            ("tenant_id",),
            ("code",),
            ("created_at",),
        ]
    
    def __str__(self):
        return f"{self.name} ({self.code})"
```

### 2. æƒé™æ¨¡å‹ï¼ˆPermissionï¼‰

```python
# riveredge-backend/src/tree-root/models/permission.py
from tortoise.models import Model
from tortoise import fields
from .base import BaseModel


class PermissionType:
    """æƒé™ç±»å‹å¸¸é‡"""
    FUNCTION = "function"  # åŠŸèƒ½æƒé™
    DATA = "data"         # æ•°æ®æƒé™
    FIELD = "field"       # å­—æ®µæƒé™


class Permission(BaseModel):
    """
    æƒé™æ¨¡å‹
    
    ç”¨äºå®šä¹‰ç³»ç»Ÿä¸­çš„æƒé™ï¼Œæ¯ä¸ªæƒé™ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„æ“ä½œã€‚
    æƒé™ä»£ç æ ¼å¼ï¼šèµ„æº:æ“ä½œï¼ˆå¦‚ user:createã€role:readï¼‰
    """
    name = fields.CharField(max_length=100, description="æƒé™åç§°")
    code = fields.CharField(max_length=100, description="æƒé™ä»£ç ï¼ˆå”¯ä¸€ï¼Œæ ¼å¼ï¼šèµ„æº:æ“ä½œï¼‰")
    resource = fields.CharField(max_length=50, description="èµ„æºï¼ˆæ¨¡å—ï¼Œå¦‚ userã€roleï¼‰")
    action = fields.CharField(max_length=50, description="æ“ä½œï¼ˆå¦‚ createã€readã€updateã€deleteï¼‰")
    description = fields.TextField(null=True, description="æƒé™æè¿°")
    permission_type = fields.CharField(
        max_length=20,
        default=PermissionType.FUNCTION,
        description="æƒé™ç±»å‹ï¼šfunctionï¼ˆåŠŸèƒ½æƒé™ï¼‰ã€dataï¼ˆæ•°æ®æƒé™ï¼‰ã€fieldï¼ˆå­—æ®µæƒé™ï¼‰"
    )
    
    class Meta:
        table = "root_permissions"
        unique_together = [("tenant_id", "code")]
        indexes = [
            ("tenant_id",),
            ("code",),
            ("resource",),
            ("permission_type",),
        ]
    
    def __str__(self):
        return f"{self.name} ({self.code})"
```

### 3. ç”¨æˆ·-è§’è‰²å…³è”æ¨¡å‹ï¼ˆUserRoleï¼‰

```python
# riveredge-backend/src/tree-root/models/user_role.py
from tortoise.models import Model
from tortoise import fields


class UserRole(Model):
    """
    ç”¨æˆ·-è§’è‰²å…³è”æ¨¡å‹
    
    ç”¨äºå…³è”ç”¨æˆ·å’Œè§’è‰²ï¼Œå®ç°å¤šå¯¹å¤šå…³ç³»ã€‚
    """
    user = fields.ForeignKeyField(
        "models.User",
        related_name="user_roles",
        description="ç”¨æˆ·"
    )
    role = fields.ForeignKeyField(
        "models.Role",
        related_name="user_roles",
        description="è§’è‰²"
    )
    created_at = fields.DatetimeField(auto_now_add=True, description="åˆ›å»ºæ—¶é—´")
    
    class Meta:
        table = "root_user_roles"
        unique_together = [("user_id", "role_id")]
        indexes = [
            ("user_id",),
            ("role_id",),
        ]
```

---

## ğŸ“¡ API è®¾è®¡

### 1. è§’è‰²ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/v1/roles`  
**Tags**ï¼š`Roles`ï¼ˆè‹±æ–‡ï¼‰

#### 1.1 åˆ›å»ºè§’è‰²

```python
POST /api/v1/roles

Request Body:
{
    "name": "ç®¡ç†å‘˜",
    "code": "admin",
    "description": "ç³»ç»Ÿç®¡ç†å‘˜è§’è‰²",
    "is_active": true
}

Response 201:
{
    "id": 1,
    "tenant_id": 1,
    "name": "ç®¡ç†å‘˜",
    "code": "admin",
    "description": "ç³»ç»Ÿç®¡ç†å‘˜è§’è‰²",
    "is_system": false,
    "is_active": true,
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è®¾ç½® `tenant_id`ï¼ˆä»å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–ï¼‰
- âœ… éªŒè¯ `code` åœ¨ç»„ç»‡å†…å”¯ä¸€
- âœ… éœ€è¦ç»„ç»‡ç®¡ç†å‘˜æˆ–è¶…çº§ç”¨æˆ·æƒé™
- âœ… ç³»ç»Ÿè§’è‰²ä¸å¯åˆ›å»ºï¼ˆ`is_system` åªèƒ½ç”±ç³»ç»Ÿè®¾ç½®ï¼‰

#### 1.2 è·å–è§’è‰²åˆ—è¡¨

```python
GET /api/v1/roles?page=1&page_size=20&keyword=ç®¡ç†å‘˜&is_active=true

Response 200:
{
    "items": [
        {
            "id": 1,
            "name": "ç®¡ç†å‘˜",
            "code": "admin",
            "description": "ç³»ç»Ÿç®¡ç†å‘˜è§’è‰²",
            "is_system": false,
            "is_active": true,
            "permission_count": 10,  // å…³è”çš„æƒé™æ•°é‡
            "user_count": 5           // å…³è”çš„ç”¨æˆ·æ•°é‡
        }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è¿‡æ»¤ç»„ç»‡ï¼ˆåªè¿”å›å½“å‰ç»„ç»‡çš„è§’è‰²ï¼‰
- âœ… æ”¯æŒåˆ†é¡µï¼ˆ`page`, `page_size`ï¼‰
- âœ… æ”¯æŒå…³é”®è¯æœç´¢ï¼ˆ`keyword`ï¼šæœç´¢è§’è‰²åç§°ã€ä»£ç ã€æè¿°ï¼‰
- âœ… æ”¯æŒç­›é€‰ï¼ˆ`is_active`, `is_system`ï¼‰
- âœ… è¿”å›å…³è”çš„æƒé™æ•°é‡å’Œç”¨æˆ·æ•°é‡ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰

#### 1.3 è·å–è§’è‰²è¯¦æƒ…

```python
GET /api/v1/roles/{role_uuid}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440000",  // UUIDï¼ˆå¯¹å¤–æš´éœ²ï¼‰
    "name": "ç®¡ç†å‘˜",
    "code": "admin",
    "description": "ç³»ç»Ÿç®¡ç†å‘˜è§’è‰²",
    "is_system": false,
    "is_active": true,
    "permissions": [  // å…³è”çš„æƒé™åˆ—è¡¨
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440001",
            "name": "åˆ›å»ºç”¨æˆ·",
            "code": "user:create",
            "resource": "user",
            "action": "create"
        }
    ],
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{role_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{role_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… è¿”å›è§’è‰²å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…³è”çš„æƒé™åˆ—è¡¨ï¼‰
- âœ… å“åº”ä¸­åŒ…å« `uuid` å­—æ®µï¼ˆå¯¹å¤–æš´éœ²ï¼‰ï¼Œ`id` å­—æ®µä¿ç•™ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

#### 1.4 æ›´æ–°è§’è‰²

```python
PUT /api/v1/roles/{role_uuid}

Request Body:
{
    "name": "ç®¡ç†å‘˜ï¼ˆæ›´æ–°ï¼‰",
    "description": "æ›´æ–°åçš„æè¿°",
    "is_active": true
}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440000",
    "name": "ç®¡ç†å‘˜ï¼ˆæ›´æ–°ï¼‰",
    "description": "æ›´æ–°åçš„æè¿°",
    ...
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{role_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{role_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… ç³»ç»Ÿè§’è‰²ä¸å¯ä¿®æ”¹ï¼ˆ`is_system=true` çš„è§’è‰²ï¼‰
- âœ… `code` ä¸å¯ä¿®æ”¹ï¼ˆç”¨äºç¨‹åºè¯†åˆ«ï¼‰
- âœ… æ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼ˆPydantic çš„ `exclude_unset=True`ï¼‰

#### 1.5 åˆ é™¤è§’è‰²

```python
DELETE /api/v1/roles/{role_uuid}

Response 204: No Content
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{role_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{role_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… ç³»ç»Ÿè§’è‰²ä¸å¯åˆ é™¤ï¼ˆ`is_system=true` çš„è§’è‰²ï¼‰
- âœ… æ£€æŸ¥æ˜¯å¦æœ‰å…³è”ç”¨æˆ·ï¼ˆå¦‚æœæœ‰ï¼Œè¿”å›é”™è¯¯æç¤ºï¼‰
- âœ… è½¯åˆ é™¤ï¼ˆè®¾ç½® `deleted_at`ï¼‰

#### 1.6 åˆ†é…æƒé™ç»™è§’è‰²

```python
POST /api/v1/roles/{role_uuid}/permissions

Request Body:
{
    "permission_uuids": [  // æƒé™UUIDåˆ—è¡¨ï¼ˆä½¿ç”¨UUIDè€Œä¸æ˜¯IDï¼‰
        "550e8400-e29b-41d4-a716-446655440001",
        "550e8400-e29b-41d4-a716-446655440002",
        "550e8400-e29b-41d4-a716-446655440003"
    ]
}

Response 200:
{
    "success": true,
    "message": "æƒé™åˆ†é…æˆåŠŸ",
    "added_count": 3,
    "removed_count": 0
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{role_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{role_id}`
- âœ… **è¯·æ±‚ä½“ä½¿ç”¨ `permission_uuids`**ï¼ˆUUIDåˆ—è¡¨ï¼‰ï¼Œè€Œä¸æ˜¯ `permission_ids`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… æ”¯æŒæ‰¹é‡åˆ†é…æƒé™
- âœ… éªŒè¯æƒé™å±äºå½“å‰ç»„ç»‡
- âœ… è¿”å›æ·»åŠ å’Œç§»é™¤çš„æƒé™æ•°é‡

#### 1.7 è·å–è§’è‰²æƒé™åˆ—è¡¨

```python
GET /api/v1/roles/{role_uuid}/permissions

Response 200:
{
    "items": [
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440001",
            "name": "åˆ›å»ºç”¨æˆ·",
            "code": "user:create",
            "resource": "user",
            "action": "create",
            "permission_type": "function"
        }
    ],
    "total": 10
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{role_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{role_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… è‡ªåŠ¨è¿‡æ»¤ç»„ç»‡ï¼ˆåªè¿”å›å½“å‰ç»„ç»‡çš„æƒé™ï¼‰
- âœ… å“åº”ä¸­åŒ…å« `uuid` å­—æ®µ

### 2. æƒé™ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/v1/permissions`  
**Tags**ï¼š`Permissions`ï¼ˆè‹±æ–‡ï¼‰

#### 2.1 è·å–æƒé™åˆ—è¡¨

```python
GET /api/v1/permissions?page=1&page_size=20&resource=user&permission_type=function

Response 200:
{
    "items": [
        {
            "id": 1,
            "name": "åˆ›å»ºç”¨æˆ·",
            "code": "user:create",
            "resource": "user",
            "action": "create",
            "permission_type": "function",
            "description": "åˆ›å»ºç”¨æˆ·çš„æƒé™",
            "role_count": 5  // å…³è”çš„è§’è‰²æ•°é‡
        }
    ],
    "total": 50,
    "page": 1,
    "page_size": 20
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è¿‡æ»¤ç»„ç»‡ï¼ˆåªè¿”å›å½“å‰ç»„ç»‡çš„æƒé™ï¼‰
- âœ… æ”¯æŒåˆ†é¡µï¼ˆ`page`, `page_size`ï¼‰
- âœ… æ”¯æŒç­›é€‰ï¼ˆ`resource`, `permission_type`, `action`ï¼‰
- âœ… æ”¯æŒå…³é”®è¯æœç´¢ï¼ˆ`keyword`ï¼šæœç´¢æƒé™åç§°ã€ä»£ç ã€æè¿°ï¼‰
- âœ… è¿”å›å…³è”çš„è§’è‰²æ•°é‡ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰

#### 2.2 è·å–æƒé™è¯¦æƒ…

```python
GET /api/v1/permissions/{permission_uuid}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440001",
    "name": "åˆ›å»ºç”¨æˆ·",
    "code": "user:create",
    "resource": "user",
    "action": "create",
    "permission_type": "function",
    "description": "åˆ›å»ºç”¨æˆ·çš„æƒé™",
    "roles": [  // å…³è”çš„è§’è‰²åˆ—è¡¨
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440000",
            "name": "ç®¡ç†å‘˜",
            "code": "admin"
        }
    ],
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{permission_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{permission_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… è¿”å›æƒé™å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…³è”çš„è§’è‰²åˆ—è¡¨ï¼‰
- âœ… å“åº”ä¸­åŒ…å« `uuid` å­—æ®µ

---

## ğŸ”§ Service å±‚è®¾è®¡

### 1. è§’è‰²æœåŠ¡ï¼ˆRoleServiceï¼‰

```python
# riveredge-backend/src/tree-root/services/role_service.py
from typing import List, Optional
from tortoise.exceptions import IntegrityError
from models.role import Role
from models.permission import Permission
from schemas.role import RoleCreate, RoleUpdate
from core.exceptions import NotFoundError, ValidationError, PermissionDeniedError


class RoleService:
    """
    è§’è‰²æœåŠ¡ç±»
    
    æä¾›è§’è‰²çš„ CRUD æ“ä½œå’Œæƒé™åˆ†é…åŠŸèƒ½ã€‚
    """
    
    @staticmethod
    async def create_role(
        tenant_id: int,
        data: RoleCreate,
        current_user_id: int
    ) -> Role:
        """
        åˆ›å»ºè§’è‰²
        
        Args:
            tenant_id: ç»„ç»‡ID
            data: è§’è‰²åˆ›å»ºæ•°æ®
            current_user_id: å½“å‰ç”¨æˆ·ID
            
        Returns:
            Role: åˆ›å»ºçš„è§’è‰²å¯¹è±¡
            
        Raises:
            ValidationError: å½“è§’è‰²ä»£ç å·²å­˜åœ¨æ—¶æŠ›å‡º
            PermissionDeniedError: å½“ç”¨æˆ·æ— æƒé™æ—¶æŠ›å‡º
        """
        # éªŒè¯æƒé™ï¼ˆéœ€è¦ç»„ç»‡ç®¡ç†å‘˜æˆ–è¶…çº§ç”¨æˆ·ï¼‰
        # TODO: å®ç°æƒé™éªŒè¯é€»è¾‘
        
        # æ£€æŸ¥è§’è‰²ä»£ç æ˜¯å¦å·²å­˜åœ¨
        existing_role = await Role.filter(
            tenant_id=tenant_id,
            code=data.code,
            deleted_at__isnull=True
        ).first()
        
        if existing_role:
            raise ValidationError(f"è§’è‰²ä»£ç  {data.code} å·²å­˜åœ¨")
        
        # åˆ›å»ºè§’è‰²
        role = await Role.create(
            tenant_id=tenant_id,
            name=data.name,
            code=data.code,
            description=data.description,
            is_active=data.is_active if data.is_active is not None else True,
            is_system=False,  # ç³»ç»Ÿè§’è‰²åªèƒ½ç”±ç³»ç»Ÿåˆ›å»º
        )
        
        return role
    
    @staticmethod
    async def get_role_list(
        tenant_id: int,
        page: int = 1,
        page_size: int = 20,
        keyword: Optional[str] = None,
        is_active: Optional[bool] = None,
        is_system: Optional[bool] = None,
    ) -> dict:
        """
        è·å–è§’è‰²åˆ—è¡¨
        
        Args:
            tenant_id: ç»„ç»‡ID
            page: é¡µç 
            page_size: æ¯é¡µæ•°é‡
            keyword: å…³é”®è¯æœç´¢
            is_active: æ˜¯å¦å¯ç”¨ç­›é€‰
            is_system: æ˜¯å¦ç³»ç»Ÿè§’è‰²ç­›é€‰
            
        Returns:
            dict: åŒ…å«è§’è‰²åˆ—è¡¨å’Œåˆ†é¡µä¿¡æ¯
        """
        # æ„å»ºæŸ¥è¯¢
        query = Role.filter(tenant_id=tenant_id, deleted_at__isnull=True)
        
        # å…³é”®è¯æœç´¢
        if keyword:
            query = query.filter(
                Q(name__icontains=keyword) |
                Q(code__icontains=keyword) |
                Q(description__icontains=keyword)
            )
        
        # ç­›é€‰
        if is_active is not None:
            query = query.filter(is_active=is_active)
        
        if is_system is not None:
            query = query.filter(is_system=is_system)
        
        # åˆ†é¡µ
        total = await query.count()
        roles = await query.offset((page - 1) * page_size).limit(page_size).all()
        
        # è·å–å…³è”çš„æƒé™æ•°é‡å’Œç”¨æˆ·æ•°é‡
        result = []
        for role in roles:
            permission_count = await role.permissions.all().count()
            user_count = await role.user_roles.all().count()
            
            result.append({
                **role.__dict__,
                "permission_count": permission_count,
                "user_count": user_count,
            })
        
        return {
            "items": result,
            "total": total,
            "page": page,
            "page_size": page_size,
        }
    
    @staticmethod
    async def assign_permissions(
        tenant_id: int,
        role_id: int,
        permission_ids: List[int],
        current_user_id: int
    ) -> dict:
        """
        åˆ†é…æƒé™ç»™è§’è‰²
        
        Args:
            tenant_id: ç»„ç»‡ID
            role_id: è§’è‰²ID
            permission_ids: æƒé™IDåˆ—è¡¨
            current_user_id: å½“å‰ç”¨æˆ·ID
            
        Returns:
            dict: æ“ä½œç»“æœ
            
        Raises:
            NotFoundError: å½“è§’è‰²ä¸å­˜åœ¨æ—¶æŠ›å‡º
            ValidationError: å½“æƒé™ä¸å±äºå½“å‰ç»„ç»‡æ—¶æŠ›å‡º
        """
        # éªŒè¯æƒé™
        # TODO: å®ç°æƒé™éªŒè¯é€»è¾‘
        
        # è·å–è§’è‰²
        role = await Role.filter(
            id=role_id,
            tenant_id=tenant_id,
            deleted_at__isnull=True
        ).first()
        
        if not role:
            raise NotFoundError("è§’è‰²ä¸å­˜åœ¨")
        
        # æ£€æŸ¥ç³»ç»Ÿè§’è‰²
        if role.is_system:
            raise PermissionDeniedError("ç³»ç»Ÿè§’è‰²ä¸å¯ä¿®æ”¹æƒé™")
        
        # éªŒè¯æƒé™å±äºå½“å‰ç»„ç»‡
        permissions = await Permission.filter(
            id__in=permission_ids,
            tenant_id=tenant_id,
            deleted_at__isnull=True
        ).all()
        
        if len(permissions) != len(permission_ids):
            raise ValidationError("éƒ¨åˆ†æƒé™ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç»„ç»‡")
        
        # è·å–å½“å‰è§’è‰²çš„æƒé™
        current_permissions = await role.permissions.all()
        current_permission_ids = {p.id for p in current_permissions}
        new_permission_ids = set(permission_ids)
        
        # è®¡ç®—éœ€è¦æ·»åŠ å’Œç§»é™¤çš„æƒé™
        to_add = new_permission_ids - current_permission_ids
        to_remove = current_permission_ids - new_permission_ids
        
        # æ·»åŠ æƒé™
        if to_add:
            permissions_to_add = [p for p in permissions if p.id in to_add]
            await role.permissions.add(*permissions_to_add)
        
        # ç§»é™¤æƒé™
        if to_remove:
            permissions_to_remove = [p for p in current_permissions if p.id in to_remove]
            await role.permissions.remove(*permissions_to_remove)
        
        return {
            "success": True,
            "message": "æƒé™åˆ†é…æˆåŠŸ",
            "added_count": len(to_add),
            "removed_count": len(to_remove),
        }
```

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### 1. è§’è‰²ç®¡ç†é¡µé¢

**è·¯å¾„**ï¼š`/system/roles`  
**ç»„ä»¶**ï¼š`RoleManagementPage`

**åŠŸèƒ½**ï¼š
- âœ… è§’è‰²åˆ—è¡¨ï¼ˆä½¿ç”¨ `UniTable`ï¼‰
- âœ… åˆ›å»ºè§’è‰²ï¼ˆModal è¡¨å•ï¼‰
- âœ… ç¼–è¾‘è§’è‰²ï¼ˆModal è¡¨å•ï¼‰
- âœ… åˆ é™¤è§’è‰²ï¼ˆPopconfirm ç¡®è®¤ï¼‰
- âœ… åˆ†é…æƒé™ï¼ˆDrawer æŠ½å±‰ï¼Œæƒé™æ ‘å½¢é€‰æ‹©ï¼‰
- âœ… æŸ¥çœ‹è§’è‰²è¯¦æƒ…ï¼ˆDrawer æŠ½å±‰ï¼‰

**åˆ—å®šä¹‰**ï¼š
```typescript
const columns: ProColumns<Role>[] = [
  {
    title: 'è§’è‰²åç§°',
    dataIndex: 'name',
    width: 150,
  },
  {
    title: 'è§’è‰²ä»£ç ',
    dataIndex: 'code',
    width: 150,
  },
  {
    title: 'æè¿°',
    dataIndex: 'description',
    ellipsis: true,
  },
  {
    title: 'ç³»ç»Ÿè§’è‰²',
    dataIndex: 'is_system',
    width: 100,
    valueType: 'switch',
    render: (_, record) => (
      <Tag color={record.is_system ? 'red' : 'default'}>
        {record.is_system ? 'æ˜¯' : 'å¦'}
      </Tag>
    ),
  },
  {
    title: 'çŠ¶æ€',
    dataIndex: 'is_active',
    width: 100,
    valueType: 'switch',
    render: (_, record) => (
      <Tag color={record.is_active ? 'green' : 'default'}>
        {record.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}
      </Tag>
    ),
  },
  {
    title: 'æƒé™æ•°é‡',
    dataIndex: 'permission_count',
    width: 100,
    hideInSearch: true,
  },
  {
    title: 'ç”¨æˆ·æ•°é‡',
    dataIndex: 'user_count',
    width: 100,
    hideInSearch: true,
  },
  {
    title: 'æ“ä½œ',
    valueType: 'option',
    width: 200,
    render: (_, record) => [
      <Button key="edit" onClick={() => handleEdit(record)}>ç¼–è¾‘</Button>,
      <Button key="permissions" onClick={() => handleAssignPermissions(record)}>åˆ†é…æƒé™</Button>,
      <Popconfirm
        key="delete"
        title="ç¡®å®šåˆ é™¤æ­¤è§’è‰²å—ï¼Ÿ"
        onConfirm={() => handleDelete(record.id)}
        disabled={record.is_system}
      >
        <Button danger disabled={record.is_system}>åˆ é™¤</Button>
      </Popconfirm>,
    ],
  },
];
```

### 2. æƒé™ç®¡ç†é¡µé¢

**è·¯å¾„**ï¼š`/system/permissions`  
**ç»„ä»¶**ï¼š`PermissionManagementPage`

**åŠŸèƒ½**ï¼š
- âœ… æƒé™åˆ—è¡¨ï¼ˆä½¿ç”¨ `UniTable`ï¼‰
- âœ… æŒ‰èµ„æºåˆ†ç»„æ˜¾ç¤º
- âœ… æŒ‰æƒé™ç±»å‹ç­›é€‰
- âœ… æŸ¥çœ‹æƒé™è¯¦æƒ…ï¼ˆDrawer æŠ½å±‰ï¼‰

**åˆ—å®šä¹‰**ï¼š
```typescript
const columns: ProColumns<Permission>[] = [
  {
    title: 'æƒé™åç§°',
    dataIndex: 'name',
    width: 150,
  },
  {
    title: 'æƒé™ä»£ç ',
    dataIndex: 'code',
    width: 200,
  },
  {
    title: 'èµ„æº',
    dataIndex: 'resource',
    width: 100,
    valueEnum: {
      user: 'ç”¨æˆ·',
      role: 'è§’è‰²',
      department: 'éƒ¨é—¨',
      // ...
    },
  },
  {
    title: 'æ“ä½œ',
    dataIndex: 'action',
    width: 100,
    valueEnum: {
      create: 'åˆ›å»º',
      read: 'æŸ¥çœ‹',
      update: 'æ›´æ–°',
      delete: 'åˆ é™¤',
    },
  },
  {
    title: 'æƒé™ç±»å‹',
    dataIndex: 'permission_type',
    width: 100,
    valueEnum: {
      function: 'åŠŸèƒ½æƒé™',
      data: 'æ•°æ®æƒé™',
      field: 'å­—æ®µæƒé™',
    },
  },
  {
    title: 'å…³è”è§’è‰²æ•°',
    dataIndex: 'role_count',
    width: 100,
    hideInSearch: true,
  },
];
```

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

### æ•°æ®åº“è®¾è®¡
- [ ] åˆ›å»º `root_roles` è¡¨
- [ ] åˆ›å»º `root_permissions` è¡¨
- [ ] åˆ›å»º `root_role_permissions` å…³è”è¡¨
- [ ] åˆ›å»º `root_user_roles` å…³è”è¡¨
- [ ] åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ç´¢å¼•
- [ ] åˆ›å»ºå”¯ä¸€çº¦æŸ

### åç«¯å®ç°
- [ ] åˆ›å»º `Role` æ¨¡å‹
- [ ] åˆ›å»º `Permission` æ¨¡å‹
- [ ] åˆ›å»º `UserRole` å…³è”æ¨¡å‹
- [ ] åˆ›å»º `RoleService` æœåŠ¡ç±»
- [ ] åˆ›å»º `PermissionService` æœåŠ¡ç±»
- [ ] åˆ›å»ºè§’è‰²ç®¡ç† APIï¼ˆCRUDï¼‰
- [ ] åˆ›å»ºæƒé™ç®¡ç† APIï¼ˆæŸ¥è¯¢ï¼‰
- [ ] å®ç°æƒé™åˆ†é…åŠŸèƒ½
- [ ] å®ç°ç»„ç»‡éš”ç¦»ï¼ˆæ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤ `tenant_id`ï¼‰
- [ ] å®ç°æƒé™éªŒè¯ä¸­é—´ä»¶

### å‰ç«¯å®ç°
- [ ] åˆ›å»ºè§’è‰²ç®¡ç†é¡µé¢ï¼ˆå‚è€ƒç»„ç»‡ç®¡ç†é¡µé¢å¸ƒå±€ï¼‰
- [ ] åˆ›å»ºæƒé™ç®¡ç†é¡µé¢ï¼ˆå‚è€ƒç»„ç»‡ç®¡ç†é¡µé¢å¸ƒå±€ï¼‰
- [ ] åˆ›å»ºè§’è‰²è¡¨å•ç»„ä»¶ï¼ˆåˆ›å»º/ç¼–è¾‘ï¼Œä½¿ç”¨ Modal + ProFormï¼‰
- [ ] åˆ›å»ºæƒé™åˆ†é…ç»„ä»¶ï¼ˆæ ‘å½¢é€‰æ‹©å™¨ï¼‰
- [ ] é›†æˆ `UniTable` ç»„ä»¶
- [ ] å®ç°æƒé™éªŒè¯ï¼ˆå‰ç«¯æ ¹æ®æƒé™æ˜¾ç¤º/éšè—åŠŸèƒ½ï¼‰
- [ ] å‚è€ƒ [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md) è¿›è¡Œé¡µé¢å¼€å‘

### æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•ï¼ˆService å±‚ï¼‰
- [ ] API æµ‹è¯•ï¼ˆé›†æˆæµ‹è¯•ï¼‰
- [ ] å‰ç«¯ç»„ä»¶æµ‹è¯•
- [ ] æƒé™éªŒè¯æµ‹è¯•
- [ ] å¤šç»„ç»‡éš”ç¦»æµ‹è¯•

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. ç»„ç»‡éš”ç¦»
- âœ… æ‰€æœ‰æŸ¥è¯¢å¿…é¡»è‡ªåŠ¨è¿‡æ»¤ `tenant_id`
- âœ… æ‰€æœ‰åˆ›å»ºå¿…é¡»è‡ªåŠ¨è®¾ç½® `tenant_id`
- âœ… æ‰€æœ‰æ›´æ–°å¿…é¡»éªŒè¯ `tenant_id` æƒé™
- âœ… ç¦æ­¢è·¨ç»„ç»‡æ•°æ®è®¿é—®

### 2. ç³»ç»Ÿè§’è‰²ä¿æŠ¤
- âœ… ç³»ç»Ÿè§’è‰²ï¼ˆ`is_system=true`ï¼‰ä¸å¯åˆ é™¤
- âœ… ç³»ç»Ÿè§’è‰²ä¸å¯ä¿®æ”¹ï¼ˆåç§°ã€ä»£ç ç­‰ï¼‰
- âœ… ç³»ç»Ÿè§’è‰²æƒé™åˆ†é…éœ€è¦ç‰¹æ®Šæƒé™

### 3. æƒé™ä»£ç è§„èŒƒ
- âœ… æƒé™ä»£ç æ ¼å¼ï¼š`èµ„æº:æ“ä½œ`ï¼ˆå¦‚ `user:create`ï¼‰
- âœ… èµ„æºä½¿ç”¨å°å†™ï¼Œå¤šä¸ªå•è¯ç”¨ä¸‹åˆ’çº¿ï¼ˆå¦‚ `user_role`ï¼‰
- âœ… æ“ä½œä½¿ç”¨æ ‡å‡†åŠ¨è¯ï¼š`create`ã€`read`ã€`update`ã€`delete`ã€`list`ã€`export` ç­‰

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… è§’è‰²åˆ—è¡¨æŸ¥è¯¢æ—¶ï¼Œä½¿ç”¨ `prefetch_related` é¢„åŠ è½½å…³è”æ•°æ®
- âœ… æƒé™åˆ—è¡¨ä½¿ç”¨ Redis ç¼“å­˜ï¼ˆæ•°æ®å­—å…¸ç±»å‹ï¼‰
- âœ… ç”¨æˆ·æƒé™æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ï¼‰

### 5. ä»£ç è§„èŒƒ
- âœ… æ‰€æœ‰ä»£ç ä½¿ç”¨ä¸­æ–‡æ³¨é‡Š
- âœ… API Tags ä½¿ç”¨è‹±æ–‡ï¼ˆ`Roles`ã€`Permissions`ï¼‰
- âœ… API æè¿°ä½¿ç”¨ä¸­æ–‡ï¼ˆå‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰
- âœ… éµå¾ªå‘½åè§„èŒƒï¼ˆsnake_case/PascalCaseï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md](../ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½å®æ–½è·¯çº¿å›¾.md](../ç³»ç»Ÿçº§åŠŸèƒ½å®æ–½è·¯çº¿å›¾.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md) - â­ æ–‡ä»¶ç»“æ„è§„åˆ’
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md) - â­ å‰ç«¯é¡µé¢å¼€å‘è§„èŒƒ
- [2.éƒ¨é—¨ç®¡ç†æœ€ä½³å®è·µ.md](./2.éƒ¨é—¨ç®¡ç†æœ€ä½³å®è·µ.md) - éƒ¨é—¨ç®¡ç†ä¾èµ–æ­¤æ¨¡å—
- [3.èŒä½ç®¡ç†æœ€ä½³å®è·µ.md](./3.èŒä½ç®¡ç†æœ€ä½³å®è·µ.md) - èŒä½ç®¡ç†ä¾èµ–æ­¤æ¨¡å—
- [4.è´¦æˆ·ç®¡ç†æœ€ä½³å®è·µ.md](./4.è´¦æˆ·ç®¡ç†æœ€ä½³å®è·µ.md) - è´¦æˆ·ç®¡ç†ä¾èµ–æ­¤æ¨¡å—
- [APIè®¾è®¡è§„èŒƒ.md](../../2.rules/6.APIè®¾è®¡è§„èŒƒ.md)
- [æ•°æ®åº“å‘½åè§„èŒƒ.md](../../2.rules/3.æ•°æ®åº“å‘½åè§„èŒƒ.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

