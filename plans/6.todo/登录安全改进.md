# 登录安全改进计划

## 背景
前端已实现长按验证机制防止暴力破解，但客户端验证存在可被绕过的风险。需要服务端配合实现更完善的安全防护。

## 待实现的安全改进项

### 1. IP 级别的登录频率限制
- **问题**：攻击者可以清除 localStorage 后重置失败计数
- **方案**：服务端实现 IP 级别的登录频率限制
- **实现**：
  - 使用 Redis 记录每个 IP 的登录失败次数
  - 5 分钟内失败 3 次，该 IP 需要等待或完成验证
  - 即使客户端清除 localStorage，服务端仍能识别频繁请求

### 2. 服务端验证登录请求频率
- **问题**：客户端验证可被绕过，攻击者可能直接调用 API
- **方案**：服务端验证登录请求频率，拒绝过于频繁的请求
- **实现**：
  - 在登录 API 入口处检查请求频率
  - 即使客户端验证通过，服务端也要验证请求频率
  - 超过频率限制的请求直接返回 429 Too Many Requests

### 3. 递增惩罚机制
- **问题**：固定时间窗口，攻击者可以等待后重试
- **方案**：失败次数越多，延迟时间越长
- **实现**：
  - 失败 3 次：延迟 5 分钟
  - 失败 5 次：延迟 15 分钟
  - 失败 10 次：延迟 1 小时
  - 失败 20 次：延迟 24 小时
  - 使用 Redis 记录 IP 的惩罚状态和解除时间

### 4. 登录失败日志记录
- **问题**：缺少安全审计和异常检测数据
- **方案**：记录详细的登录失败日志
- **实现**：
  - 记录 IP 地址
  - 记录用户名（如果存在）
  - 记录失败原因（用户名不存在/密码错误/账户被禁用等）
  - 记录时间戳
  - 用于安全审计和异常检测

## 技术实现建议

### Redis 数据结构
```python
# IP 失败记录
login_fail:ip:{ip_address} = {
    "count": 3,
    "first_fail": timestamp,
    "last_fail": timestamp,
    "blocked_until": timestamp
}

# 登录失败日志（可选，如果数据量大可考虑使用时间序列数据库）
login_fail_log:ip:{ip_address}:{timestamp} = {
    "username": "xxx",
    "reason": "password_error",
    "ip": "xxx.xxx.xxx.xxx"
}
```

### API 中间件
在登录 API 前添加频率限制中间件：
- 检查 IP 是否在惩罚期内
- 检查请求频率是否超过限制
- 记录失败日志

## 优先级
1. **高优先级**：IP 级别的登录频率限制（核心防护）
2. **高优先级**：服务端验证登录请求频率（防止绕过）
3. **中优先级**：递增惩罚机制（增强防护）
4. **中优先级**：登录失败日志记录（审计和监控）

## 相关文件
- 前端实现：`riveredge-frontend/src/pages/login/index.tsx`
- 后端登录服务：`riveredge-backend/src/infra/services/auth_service.py`

