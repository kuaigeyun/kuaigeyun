# å¤´åƒæ˜¾ç¤ºé€»è¾‘åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ RiverEdge é¡¹ç›®ä¸­å¤´åƒçš„å­˜å‚¨ã€ä¸Šä¼ ã€æ˜¾ç¤ºé€»è¾‘ã€‚

## ğŸ—„ï¸ åç«¯å­˜å‚¨

### æ•°æ®æ¨¡å‹

1. **User æ¨¡å‹** (`riveredge-backend/src/infra/models/user.py`)
   - `avatar`: `CharField(max_length=255, null=True)` - å­˜å‚¨æ–‡ä»¶ UUID

2. **PlatformSuperAdmin æ¨¡å‹** (`riveredge-backend/src/infra/models/platform_superadmin.py`)
   - `avatar`: `CharField(max_length=255, null=True)` - å­˜å‚¨æ–‡ä»¶ UUID

### æ–‡ä»¶å­˜å‚¨

- **å­˜å‚¨è·¯å¾„**: `uploads/{tenant_id}/{year}/{month}/{filename}`
- **æ–‡ä»¶å‘½å**: ä½¿ç”¨ UUID ä½œä¸ºæ–‡ä»¶å
- **æ–‡ä»¶åˆ†ç±»**: `category='avatar'`

### API æ¥å£

1. **æ–‡ä»¶ä¸Šä¼ **: `POST /api/v1/system/files/upload?category=avatar`
   - è¿”å›: `FileUploadResponse` (åŒ…å« `uuid`, `file_type` ç­‰)

2. **æ–‡ä»¶é¢„è§ˆ**: `GET /api/v1/system/files/{uuid}/preview`
   - è¿”å›: `FilePreviewResponse` (åŒ…å« `preview_url`)
   - é¢„è§ˆ URL æ ¼å¼: `{BASE_URL}/api/v1/system/files/{uuid}/download?token={preview_token}`
   - Token æœ‰æ•ˆæœŸ: 1å°æ—¶

3. **æ–‡ä»¶ä¸‹è½½**: `GET /api/v1/system/files/{uuid}/download?token={token}`
   - éœ€è¦éªŒè¯ token æƒé™
   - è¿”å›æ–‡ä»¶æµ

## ğŸ¨ å‰ç«¯æ˜¾ç¤ºé€»è¾‘

### 1. ä¸ªäººèµ„æ–™é¡µé¢ (`/personal/profile`)

#### ä¸Šä¼ æµç¨‹

```typescript
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
   â†“
2. ç«‹å³åˆ›å»ºæœ¬åœ°é¢„è§ˆ URL (URL.createObjectURL)
   â†’ ç«‹å³æ˜¾ç¤ºå¤´åƒé¢„è§ˆ
   â†“
3. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ (uploadFile)
   â†’ è¿”å›æ–‡ä»¶ UUID
   â†“
4. è·å–æœåŠ¡å™¨é¢„è§ˆ URL (getFilePreview)
   â†’ å¦‚æœæˆåŠŸï¼Œæ›¿æ¢ä¸ºæœåŠ¡å™¨ URL
   â†’ å¦‚æœå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æœ¬åœ°é¢„è§ˆ URL
   â†“
5. æ›´æ–°è¡¨å•å­—æ®µ (avatar = UUID)
   â†“
6. ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"
   â†’ è°ƒç”¨ updateUserProfile({ avatar: UUID })
   â†’ ä¿å­˜åˆ°åç«¯
```

#### åŠ è½½æµç¨‹

```typescript
1. è°ƒç”¨ getUserProfile()
   â†’ è¿”å› UserProfile (åŒ…å« avatar: UUID)
   â†“
2. å¦‚æœæœ‰ avatar UUID
   â†’ è°ƒç”¨ getFileByUuid(avatar)
   â†’ è·å–æ–‡ä»¶ä¿¡æ¯
   â†“
3. å¦‚æœæ˜¯å›¾ç‰‡ç±»å‹
   â†’ è°ƒç”¨ getFilePreview(avatar)
   â†’ è·å–é¢„è§ˆ URL
   â†“
4. è®¾ç½® avatarUrl çŠ¶æ€
   â†’ Avatar ç»„ä»¶æ˜¾ç¤ºå¤´åƒ
```

#### å…³é”®ä»£ç ä½ç½®

- **ä¸Šä¼ å¤„ç†**: `riveredge-frontend/src/pages/personal/profile/index.tsx:107-169`
- **åŠ è½½å¤„ç†**: `riveredge-frontend/src/pages/personal/profile/index.tsx:41-102`
- **æ˜¾ç¤ºç»„ä»¶**: `riveredge-frontend/src/pages/personal/profile/index.tsx:221-225, 322-326`

### 2. é¡¶éƒ¨å¯¼èˆªæ  (`BasicLayout`)

#### å½“å‰å®ç°

```typescript
<Avatar
  size={24}
  src={(currentUser as any)?.avatar}  // âš ï¸ é—®é¢˜ï¼šè¿™é‡Œå­˜å‚¨çš„æ˜¯ UUIDï¼Œä¸æ˜¯ URL
  ...
>
```

#### é—®é¢˜åˆ†æ

- `currentUser.avatar` å­˜å‚¨çš„æ˜¯ **æ–‡ä»¶ UUID**ï¼Œä¸æ˜¯é¢„è§ˆ URL
- Avatar ç»„ä»¶çš„ `src` éœ€è¦çš„æ˜¯ **å›¾ç‰‡ URL**
- å› æ­¤é¡¶éƒ¨å¯¼èˆªæ çš„å¤´åƒæ— æ³•æ˜¾ç¤º

#### è§£å†³æ–¹æ¡ˆ

éœ€è¦å°† UUID è½¬æ¢ä¸ºé¢„è§ˆ URLï¼š

```typescript
// æ–¹æ¡ˆ1ï¼šåœ¨è·å–ç”¨æˆ·ä¿¡æ¯æ—¶è½¬æ¢
const userData = await getCurrentUser();
if (userData.avatar) {
  const previewInfo = await getFilePreview(userData.avatar);
  userData.avatar = previewInfo.preview_url;
}

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨ useEffect å¼‚æ­¥åŠ è½½
useEffect(() => {
  if (currentUser?.avatar && !avatarUrl) {
    getFilePreview(currentUser.avatar).then(info => {
      setAvatarUrl(info.preview_url);
    });
  }
}, [currentUser?.avatar]);
```

### 3. é”å±é¡µé¢ (`/lock-screen`)

#### å½“å‰å®ç°

```typescript
<Avatar
  size={80}
  src={(currentUser as any)?.avatar}  // âš ï¸ åŒæ ·çš„é—®é¢˜
  ...
>
```

#### é—®é¢˜åˆ†æ

- ä¸é¡¶éƒ¨å¯¼èˆªæ ç›¸åŒçš„é—®é¢˜
- `currentUser.avatar` æ˜¯ UUIDï¼Œä¸æ˜¯ URL

## ğŸ”„ æ•°æ®æµè½¬

### å®Œæ•´æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ å¤´åƒ
  â†“
å‰ç«¯: URL.createObjectURL (æœ¬åœ°é¢„è§ˆ)
  â†“
å‰ç«¯: uploadFile â†’ è¿”å› UUID
  â†“
å‰ç«¯: getFilePreview(UUID) â†’ è¿”å› preview_url
  â†“
å‰ç«¯: updateUserProfile({ avatar: UUID })
  â†“
åç«¯: ä¿å­˜ UUID åˆ° User.avatar æˆ– PlatformSuperAdmin.avatar
  â†“
å‰ç«¯: getUserProfile() â†’ è¿”å› { avatar: UUID }
  â†“
å‰ç«¯: getFilePreview(UUID) â†’ è¿”å› preview_url
  â†“
å‰ç«¯: Avatar src={preview_url} â†’ æ˜¾ç¤ºå¤´åƒ
```

### UUID vs URL

- **å­˜å‚¨**: åç«¯å­˜å‚¨çš„æ˜¯ **UUID** (æ–‡ä»¶å”¯ä¸€æ ‡è¯†)
- **æ˜¾ç¤º**: å‰ç«¯éœ€è¦çš„æ˜¯ **URL** (å¯è®¿é—®çš„å›¾ç‰‡åœ°å€)
- **è½¬æ¢**: é€šè¿‡ `getFilePreview(UUID)` API å°† UUID è½¬æ¢ä¸ºé¢„è§ˆ URL

## âš ï¸ å½“å‰é—®é¢˜

### é—®é¢˜1: é¡¶éƒ¨å¯¼èˆªæ å’Œé”å±é¡µé¢å¤´åƒä¸æ˜¾ç¤º

**åŸå› **: `currentUser.avatar` å­˜å‚¨çš„æ˜¯ UUIDï¼Œä¸æ˜¯ URL

**å½±å“èŒƒå›´**:
- `riveredge-frontend/src/layouts/BasicLayout.tsx:3152`
- `riveredge-frontend/src/pages/lock-screen/index.tsx:684`

**è§£å†³æ–¹æ¡ˆ**: éœ€è¦åœ¨è¿™äº›åœ°æ–¹å°† UUID è½¬æ¢ä¸ºé¢„è§ˆ URL

### é—®é¢˜2: å¤´åƒ URL è¿‡æœŸ

**åŸå› **: é¢„è§ˆ URL ä¸­çš„ token æœ‰æ•ˆæœŸä¸º 1 å°æ—¶

**å½±å“**: 1 å°æ—¶åï¼Œæ—§çš„é¢„è§ˆ URL ä¼šå¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**: 
- åœ¨æ˜¾ç¤ºå¤´åƒæ—¶ï¼Œå¦‚æœ URL å¤±æ•ˆï¼Œé‡æ–°è·å–é¢„è§ˆ URL
- æˆ–è€…ä½¿ç”¨æ›´é•¿çš„ token æœ‰æ•ˆæœŸï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰

## ğŸ“ å»ºè®®æ”¹è¿›

### 1. ç»Ÿä¸€å¤´åƒ URL è½¬æ¢é€»è¾‘

åˆ›å»ºä¸€ä¸ªå·¥å…·å‡½æ•°ï¼š

```typescript
// utils/avatar.ts
export async function getAvatarUrl(avatarUuid: string | undefined): Promise<string | undefined> {
  if (!avatarUuid) return undefined;
  
  try {
    const previewInfo = await getFilePreview(avatarUuid);
    return previewInfo.preview_url;
  } catch (error) {
    console.warn('è·å–å¤´åƒé¢„è§ˆ URL å¤±è´¥:', error);
    return undefined;
  }
}
```

### 2. åœ¨ç”¨æˆ·ä¿¡æ¯ä¸­ç›´æ¥åŒ…å«å¤´åƒ URL

ä¿®æ”¹åç«¯ APIï¼Œåœ¨è¿”å›ç”¨æˆ·ä¿¡æ¯æ—¶ç›´æ¥åŒ…å«å¤´åƒé¢„è§ˆ URLï¼š

```python
# åç«¯
class CurrentUserResponse(BaseModel):
    id: int
    username: str
    avatar: Optional[str] = None  # UUID
    avatar_url: Optional[str] = None  # é¢„è§ˆ URL
```

### 3. æ·»åŠ å¤´åƒç¼“å­˜æœºåˆ¶

- ä½¿ç”¨ localStorage ç¼“å­˜å¤´åƒ URL
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- å‡å°‘é‡å¤çš„ API è°ƒç”¨

## ğŸ” ç›¸å…³æ–‡ä»¶

### å‰ç«¯

- `riveredge-frontend/src/pages/personal/profile/index.tsx` - ä¸ªäººèµ„æ–™é¡µé¢
- `riveredge-frontend/src/layouts/BasicLayout.tsx` - é¡¶éƒ¨å¯¼èˆªæ 
- `riveredge-frontend/src/pages/lock-screen/index.tsx` - é”å±é¡µé¢
- `riveredge-frontend/src/services/file.ts` - æ–‡ä»¶æœåŠ¡
- `riveredge-frontend/src/services/userProfile.ts` - ä¸ªäººèµ„æ–™æœåŠ¡

### åç«¯

- `riveredge-backend/src/infra/models/user.py` - User æ¨¡å‹
- `riveredge-backend/src/infra/models/platform_superadmin.py` - PlatformSuperAdmin æ¨¡å‹
- `riveredge-backend/src/core/services/user_profile_service.py` - ä¸ªäººèµ„æ–™æœåŠ¡
- `riveredge-backend/src/core/api/files/files.py` - æ–‡ä»¶ API
- `riveredge-backend/src/core/services/file_preview_service.py` - æ–‡ä»¶é¢„è§ˆæœåŠ¡

## ğŸ“Š æ€»ç»“

1. **å­˜å‚¨**: åç«¯å­˜å‚¨æ–‡ä»¶ UUID
2. **æ˜¾ç¤º**: å‰ç«¯éœ€è¦å°† UUID è½¬æ¢ä¸ºé¢„è§ˆ URL
3. **ä¸ªäººèµ„æ–™é¡µé¢**: âœ… å·²æ­£ç¡®å®ç° UUID â†’ URL è½¬æ¢
4. **é¡¶éƒ¨å¯¼èˆªæ **: âŒ æœªå®ç° UUID â†’ URL è½¬æ¢
5. **é”å±é¡µé¢**: âŒ æœªå®ç° UUID â†’ URL è½¬æ¢

**ä¸‹ä¸€æ­¥**: ä¿®å¤é¡¶éƒ¨å¯¼èˆªæ å’Œé”å±é¡µé¢çš„å¤´åƒæ˜¾ç¤ºé—®é¢˜ã€‚

