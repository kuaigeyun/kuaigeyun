# 菜单收起状态显示问题分析报告

## 📋 问题描述

在菜单收起状态下，存在以下问题：
1. **图标不显示**：收起时图标消失
2. **文字不完全隐藏**：收起时仍有部分文字显示

## 🔍 当前实现分析

### 1. 主题配置逻辑

#### 1.1 主题判断
```typescript
// 通过 token.colorBgContainer 的亮度判断是否为深色模式
const isDarkMode = React.useMemo(() => {
  const bgColor = token.colorBgContainer;
  const brightness = calculateColorBrightness(bgColor);
  return brightness < 128; // 亮度 < 128 为深色模式
}, [token.colorBgContainer]);
```

#### 1.2 ProLayout navTheme 配置
```typescript
navTheme={isDarkMode ? "realDark" : "light"}
```

#### 1.3 菜单栏背景色计算
```typescript
const siderBgColor = React.useMemo(() => {
  // 深色模式：使用默认背景色
  if (isDarkMode) {
    return token.colorBgContainer;
  }
  // 浅色模式：优先使用自定义背景色
  const customBgColor = siderBgColorState || (window as any).__RIVEREDGE_SIDER_BG_COLOR__;
  return customBgColor || token.colorBgContainer;
}, [siderBgColorState, token.colorBgContainer, isDarkMode]);
```

#### 1.4 菜单栏文字颜色计算
```typescript
const siderTextColor = React.useMemo(() => {
  // 深色模式：使用深色模式的默认文字颜色
  if (isDarkMode) {
    return 'var(--ant-colorText)';
  }
  // 浅色模式：根据自定义背景色亮度计算
  const customBgColor = siderBgColorState || (window as any).__RIVEREDGE_SIDER_BG_COLOR__;
  if (customBgColor) {
    const brightness = calculateColorBrightness(customBgColor);
    return brightness < 128 ? '#ffffff' : 'var(--ant-colorText)';
  }
  return 'var(--ant-colorText)';
}, [siderBgColorState, isDarkMode]);
```

### 2. 菜单状态

#### 2.1 收起/展开状态
- `collapsed`: `useState(false)` - 控制菜单收起/展开
- ProLayout 使用 `collapsed` prop 控制菜单状态

#### 2.2 CSS 类名
- 收起状态：`.ant-pro-sider-collapsed` 或 `.ant-layout-sider-collapsed`
- 展开状态：无特殊类名

### 3. 当前 CSS 规则分析

#### 3.1 图标显示规则（当前实现）
```css
/* 确保所有图标都显示 */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-item-icon,
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .anticon:not(.ant-menu-submenu-arrow),
/* ... 更多选择器 */
{
  display: inline-flex !important;
  opacity: 1 !important;
  visibility: visible !important;
  width: 16px !important;
  height: 16px !important;
  text-indent: 0 !important;
  position: relative !important;
  z-index: 10 !important;
}
```

**问题**：
- 选择器可能不够精确
- 可能被其他规则覆盖
- 没有考虑图标在 `.ant-menu-title-content` 外部的情况

#### 3.2 文字隐藏规则（当前实现）
```css
/* 使用 text-indent 隐藏文字 */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content {
  text-indent: -9999px !important;
  overflow: hidden !important;
  white-space: nowrap !important;
}

/* 隐藏文字元素 */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content > span:not(.anticon) {
  display: none !important;
  /* ... */
}
```

**问题**：
- `text-indent: -9999px` 可能影响图标（如果图标在容器内）
- 选择器可能不够全面
- 没有处理所有可能的文字显示情况

## 📊 场景分析矩阵

### 场景 1：深色模式 + 展开状态
- **主题**：`isDarkMode = true`
- **navTheme**：`"realDark"`
- **菜单状态**：`collapsed = false`
- **菜单栏背景色**：`token.colorBgContainer`（深色）
- **菜单栏文字颜色**：`var(--ant-colorText)`（浅色）
- **预期行为**：
  - ✅ 图标显示：正常显示
  - ✅ 文字显示：正常显示
- **当前问题**：无

### 场景 2：深色模式 + 收起状态
- **主题**：`isDarkMode = true`
- **navTheme**：`"realDark"`
- **菜单状态**：`collapsed = true`
- **菜单栏背景色**：`token.colorBgContainer`（深色）
- **菜单栏文字颜色**：`var(--ant-colorText)`（浅色）
- **预期行为**：
  - ✅ 图标显示：应该显示
  - ❌ 文字显示：应该隐藏
- **当前问题**：
  - ❌ 图标不显示
  - ❌ 文字不完全隐藏

### 场景 3：浅色模式 + 浅色菜单 + 展开状态
- **主题**：`isDarkMode = false`
- **navTheme**：`"light"`
- **菜单状态**：`collapsed = false`
- **菜单栏背景色**：`token.colorBgContainer`（浅色）或自定义浅色
- **菜单栏文字颜色**：`var(--ant-colorText)`（深色）
- **预期行为**：
  - ✅ 图标显示：正常显示
  - ✅ 文字显示：正常显示
- **当前问题**：无

### 场景 4：浅色模式 + 浅色菜单 + 收起状态
- **主题**：`isDarkMode = false`
- **navTheme**：`"light"`
- **菜单状态**：`collapsed = true`
- **菜单栏背景色**：`token.colorBgContainer`（浅色）或自定义浅色
- **菜单栏文字颜色**：`var(--ant-colorText)`（深色）
- **预期行为**：
  - ✅ 图标显示：应该显示
  - ❌ 文字显示：应该隐藏
- **当前问题**：
  - ❌ 图标不显示
  - ❌ 文字不完全隐藏

### 场景 5：浅色模式 + 深色菜单 + 展开状态
- **主题**：`isDarkMode = false`
- **navTheme**：`"light"`
- **菜单状态**：`collapsed = false`
- **菜单栏背景色**：自定义深色（如 `#001529`）
- **菜单栏文字颜色**：`#ffffff`（浅色）
- **预期行为**：
  - ✅ 图标显示：正常显示
  - ✅ 文字显示：正常显示
- **当前问题**：无

### 场景 6：浅色模式 + 深色菜单 + 收起状态 ⭐ **关键场景**
- **主题**：`isDarkMode = false`
- **navTheme**：`"light"`
- **菜单状态**：`collapsed = true`
- **菜单栏背景色**：自定义深色（如 `#001529`）
- **菜单栏文字颜色**：`#ffffff`（浅色）
- **预期行为**：
  - ✅ 图标显示：应该显示（浅色图标）
  - ❌ 文字显示：应该隐藏
- **当前问题**：
  - ❌ 图标不显示（最严重）
  - ❌ 文字不完全隐藏

## 🔬 DOM 结构分析

### Ant Design Menu 在收起状态下的 DOM 结构

根据 Ant Design 的文档和实际渲染，菜单项在收起状态下的 DOM 结构可能是：

#### 情况 A：图标在菜单项直接子元素
```html
<li class="ant-menu-item">
  <span class="ant-menu-item-icon">
    <i class="anticon anticon-dashboard"></i>
  </span>
  <span class="ant-menu-title-content">
    <a>仪表盘</a>
  </span>
</li>
```

#### 情况 B：图标在 .ant-menu-title-content 内部
```html
<li class="ant-menu-item">
  <span class="ant-menu-title-content">
    <span class="ant-menu-item-icon">
      <i class="anticon anticon-dashboard"></i>
    </span>
    <a>仪表盘</a>
  </span>
</li>
```

#### 情况 C：子菜单标题结构
```html
<li class="ant-menu-submenu">
  <div class="ant-menu-submenu-title">
    <span class="anticon anticon-dashboard"></span>
    <span class="ant-menu-title-content">
      <span>仪表盘</span>
    </span>
    <span class="ant-menu-submenu-arrow">
      <i class="anticon anticon-right"></i>
    </span>
  </div>
  <ul class="ant-menu-sub">
    <!-- 子菜单项 -->
  </ul>
</li>
```

## 🎯 问题根源分析

### 问题 1：图标不显示

**可能原因**：
1. **text-indent 影响**：`.ant-menu-title-content` 设置了 `text-indent: -9999px`，如果图标在容器内，也会被影响
2. **选择器优先级不足**：图标显示规则可能被其他规则覆盖
3. **图标位置不确定**：图标可能在容器内或容器外，当前规则没有覆盖所有情况
4. **display 被覆盖**：可能有其他规则设置了 `display: none`

### 问题 2：文字不完全隐藏

**可能原因**：
1. **text-indent 不够**：只隐藏了文本节点，但文字元素可能通过其他方式显示
2. **选择器不全面**：没有覆盖所有可能的文字元素（如直接文本节点、嵌套的 span 等）
3. **CSS 优先级冲突**：可能有其他规则覆盖了隐藏规则

## 💡 解决方案设计

### 方案 1：使用更精确的选择器（推荐）

#### 1.1 图标显示策略
- **原则**：无论图标在哪里，都要确保显示
- **方法**：
  1. 使用最高优先级的选择器
  2. 覆盖所有可能的图标位置
  3. 使用 `!important` 确保优先级
  4. 明确设置图标的 `text-indent: 0` 和 `position: absolute`（如果需要）

#### 1.2 文字隐藏策略
- **原则**：只隐藏文字，不影响图标
- **方法**：
  1. 不使用 `text-indent` 在容器级别（避免影响图标）
  2. 直接隐藏所有文字元素（`span`、`a` 等，但排除图标）
  3. 使用 `font-size: 0` 在容器级别隐藏文本节点
  4. 使用 `::before` 和 `::after` 伪元素隐藏（如果需要）

### 方案 2：使用 CSS 变量和条件渲染

根据不同的场景组合，动态生成不同的 CSS 规则。

### 方案 3：使用 JavaScript 动态调整

在菜单收起时，通过 JavaScript 直接操作 DOM，隐藏文字元素，保留图标。

## 📝 推荐实施方案

### 步骤 1：移除有问题的 text-indent 规则

移除 `.ant-menu-title-content` 级别的 `text-indent: -9999px`，避免影响图标。

### 步骤 2：使用 font-size: 0 隐藏文本节点

在容器级别使用 `font-size: 0` 隐藏纯文本节点，但确保图标有明确的 `font-size`。

### 步骤 3：精确隐藏文字元素

使用更精确的选择器，只隐藏文字元素（`span`、`a` 等），明确排除图标。

### 步骤 4：确保图标显示（最高优先级）

使用最高优先级的选择器，确保图标无论在哪里都能显示。

### 步骤 5：测试所有场景

在以下场景下测试：
- ✅ 深色模式 + 展开
- ✅ 深色模式 + 收起
- ✅ 浅色模式 + 浅色菜单 + 展开
- ✅ 浅色模式 + 浅色菜单 + 收起
- ✅ 浅色模式 + 深色菜单 + 展开
- ✅ 浅色模式 + 深色菜单 + 收起

## 🔧 具体实现建议

### CSS 规则结构

```css
/* ==================== 菜单收起状态 ==================== */

/* 1. 首先确保图标显示（最高优先级） */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-item-icon,
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .anticon:not(.ant-menu-submenu-arrow),
/* ... 覆盖所有可能的图标位置 */
{
  display: inline-flex !important;
  font-size: 16px !important;
  text-indent: 0 !important;
  /* ... */
}

/* 2. 隐藏文字元素（排除图标） */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content > span:not(.anticon):not(.ant-menu-item-icon),
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content > a,
/* ... */
{
  display: none !important;
  /* ... */
}

/* 3. 使用 font-size: 0 隐藏文本节点 */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content {
  font-size: 0 !important;
  line-height: 0 !important;
}

/* 4. 确保图标不受 font-size: 0 影响 */
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content .anticon,
.ant-pro-layout .ant-pro-sider-collapsed .ant-pro-sider-menu .ant-menu-item .ant-menu-title-content .ant-menu-item-icon {
  font-size: 16px !important;
  line-height: 1 !important;
}
```

## ⚠️ 注意事项

1. **不要使用 text-indent 在容器级别**：会影响图标
2. **不要设置 width: 0**：会压缩容器，影响图标显示
3. **确保图标选择器优先级最高**：放在最前面，使用最具体的选择器
4. **测试所有场景**：确保在所有主题和状态下都能正常工作
5. **考虑弹出菜单**：收起状态下，有子菜单的项会显示弹出菜单，不要影响弹出菜单的显示

## 📅 下一步行动

1. ✅ 完成分析报告（当前步骤）
2. ⏳ 根据分析报告实现解决方案
3. ⏳ 在所有场景下测试
4. ⏳ 修复发现的问题
5. ⏳ 最终验证

---

**报告生成时间**：2025-01-07
**分析人员**：AI Assistant
**状态**：待实施

