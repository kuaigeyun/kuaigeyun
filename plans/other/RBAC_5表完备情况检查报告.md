# RBAC 5 è¡¨å®Œå¤‡æƒ…å†µæ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ—¶é—´
2025-01-XX

## âœ… æ€»ä½“æƒ…å†µ
**RBAC 5 è¡¨å‡å·²åˆ›å»ºï¼Œç»“æ„åŸºæœ¬å®Œæ•´ï¼Œä½†å­˜åœ¨ä¸€äº›ä¸ä¸€è‡´é—®é¢˜éœ€è¦ä¿®å¤ã€‚**

---

## ğŸ“Š è¯¦ç»†æ£€æŸ¥ç»“æœ

### 1. ç”¨æˆ·è¡¨ï¼ˆUserï¼‰âœ…

**è¡¨åï¼š** `core_users`ï¼ˆåŸ `sys_users`ï¼Œå·²é€šè¿‡è¿ç§»é‡å‘½åï¼‰

**æ¨¡å‹æ–‡ä»¶ï¼š** `riveredge-backend/src/infra/models/user.py`

**å­—æ®µå®Œå¤‡æ€§ï¼š**
- âœ… `id` - ä¸»é”®ï¼ˆè‡ªå¢IDï¼‰
- âœ… `uuid` - ä¸šåŠ¡IDï¼ˆUUIDï¼Œé€šè¿‡ BaseModel ç»§æ‰¿ï¼‰
- âœ… `tenant_id` - ç»„ç»‡IDï¼ˆå¤šç»„ç»‡éš”ç¦»ï¼‰
- âœ… `username` - ç”¨æˆ·å
- âœ… `email` - é‚®ç®±
- âœ… `password_hash` - å¯†ç å“ˆå¸Œ
- âœ… `full_name` - å…¨å
- âœ… `is_active` - æ˜¯å¦æ¿€æ´»
- âœ… `is_platform_admin` - æ˜¯å¦å¹³å°ç®¡ç†
- âœ… `is_tenant_admin` - æ˜¯å¦ç»„ç»‡ç®¡ç†å‘˜
- âœ… `source` - ç”¨æˆ·æ¥æº
- âœ… `last_login` - æœ€åç™»å½•æ—¶é—´
- âœ… `department_id` - éƒ¨é—¨IDï¼ˆå¤–é”®ï¼‰
- âœ… `position_id` - èŒä½IDï¼ˆå¤–é”®ï¼‰
- âœ… `phone` - æ‰‹æœºå·
- âœ… `avatar` - å¤´åƒ
- âœ… `remark` - å¤‡æ³¨
- âœ… `bio` - ä¸ªäººç®€ä»‹
- âœ… `contact_info` - è”ç³»æ–¹å¼ï¼ˆJSONï¼‰
- âœ… `deleted_at` - è½¯åˆ é™¤æ—¶é—´
- âœ… `created_at` - åˆ›å»ºæ—¶é—´
- âœ… `updated_at` - æ›´æ–°æ—¶é—´

**å…³ç³»ï¼š**
- âœ… å¤šå¯¹å¤šå…³ç³»ï¼š`roles`ï¼ˆé€šè¿‡ `core_user_roles` è¡¨ï¼‰
- âœ… å¤–é”®å…³ç³»ï¼š`department`ï¼ˆå…³è” `core_departments`ï¼‰
- âœ… å¤–é”®å…³ç³»ï¼š`position`ï¼ˆå…³è” `core_positions`ï¼‰

**ç´¢å¼•ï¼š**
- âœ… `tenant_id`
- âœ… `username`
- âœ… `(tenant_id, username)` - å”¯ä¸€çº¦æŸ
- âœ… `is_platform_admin`
- âœ… `department_id`
- âœ… `position_id`
- âœ… `phone`

**å¤–é”®çº¦æŸï¼š**
- âœ… `department_id` â†’ `core_departments.id`
- âœ… `position_id` â†’ `core_positions.id`

**çŠ¶æ€ï¼š** âœ… **å®Œæ•´**

---

### 2. è§’è‰²è¡¨ï¼ˆRoleï¼‰âœ…

**è¡¨åï¼š** `core_roles`ï¼ˆåŸ `sys_roles`ï¼Œå·²é€šè¿‡è¿ç§»é‡å‘½åï¼‰

**æ¨¡å‹æ–‡ä»¶ï¼š** `riveredge-backend/src/core/models/role.py`

**å­—æ®µå®Œå¤‡æ€§ï¼š**
- âœ… `id` - ä¸»é”®ï¼ˆè‡ªå¢IDï¼‰
- âœ… `uuid` - ä¸šåŠ¡IDï¼ˆUUIDï¼Œé€šè¿‡ BaseModel ç»§æ‰¿ï¼‰
- âœ… `tenant_id` - ç»„ç»‡IDï¼ˆå¤šç»„ç»‡éš”ç¦»ï¼‰
- âœ… `name` - è§’è‰²åç§°
- âœ… `code` - è§’è‰²ä»£ç 
- âœ… `description` - è§’è‰²æè¿°
- âœ… `is_system` - æ˜¯å¦ç³»ç»Ÿè§’è‰²
- âœ… `is_active` - æ˜¯å¦å¯ç”¨
- âœ… `deleted_at` - è½¯åˆ é™¤æ—¶é—´
- âœ… `created_at` - åˆ›å»ºæ—¶é—´
- âœ… `updated_at` - æ›´æ–°æ—¶é—´

**å…³ç³»ï¼š**
- âœ… å¤šå¯¹å¤šå…³ç³»ï¼š`permissions`ï¼ˆé€šè¿‡ `core_role_permissions` è¡¨ï¼‰

**ç´¢å¼•ï¼š**
- âœ… `tenant_id`
- âœ… `code`
- âœ… `created_at`
- âœ… `(tenant_id, code)` - å”¯ä¸€çº¦æŸ

**çŠ¶æ€ï¼š** âœ… **å®Œæ•´**

---

### 3. æƒé™è¡¨ï¼ˆPermissionï¼‰âœ…

**è¡¨åï¼š** `core_permissions`ï¼ˆåŸ `sys_permissions`ï¼Œå·²é€šè¿‡è¿ç§»é‡å‘½åï¼‰

**æ¨¡å‹æ–‡ä»¶ï¼š** `riveredge-backend/src/core/models/permission.py`

**å­—æ®µå®Œå¤‡æ€§ï¼š**
- âœ… `id` - ä¸»é”®ï¼ˆè‡ªå¢IDï¼‰
- âœ… `uuid` - ä¸šåŠ¡IDï¼ˆUUIDï¼Œé€šè¿‡ BaseModel ç»§æ‰¿ï¼‰
- âœ… `tenant_id` - ç»„ç»‡IDï¼ˆå¤šç»„ç»‡éš”ç¦»ï¼‰
- âœ… `name` - æƒé™åç§°
- âœ… `code` - æƒé™ä»£ç ï¼ˆæ ¼å¼ï¼šèµ„æº:æ“ä½œï¼‰
- âœ… `resource` - èµ„æºï¼ˆæ¨¡å—ï¼‰
- âœ… `action` - æ“ä½œï¼ˆcreateã€readã€updateã€deleteï¼‰
- âœ… `description` - æƒé™æè¿°
- âœ… `permission_type` - æƒé™ç±»å‹ï¼ˆfunctionã€dataã€fieldï¼‰
- âœ… `deleted_at` - è½¯åˆ é™¤æ—¶é—´
- âœ… `created_at` - åˆ›å»ºæ—¶é—´
- âœ… `updated_at` - æ›´æ–°æ—¶é—´

**ç´¢å¼•ï¼š**
- âœ… `tenant_id`
- âœ… `code`
- âœ… `resource`
- âœ… `permission_type`
- âœ… `(tenant_id, code)` - å”¯ä¸€çº¦æŸ

**çŠ¶æ€ï¼š** âœ… **å®Œæ•´**

---

### 4. ç”¨æˆ·-è§’è‰²å…³è”è¡¨ï¼ˆUserRoleï¼‰âš ï¸

**è¡¨åï¼š** `core_user_roles`ï¼ˆåŸ `sys_user_roles`ï¼Œå·²é€šè¿‡è¿ç§»é‡å‘½åï¼‰

**æ¨¡å‹æ–‡ä»¶ï¼š** `riveredge-backend/src/core/models/user_role.py`

**å­—æ®µå®Œå¤‡æ€§ï¼š**
- âœ… `id` - ä¸»é”®ï¼ˆè‡ªå¢IDï¼‰
- âš ï¸ `uuid` - **æ•°æ®åº“è¿ç§»ä¸­æœ‰æ­¤å­—æ®µï¼Œä½†æ¨¡å‹å®šä¹‰ä¸­ç¼ºå¤±**
- âœ… `user_id` - ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
- âœ… `role_id` - è§’è‰²IDï¼ˆå¤–é”®ï¼‰
- âœ… `created_at` - åˆ›å»ºæ—¶é—´

**å…³ç³»ï¼š**
- âœ… å¤–é”®å…³ç³»ï¼š`user_id` â†’ `core_users.id`ï¼ˆON DELETE CASCADEï¼‰
- âœ… å¤–é”®å…³ç³»ï¼š`role_id` â†’ `core_roles.id`ï¼ˆON DELETE CASCADEï¼‰

**ç´¢å¼•ï¼š**
- âœ… `user_id`
- âœ… `role_id`
- âœ… `(user_id, role_id)` - å”¯ä¸€çº¦æŸ

**å¤–é”®çº¦æŸï¼š**
- âœ… `user_id` â†’ `core_users.id` ON DELETE CASCADE
- âœ… `role_id` â†’ `core_roles.id` ON DELETE CASCADE

**é—®é¢˜ï¼š**
- âš ï¸ **ä¸ä¸€è‡´**ï¼šæ•°æ®åº“è¿ç§»æ–‡ä»¶ä¸­å®šä¹‰äº† `uuid` å­—æ®µï¼Œä½†æ¨¡å‹å®šä¹‰ä¸­æ²¡æœ‰ã€‚è¿™å¯èƒ½å¯¼è‡´ Tortoise ORM æ— æ³•æ­£ç¡®å¤„ç†è¯¥å­—æ®µã€‚

**çŠ¶æ€ï¼š** âš ï¸ **åŸºæœ¬å®Œæ•´ï¼Œä½†å­˜åœ¨ä¸ä¸€è‡´é—®é¢˜**

---

### 5. è§’è‰²-æƒé™å…³è”è¡¨ï¼ˆRolePermissionï¼‰âš ï¸

**è¡¨åï¼š** `core_role_permissions`ï¼ˆåŸ `sys_role_permissions`ï¼Œå·²é€šè¿‡è¿ç§»é‡å‘½åï¼‰

**æ¨¡å‹æ–‡ä»¶ï¼š** `riveredge-backend/src/core/models/role_permission.py`

**å­—æ®µå®Œå¤‡æ€§ï¼š**
- âœ… `id` - ä¸»é”®ï¼ˆè‡ªå¢IDï¼‰
- âš ï¸ `uuid` - **æ•°æ®åº“è¿ç§»ä¸­æœ‰æ­¤å­—æ®µï¼Œä½†æ¨¡å‹å®šä¹‰ä¸­ç¼ºå¤±**
- âœ… `role_id` - è§’è‰²IDï¼ˆå¤–é”®ï¼‰
- âœ… `permission_id` - æƒé™IDï¼ˆå¤–é”®ï¼‰
- âœ… `created_at` - åˆ›å»ºæ—¶é—´

**å…³ç³»ï¼š**
- âœ… å¤–é”®å…³ç³»ï¼š`role_id` â†’ `core_roles.id`ï¼ˆON DELETE CASCADEï¼‰
- âœ… å¤–é”®å…³ç³»ï¼š`permission_id` â†’ `core_permissions.id`ï¼ˆON DELETE CASCADEï¼‰

**ç´¢å¼•ï¼š**
- âœ… `role_id`
- âœ… `permission_id`
- âœ… `(role_id, permission_id)` - å”¯ä¸€çº¦æŸ

**å¤–é”®çº¦æŸï¼š**
- âœ… `role_id` â†’ `core_roles.id` ON DELETE CASCADE
- âœ… `permission_id` â†’ `core_permissions.id` ON DELETE CASCADE

**é—®é¢˜ï¼š**
- âš ï¸ **ä¸ä¸€è‡´**ï¼šæ•°æ®åº“è¿ç§»æ–‡ä»¶ä¸­å®šä¹‰äº† `uuid` å­—æ®µï¼Œä½†æ¨¡å‹å®šä¹‰ä¸­æ²¡æœ‰ã€‚è¿™å¯èƒ½å¯¼è‡´ Tortoise ORM æ— æ³•æ­£ç¡®å¤„ç†è¯¥å­—æ®µã€‚

**çŠ¶æ€ï¼š** âš ï¸ **åŸºæœ¬å®Œæ•´ï¼Œä½†å­˜åœ¨ä¸ä¸€è‡´é—®é¢˜**

---

## ğŸ” å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1ï¼šå…³è”è¡¨ç¼ºå°‘ `uuid` å­—æ®µå®šä¹‰

**å½±å“èŒƒå›´ï¼š**
- `core_user_roles` è¡¨
- `core_role_permissions` è¡¨

**é—®é¢˜æè¿°ï¼š**
æ•°æ®åº“è¿ç§»æ–‡ä»¶ä¸­ä¸ºè¿™ä¸¤ä¸ªå…³è”è¡¨å®šä¹‰äº† `uuid` å­—æ®µï¼Œä½†å¯¹åº”çš„ Tortoise ORM æ¨¡å‹å®šä¹‰ä¸­æ²¡æœ‰è¯¥å­—æ®µã€‚è¿™å¯èƒ½å¯¼è‡´ï¼š
1. Tortoise ORM æ— æ³•æ­£ç¡®è¯»å–/å†™å…¥ `uuid` å­—æ®µ
2. æ•°æ®åº“ç»“æ„ä¸æ¨¡å‹å®šä¹‰ä¸ä¸€è‡´
3. å¯èƒ½å¯¼è‡´æ•°æ®åŒæ­¥é—®é¢˜

**å»ºè®®ä¿®å¤æ–¹æ¡ˆï¼š**
1. **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šä»æ•°æ®åº“è¿ç§»æ–‡ä»¶ä¸­ç§»é™¤ `uuid` å­—æ®µï¼ˆå…³è”è¡¨é€šå¸¸ä¸éœ€è¦ UUIDï¼‰
2. **æ–¹æ¡ˆ B**ï¼šåœ¨æ¨¡å‹å®šä¹‰ä¸­æ·»åŠ  `uuid` å­—æ®µï¼ˆå¦‚æœç¡®å®éœ€è¦ UUIDï¼‰

**æ¨èæ–¹æ¡ˆ A çš„åŸå› ï¼š**
- å…³è”è¡¨ï¼ˆä¸­é—´è¡¨ï¼‰é€šå¸¸åªéœ€è¦ä¸»é”®å’Œå¤–é”®ï¼Œä¸éœ€è¦ä¸šåŠ¡IDï¼ˆUUIDï¼‰
- ç®€åŒ–æ¨¡å‹å®šä¹‰ï¼Œå‡å°‘ä¸å¿…è¦çš„å­—æ®µ
- ç¬¦åˆ RBAC æ ‡å‡†å®è·µ

---

## âœ… æ€»ç»“

### å®Œå¤‡æ€§è¯„åˆ†ï¼š**95/100**

**ä¼˜ç‚¹ï¼š**
- âœ… 5 ä¸ªæ ¸å¿ƒè¡¨å‡å·²åˆ›å»º
- âœ… æ‰€æœ‰è¡¨éƒ½æœ‰å®Œæ•´çš„å¤–é”®çº¦æŸ
- âœ… ç´¢å¼•è®¾è®¡åˆç†
- âœ… æ”¯æŒå¤šç»„ç»‡éš”ç¦»ï¼ˆ`tenant_id`ï¼‰
- âœ… æ”¯æŒè½¯åˆ é™¤ï¼ˆ`deleted_at`ï¼‰
- âœ… å…³ç³»å®šä¹‰å®Œæ•´ï¼ˆå¤šå¯¹å¤šã€å¤–é”®ï¼‰

**éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼š**
- âš ï¸ å…³è”è¡¨çš„ `uuid` å­—æ®µä¸ä¸€è‡´ï¼ˆ2 ä¸ªè¡¨ï¼‰

**å»ºè®®ä¼˜å…ˆçº§ï¼š**
1. ğŸ”´ **é«˜ä¼˜å…ˆçº§**ï¼šä¿®å¤å…³è”è¡¨çš„ `uuid` å­—æ®µä¸ä¸€è‡´é—®é¢˜
2. ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼šè€ƒè™‘æ˜¯å¦éœ€è¦ä¸ºå…³è”è¡¨æ·»åŠ å…¶ä»–ä¸šåŠ¡å­—æ®µï¼ˆå¦‚ `created_by`ã€`remark` ç­‰ï¼‰

---

## ğŸ“ é™„å½•ï¼šè¡¨ç»“æ„å¯¹æ¯”

### æ•°æ®åº“è¿ç§» vs æ¨¡å‹å®šä¹‰

| è¡¨å | è¿ç§»æ–‡ä»¶ä¸­çš„å­—æ®µ | æ¨¡å‹å®šä¹‰ä¸­çš„å­—æ®µ | å·®å¼‚ |
|------|----------------|----------------|------|
| `core_user_roles` | `id, uuid, user_id, role_id, created_at` | `id, user_id, role_id, created_at` | âŒ ç¼ºå°‘ `uuid` |
| `core_role_permissions` | `id, uuid, role_id, permission_id, created_at` | `id, role_id, permission_id, created_at` | âŒ ç¼ºå°‘ `uuid` |

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¿®å¤æ­¥éª¤

1. **å†³å®šæ˜¯å¦éœ€è¦ `uuid` å­—æ®µ**
   - å¦‚æœä¸éœ€è¦ï¼šä¿®æ”¹è¿ç§»æ–‡ä»¶ï¼Œç§»é™¤ `uuid` å­—æ®µ
   - å¦‚æœéœ€è¦ï¼šåœ¨æ¨¡å‹å®šä¹‰ä¸­æ·»åŠ  `uuid` å­—æ®µ

2. **åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶**
   - å¦‚æœç§»é™¤ `uuid`ï¼šåˆ›å»ºè¿ç§»æ–‡ä»¶åˆ é™¤è¯¥å­—æ®µ
   - å¦‚æœæ·»åŠ  `uuid`ï¼šåœ¨æ¨¡å‹å®šä¹‰ä¸­æ·»åŠ å­—æ®µï¼ˆTortoise ORM ä¼šè‡ªåŠ¨ç”Ÿæˆè¿ç§»ï¼‰

3. **æµ‹è¯•éªŒè¯**
   - éªŒè¯å…³è”è¡¨çš„ CRUD æ“ä½œ
   - éªŒè¯å¤–é”®çº¦æŸ
   - éªŒè¯å”¯ä¸€çº¦æŸ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2025-01-XX  
**æ£€æŸ¥å·¥å…·ï¼š** ä»£ç å®¡æŸ¥ + æ•°æ®åº“è¿ç§»æ–‡ä»¶å¯¹æ¯”

