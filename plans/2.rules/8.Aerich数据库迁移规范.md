# RiverEdge SaaS 多组织框架 - Aerich 数据库迁移规范

## 📋 概述

本文档定义 **RiverEdge SaaS 多组织框架 (RiverEdge SaaS Multi-tenant Framework)** 的 **Aerich 数据库迁移规范**，确保所有数据库结构变更都通过 Aerich 进行管理，保证迁移的可追溯性、可回滚性和团队协作的一致性。

**创建日期**：2025-12-16  
**最后更新**：2025-12-16

## ⚠️ 重要说明：Aerich 工具不稳定性及解决方案

**历史经验**：Aerich 工具在项目历史上经常出现以下问题：
- ❌ 格式检测错误："Old format of migration file detected"
- ❌ 初始化失败：无法正确识别迁移文件格式
- ❌ 版本兼容性问题：不同版本的 Aerich 对格式要求不一致
- ❌ 配置问题：无法正确加载 Tortoise ORM 配置

**核心原则**：
- ✅ **必须使用 Aerich 工具执行迁移**（严禁使用 SQL 直接执行）
- ✅ **迁移文件格式必须符合规范**
- ✅ **SQL 语句必须符合 Aerich 规范**（IF EXISTS、双引号、注释等）
- ✅ **遇到问题时，必须修复 Aerich 配置，而不是绕过它**

**解决 Aerich 问题的步骤**：
1. 检查并统一所有迁移文件格式
2. 检查 Aerich 配置是否正确
3. 尝试运行 `aerich fix-migrations` 修复格式
4. 如果仍然失败，检查 Aerich 版本和依赖
5. 查看 Aerich 错误日志，定位具体问题

## 🚨 核心原则（绝对禁止违反）

### 1. 严禁使用 SQL 直接修改数据库 ⭐⭐⭐ **绝对禁止违反！**

- ❌ **绝对禁止**使用 SQL 直接修改数据库结构（ALTER TABLE、CREATE TABLE、DROP TABLE 等）
- ❌ **绝对禁止**使用 SQL 直接修改数据库字段（RENAME COLUMN、ALTER COLUMN 等）
- ❌ **绝对禁止**使用 SQL 直接修改数据库索引（CREATE INDEX、DROP INDEX、ALTER INDEX 等）
- ❌ **绝对禁止**使用 SQL 直接修改数据库约束（ADD CONSTRAINT、DROP CONSTRAINT 等）
- ❌ **绝对禁止**使用 psql、pgAdmin、DBeaver 等工具直接执行 SQL 修改数据库
- ❌ **绝对禁止**在代码中直接执行 SQL 语句修改数据库结构
- ✅ **必须使用** Aerich 进行所有数据库迁移操作
- ✅ **必须使用** Tortoise ORM 的 `source_field` 参数映射字段名（如果数据库字段名与代码不一致）
- ✅ **必须使用** Aerich 迁移文件（`migrations/models/` 目录下的 Python 文件）进行数据库结构变更
- ✅ **必须使用** `aerich migrate` 命令生成迁移文件
- ✅ **必须使用** `aerich upgrade` 命令执行迁移

### 2. 唯一例外情况

⚠️ **只有在以下情况下，才允许使用 SQL，但必须严格遵守以下要求**：

1. **复杂的数据迁移**：需要大量数据转换、性能优化等 Aerich 无法完成的操作
2. **明确授权**：必须经过项目负责人明确授权
3. **必须创建迁移文件**：即使使用 SQL，也必须创建对应的 Aerich 迁移文件记录此次操作
4. **详细注释**：在迁移文件中添加详细注释说明为什么必须使用 SQL
5. **记录到 AI_MEMORY.md**：在 `plans/2.rules/AI_MEMORY.md` 中记录此次例外操作的原因

## 📐 Aerich 配置规范

### 1. 配置文件位置

- **Aerich 配置文件**：`riveredge-backend/migrations/aerich_config.py`
- **PyProject 配置**：`riveredge-backend/pyproject.toml` 中的 `[tool.aerich]` 部分

### 2. 配置要求

```toml
[tool.aerich]
tortoise_orm = "migrations.aerich_config.TORTOISE_ORM"
location = "./migrations"
src_folder = "./src"
```

### 3. 配置文件内容

`migrations/aerich_config.py` 必须：
- 正确导入 `TORTOISE_ORM` 配置
- 正确设置 Python 路径（添加 `src` 目录）
- 导出 `TORTOISE_ORM` 供 Aerich 使用

## 📝 迁移文件规范

### 1. 文件命名规范

迁移文件必须遵循以下命名规范：

```
{序号}_{日期时间}_{描述}.py
```

**示例**：
- ✅ `57_20251216_rename_is_platform_admin_to_is_infra_admin.py`
- ✅ `56_20251216110926_rename_indexes_uid_to_uk.py`
- ✅ `55_20250116_add_missing_table_comments.py`

**命名要求**：
- **序号**：按时间顺序递增的整数（从 0 开始）
- **日期时间**：`YYYYMMDD` 或 `YYYYMMDDHHMMSS` 格式
- **描述**：使用 `snake_case`，清晰描述迁移内容

### 2. 文件格式规范

所有迁移文件必须使用统一的格式：

```python
"""
迁移文件描述

详细说明此次迁移的目的、影响范围等。

执行时间: YYYY-MM-DD
"""

from tortoise import BaseDBAsyncClient


async def upgrade(db: BaseDBAsyncClient) -> str:
    """
    升级：执行数据库结构变更
    
    Returns:
        str: SQL 语句字符串
    """
    return """
        -- 迁移 SQL 语句
        -- 使用注释说明每个操作的目的
        
        -- 1. 创建表
        CREATE TABLE IF NOT EXISTS "table_name" (
            -- 字段定义
        );
        
        -- 2. 添加字段
        ALTER TABLE IF EXISTS "table_name" 
        ADD COLUMN IF NOT EXISTS "column_name" TYPE;
        
        -- 3. 重命名字段
        ALTER TABLE IF EXISTS "table_name" 
        RENAME COLUMN "old_name" TO "new_name";
        
        -- 4. 创建索引
        CREATE INDEX IF NOT EXISTS "idx_table_name_column" 
        ON "table_name" ("column_name");
        
        -- 5. 重命名索引
        ALTER INDEX IF EXISTS "old_index_name" 
        RENAME TO "new_index_name";
        
        -- 6. 添加注释
        COMMENT ON TABLE "table_name" IS '表注释';
        COMMENT ON COLUMN "table_name"."column_name" IS '字段注释';
    """


async def downgrade(db: BaseDBAsyncClient) -> str:
    """
    降级：回滚数据库结构变更
    
    Returns:
        str: SQL 语句字符串
    """
    return """
        -- 反向操作 SQL 语句
        -- 确保可以安全回滚
        
        -- 1. 删除表
        DROP TABLE IF EXISTS "table_name";
        
        -- 2. 删除字段
        ALTER TABLE IF EXISTS "table_name" 
        DROP COLUMN IF EXISTS "column_name";
        
        -- 3. 恢复字段名
        ALTER TABLE IF EXISTS "table_name" 
        RENAME COLUMN "new_name" TO "old_name";
        
        -- 4. 删除索引
        DROP INDEX IF EXISTS "idx_table_name_column";
        
        -- 5. 恢复索引名
        ALTER INDEX IF EXISTS "new_index_name" 
        RENAME TO "old_index_name";
    """
```

### 3. 导入规范

**必须使用**：
```python
from tortoise import BaseDBAsyncClient
```

**禁止使用**：
```python
from aerich.ddl import BaseDBAsyncClient  # ❌ 旧格式，禁止使用
```

### 4. 函数签名规范

**必须使用**：
```python
async def upgrade(db: BaseDBAsyncClient) -> str:
    return """SQL 语句"""

async def downgrade(db: BaseDBAsyncClient) -> str:
    return """SQL 语句"""
```

**禁止使用**：
```python
def upgrade():  # ❌ 旧格式，禁止使用
    return """SQL 语句"""
```

### 5. SQL 语句规范

#### 5.1 使用 IF EXISTS / IF NOT EXISTS

所有 SQL 语句必须使用 `IF EXISTS` 或 `IF NOT EXISTS`，确保迁移可以安全地重复执行：

```sql
-- ✅ 正确
CREATE TABLE IF NOT EXISTS "table_name" (...);
ALTER TABLE IF EXISTS "table_name" ADD COLUMN IF NOT EXISTS "column_name" TYPE;
DROP INDEX IF EXISTS "idx_table_name_column";

-- ❌ 错误
CREATE TABLE "table_name" (...);  -- 如果表已存在会报错
ALTER TABLE "table_name" ADD COLUMN "column_name" TYPE;  -- 如果字段已存在会报错
DROP INDEX "idx_table_name_column";  -- 如果索引不存在会报错
```

#### 5.2 使用双引号包裹标识符

所有表名、字段名、索引名必须使用双引号包裹，确保大小写敏感：

```sql
-- ✅ 正确
CREATE TABLE IF NOT EXISTS "core_users" (...);
ALTER TABLE IF EXISTS "core_users" RENAME COLUMN "is_platform_admin" TO "is_infra_admin";
CREATE INDEX IF NOT EXISTS "idx_core_users_tenant_id" ON "core_users" ("tenant_id");

-- ❌ 错误
CREATE TABLE IF NOT EXISTS core_users (...);  -- PostgreSQL 会将标识符转换为小写
```

#### 5.3 添加注释

所有 SQL 语句必须添加注释，说明操作的目的：

```sql
-- ✅ 正确
-- 重命名字段：将 is_platform_admin 重命名为 is_infra_admin，与代码保持一致
ALTER TABLE IF EXISTS "core_users" 
RENAME COLUMN "is_platform_admin" TO "is_infra_admin";

-- ❌ 错误
ALTER TABLE IF EXISTS "core_users" 
RENAME COLUMN "is_platform_admin" TO "is_infra_admin";  -- 没有注释说明
```

## 🔧 迁移操作流程

### 1. 创建迁移文件

#### 方法一：自动生成（推荐）

```bash
cd riveredge-backend

# 1. 修改模型文件（添加字段、修改字段等）
# 例如：在 src/infra/models/user.py 中添加新字段

# 2. 生成迁移文件
uv run aerich migrate --name add_new_field_to_user

# 3. 检查生成的迁移文件
# 文件位置：migrations/models/{序号}_{日期时间}_add_new_field_to_user.py
```

#### 方法二：手动创建

```bash
cd riveredge-backend

# 1. 创建迁移文件
# 文件位置：migrations/models/{序号}_{日期时间}_{描述}.py

# 2. 按照迁移文件格式规范编写迁移代码
```

### 2. 执行迁移

**必须使用 Aerich 工具执行迁移**，严禁使用 SQL 直接执行。

```bash
cd riveredge-backend

# 1. 检查迁移状态
uv run aerich status

# 2. 执行迁移
uv run aerich upgrade

# 3. 验证迁移结果
# 检查数据库结构是否符合预期
```

**如果 Aerich 报错，必须修复问题，而不是绕过**：

#### 步骤 1：检查迁移文件格式

确保所有迁移文件使用统一格式：

```bash
# 检查是否有旧格式文件
cd riveredge-backend
grep -r "from aerich.ddl import" migrations/models/
grep -r "^def upgrade(" migrations/models/

# 如果发现旧格式，统一修复为：
# from tortoise import BaseDBAsyncClient
# async def upgrade(db: BaseDBAsyncClient) -> str:
```

#### 步骤 2：尝试修复格式

```bash
cd riveredge-backend
uv run aerich fix-migrations
```

#### 步骤 3：检查 Aerich 配置

确保 `pyproject.toml` 中的配置正确：

```toml
[tool.aerich]
tortoise_orm = "migrations.aerich_config.TORTOISE_ORM"
location = "./migrations"
src_folder = "./src"
```

确保 `migrations/aerich_config.py` 正确导入配置：

```python
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
src_path = project_root / "src"
if str(src_path) not in sys.path:
    sys.path.insert(0, str(src_path))

from infra.infrastructure.database.database import TORTOISE_ORM

__all__ = ['TORTOISE_ORM']
```

#### 步骤 4：检查 Aerich 版本

```bash
cd riveredge-backend
uv run python -c "import aerich; print(aerich.__version__)"
```

如果版本过旧或过新，可能需要固定版本：

```toml
aerich==0.9.2  # 或固定到稳定版本
```

#### 步骤 5：查看详细错误信息

```bash
cd riveredge-backend
uv run aerich upgrade --verbose 2>&1 | tee aerich_error.log
```

根据错误信息定位具体问题。

**重要**：如果 Aerich 仍然无法正常工作，必须：
1. 记录详细的错误信息
2. 检查 Aerich 官方文档和 GitHub Issues
3. 尝试升级或降级 Aerich 版本
4. 检查 Tortoise ORM 版本兼容性
5. **严禁使用 SQL 直接执行迁移**

### 3. 回滚迁移

```bash
cd riveredge-backend

# 1. 查看迁移历史
uv run aerich history

# 2. 回滚到指定版本
uv run aerich downgrade

# 注意：回滚操作会执行 downgrade() 函数中的 SQL 语句
```

## ⚠️ 常见问题和解决方案

### 1. Aerich 工具报错 "Old format of migration file detected" ⚠️ 常见问题

**问题**：Aerich 报错检测到旧格式的迁移文件。

**原因**：
- 迁移文件使用了旧格式（`from aerich.ddl import BaseDBAsyncClient` 或 `def upgrade()`）
- 不同版本的 Aerich 对格式要求不一致
- 迁移文件格式不统一

**解决方案**（必须修复，不能绕过）：

1. **检查所有迁移文件格式**：
   ```bash
   cd riveredge-backend
   # 查找旧格式文件
   grep -r "from aerich.ddl import" migrations/models/
   grep -r "^def upgrade(" migrations/models/
   ```

2. **统一修复为正确格式**：
   ```python
   from tortoise import BaseDBAsyncClient
   
   async def upgrade(db: BaseDBAsyncClient) -> str:
       return """SQL 语句"""
   ```

3. **运行修复命令**：
   ```bash
   uv run aerich fix-migrations
   ```

4. **如果修复命令失败，手动修复所有文件**：
   - 批量替换 `from aerich.ddl import` 为 `from tortoise import`
   - 批量替换 `def upgrade()` 为 `async def upgrade(db: BaseDBAsyncClient) -> str:`

5. **重新尝试执行迁移**：
   ```bash
   uv run aerich upgrade
   ```

**重要**：必须修复 Aerich 问题，严禁使用 SQL 直接执行迁移。

### 2. 迁移文件格式不一致

**问题**：迁移文件使用了旧格式

**原因**：
- 迁移文件使用了旧格式（`from aerich.ddl import BaseDBAsyncClient`）
- 迁移文件使用了旧函数签名（`def upgrade()` 而不是 `async def upgrade(db: BaseDBAsyncClient) -> str`）

**解决方案**：
1. 统一所有迁移文件使用新格式：
   ```python
   from tortoise import BaseDBAsyncClient
   
   async def upgrade(db: BaseDBAsyncClient) -> str:
       return """SQL 语句"""
   ```
2. 即使修复了格式，Aerich 工具可能仍然报错，建议直接使用 Python 脚本执行迁移

### 2. 数据库连接失败

**问题**：Aerich 无法连接数据库

**原因**：
- 数据库服务未启动
- 数据库配置错误（`.env` 文件中的数据库连接信息不正确）

**解决方案**：
1. 检查数据库服务是否运行
2. 检查 `.env` 文件中的数据库配置：
   ```env
   DB_HOST=127.0.0.1
   DB_PORT=5432
   DB_USER=postgres
   DB_PASSWORD=your_password
   DB_NAME=riveredge
   ```
3. 测试数据库连接：
   ```bash
   psql -h 127.0.0.1 -p 5432 -U postgres -d riveredge
   ```

### 3. 模型加载警告

**问题**：`RuntimeWarning: Module "infra.models.base" has no models`

**原因**：
- `infra.models.base` 模块被配置在 `TORTOISE_ORM` 中，但该模块没有定义任何模型

**解决方案**：
1. 检查 `infra.models.base` 模块，确保它要么有模型，要么从配置中移除
2. 如果该模块只是基类，可以考虑重命名或移除

### 4. 字段名不一致

**问题**：代码中使用 `is_infra_admin`，但数据库字段名是 `is_platform_admin`

**解决方案**：
1. **优先方案**：使用 Tortoise ORM 的 `source_field` 参数映射字段名
   ```python
   class User(BaseModel):
       is_infra_admin = fields.BooleanField(
           default=False,
           source_field="is_platform_admin",  # 映射到数据库中的实际字段名
           description="是否为平台管理"
       )
   ```
2. **备选方案**：创建 Aerich 迁移文件重命名字段（如果必须修改数据库字段名）

### 5. 迁移文件冲突

**问题**：多个开发者同时创建迁移文件，导致序号冲突

**解决方案**：
1. 在创建迁移文件前，先拉取最新代码：`git pull`
2. 检查最新的迁移文件序号
3. 使用正确的序号创建新迁移文件
4. 如果发生冲突，手动调整序号

## 📚 最佳实践

### 1. 迁移文件编写

- ✅ **每次迁移只做一件事**：一个迁移文件只处理一个相关的变更
- ✅ **添加详细注释**：说明迁移的目的、影响范围、注意事项
- ✅ **实现 downgrade**：确保可以安全回滚
- ✅ **使用事务**：Aerich 会自动使用事务，确保迁移的原子性
- ✅ **测试迁移**：在开发环境先测试迁移，确认无误后再提交

### 2. 迁移文件命名

- ✅ **使用描述性名称**：清晰描述迁移内容
- ✅ **使用 snake_case**：符合 Python 命名规范
- ✅ **包含日期时间**：便于追踪迁移历史

### 3. 团队协作

- ✅ **及时提交迁移文件**：创建迁移文件后立即提交到 Git
- ✅ **不要修改已执行的迁移**：已执行的迁移文件不要修改，如果需要修改，创建新的迁移文件
- ✅ **同步迁移状态**：团队成员执行迁移前，先拉取最新代码

### 4. 生产环境

- ✅ **备份数据库**：执行迁移前先备份数据库
- ✅ **在维护窗口执行**：选择低峰期执行迁移
- ✅ **监控迁移过程**：执行迁移时监控数据库性能
- ✅ **准备回滚方案**：准备回滚脚本，以防迁移失败

## 🔍 验证和检查

### 1. 迁移文件格式检查

```bash
cd riveredge-backend

# 检查所有迁移文件是否使用正确的格式
grep -r "from aerich.ddl import" migrations/models/  # 应该没有结果
grep -r "^def upgrade(" migrations/models/  # 应该没有结果（应该使用 async def）
```

### 2. 迁移状态检查

```bash
cd riveredge-backend

# 检查迁移状态
uv run aerich status

# 查看迁移历史
uv run aerich history
```

### 3. 数据库结构验证

```bash
# 使用 psql 连接数据库，检查表结构
psql -h 127.0.0.1 -p 5432 -U postgres -d riveredge

# 检查表是否存在
\dt

# 检查表结构
\d core_users

# 检查索引
\di
```

## 📖 参考文档

- [Aerich 官方文档](https://github.com/tortoise/aerich)
- [Tortoise ORM 迁移文档](https://tortoise.github.io/migrations.html)
- [PostgreSQL ALTER TABLE 文档](https://www.postgresql.org/docs/current/sql-altertable.html)

## 📝 更新日志

- **2025-12-16**：创建文档，定义 Aerich 数据库迁移规范
- **2025-12-16**：添加"严禁使用 SQL 直接修改数据库"的核心原则
- **2025-12-16**：添加迁移文件格式规范和常见问题解决方案
- **2025-12-16**：明确必须使用 Aerich 工具执行迁移，严禁使用 SQL 直接执行
- **2025-12-16**：添加 Aerich 问题排查和修复步骤

---

**重要提醒**：所有数据库结构变更必须通过 Aerich 进行，严禁直接使用 SQL 修改数据库。违反此规范可能导致数据库结构不一致、迁移历史丢失、团队协作困难等问题。

