# RiverEdge SaaS å¤šç»„ç»‡æ¡†æ¶ - API è®¾è®¡è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰ **RiverEdge SaaS å¤šç»„ç»‡æ¡†æ¶ (RiverEdge SaaS Multi-tenant Framework)** çš„**ç»Ÿä¸€ API è®¾è®¡è§„èŒƒ**ï¼Œç¡®ä¿å‰åç«¯åä½œé¡ºç•…ï¼Œæ¥å£é£æ ¼ä¸€è‡´ï¼Œæå‡å¼€å‘æ•ˆç‡å’Œä»£ç å¯ç»´æŠ¤æ€§ã€‚

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-17

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **RESTful é£æ ¼**ï¼šéµå¾ª REST æ¶æ„é£æ ¼ï¼Œä½¿ç”¨æ ‡å‡† HTTP æ–¹æ³•
2. **ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šæ‰€æœ‰ API è¿”å›ç»Ÿä¸€çš„å“åº”ç»“æ„
3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šAPI è·¯å¾„åŒ…å«ç‰ˆæœ¬å·ï¼ˆ`/api/v1/`ï¼‰
4. **å¤šç»„ç»‡éš”ç¦»**ï¼šæ‰€æœ‰ API è‡ªåŠ¨å¤„ç†ç»„ç»‡éš”ç¦»ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’ `tenant_id`
5. **é”™è¯¯å¤„ç†ç»Ÿä¸€**ï¼šä½¿ç”¨æ ‡å‡† HTTP çŠ¶æ€ç å’Œä¸šåŠ¡é”™è¯¯ç 
6. **æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ**ï¼šåˆ©ç”¨ FastAPI è‡ªåŠ¨ç”Ÿæˆ OpenAPI/Swagger æ–‡æ¡£
7. **ç»å¯¹ç¦æ­¢ PowerShell**ï¼šå…¨ç¨‹ä¸¥ç¦ä½¿ç”¨ PowerShell è¿›è¡Œä»»ä½•æ“ä½œ â­ **é‡è¦**

## ğŸ“ API è·¯å¾„è§„èŒƒ

### è·¯å¾„å‰ç¼€

**è§„åˆ™**ï¼šæ‰€æœ‰ API è·¯å¾„å¿…é¡»ä»¥ `/api/v1/` å¼€å¤´

```
/api/v1/{resource}
```

**ç¤ºä¾‹**ï¼š
- âœ… `/api/v1/system/users` - ç³»ç»Ÿçº§ç”¨æˆ·ç®¡ç† API
- âœ… `/api/v1/platform/tenants` - å¹³å°çº§ç§Ÿæˆ·ç®¡ç† API
- âœ… `/api/v1/platform/admin` - å¹³å°è¶…çº§ç®¡ç†å‘˜ API
- âœ… `/api/v1/auth/login` - è®¤è¯ API
- âŒ `/api/users` - é”™è¯¯ï¼šç¼ºå°‘ç‰ˆæœ¬å·
- âŒ `/v1/users` - é”™è¯¯ï¼šç¼ºå°‘ `/api` å‰ç¼€

### èµ„æºå‘½å

**è§„åˆ™**ï¼šä½¿ç”¨å¤æ•°å½¢å¼ï¼Œå°å†™å­—æ¯ï¼Œå¤šä¸ªå•è¯ä½¿ç”¨è¿å­—ç¬¦ï¼ˆ`-`ï¼‰åˆ†éš”

**ç¤ºä¾‹**ï¼š
- âœ… `/api/v1/system/users` - ç³»ç»Ÿçº§ç”¨æˆ·èµ„æº
- âœ… `/api/v1/platform/tenants` - å¹³å°çº§ç§Ÿæˆ·èµ„æº
- âœ… `/api/v1/platform/packages` - å¹³å°å¥—é¤èµ„æº
- âœ… `/api/v1/seed-mes/order-items` - åº”ç”¨æ’ä»¶è®¢å•æ˜ç»†èµ„æºï¼ˆMES æ’ä»¶ï¼‰
- âŒ `/api/v1/user` - é”™è¯¯ï¼šåº”ä½¿ç”¨å¤æ•°
- âŒ `/api/v1/orderItems` - é”™è¯¯ï¼šåº”ä½¿ç”¨è¿å­—ç¬¦åˆ†éš”

### åµŒå¥—èµ„æº

**è§„åˆ™**ï¼šä½¿ç”¨è·¯å¾„å‚æ•°è¡¨ç¤ºèµ„æºå…³ç³»

**ç¤ºä¾‹**ï¼š
- âœ… `/api/v1/system/users/{user_id}/orders` - è·å–ç”¨æˆ·çš„è®¢å•åˆ—è¡¨
- âœ… `/api/v1/platform/tenants/{tenant_id}/users` - è·å–ç§Ÿæˆ·çš„ç”¨æˆ·åˆ—è¡¨
- âŒ `/api/v1/users/orders?user_id=123` - é”™è¯¯ï¼šåº”ä½¿ç”¨è·¯å¾„å‚æ•°

## ğŸ”§ HTTP æ–¹æ³•ä½¿ç”¨è§„èŒƒ

### GET - æŸ¥è¯¢èµ„æº

**ä½¿ç”¨åœºæ™¯**ï¼š
- è·å–èµ„æºåˆ—è¡¨
- è·å–å•ä¸ªèµ„æºè¯¦æƒ…
- æŸ¥è¯¢æ“ä½œï¼ˆä¸ä¿®æ”¹æ•°æ®ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# è·å–ç”¨æˆ·åˆ—è¡¨
GET /api/v1/system/users?page=1&page_size=10

# è·å–å•ä¸ªç”¨æˆ·
GET /api/v1/system/users/{user_id}

# æŸ¥è¯¢æ“ä½œ
GET /api/v1/system/users/search?keyword=admin
```

### POST - åˆ›å»ºèµ„æº

**ä½¿ç”¨åœºæ™¯**ï¼š
- åˆ›å»ºæ–°èµ„æº
- æ‰§è¡Œæ“ä½œï¼ˆå¦‚ç™»å½•ã€å¯¼å‡ºç­‰ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# åˆ›å»ºç”¨æˆ·
POST /api/v1/system/users
Body: { "username": "admin", "email": "admin@example.com" }

# ç”¨æˆ·ç™»å½•
POST /api/v1/auth/login
Body: { "username": "admin", "password": "123456" }
```

### PUT - å®Œæ•´æ›´æ–°èµ„æº

**ä½¿ç”¨åœºæ™¯**ï¼š
- å®Œæ•´æ›´æ–°èµ„æºï¼ˆæ›¿æ¢æ‰€æœ‰å­—æ®µï¼‰

**ç¤ºä¾‹**ï¼š
```python
# å®Œæ•´æ›´æ–°ç”¨æˆ·
PUT /api/v1/system/users/{user_id}
Body: { "username": "admin", "email": "admin@example.com", "status": "active" }
```

### PATCH - éƒ¨åˆ†æ›´æ–°èµ„æº

**ä½¿ç”¨åœºæ™¯**ï¼š
- éƒ¨åˆ†æ›´æ–°èµ„æºï¼ˆåªæ›´æ–°æä¾›çš„å­—æ®µï¼‰

**ç¤ºä¾‹**ï¼š
```python
# éƒ¨åˆ†æ›´æ–°ç”¨æˆ·
PATCH /api/v1/system/users/{user_id}
Body: { "email": "newemail@example.com" }
```

### DELETE - åˆ é™¤èµ„æº

**ä½¿ç”¨åœºæ™¯**ï¼š
- åˆ é™¤å•ä¸ªèµ„æº
- æ‰¹é‡åˆ é™¤èµ„æº

**ç¤ºä¾‹**ï¼š
```python
# åˆ é™¤å•ä¸ªç”¨æˆ·
DELETE /api/v1/system/users/{user_id}

# æ‰¹é‡åˆ é™¤ç”¨æˆ·
DELETE /api/v1/system/users
Body: { "ids": [1, 2, 3] }
```

## ğŸ“¦ ç»Ÿä¸€å“åº”æ ¼å¼

### æˆåŠŸå“åº”

**æ ‡å‡†æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": { ... },
  "timestamp": "2025-11-17T10:00:00Z"
}
```

**åˆ†é¡µå“åº”**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [ ... ],
    "total": 100,
    "page": 1,
    "page_size": 10,
    "total_pages": 10
  },
  "timestamp": "2025-11-17T10:00:00Z"
}
```

**åˆ—è¡¨å“åº”ï¼ˆæ— åˆ†é¡µï¼‰**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": [ ... ],
  "timestamp": "2025-11-17T10:00:00Z"
}
```

### é”™è¯¯å“åº”

**æ ‡å‡†æ ¼å¼**ï¼š
```json
{
  "code": 400,
  "message": "è¯·æ±‚å‚æ•°é”™è¯¯",
  "detail": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
  "timestamp": "2025-11-17T10:00:00Z"
}
```

**éªŒè¯é”™è¯¯å“åº”**ï¼š
```json
{
  "code": 422,
  "message": "æ•°æ®éªŒè¯å¤±è´¥",
  "detail": [
    {
      "field": "email",
      "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
    },
    {
      "field": "password",
      "message": "å¯†ç é•¿åº¦è‡³å°‘ 8 ä½"
    }
  ],
  "timestamp": "2025-11-17T10:00:00Z"
}
```

### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| `code` | number | HTTP çŠ¶æ€ç æˆ–ä¸šåŠ¡é”™è¯¯ç  | âœ… |
| `message` | string | å“åº”æ¶ˆæ¯ | âœ… |
| `data` | any | å“åº”æ•°æ®ï¼ˆæˆåŠŸæ—¶ï¼‰ | âŒ |
| `detail` | string/array | é”™è¯¯è¯¦æƒ…ï¼ˆé”™è¯¯æ—¶ï¼‰ | âŒ |
| `timestamp` | string | å“åº”æ—¶é—´æˆ³ï¼ˆISO 8601ï¼‰ | âœ… |

## ğŸ”¢ HTTP çŠ¶æ€ç è§„èŒƒ

### æ ‡å‡† HTTP çŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| `200` | OK | è¯·æ±‚æˆåŠŸ |
| `201` | Created | èµ„æºåˆ›å»ºæˆåŠŸ |
| `204` | No Content | åˆ é™¤æˆåŠŸï¼Œæ— è¿”å›å†…å®¹ |
| `400` | Bad Request | è¯·æ±‚å‚æ•°é”™è¯¯ |
| `401` | Unauthorized | æœªæˆæƒï¼ˆæœªç™»å½•æˆ– Token æ— æ•ˆï¼‰ |
| `403` | Forbidden | æƒé™ä¸è¶³ |
| `404` | Not Found | èµ„æºä¸å­˜åœ¨ |
| `409` | Conflict | èµ„æºå†²çªï¼ˆå¦‚ç”¨æˆ·åå·²å­˜åœ¨ï¼‰ |
| `422` | Unprocessable Entity | æ•°æ®éªŒè¯å¤±è´¥ |
| `500` | Internal Server Error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

### ä¸šåŠ¡é”™è¯¯ç ï¼ˆå¯é€‰ï¼‰

**è¯´æ˜**ï¼šåœ¨ `code` å­—æ®µä¸­å¯ä»¥ä½¿ç”¨ä¸šåŠ¡é”™è¯¯ç ï¼Œä½†å¿…é¡»é…åˆ HTTP çŠ¶æ€ç ä½¿ç”¨

**ç¤ºä¾‹**ï¼š
```json
{
  "code": 10001,  // ä¸šåŠ¡é”™è¯¯ç 
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "detail": "ç”¨æˆ· ID 123 ä¸å­˜åœ¨"
}
```

**HTTP çŠ¶æ€ç æ˜ å°„**ï¼š
- `400` + `10001-10099`: é€šç”¨ä¸šåŠ¡é”™è¯¯
- `401` + `10101-10199`: è®¤è¯ç›¸å…³é”™è¯¯
- `403` + `10201-10299`: æƒé™ç›¸å…³é”™è¯¯
- `404` + `10301-10399`: èµ„æºä¸å­˜åœ¨é”™è¯¯
- `409` + `10401-10499`: èµ„æºå†²çªé”™è¯¯

## ğŸ“„ è¯·æ±‚å‚æ•°è§„èŒƒ

### Query å‚æ•°ï¼ˆæŸ¥è¯¢å‚æ•°ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- åˆ†é¡µå‚æ•°ï¼ˆ`page`, `page_size`ï¼‰
- æ’åºå‚æ•°ï¼ˆ`sort`, `order`ï¼‰
- ç­›é€‰å‚æ•°ï¼ˆ`filter`, `search`ï¼‰
- æŸ¥è¯¢æ¡ä»¶ï¼ˆ`keyword`, `status` ç­‰ï¼‰

**ç¤ºä¾‹**ï¼š
```
GET /api/v1/system/users?page=1&page_size=10&sort=created_at&order=desc&status=active&keyword=admin
```

### Path å‚æ•°ï¼ˆè·¯å¾„å‚æ•°ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- èµ„æº ID
- åµŒå¥—èµ„æºæ ‡è¯†

**è§„åˆ™**ï¼š
- ä½¿ç”¨ `snake_case` å‘½å
- å¿…é¡»åŒ…å«åœ¨è·¯å¾„ä¸­

**ç¤ºä¾‹**ï¼š
```
GET /api/v1/system/users/{user_id}
GET /api/v1/system/users/{user_id}/orders/{order_id}
```

### Body å‚æ•°ï¼ˆè¯·æ±‚ä½“ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- POST åˆ›å»ºèµ„æº
- PUT å®Œæ•´æ›´æ–°èµ„æº
- PATCH éƒ¨åˆ†æ›´æ–°èµ„æº
- æ‰¹é‡æ“ä½œ

**è§„åˆ™**ï¼š
- ä½¿ç”¨ JSON æ ¼å¼
- éµå¾ª Pydantic Schema å®šä¹‰

**ç¤ºä¾‹**ï¼š
```json
POST /api/v1/system/users
{
  "username": "admin",
  "email": "admin@example.com",
  "password": "123456",
  "status": "active"
}
```

## ğŸ“Š åˆ†é¡µè§„èŒƒ

### åˆ†é¡µå‚æ•°

**æ ‡å‡†å‚æ•°**ï¼š
- `page`: é¡µç ï¼ˆä» 1 å¼€å§‹ï¼Œé»˜è®¤ 1ï¼‰
- `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 10ï¼Œæœ€å¤§ 100ï¼‰

**ç¤ºä¾‹**ï¼š
```
GET /api/v1/system/users?page=1&page_size=20
```

### åˆ†é¡µå“åº”

**æ ‡å‡†æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [ ... ],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `items`: å½“å‰é¡µæ•°æ®åˆ—è¡¨
- `total`: æ€»è®°å½•æ•°
- `page`: å½“å‰é¡µç 
- `page_size`: æ¯é¡µæ•°é‡
- `total_pages`: æ€»é¡µæ•°ï¼ˆå¯é€‰ï¼Œå‰ç«¯å¯è®¡ç®—ï¼‰

## ğŸ” æ’åºå’Œç­›é€‰è§„èŒƒ

### æ’åºå‚æ•°

**æ ‡å‡†å‚æ•°**ï¼š
- `sort`: æ’åºå­—æ®µï¼ˆé»˜è®¤ `created_at`ï¼‰
- `order`: æ’åºæ–¹å‘ï¼ˆ`asc` æˆ– `desc`ï¼Œé»˜è®¤ `desc`ï¼‰

**ç¤ºä¾‹**ï¼š
```
GET /api/v1/system/users?sort=username&order=asc
GET /api/v1/system/users?sort=created_at&order=desc
```

**å¤šå­—æ®µæ’åº**ï¼ˆå¯é€‰ï¼‰ï¼š
```
GET /api/v1/system/users?sort=status,created_at&order=asc,desc
```

### ç­›é€‰å‚æ•°

**æ ‡å‡†å‚æ•°**ï¼š
- `filter`: ç­›é€‰æ¡ä»¶ï¼ˆJSON å­—ç¬¦ä¸²æˆ–æŸ¥è¯¢å‚æ•°ï¼‰
- `search`: æ¨¡ç³Šæœç´¢å…³é”®è¯

**ç¤ºä¾‹**ï¼š
```
# æ–¹å¼ 1: ä½¿ç”¨æŸ¥è¯¢å‚æ•°
GET /api/v1/system/users?status=active&role=admin

# æ–¹å¼ 2: ä½¿ç”¨ filter å‚æ•°ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
GET /api/v1/system/users?filter={"status":"active","role":"admin"}

# æ–¹å¼ 3: ä½¿ç”¨ search å‚æ•°ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
GET /api/v1/system/users?search=admin
```

**æ—¥æœŸèŒƒå›´ç­›é€‰**ï¼š
```
GET /api/v1/system/users?created_at_start=2025-01-01&created_at_end=2025-12-31
```

## ğŸ¢ å¤šç»„ç»‡ API è§„èŒƒ

### ç»„ç»‡éš”ç¦»åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **æ‰€æœ‰æ•°æ®æ¨¡å‹å¿…é¡»åŒ…å« `tenant_id` å­—æ®µ**
2. **æ‰€æœ‰æŸ¥è¯¢å¿…é¡»è‡ªåŠ¨è¿‡æ»¤ç»„ç»‡**
3. **JWT Token å¿…é¡»åŒ…å«ç»„ç»‡ä¿¡æ¯**
4. **API è¯·æ±‚è‡ªåŠ¨ä» Token è·å–ç»„ç»‡ä¿¡æ¯**

### ç»„ç»‡ä¿¡æ¯è·å–

**åç«¯å®ç°**ï¼š
```python
from fastapi import Depends
from core.context.tenant_context import get_current_tenant_id

@router.get("/users")
async def get_users(
    tenant_id: int = Depends(get_current_tenant_id)
):
    # tenant_id è‡ªåŠ¨ä» JWT Token è·å–
    # æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤ç»„ç»‡
    users = await User.filter(tenant_id=tenant_id).all()
    return users
```

**å‰ç«¯å®ç°**ï¼š
```typescript
// JWT Token è‡ªåŠ¨åŒ…å«ç»„ç»‡ä¿¡æ¯
// å‰ç«¯æ— éœ€æ‰‹åŠ¨ä¼ é€’ tenant_id
const users = await getUserList({ page: 1, page_size: 10 });
```

### ç»„ç»‡ç®¡ç† API

**å¹³å°çº§ API**ï¼ˆå¹³å°çº§åŠŸèƒ½ï¼‰ï¼š
```
GET /api/v1/platform/tenants - è·å–ç§Ÿæˆ·åˆ—è¡¨ï¼ˆéœ€è¦å¹³å°è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
POST /api/v1/platform/tenants - åˆ›å»ºç§Ÿæˆ·ï¼ˆéœ€è¦å¹³å°è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
PUT /api/v1/platform/tenants/{tenant_id} - æ›´æ–°ç§Ÿæˆ·ï¼ˆéœ€è¦å¹³å°è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
DELETE /api/v1/platform/tenants/{tenant_id} - åˆ é™¤ç§Ÿæˆ·ï¼ˆéœ€è¦å¹³å°è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
```

**å¹³å°è¶…çº§ç®¡ç†å‘˜ API**ï¼ˆéœ€è¦å¹³å°è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰ï¼š
```
GET /api/v1/platform/admin - è·å–å¹³å°è¶…çº§ç®¡ç†å‘˜ä¿¡æ¯
POST /api/v1/platform/admin - åˆ›å»ºå¹³å°è¶…çº§ç®¡ç†å‘˜
PUT /api/v1/platform/admin - æ›´æ–°å¹³å°è¶…çº§ç®¡ç†å‘˜
POST /api/v1/platform/auth/login - å¹³å°è¶…çº§ç®¡ç†å‘˜ç™»å½•
GET /api/v1/platform/auth/me - è·å–å½“å‰å¹³å°è¶…çº§ç®¡ç†å‘˜ä¿¡æ¯
```

**ç»„ç»‡æ³¨å†Œ API**ï¼ˆå…¬å¼€ APIï¼‰ï¼š
```
POST /api/v1/auth/register - ç»„ç»‡æ³¨å†Œ
Body: {
  "tenant_name": "ç¤ºä¾‹å…¬å¸",
  "username": "admin",
  "email": "admin@example.com",
  "password": "123456"
}
```

### ç¦æ­¢äº‹é¡¹

**âŒ ç¦æ­¢åœ¨ API è·¯å¾„ä¸­ä¼ é€’ `tenant_id`**ï¼š
```
# âŒ é”™è¯¯ï¼šä¸åº”åœ¨è·¯å¾„ä¸­ä¼ é€’ tenant_idï¼ˆå¹³å°çº§ API é™¤å¤–ï¼‰
GET /api/v1/system/users?tenant_id=1
```

**âŒ ç¦æ­¢åœ¨ Query å‚æ•°ä¸­ä¼ é€’ `tenant_id`**ï¼š
```
# âŒ é”™è¯¯ï¼šä¸åº”åœ¨æŸ¥è¯¢å‚æ•°ä¸­ä¼ é€’ tenant_idï¼ˆå¹³å°çº§ API é™¤å¤–ï¼‰
GET /api/v1/system/users?tenant_id=1
```

**âœ… æ­£ç¡®ï¼šè‡ªåŠ¨ä» JWT Token è·å–**ï¼š
```
# âœ… æ­£ç¡®ï¼štenant_id è‡ªåŠ¨ä» Token è·å–
GET /api/v1/system/users
```

**âœ… å¹³å°çº§ API ä¾‹å¤–**ï¼š
```
# âœ… å¹³å°çº§ API å¯ä»¥ä¼ é€’ tenant_idï¼ˆç”¨äºç®¡ç†æ‰€æœ‰ç§Ÿæˆ·ï¼‰
GET /api/v1/platform/tenants/{tenant_id}/users
```

## ğŸ“– FastAPI æ–‡æ¡£ç”Ÿæˆè§„èŒƒ

### API Tags è§„èŒƒ

**è§„åˆ™**ï¼šæ‰€æœ‰ API è·¯ç”±çš„ `tags` å¿…é¡»ä½¿ç”¨**è‹±æ–‡**ï¼Œä¿æŒç»Ÿä¸€æ€§å’Œå›½é™…åŒ–

**ç›®çš„**ï¼š
- ä¿æŒ API æ–‡æ¡£çš„ç»Ÿä¸€æ€§
- ä¾¿äºå›½é™…åŒ–å±•ç¤º
- ç¬¦åˆ OpenAPI/Swagger æ ‡å‡†å®è·µ

**è§„èŒƒ**ï¼š
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨è‹±æ–‡ tags
router = APIRouter(prefix="/auth", tags=["Authentication"])
router = APIRouter(prefix="/users", tags=["Users"])
router = APIRouter(prefix="/roles", tags=["Roles"])
router = APIRouter(prefix="/permissions", tags=["Permissions"])
router = APIRouter(prefix="/tenants", tags=["Tenants"])

# âŒ é”™è¯¯ï¼šä½¿ç”¨ä¸­æ–‡ tags
router = APIRouter(prefix="/auth", tags=["è®¤è¯"])
router = APIRouter(prefix="/users", tags=["ç”¨æˆ·ç®¡ç†"])
```

**Tags å‘½åè§„èŒƒ**ï¼š
- ä½¿ç”¨**è‹±æ–‡**ï¼Œé¦–å­—æ¯å¤§å†™
- ä½¿ç”¨**å¤æ•°å½¢å¼**ï¼ˆå¦‚ `Users`, `Roles`, `Permissions`ï¼‰
- å¤šä¸ªå•è¯ä½¿ç”¨**ç©ºæ ¼åˆ†éš”**ï¼ˆå¦‚ `SuperAdmin Auth`, `SuperAdmin Tenants`ï¼‰
- ä¿æŒç®€æ´æ˜äº†

**æ ‡å‡† Tags åˆ—è¡¨**ï¼š
- `Authentication` - è®¤è¯ç›¸å…³ API
- `Users` - ç”¨æˆ·ç®¡ç† API
- `Roles` - è§’è‰²ç®¡ç† API
- `Permissions` - æƒé™ç®¡ç† API
- `Platform Tenants` - å¹³å°çº§ç§Ÿæˆ·ç®¡ç† API
- `Platform Admin` - å¹³å°è¶…çº§ç®¡ç†å‘˜ API
- `Platform Packages` - å¹³å°å¥—é¤ç®¡ç† API
- `Platform Monitoring` - å¹³å°ç›‘æ§ç»Ÿè®¡ API
- `Register` - ç»„ç»‡æ³¨å†Œ API

### API æè¿°è§„èŒƒ

**è§„åˆ™**ï¼šAPI è·¯ç”±çš„**æè¿°ï¼ˆå‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰ä½¿ç”¨ä¸­æ–‡**ï¼Œä¾¿äºå›¢é˜Ÿç†è§£

**ç›®çš„**ï¼š
- ä¾¿äºä¸­æ–‡å›¢é˜Ÿç†è§£ API åŠŸèƒ½
- æä¾›è¯¦ç»†çš„ä¸­æ–‡æ–‡æ¡£è¯´æ˜
- ä¿æŒä»£ç å¯è¯»æ€§

**è§„èŒƒ**ï¼š
```python
@router.post("/login", response_model=LoginResponse)
async def login(data: LoginRequest):
    """
    ç”¨æˆ·ç™»å½•æ¥å£
    
    éªŒè¯ç”¨æˆ·å‡­æ®å¹¶è¿”å› JWT Tokenï¼ˆåŒ…å« tenant_idï¼‰ã€‚
    ç™»å½•æˆåŠŸåè‡ªåŠ¨è®¾ç½®ç»„ç»‡ä¸Šä¸‹æ–‡ã€‚
    
    Args:
        data: ç™»å½•è¯·æ±‚æ•°æ®ï¼ˆusername, password, tenant_id å¯é€‰ï¼‰
        
    Returns:
        LoginResponse: ç™»å½•æˆåŠŸçš„å“åº”æ•°æ®ï¼ˆåŒ…å« access_tokenï¼‰
        
    Raises:
        HTTPException: å½“ç”¨æˆ·å/å¯†ç é”™è¯¯æˆ–ç”¨æˆ·æœªæ¿€æ´»æ—¶æŠ›å‡º
    """
    # å®ç°ä»£ç ...
```

**æè¿°å†…å®¹è¦æ±‚**ï¼š
- ä½¿ç”¨**ä¸­æ–‡**æè¿° API åŠŸèƒ½
- åŒ…å«**å‚æ•°è¯´æ˜**ï¼ˆArgsï¼‰
- åŒ…å«**è¿”å›å€¼è¯´æ˜**ï¼ˆReturnsï¼‰
- åŒ…å«**å¼‚å¸¸è¯´æ˜**ï¼ˆRaisesï¼‰
- åŒ…å«**ä½¿ç”¨ç¤ºä¾‹**ï¼ˆExampleï¼Œå¯é€‰ï¼‰

### æ€»ç»“

**Tags vs æè¿°**ï¼š
- **Tagsï¼ˆæ ‡ç­¾ï¼‰**ï¼šä½¿ç”¨**è‹±æ–‡**ï¼Œç”¨äº API æ–‡æ¡£åˆ†ç»„å’Œåˆ†ç±»
- **æè¿°ï¼ˆæ–‡æ¡£å­—ç¬¦ä¸²ï¼‰**ï¼šä½¿ç”¨**ä¸­æ–‡**ï¼Œç”¨äºè¯¦ç»†è¯´æ˜ API åŠŸèƒ½

**ç¤ºä¾‹å¯¹æ¯”**ï¼š
```python
# âœ… æ­£ç¡®ç¤ºä¾‹
router = APIRouter(prefix="/auth", tags=["Authentication"])  # Tags: è‹±æ–‡

@router.post("/login")
async def login(data: LoginRequest):
    """
    ç”¨æˆ·ç™»å½•æ¥å£  # æè¿°: ä¸­æ–‡
    
    éªŒè¯ç”¨æˆ·å‡­æ®å¹¶è¿”å› JWT Tokenã€‚
    """
    pass
```

## ğŸ“ ä»£ç ç¤ºä¾‹

### åç«¯å®ç°ï¼ˆFastAPIï¼‰

**ç»Ÿä¸€å“åº”æ¨¡å‹**ï¼š
```python
from typing import Generic, TypeVar, Optional, List
from pydantic import BaseModel
from datetime import datetime

T = TypeVar('T')

class ResponseModel(BaseModel, Generic[T]):
    """ç»Ÿä¸€å“åº”æ¨¡å‹"""
    code: int = 200
    message: str = "success"
    data: Optional[T] = None
    timestamp: datetime = datetime.now()

class PageResponse(BaseModel, Generic[T]):
    """åˆ†é¡µå“åº”æ¨¡å‹"""
    items: List[T]
    total: int
    page: int
    page_size: int
    total_pages: int

class ListResponse(BaseModel, Generic[T]):
    """åˆ—è¡¨å“åº”æ¨¡å‹"""
    items: List[T]
```

**API è·¯ç”±ç¤ºä¾‹**ï¼š
```python
from fastapi import APIRouter, Depends, Query
from core.response import ResponseModel, PageResponse
from core.context.tenant_context import get_current_tenant_id
from schemas.user import UserResponse, UserCreate, UserUpdate
from services.user_service import UserService

router = APIRouter(prefix="/users", tags=["Users"])

@router.get("", response_model=ResponseModel[PageResponse[UserResponse]])
async def get_users(
    page: int = Query(1, ge=1),
    page_size: int = Query(10, ge=1, le=100),
    sort: str = Query("created_at"),
    order: str = Query("desc", regex="^(asc|desc)$"),
    keyword: Optional[str] = Query(None),
    tenant_id: int = Depends(get_current_tenant_id)
):
    """è·å–ç”¨æˆ·åˆ—è¡¨"""
    users, total = await UserService.get_list(
        page=page,
        page_size=page_size,
        sort=sort,
        order=order,
        keyword=keyword,
        tenant_id=tenant_id
    )
    return ResponseModel(
        data=PageResponse(
            items=users,
            total=total,
            page=page,
            page_size=page_size,
            total_pages=(total + page_size - 1) // page_size
        )
    )

@router.post("", response_model=ResponseModel[UserResponse], status_code=201)
async def create_user(
    data: UserCreate,
    tenant_id: int = Depends(get_current_tenant_id)
):
    """åˆ›å»ºç”¨æˆ·"""
    user = await UserService.create(data, tenant_id=tenant_id)
    return ResponseModel(data=user, code=201)

@router.get("/{user_id}", response_model=ResponseModel[UserResponse])
async def get_user(
    user_id: int,
    tenant_id: int = Depends(get_current_tenant_id)
):
    """è·å–ç”¨æˆ·è¯¦æƒ…"""
    user = await UserService.get_by_id(user_id, tenant_id=tenant_id)
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")
    return ResponseModel(data=user)

@router.put("/{user_id}", response_model=ResponseModel[UserResponse])
async def update_user(
    user_id: int,
    data: UserUpdate,
    tenant_id: int = Depends(get_current_tenant_id)
):
    """æ›´æ–°ç”¨æˆ·"""
    user = await UserService.update(user_id, data, tenant_id=tenant_id)
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")
    return ResponseModel(data=user)

@router.delete("/{user_id}", status_code=204)
async def delete_user(
    user_id: int,
    tenant_id: int = Depends(get_current_tenant_id)
):
    """åˆ é™¤ç”¨æˆ·"""
    success = await UserService.delete(user_id, tenant_id=tenant_id)
    if not success:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")
    return Response(status_code=204)
```

### å‰ç«¯å®ç°ï¼ˆTypeScript + TanStack Queryï¼‰

**ç±»å‹å®šä¹‰**ï¼š
```typescript
// types/api.ts
export interface ResponseModel<T> {
  code: number;
  message: string;
  data?: T;
  timestamp: string;
}

export interface PageResponse<T> {
  items: T[];
  total: number;
  page: number;
  page_size: number;
  total_pages: number;
}

export interface ListResponse<T> {
  items: T[];
}
```

**API æœåŠ¡ç¤ºä¾‹**ï¼š
```typescript
// services/userService.ts
import { useQuery, useMutation } from '@tanstack/react-query';
import type { ResponseModel, PageResponse } from '@/types/api';
import type { User, UserCreate, UserUpdate } from '@/types/user';

/**
 * è·å–ç”¨æˆ·åˆ—è¡¨
 * 
 * @param params - æŸ¥è¯¢å‚æ•°
 * @returns ç”¨æˆ·åˆ—è¡¨å“åº”
 */
export async function getUserList(params: {
  page?: number;
  page_size?: number;
  sort?: string;
  order?: 'asc' | 'desc';
  keyword?: string;
}): Promise<ResponseModel<PageResponse<User>>> {
  return request('/api/v1/users', {
    method: 'GET',
    params,
  });
}

/**
 * è·å–ç”¨æˆ·è¯¦æƒ…
 * 
 * @param user_id - ç”¨æˆ· ID
 * @returns ç”¨æˆ·è¯¦æƒ…å“åº”
 */
export async function getUser(user_id: number): Promise<ResponseModel<User>> {
  return request(`/api/v1/users/${user_id}`, {
    method: 'GET',
  });
}

/**
 * åˆ›å»ºç”¨æˆ·
 * 
 * @param data - ç”¨æˆ·åˆ›å»ºæ•°æ®
 * @returns åˆ›å»ºçš„ç”¨æˆ·
 */
export async function createUser(data: UserCreate): Promise<ResponseModel<User>> {
  return request('/api/v1/users', {
    method: 'POST',
    data,
  });
}

/**
 * æ›´æ–°ç”¨æˆ·
 * 
 * @param user_id - ç”¨æˆ· ID
 * @param data - ç”¨æˆ·æ›´æ–°æ•°æ®
 * @returns æ›´æ–°çš„ç”¨æˆ·
 */
export async function updateUser(
  user_id: number,
  data: UserUpdate
): Promise<ResponseModel<User>> {
  return request(`/api/v1/users/${user_id}`, {
    method: 'PUT',
    data,
  });
}

/**
 * åˆ é™¤ç”¨æˆ·
 * 
 * @param user_id - ç”¨æˆ· ID
 */
export async function deleteUser(user_id: number): Promise<void> {
  return request(`/api/v1/users/${user_id}`, {
    method: 'DELETE',
  });
}
```

**ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// pages/UserList/index.tsx
import { useState, useEffect } from 'react';
import { ProTable } from '@ant-design/pro-components';
import { getUserList, deleteUser } from '@/services/userService';
import { message } from 'antd';

export default function UserList() {
  const [dataSource, setDataSource] = useState([]);
  const [loading, setLoading] = useState(false);

  const fetchUsers = async (params: any) => {
    setLoading(true);
    try {
      const response = await getUserList(params);
      if (response.code === 200 && response.data) {
        setDataSource(response.data.items);
        return {
          data: response.data.items,
          total: response.data.total,
          success: true,
        };
      }
      return { data: [], total: 0, success: false };
    } catch (error: any) {
      message.error(error.message || 'è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
      return { data: [], total: 0, success: false };
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (user_id: number) => {
    try {
      await deleteUser(user_id);
      message.success('åˆ é™¤æˆåŠŸ');
      fetchUsers({ page: 1, page_size: 10 });
    } catch (error: any) {
      message.error(error.message || 'åˆ é™¤å¤±è´¥');
    }
  };

  return (
    <ProTable
      request={fetchUsers}
      columns={[
        { title: 'ID', dataIndex: 'id', key: 'id' },
        { title: 'ç”¨æˆ·å', dataIndex: 'username', key: 'username' },
        { title: 'é‚®ç®±', dataIndex: 'email', key: 'email' },
        {
          title: 'æ“ä½œ',
          key: 'action',
          render: (_, record) => (
            <a onClick={() => handleDelete(record.id)}>åˆ é™¤</a>
          ),
        },
      ]}
      rowKey="id"
      pagination={{
        pageSize: 10,
        showSizeChanger: true,
      }}
    />
  );
}
```

## ğŸ” è®¤è¯å’Œæˆæƒ

### JWT Token è§„èŒƒ

**Token ç»“æ„**ï¼š
```json
{
  "user_id": 1,
  "tenant_id": 1,
  "username": "admin",
  "roles": ["admin"],
  "permissions": ["user:read", "user:write"],
  "exp": 1734422400
}
```

**Token ä¼ é€’**ï¼š
- **Header**: `Authorization: Bearer {token}`
- **Cookie**: `token={token}`ï¼ˆå¯é€‰ï¼‰

### è®¤è¯ API

**ç™»å½•**ï¼š
```
POST /api/v1/auth/login
Body: {
  "username": "admin",
  "password": "123456"
}
Response: {
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": { ... }
  }
}
```

**åˆ·æ–° Token**ï¼š
```
POST /api/v1/auth/refresh
Headers: {
  "Authorization": "Bearer {refresh_token}"
}
```

**ç™»å‡º**ï¼š
```
POST /api/v1/auth/logout
Headers: {
  "Authorization": "Bearer {token}"
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [2.å­—æ®µå‘½åè§„èŒƒ.md](./2.å­—æ®µå‘½åè§„èŒƒ.md) - å‘½åè§„èŒƒ
- [3.æ•°æ®åº“å‘½åè§„èŒƒ.md](./3.æ•°æ®åº“å‘½åè§„èŒƒ.md) - æ•°æ®åº“å‘½åè§„èŒƒ
- [4.æ³¨é‡Šè§„èŒƒ.md](./4.æ³¨é‡Šè§„èŒƒ.md) - æ³¨é‡Šè§„èŒƒ
- [AGENTS.md](./AGENTS.md) - AI åŠ©æ‰‹å¼€å‘è§„èŒƒ
- [1.æŠ€æœ¯é€‰å‹.md](../1.stack/1.æŠ€æœ¯é€‰å‹.md) - æŠ€æœ¯é€‰å‹
- [2.æ¶æ„è®¾è®¡.md](../1.stack/2.æ¶æ„è®¾è®¡.md) - æ¶æ„è®¾è®¡

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å¼€å‘ API æ—¶ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] API è·¯å¾„ä»¥ `/api/v1/` å¼€å¤´
- [ ] ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•ï¼ˆGET, POST, PUT, PATCH, DELETEï¼‰
- [ ] è¿”å›ç»Ÿä¸€çš„å“åº”æ ¼å¼
- [ ] ä½¿ç”¨æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
- [ ] åˆ†é¡µå‚æ•°ä½¿ç”¨ `page` å’Œ `page_size`
- [ ] æ’åºå‚æ•°ä½¿ç”¨ `sort` å’Œ `order`
- [ ] å¤šç»„ç»‡éš”ç¦»è‡ªåŠ¨å¤„ç†ï¼ˆä¸æ‰‹åŠ¨ä¼ é€’ `tenant_id`ï¼‰
- [ ] JWT Token è‡ªåŠ¨åŒ…å«ç»„ç»‡ä¿¡æ¯
- [ ] é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€
- [ ] API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆï¼ˆFastAPI OpenAPIï¼‰
- [ ] API Tags ä½¿ç”¨è‹±æ–‡ï¼ˆå¦‚ `Authentication`, `Users`, `Roles`ï¼‰
- [ ] API æè¿°ä½¿ç”¨ä¸­æ–‡ï¼ˆå‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰

---

**æœ€åæ›´æ–°**ï¼š2025-11-18

