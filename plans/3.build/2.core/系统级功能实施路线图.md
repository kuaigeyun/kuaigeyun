# 系统级功能实施路线图

## 🎯 快速参考

本文档提供系统级功能建设的快速参考，包含关键决策点和实施要点。

---

## 📋 功能模块优先级矩阵

| 模块 | 优先级 | 依赖 | 预计时间 | 关键库 |
|------|--------|------|----------|--------|
| **角色权限管理** | ⭐⭐⭐⭐⭐ | 无 | 1-2周 | 无 |
| **部门管理** | ⭐⭐⭐⭐⭐ | 角色权限 | 1周 | 无 |
| **职位管理** | ⭐⭐⭐⭐⭐ | 部门管理 | 1周 | 无 |
| **账户管理** | ⭐⭐⭐⭐⭐ | 角色、部门、职位 | 1-2周 | openpyxl |
| **菜单管理** | ⭐⭐⭐⭐⭐ | 权限管理 | 1周 | 无 | ⏸️ 暂缓，等待应用级建设 |
| **数据字典** | ⭐⭐⭐⭐ | 无 | 1周 | 无 |
| **参数设置** | ⭐⭐⭐⭐ | 无 | 1周 | redis-py |
| **文件管理** | ⭐⭐⭐⭐ | 无 | 1-2周 | kkFileView ⭐已选定, aiofiles |
| **消息管理** | ⭐⭐⭐ | 无 | 2-3周 | aiosmtplib, websockets |
| **定时任务** | ⭐⭐⭐ | 无 | 2-3周 | Inngest ⭐已选定 |
| **审批流程** | ⭐⭐⭐ | 用户、消息 | 3-4周 | Inngest ⭐已选定 |
| **操作日志** | ⭐⭐⭐ | 无 | 1周 | 无 |
| **登录日志** | ⭐⭐⭐ | 用户管理 | 1周 | 无 |

---

## 🚀 第一阶段：基础权限体系（必须优先完成）

### 建设顺序

```
1. 角色权限管理 (1-2周) ✅ 最佳实践已完成
   ↓
2. 部门管理 (1周) ✅ 最佳实践已完成
   ↓
3. 职位管理 (1周) ✅ 最佳实践已完成
   ↓
4. 账户管理 (1-2周) ✅ 最佳实践已完成
   ↓
5. 菜单管理 (1周) ⏸️ 暂缓，等待应用级建设时完善
```

### 关键决策点

#### 1. 角色权限模型设计

**推荐方案**：RBAC（基于角色的访问控制）

```
User (用户)
  ↓ 多对多
Role (角色)
  ↓ 多对多
Permission (权限)
```

**权限粒度**：
- **功能权限**：菜单访问、按钮操作
- **数据权限**：组织内数据、跨组织数据
- **字段权限**：字段可见性、字段编辑性

#### 2. 部门树形结构

**推荐方案**：使用 Tortoise ORM 自关联

```python
class Department(BaseModel):
    parent_id = fields.IntField(null=True)  # 父部门ID
    # 使用递归查询获取部门树
```

#### 3. 菜单权限控制

**推荐方案**：
- 菜单关联权限（外键）
- 前端根据用户权限动态渲染菜单
- 后端 API 权限验证

---

## 🔧 技术选型快速参考

### 必须使用的库（已确定）

| 功能 | 库 | 版本 | 说明 |
|------|-----|------|------|
| ORM | Tortoise ORM | 0.21.1 | 已使用 |
| Web框架 | FastAPI | 0.110.0 | 已使用 |
| 数据库 | PostgreSQL | 15+ | 已使用 |
| 缓存 | Redis | 7.2+ | 已使用 |
| 数据验证 | Pydantic | v2.7.0 | 已使用 |
| 密码加密 | passlib[bcrypt] | - | 已使用 |
| JWT | python-jose | - | 已使用 |

### 新增推荐库

| 功能 | 库 | 版本 | 优先级 | 说明 |
|------|-----|------|--------|------|
| 工作流编排 | Inngest | - | ⭐⭐⭐⭐⭐ | 已选定，替代 APScheduler |
| 文件操作 | aiofiles | - | ⭐⭐⭐ | 异步文件操作 |
| 文件预览 | kkFileView | - | ⭐⭐⭐⭐⭐ | 已选定，23+格式支持 |
| Excel处理 | openpyxl | - | ⭐⭐⭐ | Excel导入导出 |
| 邮件发送 | aiosmtplib | - | ⭐⭐ | 异步邮件（Inngest 工作流中调用） |
| WebSocket | websockets | - | ⭐⭐ | 实时消息（前端通知） |
| PDF生成 | reportlab | - | ⭐⭐ | 打印模板 |
| JS执行 | PyExecJS | - | ⭐ | 脚本管理 |

### 可选库（根据需求）

| 功能 | 库 | 说明 |
|------|-----|------|
| 数据分析 | pandas | 如果数据量大 |
| ~~消息队列 | celery~~ | ~~已由 Inngest 替代~~ |
| ~~定时任务 | APScheduler~~ | ~~已由 Inngest 替代~~ |
| 文件类型检测 | python-magic | 如果需要 |
| 图片处理 | Pillow | 如果需要 |
| 打印支持 | pycups | Linux打印 |

---

## 📐 数据库设计原则

### 1. 表命名规范

**必须包含模块前缀**：
- 系统级表：`root_` 前缀（如 `root_users`、`root_roles`）
- 或使用 `core_` 前缀（如 `core_users`、`core_roles`）

### 2. 必须字段

所有表必须包含：
```sql
id SERIAL PRIMARY KEY,
tenant_id INTEGER NOT NULL,  -- 组织隔离
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL,  -- 软删除（可选）
```

### 3. 索引规范

```sql
-- 组织隔离索引（必须）
INDEX idx_{table_name}_tenant_id (tenant_id);

-- 常用查询索引
INDEX idx_{table_name}_created_at (created_at);
```

---

## 🎨 前端组件复用

### 已可用组件

1. **UniTable** - 统一表格组件
   - 默认导入导出按钮
   - 默认视图切换
   - 自动生成导入配置

2. **UniImport** - 统一导入组件
   - 支持 Excel 导入
   - 自动字段映射
   - 数据验证

3. **QuerySearchButton** - 高级搜索
   - 条件保存
   - 条件钉住
   - 条件拖拽排序

### 需要新建的组件

1. **树形选择器** - 部门、菜单树形选择
2. **权限选择器** - 权限树形选择
3. **ProFlow 工作流设计器** - 审批流程可视化设计（配合 Inngest）
   - 使用 ProFlow 设计工作流
   - 转换为 Inngest 配置
   - 展示 Inngest 执行状态
4. **文件预览组件** - 集成 kkFileView 的文件预览组件
5. **打印模板设计器** - 打印模板可视化设计

---

## ⚠️ 关键注意事项

### 1. 多租户数据隔离

**必须遵循**：
- 所有查询自动过滤 `tenant_id`
- 所有创建自动设置 `tenant_id`
- 所有更新验证 `tenant_id` 权限
- 禁止跨组织数据访问

### 2. 权限验证

**必须遵循**：
- API 层验证权限
- 前端根据权限显示/隐藏功能
- 敏感操作记录操作日志

### 3. 性能优化

**建议**：
- 数据字典、参数设置使用 Redis 缓存
- 菜单树、部门树使用缓存
- 大数据量查询使用分页
- 前端使用虚拟滚动
- kkFileView 预览服务负载均衡和缓存
- Inngest 任务并发控制和优先级管理

### 4. 代码规范

**必须遵循**：
- 所有代码使用中文注释
- 遵循命名规范（snake_case/PascalCase）
- API Tags 使用英文，描述使用中文
- 所有表名包含模块前缀

---

## 📅 建议实施时间表

### 第一个月（基础权限体系）

**Week 1-2**：角色权限管理 ✅ 最佳实践已完成
- 角色模型、权限模型
- 角色权限关联
- 角色管理 API
- 权限管理 API
- 前端页面

**Week 3**：部门管理 ✅ 最佳实践已完成
- 部门模型（树形结构）
- 部门管理 API
- 前端页面

**Week 4**：职位管理 ✅ 最佳实践已完成
- 职位模型
- 职位管理 API
- 前端页面

### 第二个月（账户与菜单）

**Week 5-6**：账户管理 ✅ 最佳实践已完成
- 扩展用户模型
- 账户管理 API
- 账户导入导出
- 前端页面

**Week 7**：菜单管理 ⏸️ 暂缓，等待应用级建设
- 菜单模型（树形结构）
- 菜单管理 API
- 前端页面

### 第三个月（核心配置 - 基础）

**Week 8**：数据字典
**Week 9**：参数设置
**Week 10-11**：编码规则
**Week 12**：文件管理（集成 kkFileView）

### 后续阶段

根据业务需求灵活安排，建议优先完成：
1. **Inngest 集成**（为所有流程功能提供基础）
   - Inngest 服务部署
   - Inngest Python SDK 集成
   - 基础工作流示例
2. 消息管理（使用 Inngest 事件驱动）
3. 操作日志（为系统提供审计支持）
4. 定时任务（使用 Inngest 替代 APScheduler）

---

## 🔍 功能补充建议

### 1. 组织管理增强

- **组织设置**：Logo、主题色、域名等
- **组织成员统计**：成员数量、活跃度等
- **组织使用量**：存储、API 调用等

### 2. 安全功能

- **密码策略**：复杂度、过期、历史
- **登录安全**：失败锁定、IP 白名单
- **审计日志**：敏感操作审计

### 3. 通知中心

- **统一通知入口**
- **通知分类**：系统通知、业务通知等
- **通知设置**：免打扰、推送方式等

---

## 📚 相关文档

- [系统级功能建设计划.md](./系统级功能建设计划.md) - 详细建设计划
- [框架开发规范.md](../2.rules/README.md) - 开发规范
- [API设计规范.md](../2.rules/6.API设计规范.md) - API 设计规范
- [数据库命名规范.md](../2.rules/3.数据库命名规范.md) - 数据库规范

---

**最后更新**：2025-01-XX

