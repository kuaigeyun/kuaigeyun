# ç«™ç‚¹è®¾ç½®æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šç«™ç‚¹è®¾ç½®ï¼ˆSite Settings Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­â­ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š1-2 å‘¨  
**ä¾èµ–**ï¼šå‚æ•°è®¾ç½®ï¼ˆç«™ç‚¹è®¾ç½®æœ¬è´¨æ˜¯å‚æ•°ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- ç«™ç‚¹è®¾ç½®ç®¡ç†ï¼ˆè·å–ã€æ›´æ–°ï¼‰
- é‚€è¯·æ³¨å†ŒåŠŸèƒ½ï¼ˆé‚€è¯·ç ç”Ÿæˆã€éªŒè¯ï¼‰
- é‚€è¯·è®°å½•ç®¡ç†

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### ç«™ç‚¹è®¾ç½®å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **ä½¿ç”¨è‡ªå®šä¹‰å®ç°ï¼ˆæ¨èï¼‰**

ç»è¿‡è°ƒç ”ï¼Œç«™ç‚¹è®¾ç½®åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼Œä¸»è¦æ˜¯ JSON å­˜å‚¨å’Œé‚€è¯·ç ç”Ÿæˆï¼š

#### æ–¹æ¡ˆä¸€ï¼šè‡ªå®šä¹‰å®ç° â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… åŠŸèƒ½ç®€å•ï¼Œå®ç°æˆæœ¬ä½ï¼ˆ1-2 å‘¨å¯å®Œæˆï¼‰
- âœ… ä¸ Tortoise ORM å®Œç¾é›†æˆï¼ˆåŸç”Ÿæ”¯æŒï¼‰
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆtenant_id å­—æ®µï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰
- âœ… å®Œå…¨æ§åˆ¶ï¼Œæ˜“äºå®šåˆ¶å’Œæ‰©å±•
- âœ… é‚€è¯·ç ç”Ÿæˆé€»è¾‘ç®€å•ï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰ï¼Œæ— éœ€ç‰¹æ®Šåº“
- âœ… æ— éœ€å¼•å…¥é¢å¤–ä¾èµ–

**åŠ£åŠ¿**ï¼š
- âš ï¸ éœ€è¦è‡ªå·±å®ç°é‚€è¯·ç ç”Ÿæˆå’ŒéªŒè¯é€»è¾‘ï¼ˆä½†é€»è¾‘ç®€å•ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æ ‡å‡†çš„ç«™ç‚¹è®¾ç½®éœ€æ±‚
- âœ… éœ€è¦ä¸ç°æœ‰æ¡†æ¶æ·±åº¦é›†æˆ
- âœ… éœ€è¦å®Œå…¨ç¬¦åˆé¡¹ç›®è§„èŒƒ
- âœ… å¤šç§Ÿæˆ·æ˜¯æ ¸å¿ƒéœ€æ±‚

**å®ç°å¤æ‚åº¦**ï¼šâ­â­ï¼ˆç®€å•ï¼Œ1-2 å‘¨å¯å®Œæˆï¼‰

---

#### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ â­â­ï¼ˆä¸æ¨èï¼‰

**è°ƒç ”ç»“æœ**ï¼š
- âŒ Python ç”Ÿæ€ä¸­æ²¡æœ‰ä¸“é—¨çš„ç«™ç‚¹è®¾ç½®åº“
- âŒ æœ‰ `secrets` æ ‡å‡†åº“å¯ç”¨äºç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ˆé‚€è¯·ç ï¼‰ï¼Œä½†åŠŸèƒ½ç®€å•ï¼Œæ— éœ€é¢å¤–åº“
- âŒ å…¶ä»–é€šç”¨åº“åŠŸèƒ½è¿‡äºå¤æ‚ï¼Œä¸ç¬¦åˆç®€å•éœ€æ±‚

**ç»“è®º**ï¼šç«™ç‚¹è®¾ç½®åŠŸèƒ½ç®€å•ï¼Œé‚€è¯·ç ç”Ÿæˆä½¿ç”¨ Python æ ‡å‡†åº“ `secrets` å³å¯ï¼Œæ— éœ€ç¬¬ä¸‰æ–¹åº“ã€‚

---

### æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**æ¨è**ï¼šâœ… **ä½¿ç”¨è‡ªå®šä¹‰å®ç°**

**ç†ç”±**ï¼š
1. âœ… **åŠŸèƒ½ç®€å•**ï¼Œè‡ªå®šä¹‰å®ç°æˆæœ¬ä½ï¼ˆ1-2 å‘¨ï¼‰
2. âœ… **é‚€è¯·ç ç”Ÿæˆä½¿ç”¨æ ‡å‡†åº“** `secrets`ï¼Œæ— éœ€é¢å¤–ä¾èµ–
3. âœ… **å¤šç§Ÿæˆ·æ˜¯æ ¸å¿ƒéœ€æ±‚**ï¼Œè‡ªå®šä¹‰å®ç°å¤©ç„¶æ”¯æŒ
4. âœ… **å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒ**ï¼Œä»£ç é£æ ¼ç»Ÿä¸€
5. âœ… **ç»´æŠ¤æˆæœ¬ä½**ï¼Œå›¢é˜Ÿå®Œå…¨æŒæ§ä»£ç 

**æ‰€éœ€åº“**ï¼š
- **æ— éœ€é¢å¤–åº“**ï¼ˆä½¿ç”¨ Python æ ‡å‡†åº“ `secrets` ç”Ÿæˆé‚€è¯·ç ï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ç«™ç‚¹è®¾ç½®è¡¨ï¼ˆroot_site_settingsï¼‰

```sql
CREATE TABLE root_site_settings (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER NOT NULL UNIQUE,       -- ç»„ç»‡IDï¼ˆå”¯ä¸€ï¼Œæ¯ä¸ªç»„ç»‡åªæœ‰ä¸€ä¸ªè®¾ç½®ï¼‰
    
    -- ç«™ç‚¹åŸºæœ¬ä¿¡æ¯ï¼ˆJSONï¼‰
    settings JSONB NOT NULL DEFAULT '{}',    -- è®¾ç½®é¡¹ï¼ˆJSON å­—æ®µï¼‰
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_root_site_settings_tenant_id (tenant_id)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `tenant_id` å”¯ä¸€çº¦æŸï¼Œæ¯ä¸ªç»„ç»‡åªæœ‰ä¸€ä¸ªè®¾ç½®è®°å½•
- âœ… `settings` JSONB å­—æ®µå­˜å‚¨æ‰€æœ‰è®¾ç½®é¡¹ï¼ˆçµæ´»æ‰©å±•ï¼‰
- âœ… è®¾ç½®é¡¹åŒ…æ‹¬ï¼šç«™ç‚¹åç§°ã€Logoã€ä¸»é¢˜è‰²ã€é‚€è¯·æ³¨å†Œå¼€å…³ç­‰

### é‚€è¯·ç è¡¨ï¼ˆroot_invitation_codesï¼‰

```sql
CREATE TABLE root_invitation_codes (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- é‚€è¯·ç ä¿¡æ¯
    code VARCHAR(50) NOT NULL UNIQUE,       -- é‚€è¯·ç ï¼ˆå”¯ä¸€ï¼‰
    email VARCHAR(100),                      -- é‚€è¯·é‚®ç®±ï¼ˆå¯é€‰ï¼‰
    role_id INTEGER,                          -- é»˜è®¤è§’è‰²IDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰
    
    -- ä½¿ç”¨é™åˆ¶
    max_uses INTEGER DEFAULT 1,              -- æœ€å¤§ä½¿ç”¨æ¬¡æ•°
    used_count INTEGER DEFAULT 0,            -- å·²ä½¿ç”¨æ¬¡æ•°
    expires_at TIMESTAMP,                     -- è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,           -- æ˜¯å¦å¯ç”¨
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    INDEX idx_root_invitation_codes_tenant_id (tenant_id),
    INDEX idx_root_invitation_codes_uuid (uuid),
    INDEX idx_root_invitation_codes_code (code),
    INDEX idx_root_invitation_codes_created_at (created_at)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `code` å”¯ä¸€çº¦æŸï¼Œå…¨å±€å”¯ä¸€
- âœ… `max_uses` å’Œ `used_count` æ§åˆ¶ä½¿ç”¨æ¬¡æ•°
- âœ… `expires_at` æ”¯æŒè¿‡æœŸæ—¶é—´
- âœ… `role_id` å…³è”é»˜è®¤è§’è‰²

---

## ğŸ åç«¯æ¨¡å‹è®¾è®¡

### ç«™ç‚¹è®¾ç½®æ¨¡å‹ï¼ˆSiteSettingsï¼‰

```python
# riveredge-backend/src/tree-root/models/site_settings.py
from tortoise.models import Model
from tortoise import fields
from tortoise.fields import JSONField
from typing import Dict, Any


class SiteSettings(Model):
    """
    ç«™ç‚¹è®¾ç½®æ¨¡å‹
    
    ç”¨äºå­˜å‚¨ç»„ç»‡çš„ç«™ç‚¹é…ç½®ä¿¡æ¯ï¼Œæ¯ä¸ªç»„ç»‡åªæœ‰ä¸€ä¸ªè®¾ç½®è®°å½•ã€‚
    ä½¿ç”¨ JSONB å­—æ®µå­˜å‚¨è®¾ç½®é¡¹ï¼Œæ”¯æŒçµæ´»æ‰©å±•ã€‚
    """
    id = fields.IntField(pk=True, description="è®¾ç½®IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    
    tenant_id = fields.IntField(unique=True, description="ç»„ç»‡IDï¼ˆå”¯ä¸€ï¼‰")
    settings = JSONField(default={}, description="è®¾ç½®é¡¹ï¼ˆJSONï¼‰")
    
    created_at = fields.DatetimeField(auto_now_add=True, description="åˆ›å»ºæ—¶é—´")
    updated_at = fields.DatetimeField(auto_now=True, description="æ›´æ–°æ—¶é—´")
    
    class Meta:
        table = "root_site_settings"
    
    def get_setting(self, key: str, default: Any = None) -> Any:
        """è·å–è®¾ç½®é¡¹"""
        return self.settings.get(key, default)
    
    def set_setting(self, key: str, value: Any) -> None:
        """è®¾ç½®è®¾ç½®é¡¹"""
        if not self.settings:
            self.settings = {}
        self.settings[key] = value
    
    def update_settings(self, settings: Dict[str, Any]) -> None:
        """æ‰¹é‡æ›´æ–°è®¾ç½®é¡¹"""
        if not self.settings:
            self.settings = {}
        self.settings.update(settings)
```

### é‚€è¯·ç æ¨¡å‹ï¼ˆInvitationCodeï¼‰

```python
# riveredge-backend/src/tree-root/models/invitation_code.py
from tortoise.models import Model
from tortoise import fields
from datetime import datetime
from .base import BaseModel


class InvitationCode(BaseModel):
    """
    é‚€è¯·ç æ¨¡å‹
    
    ç”¨äºç”Ÿæˆå’Œç®¡ç†é‚€è¯·æ³¨å†Œç ï¼Œæ”¯æŒä½¿ç”¨æ¬¡æ•°é™åˆ¶å’Œè¿‡æœŸæ—¶é—´ã€‚
    æ”¯æŒå¤šç»„ç»‡éš”ç¦»ï¼Œæ¯ä¸ªç»„ç»‡å¯ä»¥ç”Ÿæˆè‡ªå·±çš„é‚€è¯·ç ã€‚
    
    æ³¨æ„ï¼šç»§æ‰¿è‡ª BaseModelï¼Œè‡ªåŠ¨åŒ…å« uuidã€tenant_idã€created_atã€updated_at å­—æ®µã€‚
    """
    id = fields.IntField(pk=True, description="é‚€è¯·ç IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    
    code = fields.CharField(max_length=50, unique=True, description="é‚€è¯·ç ï¼ˆå”¯ä¸€ï¼‰")
    email = fields.CharField(max_length=100, null=True, description="é‚€è¯·é‚®ç®±ï¼ˆå¯é€‰ï¼‰")
    role_id = fields.IntField(null=True, description="é»˜è®¤è§’è‰²IDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰")
    
    max_uses = fields.IntField(default=1, description="æœ€å¤§ä½¿ç”¨æ¬¡æ•°")
    used_count = fields.IntField(default=0, description="å·²ä½¿ç”¨æ¬¡æ•°")
    expires_at = fields.DatetimeField(null=True, description="è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰")
    
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦å¯ç”¨")
    
    class Meta:
        table = "root_invitation_codes"
    
    def is_valid(self) -> bool:
        """æ£€æŸ¥é‚€è¯·ç æ˜¯å¦æœ‰æ•ˆ"""
        if not self.is_active:
            return False
        if self.used_count >= self.max_uses:
            return False
        if self.expires_at and self.expires_at < datetime.now():
            return False
        return True
    
    def use(self) -> None:
        """ä½¿ç”¨é‚€è¯·ç ï¼ˆå¢åŠ ä½¿ç”¨æ¬¡æ•°ï¼‰"""
        if not self.is_valid():
            raise ValueError("é‚€è¯·ç æ— æ•ˆæˆ–å·²è¿‡æœŸ")
        self.used_count += 1
```

---

## ğŸ”§ Service å±‚è®¾è®¡

### ç«™ç‚¹è®¾ç½®æœåŠ¡ï¼ˆSiteSettingsServiceï¼‰

```python
# riveredge-backend/src/tree-root/services/site_settings_service.py
from typing import Dict, Any
from tortoise.exceptions import DoesNotExist

from ..models.site_settings import SiteSettings


class SiteSettingsService:
    """ç«™ç‚¹è®¾ç½®æœåŠ¡"""
    
    @staticmethod
    async def get_settings(tenant_id: int) -> SiteSettings:
        """è·å–ç«™ç‚¹è®¾ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰"""
        settings = await SiteSettings.get_or_none(tenant_id=tenant_id)
        if not settings:
            settings = await SiteSettings.create(
                tenant_id=tenant_id,
                settings={}
            )
        return settings
    
    @staticmethod
    async def update_settings(
        tenant_id: int,
        settings: Dict[str, Any]
    ) -> SiteSettings:
        """æ›´æ–°ç«™ç‚¹è®¾ç½®"""
        site_settings = await SiteSettingsService.get_settings(tenant_id)
        site_settings.update_settings(settings)
        await site_settings.save()
        return site_settings
```

### é‚€è¯·ç æœåŠ¡ï¼ˆInvitationCodeServiceï¼‰

```python
# riveredge-backend/src/tree-root/services/invitation_code_service.py
import secrets
import string
from typing import Optional
from datetime import datetime, timedelta
from uuid import UUID

from ..models.invitation_code import InvitationCode
from ..schemas.invitation_code import InvitationCodeCreate


class InvitationCodeService:
    """é‚€è¯·ç æœåŠ¡"""
    
    @staticmethod
    def _generate_code(length: int = 16) -> str:
        """ç”Ÿæˆéšæœºé‚€è¯·ç """
        alphabet = string.ascii_uppercase + string.digits
        return ''.join(secrets.choice(alphabet) for _ in range(length))
    
    @staticmethod
    async def create_invitation_code(
        tenant_id: int,
        data: InvitationCodeCreate
    ) -> InvitationCode:
        """åˆ›å»ºé‚€è¯·ç """
        # ç”Ÿæˆå”¯ä¸€é‚€è¯·ç 
        code = InvitationCodeService._generate_code()
        while await InvitationCode.exists(code=code):
            code = InvitationCodeService._generate_code()
        
        invitation_code = await InvitationCode.create(
            tenant_id=tenant_id,
            code=code,
            email=data.email,
            role_id=data.role_id,
            max_uses=data.max_uses,
            expires_at=data.expires_at,
            is_active=True
        )
        
        return invitation_code
    
    @staticmethod
    async def validate_invitation_code(code: str) -> InvitationCode:
        """éªŒè¯é‚€è¯·ç """
        invitation_code = await InvitationCode.get_or_none(
            code=code,
            deleted_at__isnull=True
        )
        
        if not invitation_code:
            raise ValueError("é‚€è¯·ç ä¸å­˜åœ¨")
        
        if not invitation_code.is_valid():
            raise ValueError("é‚€è¯·ç æ— æ•ˆæˆ–å·²è¿‡æœŸ")
        
        return invitation_code
    
    @staticmethod
    async def use_invitation_code(code: str) -> InvitationCode:
        """ä½¿ç”¨é‚€è¯·ç """
        invitation_code = await InvitationCodeService.validate_invitation_code(code)
        invitation_code.use()
        await invitation_code.save()
        return invitation_code
```

---

## ğŸŒ API è®¾è®¡

### ç«™ç‚¹è®¾ç½® API

```python
# riveredge-backend/src/tree-root/api/site_settings/site_settings.py
from fastapi import APIRouter, Depends, Body
from typing import Dict, Any

from ....soil.api.deps import get_current_tenant
from ...schemas.site_settings import SiteSettingsResponse, SiteSettingsUpdate
from ...services.site_settings_service import SiteSettingsService

router = APIRouter(prefix="/site-settings", tags=["ç«™ç‚¹è®¾ç½®"])


@router.get("", response_model=SiteSettingsResponse)
async def get_settings(
    tenant_id: int = Depends(get_current_tenant)
):
    """è·å–ç«™ç‚¹è®¾ç½®"""
    settings = await SiteSettingsService.get_settings(tenant_id)
    return settings


@router.put("", response_model=SiteSettingsResponse)
async def update_settings(
    data: SiteSettingsUpdate,
    tenant_id: int = Depends(get_current_tenant)
):
    """æ›´æ–°ç«™ç‚¹è®¾ç½®"""
    settings = await SiteSettingsService.update_settings(tenant_id, data.settings)
    return settings
```

### é‚€è¯·ç  API

```python
# riveredge-backend/src/tree-root/api/invitation_codes/invitation_codes.py
from fastapi import APIRouter, Depends, Query
from typing import Optional, List
from uuid import UUID

from ....soil.api.deps import get_current_tenant
from ...schemas.invitation_code import (
    InvitationCodeCreate,
    InvitationCodeResponse
)
from ...services.invitation_code_service import InvitationCodeService

router = APIRouter(prefix="/invitation-codes", tags=["é‚€è¯·ç "])


@router.post("", response_model=InvitationCodeResponse, status_code=201)
async def create_invitation_code(
    data: InvitationCodeCreate,
    tenant_id: int = Depends(get_current_tenant)
):
    """åˆ›å»ºé‚€è¯·ç """
    invitation_code = await InvitationCodeService.create_invitation_code(
        tenant_id, data
    )
    return invitation_code


@router.get("", response_model=List[InvitationCodeResponse])
async def list_invitation_codes(
    skip: int = Query(0, ge=0),
    limit: int = Query(100, ge=1, le=1000),
    tenant_id: int = Depends(get_current_tenant)
):
    """è·å–é‚€è¯·ç åˆ—è¡¨"""
    # å®ç°åˆ—è¡¨æŸ¥è¯¢é€»è¾‘
    pass


@router.post("/validate", response_model=Dict[str, bool])
async def validate_invitation_code(
    code: str = Body(...)
):
    """éªŒè¯é‚€è¯·ç """
    try:
        await InvitationCodeService.validate_invitation_code(code)
        return {"valid": True}
    except ValueError:
        return {"valid": False}
```

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

**å‚è€ƒ**ï¼šå¤ç”¨ç¬¬ä¸€é˜¶æ®µçš„é¡µé¢å¸ƒå±€è§„èŒƒ

**åŠŸèƒ½**ï¼š
- ç«™ç‚¹è®¾ç½®é¡µé¢ï¼ˆè¡¨å•ï¼ŒåŒ…å«ç«™ç‚¹åç§°ã€Logoä¸Šä¼ ã€ä¸»é¢˜è‰²ç­‰ï¼‰
- é‚€è¯·ç ç®¡ç†é¡µé¢ï¼ˆåˆ—è¡¨ã€åˆ›å»ºã€æŸ¥çœ‹ä½¿ç”¨è®°å½•ï¼‰
- é‚€è¯·ç ç”Ÿæˆï¼ˆModalï¼Œé…ç½®ä½¿ç”¨æ¬¡æ•°ã€è¿‡æœŸæ—¶é—´ç­‰ï¼‰

**é¡µé¢è·¯å¾„**ï¼š
- `riveredge-frontend/src/tree-stem/pages/system/site-settings/index.tsx`
- `riveredge-frontend/src/tree-stem/pages/system/invitation-codes/list/index.tsx`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md](../ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md)
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](../sysç¬¬ä¸€é˜¶æ®µ/å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

