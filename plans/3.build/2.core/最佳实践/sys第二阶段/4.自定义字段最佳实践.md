# è‡ªå®šä¹‰å­—æ®µæœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šè‡ªå®šä¹‰å­—æ®µï¼ˆCustom Field Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­â­ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š2-3 å‘¨  
**ä¾èµ–**ï¼šæ•°æ®å­—å…¸ï¼ˆå­—æ®µç±»å‹å¯èƒ½éœ€è¦å­—å…¸ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- è‡ªå®šä¹‰å­—æ®µç®¡ç†ï¼ˆCRUDï¼‰
- åŠ¨æ€å­—æ®µæ‰©å±•æœåŠ¡ï¼ˆè¿è¡Œæ—¶æ·»åŠ å­—æ®µï¼‰
- å­—æ®µç±»å‹æ”¯æŒï¼ˆtextã€numberã€dateã€selectç­‰ï¼‰
- å­—æ®µå…³è”è¡¨ç®¡ç†
- åŸºäº Formily çš„åŠ¨æ€è¡¨å•æ¸²æŸ“

---

## ğŸ” å‰ç«¯æŠ€æœ¯é€‰å‹

### Formily åŠ¨æ€è¡¨å•æ–¹æ¡ˆ â­â­â­â­â­ï¼ˆå·²é€‰å®šï¼‰

**Formily** æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¼ä¸šçº§è¡¨å•è§£å†³æ–¹æ¡ˆï¼Œéå¸¸é€‚åˆè‡ªå®šä¹‰å­—æ®µè¿™ç§éœ€è¦åŠ¨æ€ç”Ÿæˆè¡¨å•çš„åœºæ™¯ã€‚

#### ä¼˜åŠ¿
- âœ… **é˜¿é‡Œç³»ï¼Œä¸ Ant Design ç”Ÿæ€ä¸€è‡´**ï¼šå®Œç¾é›†æˆ Ant Design ç»„ä»¶
- âœ… **åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒå¤æ‚è¡¨å•åœºæ™¯**ï¼šæ”¯æŒå­—æ®µè”åŠ¨ã€æ¡ä»¶æ¸²æŸ“ã€éªŒè¯è§„åˆ™ç­‰
- âœ… **åŠ¨æ€æ¸²æŸ“**ï¼šåŸºäº JSON Schema åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼Œå®Œç¾é€‚é…è‡ªå®šä¹‰å­—æ®µ
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šæŒ‰éœ€æ¸²æŸ“ï¼Œæ€§èƒ½ä¼˜å¼‚
- âœ… **å®Œå–„çš„æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒ**

#### æ ¸å¿ƒç‰¹æ€§
1. **åŠ¨æ€æ¸²æŸ“** - åŸºäº JSON Schema åŠ¨æ€æ¸²æŸ“è¡¨å•
2. **å­—æ®µè”åŠ¨** - å¼ºå¤§çš„å­—æ®µè”åŠ¨æœºåˆ¶
3. **éªŒè¯è§„åˆ™** - çµæ´»çš„éªŒè¯è§„åˆ™é…ç½®
4. **è¡¨å•è®¾è®¡å™¨** - å¯è§†åŒ–è¡¨å•è®¾è®¡ï¼ˆå¯é€‰ï¼‰

#### å®‰è£…ä¾èµ–

```bash
# å®‰è£… Formily æ ¸å¿ƒåŒ…
npm install @formily/core @formily/react @formily/antd-v5

# å¦‚æœéœ€è¦è¡¨å•è®¾è®¡å™¨ï¼ˆå¯é€‰ï¼‰
npm install @formily/designable @formily/designable-antd-v5
```

#### æŠ€æœ¯è¦ç‚¹

1. **å°†è‡ªå®šä¹‰å­—æ®µé…ç½®è½¬æ¢ä¸º Formily Schema**
   - ä»åç«¯è·å–è‡ªå®šä¹‰å­—æ®µåˆ—è¡¨
   - å°†å­—æ®µé…ç½®è½¬æ¢ä¸º Formily çš„ JSON Schema æ ¼å¼
   - æ”¯æŒå­—æ®µç±»å‹æ˜ å°„ï¼ˆtext â†’ Inputã€number â†’ InputNumberã€date â†’ DatePicker ç­‰ï¼‰

2. **åŠ¨æ€è¡¨å•æ¸²æŸ“**
   - ä½¿ç”¨ Formily çš„ `FormProvider` å’Œ `SchemaField` ç»„ä»¶
   - æ ¹æ® Schema åŠ¨æ€æ¸²æŸ“è¡¨å•å­—æ®µ
   - æ”¯æŒå­—æ®µéªŒè¯ã€è”åŠ¨ç­‰é«˜çº§åŠŸèƒ½

3. **å­—æ®µå€¼ç®¡ç†**
   - è¡¨å•æäº¤æ—¶ï¼Œå°† Formily è¡¨å•å€¼è½¬æ¢ä¸ºè‡ªå®šä¹‰å­—æ®µå€¼æ ¼å¼
   - è¡¨å•åˆå§‹åŒ–æ—¶ï¼Œå°†è‡ªå®šä¹‰å­—æ®µå€¼è½¬æ¢ä¸º Formily è¡¨å•å€¼

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### è‡ªå®šä¹‰å­—æ®µè¡¨ï¼ˆroot_custom_fieldsï¼‰

```sql
CREATE TABLE root_custom_fields (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- å­—æ®µåŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,              -- å­—æ®µåç§°
    code VARCHAR(50) NOT NULL,               -- å­—æ®µä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰
    table_name VARCHAR(50) NOT NULL,         -- å…³è”è¡¨å
    field_type VARCHAR(20) NOT NULL,         -- å­—æ®µç±»å‹ï¼štextã€numberã€dateã€selectã€textareaç­‰
    
    -- å­—æ®µé…ç½®ï¼ˆJSONï¼‰
    config JSONB,                             -- å­—æ®µé…ç½®ï¼ˆé»˜è®¤å€¼ã€éªŒè¯è§„åˆ™ã€é€‰é¡¹ç­‰ï¼‰
    
    -- æ˜¾ç¤ºé…ç½®
    label VARCHAR(100),                       -- å­—æ®µæ ‡ç­¾ï¼ˆæ˜¾ç¤ºåç§°ï¼‰
    placeholder VARCHAR(200),                 -- å ä½ç¬¦
    is_required BOOLEAN DEFAULT FALSE,       -- æ˜¯å¦å¿…å¡«
    is_searchable BOOLEAN DEFAULT TRUE,       -- æ˜¯å¦å¯æœç´¢
    is_sortable BOOLEAN DEFAULT TRUE,        -- æ˜¯å¦å¯æ’åº
    
    -- æ’åºå’ŒçŠ¶æ€
    sort_order INTEGER DEFAULT 0,            -- æ’åºé¡ºåº
    is_active BOOLEAN DEFAULT TRUE,           -- æ˜¯å¦å¯ç”¨
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_custom_fields_tenant_table_code UNIQUE (tenant_id, table_name, code),
    INDEX idx_root_custom_fields_tenant_id (tenant_id),
    INDEX idx_root_custom_fields_uuid (uuid),
    INDEX idx_root_custom_fields_table_name (table_name),
    INDEX idx_root_custom_fields_created_at (created_at)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `table_name` æŒ‡å®šå­—æ®µå…³è”çš„è¡¨
- âœ… `field_type` æ”¯æŒå¤šç§å­—æ®µç±»å‹
- âœ… `config` JSONB å­—æ®µå­˜å‚¨å­—æ®µé…ç½®ï¼ˆçµæ´»æ‰©å±•ï¼‰
- âœ… `tenant_id + table_name + code` å”¯ä¸€çº¦æŸ

### è‡ªå®šä¹‰å­—æ®µå€¼è¡¨ï¼ˆroot_custom_field_valuesï¼‰

```sql
CREATE TABLE root_custom_field_values (
    id SERIAL PRIMARY KEY,
    custom_field_id INTEGER NOT NULL,         -- å…³è”è‡ªå®šä¹‰å­—æ®µIDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- å…³è”è®°å½•
    record_id INTEGER NOT NULL,               -- å…³è”è®°å½•IDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰
    record_table VARCHAR(50) NOT NULL,        -- å…³è”è¡¨å
    
    -- å­—æ®µå€¼
    value_text TEXT,                           -- æ–‡æœ¬å€¼
    value_number NUMERIC,                      -- æ•°å€¼
    value_date DATE,                           -- æ—¥æœŸå€¼
    value_json JSONB,                         -- JSONå€¼ï¼ˆç”¨äºå¤æ‚ç±»å‹ï¼‰
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    INDEX idx_root_custom_field_values_tenant_id (tenant_id),
    INDEX idx_root_custom_field_values_field_id (custom_field_id),
    INDEX idx_root_custom_field_values_record (record_table, record_id),
    INDEX idx_root_custom_field_values_created_at (created_at),
    
    -- å¤–é”®
    FOREIGN KEY (custom_field_id) REFERENCES root_custom_fields(id) ON DELETE CASCADE
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… ä½¿ç”¨å¤šåˆ—å­˜å‚¨ä¸åŒç±»å‹çš„å€¼ï¼ˆ`value_text`ã€`value_number`ã€`value_date`ã€`value_json`ï¼‰
- âœ… `record_table + record_id` å…³è”åˆ°å…·ä½“è®°å½•
- âœ… æ”¯æŒè½¯åˆ é™¤ï¼ˆé€šè¿‡ `custom_field_id` çš„ CASCADE åˆ é™¤ï¼‰

---

## ğŸ åç«¯æ¨¡å‹è®¾è®¡

### è‡ªå®šä¹‰å­—æ®µæ¨¡å‹ï¼ˆCustomFieldï¼‰

```python
# riveredge-backend/src/tree-root/models/custom_field.py
from tortoise.models import Model
from tortoise import fields
from tortoise.fields import JSONField
from .base import BaseModel
from typing import Dict, Any


class CustomField(BaseModel):
    """
    è‡ªå®šä¹‰å­—æ®µæ¨¡å‹
    
    ç”¨äºå®šä¹‰åŠ¨æ€å­—æ®µï¼Œæ”¯æŒä¸ºä¸åŒè¡¨æ·»åŠ è‡ªå®šä¹‰å­—æ®µã€‚
    æ”¯æŒå¤šç»„ç»‡éš”ç¦»ï¼Œæ¯ä¸ªç»„ç»‡å¯ä»¥å®šä¹‰è‡ªå·±çš„è‡ªå®šä¹‰å­—æ®µã€‚
    
    æ³¨æ„ï¼šç»§æ‰¿è‡ª BaseModelï¼Œè‡ªåŠ¨åŒ…å« uuidã€tenant_idã€created_atã€updated_at å­—æ®µã€‚
    """
    id = fields.IntField(pk=True, description="å­—æ®µIDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    
    name = fields.CharField(max_length=100, description="å­—æ®µåç§°")
    code = fields.CharField(max_length=50, description="å­—æ®µä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰")
    table_name = fields.CharField(max_length=50, description="å…³è”è¡¨å")
    field_type = fields.CharField(max_length=20, description="å­—æ®µç±»å‹")
    
    config = JSONField(null=True, description="å­—æ®µé…ç½®ï¼ˆJSONï¼‰")
    
    label = fields.CharField(max_length=100, null=True, description="å­—æ®µæ ‡ç­¾")
    placeholder = fields.CharField(max_length=200, null=True, description="å ä½ç¬¦")
    is_required = fields.BooleanField(default=False, description="æ˜¯å¦å¿…å¡«")
    is_searchable = fields.BooleanField(default=True, description="æ˜¯å¦å¯æœç´¢")
    is_sortable = fields.BooleanField(default=True, description="æ˜¯å¦å¯æ’åº")
    
    sort_order = fields.IntField(default=0, description="æ’åºé¡ºåº")
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦å¯ç”¨")
    
    class Meta:
        table = "root_custom_fields"
        unique_together = [("tenant_id", "table_name", "code")]
    
    def get_config(self) -> Dict[str, Any]:
        """è·å–å­—æ®µé…ç½®"""
        return self.config or {}
    
    def set_config(self, config: Dict[str, Any]) -> None:
        """è®¾ç½®å­—æ®µé…ç½®"""
        self.config = config
```

### è‡ªå®šä¹‰å­—æ®µå€¼æ¨¡å‹ï¼ˆCustomFieldValueï¼‰

```python
# riveredge-backend/src/tree-root/models/custom_field_value.py
from tortoise.models import Model
from tortoise import fields
from tortoise.fields import JSONField
from typing import Optional, Any
from datetime import date
from decimal import Decimal


class CustomFieldValue(Model):
    """
    è‡ªå®šä¹‰å­—æ®µå€¼æ¨¡å‹
    
    ç”¨äºå­˜å‚¨è‡ªå®šä¹‰å­—æ®µçš„å€¼ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹ã€‚
    """
    id = fields.IntField(pk=True, description="å€¼IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    
    custom_field_id = fields.IntField(description="å…³è”è‡ªå®šä¹‰å­—æ®µIDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰")
    tenant_id = fields.IntField(description="ç»„ç»‡ID")
    
    record_id = fields.IntField(description="å…³è”è®°å½•IDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰")
    record_table = fields.CharField(max_length=50, description="å…³è”è¡¨å")
    
    value_text = fields.TextField(null=True, description="æ–‡æœ¬å€¼")
    value_number = fields.DecimalField(max_digits=20, decimal_places=4, null=True, description="æ•°å€¼")
    value_date = fields.DateField(null=True, description="æ—¥æœŸå€¼")
    value_json = JSONField(null=True, description="JSONå€¼")
    
    created_at = fields.DatetimeField(auto_now_add=True, description="åˆ›å»ºæ—¶é—´")
    updated_at = fields.DatetimeField(auto_now=True, description="æ›´æ–°æ—¶é—´")
    
    class Meta:
        table = "root_custom_field_values"
        indexes = [
            ("record_table", "record_id"),
        ]
    
    def get_value(self) -> Any:
        """æ ¹æ®å­—æ®µç±»å‹è·å–å€¼"""
        if self.value_text is not None:
            return self.value_text
        elif self.value_number is not None:
            return float(self.value_number)
        elif self.value_date is not None:
            return self.value_date
        elif self.value_json is not None:
            return self.value_json
        return None
    
    def set_value(self, value: Any, field_type: str) -> None:
        """æ ¹æ®å­—æ®µç±»å‹è®¾ç½®å€¼"""
        if field_type in ("text", "textarea", "select"):
            self.value_text = str(value) if value is not None else None
            self.value_number = None
            self.value_date = None
            self.value_json = None
        elif field_type == "number":
            self.value_text = None
            self.value_number = Decimal(str(value)) if value is not None else None
            self.value_date = None
            self.value_json = None
        elif field_type == "date":
            self.value_text = None
            self.value_number = None
            self.value_date = value if isinstance(value, date) else None
            self.value_json = None
        elif field_type == "json":
            self.value_text = None
            self.value_number = None
            self.value_date = None
            self.value_json = value
```

---

## ğŸ”§ Service å±‚è®¾è®¡

### è‡ªå®šä¹‰å­—æ®µæœåŠ¡ï¼ˆCustomFieldServiceï¼‰

```python
# riveredge-backend/src/tree-root/services/custom_field_service.py
from typing import Optional, List, Dict, Any
from uuid import UUID
from tortoise.exceptions import IntegrityError
from fastapi import HTTPException, status

from ..models.custom_field import CustomField
from ..models.custom_field_value import CustomFieldValue
from ..schemas.custom_field import CustomFieldCreate, CustomFieldUpdate


class CustomFieldService:
    """è‡ªå®šä¹‰å­—æ®µæœåŠ¡"""
    
    @staticmethod
    async def create_field(
        tenant_id: int,
        data: CustomFieldCreate
    ) -> CustomField:
        """åˆ›å»ºè‡ªå®šä¹‰å­—æ®µ"""
        try:
            field = await CustomField.create(
                tenant_id=tenant_id,
                **data.model_dump()
            )
            return field
        except IntegrityError:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"å­—æ®µä»£ç  {data.code} å·²å­˜åœ¨"
            )
    
    @staticmethod
    async def get_fields_by_table(
        tenant_id: int,
        table_name: str,
        is_active: Optional[bool] = None
    ) -> List[CustomField]:
        """è·å–æŒ‡å®šè¡¨çš„æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µ"""
        query = CustomField.filter(
            tenant_id=tenant_id,
            table_name=table_name,
            deleted_at__isnull=True
        )
        if is_active is not None:
            query = query.filter(is_active=is_active)
        
        return await query.order_by("sort_order", "id")
    
    @staticmethod
    async def set_field_value(
        tenant_id: int,
        field_uuid: UUID,
        record_table: str,
        record_id: int,
        value: Any
    ) -> CustomFieldValue:
        """è®¾ç½®å­—æ®µå€¼"""
        field = await CustomField.get_or_none(
            tenant_id=tenant_id,
            uuid=field_uuid,
            deleted_at__isnull=True
        )
        if not field:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="è‡ªå®šä¹‰å­—æ®µä¸å­˜åœ¨"
            )
        
        # è·å–æˆ–åˆ›å»ºå­—æ®µå€¼
        field_value = await CustomFieldValue.get_or_none(
            custom_field_id=field.id,
            tenant_id=tenant_id,
            record_table=record_table,
            record_id=record_id
        )
        
        if not field_value:
            field_value = CustomFieldValue(
                custom_field_id=field.id,
                tenant_id=tenant_id,
                record_table=record_table,
                record_id=record_id
            )
        
        field_value.set_value(value, field.field_type)
        await field_value.save()
        
        return field_value
    
    @staticmethod
    async def get_field_values(
        tenant_id: int,
        record_table: str,
        record_id: int
    ) -> Dict[str, Any]:
        """è·å–è®°å½•çš„æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µå€¼"""
        fields = await CustomFieldService.get_fields_by_table(
            tenant_id, record_table, is_active=True
        )
        
        field_ids = [f.id for f in fields]
        values = await CustomFieldValue.filter(
            custom_field_id__in=field_ids,
            tenant_id=tenant_id,
            record_table=record_table,
            record_id=record_id
        )
        
        result = {}
        for field in fields:
            value_obj = next((v for v in values if v.custom_field_id == field.id), None)
            result[field.code] = value_obj.get_value() if value_obj else None
        
        return result
```

---

## ğŸŒ API è®¾è®¡

### è‡ªå®šä¹‰å­—æ®µ API

```python
# riveredge-backend/src/tree-root/api/custom_fields/custom_fields.py
from fastapi import APIRouter, Depends, Query, Body
from typing import Optional, List, Dict, Any
from uuid import UUID

from ....soil.api.deps import get_current_tenant
from ...schemas.custom_field import (
    CustomFieldCreate,
    CustomFieldUpdate,
    CustomFieldResponse
)
from ...services.custom_field_service import CustomFieldService

router = APIRouter(prefix="/custom-fields", tags=["è‡ªå®šä¹‰å­—æ®µ"])


@router.post("", response_model=CustomFieldResponse, status_code=201)
async def create_field(
    data: CustomFieldCreate,
    tenant_id: int = Depends(get_current_tenant)
):
    """åˆ›å»ºè‡ªå®šä¹‰å­—æ®µ"""
    field = await CustomFieldService.create_field(tenant_id, data)
    return field


@router.get("/table/{table_name}", response_model=List[CustomFieldResponse])
async def get_fields_by_table(
    table_name: str,
    is_active: Optional[bool] = Query(None),
    tenant_id: int = Depends(get_current_tenant)
):
    """è·å–æŒ‡å®šè¡¨çš„æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µ"""
    fields = await CustomFieldService.get_fields_by_table(
        tenant_id, table_name, is_active
    )
    return fields


@router.post("/{field_uuid}/values", response_model=Dict[str, Any])
async def set_field_value(
    field_uuid: UUID,
    record_table: str = Body(...),
    record_id: int = Body(...),
    value: Any = Body(...),
    tenant_id: int = Depends(get_current_tenant)
):
    """è®¾ç½®å­—æ®µå€¼"""
    field_value = await CustomFieldService.set_field_value(
        tenant_id, field_uuid, record_table, record_id, value
    )
    return {"success": True}


@router.get("/values/{record_table}/{record_id}", response_model=Dict[str, Any])
async def get_field_values(
    record_table: str,
    record_id: int,
    tenant_id: int = Depends(get_current_tenant)
):
    """è·å–è®°å½•çš„æ‰€æœ‰è‡ªå®šä¹‰å­—æ®µå€¼"""
    values = await CustomFieldService.get_field_values(
        tenant_id, record_table, record_id
    )
    return values
```

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

**å‚è€ƒ**ï¼šå¤ç”¨ç¬¬ä¸€é˜¶æ®µçš„é¡µé¢å¸ƒå±€è§„èŒƒ

**åŠŸèƒ½**ï¼š
- è‡ªå®šä¹‰å­—æ®µåˆ—è¡¨ï¼ˆæŒ‰è¡¨åˆ†ç»„å±•ç¤ºï¼‰
- åˆ›å»ºå­—æ®µï¼ˆModalï¼Œå­—æ®µç±»å‹é€‰æ‹©å™¨ï¼‰
- ç¼–è¾‘å­—æ®µï¼ˆModalï¼‰
- å­—æ®µé…ç½®ï¼ˆæ ¹æ®ç±»å‹åŠ¨æ€é…ç½®ï¼‰
- å­—æ®µå€¼ç®¡ç†ï¼ˆåœ¨å…³è”è¡¨çš„è¯¦æƒ…é¡µä¸­æ˜¾ç¤ºï¼Œä½¿ç”¨ Formily åŠ¨æ€è¡¨å•ï¼‰

**é¡µé¢è·¯å¾„**ï¼š
- å­—æ®µç®¡ç†ï¼š`riveredge-frontend/src/tree-stem/pages/system/custom-fields/list/index.tsx`
- åŠ¨æ€è¡¨å•ç»„ä»¶ï¼š`riveredge-frontend/src/tree-stem/components/custom-fields/DynamicFormField.tsx`

---

## ğŸ”§ Formily é›†æˆå®ç°

### 1. è‡ªå®šä¹‰å­—æ®µè½¬ Formily Schema

```typescript
// riveredge-frontend/src/tree-stem/utils/customFieldToFormily.ts
import { ISchema } from '@formily/core';
import { CustomField } from '@/services/customField';

/**
 * å°†è‡ªå®šä¹‰å­—æ®µé…ç½®è½¬æ¢ä¸º Formily Schema
 */
export function customFieldsToFormilySchema(
  fields: CustomField[]
): ISchema {
  const properties: Record<string, any> = {};
  
  fields.forEach((field) => {
    const fieldSchema: any = {
      type: getFormilyFieldType(field.field_type),
      title: field.label || field.name,
      description: field.description,
      'x-decorator': 'FormItem',
      'x-component': getFormilyComponent(field.field_type),
      'x-component-props': {
        placeholder: field.placeholder,
      },
    };
    
    // å¿…å¡«éªŒè¯
    if (field.is_required) {
      fieldSchema.required = true;
    }
    
    // å­—æ®µç±»å‹ç‰¹å®šé…ç½®
    if (field.field_type === 'select') {
      const config = field.config || {};
      fieldSchema.enum = config.options || [];
      fieldSchema['x-component-props'].options = config.options || [];
    }
    
    // éªŒè¯è§„åˆ™
    if (field.config?.rules) {
      fieldSchema['x-validator'] = field.config.rules;
    }
    
    properties[field.code] = fieldSchema;
  });
  
  return {
    type: 'object',
    properties,
  };
}

/**
 * è·å– Formily å­—æ®µç±»å‹
 */
function getFormilyFieldType(fieldType: string): string {
  const typeMap: Record<string, string> = {
    text: 'string',
    textarea: 'string',
    number: 'number',
    date: 'string',
    datetime: 'string',
    select: 'string',
    json: 'object',
  };
  return typeMap[fieldType] || 'string';
}

/**
 * è·å– Formily ç»„ä»¶åç§°
 */
function getFormilyComponent(fieldType: string): string {
  const componentMap: Record<string, string> = {
    text: 'Input',
    textarea: 'Input.TextArea',
    number: 'InputNumber',
    date: 'DatePicker',
    datetime: 'DatePicker',
    select: 'Select',
    json: 'Input.TextArea',
  };
  return componentMap[fieldType] || 'Input';
}
```

### 2. åŠ¨æ€è¡¨å•ç»„ä»¶

```typescript
// riveredge-frontend/src/tree-stem/components/custom-fields/DynamicFormField.tsx
import React, { useEffect, useMemo } from 'react';
import { createForm, FormProvider, SchemaField } from '@formily/react';
import { createSchemaField } from '@formily/react';
import {
  FormItem,
  Input,
  InputNumber,
  DatePicker,
  Select,
} from '@formily/antd-v5';
import { customFieldsToFormilySchema } from '@/utils/customFieldToFormily';
import { getCustomFieldsByTable, getCustomFieldValues, setCustomFieldValues } from '@/services/customField';

interface DynamicFormFieldProps {
  tableName: string;
  recordId?: number;
  onValuesChange?: (values: Record<string, any>) => void;
}

const SchemaFieldComponent = createSchemaField({
  components: {
    FormItem,
    Input,
    InputNumber,
    DatePicker,
    Select,
  },
});

export const DynamicFormField: React.FC<DynamicFormFieldProps> = ({
  tableName,
  recordId,
  onValuesChange,
}) => {
  const [fields, setFields] = React.useState<any[]>([]);
  const [loading, setLoading] = React.useState(false);
  
  const form = useMemo(() => createForm(), []);
  
  // è·å–è‡ªå®šä¹‰å­—æ®µåˆ—è¡¨
  useEffect(() => {
    const loadFields = async () => {
      setLoading(true);
      try {
        const data = await getCustomFieldsByTable(tableName, { is_active: true });
        setFields(data);
        
        // è½¬æ¢ä¸º Formily Schema
        const schema = customFieldsToFormilySchema(data);
        form.setSchema(schema);
        
        // å¦‚æœæœ‰ recordIdï¼ŒåŠ è½½å­—æ®µå€¼
        if (recordId) {
          const values = await getCustomFieldValues(tableName, recordId);
          form.setValues(values);
        }
      } catch (error) {
        console.error('åŠ è½½è‡ªå®šä¹‰å­—æ®µå¤±è´¥:', error);
      } finally {
        setLoading(false);
      }
    };
    
    loadFields();
  }, [tableName, recordId, form]);
  
  // ç›‘å¬è¡¨å•å€¼å˜åŒ–
  useEffect(() => {
    const dispose = form.onValuesChange((values) => {
      onValuesChange?.(values);
    });
    return dispose;
  }, [form, onValuesChange]);
  
  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }
  
  if (fields.length === 0) {
    return null;
  }
  
  return (
    <FormProvider form={form}>
      <SchemaFieldComponent schema={form.getSchema()} />
    </FormProvider>
  );
};
```

### 3. åœ¨è¯¦æƒ…é¡µä¸­ä½¿ç”¨åŠ¨æ€è¡¨å•

```typescript
// ç¤ºä¾‹ï¼šåœ¨ç”¨æˆ·è¯¦æƒ…é¡µä¸­ä½¿ç”¨è‡ªå®šä¹‰å­—æ®µ
import { DynamicFormField } from '@/components/custom-fields/DynamicFormField';

const UserDetailPage: React.FC = () => {
  const [userId, setUserId] = React.useState<number>();
  
  const handleCustomFieldChange = async (values: Record<string, any>) => {
    if (!userId) return;
    
    // ä¿å­˜è‡ªå®šä¹‰å­—æ®µå€¼
    await setCustomFieldValues('users', userId, values);
  };
  
  return (
    <div>
      {/* å…¶ä»–ç”¨æˆ·ä¿¡æ¯ */}
      
      {/* è‡ªå®šä¹‰å­—æ®µåŠ¨æ€è¡¨å• */}
      <Card title="è‡ªå®šä¹‰å­—æ®µ" style={{ marginTop: 16 }}>
        <DynamicFormField
          tableName="users"
          recordId={userId}
          onValuesChange={handleCustomFieldChange}
        />
      </Card>
    </div>
  );
};
```

### 4. å­—æ®µé…ç½® API æ‰©å±•

éœ€è¦åœ¨åç«¯ API ä¸­è¿”å›å­—æ®µçš„å®Œæ•´é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- å­—æ®µç±»å‹
- éªŒè¯è§„åˆ™
- é€‰é¡¹åˆ—è¡¨ï¼ˆselect ç±»å‹ï¼‰
- é»˜è®¤å€¼
- å…¶ä»–é…ç½®é¡¹

---

## ğŸ“¦ æ‰€éœ€ä¾èµ–

### å‰ç«¯ä¾èµ–

```json
{
  "dependencies": {
    "@formily/core": "^2.x",
    "@formily/react": "^2.x",
    "@formily/antd-v5": "^2.x"
  }
}
```

### å®‰è£…å‘½ä»¤

```bash
npm install @formily/core @formily/react @formily/antd-v5
```

---

## ğŸ¯ å®ç°è¦ç‚¹

1. **Schema è½¬æ¢**
   - å°†è‡ªå®šä¹‰å­—æ®µé…ç½®è½¬æ¢ä¸º Formily JSON Schema
   - æ”¯æŒå­—æ®µç±»å‹æ˜ å°„å’Œç»„ä»¶æ˜ å°„
   - æ”¯æŒéªŒè¯è§„åˆ™è½¬æ¢

2. **è¡¨å•æ¸²æŸ“**
   - ä½¿ç”¨ Formily çš„ `SchemaField` åŠ¨æ€æ¸²æŸ“è¡¨å•
   - æ”¯æŒå­—æ®µè”åŠ¨å’Œæ¡ä»¶æ¸²æŸ“
   - æ”¯æŒè‡ªå®šä¹‰éªŒè¯è§„åˆ™

3. **æ•°æ®åŒæ­¥**
   - è¡¨å•å€¼å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜åˆ°åç«¯
   - æ”¯æŒæ‰¹é‡ä¿å­˜å’Œå•ä¸ªå­—æ®µä¿å­˜
   - æ”¯æŒè¡¨å•åˆå§‹å€¼åŠ è½½

4. **æ€§èƒ½ä¼˜åŒ–**
   - æŒ‰éœ€åŠ è½½è‡ªå®šä¹‰å­—æ®µé…ç½®
   - è¡¨å•å€¼å˜åŒ–é˜²æŠ–å¤„ç†
   - ä½¿ç”¨ Formily çš„æŒ‰éœ€æ¸²æŸ“æœºåˆ¶

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md](../ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md)
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](../sysç¬¬ä¸€é˜¶æ®µ/å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

