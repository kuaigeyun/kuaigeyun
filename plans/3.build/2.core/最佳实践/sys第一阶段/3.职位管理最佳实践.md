# 职位管理最佳实践

## 📋 模块概述

**模块名称**：职位管理（Position Management）  
**优先级**：⭐⭐⭐⭐⭐（最高优先级）  
**预计时间**：1 周  
**依赖**：部门管理（职位通常属于部门）

**功能范围**：
- 职位模型（Position）
- 职位管理 API（CRUD）
- 职位列表查询（支持按部门筛选）

---

## 🔍 库选择评估

### 实现方案

**职位管理相对简单**，无需额外库：
- ✅ 使用 Tortoise ORM 标准模型
- ✅ 使用外键关联部门
- ✅ 无需树形结构（职位是扁平结构）
- ✅ 无需复杂查询（标准 CRUD）

**实现复杂度**：⭐（简单）

---

## 🗄️ 数据库设计

### 职位表（root_positions）

```sql
CREATE TABLE root_positions (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 职位基本信息
    name VARCHAR(100) NOT NULL,              -- 职位名称
    code VARCHAR(50),                        -- 职位代码（可选，用于程序识别）
    description TEXT,                        -- 职位描述
    
    -- 关联部门
    department_id INTEGER,                    -- 所属部门ID（外键，关联 root_departments，内部使用自增ID）
    
    -- 排序和状态
    sort_order INTEGER DEFAULT 0,            -- 排序顺序
    is_active BOOLEAN DEFAULT TRUE,          -- 是否启用
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    INDEX idx_root_positions_tenant_id (tenant_id),
    INDEX idx_root_positions_uuid (uuid),
    INDEX idx_root_positions_department_id (department_id),
    INDEX idx_root_positions_code (code),
    INDEX idx_root_positions_sort_order (sort_order),
    INDEX idx_root_positions_created_at (created_at),
    
    -- 外键
    FOREIGN KEY (department_id) REFERENCES root_departments(id) ON DELETE SET NULL
);
```

**设计要点**：
- ✅ **混合ID方案**：`id`（自增ID，内部使用，性能优先）+ `uuid`（UUID，对外暴露，安全且唯一）
- ✅ `uuid` 字段用于对外API，避免暴露自增ID（安全性）
- ✅ `id` 字段用于内部关联和查询（性能）
- ✅ `department_id` 关联部门（可选，内部使用自增ID）
- ✅ `code` 可选，用于程序识别
- ✅ `sort_order` 用于排序
- ✅ 软删除支持（`deleted_at`）
- ✅ `ON DELETE SET NULL`：删除部门时，职位的 `department_id` 设为 `NULL`

---

## 🐍 后端模型设计

### 职位模型（Position）

```python
# riveredge-backend/src/tree-root/models/position.py
from tortoise.models import Model
from tortoise import fields
from .base import BaseModel


class Position(BaseModel):
    """
    职位模型
    
    用于定义组织中的职位，每个职位可以关联到一个部门。
    支持多组织隔离，每个组织可以定义自己的职位。
    
    注意：继承自 BaseModel，自动包含 uuid、tenant_id、created_at、updated_at 字段。
    """
    id = fields.IntField(pk=True, description="职位ID（主键，自增ID，内部使用）")
    # uuid 字段由 BaseModel 提供，无需重复定义
    # tenant_id 字段由 BaseModel 提供，无需重复定义
    
    name = fields.CharField(max_length=100, description="职位名称")
    code = fields.CharField(max_length=50, null=True, description="职位代码（可选，用于程序识别）")
    description = fields.TextField(null=True, description="职位描述")
    
    # 关联部门
    department = fields.ForeignKeyField(
        "models.Department",
        related_name="positions",
        null=True,
        description="所属部门（外键，关联 Department，可选）"
    )
    
    # 排序和状态
    sort_order = fields.IntField(default=0, description="排序顺序")
    is_active = fields.BooleanField(default=True, description="是否启用")
    
    class Meta:
        table = "root_positions"
        indexes = [
            ("tenant_id",),
            ("department_id",),
            ("code",),
            ("sort_order",),
            ("created_at",),
        ]
    
    def __str__(self):
        return f"{self.name} ({self.code or 'N/A'})"
```

**设计要点**：
- ✅ 使用 `ForeignKeyField` 关联部门
- ✅ `related_name="positions"` 用于反向查询部门的职位列表
- ✅ `null=True` 表示职位可以不关联部门（可选）

---

## 📡 API 设计

### 职位管理 API

**路由前缀**：`/api/v1/positions`  
**Tags**：`Positions`（英文）

#### 1.1 创建职位

```python
POST /api/v1/positions

Request Body:
{
    "name": "高级工程师",
    "code": "senior-engineer",
    "description": "高级工程师职位",
    "department_uuid": "550e8400-e29b-41d4-a716-446655440000",  // 可选，所属部门UUID
    "sort_order": 0,                        // 可选，排序顺序
    "is_active": true
}

Response 201:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440001",  // UUID（对外暴露）
    "tenant_id": 1,
    "name": "高级工程师",
    "code": "senior-engineer",
    "description": "高级工程师职位",
    "department_id": 1,
    "department": {                         // 部门信息（如果关联）
        "id": 1,
        "uuid": "550e8400-e29b-41d4-a716-446655440000",
        "name": "技术部"
    },
    "sort_order": 0,
    "is_active": true,
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**实现要点**：
- ✅ 自动设置 `tenant_id`（从当前用户上下文获取）
- ✅ **请求体使用 `department_uuid`**（需要在Service层转换为ID）
- ✅ 验证 `department_uuid` 属于当前组织（如果提供）
- ✅ 需要组织管理员或超级用户权限
- ✅ `department_uuid` 可选，职位可以不关联部门

#### 1.2 获取职位列表

```python
GET /api/v1/positions?page=1&page_size=20&keyword=工程师&department_uuid=550e8400-e29b-41d4-a716-446655440000&is_active=true

Response 200:
{
    "items": [
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440001",
            "name": "高级工程师",
            "code": "senior-engineer",
            "description": "高级工程师职位",
            "department_id": 1,
            "department": {
                "id": 1,
                "uuid": "550e8400-e29b-41d4-a716-446655440000",
                "name": "技术部"
            },
            "sort_order": 0,
            "is_active": true,
            "user_count": 5                  // 职位用户数量
        }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
}
```

**实现要点**：
- ✅ 自动过滤组织（只返回当前组织的职位）
- ✅ 支持分页（`page`, `page_size`）
- ✅ 支持关键词搜索（`keyword`：搜索职位名称、代码、描述）
- ✅ 支持筛选（`department_uuid`, `is_active`，`department_uuid` 需要在Service层转换为ID）
- ✅ 返回用户数量（用于前端显示）

#### 1.3 获取职位详情

```python
GET /api/v1/positions/{position_uuid}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440001",
    "name": "高级工程师",
    "code": "senior-engineer",
    "description": "高级工程师职位",
    "department_id": 1,
    "department": {
        "id": 1,
        "uuid": "550e8400-e29b-41d4-a716-446655440000",
        "name": "技术部",
        "code": "tech"
    },
    "sort_order": 0,
    "is_active": true,
    "user_count": 5,
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**实现要点**：
- ✅ **使用 UUID 作为路径参数**（`{position_uuid}`），而不是 `{position_id}`
- ✅ 自动验证组织权限
- ✅ 返回职位完整信息（包括关联的部门信息）

#### 1.4 更新职位

```python
PUT /api/v1/positions/{position_uuid}

Request Body:
{
    "name": "高级工程师（更新）",
    "description": "更新后的描述",
    "department_uuid": "550e8400-e29b-41d4-a716-446655440001",  // 可以修改所属部门
    "sort_order": 1,
    "is_active": true
}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440001",
    "name": "高级工程师（更新）",
    "description": "更新后的描述",
    ...
}
```

**实现要点**：
- ✅ **使用 UUID 作为路径参数**（`{position_uuid}`），而不是 `{position_id}`
- ✅ **请求体使用 `department_uuid`**（需要在Service层转换为ID）
- ✅ 自动验证组织权限
- ✅ 验证 `department_uuid` 属于当前组织（如果提供）
- ✅ 支持部分更新（Pydantic 的 `exclude_unset=True`）

#### 1.5 删除职位

```python
DELETE /api/v1/positions/{position_uuid}

Response 204: No Content
```

**实现要点**：
- ✅ **使用 UUID 作为路径参数**（`{position_uuid}`），而不是 `{position_id}`
- ✅ 自动验证组织权限
- ✅ 检查是否有用户（如果有，返回错误提示）
- ✅ 软删除（设置 `deleted_at`）

---

## 🔧 Service 层设计

### 职位服务（PositionService）

```python
# riveredge-backend/src/tree-root/services/position_service.py
from typing import List, Optional, Dict, Any
from tortoise.exceptions import IntegrityError
from models.position import Position
from models.department import Department
from models.user import User
from schemas.position import PositionCreate, PositionUpdate
from core.exceptions import NotFoundError, ValidationError, PermissionDeniedError


class PositionService:
    """
    职位服务类
    
    提供职位的 CRUD 操作。
    """
    
    @staticmethod
    async def create_position(
        tenant_id: int,
        data: PositionCreate,
        current_user_id: int
    ) -> Position:
        """
        创建职位
        
        Args:
            tenant_id: 组织ID
            data: 职位创建数据
            current_user_id: 当前用户ID
            
        Returns:
            Position: 创建的职位对象
            
        Raises:
            ValidationError: 当部门不存在或不属于当前组织时抛出
            PermissionDeniedError: 当用户无权限时抛出
        """
        # 验证权限
        # TODO: 实现权限验证逻辑
        
        # 验证部门（如果提供）
        department_id = None
        if data.department_uuid:
            department = await Department.filter(
                uuid=data.department_uuid,
                tenant_id=tenant_id,
                deleted_at__isnull=True
            ).first()
            
            if not department:
                raise ValidationError("部门不存在或不属于当前组织")
            
            department_id = department.id
        
        # 创建职位
        position = await Position.create(
            tenant_id=tenant_id,
            name=data.name,
            code=data.code,
            description=data.description,
            department_id=department_id,
            sort_order=data.sort_order if data.sort_order is not None else 0,
            is_active=data.is_active if data.is_active is not None else True,
        )
        
        return position
    
    @staticmethod
    async def get_position_list(
        tenant_id: int,
        page: int = 1,
        page_size: int = 20,
        keyword: Optional[str] = None,
        department_uuid: Optional[str] = None,
        is_active: Optional[bool] = None,
    ) -> dict:
        """
        获取职位列表
        
        Args:
            tenant_id: 组织ID
            page: 页码
            page_size: 每页数量
            keyword: 关键词搜索
            department_uuid: 部门UUID筛选
            is_active: 是否启用筛选
            
        Returns:
            dict: 包含职位列表和分页信息
        """
        # 构建查询
        query = Position.filter(tenant_id=tenant_id, deleted_at__isnull=True)
        
        # 关键词搜索
        if keyword:
            query = query.filter(
                Q(name__icontains=keyword) |
                Q(code__icontains=keyword) |
                Q(description__icontains=keyword)
            )
        
        # 部门筛选
        if department_uuid:
            department = await Department.filter(
                uuid=department_uuid,
                tenant_id=tenant_id,
                deleted_at__isnull=True
            ).first()
            
            if department:
                query = query.filter(department_id=department.id)
            else:
                # 部门不存在，返回空列表
                return {
                    "items": [],
                    "total": 0,
                    "page": page,
                    "page_size": page_size,
                }
        
        # 筛选
        if is_active is not None:
            query = query.filter(is_active=is_active)
        
        # 分页
        total = await query.count()
        positions = await query.order_by("sort_order", "id").offset((page - 1) * page_size).limit(page_size).all()
        
        # 获取用户数量
        result = []
        for position in positions:
            user_count = await User.filter(
                tenant_id=tenant_id,
                position_id=position.id  # 假设 User 模型有 position_id 字段
            ).count()
            
            # 预加载部门信息
            await position.fetch_related("department")
            
            result.append({
                **position.__dict__,
                "user_count": user_count,
            })
        
        return {
            "items": result,
            "total": total,
            "page": page,
            "page_size": page_size,
        }
    
    @staticmethod
    async def update_position(
        tenant_id: int,
        position_uuid: str,
        data: PositionUpdate,
        current_user_id: int
    ) -> Position:
        """
        更新职位
        
        Args:
            tenant_id: 组织ID
            position_uuid: 职位UUID
            data: 职位更新数据
            current_user_id: 当前用户ID
            
        Returns:
            Position: 更新后的职位对象
            
        Raises:
            NotFoundError: 当职位不存在时抛出
            ValidationError: 当部门不存在或不属于当前组织时抛出
        """
        # 验证权限
        # TODO: 实现权限验证逻辑
        
        # 获取职位
        position = await Position.filter(
            uuid=position_uuid,
            tenant_id=tenant_id,
            deleted_at__isnull=True
        ).first()
        
        if not position:
            raise NotFoundError("职位不存在")
        
        # 验证部门（如果提供）
        if data.department_uuid is not None:
            if data.department_uuid:
                department = await Department.filter(
                    uuid=data.department_uuid,
                    tenant_id=tenant_id,
                    deleted_at__isnull=True
                ).first()
                
                if not department:
                    raise ValidationError("部门不存在或不属于当前组织")
                
                position.department_id = department.id
            else:
                # department_uuid 为 null，表示取消关联部门
                position.department_id = None
        
        # 更新其他字段
        update_data = data.dict(exclude_unset=True, exclude={"department_uuid"})
        for key, value in update_data.items():
            setattr(position, key, value)
        
        await position.save()
        
        return position
    
    @staticmethod
    async def delete_position(
        tenant_id: int,
        position_uuid: str,
        current_user_id: int
    ) -> None:
        """
        删除职位
        
        Args:
            tenant_id: 组织ID
            position_uuid: 职位UUID
            current_user_id: 当前用户ID
            
        Raises:
            NotFoundError: 当职位不存在时抛出
            ValidationError: 当职位有用户时抛出
        """
        # 验证权限
        # TODO: 实现权限验证逻辑
        
        # 获取职位
        position = await Position.filter(
            uuid=position_uuid,
            tenant_id=tenant_id,
            deleted_at__isnull=True
        ).first()
        
        if not position:
            raise NotFoundError("职位不存在")
        
        # 检查是否有用户
        user_count = await User.filter(
            tenant_id=tenant_id,
            position_id=position.id
        ).count()
        
        if user_count > 0:
            raise ValidationError(f"职位下有 {user_count} 个用户，无法删除")
        
        # 软删除
        from datetime import datetime
        position.deleted_at = datetime.now()
        await position.save()
```

---

## 🎨 前端页面设计

### 职位管理页面

**路径**：`/system/positions`  
**组件**：`PositionManagementPage`

**功能**：
- ✅ 职位列表（使用 `UniTable`）
- ✅ 创建职位（Modal 表单，支持选择部门）
- ✅ 编辑职位（Modal 表单）
- ✅ 删除职位（Popconfirm 确认）
- ✅ 按部门筛选

**列定义**：
```typescript
const columns: ProColumns<Position>[] = [
  {
    title: '职位名称',
    dataIndex: 'name',
    width: 150,
    render: (_, record) => (
      <Space>
        <span>{record.name}</span>
        {record.code && <Tag>{record.code}</Tag>}
      </Space>
    ),
  },
  {
    title: '所属部门',
    dataIndex: 'department_id',
    width: 150,
    hideInSearch: true,
    render: (_, record) => record.department?.name || '-',
  },
  {
    title: '描述',
    dataIndex: 'description',
    ellipsis: true,
    hideInSearch: true,
  },
  {
    title: '用户数',
    dataIndex: 'user_count',
    width: 100,
    hideInSearch: true,
  },
  {
    title: '状态',
    dataIndex: 'is_active',
    width: 100,
    valueType: 'switch',
    render: (_, record) => (
      <Tag color={record.is_active ? 'green' : 'default'}>
        {record.is_active ? '启用' : '禁用'}
      </Tag>
    ),
  },
  {
    title: '操作',
    valueType: 'option',
    width: 200,
    render: (_, record) => [
      <Button key="edit" onClick={() => handleEdit(record)}>编辑</Button>,
      <Popconfirm
        key="delete"
        title="确定删除此职位吗？"
        onConfirm={() => handleDelete(record.uuid)}
      >
        <Button danger>删除</Button>
      </Popconfirm>,
    ],
  },
];
```

**筛选器**：
```typescript
// 部门筛选（使用部门树选择器）
{
  title: '所属部门',
  dataIndex: 'department_uuid',
  valueType: 'treeSelect',
  hideInTable: true,
  request: async () => {
    const response = await getDepartmentTree();
    return convertToTreeSelectData(response.items);
  },
}
```

---

## ✅ 实现检查清单

### 数据库设计
- [ ] 创建 `root_positions` 表
- [ ] 创建所有必要的索引
- [ ] 创建外键约束（部门关联）

### 后端实现
- [ ] 创建 `Position` 模型
- [ ] 创建 `PositionService` 服务类
- [ ] 创建职位管理 API（CRUD）
- [ ] 实现组织隔离（所有查询自动过滤 `tenant_id`）
- [ ] 实现 UUID 和 ID 转换逻辑

### 前端实现
- [ ] 创建职位管理页面
- [ ] 创建职位表单组件（创建/编辑）
- [ ] 集成 `UniTable` 组件
- [ ] 实现部门筛选（使用部门树选择器）
- [ ] 实现权限验证（前端根据权限显示/隐藏功能）

### 测试
- [ ] 单元测试（Service 层）
- [ ] API 测试（集成测试）
- [ ] 前端组件测试
- [ ] 多组织隔离测试

---

## ⚠️ 关键注意事项

### 1. 混合ID方案使用规范

**系统使用自增ID+UUID混合方案**：
- ✅ **`id`（自增ID）**：内部使用，用于数据库关联和查询（性能优先）
- ✅ **`uuid`（UUID）**：对外暴露，用于API路径参数和响应（安全性优先）

**API设计规范**：
- ✅ 路径参数使用 `{position_uuid}`，而不是 `{position_id}`
- ✅ 请求体中的关联字段使用 `department_uuid`（需要在Service层转换为ID）
- ✅ 响应中包含 `uuid` 字段（对外暴露），`id` 字段保留（内部使用）

**Service层转换**：
```python
# 示例：将 UUID 转换为 ID
if department_uuid:
    department = await Department.get(uuid=department_uuid, tenant_id=tenant_id)
    department_id = department.id  # 用于数据库关联
```

### 2. 组织隔离
- ✅ 所有查询必须自动过滤 `tenant_id`
- ✅ 所有创建必须自动设置 `tenant_id`
- ✅ 所有更新必须验证 `tenant_id` 权限
- ✅ 禁止跨组织数据访问

### 3. 删除保护
- ✅ 删除职位前，检查是否有用户
- ✅ 如果有用户，返回明确的错误提示
- ✅ 软删除（设置 `deleted_at`）

### 4. 部门关联
- ✅ 职位可以不关联部门（`department_id` 可为 `NULL`）
- ✅ 删除部门时，职位的 `department_id` 设为 `NULL`（`ON DELETE SET NULL`）
- ✅ 更新职位时，可以修改或取消部门关联

### 5. 性能优化
- ✅ 使用 `prefetch_related` 预加载部门信息
- ✅ 使用 `fetch_related` 按需加载关联数据
- ✅ 职位列表查询时，批量获取用户数量

### 6. 代码规范
- ✅ 所有代码使用中文注释
- ✅ API Tags 使用英文（`Positions`）
- ✅ API 描述使用中文（函数文档字符串）
- ✅ 遵循命名规范（snake_case/PascalCase）

---

## 📚 相关文档

- [系统级功能建设计划.md](../系统级功能建设计划.md)
- [系统级功能实施路线图.md](../系统级功能实施路线图.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md) - ⭐ 文件结构规划
- [前端页面布局规范.md](./前端页面布局规范.md) - ⭐ 前端页面开发规范
- [1.角色权限管理最佳实践.md](./1.角色权限管理最佳实践.md) - 依赖：需要权限控制
- [2.部门管理最佳实践.md](./2.部门管理最佳实践.md) - 依赖：职位关联部门
- [4.账户管理最佳实践.md](./4.账户管理最佳实践.md) - 关联：用户关联职位
- [API设计规范.md](../../2.rules/6.API设计规范.md)
- [数据库命名规范.md](../../2.rules/3.数据库命名规范.md)

---

**最后更新**：2025-01-XX

