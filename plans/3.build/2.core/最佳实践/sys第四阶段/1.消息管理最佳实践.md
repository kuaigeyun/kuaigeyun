# 消息管理最佳实践

## 📋 模块概述

**模块名称**：消息管理（Message Management）  
**优先级**：⭐⭐⭐（中优先级）  
**预计时间**：2-3 周  
**依赖**：无（独立功能）

**功能范围**：
- 消息配置管理（邮件、短信、站内信、推送通知配置）
- 消息模板管理（消息模板 CRUD）
- 消息推送服务（基于 Inngest 事件驱动）
- 消息发送记录（发送历史、状态跟踪）

**核心特点**：
- ✅ **基于 Inngest 事件驱动**：消息推送通过 Inngest 事件触发
- ✅ **工作流编排**：邮件、短信、站内信、推送通知都通过 Inngest 工作流处理
- ✅ **异步处理**：所有消息发送都是异步的，通过 Inngest 执行

---

## 🔍 库选择评估

### 消息管理实现方案

**结论**：✅ **使用自定义实现 + Inngest 事件驱动（推荐）**

#### 方案一：自定义实现 + Inngest ⭐⭐⭐⭐⭐（强烈推荐）

**优势**：
- ✅ 功能完整，支持多种消息类型
- ✅ Inngest 事件驱动，消息发送异步处理
- ✅ Inngest 工作流编排，支持复杂消息发送流程
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）
- ✅ 支持消息发送重试和错误处理

**劣势**：
- ⚠️ 需要自己实现消息发送逻辑
- ⚠️ 需要集成 Inngest

**适用场景**：
- ✅ 需要多种消息类型支持
- ✅ 需要异步消息发送
- ✅ 需要消息发送工作流编排
- ✅ 需要多租户消息隔离

**实现复杂度**：⭐⭐⭐（中等，2-3 周可完成）

---

### 最终推荐方案

**推荐**：✅ **使用自定义实现 + Inngest 事件驱动**

**理由**：
1. ✅ **Inngest 事件驱动**，消息发送异步处理
2. ✅ **Inngest 工作流编排**，支持复杂消息发送流程
3. ✅ **多租户是核心需求**，自定义实现天然支持
4. ✅ **完全符合框架规范**，代码风格统一
5. ✅ **维护成本低**，团队完全掌控代码

---

## 🗄️ 数据库设计

### 1. 消息配置表（root_message_configs）

```sql
CREATE TABLE root_message_configs (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 消息配置基本信息
    name VARCHAR(100) NOT NULL,              -- 配置名称
    code VARCHAR(50) NOT NULL,                -- 配置代码（唯一，用于程序识别）
    type VARCHAR(20) NOT NULL,               -- 消息类型（email、sms、internal、push）
    description TEXT,                         -- 配置描述
    
    -- 配置信息（JSON格式，根据类型不同而不同）
    config JSONB NOT NULL,                    -- 配置信息（JSON格式）
    
    -- 配置状态
    is_active BOOLEAN DEFAULT TRUE,          -- 是否启用
    is_default BOOLEAN DEFAULT FALSE,         -- 是否默认配置
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    CONSTRAINT uk_root_message_configs_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_message_configs_tenant_id (tenant_id),
    INDEX idx_root_message_configs_uuid (uuid),
    INDEX idx_root_message_configs_code (code),
    INDEX idx_root_message_configs_type (type),
    INDEX idx_root_message_configs_created_at (created_at)
);
```

**设计要点**：
- ✅ **混合ID方案**：`id`（自增ID，内部使用）+ `uuid`（UUID，对外暴露）
- ✅ `type` 字段标识消息类型（email、sms、internal、push）
- ✅ `config` 字段使用 JSONB 存储配置信息（根据类型不同而不同）
- ✅ `tenant_id + code` 唯一约束，确保组织内配置代码唯一
- ✅ 软删除支持（`deleted_at`）

**配置示例**：

**邮件配置**：
```json
{
  "smtp_host": "smtp.example.com",
  "smtp_port": 587,
  "smtp_username": "user@example.com",
  "smtp_password": "password",
  "smtp_use_tls": true,
  "from_email": "noreply@example.com",
  "from_name": "RiverEdge"
}
```

**短信配置**：
```json
{
  "provider": "aliyun",
  "access_key_id": "your_access_key_id",
  "access_key_secret": "your_access_key_secret",
  "sign_name": "RiverEdge",
  "region": "cn-hangzhou"
}
```

### 2. 消息模板表（root_message_templates）

```sql
CREATE TABLE root_message_templates (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 模板基本信息
    name VARCHAR(100) NOT NULL,              -- 模板名称
    code VARCHAR(50) NOT NULL,                -- 模板代码（唯一，用于程序识别）
    type VARCHAR(20) NOT NULL,               -- 消息类型（email、sms、internal、push）
    description TEXT,                         -- 模板描述
    
    -- 模板内容
    subject VARCHAR(200),                     -- 主题（邮件、推送通知）
    content TEXT NOT NULL,                   -- 模板内容（支持变量）
    variables JSONB,                          -- 模板变量定义（JSON格式）
    
    -- 模板状态
    is_active BOOLEAN DEFAULT TRUE,          -- 是否启用
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    CONSTRAINT uk_root_message_templates_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_message_templates_tenant_id (tenant_id),
    INDEX idx_root_message_templates_uuid (uuid),
    INDEX idx_root_message_templates_code (code),
    INDEX idx_root_message_templates_type (type),
    INDEX idx_root_message_templates_created_at (created_at)
);
```

### 3. 消息发送记录表（root_message_logs）

```sql
CREATE TABLE root_message_logs (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 消息基本信息
    template_uuid VARCHAR(36),               -- 关联模板UUID
    config_uuid VARCHAR(36),                -- 关联配置UUID
    type VARCHAR(20) NOT NULL,               -- 消息类型
    recipient VARCHAR(200) NOT NULL,         -- 接收者（邮箱、手机号、用户ID等）
    
    -- 消息内容
    subject VARCHAR(200),                    -- 主题
    content TEXT NOT NULL,                   -- 消息内容
    variables JSONB,                         -- 模板变量值（JSON格式）
    
    -- 发送状态
    status VARCHAR(20) NOT NULL,             -- 发送状态（pending、sending、success、failed）
    inngest_run_id VARCHAR(100),             -- Inngest 运行ID（关联 Inngest 工作流实例）
    error_message TEXT,                       -- 错误信息
    sent_at TIMESTAMP NULL,                  -- 发送时间
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    INDEX idx_root_message_logs_tenant_id (tenant_id),
    INDEX idx_root_message_logs_uuid (uuid),
    INDEX idx_root_message_logs_template_uuid (template_uuid),
    INDEX idx_root_message_logs_config_uuid (config_uuid),
    INDEX idx_root_message_logs_type (type),
    INDEX idx_root_message_logs_status (status),
    INDEX idx_root_message_logs_inngest_run_id (inngest_run_id),
    INDEX idx_root_message_logs_created_at (created_at)
);
```

---

## 🐍 后端模型设计

### 1. 消息配置模型（MessageConfig）

```python
# riveredge-backend/src/tree_root/models/message_config.py
from tortoise.models import Model
from tortoise import fields
from typing import Optional, Dict, Any
from .base import BaseModel


class MessageConfig(BaseModel):
    """
    消息配置模型
    
    用于定义组织内的消息发送配置（邮件、短信、站内信、推送通知等）。
    支持多组织隔离，每个组织的配置相互独立。
    
    注意：继承自 BaseModel，自动包含 uuid、tenant_id、created_at、updated_at 字段。
    """
    id = fields.IntField(pk=True, description="配置ID（主键，自增ID，内部使用）")
    # uuid 字段由 BaseModel 提供
    # tenant_id 字段由 BaseModel 提供
    
    name = fields.CharField(max_length=100, description="配置名称")
    code = fields.CharField(max_length=50, description="配置代码（唯一，用于程序识别）")
    type = fields.CharField(max_length=20, description="消息类型（email、sms、internal、push）")
    description = fields.TextField(null=True, description="配置描述")
    
    config = fields.JSONField(description="配置信息（JSON格式）")
    
    is_active = fields.BooleanField(default=True, description="是否启用")
    is_default = fields.BooleanField(default=False, description="是否默认配置")
    
    class Meta:
        table = "root_message_configs"
        indexes = [
            ("tenant_id", "code"),  # 唯一索引
            ("type",),
        ]
        unique_together = [("tenant_id", "code")]
    
    def __str__(self):
        return f"{self.name} ({self.type})"
```

---

## 🔧 Inngest 集成

### 1. 消息发送工作流

**文件位置**：`riveredge-backend/src/tree_root/inngest/functions/message_sender.py`

```python
from inngest import Inngest, Event
from typing import Dict, Any
import aiosmtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

inngest = Inngest(app_id="riveredge")

@inngest.create_function(
    id="message-sender",
    name="消息发送器",
    trigger=inngest.TriggerEvent(event="message/send"),
    retries=3,
    retry_delay=inngest.RetryDelay(seconds=60)
)
async def message_sender(event: Event) -> Dict[str, Any]:
    """
    消息发送器
    
    监听 message/send 事件，根据消息类型发送消息。
    """
    tenant_id = event.data.get("tenant_id")
    message_type = event.data.get("message_type")
    recipient = event.data.get("recipient")
    subject = event.data.get("subject")
    content = event.data.get("content")
    config_uuid = event.data.get("config_uuid")
    
    try:
        if message_type == "email":
            # 发送邮件
            result = await send_email(tenant_id, config_uuid, recipient, subject, content)
        elif message_type == "sms":
            # 发送短信
            result = await send_sms(tenant_id, config_uuid, recipient, content)
        elif message_type == "internal":
            # 发送站内信
            result = await send_internal_message(tenant_id, recipient, subject, content)
        elif message_type == "push":
            # 发送推送通知
            result = await send_push_notification(tenant_id, recipient, subject, content)
        else:
            result = {"success": False, "error": "Unknown message type"}
        
        return {
            "success": result.get("success", False),
            "message_id": result.get("message_id"),
            "error": result.get("error")
        }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }
```

### 2. 发送消息事件

**文件位置**：`riveredge-backend/src/tree_root/services/message_service.py`

```python
from inngest import Event
from ..inngest.client import inngest_client

async def send_message(
    tenant_id: int,
    message_type: str,
    recipient: str,
    subject: str,
    content: str,
    config_uuid: str = None
) -> Dict[str, Any]:
    """
    发送消息
    
    通过 Inngest 事件触发消息发送。
    """
    # 发送 Inngest 事件
    await inngest_client.send_event(
        event=Event(
            name="message/send",
            data={
                "tenant_id": tenant_id,
                "message_type": message_type,
                "recipient": recipient,
                "subject": subject,
                "content": content,
                "config_uuid": config_uuid
            }
        )
    )
    
    return {"success": True}
```

---

## 🌐 API 设计

### 消息管理 API

**路由前缀**：`/api/tree-root/messages`

**接口列表**：
1. `POST /configs` - 创建消息配置
2. `GET /configs/list` - 获取消息配置列表
3. `GET /configs/{uuid}` - 获取消息配置详情
4. `PUT /configs/{uuid}` - 更新消息配置
5. `DELETE /configs/{uuid}` - 删除消息配置
6. `POST /templates` - 创建消息模板
7. `GET /templates/list` - 获取消息模板列表
8. `GET /templates/{uuid}` - 获取消息模板详情
9. `PUT /templates/{uuid}` - 更新消息模板
10. `DELETE /templates/{uuid}` - 删除消息模板
11. `POST /send` - 发送消息（触发 Inngest 事件）
12. `GET /logs/list` - 获取消息发送记录列表

---

## 🎨 前端页面设计

### 消息管理页面

**页面路径**：`pages/system/messages/config/index.tsx`

**核心功能**：
1. 消息配置列表展示（UniTable，支持表格视图）
2. 消息配置创建/编辑（Modal + ProForm，根据类型动态渲染配置表单）
3. 消息模板管理（列表、创建、编辑、删除）
4. 消息发送（发送消息、查看发送记录）
5. 消息搜索和筛选（按名称、类型）

**布局规范**：
- ✅ 使用 `UniTable` 组件展示列表
- ✅ 使用高级搜索（`showAdvancedSearch={true}`）
- ✅ 使用 `searchFormValues` 获取搜索条件
- ✅ 创建/编辑使用 Modal + ProForm

---

## ⚠️ 重要注意事项

### 1. 吸取第一、第二、第三阶段经验教训

**必须遵守的规范**：
1. ✅ **禁止假设和猜测**：必须直接查看实际代码，使用完全相同的值
2. ✅ **禁止擅作主张**：只做用户明确要求的事，不做额外"优化"
3. ✅ **数据库迁移规范**：必须使用 Aerich 迁移系统，禁止直接使用 SQL
4. ✅ **前端搜索规范**：必须使用高级搜索（`showAdvancedSearch={true}`），使用 `searchFormValues` 获取搜索条件
5. ✅ **UniTable 规范**：`request` 函数必须接收四个参数：`(params, sort, _filter, searchFormValues)`

### 2. Inngest 集成注意事项

**事件驱动**：
- 所有消息发送都通过 Inngest 事件触发
- 事件数据必须包含 `tenant_id`，确保多租户隔离
- 消息发送是异步的，通过 Inngest 工作流执行

**工作流编排**：
- 复杂消息发送流程可以通过 Inngest 工作流编排
- 支持消息发送重试和错误处理
- 消息发送状态通过 Inngest 运行ID跟踪

**错误处理**：
- 消息发送失败时，Inngest 会自动重试
- 错误信息记录到消息发送记录表
- 支持错误通知（可选）

---

## 📚 相关文档

- [Inngest 集成指南.md](./Inngest集成指南.md)
- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)

---

**最后更新**：2025-01-XX

