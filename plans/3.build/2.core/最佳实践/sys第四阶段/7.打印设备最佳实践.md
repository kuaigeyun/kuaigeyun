# 打印设备最佳实践

## 📋 模块概述

**模块名称**：打印设备（Print Device Management）  
**优先级**：⭐⭐（低优先级）  
**预计时间**：1-2 周  
**依赖**：打印模板（打印需要模板）

**功能范围**：
- 打印设备定义（设备名称、类型、配置）
- 打印设备管理（CRUD、测试连接）
- 打印任务执行（可选集成 Inngest 异步执行）

**核心特点**：
- ✅ **可选集成 Inngest**：打印任务可以通过 Inngest 异步执行（可选）
- ✅ **支持多种设备类型**：网络打印机、本地打印机等

---

## 🔍 库选择评估

### 打印设备实现方案

**结论**：✅ **使用自定义实现 + pycups（可选）+ Inngest（可选）**

#### 方案一：自定义实现 + pycups + Inngest ⭐⭐⭐（推荐）

**优势**：
- ✅ 功能完整，支持打印设备管理
- ✅ pycups 支持 Linux 打印（可选）
- ✅ 可选集成 Inngest，支持异步打印任务
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）

**实现复杂度**：⭐⭐（简单，1-2 周可完成）

---

## 🗄️ 数据库设计

### 打印设备表（root_print_devices）

```sql
CREATE TABLE root_print_devices (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 设备基本信息
    name VARCHAR(100) NOT NULL,              -- 设备名称
    code VARCHAR(50) NOT NULL,                -- 设备代码（唯一，用于程序识别）
    description TEXT,                         -- 设备描述
    type VARCHAR(20) NOT NULL,               -- 设备类型（network、local等）
    
    -- 设备配置（JSON格式，根据类型不同而不同）
    config JSONB NOT NULL,                   -- 设备配置（JSON格式）
    
    -- 设备状态
    is_active BOOLEAN DEFAULT TRUE,          -- 是否启用
    is_connected BOOLEAN DEFAULT FALSE,      -- 是否已连接
    last_connected_at TIMESTAMP NULL,         -- 最后连接时间
    last_error TEXT,                          -- 最后错误信息
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    CONSTRAINT uk_root_print_devices_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_print_devices_tenant_id (tenant_id),
    INDEX idx_root_print_devices_uuid (uuid),
    INDEX idx_root_print_devices_code (code),
    INDEX idx_root_print_devices_type (type),
    INDEX idx_root_print_devices_created_at (created_at)
);
```

**配置示例**：

**网络打印机**：
```json
{
  "host": "192.168.1.100",
  "port": 9100,
  "protocol": "raw",
  "printer_name": "HP LaserJet"
}
```

**本地打印机**：
```json
{
  "printer_name": "HP LaserJet",
  "driver": "hp-laserjet"
}
```

---

## 🔧 打印设备连接测试

### 1. 网络打印机测试

**文件位置**：`riveredge-backend/src/tree_root/services/print_device_service.py`

```python
import socket

async def test_network_printer(config: Dict[str, Any]) -> Dict[str, Any]:
    """
    测试网络打印机连接
    
    Args:
        config: 打印机配置
        
    Returns:
        测试结果
    """
    try:
        host = config["host"]
        port = config.get("port", 9100)
        
        # 尝试连接
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        result = sock.connect_ex((host, port))
        sock.close()
        
        if result == 0:
            return {"success": True, "message": "连接成功"}
        else:
            return {"success": False, "error": "连接失败"}
    except Exception as e:
        return {"success": False, "error": str(e)}
```

### 2. Linux 打印机测试（使用 pycups）

```python
try:
    import cups
    
    async def test_cups_printer(config: Dict[str, Any]) -> Dict[str, Any]:
        """
        测试 CUPS 打印机连接
        
        Args:
            config: 打印机配置
            
        Returns:
            测试结果
        """
        try:
            conn = cups.Connection()
            printer_name = config["printer_name"]
            
            # 检查打印机是否存在
            printers = conn.getPrinters()
            if printer_name in printers:
                return {"success": True, "message": "打印机连接成功"}
            else:
                return {"success": False, "error": "打印机不存在"}
        except Exception as e:
            return {"success": False, "error": str(e)}
except ImportError:
    # pycups 未安装，跳过
    pass
```

---

## 🌐 API 设计

### 打印设备管理 API

**路由前缀**：`/api/tree-root/print-devices`

**接口列表**：
1. `POST /` - 创建打印设备
2. `GET /list` - 获取打印设备列表（分页、搜索、筛选）
3. `GET /{uuid}` - 获取打印设备详情
4. `PUT /{uuid}` - 更新打印设备
5. `DELETE /{uuid}` - 删除打印设备
6. `POST /{uuid}/test` - 测试打印设备连接
7. `POST /{uuid}/print` - 执行打印任务（可选集成 Inngest）

---

## 🎨 前端页面设计

### 打印设备管理页面

**页面路径**：`pages/system/print-devices/list/index.tsx`

**核心功能**：
1. 打印设备列表展示（UniTable，支持表格视图）
2. 打印设备创建/编辑（Modal + ProForm，根据类型动态渲染配置表单）
3. 打印设备连接测试（测试连接、显示测试结果）
4. 打印设备删除（单个删除、批量删除）
5. 打印设备搜索和筛选（按名称、类型）

**布局规范**：
- ✅ 使用 `UniTable` 组件展示列表
- ✅ 使用高级搜索（`showAdvancedSearch={true}`）
- ✅ 使用 `searchFormValues` 获取搜索条件
- ✅ 创建/编辑使用 Modal + ProForm
- ✅ 连接测试使用 Drawer 展示测试结果

---

## ⚠️ 重要注意事项

### 1. 打印设备连接注意事项

**要点**：
- 网络打印机需要验证 IP 地址和端口
- Linux 打印机需要 CUPS 支持（可选）
- 连接测试需要超时设置，防止长时间等待

### 2. 多租户支持

**要点**：
- 打印设备按组织隔离
- 打印任务按组织隔离

---

## 📚 相关文档

- [Inngest 集成指南.md](./Inngest集成指南.md)
- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)
- [6.打印模板最佳实践.md](./6.打印模板最佳实践.md)

---

**最后更新**：2025-01-XX

