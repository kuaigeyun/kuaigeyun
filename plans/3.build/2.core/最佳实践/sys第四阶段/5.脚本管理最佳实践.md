# 脚本管理最佳实践

## 📋 模块概述

**模块名称**：脚本管理（Script Management）  
**优先级**：⭐⭐（低优先级）  
**预计时间**：1-2 周  
**依赖**：无（独立功能）

**功能范围**：
- 脚本定义（脚本名称、类型、内容）
- 脚本管理（CRUD、执行脚本）
- 脚本执行（可选集成 Inngest 异步执行）
- 脚本执行记录（执行历史、结果跟踪）

**核心特点**：
- ✅ **可选集成 Inngest**：脚本执行可以通过 Inngest 异步执行（可选）
- ✅ **支持多种脚本类型**：JavaScript、Python等

---

## 🔍 库选择评估

### 脚本管理实现方案

**结论**：✅ **使用自定义实现 + PyExecJS + Inngest（可选）**

#### 方案一：自定义实现 + PyExecJS + Inngest ⭐⭐⭐⭐（推荐）

**优势**：
- ✅ 功能完整，支持多种脚本类型
- ✅ PyExecJS 支持 JavaScript 执行
- ✅ 可选集成 Inngest，支持异步脚本执行
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）

**实现复杂度**：⭐⭐（简单，1-2 周可完成）

---

## 🗄️ 数据库设计

### 脚本表（root_scripts）

```sql
CREATE TABLE root_scripts (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 脚本基本信息
    name VARCHAR(100) NOT NULL,              -- 脚本名称
    code VARCHAR(50) NOT NULL,                -- 脚本代码（唯一，用于程序识别）
    description TEXT,                         -- 脚本描述
    type VARCHAR(20) NOT NULL,               -- 脚本类型（javascript、python等）
    
    -- 脚本内容
    content TEXT NOT NULL,                   -- 脚本内容
    
    -- 脚本状态
    is_active BOOLEAN DEFAULT TRUE,          -- 是否启用
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    CONSTRAINT uk_root_scripts_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_scripts_tenant_id (tenant_id),
    INDEX idx_root_scripts_uuid (uuid),
    INDEX idx_root_scripts_code (code),
    INDEX idx_root_scripts_type (type),
    INDEX idx_root_scripts_created_at (created_at)
);
```

---

## 🔧 脚本执行

### 1. JavaScript 执行（使用 PyExecJS）

**文件位置**：`riveredge-backend/src/tree_root/services/script_service.py`

```python
import PyExecJS

async def execute_javascript_script(script_content: str, context: Dict[str, Any] = None) -> Dict[str, Any]:
    """
    执行 JavaScript 脚本
    
    Args:
        script_content: 脚本内容
        context: 执行上下文（可选）
        
    Returns:
        执行结果
    """
    try:
        # 创建执行上下文
        ctx = PyExecJS.compile(script_content)
        
        # 如果有上下文，注入到脚本中
        if context:
            for key, value in context.items():
                ctx.eval(f"var {key} = {json.dumps(value)};")
        
        # 执行脚本
        result = ctx.eval(script_content)
        
        return {
            "success": True,
            "result": result
        }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }
```

### 2. 可选集成 Inngest（异步执行）

```python
from inngest import Event
from ..inngest.client import inngest_client

async def execute_script_async(tenant_id: int, script_uuid: str, context: Dict[str, Any] = None) -> Dict[str, Any]:
    """
    异步执行脚本（通过 Inngest）
    
    Args:
        tenant_id: 组织ID
        script_uuid: 脚本UUID
        context: 执行上下文（可选）
        
    Returns:
        执行结果（异步）
    """
    # 发送 Inngest 事件
    await inngest_client.send_event(
        event=Event(
            name="script/execute",
            data={
                "tenant_id": tenant_id,
                "script_uuid": script_uuid,
                "context": context or {}
            }
        )
    )
    
    return {"success": True, "message": "脚本执行已提交"}
```

---

## 🌐 API 设计

### 脚本管理 API

**路由前缀**：`/api/tree-root/scripts`

**接口列表**：
1. `POST /` - 创建脚本
2. `GET /list` - 获取脚本列表（分页、搜索、筛选）
3. `GET /{uuid}` - 获取脚本详情
4. `PUT /{uuid}` - 更新脚本
5. `DELETE /{uuid}` - 删除脚本
6. `POST /{uuid}/execute` - 执行脚本（同步或异步）
7. `GET /{uuid}/executions` - 获取脚本执行记录

---

## 🎨 前端页面设计

### 脚本管理页面

**页面路径**：`pages/system/scripts/list/index.tsx`

**核心功能**：
1. 脚本列表展示（UniTable，支持表格视图）
2. 脚本创建/编辑（Modal + 代码编辑器）
3. 脚本执行（同步执行、异步执行）
4. 脚本执行记录（查看执行历史、执行结果）
5. 脚本删除（单个删除、批量删除）
6. 脚本搜索和筛选（按名称、类型）

**布局规范**：
- ✅ 使用 `UniTable` 组件展示列表
- ✅ 使用高级搜索（`showAdvancedSearch={true}`）
- ✅ 使用 `searchFormValues` 获取搜索条件
- ✅ 创建/编辑使用 Modal + 代码编辑器（Monaco Editor 或 CodeMirror）

---

## ⚠️ 重要注意事项

### 1. 脚本执行安全

**要点**：
- JavaScript 脚本执行需要安全沙箱，防止代码注入
- Python 脚本执行需要安全沙箱，防止代码注入
- 脚本执行需要限制执行时间和资源使用
- 脚本执行需要记录执行日志

### 2. 多租户支持

**要点**：
- 脚本按组织隔离
- 脚本执行按组织隔离
- 脚本执行记录按组织隔离

---

## 📚 相关文档

- [Inngest 集成指南.md](./Inngest集成指南.md)
- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)

---

**最后更新**：2025-01-XX

