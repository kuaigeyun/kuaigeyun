# å®¡æ‰¹æµç¨‹æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šå®¡æ‰¹æµç¨‹ï¼ˆApproval Process Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š3-4 å‘¨  
**ä¾èµ–**ï¼šç”¨æˆ·ç®¡ç†ã€æ¶ˆæ¯ç®¡ç†ï¼ˆå®¡æ‰¹éœ€è¦é€šçŸ¥ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- å®¡æ‰¹æµç¨‹å®šä¹‰ï¼ˆæµç¨‹åç§°ã€èŠ‚ç‚¹é…ç½®ã€æµç¨‹é…ç½®ï¼‰
- å®¡æ‰¹æµç¨‹ç®¡ç†ï¼ˆCRUDã€åŸºäº Inngest å·¥ä½œæµç¼–æ’ï¼‰
- å®¡æ‰¹å®ä¾‹ç®¡ç†ï¼ˆæäº¤å®¡æ‰¹ã€å®¡æ‰¹æ“ä½œã€çŠ¶æ€è·Ÿè¸ªï¼‰
- å®¡æ‰¹æµç¨‹å¯è§†åŒ–ï¼ˆProFlow è®¾è®¡å™¨ï¼‰

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **åŸºäº Inngest å·¥ä½œæµç¼–æ’**ï¼šæ‰€æœ‰å®¡æ‰¹æµç¨‹éƒ½é€šè¿‡ Inngest å·¥ä½œæµæ‰§è¡Œ
- âœ… **ProFlow å¯è§†åŒ–è®¾è®¡**ï¼šå‰ç«¯ä½¿ç”¨ ProFlow è®¾è®¡å®¡æ‰¹æµç¨‹
- âœ… **å·¥ä½œæµè½¬æ¢**ï¼šProFlow è®¾è®¡è½¬æ¢ä¸º Inngest å·¥ä½œæµé…ç½®
- âœ… **çŠ¶æ€åŒæ­¥**ï¼šInngest å·¥ä½œæµçŠ¶æ€åŒæ­¥åˆ°æ•°æ®åº“

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### å®¡æ‰¹æµç¨‹å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **ä½¿ç”¨ Inngest å·¥ä½œæµç¼–æ’ + ProFlow å¯è§†åŒ–ï¼ˆæ¨èï¼‰**

#### æ–¹æ¡ˆä¸€ï¼šInngest + ProFlow â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… Inngest ä½œä¸ºå·¥ä½œæµç¼–æ’å¼•æ“ï¼ˆ"éª¨"ï¼‰ï¼ŒåŠŸèƒ½å¼ºå¤§
- âœ… ProFlow ä½œä¸ºå¯è§†åŒ–ç»„ä»¶ï¼ˆ"çš®"ï¼‰ï¼Œç”¨æˆ·ä½“éªŒå¥½
- âœ… æ”¯æŒå¤æ‚å·¥ä½œæµè®¾è®¡ï¼ˆæ¡ä»¶åˆ†æ”¯ã€å¹¶è¡Œæ‰§è¡Œï¼‰
- âœ… æ”¯æŒå·¥ä½œæµçŠ¶æ€ç®¡ç†å’Œç›‘æ§
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆtenant_id å­—æ®µï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰

**å·¥ä½œæµç¨‹**ï¼š
1. **è®¾è®¡é˜¶æ®µ**ï¼šä½¿ç”¨ ProFlow åœ¨å‰ç«¯å¯è§†åŒ–è®¾è®¡å®¡æ‰¹æµç¨‹
2. **é…ç½®é˜¶æ®µ**ï¼šå°† ProFlow è®¾è®¡çš„æµç¨‹è½¬æ¢ä¸º Inngest å·¥ä½œæµé…ç½®
3. **æ³¨å†Œé˜¶æ®µ**ï¼šå°†å·¥ä½œæµé…ç½®æ³¨å†Œåˆ° Inngest
4. **æ‰§è¡Œé˜¶æ®µ**ï¼šInngest æ‰§è¡Œå·¥ä½œæµï¼ŒProFlow å±•ç¤ºæ‰§è¡ŒçŠ¶æ€
5. **ç›‘æ§é˜¶æ®µ**ï¼šProFlow å®æ—¶å±•ç¤ºå·¥ä½œæµæ‰§è¡Œè¿›åº¦å’Œç»“æœ

**å®ç°å¤æ‚åº¦**ï¼šâ­â­â­â­ï¼ˆè¾ƒå¤æ‚ï¼Œ3-4 å‘¨å¯å®Œæˆï¼‰

---

### æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**æ¨è**ï¼šâœ… **ä½¿ç”¨ Inngest å·¥ä½œæµç¼–æ’ + ProFlow å¯è§†åŒ–**

**ç†ç”±**ï¼š
1. âœ… **Inngest åŠŸèƒ½å¼ºå¤§**ï¼Œæ”¯æŒå¤æ‚å·¥ä½œæµç¼–æ’
2. âœ… **ProFlow ç”¨æˆ·ä½“éªŒå¥½**ï¼Œå¯è§†åŒ–è®¾è®¡å·¥ä½œæµ
3. âœ… **å¤šç§Ÿæˆ·æ˜¯æ ¸å¿ƒéœ€æ±‚**ï¼ŒInngest å¤©ç„¶æ”¯æŒ
4. âœ… **å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒ**ï¼Œä»£ç é£æ ¼ç»Ÿä¸€
5. âœ… **ç»´æŠ¤æˆæœ¬ä½**ï¼Œç»Ÿä¸€æŠ€æœ¯æ ˆ

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. å®¡æ‰¹æµç¨‹è¡¨ï¼ˆroot_approval_processesï¼‰

```sql
CREATE TABLE root_approval_processes (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- æµç¨‹åŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,              -- æµç¨‹åç§°
    code VARCHAR(50) NOT NULL,                -- æµç¨‹ä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰
    description TEXT,                         -- æµç¨‹æè¿°
    
    -- æµç¨‹é…ç½®
    nodes JSONB NOT NULL,                     -- æµç¨‹èŠ‚ç‚¹é…ç½®ï¼ˆJSONæ ¼å¼ï¼ŒProFlow è®¾è®¡ï¼‰
    config JSONB NOT NULL,                   -- æµç¨‹é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
    
    -- Inngest å…³è”
    inngest_workflow_id VARCHAR(100),        -- Inngest å·¥ä½œæµIDï¼ˆå…³è” Inngest å·¥ä½œæµï¼‰
    
    -- æµç¨‹çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,          -- æ˜¯å¦å¯ç”¨
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_approval_processes_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_approval_processes_tenant_id (tenant_id),
    INDEX idx_root_approval_processes_uuid (uuid),
    INDEX idx_root_approval_processes_code (code),
    INDEX idx_root_approval_processes_created_at (created_at)
);
```

### 2. å®¡æ‰¹å®ä¾‹è¡¨ï¼ˆroot_approval_instancesï¼‰

```sql
CREATE TABLE root_approval_instances (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    process_id INTEGER NOT NULL,             -- å…³è”æµç¨‹IDï¼ˆå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰
    
    -- å®ä¾‹åŸºæœ¬ä¿¡æ¯
    title VARCHAR(200) NOT NULL,             -- å®¡æ‰¹æ ‡é¢˜
    content TEXT,                             -- å®¡æ‰¹å†…å®¹
    data JSONB,                               -- å®¡æ‰¹æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
    
    -- å®¡æ‰¹çŠ¶æ€
    status VARCHAR(20) NOT NULL,             -- å®¡æ‰¹çŠ¶æ€ï¼ˆpendingã€approvedã€rejectedã€cancelledï¼‰
    current_node VARCHAR(100),                -- å½“å‰èŠ‚ç‚¹
    current_approver_id INTEGER,              -- å½“å‰å®¡æ‰¹äººID
    
    -- Inngest å…³è”
    inngest_run_id VARCHAR(100),              -- Inngest è¿è¡ŒIDï¼ˆå…³è” Inngest å·¥ä½œæµå®ä¾‹ï¼‰
    
    -- å®¡æ‰¹ä¿¡æ¯
    submitter_id INTEGER NOT NULL,           -- æäº¤äººID
    submitted_at TIMESTAMP NOT NULL,         -- æäº¤æ—¶é—´
    completed_at TIMESTAMP NULL,              -- å®Œæˆæ—¶é—´
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    INDEX idx_root_approval_instances_tenant_id (tenant_id),
    INDEX idx_root_approval_instances_uuid (uuid),
    INDEX idx_root_approval_instances_process_id (process_id),
    INDEX idx_root_approval_instances_status (status),
    INDEX idx_root_approval_instances_current_approver_id (current_approver_id),
    INDEX idx_root_approval_instances_submitter_id (submitter_id),
    INDEX idx_root_approval_instances_inngest_run_id (inngest_run_id),
    INDEX idx_root_approval_instances_created_at (created_at),
    
    -- å¤–é”®
    FOREIGN KEY (process_id) REFERENCES root_approval_processes(id) ON DELETE RESTRICT
);
```

---

## ğŸ”§ Inngest é›†æˆ

### 1. å·¥ä½œæµè½¬æ¢

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/services/approval_process_service.py`

```python
from typing import Dict, Any

def convert_proflow_to_inngest(proflow_config: Dict[str, Any]) -> Dict[str, Any]:
    """
    å°† ProFlow è®¾è®¡è½¬æ¢ä¸º Inngest å·¥ä½œæµé…ç½®
    
    Args:
        proflow_config: ProFlow è®¾è®¡çš„æµç¨‹é…ç½®
        
    Returns:
        Inngest å·¥ä½œæµé…ç½®
    """
    # è½¬æ¢é€»è¾‘ï¼šå°† ProFlow èŠ‚ç‚¹è½¬æ¢ä¸º Inngest æ­¥éª¤
    inngest_steps = []
    
    for node in proflow_config.get("nodes", []):
        step = {
            "id": node["id"],
            "name": node["name"],
            "type": node["type"],
            "config": node.get("config", {})
        }
        inngest_steps.append(step)
    
    return {
        "steps": inngest_steps,
        "edges": proflow_config.get("edges", [])
    }
```

### 2. å®¡æ‰¹å·¥ä½œæµå‡½æ•°

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/inngest/functions/approval_workflow.py`

```python
from inngest import Inngest, Event
from inngest.functions import Step
from typing import Dict, Any

inngest = Inngest(app_id="riveredge")

@inngest.create_function(
    id="approval-workflow",
    name="å®¡æ‰¹å·¥ä½œæµ",
    trigger=inngest.TriggerEvent(event="approval/submit")
)
async def approval_workflow(event: Event) -> Dict[str, Any]:
    """
    å®¡æ‰¹å·¥ä½œæµ
    
    å¤„ç†å®¡æ‰¹æµç¨‹çš„å„ä¸ªèŠ‚ç‚¹ã€‚
    """
    tenant_id = event.data.get("tenant_id")
    approval_id = event.data.get("approval_id")
    process_id = event.data.get("process_id")
    current_node = event.data.get("current_node")
    
    # æ­¥éª¤1ï¼šè·å–å®¡æ‰¹æµç¨‹é…ç½®
    process_config = await Step.run(
        "get-process-config",
        lambda: get_approval_process_config(process_id)
    )
    
    # æ­¥éª¤2ï¼šæ‰§è¡Œå½“å‰èŠ‚ç‚¹
    node_result = await Step.run(
        "execute-node",
        lambda: execute_approval_node(tenant_id, approval_id, current_node, process_config)
    )
    
    # æ­¥éª¤3ï¼šåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    if node_result.get("has_next"):
        next_node = node_result.get("next_node")
        # è§¦å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        await inngest.send_event(
            event=Event(
                name="approval/next",
                data={
                    "tenant_id": tenant_id,
                    "approval_id": approval_id,
                    "current_node": next_node
                }
            )
        )
    else:
        # å®¡æ‰¹å®Œæˆ
        await Step.run(
            "complete-approval",
            lambda: complete_approval(tenant_id, approval_id, node_result)
        )
    
    return {
        "success": True,
        "current_node": current_node,
        "result": node_result
    }
```

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### å®¡æ‰¹æµç¨‹ç®¡ç†é¡µé¢

**é¡µé¢è·¯å¾„**ï¼š`pages/system/approval-processes/list/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. å®¡æ‰¹æµç¨‹åˆ—è¡¨å±•ç¤ºï¼ˆUniTableï¼Œæ”¯æŒè¡¨æ ¼è§†å›¾ï¼‰
2. å®¡æ‰¹æµç¨‹åˆ›å»º/ç¼–è¾‘ï¼ˆModal + ProFlow è®¾è®¡å™¨ï¼‰
3. å®¡æ‰¹æµç¨‹åˆ é™¤ï¼ˆå•ä¸ªåˆ é™¤ã€æ‰¹é‡åˆ é™¤ï¼‰
4. å®¡æ‰¹æµç¨‹æœç´¢å’Œç­›é€‰ï¼ˆæŒ‰åç§°ã€çŠ¶æ€ï¼‰

### ProFlow æµç¨‹è®¾è®¡å™¨

**é¡µé¢è·¯å¾„**ï¼š`pages/system/approval-processes/designer/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. ProFlow å¯è§†åŒ–è®¾è®¡å™¨ï¼ˆèŠ‚ç‚¹æ‹–æ‹½ã€è¿æ¥çº¿ç»˜åˆ¶ï¼‰
2. èŠ‚ç‚¹å±æ€§é…ç½®ï¼ˆå®¡æ‰¹äººã€å®¡æ‰¹æ¡ä»¶ç­‰ï¼‰
3. æµç¨‹é¢„è§ˆï¼ˆé¢„è§ˆæµç¨‹è®¾è®¡ï¼‰
4. æµç¨‹ä¿å­˜ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼Œè½¬æ¢ä¸º Inngest é…ç½®ï¼‰

### å®¡æ‰¹å®ä¾‹é¡µé¢

**é¡µé¢è·¯å¾„**ï¼š`pages/system/approval-processes/instances/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. å®¡æ‰¹å®ä¾‹åˆ—è¡¨å±•ç¤ºï¼ˆæˆ‘å‘èµ·çš„ã€æˆ‘çš„å¾…åŠã€æˆ‘çš„å·²åŠã€æˆ‘çš„æŠ„é€ï¼‰
2. æäº¤å®¡æ‰¹ï¼ˆåˆ›å»ºå®¡æ‰¹å®ä¾‹ï¼Œè§¦å‘ Inngest å·¥ä½œæµï¼‰
3. å®¡æ‰¹æ“ä½œï¼ˆåŒæ„ã€æ‹’ç»ã€è½¬äº¤ï¼‰
4. å®¡æ‰¹çŠ¶æ€è·Ÿè¸ªï¼ˆæŸ¥çœ‹å®¡æ‰¹è¿›åº¦ã€å®¡æ‰¹å†å²ï¼‰

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. ProFlow ä¸ Inngest é…åˆ

**å·¥ä½œæµç¨‹**ï¼š
1. **è®¾è®¡é˜¶æ®µ**ï¼šProFlow å¯è§†åŒ–è®¾è®¡å·¥ä½œæµ
2. **è½¬æ¢é˜¶æ®µ**ï¼šProFlow è®¾è®¡è½¬æ¢ä¸º Inngest å·¥ä½œæµé…ç½®
3. **æ³¨å†Œé˜¶æ®µ**ï¼šInngest å·¥ä½œæµé…ç½®æ³¨å†Œåˆ° Inngest
4. **æ‰§è¡Œé˜¶æ®µ**ï¼šInngest æ‰§è¡Œå·¥ä½œæµ
5. **ç›‘æ§é˜¶æ®µ**ï¼šProFlow å±•ç¤º Inngest å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€

### 2. çŠ¶æ€åŒæ­¥

**è¦ç‚¹**ï¼š
- Inngest å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€éœ€è¦åŒæ­¥åˆ°æ•°æ®åº“
- å®¡æ‰¹å®ä¾‹çŠ¶æ€éœ€è¦å®æ—¶æ›´æ–°
- å®¡æ‰¹è¿›åº¦éœ€è¦å®æ—¶å±•ç¤º

### 3. å¤šç§Ÿæˆ·æ”¯æŒ

**è¦ç‚¹**ï¼š
- æ‰€æœ‰ Inngest å‡½æ•°å¿…é¡»åŒ…å« `tenant_id` å‚æ•°
- å®¡æ‰¹æµç¨‹æŒ‰ç»„ç»‡éš”ç¦»
- å®¡æ‰¹å®ä¾‹æŒ‰ç»„ç»‡éš”ç¦»

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Inngest é›†æˆæŒ‡å—.md](./Inngesté›†æˆæŒ‡å—.md)
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md)
- [å»ºè®¾è¿›åº¦.md](./å»ºè®¾è¿›åº¦.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

