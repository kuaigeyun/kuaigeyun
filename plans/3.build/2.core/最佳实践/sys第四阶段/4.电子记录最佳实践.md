# ç”µå­è®°å½•æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šç”µå­è®°å½•ï¼ˆElectronic Record Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š2-3 å‘¨  
**ä¾èµ–**ï¼šæ–‡ä»¶ç®¡ç†ï¼ˆç”µå­è®°å½•å¯èƒ½éœ€è¦é™„ä»¶ï¼‰ã€Inngestï¼ˆå·¥ä½œæµï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- ç”µå­è®°å½•å®šä¹‰ï¼ˆè®°å½•åç§°ã€ç±»å‹ã€å†…å®¹ã€å…³è”æ–‡ä»¶ï¼‰
- ç”µå­è®°å½•ç®¡ç†ï¼ˆCRUDã€ç­¾åã€å½’æ¡£ï¼‰
- ç”µå­è®°å½•å·¥ä½œæµï¼ˆåŸºäº Inngest å·¥ä½œæµï¼‰
- ç”µå­è®°å½•ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»ºã€ç­¾åã€å½’æ¡£ã€é”€æ¯ï¼‰

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **åŸºäº Inngest å·¥ä½œæµ**ï¼šç­¾åã€å½’æ¡£æµç¨‹éƒ½é€šè¿‡ Inngest å·¥ä½œæµæ‰§è¡Œ
- âœ… **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè®°å½•çš„ç”Ÿå‘½å‘¨æœŸé€šè¿‡ Inngest å·¥ä½œæµç®¡ç†

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### ç”µå­è®°å½•å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **ä½¿ç”¨è‡ªå®šä¹‰å®ç° + Inngest å·¥ä½œæµï¼ˆæ¨èï¼‰**

#### æ–¹æ¡ˆä¸€ï¼šè‡ªå®šä¹‰å®ç° + Inngest â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒç”µå­è®°å½•å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… Inngest å·¥ä½œæµç¼–æ’ï¼Œæ”¯æŒç­¾åã€å½’æ¡£æµç¨‹
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆtenant_id å­—æ®µï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰

**å®ç°å¤æ‚åº¦**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼Œ2-3 å‘¨å¯å®Œæˆï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ç”µå­è®°å½•è¡¨ï¼ˆroot_electronic_recordsï¼‰

```sql
CREATE TABLE root_electronic_records (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- è®°å½•åŸºæœ¬ä¿¡æ¯
    name VARCHAR(200) NOT NULL,              -- è®°å½•åç§°
    code VARCHAR(50) NOT NULL,                -- è®°å½•ä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰
    type VARCHAR(50) NOT NULL,               -- è®°å½•ç±»å‹
    description TEXT,                         -- è®°å½•æè¿°
    
    -- è®°å½•å†…å®¹
    content JSONB NOT NULL,                   -- è®°å½•å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
    
    -- å…³è”æ–‡ä»¶
    file_uuid VARCHAR(36),                    -- å…³è”æ–‡ä»¶UUIDï¼ˆå¯é€‰ï¼‰
    
    -- Inngest å…³è”
    inngest_workflow_id VARCHAR(100),        -- Inngest å·¥ä½œæµIDï¼ˆç­¾åã€å½’æ¡£æµç¨‹ï¼‰
    inngest_run_id VARCHAR(100),              -- Inngest è¿è¡ŒIDï¼ˆå½“å‰å·¥ä½œæµå®ä¾‹ï¼‰
    
    -- è®°å½•çŠ¶æ€
    status VARCHAR(20) NOT NULL,             -- è®°å½•çŠ¶æ€ï¼ˆdraftã€signedã€archivedã€destroyedï¼‰
    lifecycle_stage VARCHAR(20),             -- ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼ˆcreatedã€signingã€archivingã€completedï¼‰
    
    -- ç­¾åä¿¡æ¯
    signer_id INTEGER,                        -- ç­¾åäººID
    signed_at TIMESTAMP NULL,                 -- ç­¾åæ—¶é—´
    signature_data TEXT,                      -- ç­¾åæ•°æ®ï¼ˆå¯é€‰ï¼‰
    
    -- å½’æ¡£ä¿¡æ¯
    archived_at TIMESTAMP NULL,               -- å½’æ¡£æ—¶é—´
    archive_location VARCHAR(200),            -- å½’æ¡£ä½ç½®ï¼ˆå¯é€‰ï¼‰
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_electronic_records_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_electronic_records_tenant_id (tenant_id),
    INDEX idx_root_electronic_records_uuid (uuid),
    INDEX idx_root_electronic_records_code (code),
    INDEX idx_root_electronic_records_type (type),
    INDEX idx_root_electronic_records_status (status),
    INDEX idx_root_electronic_records_lifecycle_stage (lifecycle_stage),
    INDEX idx_root_electronic_records_created_at (created_at)
);
```

---

## ğŸ”§ Inngest é›†æˆ

### 1. ç­¾åå·¥ä½œæµ

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/inngest/functions/electronic_record_workflow.py`

```python
from inngest import Inngest, Event
from inngest.functions import Step
from typing import Dict, Any

inngest = Inngest(app_id="riveredge")

@inngest.create_function(
    id="electronic-record-sign",
    name="ç”µå­è®°å½•ç­¾åå·¥ä½œæµ",
    trigger=inngest.TriggerEvent(event="electronic-record/sign")
)
async def electronic_record_sign_workflow(event: Event) -> Dict[str, Any]:
    """
    ç”µå­è®°å½•ç­¾åå·¥ä½œæµ
    
    å¤„ç†ç”µå­è®°å½•çš„ç­¾åæµç¨‹ã€‚
    """
    tenant_id = event.data.get("tenant_id")
    record_id = event.data.get("record_id")
    signer_id = event.data.get("signer_id")
    
    # æ­¥éª¤1ï¼šéªŒè¯è®°å½•çŠ¶æ€
    record = await Step.run(
        "validate-record",
        lambda: validate_electronic_record(tenant_id, record_id)
    )
    
    # æ­¥éª¤2ï¼šæ‰§è¡Œç­¾å
    signature = await Step.run(
        "sign-record",
        lambda: sign_electronic_record(tenant_id, record_id, signer_id)
    )
    
    # æ­¥éª¤3ï¼šæ›´æ–°è®°å½•çŠ¶æ€
    await Step.run(
        "update-status",
        lambda: update_record_status(tenant_id, record_id, "signed", signature)
    )
    
    return {"success": True, "signature": signature}
```

### 2. å½’æ¡£å·¥ä½œæµ

```python
@inngest.create_function(
    id="electronic-record-archive",
    name="ç”µå­è®°å½•å½’æ¡£å·¥ä½œæµ",
    trigger=inngest.TriggerEvent(event="electronic-record/archive")
)
async def electronic_record_archive_workflow(event: Event) -> Dict[str, Any]:
    """
    ç”µå­è®°å½•å½’æ¡£å·¥ä½œæµ
    
    å¤„ç†ç”µå­è®°å½•çš„å½’æ¡£æµç¨‹ã€‚
    """
    tenant_id = event.data.get("tenant_id")
    record_id = event.data.get("record_id")
    
    # æ­¥éª¤1ï¼šéªŒè¯è®°å½•çŠ¶æ€
    record = await Step.run(
        "validate-record",
        lambda: validate_electronic_record(tenant_id, record_id)
    )
    
    # æ­¥éª¤2ï¼šæ‰§è¡Œå½’æ¡£
    archive_location = await Step.run(
        "archive-record",
        lambda: archive_electronic_record(tenant_id, record_id)
    )
    
    # æ­¥éª¤3ï¼šæ›´æ–°è®°å½•çŠ¶æ€
    await Step.run(
        "update-status",
        lambda: update_record_status(tenant_id, record_id, "archived", archive_location)
    )
    
    return {"success": True, "archive_location": archive_location}
```

---

## ğŸŒ API è®¾è®¡

### ç”µå­è®°å½•ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/tree-root/electronic-records`

**æ¥å£åˆ—è¡¨**ï¼š
1. `POST /` - åˆ›å»ºç”µå­è®°å½•
2. `GET /list` - è·å–ç”µå­è®°å½•åˆ—è¡¨ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ï¼‰
3. `GET /{uuid}` - è·å–ç”µå­è®°å½•è¯¦æƒ…
4. `PUT /{uuid}` - æ›´æ–°ç”µå­è®°å½•
5. `DELETE /{uuid}` - åˆ é™¤ç”µå­è®°å½•
6. `POST /{uuid}/sign` - ç­¾åç”µå­è®°å½•ï¼ˆè§¦å‘ Inngest å·¥ä½œæµï¼‰
7. `POST /{uuid}/archive` - å½’æ¡£ç”µå­è®°å½•ï¼ˆè§¦å‘ Inngest å·¥ä½œæµï¼‰
8. `GET /{uuid}/status` - è·å–è®°å½•çŠ¶æ€ï¼ˆåŒ…æ‹¬å·¥ä½œæµçŠ¶æ€ï¼‰

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### ç”µå­è®°å½•ç®¡ç†é¡µé¢

**é¡µé¢è·¯å¾„**ï¼š`pages/system/electronic-records/list/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. ç”µå­è®°å½•åˆ—è¡¨å±•ç¤ºï¼ˆUniTableï¼Œæ”¯æŒè¡¨æ ¼è§†å›¾ï¼‰
2. ç”µå­è®°å½•åˆ›å»º/ç¼–è¾‘ï¼ˆModal + ProFormï¼‰
3. ç”µå­è®°å½•ç­¾åï¼ˆè§¦å‘ç­¾åå·¥ä½œæµï¼‰
4. ç”µå­è®°å½•å½’æ¡£ï¼ˆè§¦å‘å½’æ¡£å·¥ä½œæµï¼‰
5. ç”µå­è®°å½•çŠ¶æ€è·Ÿè¸ªï¼ˆæŸ¥çœ‹ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼‰
6. ç”µå­è®°å½•åˆ é™¤ï¼ˆå•ä¸ªåˆ é™¤ã€æ‰¹é‡åˆ é™¤ï¼‰

**å¸ƒå±€è§„èŒƒ**ï¼š
- âœ… ä½¿ç”¨ `UniTable` ç»„ä»¶å±•ç¤ºåˆ—è¡¨
- âœ… ä½¿ç”¨é«˜çº§æœç´¢ï¼ˆ`showAdvancedSearch={true}`ï¼‰
- âœ… ä½¿ç”¨ `searchFormValues` è·å–æœç´¢æ¡ä»¶
- âœ… åˆ›å»º/ç¼–è¾‘ä½¿ç”¨ Modal + ProForm

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. Inngest å·¥ä½œæµé›†æˆ

**è¦ç‚¹**ï¼š
- ç­¾åå’Œå½’æ¡£æµç¨‹éƒ½é€šè¿‡ Inngest å·¥ä½œæµæ‰§è¡Œ
- å·¥ä½œæµçŠ¶æ€éœ€è¦åŒæ­¥åˆ°æ•°æ®åº“
- è®°å½•ç”Ÿå‘½å‘¨æœŸçŠ¶æ€éœ€è¦å®æ—¶æ›´æ–°

### 2. å¤šç§Ÿæˆ·æ”¯æŒ

**è¦ç‚¹**ï¼š
- æ‰€æœ‰ Inngest å‡½æ•°å¿…é¡»åŒ…å« `tenant_id` å‚æ•°
- ç”µå­è®°å½•æŒ‰ç»„ç»‡éš”ç¦»
- å·¥ä½œæµæ‰§è¡ŒæŒ‰ç»„ç»‡éš”ç¦»

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Inngest é›†æˆæŒ‡å—.md](./Inngesté›†æˆæŒ‡å—.md)
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md)
- [å»ºè®¾è¿›åº¦.md](./å»ºè®¾è¿›åº¦.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

