# 第六阶段：监控运维建设

## 📋 概述

第六阶段是系统级功能建设的监控运维阶段，建立系统监控和运维功能。

**建设时间**：5 周  
**状态**：⏳ **待开始**

**核心原则**：
- ✅ **系统可观测性**：提供完整的系统监控和日志功能
- ✅ **数据安全**：提供数据备份和恢复功能
- ✅ **运维便捷**：提供便捷的运维工具和操作界面

---

## 📁 本文件夹内容

本文件夹包含第六阶段建设所需的所有规划文档：

1. **最佳实践文档**：
   - [1.操作日志最佳实践.md](./1.操作日志最佳实践.md)
   - [2.登录日志最佳实践.md](./2.登录日志最佳实践.md)
   - [3.在线用户最佳实践.md](./3.在线用户最佳实践.md)
   - [4.数据备份最佳实践.md](./4.数据备份最佳实践.md)（基于 Inngest 定时备份）

2. **规范文档**：
   - [前端页面布局规范.md](./前端页面布局规范.md)（复用第四阶段规范）
   - [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)（复用第四阶段规范）

3. **开发计划**：
   - [建设进度.md](./建设进度.md)（开发进度跟踪）

---

## 🚀 建设顺序

### 1. 操作日志（第1优先级）

**预计时间**：1 周  
**状态**：⏳ 待开始

**依赖**：无（独立功能）

**核心特点**：
- ✅ **自动记录**：通过中间件自动记录所有 API 操作
- ✅ **详细记录**：记录操作类型、操作模块、操作对象、操作内容等
- ✅ **多维度查询**：支持按用户、操作类型、操作模块、时间范围查询

**文件位置**：
- 后端：`riveredge-backend/src/tree_root/api/operation_logs/`
- 前端：`riveredge-frontend/src/tree-stem/pages/system/operation-logs/`

**建设步骤**：
1. ⏳ 创建数据库模型（OperationLog）
2. ⏳ 创建 Schema（数据验证）
3. ⏳ 创建 Service（业务逻辑）
4. ⏳ 创建 API（路由）
5. ⏳ 创建数据库迁移
6. ⏳ 创建操作日志中间件（自动记录 API 操作）
7. ⏳ 创建前端页面和服务

---

### 2. 登录日志（第2优先级）

**预计时间**：1 周  
**状态**：⏳ 待开始

**依赖**：用户管理（需要用户信息）

**核心特点**：
- ✅ **自动记录**：通过中间件自动记录所有登录尝试
- ✅ **详细记录**：记录登录用户、IP、设备、浏览器、登录状态等
- ✅ **安全监控**：支持登录失败统计、异常登录检测

**文件位置**：
- 后端：`riveredge-backend/src/tree_root/api/login_logs/`
- 前端：`riveredge-frontend/src/tree-stem/pages/system/login-logs/`

**建设步骤**：
1. ⏳ 创建数据库模型（LoginLog）
2. ⏳ 创建 Schema（数据验证）
3. ⏳ 创建 Service（业务逻辑）
4. ⏳ 创建 API（路由）
5. ⏳ 创建数据库迁移
6. ⏳ 创建登录日志中间件（自动记录登录尝试）
7. ⏳ 创建前端页面和服务

---

### 3. 在线用户（第3优先级）

**预计时间**：1 周  
**状态**：⏳ 待开始

**依赖**：用户管理、Redis（需要会话存储）

**核心特点**：
- ✅ **从 Redis 读取**：从 Redis 会话中提取在线用户信息
- ✅ **会话管理**：支持查看用户会话详情、强制下线
- ✅ **实时统计**：实时统计在线用户数、活跃用户数

**文件位置**：
- 后端：`riveredge-backend/src/tree_root/api/online_users/`
- 前端：`riveredge-frontend/src/tree-stem/pages/system/online-users/`

**建设步骤**：
1. ⏳ 创建 Service（业务逻辑，从 Redis 读取会话信息）
2. ⏳ 创建 API（路由）
3. ⏳ 创建前端页面和服务

---

### 4. 数据备份（第4优先级）

**预计时间**：2 周  
**状态**：⏳ 待开始

**依赖**：Inngest（定时备份任务）、文件管理（备份文件存储）

**核心特点**：
- ✅ **基于 Inngest**：使用 Inngest 定时触发器执行备份任务
- ✅ **多种备份类型**：支持全量备份、增量备份
- ✅ **备份策略**：支持配置备份频率、保留策略
- ✅ **数据恢复**：支持从备份文件恢复数据库

**文件位置**：
- 后端：`riveredge-backend/src/tree_root/api/data_backups/`
- 前端：`riveredge-frontend/src/tree-stem/pages/system/data-backups/`

**建设步骤**：
1. ⏳ 创建数据库模型（DataBackup）
2. ⏳ 创建 Schema（数据验证）
3. ⏳ 创建 Service（业务逻辑，包含备份和恢复逻辑）
4. ⏳ 创建 Inngest 函数（定时备份任务）
5. ⏳ 创建 API（路由）
6. ⏳ 创建数据库迁移
7. ⏳ 创建前端页面和服务

**关键技术**：
- Inngest（定时备份任务）
- pg_dump（PostgreSQL 全量备份）
- pg_restore（PostgreSQL 恢复备份）

---

## 📚 相关文档

- [系统级功能建设计划.md](../系统级功能建设计划.md)
- [第四阶段建设规范](../sys第四阶段/)
- [第三阶段建设规范](../sys第三阶段/)
- [第二阶段建设规范](../sys第二阶段/)
- [第一阶段建设规范](../sys第一阶段/)

---

## 🎯 第六阶段核心目标

### 1. 系统可观测性

- ✅ **操作日志**：记录所有系统操作，支持审计和问题排查
- ✅ **登录日志**：记录所有登录尝试，支持安全监控
- ✅ **在线用户**：实时查看在线用户，支持会话管理

### 2. 数据安全

- ✅ **数据备份**：定时自动备份数据库，支持全量和增量备份
- ✅ **数据恢复**：支持从备份文件恢复数据库
- ✅ **备份管理**：支持备份文件管理、备份策略配置

### 3. 统一的设计规范

- ✅ 复用第一、第二、第三、第四阶段的设计规范（混合ID方案、API设计规范、数据库设计规范）
- ✅ 保持代码规范（命名、注释、错误处理）
- ✅ 多租户隔离（所有数据自动过滤 tenant_id）
- ✅ 前端页面布局规范（UniTable、Modal、Drawer 标准用法）

### 4. 经验教训应用

- ✅ **禁止假设和猜测**：必须直接查看实际代码，使用完全相同的值
- ✅ **禁止擅作主张**：只做用户明确要求的事，不做额外"优化"
- ✅ **数据库迁移规范**：必须使用 Aerich 迁移系统，禁止直接使用 SQL
- ✅ **前端搜索规范**：必须使用高级搜索（`showAdvancedSearch={true}`），使用 `searchFormValues` 获取搜索条件

---

## ⚠️ 重要注意事项

### 1. 日志记录性能

**必须遵守的原则**：
1. ✅ **异步记录**：日志记录应该异步执行，不影响业务性能
2. ✅ **批量写入**：可以考虑批量写入日志，减少数据库压力
3. ✅ **日志清理**：定期清理过期日志，避免数据量过大

### 2. 数据备份安全

**设计要点**：
1. ✅ **备份文件加密**：敏感数据备份文件应该加密存储
2. ✅ **备份权限控制**：只有管理员可以创建和恢复备份
3. ✅ **备份验证**：备份完成后验证备份文件完整性
4. ✅ **备份存储**：备份文件应该存储在安全的位置

### 3. 开发顺序

**严格按照依赖关系开发**：
1. **操作日志**（第1优先级）- 无依赖，可立即开始
2. **登录日志**（第2优先级）- 依赖用户管理，可并行开发
3. **在线用户**（第3优先级）- 依赖用户管理和 Redis，可并行开发
4. **数据备份**（第4优先级）- 依赖 Inngest 和文件管理，需等待 Inngest 集成完成后开始

---

**最后更新**：2025-01-XX

