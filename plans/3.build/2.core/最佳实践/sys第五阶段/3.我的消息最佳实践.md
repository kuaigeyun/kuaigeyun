# æˆ‘çš„æ¶ˆæ¯æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šæˆ‘çš„æ¶ˆæ¯ï¼ˆMy Messagesï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š1 å‘¨  
**ä¾èµ–**ï¼šæ¶ˆæ¯ç®¡ç†ï¼ˆéœ€è¦æ¶ˆæ¯ç³»ç»Ÿï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- ç”¨æˆ·æ¶ˆæ¯ç®¡ç†ï¼ˆæ¶ˆæ¯åˆ—è¡¨ã€æŸ¥çœ‹è¯¦æƒ…ã€æ ‡è®°å·²è¯»ã€åˆ é™¤ï¼‰
- æ¶ˆæ¯çŠ¶æ€ç®¡ç†ï¼ˆå·²è¯»/æœªè¯»çŠ¶æ€ï¼‰
- æ¶ˆæ¯åˆ†ç±»ï¼ˆç³»ç»Ÿé€šçŸ¥ã€ä¸šåŠ¡é€šçŸ¥ã€å®¡æ‰¹é€šçŸ¥ç­‰ï¼‰
- æœªè¯»æ¶ˆæ¯ç»Ÿè®¡

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **ç”¨æˆ·æ¶ˆæ¯æ¨¡å‹**ï¼šç‹¬ç«‹çš„ç”¨æˆ·æ¶ˆæ¯è¡¨ï¼Œå­˜å‚¨ç”¨æˆ·æ¥æ”¶çš„æ¶ˆæ¯
- âœ… **æ¶ˆæ¯çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒå·²è¯»/æœªè¯»çŠ¶æ€
- âœ… **æ¶ˆæ¯åˆ†ç±»**ï¼šæ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹å’Œçº§åˆ«

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### æˆ‘çš„æ¶ˆæ¯å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **ä½¿ç”¨ç‹¬ç«‹ç”¨æˆ·æ¶ˆæ¯è¡¨ï¼ˆæ¨èï¼‰**

#### æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹ç”¨æˆ·æ¶ˆæ¯è¡¨ â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æ•°æ®åˆ†ç¦»ï¼Œæ¶ˆæ¯å‘é€è®°å½•å’Œç”¨æˆ·æ¶ˆæ¯åˆ†å¼€å­˜å‚¨
- âœ… æ”¯æŒæ¶ˆæ¯çŠ¶æ€ç®¡ç†ï¼ˆå·²è¯»/æœªè¯»ï¼‰
- âœ… æ”¯æŒæ¶ˆæ¯åˆ†ç±»å’Œç­›é€‰
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆtenant_id å­—æ®µï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰

**åŠ£åŠ¿**ï¼š
- âš ï¸ éœ€è¦æ–°å»ºè¡¨å’Œå…³è”é€»è¾‘

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… éœ€è¦æ¶ˆæ¯çŠ¶æ€ç®¡ç†
- âœ… éœ€è¦æ¶ˆæ¯åˆ†ç±»å’Œç­›é€‰
- âœ… éœ€è¦å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

**å®ç°å¤æ‚åº¦**ï¼šâ­ï¼ˆç®€å•ï¼Œ1 å‘¨å¯å®Œæˆï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ç”¨æˆ·æ¶ˆæ¯è¡¨ï¼ˆroot_user_messagesï¼‰

```sql
CREATE TABLE root_user_messages (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,                -- å…³è”ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
    
    -- å…³è”æ¶ˆæ¯å‘é€è®°å½•ï¼ˆå¯é€‰ï¼‰
    message_log_uuid VARCHAR(36),            -- å…³è”æ¶ˆæ¯å‘é€è®°å½•UUIDï¼ˆå¯é€‰ï¼‰
    
    -- æ¶ˆæ¯åŸºæœ¬ä¿¡æ¯
    title VARCHAR(200) NOT NULL,             -- æ¶ˆæ¯æ ‡é¢˜
    content TEXT NOT NULL,                   -- æ¶ˆæ¯å†…å®¹
    type VARCHAR(50) NOT NULL,               -- æ¶ˆæ¯ç±»å‹ï¼ˆsystemã€businessã€approvalç­‰ï¼‰
    level VARCHAR(20) NOT NULL DEFAULT 'info', -- æ¶ˆæ¯çº§åˆ«ï¼ˆinfoã€warningã€errorï¼‰
    
    -- æ¶ˆæ¯çŠ¶æ€
    is_read BOOLEAN DEFAULT FALSE,           -- æ˜¯å¦å·²è¯»
    read_at TIMESTAMP NULL,                  -- å·²è¯»æ—¶é—´
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    INDEX idx_root_user_messages_tenant_id (tenant_id),
    INDEX idx_root_user_messages_user_id (user_id),
    INDEX idx_root_user_messages_uuid (uuid),
    INDEX idx_root_user_messages_type (type),
    INDEX idx_root_user_messages_level (level),
    INDEX idx_root_user_messages_is_read (is_read),
    INDEX idx_root_user_messages_created_at (created_at)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… **æ··åˆIDæ–¹æ¡ˆ**ï¼š`id`ï¼ˆè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰+ `uuid`ï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼‰
- âœ… `user_id` å­—æ®µå…³è”ç”¨æˆ·è¡¨
- âœ… `message_log_uuid` å­—æ®µå¯é€‰å…³è”æ¶ˆæ¯å‘é€è®°å½•
- âœ… `type` å­—æ®µæ ‡è¯†æ¶ˆæ¯ç±»å‹ï¼ˆsystemã€businessã€approvalç­‰ï¼‰
- âœ… `level` å­—æ®µæ ‡è¯†æ¶ˆæ¯çº§åˆ«ï¼ˆinfoã€warningã€errorï¼‰
- âœ… `is_read` å­—æ®µæ ‡è¯†æ¶ˆæ¯æ˜¯å¦å·²è¯»
- âœ… è½¯åˆ é™¤æ”¯æŒï¼ˆ`deleted_at`ï¼‰

---

## ğŸ”§ åç«¯å®ç°

### 1. åˆ›å»ºæ•°æ®åº“æ¨¡å‹

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/models/user_message.py`

å‚è€ƒç¬¬å››é˜¶æ®µçš„æ¨¡å‹æ ¼å¼åˆ›å»ºã€‚

### 2. åˆ›å»º Schema

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/schemas/user_message.py`

```python
"""
ç”¨æˆ·æ¶ˆæ¯ Schema æ¨¡å—

å®šä¹‰ç”¨æˆ·æ¶ˆæ¯ç›¸å…³çš„ Pydantic Schemaï¼Œç”¨äºæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–ã€‚
"""

from pydantic import BaseModel, Field, ConfigDict
from typing import Optional
from datetime import datetime
from uuid import UUID


class UserMessageBase(BaseModel):
    """ç”¨æˆ·æ¶ˆæ¯åŸºç¡€ Schema"""
    title: str = Field(..., max_length=200, description="æ¶ˆæ¯æ ‡é¢˜")
    content: str = Field(..., description="æ¶ˆæ¯å†…å®¹")
    type: str = Field(..., max_length=50, description="æ¶ˆæ¯ç±»å‹")
    level: str = Field(default="info", max_length=20, description="æ¶ˆæ¯çº§åˆ«")


class UserMessageCreate(UserMessageBase):
    """åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ Schema"""
    user_id: int = Field(..., description="å…³è”ç”¨æˆ·ID")
    message_log_uuid: Optional[str] = Field(None, description="å…³è”æ¶ˆæ¯å‘é€è®°å½•UUID")


class UserMessageUpdate(BaseModel):
    """æ›´æ–°ç”¨æˆ·æ¶ˆæ¯ Schema"""
    is_read: Optional[bool] = Field(None, description="æ˜¯å¦å·²è¯»")


class UserMessageResponse(UserMessageBase):
    """ç”¨æˆ·æ¶ˆæ¯å“åº” Schema"""
    uuid: UUID = Field(..., description="ç”¨æˆ·æ¶ˆæ¯UUID")
    tenant_id: int = Field(..., description="ç»„ç»‡ID")
    user_id: int = Field(..., description="å…³è”ç”¨æˆ·ID")
    message_log_uuid: Optional[str] = Field(None, description="å…³è”æ¶ˆæ¯å‘é€è®°å½•UUID")
    is_read: bool = Field(..., description="æ˜¯å¦å·²è¯»")
    read_at: Optional[datetime] = Field(None, description="å·²è¯»æ—¶é—´")
    created_at: datetime = Field(..., description="åˆ›å»ºæ—¶é—´")
    updated_at: datetime = Field(..., description="æ›´æ–°æ—¶é—´")
    
    model_config = ConfigDict(from_attributes=True)


class UserMessageUnreadCountResponse(BaseModel):
    """æœªè¯»æ¶ˆæ¯æ•°é‡å“åº” Schema"""
    total: int = Field(..., description="æ€»æœªè¯»æ¶ˆæ¯æ•°")
    by_type: dict = Field(default_factory=dict, description="æŒ‰ç±»å‹ç»Ÿè®¡æœªè¯»æ¶ˆæ¯æ•°")
    by_level: dict = Field(default_factory=dict, description="æŒ‰çº§åˆ«ç»Ÿè®¡æœªè¯»æ¶ˆæ¯æ•°")
```

### 3. åˆ›å»º Service

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/services/user_message_service.py`

å‚è€ƒç¬¬å››é˜¶æ®µçš„ Service æ ¼å¼åˆ›å»ºï¼ŒåŒ…å«ï¼š
- `list_user_messages`ï¼šè·å–ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ï¼šå…¨éƒ¨ã€æœªè¯»ã€å·²è¯»ï¼‰
- `get_user_message_by_uuid`ï¼šè·å–ç”¨æˆ·æ¶ˆæ¯è¯¦æƒ…
- `mark_as_read`ï¼šæ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
- `mark_all_as_read`ï¼šæ‰¹é‡æ ‡è®°ä¸ºå·²è¯»
- `delete_user_message`ï¼šåˆ é™¤æ¶ˆæ¯
- `get_unread_count`ï¼šè·å–æœªè¯»æ¶ˆæ¯æ•°é‡

### 4. åˆ›å»º API

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/api/user_messages/user_messages.py`

å‚è€ƒç¬¬å››é˜¶æ®µçš„ API æ ¼å¼åˆ›å»ºï¼ŒåŒ…å«ï¼š
- `GET /`ï¼šè·å–å½“å‰ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨
- `GET /{uuid}`ï¼šè·å–æ¶ˆæ¯è¯¦æƒ…
- `PUT /{uuid}/read`ï¼šæ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
- `PUT /read-all`ï¼šæ‰¹é‡æ ‡è®°ä¸ºå·²è¯»
- `DELETE /{uuid}`ï¼šåˆ é™¤æ¶ˆæ¯
- `GET /unread-count`ï¼šè·å–æœªè¯»æ¶ˆæ¯æ•°é‡

### 5. æ•°æ®åº“è¿ç§»

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/migrations/models/XX_YYYYMMDDHHMMSS_create_user_messages.py`

å‚è€ƒç¬¬å››é˜¶æ®µçš„è¿ç§»æ–‡ä»¶æ ¼å¼åˆ›å»ºã€‚

---

## ğŸŒ API è®¾è®¡

### æˆ‘çš„æ¶ˆæ¯ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/v1/personal/user-messages`

**æ¥å£åˆ—è¡¨**ï¼š
1. `GET /` - è·å–å½“å‰ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ï¼šå…¨éƒ¨ã€æœªè¯»ã€å·²è¯»ï¼‰
2. `GET /{uuid}` - è·å–æ¶ˆæ¯è¯¦æƒ…
3. `PUT /{uuid}/read` - æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
4. `PUT /read-all` - æ‰¹é‡æ ‡è®°ä¸ºå·²è¯»
5. `DELETE /{uuid}` - åˆ é™¤æ¶ˆæ¯
6. `GET /unread-count` - è·å–æœªè¯»æ¶ˆæ¯æ•°é‡

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### æˆ‘çš„æ¶ˆæ¯é¡µé¢

**é¡µé¢è·¯å¾„**ï¼š`pages/personal/messages/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. æ¶ˆæ¯åˆ—è¡¨å±•ç¤ºï¼ˆUniTableï¼Œæ”¯æŒç­›é€‰ï¼šå…¨éƒ¨ã€æœªè¯»ã€å·²è¯»ï¼‰
2. æ¶ˆæ¯è¯¦æƒ…æŸ¥çœ‹ï¼ˆDrawer æˆ– Modalï¼‰
3. æ¶ˆæ¯æ“ä½œï¼ˆæ ‡è®°å·²è¯»ã€æ‰¹é‡æ ‡è®°å·²è¯»ã€åˆ é™¤ï¼‰
4. æœªè¯»æ¶ˆæ¯æ•°é‡æç¤ºï¼ˆå³ä¸Šè§’è§’æ ‡ï¼‰

**å¸ƒå±€è§„èŒƒ**ï¼š
- âœ… ä½¿ç”¨ `UniTable` ç»„ä»¶å±•ç¤ºåˆ—è¡¨
- âœ… ä½¿ç”¨é«˜çº§æœç´¢ï¼ˆ`showAdvancedSearch={true}`ï¼‰
- âœ… ä½¿ç”¨ `searchFormValues` è·å–æœç´¢æ¡ä»¶
- âœ… æ¶ˆæ¯è¯¦æƒ…ä½¿ç”¨ Drawer å±•ç¤º
- âœ… æœªè¯»æ¶ˆæ¯æ•°é‡ä½¿ç”¨ Badge ç»„ä»¶æ˜¾ç¤º

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æ¶ˆæ¯åˆ›å»ºæ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- ç”¨æˆ·æ¶ˆæ¯é€šå¸¸åœ¨æ¶ˆæ¯å‘é€æ—¶è‡ªåŠ¨åˆ›å»º
- å¯ä»¥é€šè¿‡æ¶ˆæ¯ç®¡ç†æ¨¡å—å‘é€æ¶ˆæ¯æ—¶åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
- ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ï¼ˆç³»ç»Ÿé€šçŸ¥ç­‰ï¼‰

### 2. æ¶ˆæ¯çŠ¶æ€ç®¡ç†æ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- æ ‡è®°å·²è¯»æ—¶ï¼Œéœ€è¦æ›´æ–° `is_read` å­—æ®µå’Œ `read_at` å­—æ®µ
- æ‰¹é‡æ ‡è®°å·²è¯»æ—¶ï¼Œéœ€è¦æ‰¹é‡æ›´æ–°å¤šæ¡æ¶ˆæ¯
- æœªè¯»æ¶ˆæ¯æ•°é‡éœ€è¦å®æ—¶ç»Ÿè®¡

### 3. å¤šç§Ÿæˆ·æ”¯æŒ

**è¦ç‚¹**ï¼š
- ç”¨æˆ·æ¶ˆæ¯æŒ‰ç»„ç»‡éš”ç¦»ï¼ˆtenant_idï¼‰
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ¶ˆæ¯
- API è‡ªåŠ¨è¿‡æ»¤å½“å‰ç”¨æˆ·ï¼Œæ— éœ€æ‰‹åŠ¨è¿‡æ»¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md)
- [å»ºè®¾è¿›åº¦.md](./å»ºè®¾è¿›åº¦.md)
- [1.æ¶ˆæ¯ç®¡ç†æœ€ä½³å®è·µ.md](../sysç¬¬å››é˜¶æ®µ/1.æ¶ˆæ¯ç®¡ç†æœ€ä½³å®è·µ.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

