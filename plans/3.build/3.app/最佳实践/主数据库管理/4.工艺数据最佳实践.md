# 工艺数据最佳实践

## 📋 概述

本文档详细说明工艺数据模块（不良品、工序、工艺路线、作业程序）的开发最佳实践，结合 RiverEdge SaaS 框架规范和 DDD 应用层设计规范。

## 🎯 模块说明

工艺数据模块用于管理生产工艺相关的基础数据，包含：
- **不良品（Defect Type）**：不良品类型信息
- **工序（Operation）**：生产工序信息
- **工艺路线（Process Route）**：工序序列组合
- **作业程序（SOP）**：标准作业程序

## 🏗️ 技术架构

### 后端架构（传统分层）

```
riveredge-backend/src/apps/master_data/
├── api/
│   └── process.py                    # 工艺数据 API
├── services/
│   └── process_service.py           # 工艺数据服务
├── models/
│   └── process.py                   # 工艺数据模型
└── schemas/
    └── process_schemas.py           # 工艺数据 Schema
```

## 📐 数据库设计规范

### 不良品表（seed_master_data_defect_types）

```sql
CREATE TABLE seed_master_data_defect_types (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    category VARCHAR(50),
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE(tenant_id, code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_uuid (uuid),
    INDEX idx_category (category)
);
```

### 工序表（seed_master_data_operations）

```sql
CREATE TABLE seed_master_data_operations (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE(tenant_id, code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_uuid (uuid)
);
```

### 工艺路线表（seed_master_data_process_routes）

```sql
CREATE TABLE seed_master_data_process_routes (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    operation_sequence JSONB,              -- 工序序列（JSON格式）
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE(tenant_id, code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_uuid (uuid)
);
```

### 作业程序表（seed_master_data_sop）

```sql
CREATE TABLE seed_master_data_sop (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    operation_id INTEGER,                    -- 关联工序ID
    version VARCHAR(20),
    content TEXT,                           -- SOP内容（支持富文本）
    attachments JSONB,                      -- 附件列表（JSON格式）
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE(tenant_id, code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_uuid (uuid),
    INDEX idx_operation_id (operation_id)
);
```

## ✅ 检查清单

### 开发前准备

- [ ] 确认数据库表结构设计
- [ ] 确认工艺路线工序序列数据结构（JSON格式）
- [ ] 确认SOP内容格式（富文本）
- [ ] 确认SOP附件管理逻辑

### 开发中

- [ ] 遵循命名规范
- [ ] 所有查询必须包含 `tenant_id` 过滤
- [ ] 工艺路线支持工序序列（JSON格式）
- [ ] SOP支持富文本内容和附件
- [ ] 编写完整的注释（中文）
- [ ] 编写单元测试（覆盖率 > 80%）

### 开发后

- [ ] 完整功能测试
- [ ] 性能测试
- [ ] 文档完善
- [ ] 代码审查

## 📚 相关文档

- [主数据管理APP开发计划](./主数据管理APP开发计划.md)
- [工厂数据最佳实践](./1.工厂数据最佳实践.md)

---

**最后更新**：2025-01-11

