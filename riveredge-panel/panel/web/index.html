<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RiverEdge 部署向导</title>
  <style>
    *{box-sizing:border-box}
    :root{--app-max:720px;--app-pad:32px}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang SC','Microsoft YaHei',sans-serif;background:linear-gradient(180deg,#f0f5ff 0%,#e6f7ff 50%,#f5f5f5 100%);min-height:100vh}
    .header{background:linear-gradient(180deg,#fff 0%,#fafbff 100%);padding:20px var(--app-pad);border-bottom:1px solid #e8ecf4}
    .header-inner{max-width:var(--app-max);width:100%;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:24px;flex-wrap:wrap}
    .header-brand{flex:1;min-width:0}
    .header-brand-row{display:flex;align-items:center;gap:12px;margin-bottom:4px}
    .header .brand-icon{width:36px;height:36px;flex-shrink:0;background:linear-gradient(135deg,#1890ff,#096dd9);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;font-weight:700;letter-spacing:-1px}
    .header h1{margin:0;font-size:22px;font-weight:600;color:#262626;letter-spacing:-.5px}
    .header .header-desc{margin:0;color:#8c8c8c;font-size:14px;line-height:1.5}
    .header .btn-logout{flex-shrink:0;font-size:13px;padding:6px 14px}
    .main{padding:32px var(--app-pad);max-width:calc(var(--app-max) + var(--app-pad) * 2);width:100%;margin:0 auto}
    .progress{display:flex;gap:0;margin-bottom:32px;background:#fff;padding:8px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .progress-step{flex:1;text-align:center;padding:12px 8px;font-size:13px;color:#8c8c8c;position:relative;border-radius:8px;transition:all .2s}
    .progress-step.done{color:#52c41a;font-weight:500}
    .progress-step.active{color:#1890ff;background:#e6f7ff;font-weight:600}
    .progress-step-num{display:inline-block;width:28px;height:28px;line-height:28px;border-radius:50%;background:#d9d9d9;color:#fff;font-weight:600;margin-bottom:6px;font-size:14px}
    .progress-step.done .progress-step-num{background:#52c41a}
    .progress-step.active .progress-step-num{background:#1890ff}
    .card{background:#fff;border-radius:12px;padding:28px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .card h2{margin:0 0 8px;font-size:18px;color:#262626}
    .card .desc{color:#8c8c8c;font-size:14px;margin-bottom:20px;line-height:1.6}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:500;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,#1890ff,#096dd9);color:#fff;box-shadow:0 2px 6px rgba(24,144,255,.4)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(24,144,255,.5)}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-secondary{background:#f5f5f5;color:#595959}
    .btn-secondary:hover{background:#e8e8e8}
    .btn-orange{background:linear-gradient(135deg,#fa8c16,#d46b08);color:#fff;box-shadow:0 2px 6px rgba(250,140,22,.4)}
    .btn-orange:hover{background:linear-gradient(135deg,#ffa940,#fa8c16);transform:translateY(-1px);box-shadow:0 4px 12px rgba(250,140,22,.5)}
    .btn-orange:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-green{background:linear-gradient(135deg,#52c41a,#389e0d);color:#fff;box-shadow:0 2px 6px rgba(82,196,26,.4)}
    .btn-green:hover{background:linear-gradient(135deg,#73d13d,#52c41a);transform:translateY(-1px);box-shadow:0 4px 12px rgba(82,196,26,.5)}
    .btn-green:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .tag{display:inline-block;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:500}
    .tag-ok{background:#f6ffed;color:#52c41a;border:1px solid #b7eb8f}
    .tag-fail{background:#fff2f0;color:#ff4d4f;border:1px solid #ffccc7}
    .tag-warn{background:#fffbe6;color:#faad14;border:1px solid #ffe58f}
    .check-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .check-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fafafa;border-radius:8px;border:1px solid #f0f0f0}
    .check-item .name{font-weight:500;color:#262626}
    .check-item .hint{font-size:12px;color:#8c8c8c;margin-top:2px}
    .cmd-box{background:#1f1f1f;color:#e8e8e8;padding:14px 16px;border-radius:8px;font-family:'Consolas','Monaco',monospace;font-size:13px;overflow-x:auto;margin:8px 0}
    .cmd-row{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .cmd-row:last-child{margin-bottom:0}
    .form-group{margin-bottom:18px}
    .form-group label{display:block;margin-bottom:6px;font-weight:500;color:#262626}
    .form-group .hint{font-size:12px;color:#8c8c8c;margin-top:4px}
    input{padding:10px 14px;border:1px solid #d9d9d9;border-radius:8px;width:100%;max-width:320px;font-size:14px}
    input:focus{outline:none;border-color:#1890ff;box-shadow:0 0 0 2px rgba(24,144,255,.2)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .step-item{display:flex;align-items:flex-start;gap:16px;padding:16px;background:#fafafa;border-radius:8px;margin-bottom:12px;border:1px solid #f0f0f0}
    .step-item.done{background:#f6ffed;border-color:#b7eb8f}
    .step-num{width:32px;height:32px;min-width:32px;background:#1890ff;color:#fff;border-radius:50%;text-align:center;line-height:32px;font-weight:600}
    .step-item.done .step-num{background:#52c41a}
    .success-box{text-align:center;padding:40px 24px}
    .success-box .icon{font-size:64px;color:#52c41a;margin-bottom:16px}
    .success-box h3{margin:0 0 12px;font-size:22px;color:#262626}
    .success-box p{color:#8c8c8c;margin-bottom:24px}
    .success-links{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .success-links a{display:inline-block;padding:12px 24px;background:#e6f7ff;color:#1890ff;border-radius:8px;text-decoration:none;font-weight:500}
    .success-links a:hover{background:#bae7ff}
    .alert{padding:14px 18px;border-radius:8px;margin-bottom:20px;line-height:1.5}
    .alert-info{background:#e6f7ff;border:1px solid #91d5ff;color:#0050b3}
    .alert-warn{background:#fffbe6;border:1px solid #ffe58f;color:#ad6800}
    .alert-error{background:#fff2f0;border:1px solid #ffccc7;color:#cf1322}
    .deploy-mode{display:flex;gap:16px;margin-top:12px;flex-wrap:wrap}
    .deploy-mode-opt{display:inline-flex;align-items:center;gap:10px;padding:14px 20px;border:2px solid #e8e8e8;border-radius:10px;cursor:pointer;background:#fafafa;transition:all .2s;white-space:nowrap}
    .deploy-mode-opt:hover{border-color:#bfbfbf;background:#f5f5f5}
    .deploy-mode-opt.selected{border-color:#1890ff;background:#e6f7ff}
    .deploy-mode-opt input{display:none}
    .deploy-mode-opt .label{font-weight:500;color:#262626}
    .config-section{margin-bottom:28px}
    .config-section-title{font-size:15px;font-weight:600;color:#262626;margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid #1890ff;display:inline-block}
    .input-test-row{display:flex;align-items:center;gap:12px}
    .input-test-row input{flex:1;min-width:0;max-width:none}
    .input-test-row .test-result{min-width:80px}
    .btn-test{background:linear-gradient(135deg,#52c41a,#389e0d);color:#fff!important;flex-shrink:0}
    .btn-test:hover{background:linear-gradient(135deg,#73d13d,#52c41a);transform:translateY(-1px)}
    .init-helper-box{background:#fff7e6;border:2px solid #ffc53d;border-radius:10px;padding:18px;margin-top:12px}
    .init-helper-box .title{font-weight:600;color:#ad6800;margin-bottom:12px}
    .collapse-header{display:flex;align-items:center;gap:8px;padding:12px 16px;background:#fff7e6;border:1px solid #ffc53d;border-radius:8px;cursor:pointer;user-select:none;transition:background .2s}
    .collapse-header:hover{background:#fffbe6}
    .collapse-header .arrow{font-size:12px;color:#ad6800;transition:transform .2s}
    .collapse-header.expanded .arrow{transform:rotate(90deg)}
    .collapse-body{display:none;padding:16px 0 0;border-top:1px solid #ffe58f;margin-top:12px}
    .collapse-body.show{display:block}
    .auth-screen{max-width:400px;margin:80px auto;padding:32px;background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
    .auth-screen h2{margin:0 0 8px;font-size:20px;color:#262626}
    .auth-screen .hint{margin-bottom:20px;color:#8c8c8c;font-size:14px}
    .auth-screen input[type=password]{max-width:100%}
    .auth-screen .btn{margin-top:12px}
    .auth-screen .error{color:#ff4d4f;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div id="authGate" style="display:block;min-height:100vh;padding:24px">
    <div id="authSetPassword" class="auth-screen" style="display:none">
      <h2>首次使用：设置 Master 密码</h2>
      <p class="hint">请设置一个密码，后续访问面板需输入此密码</p>
      <div class="form-group">
        <label>Master 密码（至少 6 位）</label>
        <input type="password" id="authNewPassword" placeholder="请输入密码" onkeydown="if(event.key==='Enter')doSetMasterPassword()">
      </div>
      <div class="form-group">
        <label>确认密码</label>
        <input type="password" id="authConfirmPassword" placeholder="再次输入密码" onkeydown="if(event.key==='Enter')doSetMasterPassword()">
      </div>
      <div id="authSetError" class="error" style="display:none"></div>
      <button class="btn btn-primary" onclick="doSetMasterPassword()">设置并登录</button>
    </div>
    <div id="authLogin" class="auth-screen" style="display:none">
      <h2>输入 Master 密码</h2>
      <p class="hint">请输入 Master 密码以访问面板</p>
      <div class="form-group">
        <label>Master 密码</label>
        <input type="password" id="authPassword" placeholder="请输入密码" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <div id="authLoginError" class="error" style="display:none"></div>
      <button class="btn btn-primary" onclick="doLogin()">登录</button>
    </div>
    <div id="authLoading" style="text-align:center;padding:80px;color:#8c8c8c">正在验证...</div>
  </div>
  <div id="mainApp" style="display:none">
  <header class="header">
    <div class="header-inner">
      <div class="header-brand">
        <div class="header-brand-row">
          <div class="brand-icon">R</div>
          <h1>RiverEdge 部署向导</h1>
        </div>
        <p class="header-desc">从零开始，一步步将 RiverEdge 配置并启动</p>
      </div>
      <button class="btn btn-secondary btn-logout" onclick="doLogout()">退出</button>
    </div>
  </header>
  <main class="main">
    <div class="progress" id="progress">
      <div class="progress-step active" data-step="1"><span class="progress-step-num">1</span><br>环境检测</div>
      <div class="progress-step" data-step="2"><span class="progress-step-num">2</span><br>安装缺失</div>
      <div class="progress-step" data-step="3"><span class="progress-step-num">3</span><br>填写配置</div>
      <div class="progress-step" data-step="4"><span class="progress-step-num">4</span><br>执行部署</div>
      <div class="progress-step" data-step="5"><span class="progress-step-num">5</span><br>完成</div>
    </div>

    <div id="step1" class="card">
      <h2>第一步：环境检测</h2>
      <p class="desc">检测您的电脑是否已安装运行 RiverEdge 所需的软件。若全部通过，可直接进入下一步；若有未安装项，请先安装。</p>
      <div id="checkError" class="alert alert-error" style="display:none"></div>
      <div id="checkLoading" style="text-align:center;padding:24px;color:#8c8c8c">正在检测...</div>
      <div id="checkResult" style="display:none">
        <p style="margin-bottom:16px">当前系统：<strong id="platform"></strong> <span id="statusTag" class="tag"></span></p>
        <div class="check-grid" id="checkGrid"></div>
        <div style="margin-top:24px;display:flex;gap:12px">
          <button class="btn btn-primary" onclick="runCheck()" id="btnCheck">重新检测</button>
          <button class="btn btn-primary" onclick="goStep(2)" id="btnNextInstall" style="display:none">有未安装项，去安装 →</button>
          <button class="btn btn-primary" onclick="goStep(3)" id="btnNextConfig" style="display:none">全部通过，填写配置 →</button>
        </div>
      </div>
    </div>

    <div id="step2" class="card" style="display:none">
      <h2>第二步：安装缺失组件</h2>
      <p class="desc">复制下方命令，在 <strong>以管理员身份运行</strong> 的终端中执行。<br>Windows：右键「开始」→ Windows Terminal（管理员）或 CMD（管理员）。</p>
      <div id="installList"></div>
      <div style="margin-top:24px">
        <button class="btn btn-secondary" onclick="goStep(1)">← 返回检测</button>
        <button class="btn btn-primary" onclick="goStep(3)" style="margin-left:8px">已安装完成，去配置 →</button>
      </div>
    </div>

    <div id="step3" class="card" style="display:none">
      <h2>第三步：填写配置</h2>
      <p class="desc">填写数据库、Redis 等连接信息。先选择您的部署方式：</p>
      <div class="form-group">
        <label>部署方式</label>
        <div class="deploy-mode">
          <div class="deploy-mode-opt selected" id="opt_local" onclick="setDeployMode('local',true)">
            <input type="radio" name="deploy_mode" value="local" checked> <span class="label">本地部署</span>
          </div>
          <div class="deploy-mode-opt" id="opt_remote" onclick="setDeployMode('remote',true)">
            <input type="radio" name="deploy_mode" value="remote"> <span class="label">云服务器 / 远程数据库</span>
          </div>
        </div>
        <div class="hint" id="deployModeHint" style="margin-top:10px">数据库和 Redis 安装在本机，主机填 localhost</div>
        <div id="sgAlert" class="alert alert-warn" style="display:none;margin-top:12px">
          <strong>安全组提醒</strong>：云服务器部署时，请在云控制台「安全组」中放通以下端口：<br>
          数据库 <code>5432</code>、Redis <code>6379</code>（应用所在服务器需能访问）；若需外网访问，还需放通后端 <code>8200</code>、前端 <code>8100</code>、Inngest <code>8288</code>。
        </div>
      </div>
      <div class="config-section">
        <div class="config-section-title">数据库/Redis 初始化指引</div>
        <div class="collapse-header" id="initGuideHeader" onclick="toggleInitGuide()">
          <span class="arrow" id="initGuideArrow">▶</span>
          <span>本地首次部署？点击查看数据库与 Redis 初始化命令</span>
        </div>
        <div class="collapse-body" id="initGuideBody">
          <p class="hint" style="margin-bottom:12px">若数据库尚未创建，可按下方命令初始化（复制后修改密码再执行）：</p>
          <div class="init-helper-box">
            <div class="title">方式一：创建独立用户 riveredge</div>
            <div class="cmd-box" style="font-size:12px;white-space:pre-wrap" id="initCmd1">psql -U postgres -c "CREATE DATABASE riveredge;"
psql -U postgres -c "CREATE USER riveredge WITH PASSWORD '你的密码';"
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE riveredge TO riveredge;"</div>
            <button class="btn btn-secondary" style="margin-top:8px" onclick="copyInitCmd('initCmd1')">复制</button>
          </div>
          <div class="init-helper-box" style="margin-top:12px">
            <div class="title">方式二：使用 postgres 超级用户（需先设置密码）</div>
            <div class="cmd-box" style="font-size:12px;white-space:pre-wrap" id="initCmd2">psql -U postgres -c "ALTER USER postgres PASSWORD '你的密码';"
createdb -U postgres riveredge</div>
            <button class="btn btn-secondary" style="margin-top:8px" onclick="copyInitCmd('initCmd2')">复制</button>
          </div>
          <p class="hint" style="margin-top:12px">Redis 本地安装通常无需配置；云 Redis 需在控制台设置密码后填入上方 Redis 配置。</p>
        </div>
      </div>
      <div class="config-section">
        <div class="config-section-title">数据库配置</div>
        <div class="form-grid">
          <div class="form-group">
            <label>主机</label>
            <input id="db_host" value="localhost" placeholder="localhost 或 远程IP/域名">
            <div class="hint" id="db_host_hint">本机填 localhost</div>
          </div>
          <div class="form-group">
            <label>端口</label>
            <input id="db_port" type="number" value="5432">
          </div>
          <div class="form-group">
            <label>用户</label>
            <input id="db_user" value="postgres">
          </div>
          <div class="form-group">
            <label>密码</label>
            <input id="db_password" type="password" placeholder="PostgreSQL 用户密码">
          </div>
          <div class="form-group form-group-with-test" style="grid-column:1/-1">
            <label>数据库名</label>
            <div class="input-test-row">
              <input id="db_name" value="riveredge">
              <button class="btn btn-test" onclick="testConnectivity('postgres')" id="btnTestPostgres">测试连通性</button>
              <span id="postgresTestResult" class="test-result"></span>
            </div>
            <div class="hint">不存在时会自动创建</div>
          </div>
        </div>
      </div>
      <div class="config-section">
        <div class="config-section-title">Redis 配置</div>
        <div class="form-grid">
          <div class="form-group">
            <label>主机</label>
            <input id="redis_host" value="localhost" placeholder="主机">
          </div>
          <div class="form-group">
            <label>端口</label>
            <input id="redis_port" type="number" value="6379">
          </div>
          <div class="form-group form-group-with-test" style="grid-column:1/-1">
            <label>密码</label>
            <div class="input-test-row">
              <input id="redis_password" type="password" placeholder="无则留空">
              <button class="btn btn-test" onclick="testConnectivity('redis')" id="btnTestRedis">测试连通性</button>
              <span id="redisTestResult" class="test-result"></span>
            </div>
          </div>
        </div>
        <div class="hint">云 Redis 通常需填密码；本地 Redis 一般留空</div>
      </div>
      <div class="config-section">
        <div class="config-section-title">应用配置</div>
        <div class="form-grid">
          <div class="form-group">
            <label>平台超级管理员密码（首次登录用）</label>
            <input id="platform_superadmin_password" type="password" placeholder="留空则使用默认密码" style="max-width:320px">
          </div>
          <div class="form-group" style="grid-column:1/-1">
            <label>Git 仓库地址（可选）</label>
            <input id="git_remote_url" placeholder="如 https://gitee.com/xxx/riveredge.git，留空使用当前 origin">
            <div class="hint">拉取代码的远程地址。留空则使用 git 已配置的 origin</div>
          </div>
          <div class="form-group">
            <label>部署/更新分支</label>
            <input id="git_branch" value="develop" placeholder="develop 或 master">
            <div class="hint">开发用 develop，正式发版用 master</div>
          </div>
        </div>
      </div>
      <div class="config-section">
        <div class="config-section-title">Caddy 反向代理（生产环境）</div>
        <p class="hint" style="margin-bottom:12px">配置生产环境的反向代理。留空域名则使用 localhost；填写域名并勾选 Let's Encrypt 可自动申请 HTTPS 证书并续期。</p>
        <div class="form-grid">
          <div class="form-group">
            <label>域名（可选）</label>
            <input id="caddy_domain" placeholder="如 app.example.com，留空则用 localhost">
            <div class="hint">留空时使用 :8080 监听；填域名可启用 HTTPS</div>
          </div>
          <div class="form-group">
            <label>监听端口</label>
            <input id="caddy_proxy_port" type="number" value="8080" min="1" max="65535">
          </div>
          <div class="form-group" style="grid-column:1/-1">
            <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="caddy_enable_letsencrypt" style="width:18px;height:18px;max-width:none">
              <span>启用 Let's Encrypt 自动 HTTPS</span>
            </label>
            <div class="hint">需填写域名，且 80 端口可从公网访问；证书自动续期</div>
          </div>
        </div>
        <div style="margin-top:16px">
          <button class="btn btn-orange" onclick="previewCaddyfile()">预览 Caddyfile</button>
          <div id="caddyfilePreview" class="cmd-box" style="display:none;margin-top:12px;white-space:pre-wrap;max-height:200px;overflow-y:auto"></div>
        </div>
      </div>
      <div style="margin-top:24px;display:flex;gap:12px">
        <button class="btn btn-secondary" onclick="goStep(2)">← 返回</button>
        <button class="btn btn-primary" onclick="saveConfig()" id="btnSaveConfig">保存配置</button>
        <button class="btn btn-primary" onclick="goStep(4)" id="btnNextDeploy" style="display:none">去部署 →</button>
      </div>
    </div>

    <div id="step4" class="card" style="display:none">
      <h2>第四步：执行部署</h2>
      <p class="desc">依次执行：生成配置文件 → 数据库迁移 → 启动服务。请确保 PostgreSQL 和 Redis 已启动。</p>
      <div id="deployError" class="alert alert-error" style="display:none"></div>
      <div class="step-item" id="deployStep1">
        <span class="step-num">1</span>
        <div>
          <strong>生成 .env 配置文件</strong>
          <p style="margin:4px 0 0;color:#8c8c8c;font-size:14px">根据您的配置写入 riveredge-backend/.env</p>
        </div>
      </div>
      <div class="step-item" id="deployStep2">
        <span class="step-num">2</span>
        <div>
          <strong>数据库迁移</strong>
          <p style="margin:4px 0 0;color:#8c8c8c;font-size:14px">执行 <code>uv run aerich upgrade</code>，根据 migrations/ 目录下的 SQL 脚本创建/更新表结构（Aerich 为 Tortoise ORM 迁移工具）</p>
        </div>
      </div>
      <div class="step-item" id="deployStep3">
        <span class="step-num">3</span>
        <div>
          <strong>启动 RiverEdge（开发模式）</strong>
          <p style="margin:4px 0 0;color:#8c8c8c;font-size:14px">启动后端、前端、Inngest（热重载，需 Git Bash）</p>
        </div>
      </div>
      <div class="step-item" id="deployStep4">
        <span class="step-num">4</span>
        <div>
          <strong>生产启动（可选）</strong>
          <p style="margin:4px 0 0;color:#8c8c8c;font-size:14px">构建前端+手机端，启动后端、Inngest、Caddy 反向代理（含 Let's Encrypt）</p>
        </div>
      </div>
      <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-secondary" onclick="goStep(3)">← 返回</button>
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;color:#595959">
          <input type="checkbox" id="launch_mobile"> 开发启动时同时启动手机端
        </label>
        <button class="btn btn-primary" onclick="runDeployStep()" id="btnDeploy">开发启动</button>
        <button class="btn btn-primary" onclick="runLaunchProd()" id="btnDeployProd">生产启动</button>
        <button class="btn btn-green" onclick="runUpdateProd(this)" id="btnUpdateProd">生产更新</button>
      </div>
      <p class="hint" style="margin-top:12px">生产更新：拉取代码 → 数据库迁移 → 重新构建 → 重启服务（适用于项目已部署后的更新）</p>
    </div>

    <div id="step5" class="card" style="display:none">
      <div class="success-box">
        <div class="icon">✓</div>
        <h3>部署完成！</h3>
        <p>RiverEdge 已启动。请稍等片刻让服务完全就绪（约 30 秒），然后访问：</p>
        <div class="success-links">
          <a href="http://localhost:8100" target="_blank">开发模式 Web (8100) →</a>
          <a href="http://localhost:8101" target="_blank">开发模式 手机端 (8101) →</a>
          <a href="http://localhost:8080" target="_blank">生产模式 Web (8080) →</a>
          <a href="http://localhost:8080/mobile" target="_blank">生产模式 手机端 (8080/mobile) →</a>
          <a href="http://localhost:8100/infra" target="_blank">平台登录页 →</a>
        </div>
        <p style="margin-top:24px;font-size:13px;color:#8c8c8c">开发模式：Launch.dev.sh；生产模式：riveredge-panel/Launch.prod.sh (Linux) 或 Launch.prod.win.sh (Windows)</p>
        <div style="margin-top:16px">
          <button class="btn btn-green" onclick="runUpdateProd(this)">生产更新</button>
          <span class="hint" style="margin-left:8px">拉取代码、迁移、重建、重启</span>
        </div>
      </div>
      <div class="launch-status-box" style="margin-top:24px;text-align:left">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <span style="font-weight:600;color:#262626">启动状态</span>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:#8c8c8c">
            <input type="checkbox" id="statusAutoRefresh" checked onchange="toggleStatusRefresh()"> 自动刷新
          </label>
        </div>
        <div id="launchStatusGrid" class="check-grid" style="margin-bottom:16px">加载中...</div>
        <details style="margin-top:12px">
          <summary style="cursor:pointer;color:#8c8c8c;font-size:13px">查看运行日志</summary>
          <div style="margin-top:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <select id="logFileSelect" onchange="loadLogs()" style="padding:6px 12px;border-radius:6px;font-size:14px">
              <option value="backend">后端</option>
              <option value="frontend">前端</option>
              <option value="inngest">Inngest</option>
              <option value="caddy">Caddy</option>
              <option value="mobile">手机端</option>
            </select>
            <button class="btn btn-secondary" onclick="loadLogs()" style="font-size:13px">刷新日志</button>
          </div>
          <div id="logContent" class="cmd-box" style="max-height:200px;overflow-y:auto;white-space:pre-wrap;font-size:12px;text-align:left;margin-top:8px;display:none"></div>
        </details>
      </div>
    </div>
  </main>
  </div>
  <script>
    const API = '/api';
    let checkData = null;
    let deployStep = 0;
    let currentStep = 1;

    async function fetchApi(path, opts) {
      opts = opts || {};
      opts.credentials = 'include';
      const r = await fetch(API + path, opts);
      if (r.status === 401) {
        document.getElementById('authGate').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authLogin').style.display = 'block';
        document.getElementById('authSetPassword').style.display = 'none';
        document.getElementById('authLoading').style.display = 'none';
        throw new Error('未登录');
      }
      if (!r.ok) {
        const text = await r.text();
        try {
          const j = JSON.parse(text);
          if (j.error) throw new Error(j.error);
        } catch (_) {}
        throw new Error(text || r.statusText);
      }
      return r.json();
    }

    async function checkAuth() {
      try {
        const r = await fetch(API + '/auth-status', { credentials: 'include' });
        const d = await r.json();
        if (d.authenticated) {
          document.getElementById('authGate').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          goStep(1);
          runCheck();
          return;
        }
        document.getElementById('authGate').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authLoading').style.display = 'none';
        if (d.has_password) {
          document.getElementById('authLogin').style.display = 'block';
          document.getElementById('authSetPassword').style.display = 'none';
        } else {
          document.getElementById('authLogin').style.display = 'none';
          document.getElementById('authSetPassword').style.display = 'block';
        }
      } catch (e) {
        document.getElementById('authLoading').textContent = '验证失败：' + (e.message || '');
      }
    }

    async function doSetMasterPassword() {
      const pwd = document.getElementById('authNewPassword').value;
      const confirm = document.getElementById('authConfirmPassword').value;
      document.getElementById('authSetError').style.display = 'none';
      if (!pwd || pwd.length < 6) {
        document.getElementById('authSetError').textContent = '密码至少 6 位';
        document.getElementById('authSetError').style.display = 'block';
        return;
      }
      if (pwd !== confirm) {
        document.getElementById('authSetError').textContent = '两次输入不一致';
        document.getElementById('authSetError').style.display = 'block';
        return;
      }
      try {
        const r = await fetch(API + '/set-master-password', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
        if (!r.ok) throw new Error(await r.text());
        document.getElementById('authGate').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        goStep(1);
        runCheck();
      } catch (e) {
        document.getElementById('authSetError').textContent = e.message || '设置失败';
        document.getElementById('authSetError').style.display = 'block';
      }
    }

    async function doLogout() {
      try {
        await fetch(API + '/logout', { method: 'POST', credentials: 'include' });
      } catch (_) {}
      checkAuth();
    }

    async function doLogin() {
      const pwd = document.getElementById('authPassword').value;
      document.getElementById('authLoginError').style.display = 'none';
      if (!pwd) {
        document.getElementById('authLoginError').textContent = '请输入密码';
        document.getElementById('authLoginError').style.display = 'block';
        return;
      }
      try {
        const r = await fetch(API + '/login', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
        if (!r.ok) throw new Error(await r.text());
        document.getElementById('authGate').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        goStep(1);
        runCheck();
      } catch (e) {
        document.getElementById('authLoginError').textContent = e.message || '登录失败';
        document.getElementById('authLoginError').style.display = 'block';
      }
    }

    let statusRefreshTimer = null;
    function goStep(n) {
      currentStep = n;
      if (statusRefreshTimer) { clearInterval(statusRefreshTimer); statusRefreshTimer = null; }
      document.querySelectorAll('[id^="step"]').forEach(el => { el.style.display = 'none'; });
      const el = document.getElementById('step' + n);
      if (el) el.style.display = 'block';
      document.querySelectorAll('.progress-step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < n) s.classList.add('done');
        else if (i + 1 === n) s.classList.add('active');
      });
      if (n === 2) loadInstall();
      if (n === 3) loadConfig();
      if (n === 5) { loadLaunchStatus(); startStatusRefresh(); }
    }
    async function loadLaunchStatus() {
      const el = document.getElementById('launchStatusGrid');
      try {
        const d = await fetchApi('/launch-status');
        let html = '';
        const items = [
          { key: 'backend', label: '后端 API', url: d.backend?.url },
          { key: 'frontend', label: '前端 Web', url: d.frontend?.url },
          { key: 'mobile', label: '手机端', url: d.mobile?.url },
          { key: 'inngest', label: 'Inngest', url: null },
          { key: 'caddy', label: 'Caddy 反向代理', url: d.caddy?.url },
        ];
        for (const it of items) {
          const s = d[it.key];
          const ok = s?.running;
          const tag = ok ? '<span class="tag tag-ok">✓ 运行中</span>' : '<span class="tag tag-fail">未启动</span>';
          const link = it.url && ok ? '<a href="' + it.url + '" target="_blank" style="font-size:12px;margin-right:8px">访问 →</a>' : '<span style="display:inline-block;min-width:52px"></span>';
          html += '<div class="check-item"><div><span class="name">' + it.label + '</span><div class="hint">端口 ' + (s?.port || '-') + '</div></div><div style="display:flex;align-items:center;justify-content:flex-end">' + link + tag + '</div></div>';
        }
        el.innerHTML = html || '加载失败';
      } catch (e) {
        el.innerHTML = '<div class="alert alert-error">加载失败：' + (e.message || '') + '</div>';
      }
    }
    function startStatusRefresh() {
      if (statusRefreshTimer) return;
      if (!document.getElementById('statusAutoRefresh')?.checked) return;
      statusRefreshTimer = setInterval(loadLaunchStatus, 2000);
    }
    function toggleStatusRefresh() {
      if (document.getElementById('statusAutoRefresh')?.checked) startStatusRefresh();
      else if (statusRefreshTimer) { clearInterval(statusRefreshTimer); statusRefreshTimer = null; }
    }
    async function loadLogs() {
      const file = document.getElementById('logFileSelect')?.value || 'backend';
      const el = document.getElementById('logContent');
      if (!el) return;
      try {
        const d = await fetchApi('/logs?file=' + file + '&lines=300');
        el.textContent = d.content || d.message || '（无日志）';
        el.style.display = 'block';
        el.scrollTop = el.scrollHeight;
      } catch (e) {
        el.textContent = '加载失败：' + (e.message || '');
        el.style.display = 'block';
      }
    }

    async function runCheck() {
      const btn = document.getElementById('btnCheck');
      btn.disabled = true;
      document.getElementById('checkLoading').style.display = 'block';
      document.getElementById('checkResult').style.display = 'none';
      document.getElementById('checkError').style.display = 'none';
      try {
        checkData = await fetchApi('/check');
        document.getElementById('checkLoading').style.display = 'none';
        document.getElementById('checkResult').style.display = 'block';
        renderChecks();
      } catch (e) {
        document.getElementById('checkLoading').style.display = 'none';
        document.getElementById('checkError').style.display = 'block';
        document.getElementById('checkError').textContent = '检测失败：' + (e.message || '请确保部署面板程序正在运行');
      }
      btn.disabled = false;
    }

    const LABELS = { node: 'Node.js 22+', python: 'Python 3.12', uv: 'UV', npm: 'npm', postgresql: 'PostgreSQL 15+', redis: 'Redis 6+', bash: 'Git Bash / WSL', inngest: 'Inngest CLI', caddy: 'Caddy' };
    const HINTS = { node: '前端运行环境', python: '后端运行环境', uv: 'Python 包管理', npm: '前端包管理', postgresql: '数据库', redis: '缓存服务', bash: '启动脚本需 bash', inngest: '工作流调度（可选）', caddy: '生产反向代理（建议安装）' };

    function renderChecks() {
      const checks = checkData?.checks || {};
      const required = ['bash','python','uv','node','npm','postgresql','redis'];
      const recommended = ['caddy'];
      const order = ['bash','caddy','python','uv','node','npm','postgresql','redis','inngest'];
      const allOk = required.every(k => checks[k]?.installed && checks[k]?.meets_requirement !== false);
      const hasMissing = required.some(k => !checks[k]?.installed || checks[k]?.meets_requirement === false);
      document.getElementById('platform').textContent = checkData.platform || '未知';
      const tag = document.getElementById('statusTag');
      tag.textContent = allOk ? '全部通过' : '有未安装项';
      tag.className = 'tag ' + (allOk ? 'tag-ok' : 'tag-warn');
      let html = '';
      for (const k of order) {
        const v = checks[k];
        if (!v) continue;
        const ok = v.installed && v.meets_requirement !== false;
        let statusTag = ok ? '<span class="tag tag-ok">✓ ' + (v.version || '') + '</span>' : (recommended.includes(k) ? '<span class="tag tag-warn">建议安装</span>' : '<span class="tag tag-fail">未安装</span>');
        html += '<div class="check-item"><div><span class="name">' + (LABELS[k] || k) + '</span><div class="hint">' + (HINTS[k] || '') + '</div></div>' + statusTag + '</div>';
      }
      document.getElementById('checkGrid').innerHTML = html;
      document.getElementById('btnNextInstall').style.display = hasMissing ? 'inline-flex' : 'none';
      document.getElementById('btnNextConfig').style.display = allOk ? 'inline-flex' : 'none';
    }

    async function loadInstall() {
      const comps = ['bash', 'caddy', 'python', 'uv', 'node', 'npm', 'postgresql', 'redis', 'inngest'];
      const list = document.getElementById('installList');
      list.innerHTML = '';
      for (const c of comps) {
        const inst = checkData?.checks?.[c]?.installed;
        if (inst) continue;
        let cmd = '';
        try { const r = await fetchApi('/install-script/' + c); cmd = r.command || ''; } catch (_) {}
        const div = document.createElement('div');
        div.style.marginBottom = '16px';
        div.innerHTML = '<strong>' + (LABELS[c] || c) + '</strong><div class="cmd-row"><div class="cmd-box">' + cmd.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div><button class="btn btn-primary" onclick="copyText(this)">复制</button></div>';
        div.querySelector('.cmd-box').dataset.cmd = cmd;
        list.appendChild(div);
      }
      if (list.innerHTML === '') list.innerHTML = '<p class="alert alert-info">所有组件已安装，可直接前往「填写配置」。</p>';
    }

    async function testConnectivity(typ) {
      const btn = typ === 'postgres' ? document.getElementById('btnTestPostgres') : document.getElementById('btnTestRedis');
      const resultEl = typ === 'postgres' ? document.getElementById('postgresTestResult') : document.getElementById('redisTestResult');
      btn.disabled = true;
      resultEl.textContent = '测试中...';
      resultEl.style.color = '#8c8c8c';
      try {
        const cfg = {
          postgres: { db_host: document.getElementById('db_host').value, db_port: parseInt(document.getElementById('db_port').value,10), db_user: document.getElementById('db_user').value, db_password: document.getElementById('db_password').value, db_name: document.getElementById('db_name').value },
          redis: { redis_host: document.getElementById('redis_host').value, redis_port: parseInt(document.getElementById('redis_port').value,10), redis_password: document.getElementById('redis_password').value }
        };
        const r = await fetch(API + '/test-' + typ, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg[typ]) });
        const data = await r.json().catch(() => ({}));
        const ok = r.ok && data.ok;
        resultEl.textContent = ok ? '✓ 连接成功' : ('✗ ' + (data.error || '连接失败'));
        resultEl.style.color = ok ? '#52c41a' : '#ff4d4f';
      } catch (e) {
        resultEl.textContent = '✗ ' + (e.message || '测试失败（需安装 psql/redis-cli）');
        resultEl.style.color = '#ff4d4f';
      }
      btn.disabled = false;
    }

    function toggleInitGuide() {
      const body = document.getElementById('initGuideBody');
      const header = document.getElementById('initGuideHeader');
      body.classList.toggle('show');
      header.classList.toggle('expanded', body.classList.contains('show'));
    }

    function copyInitCmd(id) {
      const el = document.getElementById(id);
      if (el) navigator.clipboard.writeText(el.textContent).then(() => alert('已复制'));
    }

    function copyText(btn) {
      const box = btn.parentElement.querySelector('.cmd-box');
      if (box?.dataset?.cmd) navigator.clipboard.writeText(box.dataset.cmd).then(() => { btn.textContent = '已复制'; setTimeout(() => btn.textContent = '复制', 1500); });
    }

    function setDeployMode(mode, applyDefaults) {
      document.querySelector('input[name="deploy_mode"][value="' + mode + '"]').checked = true;
      document.getElementById('opt_local').classList.toggle('selected', mode === 'local');
      document.getElementById('opt_remote').classList.toggle('selected', mode === 'remote');
      onDeployModeChange(applyDefaults);
    }

    function onDeployModeChange(applyDefaults) {
      const mode = document.querySelector('input[name="deploy_mode"]:checked')?.value || 'local';
      document.getElementById('sgAlert').style.display = mode === 'remote' ? 'block' : 'none';
      const hint = document.getElementById('deployModeHint');
      const dbHint = document.getElementById('db_host_hint');
      if (mode === 'remote') {
        hint.textContent = '数据库和 Redis 在云上或其他服务器，填写实例地址或 IP';
        dbHint.textContent = '云数据库填控制台提供的连接地址（如 xxx.rds.aliyuncs.com）';
        if (applyDefaults && (!document.getElementById('db_host').value || document.getElementById('db_host').value === 'localhost')) {
          document.getElementById('db_host').value = '';
          document.getElementById('db_host').placeholder = '如 1.2.3.4 或 db.xxx.com';
        }
        document.getElementById('redis_host').placeholder = 'Redis 实例地址';
      } else {
        hint.textContent = '数据库和 Redis 安装在本机，主机填 localhost';
        dbHint.textContent = '本机填 localhost，云数据库填实例地址';
        if (applyDefaults) {
          document.getElementById('db_host').value = 'localhost';
          document.getElementById('redis_host').value = 'localhost';
        }
        document.getElementById('db_host').placeholder = 'localhost 或 远程IP/域名';
        document.getElementById('redis_host').placeholder = '主机';
      }
    }

    async function loadConfig() {
      try {
        const cfg = await fetchApi('/config');
        const c = cfg.config || {};
        const mode = (c.deploy_mode === 'remote' ? 'remote' : 'local');
        setDeployMode(mode, false);
        document.getElementById('db_host').value = c.db_host ?? (mode === 'local' ? 'localhost' : '');
        document.getElementById('db_port').value = c.db_port ?? 5432;
        document.getElementById('db_user').value = c.db_user || 'postgres';
        document.getElementById('db_password').value = c.db_password || '';
        document.getElementById('db_name').value = c.db_name || 'riveredge';
        document.getElementById('redis_host').value = c.redis_host ?? (mode === 'local' ? 'localhost' : '');
        document.getElementById('redis_port').value = c.redis_port ?? 6379;
        document.getElementById('redis_password').value = c.redis_password || '';
        document.getElementById('platform_superadmin_password').value = c.platform_superadmin_password || '';
        document.getElementById('launch_mobile').checked = !!c.launch_mobile;
        document.getElementById('git_remote_url').value = c.git_remote_url || '';
        document.getElementById('git_branch').value = c.git_branch || 'develop';
        document.getElementById('caddy_domain').value = c.caddy_domain || '';
        document.getElementById('caddy_proxy_port').value = c.caddy_proxy_port ?? 8080;
        document.getElementById('caddy_enable_letsencrypt').checked = !!c.caddy_enable_letsencrypt;
        onDeployModeChange(false);
      } catch (_) {}
    }

    async function previewCaddyfile() {
      const el = document.getElementById('caddyfilePreview');
      try {
        const r = await fetch(API + '/caddyfile-preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            config: {
              caddy_domain: document.getElementById('caddy_domain').value.trim(),
              caddy_proxy_port: parseInt(document.getElementById('caddy_proxy_port').value, 10) || 8080,
              caddy_enable_letsencrypt: document.getElementById('caddy_enable_letsencrypt').checked
            }
          })
        });
        const data = await r.json();
        el.textContent = data.content || '';
        el.style.display = 'block';
      } catch (e) {
        el.textContent = '预览失败：' + (e.message || '');
        el.style.display = 'block';
      }
    }

    async function saveConfig() {
      const btn = document.getElementById('btnSaveConfig');
      btn.disabled = true;
      try {
        await fetchApi('/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            config: {
              deploy_mode: document.querySelector('input[name="deploy_mode"]:checked')?.value || 'local',
              db_host: document.getElementById('db_host').value,
              db_port: parseInt(document.getElementById('db_port').value, 10),
              db_user: document.getElementById('db_user').value,
              db_password: document.getElementById('db_password').value,
              db_name: document.getElementById('db_name').value,
              redis_host: document.getElementById('redis_host').value,
              redis_port: parseInt(document.getElementById('redis_port').value, 10),
              redis_password: document.getElementById('redis_password').value,
              backend_port: 8200,
              frontend_port: 8100,
              platform_superadmin_password: document.getElementById('platform_superadmin_password').value,
              git_remote_url: document.getElementById('git_remote_url').value.trim(),
              git_branch: document.getElementById('git_branch').value.trim() || 'develop',
              caddy_domain: document.getElementById('caddy_domain').value.trim(),
              caddy_proxy_port: parseInt(document.getElementById('caddy_proxy_port').value, 10) || 8080,
              caddy_enable_letsencrypt: document.getElementById('caddy_enable_letsencrypt').checked,
              launch_mobile: document.getElementById('launch_mobile').checked
            }
          })
        });
        btn.textContent = '已保存';
        document.getElementById('btnNextDeploy').style.display = 'inline-flex';
      } catch (e) {
        alert('保存失败：' + (e.message || ''));
      }
      btn.disabled = false;
    }

    async function runDeployStep() {
      const btn = document.getElementById('btnDeploy');
      document.getElementById('deployError').style.display = 'none';
      btn.disabled = true;
      try {
        if (deployStep === 0) {
          await fetchApi('/generate-env', { method: 'POST' });
          document.getElementById('deployStep1').classList.add('done');
        } else if (deployStep === 1) {
          await fetchApi('/migrate', { method: 'POST' });
          document.getElementById('deployStep2').classList.add('done');
        } else {
          await fetchApi('/launch', { method: 'POST' });
          document.getElementById('deployStep3').classList.add('done');
          goStep(5);
          return;
        }
        deployStep++;
      } catch (e) {
        const errEl = document.getElementById('deployError');
        errEl.style.display = 'block';
        errEl.textContent = '执行失败：' + (e.message || '请检查 PostgreSQL、Redis 是否已启动，以及配置是否正确');
      }
      btn.disabled = false;
    }

    async function runLaunchProd() {
      const btn = document.getElementById('btnDeployProd');
      document.getElementById('deployError').style.display = 'none';
      btn.disabled = true;
      try {
        await fetchApi('/launch-prod', { method: 'POST' });
        document.getElementById('deployStep4').classList.add('done');
        goStep(5);
      } catch (e) {
        const errEl = document.getElementById('deployError');
        errEl.style.display = 'block';
        errEl.textContent = '生产启动失败：' + (e.message || '请确保已完成步骤 1、2，且已安装 Caddy');
      }
      btn.disabled = false;
    }

    async function runUpdateProd(btn) {
      if (btn) btn.disabled = true;
      const errEl = document.getElementById('deployError');
      if (errEl) errEl.style.display = 'none';
      try {
        await fetchApi('/update-prod', { method: 'POST' });
        alert('生产更新已启动，请稍候（约 1–2 分钟）。完成后访问生产地址即可。');
        if (currentStep === 4) goStep(5);
      } catch (e) {
        if (errEl) {
          errEl.style.display = 'block';
          errEl.textContent = '生产更新失败：' + (e.message || '请确保已部署过生产环境，且 git 可拉取代码');
        } else {
          alert('生产更新失败：' + (e.message || ''));
        }
      }
      if (btn) btn.disabled = false;
    }

    checkAuth();
  </script>
</body>
</html>
