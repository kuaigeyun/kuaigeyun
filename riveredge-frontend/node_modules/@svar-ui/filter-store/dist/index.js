var N=new Date().valueOf(),_=()=>N++,B=class{constructor(t){const e={id:0,$level:0,data:[],parent:null},s=new Map;s.set(0,e),this._pool=s,t&&t.length&&this.parse(t,0)}parse(t,e){const s=this._pool;for(let n=0;n<t.length;n++){const r=t[n];r.parent=r.parent||e,r.data=null,s.set(r.id,r)}for(let n=0;n<t.length;n++){const r=t[n],a=s.get(r.parent);a&&(a.data||(a.data=[]),a.data.push(r))}const i=s.get(e);this.setLevel(i,i.$level+1,!1)}add(t,e){const s=this._pool.get(t.parent||0);t.$level=s.$level+1,this._pool.set(t.id,t),s.data?e===-1?s.data=[...s.data,t]:x(s,e,t):s.data=[t]}addAfter(t,e){if(!e)return this.add(t,-1);const s=this.byId(e),i=this.byId(s.parent),n=g(i,s.id)+1;t.parent=i.id,t.$level=i.$level+1,this.add(t,n)}remove(t){const e=this._pool.get(t);this._remove(e);const s=this._pool.get(e.parent);s.data=s.data.filter(i=>i.id!=t),this._clearBranch(s)}_remove(t){t.data&&t.data.forEach(e=>this._remove(e)),this._pool.delete(t.id)}update(t,e){let s=this._pool.get(t);const i=this._pool.get(s.parent),n=g(i,s.id);s={...s,...e},i&&n>=0&&(i.data[n]=s,i.data=[...i.data]),this._pool.set(s.id,s)}move(t,e,s){const i=this._pool.get(t),n=e==="child",r=this._pool.get(s),a=r.$level+(n?1:0);if(!i||!r)return;const l=this._pool.get(i.parent),d=n?r:this._pool.get(r.parent);d.data||(d.data=[]);const o=g(l,i.id);z(l,o);const p=n?d.data.length:g(d,r.id)+(e==="after"?1:0);if(x(d,p,i),l.id===d.id&&o===p)return null;i.parent=d.id,i.$level!==a&&(i.$level=a,this.setLevel(i,a+1,!0)),this.update(i.id,i),this._clearBranch(l)}_clearBranch(t){t.data&&!t.data.length&&(t.open&&delete t.open,this.update(t.id,{data:null}))}toArray(){const t=[],e=this._pool.get(0).data;return e&&S(e,t),t}byId(t){return this._pool.get(t)}getBranch(t){return this._pool.get(t).data}forEach(t){this._pool.forEach((e,s)=>{s!==0&&t(e)})}eachChild(t,e){const s=this.byId(e);!s||!s.data||s.data.forEach((i,n)=>{t(this.byId(i.id),n),this.eachChild(t,i.id)})}setLevel(t,e,s){t.data&&(t.data=t.data.map(i=>(s&&(i={...i},this._pool.set(i.id,i)),i.$level=e,i.data&&this.setLevel(i,e+1,s),i)))}};function S(t,e){t.forEach(s=>{e.push(s),s.open===!0&&S(s.data,e)})}function z(t,e){const s=[...t.data];s.splice(e,1),t.data=s}function x(t,e,s){const i=[...t.data];i.splice(e,0,s),t.data=i}function g(t,e){return t?.data.findIndex(s=>s.id===e)}var m=2,M=class{constructor(t){t&&(this._writable=t.writable,this._async=t.async),this._values={},this._state={}}setState(t,e=0){const s={};return this._wrapProperties(t,this._state,this._values,"",s,e),s}getState(){return this._values}getReactive(){return this._state}_wrapProperties(t,e,s,i,n,r){for(const a in t){const l=e[a],d=s[a],o=t[a];if(l&&(d===o&&typeof o!="object"||o instanceof Date&&d instanceof Date&&d.getTime()===o.getTime()))continue;const p=i+(i?".":"")+a;l?(l.__parse(o,p,n,r)&&(s[a]=o),r&m?n[p]=l.__trigger:l.__trigger()):(o&&o.__reactive?e[a]=this._wrapNested(o,o,p,n):e[a]=this._wrapWritable(o),s[a]=o),n[p]=n[p]||null}}_wrapNested(t,e,s,i){const n=this._wrapWritable(t);return this._wrapProperties(t,n,e,s,i,0),n.__parse=(r,a,l,d)=>(this._wrapProperties(r,n,e,a,l,d),!1),n}_wrapWritable(t){const e=[],s=function(){for(let i=0;i<e.length;i++)e[i](t)};return{subscribe:i=>(e.push(i),this._async?setTimeout(i,1,t):i(t),()=>{const n=e.indexOf(i);n>=0&&e.splice(n,1)}),__trigger:()=>{e.length&&(this._async?setTimeout(s,1):s())},__parse:function(i){return t=i,!0}}}},R=class{constructor(t,e,s,i){typeof t=="function"?this._setter=t:this._setter=t.setState.bind(t),this._routes=e,this._parsers=s,this._prev={},this._triggers=new Map,this._sources=new Map,this._routes.forEach(n=>{n.in.forEach(r=>{const a=this._triggers.get(r)||[];a.push(n),this._triggers.set(r,a)}),n.out.forEach(r=>{const a=this._sources.get(r)||{};n.in.forEach(l=>a[l]=!0),this._sources.set(r,a)})}),this._routes.forEach(n=>{n.length=Math.max(...n.in.map(r=>O(r,this._sources,1)))}),this._bus=i}init(t){const e={};for(const s in t)if(this._prev[s]!==t[s]){const i=this._parsers[s];e[s]=i?i(t[s]):t[s]}this._prev=this._prev?{...this._prev,...t}:{...t},this.setState(e),this._bus&&this._bus.exec("init-state",e)}setStateAsync(t){const e=this._setter(t,m);return this._async?Object.assign(this._async.signals,e):this._async={signals:e,timer:setTimeout(this._applyState.bind(this),1)},e}_applyState(){const t=this._async;if(t){this._async=null,this._triggerUpdates(t.signals,[]);for(const e in t.signals){const s=t.signals[e];s&&s()}}}setState(t,e=[]){const s=this._setter(t);return this._triggerUpdates(s,e),s}_triggerUpdates(t,e){const s=Object.keys(t),i=!e.length;e=e||[];for(let n=0;n<s.length;n++){const r=s[n],a=this._triggers.get(r);a&&a.forEach(l=>{e.indexOf(l)==-1&&e.push(l)})}i&&this._execNext(e)}_execNext(t){for(;t.length;){t.sort((s,i)=>s.length<i.length?1:-1);const e=t[t.length-1];t.splice(t.length-1),e.exec(t)}}};function O(t,e,s){const i=e.get(t);if(!i)return s;const n=Object.keys(i).map(r=>O(r,e,s+1));return Math.max(...n)}var W=class{constructor(){this._nextHandler=null,this._handlers={},this._tag=new WeakMap,this.exec=this.exec.bind(this)}on(t,e,s){let i=this._handlers[t];i?s&&s.intercept?i.unshift(e):i.push(e):i=this._handlers[t]=[e],s&&s.tag&&this._tag.set(e,s.tag)}intercept(t,e,s){this.on(t,e,{...s,intercept:!0})}detach(t){for(const e in this._handlers){const s=this._handlers[e];for(let i=s.length-1;i>=0;i--)this._tag.get(s[i])===t&&s.splice(i,1)}}async exec(t,e){const s=this._handlers[t];if(s)for(let i=0;i<s.length;i++){const n=s[i](e);if(n===!1||n&&n.then&&await n===!1)return}return this._nextHandler&&await this._nextHandler.exec(t,e),e}setNext(t){return this._nextHandler=t}};const h="number",u="text",c="date",f="tuple",y=[{id:"greater",label:"greater",short:">",type:[h,c,f],handler:(t,e)=>t>e},{id:"less",label:"less",short:"<",type:[h,c,f],handler:(t,e)=>t<e},{id:"greaterOrEqual",label:"greater or equal",short:">=",type:[h,c,f],handler:(t,e)=>t>=e},{id:"lessOrEqual",label:"less or equal",short:"<=",type:[h,c,f],handler:(t,e)=>t<=e},{id:"equal",label:"equal",short:"=",type:[h,f],handler:(t,e)=>t==e},{id:"equal",label:"equal",short:"=",type:[u],handler:(t,e)=>t.toLowerCase()===e.toLowerCase()},{id:"equal",label:"equal",short:"=",default:!0,type:[c],handler:(t,e)=>!t||!e?!1:t.valueOf()===e.valueOf()},{id:"notEqual",label:"not equal",short:"!=",type:[h,f],handler:(t,e)=>t!=e},{id:"notEqual",label:"not equal",short:"!=",type:[u],handler:(t,e)=>t.toLowerCase()!==e.toLowerCase()},{id:"notEqual",label:"not equal",short:"!=",type:[c],handler:(t,e)=>!t||!e?!0:t.valueOf()!==e.valueOf()},{id:"contains",label:"contains",default:!0,type:[h,u],handler:(t,e)=>t.toString().toLowerCase().indexOf(e.toString().toLowerCase())!==-1},{id:"notContains",label:"not contains",type:[h,u],handler:(t,e)=>t.toString().toLowerCase().indexOf(e.toString().toLowerCase())===-1},{id:"beginsWith",label:"begins with",type:[h,u],handler:(t,e)=>(t=t.toString().toLowerCase(),e=e.toString().toLowerCase(),t.lastIndexOf(e,0)===0)},{id:"notBeginsWith",label:"not begins with",type:[h,u],handler:(t,e)=>(t=t.toString().toLowerCase(),e=e.toString().toLowerCase(),t.lastIndexOf(e,0)!==0)},{id:"endsWith",label:"ends with",type:[h,u],handler:(t,e)=>(t=t.toString().toLowerCase(),e=e.toString().toLowerCase(),t.indexOf(e,t.length-e.length)!==-1)},{id:"notEndsWith",label:"not ends with",type:[h,u],handler:(t,e)=>(t=t.toString().toLowerCase(),e=e.toString().toLowerCase(),t.indexOf(e,t.length-e.length)===-1)},{id:"between",label:"between",range:!0,type:[c],handler:(t,e)=>(!e.start||t>e.start)&&(!e.end||t<e.end)},{id:"notBetween",label:"not between",range:!0,type:[c],handler:(t,e)=>!e.start||t<=e.start||!e.end||t>=e.end}];function v(t){return typeof t>"u"?y:y.filter(e=>e.type.indexOf(t)!==-1)}function b(t,e){e=e||u;let s=y.filter(i=>i.id===t);return s.length>1&&(s=s.filter(i=>i.type.indexOf(e)!==-1)),s[0]}class F extends B{constructor(e){super(),this.parseRules(e)}getRoot(){return this.getBranch(0)[0]}parseRules(e){this.parse(A(e),0)}remove(e){let s=this.byId(e);for(super.remove(e);s.parent;)s=this.byId(s.parent),s.parent&&!s.data&&super.remove(s.id)}serialize(){const e=this.getBranch(0)[0];return E(e)}}function A(t){const e=[];return C([t],0,e),e}function C(t,e,s){t.forEach(i=>{const n={...i,parent:e,id:_(),$level:0};s.push(n),i.rules&&C(i.rules,n.id,s)})}function E(t){if(t.data&&t.data.length)return{glue:t.glue,rules:t.data.map(E).filter(e=>e!==null)};{const e={field:t.field};if(t.filter&&(e.filter=t.filter,e.value=t.value,e.type=t.type),t.includes&&(e.includes=[...t.includes]),t.predicate&&(e.predicate=t.predicate),t.filter&&(!t.includes||!t.includes.length)){const s=b(t.filter,t.type);if(!j(t.value,s.type))return null}return e}}const D={[h]:P,[c]:T,[u]:()=>!0,[f]:()=>!0};function j(t,e){for(let s=0;s<e.length;s++)if(D[e[s]](t))return!0;return!1}function P(t){return!isNaN(parseFloat(t))}function T(t){return t&&(t.start||t)instanceof Date}class H extends M{in;_router;constructor(e){super({writable:e,async:!1});const s=this.in=new W;this._router=new R(super.setState.bind(this),[],{value:i=>new F(i)}),s.on("edit-rule",({id:i})=>{const{value:n,_editor:r}=this.getState();if(r&&(!i||i!=r.id)){const a=n.byId(r.id);(a.$temp||!a.includes&&!a.value)&&(n.remove(r.id),this.setState({value:n}))}i?this.setState({_editor:{id:i}}):this.setState({_editor:null})}),s.on("delete-rule",({id:i})=>{const{value:n}=this.getState();n.byId(i)&&(n.remove(i),this.onChange(n),this.setState({value:n}))}),s.on("add-rule",({after:i,rule:n,edit:r})=>{const{value:a}=this.getState();!i&&!n.parent&&(n.parent=a.getBranch(0)[0].id),a.addAfter(this._fixRule(n),i),this.setState({value:a}),r&&s.exec("edit-rule",{id:n.id})}),s.on("add-group",({after:i,rule:n,edit:r})=>{const{value:a}=this.getState(),l={id:_(),glue:"and"};a.addAfter(l,i),n=this._fixRule(n),n.parent=l.id,a.add(n,0),this.setState({value:a}),r&&s.exec("edit-rule",{id:n.id})}),s.on("toggle-glue",({id:i})=>{const{value:n}=this.getState();n.update(i,{glue:n.byId(i).glue==="and"?"or":"and"}),this.onChange(n),this.setState({value:n})}),s.on("update-rule",({id:i,rule:n})=>{const{value:r}=this.getState();n.$temp=!1,r.update(i,n),this.onChange(r),this.setState({value:r})})}onChange(e){const s=e.serialize();this.in.exec("change",{value:s})}init(e){e.value=this.normalizeValue(e.value,e.fields),e.options=this.normalizeOptions(e.options),this._router.init({_editor:null,...e})}setState(e,s){return this._router.setState(e,s)}getValue(){return this.getState().value.serialize()}normalizeOptions(e){return typeof e=="function"?e:e&&typeof e=="object"?s=>e[s]||[]:null}normalizeValue(e,s){return{glue:e.glue||"and",rules:e.rules?e.rules.map(i=>{if(i.field){const n=i,r={...n};if(!r.type||!r.predicate){const a=s.find(l=>l.id===n.field);r.type=n.type??a.type,a.predicate&&(r.predicate=a.predicate)}return r.includes=n.includes?[...n.includes]:[],r.filter=n.filter??v(r.type).find(a=>a.default).id,r}return i.rules?this.normalizeValue(i,s):i}):[]}}_fixRule(e){const{fields:s}=this.getState();e.id=e.id||_(),e.field||(e.field=s[0].id);const i=s.find(({id:n})=>n===e.field);if(e.filter||(e.filter=v(i.type).find(n=>n.default).id,e.type=i.type,e.value=""),!e.predicate){const n=s.find(r=>r.id===e.field).predicate;n&&(e.predicate=n)}return e.includes||(e.includes=[]),e}}const L=t=>t,q=(t,e)=>t-e,I={month:t=>t.getMonth(),year:t=>t.getFullYear()};function V(t){return e=>{for(let s=0;s<t.length;s++)if(t[s](e))return!0;return!1}}function k(t){return e=>{for(let s=0;s<t.length;s++)if(!t[s](e))return!1;return!0}}const U={or:V,and:k};function Y(t,e){const s=w(t,{orNull:!0});return s===null?e&&e.orNull?null:i=>i:i=>i.filter(s)}function w(t,e){let s=[];return t&&t.rules&&(t.rules.forEach(i=>{i.rules?s.push(w(i)):s.push(G(i))}),s=s.filter(i=>i!==null)),s.length?U[t.glue||"and"](s):e&&e.orNull?null:()=>!0}function G(t){const e=I[t.predicate]||L;if(t.includes&&t.includes.length)return s=>t.includes.includes(e(s[t.field]));if(t.filter){const s=b(t.filter,t.type).handler;return i=>s(e(i[t.field]),t.value)}return null}function J(t,e,s){return s?{glue:"or",rules:t.map(i=>({field:i.id,type:i.type||"text",filter:e,value:s}))}:null}function $(t,e,s){const i=new Set,n=[],r=s&&s.predicate?I[s.predicate]:L;if(t.forEach(a=>{const l=r(a[e]);(l||l===0)&&(i.has(l)||(i.add(l),n.push(l)))}),!s||s.sort!==!1){let a;s?a=s.sort||(s.type==="date"||s.type==="number"?q:null):n.length&&(typeof n[0]=="number"||n[0]instanceof Date)&&(a=q),typeof a=="function"?n.sort(a):n.sort()}return n}function K(t,e){const s={};if(!e&&!t.length)return s;if(!e){e=[];for(const i in t[0])e.push({id:i})}return e.forEach(i=>{Object.defineProperty(s,i.id,{get:()=>$(t,i.id.toString(),i)})}),s}export{H as DataStore,Y as createArrayFilter,w as createFilter,J as createFilterRule,b as getFilter,v as getFilters,$ as getOptions,K as getOptionsMap};
