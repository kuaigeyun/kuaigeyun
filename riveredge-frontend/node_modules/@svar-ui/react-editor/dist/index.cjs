"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("react/jsx-runtime"),y=require("@svar-ui/react-core"),p=require("react"),B=require("@svar-ui/lib-state"),se=require("@svar-ui/lib-react"),ue=require("@svar-ui/react-toolbar"),J=require("@svar-ui/lib-dom"),Q={};function ee(t){return typeof t<"u"?Q[t]||t:Q.text}function H(t,e){Q[t]=e}const oe={editor:{}};function U(t){const{editors:e,data:s,css:a="",errors:i,focus:u=!1,onClick:n,children:o,onChange:l}=t,m=p.useRef(null);p.useEffect(()=>{if(u){const f=document.activeElement;if(f&&m.current&&m.current.contains(f))return;const x=m.current?m.current.querySelector("input:not([disabled]), textarea:not([disabled]), select:not([disabled])"):null;x&&setTimeout(()=>{typeof x.select=="function"&&x.select(),typeof x.focus=="function"&&x.focus()},300)}},[]);const c=p.useContext(y.context.i18n),w=p.useMemo(()=>c.getGroup("editor"),[c]),h=p.useMemo(()=>e.config[0].comp==="readonly"&&e.config.every(f=>!Object.keys(s).includes(f.key)),[e,s]);return r.jsxs("div",{className:"wx-s2aE1xdZ wx-sections "+a,ref:m,children:[o,h?r.jsx("div",{className:"wx-s2aE1xdZ wx-overlay",children:w("No data")}):null,e.config.map(f=>{if(!f.hidden){const{key:x,onChange:C,...j}=f;if(f.comp==="readonly"||f.comp==="section"){const M=ee(f.comp);return r.jsx(M,{fieldKey:x,label:f.label,value:s[x],...j,onClick:n},x)}else{const M=ee(f.comp);return r.jsxs("div",{children:[r.jsx(y.Field,{label:f.labelTemplate?f.labelTemplate(s[x]):f.label??"",required:f.required,children:r.jsx(M,{fieldKey:x,...j,onChange:C||(S=>{l&&l({value:S.value,key:x,input:S.input})}),label:void 0,error:i&&i[x],value:s[x]},x)}),i&&i[x]&&f.validationMessage?r.jsx("div",{className:"wx-s2aE1xdZ wx-message",children:f.validationMessage}):null]},x)}}return null})]})}function fe(t){if(typeof t=="string"&&t.includes(".")){const e=t.split(".");return s=>{let a=s;return e.forEach(i=>{a=a[i]}),a}}return e=>e[t]}function de(t){if(typeof t=="string"&&t.includes(".")){const e=t.split(".");return(s,a)=>{let i=s;e.forEach((u,n)=>{n===e.length-1?i[u]=a:i=i[u]})}}return(e,s)=>e[t]=s}function me(t){const e=t.map(n=>{const o={...n};return n.config&&Object.assign(o,n.config),o.key=n.key||B.uid(),o.setter=n.setter||de(n.key),o.getter=n.getter||fe(n.key),o}),s=n=>{const o={};return e.forEach(l=>{l.comp!=="section"&&(l.getter?o[l.key]=l.getter(n):o[l.key]=n[l.key])}),o},a=(n,o,l)=>((l.length?l.map(c=>e.find(w=>w.key===c)):e).forEach(c=>{c.setter?c.setter(n,o[c.key]):n[c.key]=o[c.key]}),n),i=(n,o)=>{const l=s(n),m=[];return e.forEach(c=>{const w=l[c.key],h=o[c.key];!B.isSame(w,h)&&(w!==void 0||h)&&m.push(c.key)}),m},u=(n,o,l)=>{let m=0;const c={};return(o?.length?o.map(h=>e.find(f=>f.key===h)):e).forEach(h=>{h.required&&!n[h.key]?(c[h.key]={errorType:"required"},h.validationMessage=h.validationMessage??l("This field is required"),m++):h.validation&&!h.validation(n[h.key])&&(c[h.key]={errorType:"validation"},h.validationMessage=h.validationMessage??l("Invalid value"),m++)}),m>0?c:null};return{config:e.filter(n=>n.comp!=="hidden"),getValues:s,setValues:a,diff:i,validateValues:u}}function re({values:t,items:e,css:s,activeBatch:a,autoSave:i,focus:u,readonly:n,topBar:o=!0,bottomBar:l=!0,layout:m="default",placement:c="inline",view:w,children:h,onChange:f,onSave:x,onAction:C,onValidation:j,hotkeys:M}){const R=p.useContext(y.context.i18n).getGroup("editor"),[v,D]=se.useWritableProp(t),[O,F]=p.useState(null),N=p.useMemo(()=>{const g=me(e);O&&g.config.forEach(d=>{d.comp==="section"&&d.key===O&&(d.sectionMode==="accordion"?d.activeSection||(g.config.forEach(V=>{V.comp==="section"&&V.key!==d.key&&(V.activeSection=!1)}),d.activeSection=!0):d.activeSection=!d.activeSection)});let E=new Set,q=null;return g.config.forEach(d=>{d.sectionMode==="exclusive"&&d.activeSection&&(q=d.key),d.activeSection&&E.add(d.key)}),g.config.forEach(d=>{d.hidden=d.hidden||a&&a!==d.batch||q&&d.key!=q&&d.section!==q||d.section&&!E.has(d.section)}),n?{...g,config:g.config.map(d=>({...d,comp:"readonly"})),diff:()=>[]}:g},[e,O,a,n]),[A,b]=p.useState({}),[T,$]=p.useState({}),k=v;p.useEffect(()=>{v!==void 0&&(b(B.deepCopy(v)),$(B.deepCopy(v)),k.errors&&(k.errors=K()))},[v]);const[W,I]=p.useState([]);p.useEffect(()=>{v&&I([])},[v]);function Y(g){return[...new Set(g)]}function K(g){const E=N.validateValues(A,g,R);return B.isSame(E,k.errors)||j&&j({errors:E,values:A}),E}function ie(g,E){if(i&&!k.errors){const q=N.setValues(v,E??T,g);D(q),x&&x({changes:g,values:q})}else I(g)}function ce({value:g,key:E,input:q}){let d={...T||{},[E]:g};const V={key:E,value:g,update:d};if(q&&(V.input=q),f&&f(V),!v)return;d=V.update,$(d);const P=N.diff(v,d),ae=N.setValues({...A||{}},d,Y([...P,E]));if(b(ae),P.length){const G=i?[]:Y([...P,...Object.keys(k.errors??{}),E]);k.errors=K(G),ie(P,d)}else{const G=Object.keys(k.errors??{});G.length&&(k.errors=K(G)),I([])}}function le(){if(W.length&&(i||(k.errors=K()),!k.errors)){x&&x({changes:W,values:A});const g=N.setValues(v,T,W);D(g),I([]),D({...A})}}function X({item:g}){g.id==="save"?le():g.id==="toggle-section"&&F(g.key),C&&C({item:g,values:A,changes:W})}return r.jsx(w,{topBar:o,bottomBar:l,placement:c,layout:m,readonly:n,autoSave:i,css:s,data:T,editors:N,focus:u,hotkeys:M,errors:k.errors,onClick:X,onKeyDown:X,onChange:ce,children:h})}function xe({values:t={},items:e=[],css:s="",activeBatch:a=null,focus:i=!1,autoSave:u=!0,readonly:n=!1,children:o,...l}){const m={};for(const c in l){if(/^on[a-z]/.test(c)){const w="on"+c.charAt(2).toUpperCase()+c.slice(3);if(w in l)continue;m[w]=l[c];continue}m[c]=l[c]}return r.jsx(y.Locale,{words:oe,optional:!0,children:r.jsx("div",{className:"wx-H902AF2Y wx-content",children:r.jsx(re,{view:U,values:t,items:e,css:s,focus:i,activeBatch:a,autoSave:u,readonly:n,...m,children:o})})})}function pe(t){const{editors:e,data:s,layout:a,errors:i,focus:u,onClick:n,onChange:o}=t,l=p.useMemo(()=>{let m=[];if(a==="columns"&&(m=[{...e,config:[]},{...e,config:[]}],e.config.forEach(c=>{const w=c.column==="left"?0:1;m[w].config.push(c)}),m[0].config.length)){const c=m[0].config[0];c.comp==="text"&&(m[0][0]={...c,css:"title",label:""})}return m},[a,e]);return a==="columns"?r.jsxs("div",{className:"wx-bNrSbszs wx-cols",children:[r.jsx("div",{className:"wx-bNrSbszs wx-left",children:r.jsx(U,{editors:l[0],data:s,errors:i,onClick:n,onChange:o})}),r.jsx("div",{className:"wx-bNrSbszs wx-right",children:r.jsx(U,{editors:l[1],data:s,focus:u,errors:i,onClick:n,onChange:o})})]}):r.jsx(U,{editors:e,data:s,focus:u,errors:i,onClick:n,onChange:o})}function te({items:t,values:e=null,top:s=!0,onClick:a,onChange:i}){const u=p.useCallback(({item:n,value:o})=>{i&&i({key:n.key,value:o})},[i]);return t.length?r.jsx("div",{className:`wx-66OW1j0R wx-editor-toolbar ${s?"wx-topbar":"wx-bottom"}`,children:r.jsx(ue.Toolbar,{items:t,values:e,onClick:a,onChange:u})}):null}const z=()=>({comp:"spacer"}),L=t=>({comp:"button",text:t("Cancel"),id:"cancel"}),Z=t=>({type:"primary",comp:"button",text:t("Save"),id:"save"}),ne=()=>({comp:"icon",icon:"wxi-close",id:"close"});function _(t){const{data:e,editors:s,focus:a,css:i,topBar:u,bottomBar:n,layout:o,placement:l,errors:m,readonly:c,autoSave:w,children:h,onClick:f,onKeyDown:x,onChange:C,hotkeys:j}=t,M=p.useContext(y.context.i18n),S=p.useMemo(()=>M.getGroup("editor"),[M]),R=p.useMemo(()=>u===!0&&n===!0,[u,n]),v=p.useMemo(()=>{let b=u&&u.items?u.items.map(T=>({...T})):[];return R&&(c?b=[z(),ne()]:(w?b=[z(),ne()]:l!=="modal"&&(b=[z(),L(S),Z(S)]),o==="columns"&&!b.length&&(b=[z(),Z(S),L(S)]))),b},[u,R,c,w,l,o,S]),D=p.useMemo(()=>{let b=n&&n.items?n.items.map(T=>({...T})):[];return R&&(c||(l==="modal"&&!w&&(b=[z(),Z(S),L(S)]),o==="columns"&&v.length&&(b=[]))),b},[n,R,c,l,w,o,v,S]),O=p.useMemo(()=>[...v,...D],[v,D]),F=p.useRef(null),N=p.useRef(null);N.current=(b,...T)=>{const $=O.findIndex(I=>T.includes(I.id));if($===-1)return!1;const k=b.target,W=O[$];b.key=="Escape"&&(k.closest(".wx-combo")||k.closest(".wx-multicombo")||k.closest(".wx-richselect"))||b.key=="Delete"&&(k.tagName==="INPUT"||k.tagName==="TEXTAREA")||(b.preventDefault(),x&&x({item:W}))};const A=p.useMemo(()=>j===!1?{}:{"ctrl+s":b=>N.current(b,"save"),escape:b=>N.current(b,"cancel","close"),"ctrl+d":b=>N.current(b,"delete"),...j||{}},[j]);return se.useHotkeys(A,F),r.jsxs("div",{className:i?"wx-85HDaNoA "+i:"wx-85HDaNoA",ref:F,children:[r.jsx(te,{...u&&typeof u=="object"?u:{},items:v,values:e,onClick:f,onChange:C}),r.jsxs("div",{className:`wx-85HDaNoA wx-content${o==="columns"?" wx-layout-columns":""}`,children:[h,r.jsx(pe,{editors:s,layout:o,data:e,focus:a,errors:m,onClick:f,onChange:C}),r.jsx(te,{...n&&typeof n=="object"?n:{},items:D,values:e,top:!1,onClick:f,onChange:C})]})]})}function ge(t){const{css:e,onClick:s,placement:a,...i}=t;function u(){s&&s({item:{id:"close"}})}return a==="modal"?r.jsx(y.ModalArea,{children:r.jsx(_,{css:`wx-panel ${e}`,onClick:s,placement:a,...i})}):a==="sidebar"?r.jsx(y.SideArea,{onCancel:u,children:r.jsx(_,{css:`wx-panel ${e}`,onClick:s,placement:a,...i})}):r.jsx(_,{css:`wx-inline-form ${e}`,onClick:s,placement:a,...i})}function he(t){const{values:e={},items:s=[],css:a="",activeBatch:i=null,topBar:u=!0,bottomBar:n=!0,focus:o=!1,autoSave:l=!1,layout:m="default",readonly:c=!1,placement:w="inline",children:h,...f}=t,x=Object.keys(f).reduce((C,j)=>{if(/^on[a-z]/.test(j)){const M="on"+j.charAt(2).toUpperCase()+j.slice(3);M in f?C[j]=f[j]:C[M]=f[j]}else C[j]=f[j];return C},{});return r.jsx(y.Locale,{words:oe,optional:!0,children:r.jsx(re,{view:ge,values:e,items:s,css:a,activeBatch:i,topBar:u,bottomBar:n,focus:o,autoSave:l,layout:m,readonly:c,placement:w,...x,children:h})})}function be({fonts:t=!0,children:e}){return e?r.jsx(y.Material,{fonts:t,children:e}):r.jsx(y.Material,{fonts:t})}function we({fonts:t=!0,children:e}){return e?r.jsx(y.Willow,{fonts:t,children:e}):r.jsx(y.Willow,{fonts:t})}function ye(t){const{fonts:e=!0,children:s}=t;return s?r.jsx(y.WillowDark,{fonts:e,children:s}):r.jsx(y.WillowDark,{fonts:e})}function je({value:t,options:e,label:s}){const i=p.useContext(y.context.i18n).getGroup("editor"),u=p.useMemo(()=>{let n=t;if(typeof t=="boolean"&&(n=i(t?"Yes":"No")),e){const o=e.find(l=>l.id===t);o&&(n=o.label)}return n},[t,e,i]);return u||u===0?r.jsx(y.Field,{label:s,children:u}):null}function ve({fieldKey:t,label:e,activeSection:s,onClick:a}){return r.jsxs("div",{className:`wx-OmgQq65I wx-section${s?" wx-section-active":""}`,onClick:()=>a&&a({item:{id:"toggle-section",key:s?null:t}}),children:[r.jsx("h3",{children:e}),r.jsx("i",{className:`wx-OmgQq65I wxi-angle-${s?"down":"right"} wx-icon`})]})}H("text",y.Text);H("textarea",y.TextArea);H("checkbox",y.Checkbox);H("readonly",je);H("section",ve);J.setEnv(J.env);exports.Editor=he;exports.Form=xe;exports.Material=be;exports.Willow=we;exports.WillowDark=ye;exports.registerEditorItem=H;
//# sourceMappingURL=index.cjs.map
