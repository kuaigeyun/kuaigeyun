"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("react/jsx-runtime"),e=require("react"),a=require("@svar-ui/react-core"),Re=require("@svar-ui/react-menu"),se=require("@svar-ui/lib-dom"),U=require("@svar-ui/lib-react"),de=require("@svar-ui/filter-locales"),V=require("@svar-ui/filter-store"),He=require("@svar-ui/lib-state"),te=e.createContext(null);function Qe(s){const{fields:l=null,fieldsSelector:y=!0,field:p=null,buttons:b=!0,options:h=null,includes:F=null,type:C="text",filter:i="",value:d="",format:w=null,predicate:m=null}=s,j=s.onApply||s.onapply,N=s.onCancel||s.oncancel,v=s.onChange||s.onchange,f=e.useContext(a.context.i18n),x=f.getRaw(),A=x.filter?.dateFormat||x.formats?.dateFormat,T=se.dateToString(A,x.calendar),$=f.getGroup("filter"),g=1,E=2,q=4,L=8,B=16,z=32,r=64,[o,u]=e.useState(),R=e.useRef(),[k,J]=e.useState(),I=e.useRef(),[ce,Fe]=e.useState(),H=e.useRef(),[K,ue]=e.useState(),O=e.useRef(),[fe,Ne]=e.useState([]),P=e.useRef([]),[Ae,xe]=e.useState(),Y=e.useRef(),[,pe]=e.useState(),X=e.useRef(),[,me]=e.useState(),ne=e.useRef(),[M,_e]=e.useState(!1),[ge,Oe]=e.useState(null);async function De(n){if(!h||typeof h!="function")return;const c=await h(n);Oe(c||[])}const re=e.useRef(0),ie=e.useRef(null);function he(n){return n?n.toString():""}function _(n,c,S){n(S),c.current=S}function D(n,c){switch(n){case g:if(I.current!==c)return _(J,I,c),n;break;case B:if(H.current!==c)return _(Fe,H,c),n;break;case E:if(R.current!==c)return _(u,R,c),n;break;case q:if(O.current!==c)return _(ue,O,c),n;break;case L:if(he(P.current)!=he(c))return _(Ne,P,c||[]),n;break;case r:if(Y.current!==c)return _(xe,Y,c||[]),n;break}return 0}function G(n){re.current=re.current|n,ie.current||(ie.current=setTimeout(()=>{const c=re.current;ie.current=null,re.current=0,Te(c)}))}const[Ee,we]=e.useState(),oe=e.useRef(),[ke,ye]=e.useState([]),Z=e.useRef([]),[,Pe]=e.useState(),be=e.useRef(),[Ve,$e]=e.useState(),Me=e.useRef();function Te(n){if(n&g&&l){_(xe,Y,null);const c=l.find(W=>W.id===I.current),S=O.current instanceof Date||O.current&&typeof O.current=="object",Q=c.type==="tuple"||H.current=="tuple";if(S&&c.type!=="date"||!S&&c.type=="date"||isNaN(O.current)&&c.type=="number"||Q)_(ue,O,null);else if(c.type==="text"&&typeof O.current!="string"){const W=O.current||O.current===0?O.current.toString():"";_(ue,O,W)}_(pe,X,c.format),_(me,ne,c.predicate),n=n|D(B,c.type||"text"),De(I.current)}if(n&B){const c=V.getFilters(H.current).map(S=>({id:S.id,label:$(S.label||S.id)}));_($e,Me,c),c.some(S=>S?.id===R.current)||_(u,R,null)}if(n&B||n&E){let c=V.getFilter(R.current,H.current);c||(c=V.getFilters(H.current).find(S=>S.default),n=n|D(E,c.id)),_(Pe,be,c),typeof O.current=="object"&&!(O.current instanceof Date)&&!c.range&&(n=n|D(q,H.current==="date"?null:""))}if(n&E||n&q||n&r)if(Y.current){const c=O.current||O.current===0?W=>be.current.handler(W,O.current||""):null,S=R.current&&c?Y.current.filter(c):Y.current;_(ye,Z,S);let Q=P.current;P.current.length&&(Q=P.current.filter(W=>S.includes(W))),Q.length?Q.length!==P.current.length&&(n=n|D(L,Q)):n=n|D(L,[...S])}else _(ye,Z,[]);if(n&L){const c=P.current.length===Z.current.length;_(we,oe,c)}if(n&z){const c=je();v&&v({value:c})}}function Ge(){const n=je();j&&j({value:n})}function Be(){N&&N()}function qe(){const n=!oe.current;_(we,oe,n),G(D(L,n?[...Z.current]:[])|z)}function Le(n){const{inputValue:c,value:S}=n,Q=S?[...P.current,c]:P.current.filter(W=>W!=c);G(D(L,Q)|z)}function ee({value:n}){n==="$empty"&&(n=""),G(D(q,n)|z)}function Ie({value:n}){G(D(g,n)|z)}function We({value:n}){G(D(E,n)|z)}function je(){const n={filter:R.current,value:O.current,type:H.current};return ne.current&&(n.predicate=ne.current),I.current&&(n.field=I.current),P.current&&P.current.length&&P.current.length!==Z.current.length?n.includes=[...P.current]:n.includes=[],n}function Ce(n){return X.current&&typeof X.current=="function"?X.current(n):n instanceof Date?X.current?se.dateToString(X.current,x.calendar)(n):T(n):typeof n=="string"?n:n.toString()}function ze(n){let c=n?n.map(S=>({id:S,label:Ce(S)})):[];return[{id:"$empty",label:"",emptyLabel:$("None")}].concat(c)}const ae=e.useRef(null);return e.useEffect(()=>{I.current&&ae.current&&setTimeout(()=>{const n=ae.current,c=n&&n.querySelector("input");c&&c.focus()},1)},[k]),e.useEffect(()=>{M&&G(D(g,p))},[p,M]),e.useEffect(()=>{M&&G(D(B,C))},[C,M]),e.useEffect(()=>{M&&G(D(E,i))},[i,M]),e.useEffect(()=>{M&&G(D(q,d))},[d,M]),e.useEffect(()=>{M&&G(D(L,F))},[F,M]),e.useEffect(()=>{const n=Array.isArray(h)?h:ge;M&&G(D(r,n))},[h,ge,M]),e.useEffect(()=>{w&&!l&&_(pe,X,w),m&&!l&&_(me,ne,m)},[w,m,l]),e.useEffect(()=>{_e(!0)},[]),t.jsx(a.context.fieldId.Provider,{value:null,children:t.jsxs("div",{className:"wx-3z8r9Oys wx-filter-editor",children:[l&&y?t.jsx(a.RichSelect,{onChange:Ie,options:l,value:k}):null,t.jsxs("div",{className:"wx-3z8r9Oys wx-wrapper",children:[t.jsx("div",{className:"wx-3z8r9Oys wx-cell",children:t.jsx(a.RichSelect,{onChange:We,options:Ve,value:o,placeholder:$("Click to select")})}),t.jsx("div",{className:"wx-3z8r9Oys wx-cell",ref:ae,children:ce==="date"?o=="between"||o=="notBetween"?t.jsx(a.DateRangePicker,{format:A,value:K,buttons:["done","clear","today"],onChange:ee}):t.jsx(a.DatePicker,{format:A,value:K,onChange:ee}):ce==="number"?t.jsx(a.Text,{value:K,onChange:ee,type:"number"}):ce==="tuple"?t.jsx(a.Combo,{value:K,options:ze(Ae),onChange:ee,children:({option:n})=>n.emptyLabel||n.label}):t.jsx(a.Text,{value:K,onChange:ee})})]}),t.jsx(a.Button,{onClick:qe,children:$(Ee?"Unselect all":"Select all")}),t.jsx("div",{className:"wx-3z8r9Oys wx-list",role:"listbox",children:ke.map((n,c)=>t.jsx("div",{className:"wx-3z8r9Oys wx-item",tabIndex:c?-1:0,role:"option",children:t.jsx(a.Checkbox,{label:Ce(n),inputValue:n,value:fe&&fe.includes(n),onChange:Le})},c))}),b?t.jsxs("div",{className:"wx-3z8r9Oys wx-wrapper",children:[t.jsx(a.Button,{type:"secondary",onClick:Be,children:$("Cancel")}),t.jsx(a.Button,{type:"primary",onClick:Ge,children:$("Apply")})]}):null]})})}function Se(s){return t.jsx(a.Locale,{words:de.en,optional:!0,children:t.jsx(Qe,{...s})})}function ve(s){const{rule:l,type:y}=s,p=e.useMemo(()=>l.includes&&l.includes.length?l.includes:null,[l]),b=e.useMemo(()=>l.filter||"contains",[l]),h=e.useMemo(()=>l.value||"",[l]),F=e.useMemo(()=>l.field,[l]),C=e.useMemo(()=>l.id,[l]),i=e.useContext(te),d=U.useStore(i,"fields"),w=U.useStore(i,"options"),m=e.useCallback(()=>{i.exec("edit-rule",{})},[i]),j=e.useCallback(({value:v})=>{i.exec("update-rule",{id:C,rule:v}),m()},[i,C]),N=e.useCallback(({value:v})=>{i.exec("change-rule",{id:C,rule:v})},[i,C]);return t.jsx("div",{className:"wx-uOIGm7Ce wx-panel",children:t.jsx(Se,{fieldsSelector:y!=="simple",fields:d,field:F,options:w,includes:p,filter:b,value:h,onApply:j,onCancel:m,onChange:N})})}function Ue({filter:s,field:l,type:y="list",action:p="menu"}){const b=A=>A,h=e.useContext(a.context.i18n),F=e.useRef();F.current===void 0&&(F.current=h.getRaw());const C=F.current,i=e.useRef();i.current===void 0&&(i.current=l?.format||C.filter?.dateFormat||C.formats.dateFormat);const d=i.current,w=e.useMemo(()=>typeof d=="function"?d:l?.type==="date"?se.dateToString(d,C.calendar):b,[l]),m=e.useRef();m.current===void 0&&(m.current=h.getGroup("filter"));const j=m.current,[N,v]=e.useState(),[f,x]=e.useState();return e.useEffect(()=>{x(s.value),v(s.filter?V.getFilter(s.filter,s.type):null)},[s]),t.jsxs("div",{className:`wx-5GeVl88l wx-rule wx-${y}`,"data-id":s.id,children:[t.jsxs("span",{className:"wx-5GeVl88l wx-filter",children:[t.jsx("span",{className:"wx-5GeVl88l wx-field",children:l.label}),s.includes&&s.includes.length?t.jsxs(t.Fragment,{children:[" "+j("in")+" ",s.includes.map((A,T)=>t.jsxs(e.Fragment,{children:[t.jsx("span",{className:"wx-5GeVl88l wx-value",children:w(A)}),T<s.includes.length-1?",Â ":null]},A))]}):s.filter&&(f||f===0)?t.jsxs(t.Fragment,{children:[" "+(j(N.short||N.label)||N.id)+" ",l.type==="date"?f.start?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"wx-5GeVl88l wx-value",children:w(f.start)})," "+j("and")+" ",t.jsx("span",{className:"wx-5GeVl88l wx-value",children:w(f.end)})]}):t.jsx("span",{className:"wx-5GeVl88l wx-value",children:w(f)}):t.jsx("span",{className:"wx-5GeVl88l wx-value",children:w(f)})]}):null]}),t.jsx("i",{className:`wx-5GeVl88l wxi-${p==="menu"?"dots-v":p} wx-menu-icon`,role:"button","data-action":p})]})}function Xe({mode:s="and",id:l}){const p=e.useContext(a.context.i18n).getGroup("filter"),b=e.useContext(te);function h(){b.exec("toggle-glue",{id:l})}return t.jsx("div",{className:`wx-XRdDajFX wx-glue wx-${s}`,role:"button",onClick:h,children:p(s)})}function le(s){const{group:l,type:y,onShowMenu:p}=s,b=e.useContext(te),[h,F]=U.useStoreWithCounter(b,"value"),C=U.useStore(b,"fields"),i=U.useStore(b,"_editor"),d=e.useMemo(()=>h&&h.getBranch(l.id)||[],[F,l.id]),w=e.useMemo(()=>y=="simple"?"line":y,[y]),m=e.useMemo(()=>l.$level==1?"top":"inner",[l.$level]),j=e.useMemo(()=>({dblclick:g=>b.exec("edit-rule",{id:g}),menu:(g,E)=>p&&p({id:g,ev:E}),delete:g=>{b.exec("edit-rule",{}),b.exec("delete-rule",{id:g})}}),[b,p]),N=e.useCallback(g=>C.find(E=>E.id==g),[C]),v=e.useRef(null),[f,x]=e.useState(),[A,T]=e.useState();e.useEffect(()=>{const g=v.current;return g?se.delegateClick(g,j):void 0},[j]),e.useEffect(()=>{if(!(i&&A===i.id)){if(i&&y!=="list"&&d.find(g=>g.id===i.id)){const g=v.current&&v.current.querySelector(`[data-id='${i.id}']`);if(g){x(g.getBoundingClientRect()),T(i.id);return}}x(null),T(null)}},[i,y,d,A]);function $(){x(null),T(null),b.exec("edit-rule",{})}return t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:v,className:`wx-3udP2tTA wx-group wx-${m} wx-${w}`,children:d.map((g,E)=>t.jsxs(e.Fragment,{children:[y==="list"&&i&&i.id==g.id?t.jsx(ve,{rule:g}):g.data?t.jsx(le,{type:y,group:g,onShowMenu:p}):t.jsx("div",{className:"wx-3udP2tTA wx-rule-wrapper",children:t.jsx(Ue,{action:y=="simple"?"delete":"menu",type:w,filter:g,field:N(g.field)})}),y!=="simple"&&E<d.length-1?t.jsx("div",{className:"wx-3udP2tTA wx-glue-wrapper",children:t.jsx(Xe,{mode:l.glue,id:l.id})}):null]},g.id))}),i&&f?t.jsx(a.Portal,{children:t.jsx(a.Popup,{top:f.top+f.height,left:f.left+f.width/2,onCancel:$,children:t.jsx("div",{className:"wx-3udP2tTA wx-editor-wrapper",children:t.jsx(ve,{type:y,rule:h.byId(i.id)})})})}):null]})}function Ye({type:s}){const l=e.useContext(te),y=e.useContext(a.context.i18n),p=e.useMemo(()=>y.getGroup("filter"),[y]),b=U.useStore(l,"fields"),[h,F]=U.useStoreWithCounter(l,"value"),C=h.getBranch(0)[0];function i(f){l.exec("add-rule",{rule:{$temp:!0,...f},edit:!0})}const d=e.useMemo(()=>{const f={};return h.forEach(x=>f[x.field]=!0),b.filter(x=>!f[x.id]).map(x=>({id:x.id,text:x.label}))},[F,b]),w=e.useCallback(f=>{const x=f.action;x&&i({field:x.id})},[i]),m=e.useMemo(()=>[{id:"edit-rule",text:p("Edit"),icon:"wxi-edit-outline"},{id:"add-rule",text:p("Add filter"),icon:"wxi-filter-plus-outline",resolver:f=>({after:f,rule:{$temp:!0},edit:!0})},{id:"add-group",text:p("Add group"),icon:"wxi-filter-multiple-outline",resolver:f=>({after:f,rule:{$temp:!0},edit:!0})},{type:"separator"},{id:"delete-rule",text:p("Delete"),icon:"wxi-delete-outline"}],[p]),j=e.useRef(null),N=e.useCallback(f=>{const{context:x,action:A}=f;if(A){const T=A.resolver?A.resolver(x):{id:x};l.exec(A.id,T)}},[l]),v=e.useCallback(({ev:f,id:x})=>{j.current&&typeof j.current.show=="function"&&j.current.show(f,x)},[]);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`wx-VDDi7d7g wx-filter-builder wx-${s}`,children:s==="list"?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`wx-VDDi7d7g wx-toolbar wx-${s}`,children:t.jsx(a.Button,{type:"primary",onClick:i,children:p("Add filter")})}),t.jsx(le,{type:s,group:C,onShowMenu:v})]}):s==="line"?t.jsxs("div",{className:`wx-VDDi7d7g wx-toolbar wx-${s}`,children:[t.jsx("div",{className:"wx-VDDi7d7g wx-filters",children:t.jsx(le,{type:s,group:C,onShowMenu:v})}),t.jsx("div",{className:"wx-VDDi7d7g wx-button",children:t.jsx(a.Button,{type:"primary",onClick:i,children:p("Add filter")})})]}):s==="simple"?t.jsxs("div",{className:`wx-VDDi7d7g wx-toolbar wx-${s}`,children:[t.jsx("div",{className:"wx-VDDi7d7g wx-button",children:t.jsx(Re.DropDownMenu,{options:d,onClick:w,children:t.jsx(a.Button,{disabled:!d.length,type:"primary",children:p("Add filter")})})}),t.jsx("div",{className:"wx-VDDi7d7g wx-filters",children:t.jsx(le,{type:s,group:C,onShowMenu:v})})]}):null}),s!=="simple"?t.jsx(Re.ContextMenu,{options:m,onClick:N,ref:j}):null]})}const Je=s=>s.split("-").map(l=>l?l.charAt(0).toUpperCase()+l.slice(1):"").join(""),Ke=e.forwardRef(function({value:l={glue:"and",rules:[]},fields:y=[],options:p=null,type:b="list",init:h=null,...F},C){const i=e.useRef();i.current=F;const d=e.useMemo(()=>new V.DataStore(U.writable),[]),w=e.useMemo(()=>d.in,[d]),m=e.useRef(null);m.current===null&&(m.current=new He.EventBusRouter((v,f)=>{const x="on"+Je(v);i.current&&i.current[x]&&i.current[x](f)}),w.setNext(m.current));const j=e.useMemo(()=>({getState:d.getState.bind(d),getReactiveState:d.getReactive.bind(d),getStores:()=>({data:d}),exec:w.exec,setNext:v=>(m.current=m.current.setNext(v),m.current),intercept:w.intercept.bind(w),on:w.on.bind(w),detach:w.detach.bind(w),getValue:d.getValue.bind(d)}),[d,w]),N=e.useRef(!0);return e.useEffect(()=>{d.init({value:l,fields:y,options:p}),N.current&&h&&(h(j),N.current=!1)},[d,l,y,p,h,j]),N.current&&(d.init({value:l,fields:y,options:p}),h&&h(j),N.current=!1),e.useImperativeHandle(C,()=>({...j}),[j]),t.jsx(a.Locale,{words:de.en,optional:!0,children:t.jsx(te.Provider,{value:j,children:t.jsx(Ye,{type:b})})})});function Ze(s){const{fields:l=[],debounce:y=300,onChange:p}=s,[b,h]=e.useState(),[F,C]=e.useState({}),i=e.useContext(a.context.i18n),d=i.getRaw(),w=d.filter&&d.filter.dateFormat||d.formats&&d.formats.dateFormat,m=i.getGroup("filter");function j(r){const o=r.options.map(u=>typeof u=="string"||typeof u=="number"?{id:u,label:u}:u);return o.unshift({id:"$empty",label:m("None")}),o}function N(r){return typeof r=="string"?{id:r,type:"text",filter:"contains"}:{...r,filter:r.filter||(r.options?"equal":"contains"),options:r.type!=="date"&&r.options&&j(r)}}function v(r){return r.map(o=>o.type==="all"||o.type==="dynamic"?{...o,by:o.by.map(u=>N(u))}:N(o))}function f(r){return r.map(o=>({id:o.id,label:o.id}))}const x=e.useMemo(()=>v(l),[l]),A=e.useRef(null);e.useEffect(()=>{const r={};let o=b;x.forEach(u=>{u.type==="dynamic"?(u.by.forEach(R=>{typeof R.value<"u"&&(r[R.id]=R.value)}),o=u.by[0].id):u.type==="all"?r[u.type]=u.value??"":typeof u.value<"u"&&(r[u.id]=u.value)}),A.current=r,C(r),h(o)},[x]);function T(r,o,u){return r.map(R=>{let k={field:R.type,label:R.label,placeholder:R.placeholder};if(R.type==="dynamic"){k.dynamicField=!0,k.field=o;const J=R.by.find(I=>I.id===k.field);J&&(k={...J,...k,placeholder:J.placeholder??k.placeholder})}else R.type!=="all"&&(k={...k,...R,field:R.id});return R.by&&(k.optionsBy=f(R.by)),k.value=u[k.field],{type:"text",filter:"contains",...k}})}const $=e.useMemo(()=>T(x,b,F),[x,b,F]);function g(r,o){if(r.field==="all")return V.createFilterRule(r.optionsBy,"contains",o[r.field]);const u=o[r.field];return u?{field:r.field,filter:r.filter,type:r.type,value:u}:null}function E(r){const o=$.map(u=>g(u,r)).filter(u=>!!u);return o.length===1&&o[0]?.glue==="or"?o[0]:{glue:"and",rules:o}}const q=e.useRef(null);function L(r,o){q.current&&clearTimeout(q.current),q.current=setTimeout(()=>{p&&p({value:E(o)})},r)}e.useEffect(()=>{A.current&&A.current!==F&&L(1,F)},[F]);const B=(r,o)=>{C(u=>({...u,[o]:r==="$empty"?"":r}))},z=r=>{C(o=>(h(r),b?{...o,[b]:""}:o))};return t.jsx("div",{className:"wx-gWqAfosQ wx-filter-bar",children:$.map((r,o)=>t.jsxs(e.Fragment,{children:[r.label?t.jsx("div",{className:"wx-gWqAfosQ wx-label",children:r.label}):null,r.dynamicField?t.jsx("div",{className:"wx-gWqAfosQ wx-select",children:t.jsx(a.RichSelect,{value:r.field,options:r.optionsBy,onChange:({value:u})=>z(u)})}):null,r.options?t.jsx("div",{className:"wx-gWqAfosQ wx-select",children:t.jsx(a.RichSelect,{value:r.value,placeholder:r.placeholder??`${m("filter by")} ${r.field}`,options:r.options,onChange:({value:u})=>B(u,r.field)})}):r.type==="text"||r.type==="number"?t.jsx("div",{className:"wx-gWqAfosQ wx-text",children:t.jsx(a.Text,{value:r.value,placeholder:r.placeholder??`${m("filter by")} ${r.field} (${m(r.filter)})`,onChange:({value:u,input:R})=>{R&&B(u,r.field)},type:r.type})}):r.type==="date"?t.jsx("div",{className:"wx-gWqAfosQ wx-date",children:r.filter==="between"||r.filter==="notBetween"?t.jsx(a.DateRangePicker,{value:r.value,format:w,buttons:["done","clear","today"],placeholder:r.placeholder??`${m("filter by")} ${r.field} (${m(r.filter)})`,onChange:({value:u})=>B(u,r.field)}):t.jsx(a.DatePicker,{value:r.value,format:w,placeholder:r.placeholder??`${m("filter by")} ${r.field} (${m(r.filter)})`,onChange:({value:u})=>B(u,r.field)})}):null]},o))})}function et(s={}){return t.jsx(a.Locale,{words:de.en,optional:!0,children:t.jsx(Ze,{...s})})}function tt({fonts:s=!0,children:l}){return l?t.jsx(a.Material,{fonts:s,children:l}):t.jsx(a.Material,{fonts:s})}function nt({fonts:s=!0,children:l}){return l?t.jsx(a.Willow,{fonts:s,children:l}):t.jsx(a.Willow,{fonts:s})}function rt(s){const{fonts:l=!0,children:y}=s;return y?t.jsx(a.WillowDark,{fonts:l,children:y}):t.jsx(a.WillowDark,{fonts:l})}Object.defineProperty(exports,"createArrayFilter",{enumerable:!0,get:()=>V.createArrayFilter});Object.defineProperty(exports,"createFilter",{enumerable:!0,get:()=>V.createFilter});Object.defineProperty(exports,"createFilterRule",{enumerable:!0,get:()=>V.createFilterRule});Object.defineProperty(exports,"getFilter",{enumerable:!0,get:()=>V.getFilter});Object.defineProperty(exports,"getFilters",{enumerable:!0,get:()=>V.getFilters});Object.defineProperty(exports,"getOptions",{enumerable:!0,get:()=>V.getOptions});Object.defineProperty(exports,"getOptionsMap",{enumerable:!0,get:()=>V.getOptionsMap});exports.FilterBar=et;exports.FilterBuilder=Ke;exports.FilterEditor=Se;exports.Material=tt;exports.Willow=nt;exports.WillowDark=rt;
//# sourceMappingURL=index.cjs.map
