"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("@univerjs/core/facade"),o=require("@univerjs/core"),n=require("@univerjs/engine-formula"),c=require("rxjs");var d=Object.getOwnPropertyDescriptor,f=(a,e,t,r)=>{for(var i=r>1?void 0:r?d(e,t):e,s=a.length-1,m;s>=0;s--)(m=a[s])&&(i=m(i)||i);return i},u=(a,e)=>(t,r)=>e(t,r,a);exports.FFormula=class extends l.FBase{constructor(e,t,r,i){super(),this._commandService=e,this._injector=t,this._lexerTreeBuilder=r,this._configService=i,this._initialize()}_initialize(){}get lexerTreeBuilder(){return this._lexerTreeBuilder}moveFormulaRefOffset(e,t,r,i){return this._lexerTreeBuilder.moveFormulaRefOffset(e,t,r,i)}sequenceNodesBuilder(e){return this._lexerTreeBuilder.sequenceNodesBuilder(e)||[]}executeCalculation(){this._commandService.executeCommand(n.SetFormulaCalculationStartMutation.id,{commands:[],forceCalculation:!0},{onlyLocal:!0})}stopCalculation(){this._commandService.executeCommand(n.SetFormulaCalculationStopMutation.id,{})}calculationStart(e){return this._commandService.onCommandExecuted(t=>{if(t.id===n.SetFormulaCalculationStartMutation.id){const r=t.params;e(r.forceCalculation)}})}calculationEnd(e){return this._commandService.onCommandExecuted(t=>{if(t.id!==n.SetFormulaCalculationNotificationMutation.id)return;const r=t.params;r.functionsExecutedState!==void 0&&e(r.functionsExecutedState)})}whenComputingCompleteAsync(e){const t=this._injector.get(n.GlobalComputingStatusService);return t.computingStatus?Promise.resolve(!0):c.firstValueFrom(c.race(t.computingStatus$.pipe(c.filter(r=>r)),c.timer(e!=null?e:3e4).pipe(c.map(()=>!1))))}onCalculationEnd(){return new Promise((e,t)=>{const r=setTimeout(()=>{t(new Error("Calculation end timeout"))},3e4),i=this.calculationEnd(()=>{clearTimeout(r),i.dispose(),e()})})}calculationProcessing(e){return this._commandService.onCommandExecuted(t=>{if(t.id!==n.SetFormulaCalculationNotificationMutation.id)return;const r=t.params;r.stageInfo!==void 0&&e(r.stageInfo)})}setMaxIteration(e){this._configService.setConfig(n.ENGINE_FORMULA_CYCLE_REFERENCE_COUNT,e)}};exports.FFormula=f([u(0,o.Inject(o.ICommandService)),u(1,o.Inject(o.Injector)),u(2,o.Inject(n.LexerTreeBuilder)),u(3,o.IConfigService)],exports.FFormula);class C extends l.FUniver{getFormula(){return this._injector.createInstance(exports.FFormula)}}l.FUniver.extend(C);
