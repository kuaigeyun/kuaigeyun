"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("@univerjs/core"),U=require("@univerjs/drawing"),l=require("@univerjs/sheets");var b=(e=>(e.Position="0",e.Both="1",e.None="2",e))(b||{});class R extends U.UnitDrawingService{}const D=s.createIdentifier("sheets-drawing.sheet-drawing.service");var h=(e=>(e[e.INSERT=0]="INSERT",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE",e[e.ARRANGE=3]="ARRANGE",e[e.GROUP=4]="GROUP",e[e.UNGROUP=5]="UNGROUP",e))(h||{});const g={id:"sheet.mutation.set-drawing-apply",type:s.CommandType.MUTATION,handler:(e,i)=>{const t=e.get(U.IDrawingManagerService),r=e.get(D),{op:n,unitId:a,subUnitId:c,type:d,objects:o}=i;switch(t.applyJson1(a,c,n),r.applyJson1(a,c,n),d){case 0:t.addNotification(o),r.addNotification(o);break;case 1:t.removeNotification(o),r.removeNotification(o);break;case 2:t.updateNotification(o),r.updateNotification(o);break;case 3:t.orderNotification(o),r.orderNotification(o);break;case 4:t.groupUpdateNotification(o);break;case 5:t.ungroupUpdateNotification(o);break}return!0}};var P=Object.getOwnPropertyDescriptor,C=(e,i,t,r)=>{for(var n=r>1?void 0:r?P(i,t):i,a=e.length-1,c;a>=0;a--)(c=e[a])&&(n=c(n)||n);return n},u=(e,i)=>(t,r)=>i(t,r,e);const E="SHEET_DRAWING_PLUGIN";let p=class extends s.Disposable{constructor(e,i,t,r,n,a){super(),this._sheetInterceptorService=e,this._univerInstanceService=i,this._commandService=t,this._sheetDrawingService=r,this._drawingManagerService=n,this._resourceManagerService=a,this._initSnapshot(),this._initSheetChange(),this.disposeWithMe(this._commandService.registerCommand(g))}_initSnapshot(){const e=(t,r)=>{const n=r||this._sheetDrawingService.getDrawingDataForUnit(t);return n?JSON.stringify(n):""},i=t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:E,businesses:[s.UniverInstanceType.UNIVER_SHEET],toJson:(t,r)=>e(t,r),parseJson:t=>i(t),onUnLoad:t=>{this._sheetDrawingService.removeDrawingDataForUnit(t),this._drawingManagerService.removeDrawingDataForUnit(t)},onLoad:(t,r)=>{this._sheetDrawingService.registerDrawingData(t,r),this._drawingManagerService.registerDrawingData(t,r)}}))}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>{var i;if(e.id===l.RemoveSheetCommand.id){const t=e.params,r=t.unitId||this._univerInstanceService.getCurrentUnitOfType(s.UniverInstanceType.UNIVER_SHEET).getUnitId(),n=t.subUnitId||((i=this._univerInstanceService.getCurrentUnitOfType(s.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:i.getSheetId());if(!r||!n)return{redos:[],undos:[]};const a=this._sheetDrawingService.getDrawingData(r,n),c=Object.values(a).filter(_=>_.drawingType!==s.DrawingTypeEnum.DRAWING_CHART);if(c.length===0)return{redos:[],undos:[]};const d=this._sheetDrawingService.getBatchRemoveOp(c),{unitId:o,subUnitId:v,undo:S,redo:f,objects:I}=d;return{redos:[{id:g.id,params:{op:f,unitId:o,subUnitId:v,objects:I,type:h.REMOVE}}],undos:[{id:g.id,params:{op:S,unitId:o,subUnitId:v,objects:I,type:h.INSERT}}]}}else if(e.id===l.CopySheetCommand.id){const t=e.params,{unitId:r,subUnitId:n,targetSubUnitId:a}=t;if(!r||!n||!a)return{redos:[],undos:[]};const c=this._sheetDrawingService.getDrawingData(r,n),d=Object.values(c).filter(w=>w.drawingType!==s.DrawingTypeEnum.DRAWING_CHART).map(w=>({...w,subUnitId:a,drawingId:s.generateRandomId(6)}));if(d.length===0)return{redos:[],undos:[]};const o=this._sheetDrawingService.getBatchAddOp(d),{unitId:v,subUnitId:S,undo:f,redo:I,objects:_}=o;return{redos:[{id:g.id,params:{op:I,unitId:v,subUnitId:S,objects:_,type:h.INSERT}}],undos:[{id:g.id,params:{op:f,unitId:v,subUnitId:S,objects:_,type:h.REMOVE}}]}}return{redos:[],undos:[]}}}))}};p=C([u(0,s.Inject(l.SheetInterceptorService)),u(1,s.Inject(s.IUniverInstanceService)),u(2,s.ICommandService),u(3,D),u(4,U.IDrawingManagerService),u(5,s.IResourceManagerService)],p);const M="sheets-drawing.config",N={};var j=Object.defineProperty,T=Object.getOwnPropertyDescriptor,G=(e,i,t)=>i in e?j(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,H=(e,i,t,r)=>{for(var n=r>1?void 0:r?T(i,t):i,a=e.length-1,c;a>=0;a--)(c=e[a])&&(n=c(n)||n);return n},m=(e,i)=>(t,r)=>i(t,r,e),O=(e,i,t)=>G(e,typeof i!="symbol"?i+"":i,t);exports.UniverSheetsDrawingPlugin=class extends s.Plugin{constructor(i=N,t,r){super(),this._config=i,this._injector=t,this._configService=r;const{...n}=s.merge({},N,this._config);this._configService.setConfig(M,n)}onStarting(){[[p],[D,{useClass:R}]].forEach(i=>this._injector.add(i)),this._injector.get(p)}};O(exports.UniverSheetsDrawingPlugin,"pluginName",E);O(exports.UniverSheetsDrawingPlugin,"type",s.UniverInstanceType.UNIVER_SHEET);exports.UniverSheetsDrawingPlugin=H([s.DependentOn(U.UniverDrawingPlugin),m(1,s.Inject(s.Injector)),m(2,s.IConfigService)],exports.UniverSheetsDrawingPlugin);exports.DrawingApplyType=h;exports.ISheetDrawingService=D;exports.SHEET_DRAWING_PLUGIN=E;exports.SetDrawingApplyMutation=g;exports.SheetDrawingAnchorType=b;
