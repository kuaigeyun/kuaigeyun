"use strict";var E=Object.defineProperty;var $=(i,o,t)=>o in i?E(i,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[o]=t;var g=(i,o,t)=>$(i,typeof o!="symbol"?o+"":o,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const h=require("@univerjs/core"),l=require("@univerjs/sheets"),N=require("rxjs");class p extends h.Disposable{constructor(){super(...arguments);g(this,"_noteMatrix",new Map);g(this,"_change$",new N.Subject);g(this,"change$",this._change$.asObservable())}_ensureNoteMatrix(t,s){let e=this._noteMatrix.get(t);e||(e=new Map,this._noteMatrix.set(t,e));let n=e.get(s);return n||(n=new h.ObjectMatrix,e.set(s,n)),n}getSheetShowNotes$(t,s){return this._change$.pipe(N.filter(({unitId:e,sheetId:n})=>e===t&&n===s),N.map(()=>{const e=this._ensureNoteMatrix(t,s),n=[];return e.forValue((r,a,c)=>{c.show&&n.push({loc:{row:r,col:a,unitId:t,subUnitId:s},note:c})}),n}))}getCellNoteChange$(t,s,e,n){return this._change$.pipe(N.filter(({unitId:r,sheetId:a,row:c,col:d})=>r===t&&a===s&&c===e&&d===n),N.map(({note:r})=>r))}updateNote(t,s,e,n,r,a){const c=this._ensureNoteMatrix(t,s),d=c.getValue(e,n);c.setValue(e,n,r),this._change$.next({unitId:t,sheetId:s,row:e,col:n,type:"update",note:r,oldNote:d,silent:a})}removeNote(t,s,e,n,r){const a=this._ensureNoteMatrix(t,s),c=a.getValue(e,n);a.realDeleteValue(e,n),this._change$.next({unitId:t,sheetId:s,row:e,col:n,type:"update",note:null,oldNote:c,silent:r})}toggleNotePopup(t,s,e,n,r){const a=this._ensureNoteMatrix(t,s),c=a.getValue(e,n);if(c){c.show=!c.show;const d={...c,show:c.show};a.setValue(e,n,d),this._change$.next({unitId:t,sheetId:s,row:e,col:n,type:"update",note:d,oldNote:c,silent:r})}}updateNotePosition(t,s,e,n,r,a,c){const d=this._ensureNoteMatrix(t,s),u=d.getValue(e,n);u&&(d.realDeleteValue(e,n),d.setValue(r,a,u),this._change$.next({unitId:t,sheetId:s,row:e,col:n,type:"ref",newPosition:{row:r,col:a},note:u,silent:c}))}getNote(t,s,e,n){return this._ensureNoteMatrix(t,s).getValue(e,n)}getUnitNotes(t){return this._noteMatrix.get(t)}getSheetNotes(t,s){const e=this._noteMatrix.get(t);if(e)return e.get(s)}getNotes(){return this._noteMatrix}deleteUnitNotes(t){this._noteMatrix.delete(t)}}const _={id:"sheet.mutation.update-note",type:h.CommandType.MUTATION,handler:(i,o)=>{const{unitId:t,sheetId:s,row:e,col:n,note:r,silent:a}=o;return i.get(p).updateNote(t,s,e,n,r,a),!0}},S={id:"sheet.mutation.remove-note",type:h.CommandType.MUTATION,handler:(i,o)=>{const{unitId:t,sheetId:s,row:e,col:n,silent:r}=o;return i.get(p).removeNote(t,s,e,n,r),!0}},y={id:"sheet.mutation.toggle-note-popup",type:h.CommandType.MUTATION,handler:(i,o)=>{const{unitId:t,sheetId:s,row:e,col:n,silent:r}=o;return i.get(p).toggleNotePopup(t,s,e,n,r),!0}},M={id:"sheet.mutation.update-note-position",type:h.CommandType.MUTATION,handler:(i,o)=>{const{unitId:t,sheetId:s,row:e,col:n,newPosition:r,silent:a}=o;return i.get(p).updateNotePosition(t,s,e,n,r.row,r.col,a),!0}},P={id:"sheet.command.delete-note",type:h.CommandType.COMMAND,handler:(i,o)=>{const t=i.get(h.IUniverInstanceService),s=l.getSheetCommandTarget(t);if(!s)return!1;const n=i.get(l.SheetsSelectionsService).getCurrentLastSelection();if(!(n!=null&&n.primary))return!1;const{actualColumn:r,actualRow:a}=n.primary;return i.get(h.ICommandService).executeCommand(S.id,{unitId:s.unitId,sheetId:s.subUnitId,row:a,col:r})}},w={id:"sheet.command.toggle-note-popup",type:h.CommandType.COMMAND,handler:(i,o)=>{const t=i.get(h.IUniverInstanceService),s=l.getSheetCommandTarget(t);if(!s)return!1;const n=i.get(l.SheetsSelectionsService).getCurrentLastSelection();if(!(n!=null&&n.primary))return!1;const{actualColumn:r,actualRow:a}=n.primary;return i.get(h.ICommandService).executeCommand(y.id,{unitId:s.unitId,sheetId:s.subUnitId,row:a,col:r})}},x={id:"sheet.command.update-note",type:h.CommandType.COMMAND,handler:(i,o)=>i.get(h.ICommandService).syncExecuteCommand(_.id,o)},T="SHEET_NOTE_PLUGIN";var D=Object.getOwnPropertyDescriptor,j=(i,o,t,s)=>{for(var e=s>1?void 0:s?D(o,t):o,n=i.length-1,r;n>=0;n--)(r=i[n])&&(e=r(e)||e);return e},v=(i,o)=>(t,s)=>o(t,s,i);exports.SheetsNoteResourceController=class extends h.Disposable{constructor(o,t,s,e){super(),this._resourceManagerService=o,this._univerInstanceService=t,this._sheetInterceptorService=s,this._sheetsNoteModel=e,this._initSnapshot(),this._initSheetChange()}_initSnapshot(){const o=s=>{const e=this._sheetsNoteModel.getUnitNotes(s);if(!e)return"";const n={};return e.forEach((r,a)=>{const c={};r.forValue((d,u,m)=>{c[d]||(c[d]={}),c[d][u]=m}),Object.keys(c).length>0&&(n[a]=c)}),JSON.stringify(n)},t=s=>{if(!s)return{};try{return JSON.parse(s)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:T,businesses:[h.UniverInstanceType.UNIVER_SHEET],toJson:s=>o(s),parseJson:s=>t(s),onUnLoad:s=>{this._sheetsNoteModel.deleteUnitNotes(s)},onLoad:(s,e)=>{Object.entries(e).forEach(([n,r])=>{Object.entries(r).forEach(([a,c])=>{Object.entries(c).forEach(([d,u])=>{this._sheetsNoteModel.updateNote(s,n,Number(a),Number(d),u)})})})}}))}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:o=>{var t;if(o.id===l.RemoveSheetCommand.id){const s=o.params,e=s.unitId||this._univerInstanceService.getCurrentUnitOfType(h.UniverInstanceType.UNIVER_SHEET).getUnitId(),n=s.subUnitId||((t=this._univerInstanceService.getCurrentUnitOfType(h.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:t.getSheetId());if(!e||!n)return{redos:[],undos:[]};const r=this._sheetsNoteModel.getSheetNotes(e,n);if(!r)return{redos:[],undos:[]};const a=[],c=[];return r.forValue((d,u,m)=>{a.push({id:S.id,params:{unitId:e,sheetId:n,row:d,col:u}}),c.push({id:_.id,params:{unitId:e,sheetId:n,row:d,col:u,note:m}})}),{redos:a,undos:c}}else if(o.id===l.CopySheetCommand.id){const s=o.params,{unitId:e,subUnitId:n,targetSubUnitId:r}=s;if(!e||!n||!r)return{redos:[],undos:[]};const a=this._sheetsNoteModel.getSheetNotes(e,n);if(!a)return{redos:[],undos:[]};const c=[],d=[];return a.forValue((u,m,b)=>{c.push({id:_.id,params:{unitId:e,sheetId:r,row:u,col:m,note:b}}),d.push({id:S.id,params:{unitId:e,sheetId:r,row:u,col:m}})}),{redos:c,undos:d}}return{redos:[],undos:[]}}}))}};exports.SheetsNoteResourceController=j([v(0,h.IResourceManagerService),v(1,h.IUniverInstanceService),v(2,h.Inject(l.SheetInterceptorService)),v(3,h.Inject(p))],exports.SheetsNoteResourceController);const V="sheets-note.config",R={};var A=Object.getOwnPropertyDescriptor,W=(i,o,t,s)=>{for(var e=s>1?void 0:s?A(o,t):o,n=i.length-1,r;n>=0;n--)(r=i[n])&&(e=r(e)||e);return e},f=(i,o)=>(t,s)=>o(t,s,i);let C=class extends h.Disposable{constructor(o,t,s,e){super();g(this,"_disposableMap",new Map);g(this,"_watcherMap",new Map);g(this,"_handleRangeChange",(o,t,s,e,n,r,a)=>r?{redos:[{id:M.id,params:{unitId:o,sheetId:t,row:e,col:n,newPosition:{row:r.startRow,col:r.startColumn},silent:a}}],undos:[{id:M.id,params:{unitId:o,sheetId:t,row:r.startRow,col:r.startColumn,newPosition:{row:e,col:n},note:s,silent:a}}]}:{redos:[{id:S.id,params:{unitId:o,sheetId:t,row:e,col:n}}],undos:[{id:_.id,params:{unitId:o,sheetId:t,row:e,col:n,note:s}}]});this._refRangeService=o,this._sheetsNoteModel=t,this._selectionManagerService=s,this._commandService=e,this._initData(),this._initRefRange()}_getIdWithUnitId(o,t,s,e){return`${o}-${t}-${s}-${e}`}_register(o,t,s,e,n){const r={startColumn:n,endColumn:n,startRow:e,endRow:e};this._disposableMap.set(this._getIdWithUnitId(o,t,e,n),this._refRangeService.registerRefRange(r,a=>{const c=l.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests(r,a,{selectionManagerService:this._selectionManagerService}),d=Array.isArray(c)?c[0]:c;return d&&d.startColumn===r.startColumn&&d.startRow===r.startRow?{undos:[],redos:[]}:this._handleRangeChange(o,t,s,e,n,d,!1)},o,t))}_watch(o,t,s,e,n){const r={startColumn:n,endColumn:n,startRow:e,endRow:e};this._watcherMap.set(this._getIdWithUnitId(o,t,e,n),this._refRangeService.watchRange(o,t,r,(a,c)=>{const{redos:d}=this._handleRangeChange(o,t,s,a.startRow,a.startColumn,c,!0);h.sequenceExecuteAsync(d,this._commandService,{onlyLocal:!0})},!0))}_unwatch(o,t,s,e){var r;const n=this._getIdWithUnitId(o,t,s,e);(r=this._watcherMap.get(n))==null||r.dispose(),this._watcherMap.delete(n)}_unregister(o,t,s,e){var r;const n=this._getIdWithUnitId(o,t,s,e);(r=this._disposableMap.get(n))==null||r.dispose(),this._disposableMap.delete(n)}_initData(){const o=this._sheetsNoteModel.getNotes();for(const[t,s]of o)for(const[e,n]of s)n.forValue((r,a,c)=>(c&&(this._register(t,e,c,r,a),this._watch(t,e,c,r,a)),!0))}_initRefRange(){this.disposeWithMe(this._sheetsNoteModel.change$.subscribe(o=>{switch(o.type){case"update":{const{unitId:t,sheetId:s,row:e,col:n,note:r}=o,a=this._getIdWithUnitId(t,s,e,n);r?this._disposableMap.has(a)||(this._register(t,s,r,e,n),this._watch(t,s,r,e,n)):(this._unregister(t,s,e,n),this._unwatch(t,s,e,n));break}case"ref":{const{unitId:t,sheetId:s,row:e,col:n,newPosition:r,note:a,silent:c}=o;this._unregister(t,s,e,n),c||(this._unwatch(t,s,e,n),this._watch(t,s,a,r.row,r.col)),this._register(t,s,a,r.row,r.col);break}}}))}};C=W([f(0,h.Inject(l.RefRangeService)),f(1,h.Inject(p)),f(2,h.Inject(l.SheetsSelectionsService)),f(3,h.ICommandService)],C);var L=Object.getOwnPropertyDescriptor,H=(i,o,t,s)=>{for(var e=s>1?void 0:s?L(o,t):o,n=i.length-1,r;n>=0;n--)(r=i[n])&&(e=r(e)||e);return e},J=(i,o)=>(t,s)=>o(t,s,i);let I=class extends h.Disposable{constructor(i){super(),this._commandService=i,this._initialize()}_initialize(){[M,y,_,S,P,w,x].forEach(i=>{this.disposeWithMe(this._commandService.registerCommand(i))})}};I=H([J(0,h.ICommandService)],I);var q=Object.defineProperty,G=Object.getOwnPropertyDescriptor,z=(i,o,t)=>o in i?q(i,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[o]=t,F=(i,o,t,s)=>{for(var e=s>1?void 0:s?G(o,t):o,n=i.length-1,r;n>=0;n--)(r=i[n])&&(e=r(e)||e);return e},U=(i,o)=>(t,s)=>o(t,s,i),O=(i,o,t)=>z(i,typeof o!="symbol"?o+"":o,t);exports.UniverSheetsNotePlugin=class extends h.Plugin{constructor(o=R,t,s){super(),this._config=o,this._configService=t,this._injector=s;const{...e}=h.merge({},R,this._config);this._configService.setConfig(V,e)}onStarting(){[[p],[I],[exports.SheetsNoteResourceController],[C]].forEach(o=>{this._injector.add(o)}),h.touchDependencies(this._injector,[[p],[I],[exports.SheetsNoteResourceController]])}onReady(){h.touchDependencies(this._injector,[[C]])}};O(exports.UniverSheetsNotePlugin,"pluginName",T);O(exports.UniverSheetsNotePlugin,"type",h.UniverInstanceType.UNIVER_SHEET);exports.UniverSheetsNotePlugin=F([h.DependentOn(l.UniverSheetsPlugin),U(1,h.IConfigService),U(2,h.Inject(h.Injector))],exports.UniverSheetsNotePlugin);exports.RemoveNoteMutation=S;exports.SheetDeleteNoteCommand=P;exports.SheetToggleNotePopupCommand=w;exports.SheetUpdateNoteCommand=x;exports.SheetsNoteModel=p;exports.ToggleNotePopupMutation=y;exports.UpdateNoteMutation=_;exports.UpdateNotePositionMutation=M;
