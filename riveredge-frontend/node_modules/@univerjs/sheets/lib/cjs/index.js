"use strict";var Bi=Object.defineProperty;var Fi=(o,e,t)=>e in o?Bi(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var S=(o,e,t)=>Fi(o,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("@univerjs/core"),O=require("rxjs"),Y=require("@univerjs/engine-formula"),Nt=require("rxjs/operators"),ji=require("@univerjs/rpc");function Gi(o,e,t){var r,a,c;if(e.t)return e.t;if(e.v===null)return null;const n=o.getStyleByCell(e),s=o.getStyleByCell(t);if(t.t===i.CellValueType.FORCE_STRING){if(!i.isTextFormat((r=s==null?void 0:s.n)==null?void 0:r.pattern)&&e.v!==void 0){if(i.isRealNum(e.v))return i.CellValueType.NUMBER;if(i.isBooleanString(`${e.v}`))return i.CellValueType.BOOLEAN}return i.CellValueType.FORCE_STRING}return zi(n)?i.isTextFormat((a=n==null?void 0:n.n)==null?void 0:a.pattern)?i.CellValueType.STRING:ns(e,t):i.isTextFormat((c=s==null?void 0:s.n)==null?void 0:c.pattern)?i.CellValueType.STRING:ns(e,t)}function ns(o,e){return o.v!==void 0?Fn(o.v,o.t):Fn(e.v,e.t)}function zi(o){var e;return!!((e=o==null?void 0:o.n)!=null&&e.pattern)}function Fn(o,e){return o===null?null:typeof o=="string"?i.isRealNum(o)?(+o==0||+o==1)&&e===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:e!==i.CellValueType.STRING&&e!==i.CellValueType.FORCE_STRING&&i.willLoseNumericPrecision(o)?i.CellValueType.FORCE_STRING:i.CellValueType.NUMBER:i.isBooleanString(o)?i.CellValueType.BOOLEAN:i.CellValueType.STRING:typeof o=="number"?(o===0||o===1)&&e===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:i.CellValueType.NUMBER:typeof o=="boolean"?i.CellValueType.BOOLEAN:i.CellValueType.FORCE_STRING}const he=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:i.Tools.deepClone(e.ranges)}},B={id:"sheet.mutation.add-worksheet-merge",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(!s)return!1;const a=s.getConfig().mergeData,c=e.ranges;for(let l=0;l<c.length;l++)a.push(c[l]);return s.getSpanModel().rebuild(a),!0}},qi=i.createInterceptorKey("CELL_CONTENT"),Yi=i.createInterceptorKey("ROW_FILTERED"),De={CELL_CONTENT:qi,ROW_FILTERED:Yi};var ws=(o=>(o[o.DATA_VALIDATION=9]="DATA_VALIDATION",o[o.NUMFMT=10]="NUMFMT",o[o.CELL_IMAGE=11]="CELL_IMAGE",o))(ws||{});const Ms="sheet.interceptor.range-theme-id",os="sheet.interceptor.ignore-range-theme";var Ki=Object.getOwnPropertyDescriptor,Ji=(o,e,t,n)=>{for(var s=n>1?void 0:n?Ki(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Xi=(o,e)=>(t,n)=>e(t,n,o);const jn=i.createInterceptorKey("BEFORE_CELL_EDIT"),nn=i.createInterceptorKey("AFTER_CELL_EDIT"),on=i.createInterceptorKey("VALIDATE_CELL");exports.SheetInterceptorService=class extends i.Disposable{constructor(t){super();S(this,"_interceptorsByName",new Map);S(this,"_commandInterceptors",[]);S(this,"_rangeInterceptors",[]);S(this,"_autoHeightInterceptors",[]);S(this,"_beforeCommandInterceptor",[]);S(this,"_afterCommandInterceptors",[]);S(this,"_workbookDisposables",new Map);S(this,"_worksheetDisposables",new Map);S(this,"_interceptorsDirty",!1);S(this,"_composedInterceptorByKey",new Map);S(this,"writeCellInterceptor",new i.InterceptorManager({BEFORE_CELL_EDIT:jn,AFTER_CELL_EDIT:nn,VALIDATE_CELL:on}));this._univerInstanceService=t,this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._interceptWorkbook(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>this._disposeWorkbookInterceptor(n))),this.intercept(De.CELL_CONTENT,{priority:-1,effect:i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value,handler:n=>n}),this.disposeWithMe(this.writeCellInterceptor.intercept(nn,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(jn,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(on,{priority:-1,handler:n=>n}))}dispose(){super.dispose(),this._workbookDisposables.forEach(t=>t.dispose()),this._workbookDisposables.clear(),this._worksheetDisposables.forEach(t=>t.dispose()),this._worksheetDisposables.clear(),this._interceptorsByName.clear()}interceptCommand(t){if(this._commandInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(t),this._commandInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._commandInterceptors,t)))}onCommandExecute(t){const n=this._commandInterceptors.map(s=>s.getMutations(t));return{preUndos:n.map(s=>{var r;return(r=s.preUndos)!=null?r:[]}).flat(),undos:n.map(s=>s.undos).flat(),preRedos:n.map(s=>{var r;return(r=s.preRedos)!=null?r:[]}).flat(),redos:n.map(s=>s.redos).flat()}}interceptAfterCommand(t){if(this._afterCommandInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._afterCommandInterceptors.push(t),this._afterCommandInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._afterCommandInterceptors,t)))}afterCommandExecute(t){const n=this._afterCommandInterceptors.map(s=>s.getMutations(t));return{undos:n.map(s=>s.undos).flat(),redos:n.map(s=>s.redos).flat()}}interceptAutoHeight(t){if(this._autoHeightInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._autoHeightInterceptors.push(t),this._autoHeightInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._autoHeightInterceptors,t)))}generateMutationsOfAutoHeight(t){const n=this._autoHeightInterceptors.map(s=>s.getMutations(t));return{preUndos:n.map(s=>{var r;return(r=s.preUndos)!=null?r:[]}).flat(),undos:n.map(s=>s.undos).flat(),preRedos:n.map(s=>{var r;return(r=s.preRedos)!=null?r:[]}).flat(),redos:n.map(s=>s.redos).flat()}}interceptBeforeCommand(t){if(this._beforeCommandInterceptor.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(t),this._beforeCommandInterceptor.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._beforeCommandInterceptor,t)))}async beforeCommandExecute(t){return(await Promise.all(this._beforeCommandInterceptor.map(s=>s.performCheck(t)))).every(s=>s)}interceptRanges(t){if(this._rangeInterceptors.includes(t))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(t),this._rangeInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._rangeInterceptors,t)))}generateMutationsByRanges(t){const n=this._rangeInterceptors.map(s=>s.getMutations(t));return{preUndos:n.map(s=>{var r;return(r=s.preUndos)!=null?r:[]}).flat(),undos:n.map(s=>s.undos).flat(),preRedos:n.map(s=>{var r;return(r=s.preRedos)!=null?r:[]}).flat(),redos:n.map(s=>s.redos).flat()}}onWriteCell(t,n,s,r,a){const c={subUnitId:n.getSheetId(),unitId:t.getUnitId(),workbook:t,worksheet:n,row:s,col:r,origin:i.Tools.deepClone(a)};return this.writeCellInterceptor.fetchThroughInterceptors(nn)(a,c)}onValidateCell(t,n,s,r){const a={subUnitId:n.getSheetId(),unitId:t.getUnitId(),workbook:t,worksheet:n,row:s,col:r};return this.writeCellInterceptor.fetchThroughInterceptors(on)(Promise.resolve(!0),a)}intercept(t,n){const s=t;this._interceptorsByName.has(s)||this._interceptorsByName.set(s,[]);const r=this._interceptorsByName.get(s);r.push(n);const a=r.sort((c,l)=>{var u,d;return((u=l.priority)!=null?u:0)-((d=c.priority)!=null?d:0)});if(this._interceptorsDirty=!0,s===De.CELL_CONTENT){const c=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;this._interceptorsByName.set(`${s}-${c}`,a);const l=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;return this._interceptorsByName.set(`${s}-${i.InterceptorEffectEnum.Style}`,a.filter(u=>((u.effect||l)&i.InterceptorEffectEnum.Style)>0)),this._interceptorsByName.set(`${s}-${i.InterceptorEffectEnum.Value}`,a.filter(u=>((u.effect||l)&i.InterceptorEffectEnum.Value)>0)),this.disposeWithMe(i.toDisposable(()=>{i.remove(this._interceptorsByName.get(s),n),i.remove(this._interceptorsByName.get(`${s}-${c}`),n),i.remove(this._interceptorsByName.get(`${s}-${i.InterceptorEffectEnum.Style}`),n),i.remove(this._interceptorsByName.get(`${s}-${i.InterceptorEffectEnum.Value}`),n)}))}else return this._interceptorsByName.set(s,a),this.disposeWithMe(i.toDisposable(()=>i.remove(this._interceptorsByName.get(s),n)))}fetchThroughInterceptors(t,n,s,r){const a=n===void 0?t:`${t}-${n}`,c=s!=null?s:a;let l=this._composedInterceptorByKey.get(c);if(!l||this._interceptorsDirty){let u=this._interceptorsByName.get(a);u&&r&&(u=u.filter(r)),l=i.composeInterceptors(u||[]),this._composedInterceptorByKey.set(c,l)}return l}_interceptWorkbook(t){const n=new i.DisposableCollection,s=t.getUnitId(),r=this,a=c=>{const l=c.getSheetId();c.__interceptViewModel(u=>{const d=new i.DisposableCollection;r._worksheetDisposables.set(ss(s,c),d),d.add(u.registerCellContentInterceptor({getCell(m,h,g,R,C){const f=c.getCellRaw(m,h);return r.fetchThroughInterceptors(De.CELL_CONTENT,g,R,C)(f,{unitId:s,subUnitId:l,row:m,col:h,worksheet:c,workbook:t,rawData:f})}})),d.add(u.registerRowFilteredInterceptor({getRowFiltered(m){return!!r.fetchThroughInterceptors(De.ROW_FILTERED)(!1,{unitId:s,subUnitId:l,row:m,workbook:t,worksheet:c})}}))})};t.getSheets().forEach(c=>a(c)),n.add(t.sheetCreated$.subscribe(c=>a(c))),n.add(i.toDisposable(()=>t.getSheets().forEach(c=>this._disposeSheetInterceptor(s,c)))),n.add(t.sheetDisposed$.subscribe(c=>this._disposeSheetInterceptor(s,c))),this._workbookDisposables.set(s,n)}_disposeWorkbookInterceptor(t){const n=t.getUnitId(),s=this._workbookDisposables.get(n);s&&(s.dispose(),this._workbookDisposables.delete(n))}_disposeSheetInterceptor(t,n){const s=ss(t,n),r=this._worksheetDisposables.get(s);r&&(r.dispose(),this._worksheetDisposables.delete(s))}};exports.SheetInterceptorService=Ji([Xi(0,i.IUniverInstanceService)],exports.SheetInterceptorService);function ss(o,e){return`${o}|${e.getSheetId()}`}const X=o=>{const e={};return o.bg&&(e.bg={...o.bg}),o.ol&&(e.ol={...o.ol}),o.bd&&(e.bd={...o.bd}),o.cl&&(e.cl={...o.cl}),o.ht&&(e.ht=o.ht),o.vt&&(e.vt=o.vt),o.bl!==void 0&&(e.bl=o.bl),e};function Zi(o){const e={};if(o.length===1)return o[0];for(const t of o)t.bg&&(e.bg=t.bg),t.ol&&(e.ol=t.ol),t.bd&&(e.bd={...e.bd,...t.bd}),t.cl&&(e.cl=t.cl),t.ht&&(e.ht=t.ht),t.vt&&(e.vt=t.vt),t.bl!==void 0&&(e.bl=t.bl);return e}const K={wholeStyle:1,headerRowStyle:2,headerColumnStyle:4,firstRowStyle:8,secondRowStyle:16,lastRowStyle:32,firstColumnStyle:128,secondColumnStyle:256,lastColumnStyle:512};class xe{constructor(e,t){S(this,"_name");S(this,"wholeStyle",null);S(this,"headerRowStyle",null);S(this,"headerColumnStyle",null);S(this,"firstRowStyle",null);S(this,"secondRowStyle",null);S(this,"lastRowStyle",null);S(this,"firstColumnStyle",null);S(this,"secondColumnStyle",null);S(this,"lastColumnStyle",null);S(this,"_mergeCacheMap",new Map);t&&this.fromJson({...t,name:e}),this._name=e}getName(){return this._name}getWholeStyle(){return this.wholeStyle}setWholeStyle(e){this.wholeStyle=e,this._resetStyleCache()}getFirstRowStyle(){return this.firstRowStyle}setFirstRowStyle(e){this.firstRowStyle=e,this._resetStyleCache()}getSecondRowStyle(){return this.secondRowStyle}setSecondRowStyle(e){this.secondRowStyle=e,this._resetStyleCache()}getLastRowStyle(){return this.lastRowStyle}setLastRowStyle(e){this.lastRowStyle=e,this._resetStyleCache()}getFirstColumnStyle(){return this.firstColumnStyle}setFirstColumnStyle(e){this.firstColumnStyle=e,this._resetStyleCache()}getSecondColumnStyle(){return this.secondColumnStyle}setSecondColumnStyle(e){this.secondColumnStyle=e,this._resetStyleCache()}getLastColumnStyle(){return this.lastColumnStyle}setLastColumnStyle(e){this.lastColumnStyle=e,this._resetStyleCache()}getHeaderRowStyle(){return this.headerRowStyle}setHeaderRowStyle(e){this.headerRowStyle=e,this._resetStyleCache()}getHeaderColumnStyle(){return this.headerColumnStyle}setHeaderColumnStyle(e){this.headerColumnStyle=e,this._resetStyleCache()}getStyle(e,t,n,s,r){let a=0;return n&&(a=a|K.lastRowStyle),s&&(a=a|K.lastColumnStyle),e>=0&&t>=0&&(a=a|K.wholeStyle),e%2===1&&(a=a|(r?K.secondRowStyle:K.firstRowStyle)),e%2===0&&(a=a|(r?K.firstRowStyle:K.secondRowStyle)),e===0&&(a=a|K.headerRowStyle),t===0&&(a=a|K.headerColumnStyle),t%2===1&&(a=a|K.firstColumnStyle),t%2===0&&(a=a|K.secondColumnStyle),a===0?null:this._getMergeStyle(a)}_getMergeStyle(e){let t=this._mergeCacheMap.get(e);return t||(t=this._mergeStyle(e),this._mergeCacheMap.set(e,t)),t}_mergeStyle(e){const t=[];return this.wholeStyle&&e&K.wholeStyle&&t.push(this.wholeStyle),this.firstColumnStyle&&e&K.firstColumnStyle&&t.push(this.firstColumnStyle),this.secondColumnStyle&&e&K.secondColumnStyle&&t.push(this.secondColumnStyle),this.firstRowStyle&&e&K.firstRowStyle&&t.push(this.firstRowStyle),this.secondRowStyle&&e&K.secondRowStyle&&t.push(this.secondRowStyle),this.headerColumnStyle&&e&K.headerColumnStyle&&t.push(this.headerColumnStyle),this.lastColumnStyle&&e&K.lastColumnStyle&&t.push(this.lastColumnStyle),this.headerRowStyle&&e&K.headerRowStyle&&t.push(this.headerRowStyle),this.lastRowStyle&&e&K.lastRowStyle&&t.push(this.lastRowStyle),Zi(t)}_resetStyleCache(){this._mergeCacheMap.clear()}toJson(){const e={name:this._name};return this.wholeStyle&&(e.wholeStyle=X(this.wholeStyle)),this.headerRowStyle&&(e.headerRowStyle=X(this.headerRowStyle)),this.headerColumnStyle&&(e.headerColumnStyle=X(this.headerColumnStyle)),this.firstRowStyle&&(e.firstRowStyle=X(this.firstRowStyle)),this.secondRowStyle&&(e.secondRowStyle=X(this.secondRowStyle)),this.lastRowStyle&&(e.lastRowStyle=X(this.lastRowStyle)),this.firstColumnStyle&&(e.firstColumnStyle=X(this.firstColumnStyle)),this.secondColumnStyle&&(e.secondColumnStyle=X(this.secondColumnStyle)),this.lastColumnStyle&&(e.lastColumnStyle=X(this.lastColumnStyle)),e}fromJson(e){this._name=e.name,e.wholeStyle&&(this.wholeStyle=X(e.wholeStyle)),e.headerRowStyle&&(this.headerRowStyle=X(e.headerRowStyle)),e.headerColumnStyle&&(this.headerColumnStyle=X(e.headerColumnStyle)),e.firstRowStyle&&(this.firstRowStyle=X(e.firstRowStyle)),e.secondRowStyle&&(this.secondRowStyle=X(e.secondRowStyle)),e.lastRowStyle&&(this.lastRowStyle=X(e.lastRowStyle)),e.firstColumnStyle&&(this.firstColumnStyle=X(e.firstColumnStyle)),e.secondColumnStyle&&(this.secondColumnStyle=X(e.secondColumnStyle)),e.lastColumnStyle&&(this.lastColumnStyle=X(e.lastColumnStyle))}dispose(){this._mergeCacheMap.clear()}}const Qi=(o,e,t)=>new xe(`light-${o}`,{headerRowStyle:{bg:{rgb:e}},firstColumnStyle:{bg:{rgb:"rgb(255, 255, 255)"}},secondColumnStyle:{bg:{rgb:t}},lastRowStyle:{bg:{rgb:e}}}),ea=(o,e,t)=>new xe(`middle-${o}`,{headerRowStyle:{bg:{rgb:e}},headerColumnStyle:{bg:{rgb:t}},secondRowStyle:{bg:{rgb:t}},lastRowStyle:{bg:{rgb:e}},lastColumnStyle:{bg:{rgb:t}}}),ta=(o,e,t,n)=>new xe(`dark-${o}`,{headerRowStyle:{bg:{rgb:e},cl:{rgb:"rgb(255, 255, 255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:t}},secondRowStyle:{bg:{rgb:n}},lastRowStyle:{bg:{rgb:e}}}),na=[{baseName:"blue",header:"rgb(164, 202, 254)",color:"rgb(225, 239, 254)"},{baseName:"grey",header:"rgb(205, 208, 216)",color:"rgb(238, 239, 241)"},{baseName:"red",header:"rgb(248, 180, 180)",color:"rgb(253, 232, 232)"},{baseName:"orange",header:"rgb(253, 186, 140)",color:"rgb(254, 236, 220)"},{baseName:"yellow",header:"rgb(250, 200, 21)",color:"rgb(255, 244, 185)"},{baseName:"green",header:"rgb(132, 225, 188)",color:"rgb(222, 247, 236)"},{baseName:"azure",header:"rgb(126, 220, 226)",color:"rgb(213, 245, 246)"},{baseName:"indigo",header:"rgb(186, 198, 248)",color:"rgb(233, 237, 255)"},{baseName:"purple",header:"rgb(202, 191, 253)",color:"rgb(237, 235, 254)"},{baseName:"magenta",header:"rgb(248, 180, 217)",color:"rgb(252, 232, 243)"}],oa=[{baseName:"blue",rowHeader:"rgb(63, 131, 248)",colHeader:"rgb(195, 221, 253)"},{baseName:"grey",rowHeader:"rgb(95, 101, 116)",colHeader:"rgb(227, 229, 234)"},{baseName:"red",rowHeader:"rgb(240, 82, 82)",colHeader:"rgb(251, 213, 213)"},{baseName:"orange",rowHeader:"rgb(255, 90, 31)",colHeader:"rgb(252, 217, 189)"},{baseName:"yellow",rowHeader:"rgb(212, 157, 15)",colHeader:"rgb(252, 220, 106)"},{baseName:"green",rowHeader:"rgb(13, 164, 113)",colHeader:"rgb(188, 240, 218)"},{baseName:"azure",rowHeader:"rgb(6, 148, 162)",colHeader:"rgb(175, 236, 239)"},{baseName:"indigo",rowHeader:"rgb(70, 106, 247)",colHeader:"rgb(210, 218, 250)"},{baseName:"purple",rowHeader:"rgb(144, 97, 249)",colHeader:"rgb(220, 215, 254)"},{baseName:"magenta",rowHeader:"rgb(231, 70, 148)",colHeader:"rgb(250, 209, 232)"}],sa=[{baseName:"blue",rowHeader:"rgb(30, 66, 159)",firstRow:"rgb(195, 221, 253)",secondRow:"rgb(118, 169, 250)"},{baseName:"grey",rowHeader:"rgb(44, 48, 64)",firstRow:"rgb(227, 229, 234)",secondRow:"rgb(151, 157, 172)"},{baseName:"red",rowHeader:"rgb(155, 28, 28)",firstRow:"rgb(251, 213, 213)",secondRow:"rgb(249, 128, 128)"},{baseName:"orange",rowHeader:"rgb(180, 52, 3)",firstRow:"rgb(252, 217, 189)",secondRow:"rgb(255, 138, 76)"},{baseName:"yellow",rowHeader:"rgb(154, 109, 21)",firstRow:"rgb(252, 220, 106)",secondRow:"rgb(212, 157, 15)"},{baseName:"green",rowHeader:"rgb(4, 108, 78)",firstRow:"rgb(188, 240, 218)",secondRow:"rgb(49, 196, 141)"},{baseName:"azure",rowHeader:"rgb(3, 102, 114)",firstRow:"rgb(175, 236, 239)",secondRow:"rgb(22, 189, 202)"},{baseName:"indigo",rowHeader:"rgb(16, 51, 191)",firstRow:"rgb(210, 218, 250)",secondRow:"rgb(98, 128, 249)"},{baseName:"purple",rowHeader:"rgb(74, 29, 150)",firstRow:"rgb(220, 215, 254)",secondRow:"rgb(172, 148, 250)"},{baseName:"magenta",rowHeader:"rgb(153, 21, 75)",firstRow:"rgb(250, 209, 232)",secondRow:"rgb(241, 126, 184)"}],ra=na.map(({baseName:o,header:e,color:t})=>Qi(o,e,t)),ia=oa.map(({baseName:o,rowHeader:e,colHeader:t})=>ea(o,e,t)),aa=sa.map(({baseName:o,rowHeader:e,firstRow:t,secondRow:n})=>ta(o,e,t,n)),ca=[...ra,...ia,...aa],ys={headerRowStyle:{bg:{rgb:"rgb(68,114,196)"},cl:{rgb:"rgb(255,255,255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:"rgb(217,225,242)"}}},la=new xe("default",ys),ua=new xe("default-last-row",{...ys,lastRowStyle:{bd:{t:{s:i.BorderStyleTypes.THIN,cl:{rgb:"rgb(68,114,196)"}}},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE}});class da{constructor(){S(this,"_toggleRanges",[])}refresh(e,t){const{startRow:n,endRow:s}=e,r=[];let a=0,c=!1,l=-1;for(let u=n;u<=s;u++){if(!t(u)){a++,a%2===1?c=!0:(c=!1,l!==-1&&(r.push([l,u-1]),l=-1));continue}a%2===1?c?l===-1&&(l=u):(c=!0,l=u):c&&(r.push([l,u-2]),c=!1,l=-1),u===s&&c&&r.push([l,u])}this._toggleRanges=r}getToggleRanges(){return this._toggleRanges.concat()}getIsToggled(e){let t=0,n=this._toggleRanges.length-1;for(;t<=n;){const s=Math.floor((t+n)/2),[r,a]=this._toggleRanges[s];if(e<r)n=s-1;else if(e>a)t=s+1;else return!0}return!1}}var ma=Object.getOwnPropertyDescriptor,ha=(o,e,t,n)=>{for(var s=n>1?void 0:n?ma(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Wn=(o,e)=>(t,n)=>e(t,n,o);const ga="SHEET_RANGE_THEME_MODEL_PLUGIN";exports.SheetRangeThemeModel=class extends i.Disposable{constructor(t,n,s){super();S(this,"_rangeThemeStyleMap",new Map);S(this,"_rangeThemeStyleRuleMap",new Map);S(this,"_rTreeCollection",new Map);S(this,"_defaultRangeThemeMap",new Map);S(this,"_zebraCrossingCacheMap",new Map);S(this,"_rowVisibleFuncSet",new Map);S(this,"_rangeThemeMapChanged$",new O.Subject);S(this,"rangeThemeMapChange$",this._rangeThemeMapChanged$.asObservable());this._sheetInterceptorService=t,this._resourceManagerService=n,this._univerInstanceService=s,this._registerIntercept(),this._initSnapshot(),this._initDefaultTheme()}_initDefaultTheme(){this.registerDefaultRangeTheme(la),this.registerDefaultRangeTheme(ua);for(const t of ca)this.registerDefaultRangeTheme(t)}_ensureRangeThemeStyleMap(t){return this._rangeThemeStyleMap.has(t)||this._rangeThemeStyleMap.set(t,new Map),this._rangeThemeStyleMap.get(t)}_ensureRangeThemeStyleRuleMap(t){return this._rangeThemeStyleRuleMap.has(t)||this._rangeThemeStyleRuleMap.set(t,new Map),this._rangeThemeStyleRuleMap.get(t)}_ensureRTreeCollection(t){return this._rTreeCollection.has(t)||this._rTreeCollection.set(t,new i.RTree),this._rTreeCollection.get(t)}getDefaultRangeThemeStyle(t){return this._defaultRangeThemeMap.get(t)}getCustomRangeThemeStyle(t,n){return this._ensureRangeThemeStyleMap(t).get(n)}_getSheetRowVisibleFuncSet(t,n){this._rowVisibleFuncSet.has(t)||this._rowVisibleFuncSet.set(t,new Map);const s=this._rowVisibleFuncSet.get(t);return s.has(n)||s.set(n,new Set),s.get(n)}_getSheetRowVisibleHasInit(t,n){var s;return!!(this._rowVisibleFuncSet.has(t)&&((s=this._rowVisibleFuncSet.get(t))!=null&&s.has(n)))}refreshSheetRowVisibleFuncSet(t,n){const s=this._getSheetRowVisibleFuncSet(t,n);s.clear();const r=this._univerInstanceService.getUnit(t);if(r){const a=r.getSheetBySheetId(n);if(a){const c=a.getRowCount(),l=a.getRowManager();for(let u=1;u<=c;u++)a.getRowVisible(u)?l.getRowHeight(u)===0&&s.add(u):s.add(u)}}}_ensureZebraCrossingCache(t,n,s){this._zebraCrossingCacheMap.has(t)||this._zebraCrossingCacheMap.set(t,new Map);const r=this._zebraCrossingCacheMap.get(t);r.has(n)||r.set(n,new Map);const a=r.get(n);return a.has(s)||a.set(s,new da),a.get(s)}registerRangeThemeRule(t,n){const{unitId:s,subUnitId:r,range:a}=n,c=i.generateRandomId(),l=this._ensureRangeThemeStyleRuleMap(s),u=this._ensureRTreeCollection(s);l.set(c,{rangeInfo:n,themeName:t}),u.insert({unitId:s,sheetId:r,range:a,id:c}),this._getSheetRowVisibleHasInit(s,r)||this.refreshSheetRowVisibleFuncSet(s,r);const d=this._ensureZebraCrossingCache(s,r,c),m=this._getSheetRowVisibleFuncSet(s,r);d.refresh(a,h=>!m.has(h))}getRegisteredRangeThemeStyle(t){const{unitId:n,subUnitId:s,range:r}=t,a=this._ensureRTreeCollection(n),c=Array.from(a.bulkSearch([{unitId:n,sheetId:s,range:r}]));if(c[0]){const u=this._ensureRangeThemeStyleRuleMap(n).get(c[0]);if(u)return u.themeName}}refreshZebraCrossingCacheBySheet(t,n){this._zebraCrossingCacheMap.has(t)||this._zebraCrossingCacheMap.set(t,new Map);const s=this._zebraCrossingCacheMap.get(t);s.has(n)||s.set(n,new Map);const r=s.get(n);r&&r.forEach((a,c)=>{const u=this._ensureRangeThemeStyleRuleMap(t).get(c);u?a.refresh(u.rangeInfo.range,d=>!this._getSheetRowVisibleFuncSet(t,n).has(d)):r.delete(c)})}removeRangeThemeRule(t,n){const{unitId:s,subUnitId:r,range:a}=n,c=this._ensureRTreeCollection(s),l=Array.from(c.bulkSearch([{unitId:s,sheetId:r,range:a}])),u=this._ensureRangeThemeStyleRuleMap(s);for(let d=0;d<l.length;d++){const m=u.get(l[d]);if(m&&m.themeName===t){u.delete(l[d]),c.remove({unitId:s,sheetId:r,range:a,id:l[d]});const h=this._zebraCrossingCacheMap.get(s);if(h){const g=h.get(r);g&&g.delete(l[d])}break}}}registerDefaultRangeTheme(t){this._defaultRangeThemeMap.set(t.getName(),t),this._rangeThemeMapChanged$.next({type:"add",styleName:t.getName()})}unRegisterDefaultRangeTheme(t){this._defaultRangeThemeMap.delete(t),this._rangeThemeMapChanged$.next({type:"remove",styleName:t})}getRegisteredRangeThemes(){return Array.from(this._defaultRangeThemeMap.keys())}registerRangeThemeStyle(t,n){this._ensureRangeThemeStyleMap(t).set(n.getName(),n),this._rangeThemeMapChanged$.next({type:"add",styleName:n.getName()})}unregisterRangeThemeStyle(t,n){this._ensureRangeThemeStyleMap(t).delete(n),this._rangeThemeMapChanged$.next({type:"remove",styleName:n})}getALLRegisteredTheme(t){return Array.from(this._ensureRangeThemeStyleMap(t).keys())}getRangeThemeStyle(t,n){return this._defaultRangeThemeMap.has(n)?this._defaultRangeThemeMap.get(n):this._ensureRangeThemeStyleMap(t).get(n)}getCellStyle(t,n,s,r){const a={startRow:s,startColumn:r,endRow:s,endColumn:r},c=this._ensureRTreeCollection(t),l=Array.from(c.bulkSearch([{unitId:t,sheetId:n,range:a}]));if(l[0]){const d=this._ensureRangeThemeStyleRuleMap(t).get(l[0]);if(d){const{rangeInfo:m,themeName:h}=d,g=s-m.range.startRow,R=r-m.range.startColumn,C=this.getRangeThemeStyle(t,h),p=this._ensureZebraCrossingCache(t,n,l[0]).getIsToggled(s);if(C)return C.getStyle(g,R,s===m.range.endRow,r===m.range.endColumn,p)}}}_registerIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{id:Ms,effect:i.InterceptorEffectEnum.Style,handler:(t,n,s)=>{const{row:r,col:a,unitId:c,subUnitId:l}=n,u=this.getCellStyle(c,l,r,a);if(u){const d=!t||t===n.rawData?{...n.rawData}:t;return d.themeStyle=u,s(d)}return s(t)}}))}toJson(t){const n=this._ensureRangeThemeStyleRuleMap(t),s=this._ensureRangeThemeStyleMap(t);if(s.size===0&&n.size===0)return"{}";const r={};n.forEach((c,l)=>{r[l]=c});const a={};return s.forEach((c,l)=>{a[l]=c.toJson()}),JSON.stringify({rangeThemeStyleRuleMap:r,rangeThemeStyleMapJson:a})}fromJSON(t,n){const{rangeThemeStyleRuleMap:s,rangeThemeStyleMapJson:r}=n;s&&Object.keys(s).forEach(a=>{const c=s[a],{themeName:l,rangeInfo:u}=c;l.startsWith("table")||(this.registerRangeThemeRule(l,u),this._ensureRTreeCollection(u.unitId).insert({unitId:a,sheetId:u.subUnitId,range:u.range,id:a}))}),r&&Object.keys(r).forEach(a=>{const c=r[a],l=new xe(c.name);l.fromJson(c),this._ensureRangeThemeStyleMap(t).set(l.getName(),l)})}deleteUnitId(t){this._rangeThemeStyleMap.delete(t),this._rangeThemeStyleRuleMap.delete(t),this._rTreeCollection.delete(t)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t=>this.toJson(t),parseJson:t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}},businesses:[i.UniverInstanceType.UNIVER_SHEET],pluginName:ga,onLoad:(t,n)=>{this.fromJSON(t,n)},onUnLoad:t=>{this.deleteUnitId(t)}}))}dispose(){super.dispose(),this._rangeThemeStyleMap.clear(),this._rangeThemeStyleRuleMap.clear(),this._defaultRangeThemeMap.clear(),this._rTreeCollection.clear(),this._zebraCrossingCacheMap.clear(),this._rowVisibleFuncSet.clear()}};exports.SheetRangeThemeModel=ha([Wn(0,i.Inject(exports.SheetInterceptorService)),Wn(1,i.Inject(i.IResourceManagerService)),Wn(2,i.Inject(i.IUniverInstanceService))],exports.SheetRangeThemeModel);function Yn(o,e){const{unitId:t}=e,n=t?o.getUnit(t,i.UniverInstanceType.UNIVER_SHEET):o.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);return n?{workbook:n,unitId:n.getUnitId()}:null}function k(o,e={}){const{unitId:t,subUnitId:n}=e,s=t?o.getUnit(t,i.UniverInstanceType.UNIVER_SHEET):o.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);if(!s)return null;const r=n?s.getSheetBySheetId(n):s.getActiveSheet(!0);return r?{worksheet:r,workbook:s,unitId:s.getUnitId(),subUnitId:r.getSheetId()}:null}function _e(o,e){const{unitId:t,subUnitId:n}=e,s=o.getUnit(t,i.UniverInstanceType.UNIVER_SHEET);if(!s)return null;const r=s.getSheetBySheetId(n);return r?{worksheet:r,workbook:s}:null}const gt={id:"sheet.mutation.set-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,range:s,themeName:r}=e,a=o.get(i.IUniverInstanceService),c=k(a),l=o.get(exports.SheetRangeThemeModel);return c?(l.registerRangeThemeRule(r,{range:s,unitId:t,subUnitId:n}),!0):!1}},_s=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetRangeThemeStyleMutation]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,subUnitId:n.getSheetId(),range:e.range,themeName:e.themeName}},Rt={id:"sheet.mutation.remove-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,range:s,themeName:r}=e,a=o.get(i.IUniverInstanceService),c=k(a),l=o.get(exports.SheetRangeThemeModel);return c?(l.removeRangeThemeRule(r,{range:s,unitId:t,subUnitId:n}),!0):!1}},bs=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[DeleteWorksheetRangeThemeStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,subUnitId:n.getSheetId(),range:e.range,themeName:e.themeName}},In=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}},ae={id:"sheet.mutation.insert-row",type:i.CommandType.MUTATION,handler:(o,e)=>{var R;const{unitId:t,subUnitId:n,range:s,rowInfo:r}=e,c=o.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(c==null)throw new Error("universheet is null error!");const l=c.getSheetBySheetId(n);if(l==null)throw new Error("worksheet is null error!");const u=l.getRowManager().getRowData(),d={h:l.getConfig().defaultRowHeight,hd:0},m=s.startRow,h=s.endRow-s.startRow+1;for(let C=m;C<m+h;C++)r?i.insertMatrixArray(C,(R=r[C-s.startRow])!=null?R:d,u):i.insertMatrixArray(C,d,u);return l.setRowCount(l.getRowCount()+h),l.getCellMatrix().insertRows(s.startRow,h),!0}},Ft=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}},ce={id:"sheet.mutation.insert-col",type:i.CommandType.MUTATION,handler:(o,e)=>{var R;const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(!s)return!1;const r=s.getColumnManager(),{range:a,colInfo:c}=e,u=r.getColumnData(),d=a.startColumn,m=a.endColumn-a.startColumn+1,h=s.getConfig().defaultColumnWidth;for(let C=d;C<d+m;C++){const f={w:h,hd:0};c?i.insertMatrixArray(C,(R=c[C-a.startColumn])!=null?R:f,u):i.insertMatrixArray(C,f,u)}return s.setColumnCount(s.getColumnCount()+a.endColumn-a.startColumn+1),s.getCellMatrix().insertColumns(a.startColumn,m),!0}},Be={id:"sheet.mutation.move-range",type:i.CommandType.MUTATION,handler:(o,e)=>{const{from:t,to:n}=e;if(!t||!n)return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getSheetBySheetId(e.from.subUnitId),c=r.getSheetBySheetId(e.to.subUnitId);if(!a||!c)return!1;const l=a.getCellMatrix(),u=c.getCellMatrix();return new i.ObjectMatrix(t.value).forValue((d,m,h)=>{h==null?l.realDeleteValue(d,m):l.setValue(d,m,h)}),new i.ObjectMatrix(n.value).forValue((d,m,h)=>{h==null?u.realDeleteValue(d,m):u.setValue(d,m,h)}),!0}};function Es(o,e){const{unitId:t,subUnitId:n,sourceRange:s,targetRange:r}=e,a=s.startRow>r.startRow,c=s.endRow-s.startRow+1;return a?{unitId:t,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...s,endRow:s.endRow+c,startRow:s.startRow+c}}:{unitId:t,subUnitId:n,targetRange:i.Rectangle.clone(s),sourceRange:{...r,endRow:r.endRow-c,startRow:r.startRow-c}}}const ve={id:"sheet.mutation.move-rows",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,sourceRange:s,targetRange:r}=e,c=o.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(!c)throw new Error("[MoveRowMutation] univerSheet is null!");const l=c.getSheetBySheetId(n);if(!l)throw new Error("[MoveRowMutation] worksheet is null!");const u=s.startRow,d=s.endRow-s.startRow+1,m=r.startRow,h=l.getRowManager().getRowData();return i.moveMatrixArray(u,d,m,h),l.getCellMatrix().moveRows(u,d,m),!0}};function Ts(o,e){const{unitId:t,subUnitId:n,sourceRange:s,targetRange:r}=e,a=s.startColumn>r.startColumn,c=s.endColumn-s.startColumn+1;return a?{unitId:t,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...s,endColumn:s.endColumn+c,startColumn:s.startColumn+c}}:{unitId:t,subUnitId:n,targetRange:i.Rectangle.clone(s),sourceRange:{...r,startColumn:r.startColumn-c,endColumn:r.endColumn-c}}}const we={id:"sheet.mutation.move-columns",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,sourceRange:s,targetRange:r}=e,c=o.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(!c)throw new Error("[MoveColumnMutation] univerSheet is null!");const l=c.getSheetBySheetId(n);if(!l)throw new Error("[MoveColumnMutation] worksheet is null!");const u=s.startColumn,d=s.endColumn-s.startColumn+1,m=r.startColumn,h=l.getColumnManager().getColumnData();return i.moveMatrixArray(u,d,m,h),l.getCellMatrix().moveColumns(u,d,m),!0}},Ra=(o,e)=>{const s=e.getRowManager().getRowData(),r={},a=o.range,c=i.sliceMatrixArray(a.startRow,a.endRow,s),l=i.concatMatrixArray(r,c);return{unitId:o.unitId,subUnitId:o.subUnitId,range:o.range,rowInfo:l}},le={id:"sheet.mutation.remove-rows",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(!s)return!1;const r=e.range,c=s.getRowManager().getRowData();for(let d=r.startRow;d<=r.endRow;d++)s.getRowFiltered(d);const l=r.endRow-r.startRow+1;return i.spliceArray(r.startRow,l,c),s.getCellMatrix().removeRows(r.startRow,l),s.setRowCount(s.getRowCount()-l),!0}},Ca=(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(s==null)throw new Error("worksheet is null error!");const c=s.getColumnManager().getColumnData(),l={},u=e.range,d=i.sliceMatrixArray(u.startColumn,u.endColumn,c),m=i.concatMatrixArray(l,d);return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,colInfo:m}},ne={id:"sheet.mutation.remove-col",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(!s)return!1;const r=e.range,c=s.getColumnManager().getColumnData(),l=r.endColumn-r.startColumn+1;return i.spliceArray(r.startColumn,l,c),s.setColumnCount(s.getColumnCount()-l),s.getCellMatrix().removeColumns(r.startColumn,l),!0}},se=(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(s==null)throw new Error("worksheet is null error!");const a=s.getConfig().mergeData,c=e.ranges,l=[];for(let u=0;u<c.length;u++)for(let d=a.length-1;d>=0;d--){const m=a[d],h=c[u];i.Rectangle.intersects(m,h)&&l.push(a[d])}return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:l}},F={id:"sheet.mutation.remove-worksheet-merge",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(!s)return!1;const a=s.getConfig().mergeData,c=e.ranges;for(let l=0;l<c.length;l++)for(let u=a.length-1;u>=0;u--){const d=a[u],m=c[l];i.Rectangle.intersects(d,m)&&a.splice(u,1)}return s.getSpanModel().rebuild(a),!0}},Us=o=>{const{order:e}=o,t={};return Object.keys(e).forEach(n=>{t[e[Number(n)]]=Number(n)}),{...o,order:t}},At={id:"sheet.mutation.reorder-range",type:i.CommandType.MUTATION,handler:(o,e)=>{const{subUnitId:t,unitId:n,range:s,order:r}=e,l=o.get(i.IUniverInstanceService).getUnit(n).getSheetBySheetId(t);if(!l)return!1;const u=new i.ObjectMatrix;i.Range.foreach(s,(m,h)=>{if(r.hasOwnProperty(m)){const g=r[m],R=i.Tools.deepClone(l.getCellRaw(g,h));u.setValue(m,h,R)}});const d=l.getCellMatrix();return u.forValue((m,h,g)=>{d.setValue(m,h,g)}),!0}};function Sa(o,e){if(o==null)return o;const t=i.Tools.deepClone(o);if(e==null)return t;const n={};return"h"in e&&(n.h=t.h),"ia"in e&&(n.ia=t.ia),"ah"in e&&(n.ah=t.ah),"hd"in e&&(n.hd=t.hd),"s"in e&&(n.s=t.s),"custom"in e&&(n.custom=t.custom),n}function fa(o,e){if(o==null)return o;const t=i.Tools.deepClone(o);if(e==null)return t;const n={};return"w"in e&&(n.w=t.w),"hd"in e&&(n.hd=t.hd),"s"in e&&(n.s=t.s),"custom"in e&&(n.custom=t.custom),n}const ks=(o,e)=>{const{unitId:t,subUnitId:n,columnData:s}=o,r={},a=e.getColumnManager();for(const c in s){const l=s[c],u=a.getColumn(Number(c));r[c]=fa(u,l)}return{unitId:t,subUnitId:n,columnData:r}},rt={id:"sheet.mutation.set-col-data",type:i.CommandType.MUTATION,handler:(o,e)=>{const{columnData:t}=e,n=o.get(i.IUniverInstanceService),s=k(n,e);if(!s)return!1;const{worksheet:r}=s,a=r.getColumnManager();for(const c in t){const l=t[c];if(l==null){a.removeColumn(Number(c));continue}const u=a.getColumnOrCreate(Number(c));Object.assign(u,l)}return!0}},pa=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},Ct={id:"sheet.mutation.set-col-hidden",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!n)return!1;const s=n.getSheetBySheetId(e.subUnitId).getColumnManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let c=a.startColumn;c<a.endColumn+1;c++){const l=s.getColumnOrCreate(c);l!=null&&(l.hd=i.BooleanNumber.TRUE)}}return!0}},Ia=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},St={id:"sheet.mutation.set-col-visible",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!n)return!1;const s=n.getSheetBySheetId(e.subUnitId).getColumnManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let c=a.startColumn;c<a.endColumn+1;c++){const l=s.getColumnOrCreate(c);l!=null&&(l.hd=i.BooleanNumber.FALSE)}}return!0}},it={id:"sheet.mutation.set-gridlines-color",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=k(o.get(i.IUniverInstanceService),e);if(!t)return!1;const{worksheet:n}=t,s=n.getConfig();return s.gridlinesColor=e.color,!0}};function va(o,e,t){var a;const n=o.getStyleByCell(e);n==null&&delete e.s,typeof t.s=="string"&&(t.s=o.get(t.s));const s=sn(n,t.s?t.s:null);s&&(i.Tools.removeNull(s),Object.entries(s).forEach(([c,l])=>{typeof l=="object"&&l!==null&&Object.keys(l).length===0&&delete s[c]})),i.Tools.isEmptyObject(s)?delete e.s:e.s=o.setValue(s);const r=t.v?`${t.v}\r
`:"";!t.p&&e.p&&(r&&r!==((a=e.p.body)==null?void 0:a.dataStream)?delete e.p:ya(e.p,t.s?t.s:null))}function wa(o,e){if(!e||!Object.keys(e).length)return o;const t=i.Tools.deepClone(o!=null?o:{});for(const n in e)n==="bd"?t[n]=Ma(t[n]||{},e[n]):n in t||(t[n]=null);return t}function Ma(o,e){if(!e||!Object.keys(e).length)return o;for(const t in e)t in o||(o[t]=null);return o}function sn(o,e,t=!1){if(e===null)return e;if(e===void 0)return o;const n=i.Tools.deepClone(o)||{};for(const s in e)t&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(s)||(s in n&&s==="bd"?n[s]=Object.assign(n[s],e[s]):n[s]=e[s]);return"cl"in n&&("ul"in n&&n.ul&&(n.ul.cl=n.cl),"ol"in n&&n.ol&&(n.ol.cl=n.cl),"st"in n&&n.st&&(n.st.cl=n.cl)),n}function Ps(o,e){return o.some(t=>t.startIndex===e)?Ps(o,e+1):e}function ya(o,e){var a;if(o.body==null)return;Array.isArray(o.body.textRuns)||(o.body.textRuns=[]);let t=0;const n=[],s=((a=o.body)==null?void 0:a.paragraphs)||[];for(const c of o.body.textRuns){const{st:l,ed:u,ts:d={}}=c;if(t<l){const h={st:t,ed:l},g=sn({},e,!0);g&&i.Tools.removeNull(g),i.Tools.isEmptyObject(g)||(h.ts=g),n.push(h)}const m=sn(d,e,!0);m&&i.Tools.removeNull(m),i.Tools.isEmptyObject(m)?delete c.ts:c.ts=m,n.push(c),t=Ps(s,u)}const r=o.body.dataStream.endsWith(`\r
`)?o.body.dataStream.length-2:o.body.dataStream.length;if(t<r){const c={st:t,ed:r},l=sn({},e,!0);l&&i.Tools.removeNull(l),i.Tools.isEmptyObject(l)||(c.ts=l),n.push(c)}o.body.textRuns=i.normalizeTextRuns(n)}function rs(o,e){return e.v===void 0||e.v===null?e.v:o===i.CellValueType.NUMBER?Number(e.v):o===i.CellValueType.BOOLEAN?_a(e.v)?1:0:o===i.CellValueType.STRING||o===i.CellValueType.FORCE_STRING?`${e.v}`:e.v}function _a(o){if(typeof o=="string"){if(o.toUpperCase()==="TRUE")return!0;if(o.toUpperCase()==="FALSE")return!1;if(i.isSafeNumeric(o)){if(Number(o)===0)return!1;if(Number(o)===1)return!0}}if(typeof o=="number"){if(o===0)return!1;if(o===1)return!0}return typeof o=="boolean"?o:null}function ba(o){return o==null?null:(o.f===void 0&&(o.f=null),o.si===void 0&&(o.si=null),o.p===void 0&&(o.p=null),o.v===void 0&&(o.v=null),o.t===void 0&&(o.t=null),o.s===void 0&&(o.s=null),o.custom===void 0&&(o.custom=null),o)}const me=(o,e)=>{const{unitId:t,subUnitId:n,cellValue:s}=e,a=o.get(i.IUniverInstanceService).getUniverSheetInstance(t);if(a==null)throw new Error("workbook is null error!");const c=a.getSheetBySheetId(n);if(c==null)throw new Error("worksheet is null error!");const l=c.getCellMatrix(),u=a.getStyles(),d=new i.ObjectMatrix;return new i.ObjectMatrix(s).forValue((h,g,R)=>{const C=i.Tools.deepClone(l==null?void 0:l.getValue(h,g))||{},f=u.getStyleByCell(C),p=u.getStyleByCell(R);C.s=wa(f,p),d.setValue(h,g,ba(C))}),{...e,options:{},cellValue:d.getMatrix()}},H={id:"sheet.mutation.set-range-values",type:i.CommandType.MUTATION,handler:(o,e)=>{const{cellValue:t,subUnitId:n,unitId:s}=e,a=o.get(i.IUniverInstanceService).getUnit(s);if(!a)return!1;const c=a.getSheetBySheetId(n);if(!c)return!1;const l=c.getCellMatrix(),u=a.getStyles();return new i.ObjectMatrix(t).forValue((m,h,g)=>{if(!g)l.realDeleteValue(m,h);else{let R=l.getValue(m,h)||{};R=Ta(g,R,u),i.Tools.isEmptyObject(R)?l.realDeleteValue(m,h):l.setValue(m,h,R)}}),!0}},Ea=new Set(["f","p","si","custom","ref","xf"]);function Ta(o,e,t){const n=Gi(t,o,e);return Object.keys(o).forEach(s=>{const r=s;if(Ea.has(r)){const a=o[r];Ua(e,r,a)}else r==="v"?o.v!==void 0&&(e.v=rs(n,o)):r==="s"&&va(t,e,o)}),e.v!==void 0&&(e.t=n,e.v=rs(n,e)),e.v===null&&(delete e.t,delete e.v),e}function Ua(o,e,t){t===void 0||(t===null?delete o[e]:o[e]=t)}const Ns=(o,e)=>{const{unitId:t,subUnitId:n,rowData:s}=o,r={},a=e.getRowManager();for(const c in s){const l=s[c],u=a.getRow(Number(c));r[c]=Sa(u,l)}return{unitId:t,subUnitId:n,rowData:r}},at={id:"sheet.mutation.set-row-data",type:i.CommandType.MUTATION,handler:(o,e)=>{const{rowData:t}=e,n=o.get(i.IUniverInstanceService),s=k(n,e);if(!s)return!1;const{worksheet:r}=s,a=r.getRowManager();for(const c in t){const l=t[c];if(l==null){a.removeRow(Number(c));continue}const u=a.getRowOrCreate(Number(c));Object.assign(u,l)}return!0}},ka=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},Ye={id:"sheet.mutation.set-row-visible",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId).getRowManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let c=a.startRow;c<a.endRow+1;c++){const l=s.getRowOrCreate(c);l!=null&&(l.hd=0)}}return!0}},Pa=(o,e)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId)==null)throw new Error("universheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,ranges:e.ranges}},Ke={id:"sheet.mutation.set-row-hidden",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId).getRowManager();for(let r=0;r<e.ranges.length;r++){const a=e.ranges[r];for(let c=a.startRow;c<a.endRow+1;c++){const l=s.getRowOrCreate(c);l!=null&&(l.hd=1)}}return!0}},Kn=(o,e)=>{const{unitId:t,subUnitId:n,ranges:s}=o,r={},a=e.getColumnManager();for(let c=0;c<s.length;c++){const l=s[c];for(let u=l.startColumn;u<l.endColumn+1;u++)r[u]=a.getColumnWidth(u)}return{unitId:t,subUnitId:n,ranges:s,colWidth:r}},Ae={id:"sheet.mutation.set-worksheet-col-width",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService),n=k(t,e);if(!n)return!1;const{worksheet:s}=n,r=s.getColumnManager(),a=e.ranges;for(let c=0;c<a.length;c++){const l=a[c];for(let u=l.startColumn;u<l.endColumn+1;u++)s.getColVisible(u)&&(typeof e.colWidth=="number"?r.setColumnWidth(u,e.colWidth):i.Tools.isDefine(e.colWidth[u])&&r.setColumnWidth(u,e.colWidth[u]))}return!0}},Os=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetColumnCountUndoMutationFactory]: worksheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,columnCount:t.worksheet.getColumnCount()}},ct={id:"sheet.mutation.set-worksheet-column-count",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService),n=_e(t,e);return n?(n.worksheet.setColumnCount(e.columnCount),!0):!1}},lt={id:"sheet.mutation.set-worksheet-default-style",type:i.CommandType.MUTATION,handler:(o,e)=>{const{defaultStyle:t}=e,n=o.get(i.IUniverInstanceService),s=k(n);if(!s)return!1;const{worksheet:r}=s;return r?(r.setDefaultCellStyle(t),!0):!1}},Ds=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetDefaultStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,subUnitId:n.getSheetId(),defaultStyle:n.getDefaultCellStyle()}},As=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetRowCountUndoMutationFactory]: worksheet is null error!");return{unitId:e.unitId,subUnitId:e.subUnitId,rowCount:t.worksheet.getRowCount()}},ut={id:"sheet.mutation.set-worksheet-row-count",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService),n=_e(t,e);return n?(n.worksheet.setRowCount(e.rowCount),!0):!1}},xs=(o,e)=>{var c,l;const{unitId:t,subUnitId:n,ranges:s}=o,r={},a=e.getRowManager();for(const{startRow:u,endRow:d}of s)for(let m=u;m<d+1;m++)r[m]=(l=(c=a.getRow(m))==null?void 0:c.h)!=null?l:e.getConfig().defaultRowHeight;return{unitId:t,subUnitId:n,ranges:s,rowHeight:r}},Jn=(o,e)=>{var c;const{unitId:t,subUnitId:n,ranges:s}=o,r={},a=e.getRowManager();for(const{startRow:l,endRow:u}of s)for(let d=l;d<=u;d++)r[d]=(c=a.getRow(d))==null?void 0:c.ia;return{unitId:t,subUnitId:n,ranges:s,autoHeightInfo:r}},Na=(o,e)=>{var c,l;const{unitId:t,subUnitId:n,rowsAutoHeightInfo:s}=o,r=[],a=e.getRowManager();for(const u of s){const{row:d}=u;r.push({row:d,autoHeight:(l=(c=a.getRow(d))==null?void 0:c.ah)!=null?l:e.getConfig().defaultRowHeight})}return{unitId:t,subUnitId:n,rowsAutoHeightInfo:r}},Te={id:"sheet.mutation.set-worksheet-row-height",type:i.CommandType.MUTATION,handler:(o,e)=>{const{ranges:t,rowHeight:n}=e,s=o.get(i.IUniverInstanceService),r=k(s,e);if(!r)return!1;const{worksheet:a}=r,c=a.getRowManager();for(const{startRow:l,endRow:u}of t)for(let d=l;d<=u;d++)typeof n=="number"?c.setRowHeight(d,n):i.Tools.isDefine(n[d])&&c.setRowHeight(d,n[d]);return!0}},Se={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:i.CommandType.MUTATION,handler:(o,e)=>{var c;const{ranges:t,autoHeightInfo:n}=e,s=o.get(i.IUniverInstanceService),r=k(s,e);if(!r)return!1;const a=r.worksheet.getRowManager();for(const{startRow:l,endRow:u}of t)for(let d=l;d<=u;d++){const m=a.getRowOrCreate(d);typeof n=="number"?m.ia=n:m.ia=(c=n[d])!=null?c:void 0}return!0}},Xn={id:"sheet.mutation.set-worksheet-row-auto-height",type:i.CommandType.MUTATION,handler:(o,e)=>{const{rowsAutoHeightInfo:t}=e,n=o.get(i.IUniverInstanceService),s=k(n,e);if(!s)return!1;const r=s.worksheet.getRowManager();for(const{row:a,autoHeight:c}of t){const l=r.getRowOrCreate(a);l.ah=c}return!0}},dt={id:"sheet.mutation.toggle-gridlines",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=k(o.get(i.IUniverInstanceService),e);if(!t)return!1;const{worksheet:n}=t,s=n.getConfig();return s.showGridlines=e.showGridlines,!0}},bt={id:"sheet.operation.set-worksheet-active",type:i.CommandType.OPERATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getWorksheets();for(const[,s]of n)if(s.getSheetId()===e.subUnitId)return t.setActiveSheet(s),!0;return!1}};var Ws=(o=>(o.SET_WORKSHEET_ROW_HEIGHT="sheet.mutation.set-worksheet-row-height",o.SET_WORKSHEET_ROW_IS_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-is-auto-height",o.SET_WORKSHEET_ROW_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-auto-height",o.SET_WORKSHEET_COL_WIDTH="sheet.mutation.set-worksheet-col-width",o.SET_WORKSHEET_ACTIVE="sheet.operation.set-worksheet-active",o.MOVE_ROWS="sheet.mutation.move-rows",o.MOVE_COLUMNS="sheet.mutation.move-columns",o.SET_COL_HIDDEN="sheet.mutation.set-col-hidden",o.SET_COL_VISIBLE="sheet.mutation.set-col-visible",o.SET_ROW_HIDDEN="sheet.mutation.set-row-hidden",o.SET_ROW_VISIBLE="sheet.mutation.set-row-visible",o.INSERT_COL="sheet.mutation.insert-col",o.INSERT_ROW="sheet.mutation.insert-row",o.REMOVE_COL="sheet.mutation.remove-col",o.REMOVE_ROW="sheet.mutation.remove-rows",o.TOGGLE_GRIDLINES="sheet.mutation.toggle-gridlines",o.SET_GRIDLINES_COLOR="sheet.mutation.set-gridlines-color",o))(Ws||{}),$s=(o=>(o.SET_RANGE_VALUES="sheet.mutation.set-range-values",o.MOVE_RANGE="sheet.mutation.move-range",o.REMOVE_WORKSHEET_MERGE="sheet.mutation.remove-worksheet-merge",o.ADD_WORKSHEET_MERGE="sheet.mutation.add-worksheet-merge",o.REORDER_RANGE="sheet.mutation.reorder-range",o.SET_WORKSHEET_DEFAULT_STYLE="sheet.mutation.set-worksheet-default-style",o.SET_ROW_DATA="sheet.mutation.set-row-data",o.SET_COL_DATA="sheet.mutation.set-col-data",o.SET_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.set-worksheet-range-theme-style",o.DELETE_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.delete-worksheet-range-theme-style",o))($s||{});const Oa=[Te.id,Se.id,Xn.id,Ae.id,bt.id,ve.id,we.id,Ct.id,St.id,Ke.id,Ye.id,ce.id,ae.id,ne.id,le.id,dt.id,it.id,ut.id,ct.id],Da=[H.id,Be.id,F.id,B.id,At.id,lt.id,at.id,rt.id,gt.id,Rt.id];function Aa(o){switch(o.id){case"sheet.mutation.set-range-values":{const e=o.params,t=new i.ObjectMatrix(e.cellValue).getDataRange();return t.endRow===-1?[]:e.cellValue?[{unitId:e.unitId,subUnitId:e.subUnitId,range:t}]:[]}case"sheet.mutation.move-range":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.from.subUnitId,range:new i.ObjectMatrix(e.from.value).getRange()},{unitId:e.unitId,subUnitId:e.to.subUnitId,range:new i.ObjectMatrix(e.to.value).getRange()}]}case"sheet.mutation.remove-worksheet-merge":{const e=o.params;return e.ranges.map(t=>({unitId:e.unitId,subUnitId:e.subUnitId,range:t}))}case"sheet.mutation.add-worksheet-merge":{const e=o.params;return e.ranges.map(t=>({unitId:e.unitId,subUnitId:e.subUnitId,range:t}))}case"sheet.mutation.reorder-range":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}]}case"sheet.mutation.set-worksheet-default-style":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-row-data":{const e=o.params,t=Object.keys(e.rowData).map(Number);return t.length===0?[]:[{unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:Math.min(...t),endRow:Math.max(...t),startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-col-data":{const e=o.params,t=Object.keys(e.columnData).map(Number);return t.length===0?[]:[{unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:Math.min(...t),endColumn:Math.max(...t)}}]}case"sheet.mutation.set-worksheet-range-theme-style":case"sheet.mutation.delete-worksheet-range-theme-style":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range}]}default:return[]}}function xa(o,e){switch(o.id){case"sheet.mutation.set-worksheet-row-height":case"sheet.mutation.set-worksheet-row-is-auto-height":{const t=o.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-row-auto-height":{const t=o.params;return t.rowsAutoHeightInfo.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:n.row,endRow:n.row,startColumn:0,endColumn:e-1,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-col-width":{const t=o.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.move-rows":case"sheet.mutation.move-columns":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:t.targetRange},{unitId:t.unitId,subUnitId:t.subUnitId,range:t.sourceRange}]}case"sheet.mutation.set-col-hidden":case"sheet.mutation.set-col-visible":{const t=o.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.set-row-hidden":case"sheet.mutation.set-row-visible":{const t=o.params;return t.ranges.map(n=>({unitId:t.unitId,subUnitId:t.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.insert-col":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.insert-row":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.remove-col":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.remove-rows":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{...t.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.toggle-gridlines":case"sheet.mutation.set-gridlines-color":return[];default:return[]}}function is(o){return o==null?!1:o.v!==void 0&&o.v!==null&&o.v!==""||o.p!==void 0}function vn(o,e){return o&&o.spanAnchor?is(e.getValue(o.spanAnchor.startRow,o.spanAnchor.startColumn)):is(o)}function Wa(o,e,t,n,s){const r=o.getCellMatrix(),a=o.getSpanModel().getMergedCellRange(e,t,n,s),c=new i.ObjectMatrix;return r.forValue((l,u)=>{const d=r.getValue(l,u);d&&c.setValue(l,u,d)}),a.forEach(l=>{const{startColumn:u,startRow:d,endColumn:m,endRow:h}=l;i.createRowColIter(d,h,u,m).forEach((g,R)=>{g===d&&R===u&&c.setValue(g,R,{...r.getValue(g,R),spanAnchor:{startRow:d,endRow:h,startColumn:u,endColumn:m}}),(g!==d||R!==u)&&(c.realDeleteValue(g,R),c.setValue(g,R,{spanAnchor:{startRow:d,endRow:h,startColumn:u,endColumn:m}}))})}),c}function $a(o,e,t,n){const{startRow:s,startColumn:r,endRow:a}=o;let c=null,l=!1;for(let u=s;u<=a;u++){const d=e.getValue(u,r-t);if(l=l||vn(d,e),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.startColumn=o.startColumn-t,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function Va(o,e,t,n){const{startRow:s,endColumn:r,endRow:a}=o;let c=null,l=!1;for(let u=s;u<=a;u++){const d=e.getValue(u,r+t);if(l=l||vn(d,e),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.endColumn=o.endColumn+t,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function La(o,e,t,n){const{startRow:s,startColumn:r,endColumn:a}=o;let c=null,l=!1;for(let u=r;u<=a;u++){const d=e.getValue(s-t,u);if(l=l||vn(d,e),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.startRow=o.startRow-t,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function Ha(o,e,t,n){const{startColumn:s,endColumn:r,endRow:a}=o;let c=null,l=!1;for(let u=s;u<=r;u++){const d=e.getValue(a+t,u);if(l=l||vn(d,e),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.endRow=o.endRow+t,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function Ba(o,e,t){const n=t.getMaxRows(),s=t.getMaxColumns(),r=Wa(t,0,0,n-1,s-1),a=t.getSnapshot().mergeData.length>0,{left:c,right:l,up:u,down:d}=e;let m=!0,h={...o};const g=[];for(;m;){if(m=!1,u&&h.startRow!==0){const{hasValue:R,range:C,spanAnchor:f}=La(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}if(d&&h.endRow!==n-1){const{hasValue:R,range:C,spanAnchor:f}=Ha(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}if(c&&h.startColumn!==0){const{hasValue:R,range:C,spanAnchor:f}=$a(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}if(l&&h.endColumn!==s-1){const{hasValue:R,range:C,spanAnchor:f}=Va(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}}return g.length>0&&(h=i.Rectangle.union(h,...g)),h}const Vs=o=>{const e=new i.ObjectMatrix;return o.forEach(t=>{i.Range.foreach(t,(n,s)=>{e.setValue(n,s,1)})}),e.forValue((t,n)=>{const s=e.getValue(t-1,n);s&&e.setValue(t,n,s+1)}),e},Ls=o=>{const e=o;return e.forValue((t,n)=>{const s=o.getValue(t-1,n);s&&e.setValue(t,n,s+1)}),e},as=o=>{const e={area:0},t=(n,s)=>e.area<n?(e.area=n,e.range=s,!0):!1;return o.forValue((n,s,r)=>{let a=1,c=r;t(a*c,{startRow:n-c+1,endRow:n,startColumn:s,endColumn:s});const l={startRow:n-c+1,endRow:n,startColumn:0,endColumn:s};for(let u=s-1;u>=0&&o.getValue(n,u);u--){c=Math.min(o.getValue(n,u)||0,c),a++;const d=c*a;l.startColumn=u,l.startRow=n-c+1,t(d,l)}}),e},Fa=(o,e)=>{i.Range.foreach(e,(t,n)=>{o.realDeleteValue(t,n)});for(let t=e.startColumn;t<=e.endColumn;t++){const n=e.endRow+1;if(o.getValue(n,t)>0){o.setValue(n,t,1);let r=n+1;for(;o.getValue(r,t)>0;)o.setValue(r,t,o.getValue(r-1,t)+1),r++}}return o},Zn=o=>{const e=[];let t=as(o);for(;t.area>0;)t.range&&(e.push(t.range),Fa(o,t.range)),t=as(o);return e},Qn=o=>{const e=Vs(o);return Zn(e)};class ja{constructor(){S(this,"_matrix",new i.ObjectMatrix)}add(...e){return e.forEach(t=>{i.Range.foreach(t,(n,s)=>{this._matrix.setValue(n,s,1)})}),this}subtract(...e){return e.forEach(t=>{i.Range.foreach(t,(n,s)=>{this._matrix.realDeleteValue(n,s)})}),this}merge(){const e=Ls(this._matrix);return Zn(e)}}const Ga=1.5,za="rgba(255, 255, 255, 0.01)";function qa(o){const{rangeWithCoord:e,primaryWithCoord:t,style:n}=o,s={range:{startRow:e.startRow,startColumn:e.startColumn,endRow:e.endRow,endColumn:e.endColumn,rangeType:e.rangeType,unitId:e.unitId,sheetId:e.sheetId},primary:null,style:n};return t!=null&&(s.primary=Hs(t)),s}function Hs(o){const{actualRow:e,actualColumn:t,isMerged:n,isMergedMainCell:s}=o,{startRow:r,startColumn:a,endRow:c,endColumn:l}=o.mergeInfo;return{actualRow:e,actualColumn:t,isMerged:n,isMergedMainCell:s,startRow:r,startColumn:a,endRow:c,endColumn:l}}var Bs=(o=>(o[o.Tab=1]="Tab",o[o.Comma=2]="Comma",o[o.Semicolon=4]="Semicolon",o[o.Space=8]="Space",o[o.Custom=16]="Custom",o))(Bs||{});class Ya{constructor(){S(this,"_tabCount",0);S(this,"_commaCount",0);S(this,"_semicolonCount",0);S(this,"_spaceCount",0)}add(e){switch(e){case"	":this._tabCount++;break;case",":this._commaCount++;break;case";":this._semicolonCount++;break;case" ":this._spaceCount++;break}}update(e){e&&typeof e=="string"&&(e.includes("	")&&this._tabCount++,e.includes(",")&&this._commaCount++,e.includes(";")&&this._semicolonCount++,e.trim().includes(" ")&&this._spaceCount++)}getDelimiter(){const e=Math.max(this._tabCount,this._commaCount,this._semicolonCount,this._spaceCount);return e===0||e===this._tabCount?1:e===this._commaCount?2:e===this._semicolonCount?4:e===this._spaceCount?8:1}}function Ka(o,e,t){const n=[];t!==void 0&&(o&16)>0&&n.push(t),(o&1)>0&&n.push("	"),(o&2)>0&&n.push(","),(o&4)>0&&n.push(";"),(o&8)>0&&n.push(" ");let s="";for(const a of n)s+=Ja(a);let r="[".concat(s,"]");return e&&(r+="+"),new RegExp(r)}function Ja(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const Xa=o=>{var t;return((t=o.body)==null?void 0:t.dataStream.replace(/\r\n$/,""))||""};function Za(o){if(o!=null){if(o.p)return Xa(o.p);if(o.v&&typeof o.v=="string")return o.v;if(o.t&&(o.t===i.CellValueType.FORCE_STRING||o.t===i.CellValueType.STRING))return String(o.v)}}function Fs(o,e,t,n,s=!1){const r=i.Range.transformRange(e,o),{startColumn:a,startRow:c,endColumn:l,endRow:u}=r;if(a!==l)throw new Error("The range must be in the same column.");if(t&&(t&16)>0&&(n===void 0||n.length!==1))throw new Error("The custom delimiter must a character.");const d=t===void 0,m=d?new Ya:null,h=[];for(let I=c;I<=u;I++){const v=o.getCell(I,a),M=Za(v);h.push(M),m&&m.update(M)}const g=d?m.getDelimiter():t,R=Ka(g,s,n);let C=-1,f=0,p=0;const w=[];for(const I of h){if(I!==void 0){const v=String(I).split(R);C<0?C=v.length:C=Math.max(C,v.length),w.push(v),f=p}else w.push(void 0);p++}return{rs:w,maxLength:C===-1?0:C,lastRow:f}}const Qa=(o,e,t="")=>o.reduce((n,s)=>{const r=s&&s[e];return typeof r!="string"?(console.warn(s,`${e} is not string`),n):(r?(n[r]||(n[r]=[]),n[r].push(s)):n[t].push(s),n)},{}),ec=(o=0)=>{let e=o;return function(){return e++}};function tc(o){return o==null?!1:o.v!==void 0&&o.v!==null&&o.v!==""||o.p!==void 0}function nc(o,e){for(let t=o.startRow;t<=o.endRow;t++)for(let n=o.startColumn;n<=o.endColumn;n++){const s=e.getCell(t,n);if(tc(s))return{startRow:t,startColumn:n,endRow:t,endColumn:n}}return null}function eo(o){const e=new i.ObjectMatrix;return o.forEach(t=>{const{startRow:n,startColumn:s,endRow:r,endColumn:a}=t;for(let c=n;c<=r;c++)for(let l=s;l<=a;l++)e.setValue(c,l,null)}),e.clone()}function js(o){const e=new i.ObjectMatrix;return o.forEach(t=>{const{startRow:n,startColumn:s,endRow:r,endColumn:a}=t;for(let c=n;c<=r;c++)for(let l=s;l<=a;l++)e.setValue(c,l,{v:null,p:null,f:null,si:null,custom:null})}),e.clone()}function oc(o){const e=new i.ObjectMatrix;return o.forEach(t=>{const{startRow:n,startColumn:s,endRow:r,endColumn:a}=t;for(let c=n;c<=r;c++)for(let l=s;l<=a;l++)e.setValue(c,l,{s:null})}),e.clone()}function Gs(o,e,t,n){const s=e.get(i.IUniverInstanceService),r=t?s.getUnit(t,i.UniverInstanceType.UNIVER_SHEET):s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=n?r==null?void 0:r.getSheetBySheetId(n):r==null?void 0:r.getActiveSheet();if(!a)return null;const{startRow:c,endRow:l,startColumn:u,endColumn:d}=o,m=[],h=[];for(let g=c;g<=l;g++)a.getRowFiltered(g)||m.push(g);for(let g=u;g<=d;g++)h.push(g);return{rows:m,cols:h}}function jt(o,e,t,n){const s=[],r=[];for(const h of o){const g=Gs(h,e,t,n);g&&(s.push(...g.rows),r.push(...g.cols))}const a=Array.from(new Set(s)).sort((h,g)=>h-g),c=Array.from(new Set(r)).sort((h,g)=>h-g),l=[];function u(h){const g=[];let R=h[0];for(let C=1;C<h.length;C++)h[C]!==h[C-1]+1&&(g.push([R,h[C-1]]),R=h[C]);return g.push([R,h[h.length-1]]),g}const d=u(a),m=u(c);for(const[h,g]of d)for(const[R,C]of m)l.push({startRow:h,endRow:g,startColumn:R,endColumn:C});return l}var zs=(o=>(o.OthersCanView="othersCanView",o.NoOneElseCanView="noOneElseCanView",o))(zs||{}),qs=(o=>(o.DesignedUserCanEdit="designedUserCanEdit",o.OnlyMe="onlyMe",o))(qs||{});class J{constructor(){S(this,"_model",new Map);S(this,"_ruleChange$",new O.Subject);S(this,"ruleChange$",this._ruleChange$.asObservable());S(this,"_ruleRefresh$",new O.Subject);S(this,"ruleRefresh$",this._ruleRefresh$.asObservable());S(this,"_rangeRuleInitStateChange",new O.BehaviorSubject(!1));S(this,"rangeRuleInitStateChange$",this._rangeRuleInitStateChange.asObservable())}dispose(){this._ruleChange$.complete(),this._ruleRefresh$.complete()}ruleRefresh(e){this._ruleRefresh$.next(e)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(e){this._rangeRuleInitStateChange.next(e)}addRule(e,t,n){this._ensureRuleMap(e,t).set(n.id,n),this._ruleChange$.next({unitId:e,subUnitId:t,rule:n,type:"add"})}deleteRule(e,t,n){var r,a,c,l;const s=(a=(r=this._model.get(e))==null?void 0:r.get(t))==null?void 0:a.get(n);s&&((l=(c=this._model.get(e))==null?void 0:c.get(t))==null||l.delete(n),this._ruleChange$.next({unitId:e,subUnitId:t,rule:s,type:"delete"}))}setRule(e,t,n,s){var a,c;const r=this.getRule(e,t,n);r&&((c=(a=this._model.get(e))==null?void 0:a.get(t))==null||c.set(n,s),this._ruleChange$.next({unitId:e,subUnitId:t,oldRule:r,rule:s,type:"set"}))}getRule(e,t,n){var s,r;return(r=(s=this._model.get(e))==null?void 0:s.get(t))==null?void 0:r.get(n)}getSubunitRuleList(e,t){var s;return[...(((s=this._model.get(e))==null?void 0:s.get(t))||new Map).values()]}getSubunitRuleListLength(e,t){var s;const n=(s=this._model.get(e))==null?void 0:s.get(t);return n?n.size:0}_ensureRuleMap(e,t){let n=this._model.get(e);n||(n=new Map,this._model.set(e,n));let s=n.get(t);return s||(s=new Map,n.set(t,s)),s}toObject(){const e={};return[...this._model.keys()].forEach(n=>{const s=this._model.get(n),r=[...s.keys()];e[n]={},r.forEach(a=>{const c=s.get(a);e[n][a]=[...c.values()]})}),e}fromObject(e){const t=new Map;Object.keys(e).forEach(n=>{const s=e[n],r=new Map;Object.keys(s).forEach(a=>{const c=s[a].reduce((l,u)=>(l.set(u.id,u),l),new Map);r.set(a,c)}),t.set(n,r)}),this._model=t}deleteUnitModel(e){this._model.delete(e)}createRuleId(e,t){let n=i.generateRandomId(4);const s=this._ensureRuleMap(e,t);for(;s.has(n);)n=i.generateRandomId(4);return n}getTargetByPermissionId(e,t){const n=this._model.get(e);if(!n)return null;for(const[s,r]of n)for(const a of r.values())if(a.permissionId===t)return[e,s];return null}}const sc=(o,e)=>{const t=o.get(J),n=e.ruleIds.map(r=>t.getRule(e.unitId,e.subUnitId,r)).filter(r=>!!r);return{id:fe.id,params:{subUnitId:e.subUnitId,unitId:e.unitId,rules:n}}},Pe={id:"sheet.mutation.delete-range-protection",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,ruleIds:s}=e,r=o.get(J);return s.forEach(a=>{r.deleteRule(t,n,a)}),!0}},rc=o=>{const e={...o,ruleIds:o.rules.map(t=>t.id)};return{id:Pe.id,params:e}},fe={id:"sheet.mutation.add-range-protection",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,rules:s}=e,r=o.get(J);return s.forEach(a=>{r.addRule(t,n,a)}),!0}},Ys={type:i.CommandType.COMMAND,id:"sheet.command.add-range-protection",async handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(J),{rule:r,permissionId:a}=e,{unitId:c,subUnitId:l,ranges:u,description:d,viewState:m,editState:h}=r,g=[{ranges:u,permissionId:a,id:s.createRuleId(c,l),description:d,unitType:r.unitType,unitId:c,subUnitId:l,viewState:m,editState:h}];if(await t.executeCommand(fe.id,{unitId:c,subUnitId:l,rules:g})){const C=[{id:fe.id,params:{unitId:c,subUnitId:l,rules:g}}],f=[{id:Pe.id,params:{unitId:c,subUnitId:l,ruleIds:g.map(p=>p.id)}}];n.pushUndoRedo({unitID:c,redoMutations:C,undoMutations:f})}return!0}};var ee=(o=>(o[o.MOVE_START=0]="MOVE_START",o[o.MOVING=1]="MOVING",o[o.MOVE_END=2]="MOVE_END",o[o.ONLY_SET=3]="ONLY_SET",o))(ee||{});class Ks extends i.Disposable{constructor(t){super();S(this,"_worksheetSelections",new Map);S(this,"_selectionMoveStart$",new O.Subject);S(this,"selectionMoveStart$",this._selectionMoveStart$.asObservable());S(this,"_selectionMoving$",new O.Subject);S(this,"selectionMoving$",this._selectionMoving$.asObservable());S(this,"_selectionMoveEnd$",new O.BehaviorSubject([]));S(this,"selectionMoveEnd$",this._selectionMoveEnd$.asObservable());S(this,"_selectionSet$",new O.BehaviorSubject([]));S(this,"selectionSet$",this._selectionSet$.asObservable());S(this,"selectionChanged$");S(this,"_beforeSelectionMoveEnd$",new O.BehaviorSubject([]));S(this,"beforeSelectionMoveEnd$",this._beforeSelectionMoveEnd$.asObservable());this._workbook=t,this.selectionChanged$=O.merge(this._selectionMoveEnd$,this._selectionSet$)}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete(),this._selectionSet$.complete(),this._workbook=null}addSelections(t,n){const s=this.getSelectionsOfWorksheet(t);s.push(...n),this._selectionSet$.next(s)}setSelections(t,n=[],s){switch(this.setSelectionsOfWorksheet(t,n),s){case ee.MOVE_START:this._selectionMoveStart$.next(n);break;case ee.MOVING:this._selectionMoving$.next(n);break;case ee.MOVE_END:this._beforeSelectionMoveEnd$.next(n),this._selectionMoveEnd$.next(n);break;case ee.ONLY_SET:{this._selectionSet$.next(n);break}default:this._selectionSet$.next(n);break}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(t){return this.getSelectionsOfWorksheet(t)}getSelectionsOfWorksheet(t){return this._worksheetSelections.has(t)||this._worksheetSelections.set(t,[]),this._worksheetSelections.get(t)}setSelectionsOfWorksheet(t,n){this._worksheetSelections.set(t,[...n])}deleteSheetSelection(t){this._worksheetSelections.set(t,[])}clear(){this._worksheetSelections.clear(),this._selectionSet$.next([])}_getCurrentSelections(){return this.getSelectionsOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){const t=this._getCurrentSelections();return t[t.length-1]}}var ic=Object.getOwnPropertyDescriptor,ac=(o,e,t,n)=>{for(var s=n>1?void 0:n?ic(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},cc=(o,e)=>(t,n)=>e(t,n,o);exports.SheetsSelectionsService=class extends i.RxDisposable{constructor(t){super();S(this,"_cellStylesCache",new Map);S(this,"selectionMoveStart$");S(this,"selectionMoving$");S(this,"selectionMoveEnd$");S(this,"selectionSet$");S(this,"selectionChanged$");S(this,"_workbookSelections",new Map);this._instanceSrv=t,this._init()}get _currentSelectionPos(){const t=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!t)return null;const n=t.getActiveSheet();return{unitId:t.getUnitId(),sheetId:n.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}_init(){const t=this._instanceSrv.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.shareReplay(1),O.takeUntil(this.dispose$));this.selectionMoveStart$=t.pipe().pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveStart$:O.of())).pipe(O.takeUntil(this.dispose$)),this.selectionMoving$=t.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoving$:O.of())).pipe(O.takeUntil(this.dispose$)),this.selectionMoveEnd$=t.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveEnd$:O.of([]))).pipe(O.takeUntil(this.dispose$)),this.selectionSet$=t.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionSet$:O.of([]))).pipe(O.takeUntil(this.dispose$)),this.selectionChanged$=t.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionChanged$:O.of([]))).pipe(O.distinctUntilChanged((n,s)=>n.length!==s.length?!1:n.length===0&&s.length===0?!0:n.every((r,a)=>JSON.stringify(r)===JSON.stringify(s[a]))),O.skip(1)).pipe(O.takeUntil(this.dispose$)),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.takeUntil(this.dispose$)).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId())})),this.disposeWithMe(this.selectionChanged$.pipe(O.takeUntil(this.dispose$)).subscribe(()=>{this._cellStylesCache.clear()}))}dispose(){super.dispose(),this._cellStylesCache.clear(),this._workbookSelections.forEach(t=>t.dispose()),this._workbookSelections.clear(),this.selectionMoveStart$=O.of(null),this.selectionMoving$=O.of(null),this.selectionMoveEnd$=O.of([]),this.selectionSet$=O.of(null),this.selectionChanged$=O.of(null)}clear(){this._workbookSelections.forEach(t=>t.clear())}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){const t=this._getCurrentSelections();return t==null?void 0:t[t.length-1]}addSelections(t,n,s){if(typeof t=="string"){this._ensureWorkbookSelection(t).addSelections(n,s);return}const r=this._currentSelectionPos;if(!r)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:a,sheetId:c}=r;this._ensureWorkbookSelection(a).addSelections(c,t)}setSelections(t,n,s,r){if(typeof t=="string"&&typeof n=="string"){const u=t;this._ensureWorkbookSelection(u).setSelections(n,s||[],r!=null?r:ee.ONLY_SET);return}const a=this._currentSelectionPos;if(!a)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:c,sheetId:l}=a;if(typeof t=="object"){const u=t!=null?t:s,d=n!=null?n:ee.ONLY_SET;this._ensureWorkbookSelection(c).setSelections(l,u,d)}}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){const t=this.getCurrentSelections();return t==null?!1:t.some(({range:n},s)=>t.some(({range:r},a)=>s===a?!1:n.startRow<=r.endRow&&n.endRow>=r.startRow&&n.startColumn<=r.endColumn&&n.endColumn>=r.startColumn))}_getCurrentSelections(){const t=this._currentSelectionPos;if(!t)return[];const{unitId:n,sheetId:s}=t;return this._ensureWorkbookSelection(n).getSelectionsOfWorksheet(s)}getWorkbookSelections(t){return this._ensureWorkbookSelection(t)}_ensureWorkbookSelection(t){let n=this._workbookSelections.get(t);if(!n){const s=this._instanceSrv.getUnit(t);if(!s)throw new Error(`[SheetsSelectionsService]: cannot resolve unit with id "${t}"!`);n=new Ks(s),this._workbookSelections.set(t,n)}return n}_removeWorkbookSelection(t){this._workbookSelections.delete(t)}getCellStylesProperty(t){var a;const n=(a=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:a.getActiveSheet(),s=this.getCurrentSelections();if(!n||s.length===0)return{isAllValuesSame:!1,value:null};let r=null;for(let c=0;c<s.length;c++){const l=s[c],{startRow:u,endRow:d,startColumn:m,endColumn:h}=l.range;for(let g=u;g<=d;g++)for(let R=m;R<=h;R++){const C=`${g}_${R}`;let f;this._cellStylesCache.has(C)?f=this._cellStylesCache.get(C):(f=n.getComposedCellStyle(g,R),this._cellStylesCache.set(C,f));const p=f[t];if(r!=null&&!i.Tools.diffValue(r,p))return{isAllValuesSame:!1,value:null};r=p}}return{isAllValuesSame:!0,value:r}}};exports.SheetsSelectionsService=ac([cc(0,i.IUniverInstanceService)],exports.SheetsSelectionsService);const lc="DISABLE_NORMAL_SELECTIONS",uc="SELECTIONS_ENABLED",Js="REF_SELECTIONS_ENABLED",wn={id:"sheet.command.clear-selection-all",type:i.CommandType.COMMAND,handler:(o,e)=>{var I;const t=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUndoRedoService),a=o.get(exports.SheetInterceptorService),c=t.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!c)return!1;const l=(e==null?void 0:e.unitId)||c.getUnitId(),u=c.getActiveSheet();if(!u)return!1;const d=(e==null?void 0:e.subUnitId)||u.getSheetId(),m=(e==null?void 0:e.ranges)||((I=s.getCurrentSelections())==null?void 0:I.map(v=>v.range));if(!(m!=null&&m.length))return!1;const h=jt(m,o,l,d),g=[],R=[],C={subUnitId:d,unitId:l,cellValue:eo(h)},f=me(o,C);g.push({id:H.id,params:C}),R.push({id:H.id,params:f});const p=a.onCommandExecute({id:wn.id});return g.push(...p.redos),R.unshift(...p.undos),i.sequenceExecute(g,n)?(r.pushUndoRedo({unitID:l,undoMutations:R,redoMutations:g}),!0):!1}},Mn={id:"sheet.command.clear-selection-format",type:i.CommandType.COMMAND,handler:(o,e)=>{var I;const t=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUndoRedoService),a=o.get(exports.SheetInterceptorService),c=t.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!c)return!1;const l=(e==null?void 0:e.unitId)||c.getUnitId(),u=c.getActiveSheet();if(!u)return!1;const d=(e==null?void 0:e.subUnitId)||u.getSheetId(),m=(e==null?void 0:e.ranges)||((I=s.getCurrentSelections())==null?void 0:I.map(v=>v.range));if(!(m!=null&&m.length))return!1;const h=jt(m,o,l,d),g=[],R=[],C={subUnitId:d,unitId:l,cellValue:oc(h)},f=me(o,C);g.push({id:H.id,params:C}),R.push({id:H.id,params:f});const p=a.onCommandExecute({id:Mn.id});return g.push(...p.redos),R.unshift(...p.undos),i.sequenceExecute(g,n)?(r.pushUndoRedo({unitID:l,undoMutations:R,redoMutations:g}),!0):!1}};function Gt(o,e,t=!0){const n=e.getMatrixWithMergedCells(...i.selectionToArray(o)),s=[];if(n.forValue((a,c,l)=>{if(l.colSpan!==void 0&&l.rowSpan!==void 0){const u={startRow:a,startColumn:c,endRow:a+l.rowSpan-1,endColumn:c+l.colSpan-1};i.Rectangle.contains(o,u)||s.push(u)}}),s.length===0)return o;const r=i.Rectangle.union(o,...s);return t?Gt(r,e,t):r}function dc(o,e,t){let n=null;return t.getMatrixWithMergedCells(o,e,o,e).forValue((r,a,c)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:c.rowSpan!==void 0||c.colSpan!==void 0,isMergedMainCell:c.rowSpan!==void 0&&c.colSpan!==void 0,endRow:r+(c.rowSpan!==void 0?c.rowSpan-1:0),endColumn:a+(c.colSpan!==void 0?c.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:e,actualRow:o,startRow:o,startColumn:e,endRow:o,endColumn:e,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}function mc(o,e,t){const{startRow:n,startColumn:s,endRow:r,endColumn:a}=o;return Number.isNaN(n)&&(o.startRow=0),Number.isNaN(r)&&(o.endRow=e-1),Number.isNaN(s)&&(o.startColumn=0),Number.isNaN(a)&&(o.endColumn=t-1),o}function oe(o,e){const t=Number.isNaN(o.startRow)?0:o.startRow,n=Number.isNaN(o.startColumn)?0:o.startColumn,s=e.getMergedCell(t,n);return s?{...s,actualRow:t,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow:t,startColumn:n,endRow:o.startRow,endColumn:o.startColumn,actualRow:t,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!1,isMergedMainCell:!1}}const Ne=(o,e,t)=>({id:G.id,params:{unitId:e.getUnitId(),subUnitId:t.getSheetId(),reveal:!0,selections:[{range:o,primary:oe(o,t)}]}});function hc(o){if(!o)return!1;const{range:e,primary:t}=o;return i.Rectangle.equals(e,t)}function gc(o){function e(t,n){function s(r){for(let a=r.startRow;a<=r.endRow;a++)if(!o.getRowFiltered(a))for(let c=r.startColumn;c<=r.endColumn;c++)n(a,c,r)}s(t)}return{forOperableEach:e}}const cs=o=>o.id!==Ms;function We(o,e,t,n,s,r,a){const c={};for(let l=e;l<=t;l++)for(let u=n;u<=s;u++){const d=r?o.getCellWithFilteredInterceptors(a,u,os,cs):o.getCellWithFilteredInterceptors(l,a,os,cs);!d||!d.s||(c[l]||(c[l]={}),c[l][u]={s:d.s})}for(const l in c){for(const u in c[l]){const d=c[l][u];d.s&&typeof d.s=="object"&&i.Tools.isEmptyObject(d.s)&&delete d.s,i.Tools.isEmptyObject(d)&&delete c[l][u]}i.Tools.isEmptyObject(c[l])&&delete c[l]}return c}var Rc=Object.getOwnPropertyDescriptor,Cc=(o,e,t,n)=>{for(var s=n>1?void 0:n?Rc(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Sc=(o,e)=>(t,n)=>e(t,n,o);const Xs=i.createIdentifier("sheets-formula.ref-selections.service");exports.RefSelectionsService=class extends exports.SheetsSelectionsService{constructor(e){super(e)}_init(){const e=this._getAliveWorkbooks$().pipe(O.takeUntil(this.dispose$));this.selectionMoveStart$=e.pipe(O.switchMap(t=>O.merge(...t.map(n=>n.selectionMoveStart$)))),this.selectionMoving$=e.pipe(O.switchMap(t=>O.merge(...t.map(n=>n.selectionMoving$)))),this.selectionMoveEnd$=e.pipe(O.switchMap(t=>O.merge(...t.map(n=>n.selectionMoveEnd$)))),this.selectionSet$=e.pipe(O.switchMap(t=>O.merge(...t.map(n=>n.selectionSet$))))}dispose(){super.dispose(),this.selectionMoveStart$=O.of(null),this.selectionMoving$=O.of(null),this.selectionMoveEnd$=O.of(null),this.selectionSet$=O.of(null),delete this._instanceSrv,this._workbookSelections.clear()}_getAliveWorkbooks$(){const e=this._instanceSrv.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET);e.forEach(n=>this._ensureWorkbookSelection(n.getUnitId()));const t=new O.BehaviorSubject(e);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._ensureWorkbookSelection(n.getUnitId()),t.next([...t.getValue(),n])})),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId()),t.next(t.getValue().filter(s=>s!==n))})),t.pipe(O.map(n=>n.map(s=>this._ensureWorkbookSelection(s.getUnitId()))))}};exports.RefSelectionsService=Cc([Sc(0,i.IUniverInstanceService)],exports.RefSelectionsService);function Zs(o,e){const n=o.get(i.IContextService).getContextValue(Js);return o.get(n&&!e?Xs:exports.SheetsSelectionsService)}const G={id:"sheet.operation.set-selections",type:i.CommandType.OPERATION,handler:(o,e)=>{if(!e)return!1;const{selections:t,type:n,unitId:s,subUnitId:r}=e;return Zs(o).setSelections(s,r,[...t],n),!0}},Qs={id:"sheet.command.select-range",type:i.CommandType.COMMAND,handler:(o,e)=>{if(!e)return!1;const{unitId:t,subUnit:n,range:s}=e,r=o.get(i.ICommandService),a=k(o.get(i.IUniverInstanceService),e);if(!a)return!1;const c=[{range:s,primary:oe(s,a.worksheet),style:null}];return r.syncExecuteCommand(G.id,{unitId:t,subUnitId:n,selections:c})}},er="sheet.command.move-range",ze={type:i.CommandType.COMMAND,id:er,handler:async(o,e)=>{var w,I;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(i.ErrorService),a=o.get(i.LocaleService),c=o.get(exports.SheetInterceptorService),l=k(s);if(!l||!await c.beforeCommandExecute({id:ze.id,params:e}))return!1;const{worksheet:d,subUnitId:m,unitId:h}=l,g=yn(o,{unitId:h,subUnitId:m,range:e.fromRange},{subUnitId:m,range:e.toRange});if(g===null)return r.emit(a.t("sheets.info.acrossMergedCell")),!1;const R=c.onCommandExecute({id:ze.id,params:e}),C=[...(w=R.preRedos)!=null?w:[],...g.redos,...R.redos,{id:G.id,params:{unitId:h,subUnitId:m,selections:[{range:e.toRange,primary:fc(e.fromRange,e.toRange,d)}],type:ee.MOVE_END}}],f=[...(I=R.preUndos)!=null?I:[],...g.undos,...R.undos,{id:G.id,params:{unitId:h,subUnitId:m,selections:[{range:e.fromRange,primary:oe(e.fromRange,d)}],type:ee.MOVE_END}}];if(i.sequenceExecute(C,t).result){const{undos:v,redos:M}=c.generateMutationsOfAutoHeight({unitId:h,subUnitId:m,ranges:[e.fromRange,e.toRange]}),_=c.afterCommandExecute({id:ze.id,params:e});return i.sequenceExecute([..._.redos,...M],t),n.pushUndoRedo({unitID:h,undoMutations:[...f,..._.undos,...v],redoMutations:[...C,..._.redos,...M]}),!0}return!1}};function yn(o,e,t,n=!1){const s=[],r=[],{range:a,subUnitId:c,unitId:l}=e,{range:u,subUnitId:d}=t,h=o.get(i.IUniverInstanceService).getUniverSheetInstance(l),g=h==null?void 0:h.getSheetBySheetId(d),R=h==null?void 0:h.getSheetBySheetId(c),C=g==null?void 0:g.getCellMatrix(),f=R==null?void 0:R.getCellMatrix();if(g&&R&&C&&f){const p=Gt(u,g,!1);if(!i.Rectangle.equals(u,p)&&!n)return null;const w=new i.ObjectMatrix,I=new i.ObjectMatrix,v=new i.ObjectMatrix;i.Range.foreach(a,(U,E)=>{const P=f.getValue(U,E);if(w.setValue(U,E,i.Tools.deepClone(P)),P){const A=h==null?void 0:h.getStyles().get(P.s);v.setValue(U,E,i.Tools.deepClone(A))}I.setValue(U,E,null)});const M=new i.ObjectMatrix,_=new i.ObjectMatrix;i.Range.foreach(u,(U,E)=>{M.setValue(U,E,i.Tools.deepClone(C.getValue(U,E)))}),i.Range.foreach(a,(U,E)=>{const P=i.cellToRange(U,E),A=i.Rectangle.getRelativeRange(P,a),x=i.Rectangle.getPositionRange(A,u),W=i.Tools.deepClone(v.getValue(U,E)),$=i.Tools.deepClone(w.getValue(U,E));$&&W&&($.s=W),_.setValue(x.startRow,x.startColumn,$)});const b={fromRange:e.range,toRange:t.range,from:{value:I.getMatrix(),subUnitId:c},to:{value:_.getMatrix(),subUnitId:d},unitId:l},T={fromRange:t.range,toRange:e.range,from:{value:w.getMatrix(),subUnitId:c},to:{value:M.getMatrix(),subUnitId:d},unitId:l};s.push({id:Be.id,params:b}),r.push({id:Be.id,params:T})}return{redos:s,undos:r}}function fc(o,e,t){const n=o.startRow,s=o.startColumn,r=t.getMergedCell(n,s),a=oe(e,t);if(r){const c=r.endRow-r.startRow+1,l=r.endColumn-r.startColumn+1;a.endRow=a.startRow+c-1,a.endColumn=a.startColumn+l-1,a.actualRow=a.startRow,a.actualColumn=a.startColumn,a.isMerged=!1,a.isMergedMainCell=!0}return a}var cn=(o=>(o[o.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",o[o.UNIVER_DOC=1]="UNIVER_DOC",o[o.UNIVER_SHEET=2]="UNIVER_SHEET",o[o.UNIVER_SLIDE=3]="UNIVER_SLIDE",o[o.UNIVER_PROJECT=4]="UNIVER_PROJECT",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(cn||{}),y=(o=>(o[o.View=0]="View",o[o.Edit=1]="Edit",o[o.ManageCollaborator=2]="ManageCollaborator",o[o.Print=3]="Print",o[o.Duplicate=4]="Duplicate",o[o.Comment=5]="Comment",o[o.Copy=6]="Copy",o[o.Share=7]="Share",o[o.Export=8]="Export",o[o.MoveWorksheet=9]="MoveWorksheet",o[o.DeleteWorksheet=10]="DeleteWorksheet",o[o.HideWorksheet=11]="HideWorksheet",o[o.RenameWorksheet=12]="RenameWorksheet",o[o.CreateWorksheet=13]="CreateWorksheet",o[o.SetWorksheetStyle=14]="SetWorksheetStyle",o[o.EditWorksheetCell=15]="EditWorksheetCell",o[o.InsertHyperlink=16]="InsertHyperlink",o[o.Sort=17]="Sort",o[o.Filter=18]="Filter",o[o.PivotTable=19]="PivotTable",o[o.FloatImg=20]="FloatImg",o[o.History=21]="History",o[o.RwHgtClWdt=22]="RwHgtClWdt",o[o.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",o[o.ViewFilter=24]="ViewFilter",o[o.MoveSheet=25]="MoveSheet",o[o.DeleteSheet=26]="DeleteSheet",o[o.HideSheet=27]="HideSheet",o[o.CopySheet=28]="CopySheet",o[o.RenameSheet=29]="RenameSheet",o[o.CreateSheet=30]="CreateSheet",o[o.SelectProtectedCells=31]="SelectProtectedCells",o[o.SelectUnProtectedCells=32]="SelectUnProtectedCells",o[o.SetCellStyle=33]="SetCellStyle",o[o.SetCellValue=34]="SetCellValue",o[o.SetRowStyle=35]="SetRowStyle",o[o.SetColumnStyle=36]="SetColumnStyle",o[o.InsertRow=37]="InsertRow",o[o.InsertColumn=38]="InsertColumn",o[o.DeleteRow=39]="DeleteRow",o[o.DeleteColumn=40]="DeleteColumn",o[o.EditExtraObject=41]="EditExtraObject",o[o.Delete=42]="Delete",o[o.RecoverHistory=43]="RecoverHistory",o[o.ViewHistory=44]="ViewHistory",o[o.CreatePermissionObject=45]="CreatePermissionObject",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(y||{}),N=(o=>(o[o.Unkonwn=0]="Unkonwn",o[o.Workbook=1]="Workbook",o[o.Worksheet=2]="Worksheet",o[o.SelectRange=3]="SelectRange",o[o.Document=4]="Document",o[o.Slide=5]="Slide",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(N||{});class ge{constructor(e,t,n){S(this,"type",N.SelectRange);S(this,"subType",y.Edit);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${y.Edit}.${n}`}}class _n{constructor(e,t,n){S(this,"type",N.SelectRange);S(this,"subType",y.View);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!1);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${y.View}.${n}`}}class to{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Comment);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Comment}_${e}`}}class no{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Copy);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Copy}_${e}`}}class tr{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"subType",y.CopySheet);S(this,"status",i.PermissionStatus.INIT);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.CopySheet}_${e}`}}class oo{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.CreatePermissionObject);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.CreatePermissionObject}_${e}`}}class so{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.CreateSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.CreateSheet}_${e}`}}class nr{constructor(e){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteColumn);this.unitId=e,this.id=`${this.type}.${y.DeleteColumn}_${e}`}}class or{constructor(e){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteRow);this.unitId=e,this.id=`${this.type}.${y.DeleteRow}_${e}`}}class ro{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.DeleteSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.DeleteSheet}_${e}`}}class io{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Duplicate);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Duplicate}_${e}`}}class ue{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Edit);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Edit}_${e}`}}class ao{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Export);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Export}_${e}`}}class bn{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.HideSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.HideSheet}_${e}`}}class sr{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.History);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.History}_${e}`}}class rr{constructor(e){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertColumn);this.unitId=e,this.id=`${this.type}.${y.InsertColumn}_${e}`}}class ir{constructor(e){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertRow);this.unitId=e,this.id=`${this.type}.${y.InsertRow}_${e}`}}class En{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.ManageCollaborator);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.ManageCollaborator}_${e}`}}class Tn{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.MoveSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.MoveSheet}_${e}`}}class co{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Print);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Print}_${e}`}}class lo{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.RecoverHistory);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.RecoverHistory}_${e}`}}class Un{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.RenameSheet);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.RenameSheet}_${e}`}}class uo{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Share);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.Share}_${e}`}}class mo{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.View);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.View}_${e}`}}class ho{constructor(e){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.ViewHistory);this.unitId=e,this.unitId=e,this.id=`${this.type}.${y.ViewHistory}_${e}`}}class go{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Copy);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.Copy}_${e}_${t}`}}class Ro{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteColumn);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.DeleteColumn}_${e}_${t}`}}class Co{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Delete);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.Delete}_${e}_${t}`}}class So{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteRow);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.DeleteRow}_${e}_${t}`}}class Re{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Edit);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.Edit}_${e}_${t}`}}class fo{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.EditExtraObject);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.EditExtraObject}_${e}_${t}`}}class po{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Filter);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.Filter}_${e}_${t}`}}class Io{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertColumn);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.InsertColumn}_${e}_${t}`}}class vo{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertHyperlink);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.InsertHyperlink}_${e}_${t}`}}class wo{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertRow);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.InsertRow}_${e}_${t}`}}class Mo{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.ManageCollaborator);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.ManageCollaborator}_${e}_${t}`}}class yo{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.PivotTable);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.PivotTable}_${e}_${t}`}}class pc{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SelectProtectedCells);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.SelectProtectedCells}_${e}_${t}`}}class Ic{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SelectUnProtectedCells);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.SelectUnProtectedCells}_${e}_${t}`}}class _o{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetCellStyle);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.SetCellStyle}_${e}_${t}`}}class xt{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetCellValue);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.SetCellValue}_${e}_${t}`}}class mt{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetColumnStyle);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.SetColumnStyle}_${e}_${t}`}}class ht{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetRowStyle);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.SetRowStyle}_${e}_${t}`}}class bo{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Sort);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.Sort}_${e}_${t}`}}class zt{constructor(e,t){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.View);this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${y.View}_${e}_${t}`}}const Et={id:"sheet.command.set-range-values",type:i.CommandType.COMMAND,handler:(o,e)=>{var A;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=o.get(i.IPermissionService),l=k(s,e);if(!l)return!1;const{subUnitId:u,unitId:d,workbook:m,worksheet:h}=l,{value:g,range:R,redoUndoId:C}=e,f=R?[R]:(A=r.getCurrentSelections())==null?void 0:A.map(x=>x.range);if(!f||!f.length||!c.getPermissionPoint(new Re(d,u).id))return!1;const p=new i.ObjectMatrix;let w;if(i.Tools.isArray(g))for(let x=0;x<f.length;x++){const{startRow:W,startColumn:$,endRow:z,endColumn:j}=f[x];for(let q=0;q<=z-W;q++)for(let te=0;te<=j-$;te++)p.setValue(q+W,te+$,g[q][te])}else if(i.isICellData(g))for(let x=0;x<f.length;x++){const{startRow:W,startColumn:$,endRow:z,endColumn:j}=f[x];for(let q=W;q<=z;q++)for(let te=$;te<=j;te++)p.setValue(q,te,g)}else w=g;const I={subUnitId:u,unitId:d,cellValue:w!=null?w:p.getMatrix()},v=me(o,I),M=i.mapObjectMatrix(I.cellValue,(x,W)=>h.getCellHeight(x,W)||void 0);if(!t.syncExecuteCommand(H.id,I))return!1;const{undos:b,redos:T}=a.onCommandExecute({id:Et.id,params:I}),{undos:U,redos:E}=a.generateMutationsOfAutoHeight({unitId:d,subUnitId:u,ranges:f,cellHeights:new i.ObjectMatrix(M)});if(i.sequenceExecute([...T,...E],t).result){const x=Ne(R!=null?R:p.getRange(),m,h);return n.pushUndoRedo({unitID:d,undoMutations:[{id:H.id,params:v},...b,...U,x],redoMutations:[{id:H.id,params:I},...T,...E,i.Tools.deepClone(x)],id:C}),!0}return!1}};function Eo(o,e){const t=[],n=[],{unitId:s,subUnitId:r,range:a,shiftDimension:c,cellValue:l={}}=e,u=o.get(i.IUniverInstanceService),d=o.get(exports.SheetInterceptorService),m=u.getUniverSheetInstance(s),h=m==null?void 0:m.getSheetBySheetId(r);if(h){const g=h.getCellMatrix(),R=g.getDataRange();if(a.startColumn<=R.endColumn||a.startRow<=R.endRow){let I,v;if(c===i.Dimension.COLUMNS){const _=Math.min(a.endRow,R.endRow);let b=0;for(let U=a.startRow;U<=_;U++){const E=g.getRow(U),P=E?i.getArrayLength(E)-1:0;b=Math.max(b,P)}I={startRow:a.startRow,startColumn:a.startColumn,endRow:_,endColumn:b};const T=a.endColumn-a.startColumn+1;v={startRow:a.startRow,startColumn:I.startColumn+T,endRow:_,endColumn:I.endColumn+T}}else{const _=Math.min(a.endColumn,R.endColumn),b=R.endRow;I={startRow:a.startRow,startColumn:a.startColumn,endRow:b,endColumn:_};const T=a.endRow-a.startRow+1;v={startRow:I.startRow+T,startColumn:a.startColumn,endRow:I.endRow+T,endColumn:_}}const M=yn(o,{unitId:s,subUnitId:r,range:I},{subUnitId:r,range:v},!0);M&&(t.push(...M.redos),n.push(...M.undos))}if(Object.entries(l).length===0)for(let I=a.startRow;I<=a.endRow;I++){l[I]||(l[I]={});for(let v=a.startColumn;v<=a.endColumn;v++)l[I][v]=null}const C={subUnitId:r,unitId:s,cellValue:l},f=me(o,C),{undos:p,redos:w}=d.onCommandExecute({id:Et.id,params:{...C,range:a}});t.push({id:H.id,params:C},...w),n.push({id:H.id,params:f},...p)}return{redo:t,undo:n}}function To(o,e){const t=[],n=[],{unitId:s,subUnitId:r,range:a,shiftDimension:c}=e,l=o.get(i.IUniverInstanceService),u=o.get(exports.SheetInterceptorService),d=l.getUniverSheetInstance(s),m=d==null?void 0:d.getSheetBySheetId(r);if(m){const h=m.getCellMatrix(),g=h.getDataRange(),R={subUnitId:r,unitId:s,cellValue:eo([a])},C=me(o,R),f=u.onCommandExecute({id:Et.id,params:R});if(t.push({id:H.id,params:R},...f.redos),n.push(...f.undos,{id:H.id,params:C}),a.startColumn<=g.endColumn||a.startRow<=g.endRow){let p=null,w=null;if(c===i.Dimension.COLUMNS&&a.endColumn<g.endColumn){const I=Math.min(a.endRow,g.endRow);let v=0;for(let _=a.startRow;_<=I;_++){const b=h.getRow(_),T=b?i.getArrayLength(b)-1:0;v=Math.max(v,T)}p={startRow:a.startRow,startColumn:a.endColumn+1,endRow:I,endColumn:v};const M=a.endColumn-a.startColumn+1;w={startRow:a.startRow,startColumn:p.startColumn-M,endRow:I,endColumn:p.endColumn-M}}if(c===i.Dimension.ROWS&&a.endRow<g.endRow){const I=Math.min(a.endColumn,g.endColumn),v=g.endRow;p={startRow:a.endRow+1,startColumn:a.startColumn,endRow:v,endColumn:I};const M=a.endRow-a.startRow+1;w={startRow:p.startRow-M,startColumn:a.startColumn,endRow:p.endRow-M,endColumn:I}}if(p&&w){const I=yn(o,{unitId:s,subUnitId:r,range:p},{subUnitId:r,range:w},!0);I&&(t.push(...I.redos),n.push(...I.undos))}}}return{redo:t,undo:n}}function vc(o,e,t,n,s,r){const{startRow:a,endRow:c,startColumn:l,endColumn:u}=e;if(s===i.Dimension.ROWS){const d=c-a+1;for(let m=t;m>=a;m--)for(let h=l;h<=u;h++){const g=o.getValue(m,h);g==null?o.realDeleteValue(m+d,h):o.setValue(m+d,h,g)}for(let m=c;m>=a;m--)for(let h=l;h<=u;h++)r&&r[m]&&r[m][h]?o.setValue(m,h,r[m][h]):o.realDeleteValue(m,h)}else if(s===i.Dimension.COLUMNS){const d=u-l+1;for(let m=a;m<=c;m++)for(let h=n;h>=l;h--){const g=o.getValue(m,h);g==null?o.realDeleteValue(m,h+d):o.setValue(m,h+d,g)}for(let m=a;m<=c;m++)for(let h=u;h>=l;h--)r&&r[m]&&r[m][h]?o.setValue(m,h,r[m][h]):o.realDeleteValue(m,h)}}function wc(o,e,t,n,s){const{startRow:r,endRow:a,startColumn:c,endColumn:l}=e,u=a-r+1,d=l-c+1;if(s===i.Dimension.ROWS)for(let m=r;m<=t;m++)for(let h=c;h<=l;h++){const g=o.getValue(m+u,h);g==null?o.realDeleteValue(m,h):o.setValue(m,h,g)}else if(s===i.Dimension.COLUMNS)for(let m=r;m<=a;m++)for(let h=c;h<=n;h++){const g=o.getValue(m,h+d);g==null?o.realDeleteValue(m,h):o.setValue(m,h,g)}}const ar="sheet.command.delete-range-move-left",Fe={type:i.CommandType.COMMAND,id:ar,handler:async(o,e)=>{var v,M,_;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=k(s);if(!c)return!1;const{worksheet:l,workbook:u,subUnitId:d,unitId:m}=c;let h=e==null?void 0:e.range;if(h||(h=(v=r.getCurrentLastSelection())==null?void 0:v.range),!h)return!1;const g={range:h,subUnitId:d,unitId:m,shiftDimension:i.Dimension.COLUMNS},R=a.onCommandExecute({id:Fe.id,params:{range:h}}),{redo:C,undo:f}=To(o,g),p=[...(M=R.preRedos)!=null?M:[],...C],w=[...R.undos,...f];if(p.push(...R.redos),p.push(Ne(h,u,l)),w.push(...(_=R.preUndos)!=null?_:[]),i.sequenceExecute(p,t).result){const b=a.afterCommandExecute({id:Fe.id,params:{range:h}});return i.sequenceExecute(b.redos,t),w.push(...b.undos),p.push(...b.redos),n.pushUndoRedo({unitID:m,undoMutations:w.reverse(),redoMutations:p}),!0}return!1}},cr="sheet.command.delete-range-move-up",je={type:i.CommandType.COMMAND,id:cr,handler:async(o,e)=>{var v,M,_;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=k(s);if(!c)return!1;const{unitId:l,subUnitId:u,workbook:d,worksheet:m}=c;let h=e==null?void 0:e.range;if(h||(h=(v=r.getCurrentLastSelection())==null?void 0:v.range),!h)return!1;const g={range:h,subUnitId:u,unitId:l,shiftDimension:i.Dimension.ROWS},R=a.onCommandExecute({id:je.id,params:{range:h}}),{redo:C,undo:f}=To(o,g),p=[...(M=R.preRedos)!=null?M:[],...C],w=[...R.undos,...f];if(p.push(...R.redos),p.push(Ne(h,d,m)),w.push(...(_=R.preUndos)!=null?_:[]),i.sequenceExecute(p,t).result){const b=a.afterCommandExecute({id:je.id,params:{range:h}});return i.sequenceExecute(b.redos,t),w.push(...b.undos),p.push(...b.redos),n.pushUndoRedo({unitID:l,undoMutations:w.reverse(),redoMutations:p}),!0}return!1}},Mc="sheet.command.insert-range-move-down",Je={type:i.CommandType.COMMAND,id:"sheet.command.insert-range-move-down",handler:async(o,e)=>{var A,x,W;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=o.get(i.ErrorService),l=o.get(i.LocaleService);if(r.isOverlapping())return c.emit(l.t("sheets.info.overlappingSelections")),!1;const u=k(s);if(!u)return!1;const{unitId:d,subUnitId:m,worksheet:h,workbook:g}=u;let R=e==null?void 0:e.range;if(R||(R=(A=r.getCurrentLastSelection())==null?void 0:A.range),!R)return!1;const C=[],f=[],p=h.getCellMatrix(),w=p.getDataRange(),v=p.getSlice(w.startRow,w.endRow,R.startColumn,R.endColumn).getDataRange().endRow,M=Math.max(v+(R.endRow-R.startRow+1)-w.endRow,0);if(M>0){const $=R.startRow-1,z=h.getRowHeight($),j={unitId:d,subUnitId:m,range:{startRow:w.endRow+1,endRow:w.endRow+M,startColumn:w.startColumn,endColumn:w.endColumn},rowInfo:new Array(M).fill(void 0).map(()=>({h:z,hd:i.BooleanNumber.FALSE}))};C.push({id:ae.id,params:j});const q=In(o,j);f.push({id:le.id,params:q})}const _={};i.Range.foreach(R,($,z)=>{const j=h.getCell($,z);j&&(_[$]||(_[$]={}),_[$][z]={s:j.s})});const b={range:R,subUnitId:m,unitId:d,shiftDimension:i.Dimension.ROWS,cellValue:_},{redo:T,undo:U}=Eo(o,b);C.push(...T),f.push(...U);const E=a.onCommandExecute({id:Je.id,params:{range:R}});if(C.push(...E.redos),C.push(Ne(R,g,h)),f.push(...(x=E.preUndos)!=null?x:[]),C.unshift(...(W=E.preRedos)!=null?W:[]),f.unshift(...E.undos),i.sequenceExecute(C,t)){const $=a.afterCommandExecute({id:Je.id,params:{range:R}});return i.sequenceExecute($.redos,t),f.push(...$.undos),C.push(...$.redos),n.pushUndoRedo({unitID:d,undoMutations:f.reverse(),redoMutations:C}),!0}return!1}},Uo="sheet.command.insert-range-move-right",ft={type:i.CommandType.COMMAND,id:Uo,handler:async(o,e)=>{var A,x,W;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=o.get(i.ErrorService),l=o.get(i.LocaleService);if(r.isOverlapping())return c.emit(l.t("sheets.info.overlappingSelections")),!1;const u=k(s);if(!u)return!1;const{workbook:d,worksheet:m,unitId:h,subUnitId:g}=u;let R=e==null?void 0:e.range;if(R||(R=(A=r.getCurrentLastSelection())==null?void 0:A.range),!R)return!1;const C=[],f=[],p=m.getCellMatrix(),w=p.getDataRange(),v=p.getSlice(R.startRow,R.endRow,w.startColumn,w.endColumn).getDataRange().endColumn,M=Math.max(v+(R.endColumn-R.startColumn+1)-w.endColumn,0);if(M>0){const $=R.startColumn-1,z=m.getColumnWidth($),j={unitId:h,subUnitId:g,range:{startRow:w.startRow+1,endRow:w.endRow,startColumn:w.endColumn+1,endColumn:w.endColumn+M},colInfo:new Array(M).fill(void 0).map(()=>({w:z,hd:i.BooleanNumber.FALSE}))};C.push({id:ce.id,params:j});const q=Ft(o,j);f.push({id:ne.id,params:q})}const _={};i.Range.foreach(R,($,z)=>{const j=m.getCell($,z);!j||!j.s||(_[$]||(_[$]={}),_[$][z]={s:j.s})});const b={range:R,subUnitId:g,unitId:h,shiftDimension:i.Dimension.COLUMNS,cellValue:_},{redo:T,undo:U}=Eo(o,b);C.push(...T),f.push(...U);const E=a.onCommandExecute({id:ft.id,params:{range:R}});if(C.push(...E.redos),C.push(Ne(R,d,m)),f.push(...(x=E.preUndos)!=null?x:[]),C.unshift(...(W=E.preRedos)!=null?W:[]),f.unshift(...E.undos),i.sequenceExecute(C,t).result){const $=a.afterCommandExecute({id:ft.id,params:{range:R}});return i.sequenceExecute($.redos,t),f.push(...$.undos),C.push(...$.redos),n.pushUndoRedo({unitID:h,undoMutations:f.reverse(),redoMutations:C}),!0}return!1}},lr="sheet.command.insert-row",Me={type:i.CommandType.COMMAND,id:lr,handler:async(o,e)=>{const t=o.get(i.ICommandService),n=o.get(exports.SheetInterceptorService),{range:s,direction:r,unitId:a,subUnitId:c,cellValue:l}=e;return await n.beforeCommandExecute({id:Me.id,params:e})?t.syncExecuteCommand(ko.id,{range:s,direction:r,unitId:a,subUnitId:c,cellValue:l}):!1}},ko={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-by-range",handler:(o,e)=>{var T,U,E,P;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),a=k(s,e);if(!a)return!1;const{workbook:c,worksheet:l}=a,{range:u,direction:d,unitId:m,subUnitId:h,cellValue:g}=e,{startRow:R,endRow:C}=u;u.rangeType=i.RANGE_TYPE.ROW;const f=d===i.Direction.UP?R:R-1,p=l.getRowHeight(f),w={unitId:m,subUnitId:h,range:u,rowInfo:new Array(C-R+1).fill(void 0).map(()=>({h:p,hd:i.BooleanNumber.FALSE}))},I=In(o,w),v=[{id:ae.id,params:w}],M=[{id:le.id,params:I}];g&&Object.keys(g).length>0&&v.push({id:H.id,params:{unitId:m,subUnitId:h,cellValue:g}});const _=r.onCommandExecute({id:Me.id,params:e});if(v.unshift(...(T=_.preRedos)!=null?T:[]),v.push(...(U=_.redos)!=null?U:[]),v.push(Ne(u,c,l)),M.unshift(...(E=_.preUndos)!=null?E:[]),M.push(...(P=_.undos)!=null?P:[]),i.sequenceExecute(v,t).result){const A=r.afterCommandExecute({id:Me.id,params:e});return i.sequenceExecute(A.redos,t),v.push(...A.redos),M.push(...A.undos),n.pushUndoRedo({unitID:e.unitId,undoMutations:M,redoMutations:v}),!0}return!1}},ur={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-before",handler:async(o,e)=>{var f;const n=(f=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:f.map(p=>p.range);let s;if((n==null?void 0:n.length)===1)s=n[0];else return!1;const r=o.get(i.IUniverInstanceService),a=k(r);if(!a)return!1;const{worksheet:c,subUnitId:l,unitId:u}=a,d=e.value||0,m=s.startRow,h=s.startRow+d-1,g=0,R=c.getColumnCount()-1,C={unitId:u,subUnitId:l,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:g,endColumn:R},cellValue:We(c,m,h,g,R,!0,m-1)};return o.get(i.ICommandService).executeCommand(Me.id,C)}},dr={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-after",handler:async o=>{var C;const t=(C=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:C.map(f=>f.range);let n;if((t==null?void 0:t.length)===1)n=t[0];else return!1;const s=o.get(i.IUniverInstanceService),r=k(s);if(!r)return!1;const{worksheet:a,unitId:c,subUnitId:l}=r,u=n.endRow-n.startRow+1,d=n.endRow+1,m=n.endRow+u,h=0,g=a.getColumnCount()-1,R={unitId:c,subUnitId:l,direction:i.Direction.DOWN,range:{startRow:d,endRow:m,startColumn:h,endColumn:g,rangeType:i.RANGE_TYPE.ROW},cellValue:We(a,d,m,h,g,!0,n.endRow)};return o.get(i.ICommandService).executeCommand(Me.id,R)}},mr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-above",handler:async(o,e)=>{var p;const n=(p=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:p.map(w=>w.range);let s;if((n==null?void 0:n.length)===1)s=n[0];else return!1;const r=o.get(i.IUniverInstanceService),a=k(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=e.value||0,m=s.startRow,h=s.startRow+d-1,g=0,R=c.getColumnCount()-1,C=We(c,m,h,g,R,!0,m-1),f={unitId:l,subUnitId:u,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:g,endColumn:R,rangeType:i.RANGE_TYPE.ROW},cellValue:C};return o.get(i.ICommandService).executeCommand(Me.id,f)}},hr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-after",handler:async(o,e)=>{var f;const n=(f=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:f.map(p=>p.range);let s;if((n==null?void 0:n.length)===1)s=n[0];else return!1;const r=o.get(i.IUniverInstanceService),a=k(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=e.value||0,m=s.endRow+1,h=s.endRow+d,g=0,R=c.getColumnCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.DOWN,range:{startRow:m,endRow:h,startColumn:g,endColumn:R,rangeType:i.RANGE_TYPE.ROW},cellValue:We(c,m,h,g,R,!0,s.endRow)};return o.get(i.ICommandService).executeCommand(Me.id,C)}},gr="sheet.command.insert-col",ye={type:i.CommandType.COMMAND,id:gr,handler:async(o,e)=>{const t=o.get(i.ICommandService),n=o.get(exports.SheetInterceptorService),{range:s,direction:r,subUnitId:a,unitId:c,cellValue:l}=e;return await n.beforeCommandExecute({id:ye.id,params:e})?t.syncExecuteCommand(Po.id,{range:s,direction:r,unitId:c,subUnitId:a,cellValue:l}):!1}},Po={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-by-range",handler:(o,e)=>{var b,T,U,E;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),{range:a,direction:c,subUnitId:l,unitId:u,cellValue:d}=e,{startColumn:m,endColumn:h}=e.range;a.rangeType=i.RANGE_TYPE.COLUMN;const g=s.getUniverSheetInstance(e.unitId),R=g.getSheetBySheetId(e.subUnitId),C=c===i.Direction.LEFT?m:m-1,f=R.getColumnWidth(C),p={unitId:u,subUnitId:l,range:a,colInfo:new Array(h-m+1).fill(void 0).map(()=>({w:f,hd:i.BooleanNumber.FALSE}))},w=Ft(o,p),I=[{id:ce.id,params:p}],v=[{id:ne.id,params:w}];d&&I.push({id:H.id,params:{unitId:u,subUnitId:l,cellValue:d}});const M=r.onCommandExecute({id:ye.id,params:e});if(I.unshift(...(b=M.preRedos)!=null?b:[]),I.push(...(T=M.redos)!=null?T:[]),I.push(Ne(a,g,R)),v.unshift(...(U=M.preUndos)!=null?U:[]),v.push(...(E=M.undos)!=null?E:[]),i.sequenceExecute(I,t).result){const P=r.afterCommandExecute({id:ye.id,params:e});return i.sequenceExecute(P.redos,t),I.push(...P.redos),v.push(...P.undos),n.pushUndoRedo({unitID:e.unitId,undoMutations:v.filter(Boolean),redoMutations:I.filter(Boolean)}),!0}return!1}},Rr={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-before",handler:async(o,e)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();let s;if((n==null?void 0:n.length)===1)s=n[0].range;else return!1;const r=o.get(i.IUniverInstanceService),a=k(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=e.value||0,m=s.startColumn,h=s.startColumn+d-1,g=0,R=c.getRowCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:g,endRow:R,rangeType:i.RANGE_TYPE.COLUMN},cellValue:We(c,g,R,m,h,!1,m-1)};return o.get(i.ICommandService).executeCommand(ye.id,C)}},Cr={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-after",handler:async o=>{const t=o.get(exports.SheetsSelectionsService).getCurrentSelections();let n;if((t==null?void 0:t.length)===1)n=t[0].range;else return!1;const s=o.get(i.IUniverInstanceService),r=k(s);if(!r)return!1;const{worksheet:a,unitId:c,subUnitId:l}=r,u=n.endColumn-n.startColumn+1,d=n.endColumn+1,m=n.endColumn+u,h=0,g=a.getRowCount()-1,R={unitId:c,subUnitId:l,direction:i.Direction.RIGHT,range:{startColumn:d,endColumn:m,startRow:h,endRow:g},cellValue:We(a,h,g,d,m,!1,n.endColumn)};return o.get(i.ICommandService).executeCommand(ye.id,R)}},Sr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-before",handler:async(o,e)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();let s;if((n==null?void 0:n.length)===1)s=n[0].range;else return!1;const r=o.get(i.IUniverInstanceService),a=k(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=e.value||0,m=s.startColumn,h=s.startColumn+d-1,g=0,R=c.getRowCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:g,endRow:R,rangeType:i.RANGE_TYPE.COLUMN},cellValue:We(c,g,R,m,h,!1,m-1)};return o.get(i.ICommandService).executeCommand(ye.id,C)}},fr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-right",handler:async(o,e)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();let s;if((n==null?void 0:n.length)===1)s=n[0].range;else return!1;const r=o.get(i.IUniverInstanceService),a=k(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=e.value||0,m=s.endColumn+1,h=s.endColumn+d,g=0,R=c.getRowCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.RIGHT,range:{startColumn:m,endColumn:h,startRow:g,endRow:R},cellValue:We(c,g,R,m,h,!1,s.endColumn)};return o.get(i.ICommandService).executeCommand(ye.id,C)}},ln="sheet.command.remove-row",No={type:i.CommandType.COMMAND,id:"sheet.command.remove-row-by-range",handler:(o,e)=>{var f,p,w;if(!e)return!1;const t=o.get(i.IUniverInstanceService),n=k(t,e);if(!n)return!1;const{workbook:s,worksheet:r}=n,a=o.get(exports.SheetInterceptorService),{range:c,unitId:l,subUnitId:u}=e,d=jt([c],o,l,u).reverse(),m=[],h=[];d.forEach(I=>{const v=[],M=[],_={unitId:l,subUnitId:u,range:I},b=Ra(_,r),T=r.getCellMatrix().getSlice(I.startRow,I.endRow,0,r.getColumnCount()-1),U={unitId:l,subUnitId:u,cellValue:T.getMatrix()};M.push({id:le.id,params:_}),v.push({id:ae.id,params:b}),v.push({id:H.id,params:U}),h.push(...M),m.unshift(...v)});const g=a.onCommandExecute({id:ln,params:{range:c}}),R=o.get(i.ICommandService);if(i.sequenceExecute([...(f=g.preRedos)!=null?f:[],...h,...g.redos,Ne(c,s,r)],R).result){const I=a.afterCommandExecute({id:ln,params:{range:c}});return i.sequenceExecute(I.redos,R),o.get(i.IUndoRedoService).pushUndoRedo({unitID:l,undoMutations:[...(p=g.preUndos)!=null?p:[],...m,...g.undos,...I.undos],redoMutations:[...(w=g.preRedos)!=null?w:[],...h,...g.redos,...I.redos]}),!0}return!1}},qt={type:i.CommandType.COMMAND,id:ln,handler:async(o,e)=>{var h;const t=o.get(exports.SheetsSelectionsService),n=o.get(exports.SheetInterceptorService),s=o.get(i.ICommandService);let r=e==null?void 0:e.range;if(r||(r=(h=t.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=o.get(i.IUniverInstanceService),c=k(a);if(!c)return!1;const{worksheet:l,subUnitId:u,unitId:d}=c;return r={...r,startColumn:0,endColumn:Math.max(l.getMaxColumns()-1,0)},await n.beforeCommandExecute({id:qt.id,params:{range:r}})?s.syncExecuteCommand(No.id,{range:r,unitId:d,subUnitId:u}):!1}},un="sheet.command.remove-col",Oo={type:i.CommandType.COMMAND,id:"sheet.command.remove-col-by-range",handler:(o,e)=>{var p,w,I;if(!e)return!1;const t=o.get(i.IUniverInstanceService),n=k(t,e);if(!n)return!1;const{workbook:s,worksheet:r}=n,a=o.get(exports.SheetInterceptorService),{range:c,unitId:l,subUnitId:u}=e,d={unitId:l,subUnitId:u,range:c},m=Ca(o,d),h=r.getCellMatrix().getSlice(0,r.getRowCount()-1,c.startColumn,c.endColumn),g={unitId:l,subUnitId:u,cellValue:h.getMatrix()},R=a.onCommandExecute({id:un,params:{range:c}}),C=o.get(i.ICommandService);if(i.sequenceExecute([...(p=R.preRedos)!=null?p:[],{id:ne.id,params:d},...R.redos,Ne(c,s,r)],C).result){const v=a.afterCommandExecute({id:un,params:{range:c}});return i.sequenceExecute(v.redos,C),o.get(i.IUndoRedoService).pushUndoRedo({unitID:l,undoMutations:[...(w=R.preUndos)!=null?w:[],{id:ce.id,params:m},{id:H.id,params:g},...R.undos,...v.undos],redoMutations:[...(I=R.preRedos)!=null?I:[],{id:ne.id,params:d},...R.redos,...v.redos]}),!0}return!1}},Yt={type:i.CommandType.COMMAND,id:un,handler:async(o,e)=>{var h;const t=o.get(exports.SheetsSelectionsService),n=o.get(exports.SheetInterceptorService),s=o.get(i.ICommandService);let r=e==null?void 0:e.range;if(r||(r=(h=t.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=o.get(i.IUniverInstanceService),c=k(a);if(!c)return!1;const{worksheet:l,subUnitId:u,unitId:d}=c;return r={...r,startRow:0,endRow:Math.max(l.getMaxRows()-1,0)},await n.beforeCommandExecute({id:Yt.id,params:{range:r}})?s.syncExecuteCommand(Oo.id,{range:r,unitId:d,subUnitId:u}):!1}},pr=(o,e)=>{const t=o.get(i.IUniverInstanceService),{subUnitId:n,unitId:s}=e,r=_e(t,e);if(!r)throw new Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");const{workbook:a,worksheet:c}=r,l=c.getConfig();return{index:a.getConfig().sheetOrder.findIndex(m=>m===n),sheet:l,unitId:s}},nt={id:"sheet.mutation.remove-sheet",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService),{subUnitId:n,unitId:s}=e,r=t.getUniverSheetInstance(s);return r?r.removeSheet(n):!1}};function yc(o,e){return e.getMergeData().some(t=>t.startRow<o&&o<=t.endRow)}function _c(o,e){return e.getMergeData().some(t=>t.startColumn<o&&o<=t.endColumn)}const Ir="sheet.command.move-rows",pt={id:Ir,type:i.CommandType.COMMAND,handler:(o,e)=>{var A,x;const t=o.get(exports.SheetsSelectionsService),{fromRange:{startRow:n},toRange:{startRow:s},range:r}=e,a=r?[wr(r)]:t.getCurrentSelections(),c=a==null?void 0:a.filter(W=>W.range.rangeType===i.RANGE_TYPE.ROW&&W.range.startRow<=n&&n<=W.range.endRow);if((c==null?void 0:c.length)!==1)return!1;const l=o.get(exports.SheetInterceptorService),u=o.get(i.IUniverInstanceService),d=k(u,e);if(!d)return!1;const{workbook:m,worksheet:h}=d,g=m.getUnitId(),R=h.getSheetId(),C=o.get(i.ErrorService),f=o.get(i.LocaleService),p=c[0].range,w=c[0].primary,I=Gt(p,h,!1);if(!i.Rectangle.equals(p,I))return C.emit(f.t("sheets.info.partOfCell")),!1;if(yc(s,h))return C.emit(f.t("sheets.info.acrossMergedCell")),!1;const v={...p,startRow:s,endRow:s+p.endRow-p.startRow},M={unitId:g,subUnitId:R,sourceRange:p,targetRange:v},_=Es(o,M),b=o.get(i.ICommandService),T=l.onCommandExecute({id:pt.id,params:e}),U=[...(A=T.preRedos)!=null?A:[],{id:ve.id,params:M}],E=[...(x=T.preUndos)!=null?x:[],{id:ve.id,params:_}];if(w){const $=s-n<0,z=p.endRow-p.startRow+1,j=$?v:{...v,startRow:v.startRow-z,endRow:v.endRow-z},q={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:j,primary:oe(j,h),style:null}]},te={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:p,primary:w,style:null}]};U.push({id:G.id,params:q}),E.push({id:G.id,params:te})}if(U.push(...T.redos),E.push(...T.undos),i.sequenceExecute(U,b).result){const W=l.afterCommandExecute({id:pt.id,params:e});return i.sequenceExecute(W.redos,b),U.push(...W.redos),E.push(...W.undos),o.get(i.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:E,redoMutations:U}),!0}return!1}},vr="sheet.command.move-cols",It={id:vr,type:i.CommandType.COMMAND,handler:(o,e)=>{var A,x;const t=o.get(exports.SheetsSelectionsService),{fromRange:{startColumn:n},toRange:{startColumn:s},range:r}=e,a=r?[wr(r)]:t.getCurrentSelections(),c=a==null?void 0:a.filter(W=>W.range.rangeType===i.RANGE_TYPE.COLUMN&&W.range.startColumn<=n&&n<=W.range.endColumn);if((c==null?void 0:c.length)!==1)return!1;const l=o.get(exports.SheetInterceptorService),u=o.get(i.IUniverInstanceService),d=k(u,e);if(!d)return!1;const{workbook:m,worksheet:h}=d,g=m.getUnitId(),R=h.getSheetId(),C=o.get(i.ErrorService),f=o.get(i.LocaleService),p=c[0].range,w=c[0].primary,I=Gt(p,h,!1);if(!i.Rectangle.equals(p,I))return C.emit(f.t("sheets.info.partOfCell")),!1;if(_c(s,h))return C.emit(f.t("sheets.info.acrossMergedCell")),!1;const v={...p,startColumn:s,endColumn:s+p.endColumn-p.startColumn},M={unitId:g,subUnitId:R,sourceRange:p,targetRange:v},_=Ts(o,M),b=o.get(i.ICommandService),T=l.onCommandExecute({id:It.id,params:e}),U=[...(A=T.preRedos)!=null?A:[],{id:we.id,params:M}],E=[...(x=T.preUndos)!=null?x:[],{id:we.id,params:_}];if(w){const W=p.endColumn-p.startColumn+1,j=s-n<0?v:{...v,startColumn:v.startColumn-W,endColumn:v.endColumn-W},q={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:j,primary:oe(j,h),style:null}]},te={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:p,primary:w,style:null}]};U.push({id:G.id,params:q}),E.push({id:G.id,params:te})}if(U.push(...T.redos),E.push(...T.undos),i.sequenceExecute(U,b).result){const W=l.afterCommandExecute({id:It.id,params:e});return i.sequenceExecute(W.redos,b),U.push(...W.redos),E.push(...W.undos),o.get(i.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:E,redoMutations:U}),!0}return!1}};function wr(o){return{range:o,primary:null,style:null}}var bc=Object.getOwnPropertyDescriptor,Ec=(o,e,t,n)=>{for(var s=n>1?void 0:n?bc(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Tc=(o,e)=>(t,n)=>e(t,n,o);exports.SheetSkeletonService=class extends i.Disposable{constructor(t){super();S(this,"_sheetSkeletonStore",new Map);this._injector=t,this.disposeWithMe(()=>{this._sheetSkeletonStore=new Map})}getSkeleton(t,n){if(this._sheetSkeletonStore.has(t))return this._sheetSkeletonStore.get(t).get(n)}setSkeleton(t,n,s){this._sheetSkeletonStore.has(t)||this._sheetSkeletonStore.set(t,new Map),this._sheetSkeletonStore.get(t).set(n,s)}deleteSkeleton(t,n){this._sheetSkeletonStore.has(t)&&this._sheetSkeletonStore.get(t).delete(n)}};exports.SheetSkeletonService=Ec([Tc(0,i.Inject(i.Injector))],exports.SheetSkeletonService);function Do(o,e){const t=new i.ObjectMatrix;return o.map(n=>i.Range.transformRange(n,e)).forEach(n=>{i.Range.foreach(n,(s,r)=>{const a=e.getCellHeight(s,r);a&&t.setValue(s,r,a)})}),t}const Uc=1e4;function Kt(o,e){if(!e)return{suitableRanges:o,remainingRanges:[]};const t=e.worksheet.getColumnCount(),n=Math.ceil(Uc/t),s=[],r=[],a=e.getOffsetRelativeToRowCol(0,e.scrollY).row,c=o.map(u=>{let d;return a>=u.startRow&&a<=u.endRow?d=0:a<u.startRow?d=u.startRow-a:d=a-u.endRow,{range:u,distance:d,rowCount:u.endRow-u.startRow+1}});c.sort((u,d)=>u.distance!==d.distance?u.distance-d.distance:u.rowCount-d.rowCount);let l=0;for(const u of c)if(l+u.rowCount<=n)s.push(u.range),l+=u.rowCount;else{const d=n-l;if(d>0){const m={...u.range,endRow:u.range.startRow+d-1},h={...u.range,startRow:u.range.startRow+d};s.push(m),r.push(h),l=n}else r.push(u.range)}return{suitableRanges:s,remainingRanges:r}}function Mr(o){let e=0;return o.forEach(()=>{e++}),e}const yr="sheet.command.reorder-range",dn={id:yr,type:i.CommandType.COMMAND,handler:(o,e)=>{var I,v;const{subUnitId:t,unitId:n,range:s,order:r}=e,a=o.get(i.ICommandService),c={id:At.id,params:{unitId:n,subUnitId:t,order:r,range:s}},l={id:At.id,params:Us(c.params)},u=o.get(exports.SheetInterceptorService),d=u.onCommandExecute({id:dn.id,params:e}),m=[...(I=d.preRedos)!=null?I:[],c,...d.redos],h=[...(v=d.preUndos)!=null?v:[],l,...d.undos],g=i.sequenceExecute(m,a),{suitableRanges:R,remainingRanges:C}=Kt([s],o.get(exports.SheetSkeletonService).getSkeleton(n,t)),{undos:f,redos:p}=u.generateMutationsOfAutoHeight({unitId:n,subUnitId:t,ranges:[s],autoHeightRanges:R,lazyAutoHeightRanges:C}),w=u.afterCommandExecute({id:dn.id,params:e});return g.result?(i.sequenceExecute([...w.redos,...p],a),o.get(i.IUndoRedoService).pushUndoRedo({unitID:n,undoMutations:[...h,...w.undos,...f],redoMutations:[...m,...w.redos,...p]}),!0):!1}},D={MoveRangeCommandId:er,InsertRowCommandId:lr,InsertColCommandId:gr,RemoveColCommandId:un,RemoveRowCommandId:ln,DeleteRangeMoveLeftCommandId:ar,DeleteRangeMoveUpCommandId:cr,InsertRangeMoveDownCommandId:Mc,InsertRangeMoveRightCommandId:Uo,MoveColsCommandId:vr,MoveRowsCommandId:Ir,ReorderRangeCommandId:yr};var L=(o=>(o[o.Set=0]="Set",o[o.Delete=1]="Delete",o[o.HorizontalMove=2]="HorizontalMove",o[o.VerticalMove=3]="VerticalMove",o[o.Unknown=4]="Unknown",o))(L||{});const Zt=Number.MAX_SAFE_INTEGER,Ue=o=>{const e={...o},t=Number.isNaN(e.startRow)&&Number.isNaN(e.endRow)&&!Number.isNaN(e.startColumn)&&!Number.isNaN(e.endColumn),n=Number.isNaN(e.startColumn)&&Number.isNaN(e.endColumn)&&!Number.isNaN(e.startRow)&&!Number.isNaN(e.endRow);return(e.rangeType===i.RANGE_TYPE.COLUMN||t)&&(e.startRow=0,e.endRow=Zt),(e.rangeType===i.RANGE_TYPE.ROW||n)&&(e.startColumn=0,e.endColumn=Zt),e.rangeType===i.RANGE_TYPE.ALL&&(e.startColumn=0,e.endColumn=Zt,e.startRow=0,e.endRow=Zt),e},de=o=>{let e=o.rangeType;return o.rangeType===i.RANGE_TYPE.COLUMN?e=i.RANGE_TYPE.ROW:o.rangeType===i.RANGE_TYPE.ROW&&(e=i.RANGE_TYPE.COLUMN),{startRow:o.startColumn,endRow:o.endColumn,startColumn:o.startRow,endColumn:o.endRow,rangeType:e}},Wt=(o,e,t)=>{const n={...t},s={...e},r=(C,f)=>{const p=Math.max(C.start,f.start),w=Math.min(C.end,f.end);return w<p?null:{start:p,end:w}},a=C=>C.end-C.start+1,c=(C,f)=>({start:C.start-f.start,end:C.start-f.start+C.end-C.start}),l=(C,f)=>({start:f.start+C.start,end:f.start+C.start+C.end-C.start}),u=e.start>o.start;if(u){const C=Math.min(o.end,e.start)-o.start+1;s.start-=C,s.end-=C}const d=a(o),m=d,h=r(o,n),g=h&&a(h)>=a(n);if(o.end<n.start)n.start-=d,n.end-=d;else if(h){const C=a(h);if(g){const f=c(n,o),p=l(f,s);n.start=p.start,n.end=p.end}else h.start>o.start?u?(n.end-=C+d,n.start-=d):n.end-=C:u?n.end-=C:n.start>o.start&&n.end>o.end?(n.start-=d,n.end-=d+C):n.end-=C}const R=r(s,n);return g||(s.start<=n.start?(n.start+=m,n.end+=m):R&&(u?s.end<=n.start||s.start<=n.start&&s.end>=n.start?(n.start+=m,n.end+=m):s.start>=n.start&&s.start<=n.end&&(n.end+=m):n.start<s.start&&n.end>s.start?n.end+=m:(n.start>=s.end||n.start>=s.start&&n.start<=s.end)&&(n.end+=m,n.start+=m))),{step:n.start-t.start,length:a(n)-a(t)}},Ao=(o,e)=>{const{fromRange:t,toRange:n}=o.params||{};if(!n||!t)return[];const s=Ue(t),r=Ue(n),a=Ue(e),c=Wt({start:s.startRow,end:s.endRow},{start:r.startRow,end:r.endRow},{start:a.startRow,end:a.endRow});return c===null?[{type:L.Delete}]:[{type:L.VerticalMove,step:c.step||0,length:c.length||0}]},kc=(o,e)=>{const{fromRange:t,toRange:n}=o.params||{};if(!t||!n)return[e];const s=t.startRow,r=t.endRow-t.startRow+1,a=n.startRow,c=new i.ObjectMatrix;return i.Range.foreach(e,(u,d)=>{c.setValue(u,d,1)}),c.moveRows(s,r,a),i.queryObjectMatrix(c,u=>u===1)},Pc=(o,e)=>{const{range:t,order:n}=o.params||{};if(!t||!n)return[e];const s=new i.ObjectMatrix;i.Range.foreach(e,(c,l)=>{s.setValue(c,l,1)});const r=new i.ObjectMatrix;return i.Range.foreach(t,(c,l)=>{var u;if(Object.prototype.hasOwnProperty.call(n,c)){const d=n[c],m=(u=s.getValue(d,l))!=null?u:0;r.setValue(c,l,m)}}),r.forValue((c,l,u)=>{s.setValue(c,l,u)}),i.queryObjectMatrix(s,c=>c===1)},xo=(o,e)=>{const{fromRange:t,toRange:n}=o.params||{};if(!n||!t)return[];const s=Ue(t),r=Ue(n),a=Ue(e),c=Wt({start:s.startColumn,end:s.endColumn},{start:r.startColumn,end:r.endColumn},{start:a.startColumn,end:a.endColumn});return c===null?[{type:L.Delete}]:[{type:L.HorizontalMove,step:c.step||0,length:c.length||0}]},Nc=(o,e)=>{const{fromRange:t,toRange:n}=o.params||{};if(!t||!n)return[e];const s=t.startColumn,r=t.endColumn-t.startColumn+1,a=n.startColumn,c=new i.ObjectMatrix;return i.Range.foreach(e,(l,u)=>{c.setValue(l,u,1)}),c.moveColumns(s,r,a),i.queryObjectMatrix(c,l=>l===1)},_r=(o,e)=>{var r,a;const t=(r=o.params)==null?void 0:r.toRange,n=(a=o.params)==null?void 0:a.fromRange;if(!t||!n)return[];const s=[];if(i.Rectangle.contains(t,e)&&s.push({type:L.Delete}),i.Rectangle.contains(n,e)){s.push({type:L.Delete});const c=i.Rectangle.getRelativeRange(e,n),l=i.Rectangle.getPositionRange(c,t);return[{type:L.Set,range:l}]}return s},Oc=(o,e)=>{var m,h;const t=(m=o.params)==null?void 0:m.toRange,n=(h=o.params)==null?void 0:h.fromRange;if(!t||!n)return[e];if(!i.Rectangle.intersects(n,e)&&!i.Rectangle.intersects(t,e))return[e];if(i.Rectangle.contains(n,e)){const g=i.Rectangle.getRelativeRange(e,n);return[i.Rectangle.getPositionRange(g,t)]}const s=new i.ObjectMatrix;i.Range.foreach(e,(g,R)=>{s.setValue(g,R,1)});const r=new i.ObjectMatrix,a=i.Rectangle.getIntersects(n,e);a&&i.Range.foreach(a,(g,R)=>{s.getValue(g,R)&&(s.setValue(g,R,void 0),r.setValue(g,R,1))});const c=t.startColumn-n.startColumn,l=t.startRow-n.startRow,u={startColumn:t.startColumn-c,endColumn:t.endColumn-c,startRow:t.startRow-l,endRow:t.endRow-l};return u&&i.Range.foreach(u,(g,R)=>{var p;const C=g+l,f=R+c;s.setValue(C,f,(p=r.getValue(g,R))!=null?p:0)}),i.queryObjectMatrix(s,g=>g===1)},Xe=(o,e)=>{const t=Ue(o),n=Ue(e),s=a=>a.endColumn-a.startColumn+1,r=a=>a.endRow-a.startRow+1;if(t.startRow<=n.startRow&&t.endRow>=n.endRow){if(n.startColumn<t.startColumn&&n.endColumn>=t.startColumn&&n.endColumn<=t.endColumn||n.startColumn<t.startColumn&&n.endColumn>=t.endColumn){const a=i.Rectangle.getIntersects(n,t);if(a)return{step:0,length:-s(a)}}if(n.startColumn>=t.startColumn&&n.endColumn<=t.endColumn&&r(t)>=r(n))return null;if(n.startColumn>=t.startColumn&&n.startColumn<=t.endColumn&&n.endColumn>t.endColumn){const a=i.Rectangle.getIntersects(n,t);if(a){const c=-s(a);return{step:-(s(t)-s(a)),length:c}}}if(n.startColumn>t.endColumn)return{step:-s(t),length:0}}return{step:0,length:0}},Wo=(o,e)=>{var r;const t=(r=o.params)==null?void 0:r.range;if(!t)return[];const n=[],s=Xe(t,e);if(!s)n.push({type:L.Delete});else{const{step:a,length:c}=s;n.push({type:L.HorizontalMove,step:a,length:c})}return n},br=(o,e,t)=>{var a;const n=(a=o.params)==null?void 0:a.range;if(!n)return[];const s=[];if(t&&t.length>0){let c=n.startRow;for(let l=n.startRow;l<=n.endRow;l++){if(t.includes(l)){if(l===c){c=l+1;continue}r({...n,startRow:c,endRow:l-1}),c=l+1;continue}l===n.endRow&&r({...n,startRow:c,endRow:n.endRow})}}else r(n);function r(c){const l=Xe(de(c),de(e));if(!l)s.push({type:L.Delete});else{const{step:u,length:d}=l;s.push({type:L.VerticalMove,step:u,length:d})}}return s},Dc=(o,e)=>{const{range:t,order:n}=o.params||{};if(!t||!n)return[];if(i.Rectangle.contains(t,e)&&e.endRow===e.startRow){const s=[],r=e.startRow;for(const a in n)if(n[a]===r){const c=Number(a);return s.push({type:L.VerticalMove,step:c-r,length:0}),s}return[]}return[]},Ze=(o,e)=>{const t=Ue(o),n=Ue(e),s=r=>r.endColumn-r.startColumn+1;return t.startRow<=n.startRow&&t.endRow>=n.endRow?n.startColumn<t.startColumn&&n.endColumn>=t.startColumn&&n.endColumn<=t.endColumn||n.startColumn<t.startColumn&&n.endColumn>=t.endColumn?{step:0,length:s(t)}:n.startColumn>=t.startColumn&&n.endColumn<=t.endColumn||n.startColumn>=t.startColumn&&n.startColumn<=t.endColumn&&n.endColumn>t.endColumn||n.startColumn>=t.endColumn?{step:s(t),length:0}:{step:0,length:0}:{step:0,length:0}};function Ac(o,e,t){const n=[];if(i.Rectangle.contains(e,t)&&n.push({type:L.Delete}),i.Rectangle.contains(o,t)){n.push({type:L.Delete});const s=i.Rectangle.getRelativeRange(t,o),r=i.Rectangle.getPositionRange(s,e);return[{type:L.Set,range:r}]}return n}const Er=(o,e)=>{var c;const t=(c=o.params)==null?void 0:c.range;if(!t)return[];const n=[],s=Ze(de(t),de(e)),{step:r,length:a}=s;return n.push({type:L.VerticalMove,step:r,length:a}),n},Tr=(o,e)=>{var c;const t=(c=o.params)==null?void 0:c.range;if(!t)return[];const n=[],s=Ze(t,e),{step:r,length:a}=s;return n.push({type:L.HorizontalMove,step:r,length:a}),n},Ur=(o,e)=>{var c;const t=(c=o.params)==null?void 0:c.range;if(!t)return[];const n=[],s=Ze(de(t),de(e)),{step:r,length:a}=s;return n.push({type:L.VerticalMove,step:r,length:a}),n},xc=(o,e)=>{var l;const t=(l=o.params)==null?void 0:l.range;if(!t)return[e];const n=t.endRow-t.startRow+1,s={...t,startRow:t.startRow,endRow:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(e,s),a=i.Rectangle.getIntersects(s,e);if(!a)return[e];const c=new i.ObjectMatrix;return r.forEach(u=>{i.Range.foreach(u,(d,m)=>{c.setValue(d,m,1)})}),a&&i.Range.foreach(a,(u,d)=>{c.setValue(u+n,d,1)}),i.queryObjectMatrix(c,u=>u===1)},kr=(o,e)=>{var c;const t=(c=o.params)==null?void 0:c.range;if(!t)return[];const n=[],s=Ze(t,e),{step:r,length:a}=s;return n.push({type:L.HorizontalMove,step:r,length:a}),n},Wc=(o,e)=>{var l;const t=(l=o.params)==null?void 0:l.range;if(!t)return[e];const n=t.endColumn-t.startColumn+1,s={...t,startColumn:t.startColumn,endColumn:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(e,s),a=i.Rectangle.getIntersects(s,e);if(!a)return[e];const c=new i.ObjectMatrix;return r.forEach(u=>{i.Range.foreach(u,(d,m)=>{c.setValue(d,m,1)})}),a&&i.Range.foreach(a,(u,d)=>{c.setValue(u,d+n,1)}),i.queryObjectMatrix(c,u=>u===1)},Pr=(o,e)=>{var r;const t=(r=o.params)==null?void 0:r.range;if(!t)return[];const n=[],s=Xe(t,e);if(!s)n.push({type:L.Delete});else{const{step:a,length:c}=s;n.push({type:L.HorizontalMove,step:a,length:c})}return n},$c=(o,e)=>{var u;const t=(u=o.params)==null?void 0:u.range;if(!t)return[e];const n={startRow:t.startRow,endRow:t.endRow,startColumn:t.startColumn,endColumn:Number.POSITIVE_INFINITY},s=t.endColumn-t.startColumn+1,r=i.Rectangle.getIntersects(t,e),a=i.Rectangle.subtract(e,n),c=i.Rectangle.getIntersects(n,e);if(!r&&!c)return[e];const l=new i.ObjectMatrix;return c&&i.Range.foreach(c,(d,m)=>{l.setValue(d,m-s,1)}),r&&i.Range.foreach(r,(d,m)=>{l.setValue(d,m-s,0)}),a.forEach(d=>{i.Range.foreach(d,(m,h)=>{l.setValue(m,h,1)})}),i.queryObjectMatrix(l,d=>d===1)},Nr=(o,e)=>{var r;const t=(r=o.params)==null?void 0:r.range;if(!t)return[];const n=[],s=Xe(de(t),de(e));if(!s)n.push({type:L.Delete});else{const{step:a,length:c}=s;n.push({type:L.VerticalMove,step:a,length:c})}return n},Vc=(o,e)=>{var u;const t=(u=o.params)==null?void 0:u.range;if(!t)return[e];const n={...t,startRow:t.startRow,endRow:Number.POSITIVE_INFINITY},s=t.endRow-t.startRow+1,r=i.Rectangle.getIntersects(t,e),a=i.Rectangle.subtract(e,n),c=i.Rectangle.getIntersects(n,e);if(!r&&!c)return[e];const l=new i.ObjectMatrix;return c&&i.Range.foreach(c,(d,m)=>{l.setValue(d-s,m,1)}),r&&i.Range.foreach(r,(d,m)=>{l.setValue(d-s,m,0)}),a.forEach(d=>{i.Range.foreach(d,(m,h)=>{l.setValue(m,h,1)})}),i.queryObjectMatrix(l,d=>d===1)},Lc=(o,e)=>{var s;const t=(s=o.ranges)!=null?s:[o.range],n=new i.ObjectMatrix;return i.Range.foreach(e,(r,a)=>{n.setValue(r,a,1)}),t.forEach(r=>{const a=r.startRow,l=r.endRow-a+1;n.removeRows(a,l)}),i.queryObjectMatrix(n,r=>r===1)},Hc=(o,e)=>{const t=o.params,n=t.range.startRow,s=t.range.endRow-t.range.startRow+1;return e.startRow>=n?[{startRow:e.startRow+s,endRow:e.endRow+s,startColumn:e.startColumn,endColumn:e.endColumn}]:e.endRow<n?[e]:[{startRow:e.startRow,endRow:e.endRow+s,startColumn:e.startColumn,endColumn:e.endColumn}]},Bc=(o,e)=>{const t=o.params,n=t.range.startColumn,s=t.range.endColumn-t.range.startColumn+1;return e.startColumn>=n?[{startRow:e.startRow,endRow:e.endRow,startColumn:e.startColumn+s,endColumn:e.endColumn+s}]:e.endColumn<n?[e]:[{startRow:e.startRow,endRow:e.endRow,startColumn:e.startColumn,endColumn:e.endColumn+s}]},Qe=(o,e)=>{let t={...e};return o.forEach(n=>{switch(n.type){case L.Delete:{t=null;break}case L.HorizontalMove:{if(!t)return;t.startColumn+=n.step,t.endColumn+=n.step+(n.length||0);break}case L.VerticalMove:{if(!t)return;t.startRow+=n.step,t.endRow+=n.step+(n.length||0);break}case L.Set:{t=n.range;break}}}),t&&(t.endColumn<t.startColumn||t.endRow<t.startRow)?null:t},Gn=(o,e)=>{let t=[];switch(e.id){case D.DeleteRangeMoveLeftCommandId:{t=Pr(e,o);break}case D.DeleteRangeMoveUpCommandId:{t=Nr(e,o);break}case D.InsertColCommandId:{t=Tr(e,o);break}case D.InsertRangeMoveDownCommandId:{t=Ur(e,o);break}case D.InsertRangeMoveRightCommandId:{t=kr(e,o);break}case D.InsertRowCommandId:{t=Er(e,o);break}case D.MoveColsCommandId:{t=xo(e,o);break}case D.MoveRangeCommandId:{t=_r(e,o);break}case D.MoveRowsCommandId:{t=Ao(e,o);break}case D.RemoveColCommandId:{t=Wo(e,o);break}case D.RemoveRowCommandId:{t=br(e,o);break}case D.ReorderRangeCommandId:{t=Dc(e,o);break}}return Qe(t,o)},Fc=(o,e,t)=>[Fe.id,je.id].includes(e.id)||Dr(e,t).some(r=>i.Rectangle.intersects(r,o))?Gn(o,e):o,zn=(o,e)=>{let t=[];switch(e.id){case D.DeleteRangeMoveLeftCommandId:return $c(e,o);case D.DeleteRangeMoveUpCommandId:return Vc(e,o);case D.InsertRangeMoveDownCommandId:return xc(e,o);case D.InsertRangeMoveRightCommandId:return Wc(e,o);case D.InsertColCommandId:return Bc(e,o);case D.InsertRowCommandId:return Hc(e,o);case D.MoveColsCommandId:return Nc(e,o);case D.MoveRangeCommandId:return Oc(e,o);case D.MoveRowsCommandId:return kc(e,o);case D.ReorderRangeCommandId:return Pc(e,o);case D.RemoveColCommandId:{t=Wo(e,o);break}case D.RemoveRowCommandId:return Lc(e.params,o)}const n=Qe(t,o);return n?[n]:[]},jc=(o,e,t)=>[Fe.id,je.id,Je.id,Uo].includes(e.id)||Dr(e,t).some(r=>i.Rectangle.intersects(r,o))?zn(o,e):o;function Or(o,e){const{id:t,params:n}=e;let s={length:0,step:0,type:L.Unknown};switch(t){case nt.id:s.type=L.Delete;break;case ve.id:s=Wt({start:n.sourceRange.startRow,end:n.sourceRange.endRow},{start:n.targetRange.startRow,end:n.targetRange.endRow},{start:o.startRow,end:o.endRow}),s.type=L.VerticalMove;break;case we.id:s=Wt({start:n.sourceRange.startColumn,end:n.sourceRange.endColumn},{start:n.targetRange.startColumn,end:n.targetRange.endColumn},{start:o.startColumn,end:o.endColumn}),s.type=L.HorizontalMove;break;case ne.id:s=Xe(n.range,o),s?s.type=L.HorizontalMove:s={step:0,length:0,type:L.Delete};break;case le.id:s=Xe(de(n.range),de(o)),s?s.type=L.VerticalMove:s={step:0,length:0,type:L.Delete};break;case ae.id:s=Ze(de(n.range),de(o)),s.type=L.VerticalMove;break;case ce.id:s=Ze(n.range,o),s.type=L.HorizontalMove;break;case Be.id:{const r=n.fromRange||new i.ObjectMatrix(n.from).getRange(),a=n.toRange||new i.ObjectMatrix(n.to).getRange();s=Ac(r,a,o)}break}return s?Array.isArray(s)?Qe(s,o):Qe([s],o):o}function Dr(o,e){var n,s,r,a,c,l;const{selectionManagerService:t}=e;switch(o.id){case D.MoveColsCommandId:{const u=o.params;return[u.fromRange,{...u.toRange,startColumn:u.toRange.startColumn-.5,endColumn:u.toRange.endColumn-.5}]}case D.MoveRowsCommandId:{const u=o.params;return[u.fromRange,{...u.toRange,startRow:u.toRange.startRow-.5,endRow:u.toRange.startRow-.5}]}case D.MoveRangeCommandId:{const u=o;return[u.params.fromRange,u.params.toRange]}case D.InsertRowCommandId:{const d=o.params.range;return[{...d,startRow:d.startRow-.5,endRow:d.endRow-.5}]}case D.InsertColCommandId:{const d=o.params.range;return[{...d,startColumn:d.startColumn-.5,endColumn:d.endColumn-.5}]}case D.RemoveRowCommandId:return[o.params.range];case D.RemoveColCommandId:return[o.params.range];case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const d=((n=o.params)==null?void 0:n.range)||((r=(s=t.getCurrentSelections())==null?void 0:s.map(m=>m.range))==null?void 0:r[0]);return d?[d]:[]}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const d=((a=o.params)==null?void 0:a.range)||((l=(c=t.getCurrentSelections())==null?void 0:c.map(m=>m.range))==null?void 0:l[0]);return d?[d]:[]}case D.ReorderRangeCommandId:{const u=o,{range:d,order:m}=u.params,h=[];for(let g=d.startRow;g<=d.endRow;g++)g in m&&h.push({startRow:g,endRow:g,startColumn:d.startColumn,endColumn:d.endColumn});return h}}}function Gc(o){switch(o.id){case we.id:{const e=o.params;return[e.sourceRange,{...e.targetRange,startColumn:e.targetRange.startColumn-.5,endColumn:e.targetRange.startColumn-.5}]}case ve.id:{const e=o.params;return[e.sourceRange,{...e.targetRange,startRow:e.targetRange.startRow-.5,endRow:e.targetRange.startRow-.5}]}case Be.id:{const e=o.params;return[new i.ObjectMatrix(e.from.value).getRange(),new i.ObjectMatrix(e.to.value).getRange()]}case ce.id:{const t=o.params.range;return[{...t,startColumn:t.startColumn-.5,endColumn:t.startColumn-.5}]}case ae.id:{const t=o.params.range;return[{...t,startRow:t.startRow-.5,endRow:t.startRow-.5}]}case ne.id:return[o.params.range];case le.id:return[o.params.range]}}function zc(o,e){var s,r,a,c,l,u;const t=o.get(i.IUniverInstanceService),n=o.get(exports.SheetsSelectionsService);switch(e.id){case D.MoveColsCommandId:{const d=e.params,m=k(t,{unitId:d.unitId,subUnitId:d.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[d.fromRange,{...d.toRange,startColumn:d.fromRange.startColumn<d.toRange.startColumn?d.fromRange.endColumn+1:d.toRange.startColumn,endColumn:d.fromRange.startColumn<d.toRange.startColumn?d.toRange.endColumn-1:d.fromRange.startColumn-1}]}}case D.MoveRowsCommandId:{const d=e.params,m=k(t,{unitId:d.unitId,subUnitId:d.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[d.fromRange,{...d.toRange,startRow:d.fromRange.startRow<d.toRange.startRow?d.fromRange.endRow+1:d.toRange.startRow,endRow:d.fromRange.startRow<d.toRange.startRow?d.toRange.endRow-1:d.fromRange.startRow-1}]}}case D.MoveRangeCommandId:{const d=e.params,m=k(t);return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[d.fromRange,d.toRange]}}case D.InsertRowCommandId:{const d=e.params,m=d.range;return{unitId:d.unitId,subUnitId:d.subUnitId,ranges:[...m.startRow>0?[{...m,startRow:m.startRow-1,endRow:m.endRow-1}]:[],{...m,startRow:m.startRow,endRow:Number.MAX_SAFE_INTEGER}]}}case D.InsertColCommandId:{const d=e.params,m=d.range;return{unitId:d.unitId,subUnitId:d.subUnitId,ranges:[...m.startColumn>0?[{...m,startColumn:m.startColumn-1,endColumn:m.endColumn-1}]:[],{...m,startColumn:m.startColumn,endColumn:Number.MAX_SAFE_INTEGER}]}}case D.RemoveRowCommandId:{const m=e.params.range,h=k(t);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startRow:m.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}}case D.RemoveColCommandId:{const m=e.params.range,h=k(t);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}}case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const d=e,m=k(t),h=((s=d.params)==null?void 0:s.range)||((a=(r=n.getCurrentSelections())==null?void 0:r.map(g=>g.range))==null?void 0:a[0]);return h?{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[h,{...h,startRow:h.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}:{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[]}}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const m=((c=e.params)==null?void 0:c.range)||((u=(l=n.getCurrentSelections())==null?void 0:l.map(g=>g.range))==null?void 0:u[0]),h=k(t);return m?{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}:{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[]}}case D.ReorderRangeCommandId:{const d=e,{range:m,order:h}=d.params,g=[];for(let C=m.startRow;C<=m.endRow;C++)C in h&&g.push({startRow:C,endRow:C,startColumn:m.startColumn,endColumn:m.endColumn});const R=k(t);return{unitId:R.unitId,subUnitId:R.subUnitId,ranges:g}}}}var qc=Object.getOwnPropertyDescriptor,Yc=(o,e,t,n)=>{for(var s=n>1?void 0:n?qc(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Qt=(o,e)=>(t,n)=>e(t,n,o);const Kc=i.createInterceptorKey("MERGE_REDO"),Jc=i.createInterceptorKey("MERGE_UNDO"),ls=Math.floor(Number.MAX_SAFE_INTEGER/10);class Xc extends i.Disposable{constructor(e,t,n,s,r=!1){super(),this._unitId=e,this._subUnitId=t,this._range=n,this._callback=s,this._skipIntersects=r}onMutation(e){var s,r;if(((s=e.params)==null?void 0:s.unitId)!==this._unitId)return;if(e.id===Be.id){const a=e.params;if(a.from.subUnitId!==this._subUnitId||a.to.subUnitId!==this._subUnitId)return}else if(((r=e.params)==null?void 0:r.subUnitId)!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(e.id===nt.id)return;const a=Gc(e);if(a!=null&&a.some(c=>i.Rectangle.intersects(c,this._range)))return}const t=Or(this._range,e);if(t&&i.Rectangle.equals(t,this._range))return!1;const n=this._range;this._range=t,this._callback(n,t)}}exports.RefRangeService=class extends i.Disposable{constructor(t,n,s,r){super();S(this,"interceptor",new i.InterceptorManager({MERGE_REDO:Kc,MERGE_UNDO:Jc}));S(this,"_watchRanges",new Set);S(this,"_refRangeManagerMap",new Map);S(this,"_serializer",Zc());S(this,"_onRefRangeChange",()=>{this._sheetInterceptorService.interceptCommand({getMutations:t=>{const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet(),s=us(this._univerInstanceService),r=ds(this._univerInstanceService);if(!n||!s||!r)return{redos:[],undos:[],preRedos:[],preUndos:[]};const l=((()=>{switch(t.id){case D.MoveColsCommandId:{const g=t.params,R=Math.min(g.fromRange.startColumn,g.toRange.startColumn);return this._checkRange([{...g.fromRange,startColumn:R,endColumn:n.getColumnCount()-1}],s,r)}case D.MoveRowsCommandId:{const g=t.params,R=Math.min(g.fromRange.startRow,g.toRange.startRow);return this._checkRange([{...g.fromRange,startRow:R,endRow:n.getRowCount()-1}],s,r)}case D.MoveRangeCommandId:{const g=t;return this._checkRange([g.params.fromRange,g.params.toRange],s,r)}case D.InsertRowCommandId:{const C={startRow:t.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([C],s,r)}case D.InsertColCommandId:{const R=t.params.range.startColumn,C={startRow:0,endRow:n.getRowCount()-1,startColumn:R,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([C],s,r)}case D.RemoveRowCommandId:{const C={startRow:t.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([C],s,r)}case D.RemoveColCommandId:{const R=t.params.range.startColumn,C={startRow:0,endRow:n.getRowCount()-1,startColumn:R,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([C],s,r)}case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const R=t.params.range||ms(this._selectionManagerService)[0],C={startRow:R.startRow,startColumn:R.startColumn,endColumn:R.endColumn,endRow:ls};return this._checkRange([C],s,r)}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const R=t.params.range||ms(this._selectionManagerService)[0],C={startRow:R.startRow,startColumn:R.startColumn,endColumn:ls,endRow:R.endRow};return this._checkRange([C],s,r)}case D.ReorderRangeCommandId:{const g=t,{range:R,order:C}=g.params,f=[];for(let p=R.startRow;p<=R.endRow;p++)p in C&&f.push({startRow:p,endRow:p,startColumn:R.startColumn,endColumn:R.endColumn});return this._checkRange(f,s,r)}}})()||[]).reduce((g,R)=>{const C=R(t);return g.push(C),g},[]).reduce((g,R)=>{var C,f;return g.redos.push(...R.redos),g.undos.push(...R.undos),g.preRedos.push(...(C=R.preRedos)!=null?C:[]),g.preUndos.push(...(f=R.preUndos)!=null?f:[]),g},{redos:[],undos:[],preUndos:[],preRedos:[]}),u=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(l.preRedos,null)||[],d=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(l.redos,null)||[],m=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(l.preUndos,null)||[],h=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(l.undos,null)||[];return{redos:d,undos:h,preRedos:u,preUndos:m}}})});S(this,"_checkRange",(t,n,s)=>{const r=hs(n,s),a=this._refRangeManagerMap.get(r);if(a){const c=new Set;return[...a.keys()].forEach(u=>{const d=a.get(u),m=this._serializer.deserialize(u),h={...m,startRow:+m.startRow,endRow:+m.endRow,startColumn:+m.startColumn,endColumn:+m.endColumn,rangeType:m.rangeType&&+m.rangeType};t.some(g=>i.Rectangle.intersects(g,h))&&d&&d.forEach(g=>{c.add(g)})}),[...c]}return[]});S(this,"registerRefRange",(t,n,s,r)=>{const a=s||us(this._univerInstanceService),c=r||ds(this._univerInstanceService);if(!a||!c)return i.toDisposable(()=>{});const l=hs(a,c),u=this._serializer.serialize(t);let d=this._refRangeManagerMap.get(l);d||(d=new Map,this._refRangeManagerMap.set(l,d));const m=d.get(u);return m?m.add(n):d.set(u,new Set([n])),i.toDisposable(()=>{const h=d.get(u);h&&(h.delete(n),h.size||(d.delete(u),d.size||this._refRangeManagerMap.delete(l)))})});this._commandService=t,this._sheetInterceptorService=n,this._univerInstanceService=s,this._selectionManagerService=r,this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:a=>a}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:a=>a})}watchRange(t,n,s,r,a){let c;this._watchRanges.size===0&&(c=this._commandService.onCommandExecuted(m=>{if(m.type!==i.CommandType.MUTATION)return!1;for(const h of this._watchRanges)h.onMutation(m)}));const l=new Xc(t,n,s,r,a);this._watchRanges.add(l);const u=i.toDisposable(()=>{this._watchRanges.delete(l),this._watchRanges.size===0&&(c==null||c.dispose(),c=null)}),d=this.disposeWithMe(u);return i.toDisposable(()=>{d.dispose(),u.dispose()})}};exports.RefRangeService=Yc([Qt(0,i.ICommandService),Qt(1,i.Inject(exports.SheetInterceptorService)),Qt(2,i.Inject(i.IUniverInstanceService)),Qt(3,i.Inject(exports.SheetsSelectionsService))],exports.RefRangeService);function us(o){return o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()}function ds(o){var e;return(e=o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:e.getSheetId()}function ms(o){var e;return((e=o.getCurrentSelections())==null?void 0:e.map(t=>t.range))||[]}function hs(o,e){return`${o}_${e}`}function Zc(){const o=["startRow","startColumn","endRow","endColumn","rangeType"];return{deserialize:t=>{const n=o.reduce((r,a,c)=>(r[String(c)]=a,r),{});return t.split("_").reduce((r,a,c)=>{const l=String(c);return a&&n[l]&&(r[n[l]]=a),r},{})},serialize:t=>o.reduce((n,s,r)=>{const a=t[s];return a!==void 0?`${n}${r>0?"_":""}${a}`:`${n}`},"")}}var Qc=Object.getOwnPropertyDescriptor,el=(o,e,t,n)=>{for(var s=n>1?void 0:n?Qc(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},st=(o,e)=>(t,n)=>e(t,n,o);const tl=[ce.id,ae.id,ne.id,le.id],nl=[ve.id,we.id];function $o(o,e){let t=o;if(e!==void 0){const n=[];for(let s=0;s<t.length;s++){const{startRow:r,endRow:a,startColumn:c,endColumn:l}=t[s];if(e===i.Dimension.ROWS)for(let u=r;u<=a;u++){const d={startRow:u,endRow:u,startColumn:c,endColumn:l};n.push(d)}else if(e===i.Dimension.COLUMNS)for(let u=c;u<=l;u++){const d={startRow:r,endRow:a,startColumn:u,endColumn:u};n.push(d)}}t=n}return t}const Ar=i.createInterceptorKey("mergeCellPermissionCheck");exports.MergeCellController=class extends i.Disposable{constructor(t,n,s,r,a,c){super();S(this,"disposableCollection",new i.DisposableCollection);S(this,"interceptor",new i.InterceptorManager({MERGE_CELL_INTERCEPTOR_CHECK:Ar}));this._commandService=t,this._refRangeService=n,this._univerInstanceService=s,this._injector=r,this._sheetInterceptorService=a,this._selectionManagerService=c,this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){const t=this;this._sheetInterceptorService.interceptCommand({getMutations(n){var s;switch(n.id){case wn.id:case Mn.id:{const r=t._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=r.getUnitId(),c=r==null?void 0:r.getActiveSheet();if(!c)return{redos:[],undos:[]};const l=c.getSheetId(),u=c.getConfig().mergeData,d=(s=t._selectionManagerService.getCurrentSelections())==null?void 0:s.map(m=>m.range);if(d&&d.length>0&&d.some(h=>u.some(g=>i.Rectangle.intersects(g,h)))){const h={unitId:a,subUnitId:l,ranges:d},g=se(t._injector,h),R=[{id:F.id,params:h}],C=[{id:B.id,params:g}];return{redos:R,undos:C}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:({unitId:n,subUnitId:s,ranges:r})=>{const a=[],c=[],l={redos:a,undos:c};if(!r||!r.length)return l;const u=k(this._univerInstanceService,{unitId:n,subUnitId:s});if(!u)return l;const{worksheet:d}=u,h=d.getMergeData().filter(g=>r.some(R=>i.Rectangle.intersects(g,R)));return h.length?(a.push({id:F.id,params:{unitId:n,subUnitId:s,ranges:h}}),c.push({id:B.id,params:{unitId:n,subUnitId:s,ranges:h}}),{undos:c,redos:a}):l}})}refRangeHandle(t,n,s){switch(t.id){case D.MoveColsCommandId:{const r=t.params;return this._handleMoveColsCommand(r,n,s)}case D.MoveRowsCommandId:{const r=t.params;return this._handleMoveRowsCommand(r,n,s)}case Me.id:{const r=t.params,a=r.unitId||n,c=r.subUnitId||s;return this._handleInsertRowCommand(r,a,c)}case ye.id:{const r=t.params,a=r.unitId||n,c=r.subUnitId||s;return this._handleInsertColCommand(r,a,c)}case Yt.id:{const r=t.params;return this._handleRemoveColCommand(r,n,s)}case qt.id:{const r=t.params;return this._handleRemoveRowCommand(r,n,s)}case ze.id:{const r=t.params;return this._handleMoveRangeCommand(r,n,s)}case ft.id:{const r=t.params;return this._handleInsertRangeMoveRightCommand(r,n,s)}case Je.id:{const r=t.params;return this._handleInsertRangeMoveDownCommand(r,n,s)}case je.id:{const r=t.params;return this._handleDeleteRangeMoveUpCommand(r,n,s)}case Fe.id:{const r=t.params;return this._handleDeleteRangeMoveLeftCommand(r,n,s)}}return{redos:[],undos:[]}}_onRefRangeChange(){const t=(n,s)=>{const r=this._univerInstanceService.getUniverSheetInstance(n);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(s);if(!a)return;this.disposableCollection.dispose();const c=a.getMergeData(),l=u=>this.refRangeHandle(u,n,s);c.forEach(u=>{this.disposableCollection.add(this._refRangeService.registerRefRange(u,l,n,s))})};this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id===bt.id){const s=n.params,r=s.subUnitId,a=s.unitId;if(!r||!a)return;t(a,r)}if(n.id===B.id){const s=n.params,r=s.subUnitId,a=s.unitId;if(!r||!a)return;t(s.unitId,s.subUnitId)}})),this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.first(n=>!!n)).subscribe(n=>{const s=n.getActiveSheet();s&&t(n.getUnitId(),s.getSheetId())})}_handleMoveRowsCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=[...a.getMergeData()],l={unitId:n,subUnitId:s,ranges:[]},u={unitId:n,subUnitId:s,ranges:[]},{fromRange:d}=t,{startRow:m,endRow:h}=d;if(c.forEach(C=>{if(m<=C.startRow&&h>=C.endRow){l.ranges.push(C);const f=Ao({id:D.MoveRowsCommandId,params:t},C),p=Qe(f,C);p&&u.ranges.push(p)}}),l.ranges.length===0)return this._handleNull();const g=se(this._injector,l),R=he(this._injector,u);return{preRedos:[{id:F.id,params:l}],redos:[{id:B.id,params:u}],preUndos:[{id:F.id,params:R}],undos:[{id:B.id,params:g}]}}_handleMoveColsCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=[...a.getMergeData()],l={unitId:n,subUnitId:s,ranges:[]},u={unitId:n,subUnitId:s,ranges:[]},{fromRange:d}=t,{startColumn:m,endColumn:h}=d;if(c.forEach(C=>{if(m<=C.startColumn&&h>=C.endColumn){l.ranges.push(C);const f=xo({id:D.MoveColsCommandId,params:t},C),p=Qe(f,C);p&&u.ranges.push(p)}}),l.ranges.length===0)return this._handleNull();const g=se(this._injector,l),R=he(this._injector,u);return{preRedos:[{id:F.id,params:l}],redos:[{id:B.id,params:u}],preUndos:[{id:F.id,params:R}],undos:[{id:B.id,params:g}]}}_handleMoveRangeCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=a.getMergeData(),l=c.filter(R=>i.Rectangle.intersects(R,t.fromRange)),u=c.filter(R=>i.Rectangle.intersects(R,t.toRange)),d=l.map(R=>i.Rectangle.getRelativeRange(R,t.fromRange)).map(R=>i.Rectangle.getPositionRange(R,t.toRange)),m=$o(d).filter(R=>!c.some(C=>i.Rectangle.equals(R,C))),h=[{id:F.id,params:{unitId:n,subUnitId:s,ranges:l}},{id:F.id,params:{unitId:n,subUnitId:s,ranges:u}},{id:B.id,params:{unitId:n,subUnitId:s,ranges:m}}],g=[{id:F.id,params:{unitId:n,subUnitId:s,ranges:m}},{id:B.id,params:{unitId:n,subUnitId:s,ranges:u}},{id:B.id,params:{unitId:n,subUnitId:s,ranges:l}}];return{redos:h,undos:g}}_handleInsertRowCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const{range:c}=t,{startRow:l,endRow:u}=c,d=i.Tools.deepClone(a.getMergeData()).reduce((w,I)=>(l>I.startRow&&l<=I.endRow&&w.push(I),w),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((w,I)=>{if(l>I.startRow&&l<=I.endRow){const v=u-l+1;I.endRow+=v,this._checkIsMergeCell(I)&&w.push(I)}return w},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:F.id,params:h},{id:B.id,params:R}],p=[{id:F.id,params:C},{id:B.id,params:g}];return{redos:f,undos:p}}_handleInsertColCommand(t,n,s){const{range:r}=t,a=pe(this._univerInstanceService,n);if(!a)return this._handleNull();const c=Ie(a,s);if(!c)return this._handleNull();const{startColumn:l,endColumn:u}=r,d=i.Tools.deepClone(c.getMergeData()).reduce((w,I)=>(l>I.startColumn&&l<=I.endColumn&&w.push(I),w),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(c.getMergeData()).reduce((w,I)=>{if(l>I.startColumn&&l<=I.endColumn){const v=u-l+1;I.endColumn+=v,this._checkIsMergeCell(I)&&w.push(I)}return w},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:F.id,params:h},{id:B.id,params:R}],p=[{id:F.id,params:C},{id:B.id,params:g}];return{redos:f,undos:p}}_handleRemoveColCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const{range:c}=t,{startColumn:l,endColumn:u}=c,d=i.Tools.deepClone(a.getMergeData()).reduce((v,M)=>(i.Rectangle.intersects(c,M)&&v.push(M),v),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((v,M)=>{if(i.Rectangle.intersects(c,M)){if(l<=M.startColumn&&u>=M.endColumn)return v;l>=M.startColumn&&u<=M.endColumn?M.endColumn-=u-l+1:l<M.startColumn?(M.startColumn=l,M.endColumn-=u-l+1):u>M.endColumn&&(M.endColumn=l-1),this._checkIsMergeCell(M)&&v.push(M)}return v},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:F.id,params:h}],p=[{id:B.id,params:R}],w=[{id:F.id,params:C}],I=[{id:B.id,params:g}];return{preUndos:w,undos:I,preRedos:f,redos:p}}_handleRemoveRowCommand(t,n,s){const{range:r}=t,a=pe(this._univerInstanceService,n);if(!a)return this._handleNull();const c=Ie(a,s);if(!c)return this._handleNull();const{startRow:l,endRow:u}=r,d=i.Tools.deepClone(c.getMergeData()).reduce((v,M)=>(i.Rectangle.intersects(r,M)&&v.push(M),v),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(c.getMergeData()).reduce((v,M)=>{if(i.Rectangle.intersects(r,M)){if(l<=M.startRow&&u>=M.endRow)return v;l>=M.startRow&&u<=M.endRow?M.endRow-=u-l+1:l<M.startRow?(M.startRow=l,M.endRow-=u-l+1):u>M.endRow&&(M.endRow=l-1),this._checkIsMergeCell(M)&&v.push(M)}return v},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:F.id,params:h}],p=[{id:B.id,params:R}],w=[{id:F.id,params:C}],I=[{id:B.id,params:g}];return{preUndos:w,undos:I,preRedos:f,redos:p}}_handleInsertRangeMoveRightCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=t.range,l=a.getMaxColumns()-1,u=a.getMergeData(),d=[],m=[];u.forEach(f=>{const{startRow:p,endRow:w,startColumn:I,endColumn:v}=c;if(i.Rectangle.intersects({startRow:p,startColumn:I,endRow:w,endColumn:l},f)&&(d.push(f),i.Rectangle.contains({startRow:p,startColumn:I,endRow:w,endColumn:l},f))){const b=v-I+1;m.push({startRow:f.startRow,startColumn:f.startColumn+b,endRow:f.endRow,endColumn:f.endColumn+b})}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R);return{preRedos:[{id:F.id,params:h}],redos:[{id:B.id,params:R}],preUndos:[{id:F.id,params:C}],undos:[{id:B.id,params:g}]}}_handleInsertRangeMoveDownCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=t.range,l=a.getMaxRows()-1,u=a.getMergeData(),d=[],m=[];u.forEach(v=>{const{startRow:M,startColumn:_,endColumn:b,endRow:T}=c;if(i.Rectangle.intersects({startRow:M,startColumn:_,endRow:l,endColumn:b},v)&&(d.push(v),i.Rectangle.contains({startRow:M,startColumn:_,endRow:l,endColumn:b},v))){const P=T-M+1;m.push({startRow:v.startRow+P,startColumn:v.startColumn,endRow:v.endRow+P,endColumn:v.endColumn})}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:F.id,params:h}],p=[{id:B.id,params:R}],w=[{id:F.id,params:C}],I=[{id:B.id,params:g}];return{redos:p,undos:I,preRedos:f,preUndos:w}}_handleDeleteRangeMoveUpCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=t.range,l=a.getMaxRows()-1,u=a.getMergeData(),d=[],m=[];u.forEach(v=>{const{startRow:M,startColumn:_,endColumn:b,endRow:T}=c;if(i.Rectangle.intersects({startRow:M,startColumn:_,endRow:l,endColumn:b},v)&&(d.push(v),i.Rectangle.contains({startRow:M,startColumn:_,endRow:l,endColumn:b},v))){const P=T-M+1,A=i.Rectangle.moveVertical(v,-P);m.push(A)}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:F.id,params:h}],p=[{id:B.id,params:R}],w=[{id:F.id,params:C}],I=[{id:B.id,params:g}];return{redos:p,undos:I,preRedos:f,preUndos:w}}_handleDeleteRangeMoveLeftCommand(t,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=t.range,l=a.getMaxColumns()-1,u=a.getMergeData(),d=[],m=[];u.forEach(f=>{const{startRow:p,endRow:w,startColumn:I,endColumn:v}=c;if(i.Rectangle.intersects({startRow:p,startColumn:I,endRow:w,endColumn:l},f)&&(d.push(f),i.Rectangle.contains({startRow:p,startColumn:I,endRow:w,endColumn:l},f))){const b=v-I+1;m.push({startRow:f.startRow,startColumn:f.startColumn-b,endRow:f.endRow,endColumn:f.endColumn-b})}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R);return{preRedos:[{id:F.id,params:h}],redos:[{id:B.id,params:R}],undos:[{id:B.id,params:g}],preUndos:[{id:F.id,params:C}]}}_checkIsMergeCell(t){return!(t.startRow===t.endRow&&t.startColumn===t.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(nl.includes(t.id)){if(!t.params)return;const n=this._univerInstanceService.getUniverSheetInstance(t.params.unitId);if(!n)return;const s=n.getSheetBySheetId(t.params.subUnitId);if(!s)return;const{sourceRange:r,targetRange:a}=t.params,c=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,l=c?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,u=c?r.startRow:r.startColumn,d=c?a.startRow:a.startColumn,m=s.getConfig().mergeData,h=[];m.forEach(f=>{let{startRow:p,endRow:w,startColumn:I,endColumn:v,rangeType:M}=f;i.Rectangle.intersects(f,r)||(c?u<p&&d>w?(p-=l,w-=l):u>w&&d<=p&&(p+=l,w+=l):u<I&&d>v?(I-=l,v-=l):u>v&&d<=I&&(I+=l,v+=l)),f.startRow===f.endRow&&f.startColumn===f.endColumn||h.push({startRow:p,endRow:w,startColumn:I,endColumn:v,rangeType:M})}),s.setMergeData(h),this.disposableCollection.dispose();const{unitId:g,subUnitId:R}=t.params,C=f=>this.refRangeHandle(f,g,R);h.forEach(f=>{this.disposableCollection.add(this._refRangeService.registerRefRange(f,C,g,R))})}if(tl.includes(t.id)){const n=this._univerInstanceService.getUniverSheetInstance(t.params.unitId);if(!n)return;const s=n.getSheetBySheetId(t.params.subUnitId);if(!s)return;const r=s.getConfig().mergeData,a=t.params;if(!a)return;const{range:c}=a,l=t.id.includes("row"),u=t.id.includes("insert"),d=l?c.startRow:c.startColumn,m=l?c.endRow:c.endColumn,h=m-d+1,g=[];r.forEach(p=>{let{startRow:w,endRow:I,startColumn:v,endColumn:M,rangeType:_}=p;u?l?d<=w&&(w+=h,I+=h):d<=v&&(v+=h,M+=h):l?m<w&&(w-=h,I-=h):m<v&&(v-=h,M-=h),p.startRow===p.endRow&&p.startColumn===p.endColumn||g.push({startRow:w,endRow:I,startColumn:v,endColumn:M,rangeType:_})}),s.setMergeData(g),this.disposableCollection.dispose();const{unitId:R,subUnitId:C}=t.params,f=p=>this.refRangeHandle(p,R,C);g.forEach(p=>{this.disposableCollection.add(this._refRangeService.registerRefRange(p,f,R,C))})}}))}};exports.MergeCellController=el([st(0,i.Inject(i.ICommandService)),st(1,i.Inject(exports.RefRangeService)),st(2,i.Inject(i.IUniverInstanceService)),st(3,i.Inject(i.Injector)),st(4,i.Inject(exports.SheetInterceptorService)),st(5,i.Inject(exports.SheetsSelectionsService))],exports.MergeCellController);function pe(o,e){return e?o.getUniverSheetInstance(e):o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET)}function Ie(o,e){return e?o.getSheetBySheetId(e):o.getActiveSheet()}function ol(o,e){return e.some(t=>sl(o,t))}function sl(o,e){const{startRow:t,startColumn:n,endColumn:s,endRow:r}=e,a=o.getMatrixWithMergedCells(t,n,r,s);let c=!1;return a.forValue((l,u,d)=>{if(d&&(l!==t||u!==n)&&o.cellHasValue(d))return c=!0,!1}),c}function rl(o,e,t,n){const s=[],r=[],a=t.getSheetId();return n.forEach(c=>{const l=il(t,c),u={unitId:e,subUnitId:a,cellValue:l.getData()},d=me(o,u);s.push({id:H.id,params:d}),r.push({id:H.id,params:u})}),{undos:s,redos:r}}function il(o,e){const{startRow:t,startColumn:n,endColumn:s,endRow:r}=e,a=o.getMatrixWithMergedCells(t,n,r,s,i.CellModeEnum.Raw),c=new i.ObjectMatrix;return a.forValue((l,u,d)=>{d&&(l!==t||u!==n)&&c.setValue(l,u,null)}),c}const Jt={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=e.unitId,a=e.subUnitId,c=e.selections,l=$o(c,e.value),u=s.getUniverSheetInstance(r).getSheetBySheetId(a),d=[],m=[],h=ol(u,l),g={unitId:r,subUnitId:a,ranges:l},R={unitId:r,subUnitId:a,ranges:l};d.push({id:F.id,params:g}),d.push({id:B.id,params:R});const C=se(o,g),f=he(o,R);if(m.push({id:F.id,params:f}),m.push({id:B.id,params:C}),h){const w=rl(o,r,u,l);d.unshift(...w.redos),m.push(...w.undos)}return i.sequenceExecute(d,t).result?(n.pushUndoRedo({unitID:r,undoMutations:m,redoMutations:d}),!0):!1}},al={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:async o=>{var u;const e=o.get(i.ICommandService),n=(u=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:u.map(d=>d.range);if(!(n!=null&&n.length))return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const c=r.getUnitId(),l=a.getSheetId();return e.executeCommand(Jt.id,{selections:n,unitId:c,subUnitId:l})}},cl={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:async o=>{var u;const e=o.get(i.ICommandService),n=(u=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:u.map(d=>d.range);if(!(n!=null&&n.length))return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const c=r.getUnitId(),l=a.getSheetId();return e.executeCommand(Jt.id,{value:i.Dimension.COLUMNS,selections:n,unitId:c,subUnitId:l})}},ll={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:async o=>{var u;const e=o.get(i.ICommandService),n=(u=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:u.map(d=>d.range);if(!(n!=null&&n.length))return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const c=r.getUnitId(),l=a.getSheetId();return e.executeCommand(Jt.id,{value:i.Dimension.ROWS,selections:n,unitId:c,subUnitId:l})}};function ul(o,e,t,n,s){const r=o.get(i.IUniverInstanceService),a=k(r,{unitId:e,subUnitId:t});if(!a)return;const{worksheet:c}=a;if(c.getMergeData().some(m=>n.some(h=>i.Rectangle.intersects(h,m))))throw new Error("The ranges to be merged overlap with the existing merged cells");o.get(i.ICommandService).executeCommand(Jt.id,{unitId:e,subUnitId:t,selections:n,defaultMerge:s})}class Oe{constructor(){S(this,"_model",new Map);S(this,"_ruleChange",new O.Subject);S(this,"_ruleRefresh",new O.Subject);S(this,"_resetOrder",new O.Subject);S(this,"ruleChange$",this._ruleChange.asObservable());S(this,"ruleRefresh$",this._ruleRefresh.asObservable());S(this,"resetOrder$",this._resetOrder.asObservable());S(this,"_worksheetRuleInitStateChange",new O.BehaviorSubject(!1));S(this,"worksheetRuleInitStateChange$",this._worksheetRuleInitStateChange.asObservable())}changeRuleInitState(e){this._worksheetRuleInitStateChange.next(e)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(e,t){this._ensureSubUnitMap(e).set(t.subUnitId,t),this._ruleChange.next({unitId:e,rule:t,type:"add",subUnitId:t.subUnitId})}deleteRule(e,t){var s,r,a;const n=(r=(s=this._model)==null?void 0:s.get(e))==null?void 0:r.get(t);n&&((a=this._model.get(e))==null||a.delete(t),this._ruleChange.next({unitId:e,rule:n,type:"delete",subUnitId:t}))}setRule(e,t,n){var r,a;const s=this.getRule(e,t);s&&((a=(r=this._model)==null?void 0:r.get(e))==null||a.set(t,n),this._ruleChange.next({unitId:e,oldRule:s,rule:n,type:"set",subUnitId:t}))}getRule(e,t){var n,s;return(s=(n=this._model)==null?void 0:n.get(e))==null?void 0:s.get(t)}toObject(){const e={};return[...this._model.keys()].forEach(n=>{const s=this._model.get(n);s!=null&&s.size&&(e[n]=[],[...s.keys()].forEach(a=>{const c=s.get(a);c&&e[n].push(c)}))}),e}fromObject(e){const t=new Map;Object.keys(e).forEach(n=>{const s=e[n];if(s!=null&&s.length){const r=new Map;s.forEach(a=>{r.set(a.subUnitId,a)}),t.set(n,r)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=new Map,this._model.set(e,t)),t}ruleRefresh(e){this._ruleRefresh.next(e)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(e,t){const n=this._model.get(e);if(!n)return null;for(const[s,r]of n)if(r.permissionId===t)return[e,s]}}const Ge={id:"sheet.mutation.add-worksheet-protection",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(Oe),{unitId:n,rule:s}=e;return t.addRule(n,s),!0}},et={id:"sheet.mutation.delete-worksheet-protection",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(Oe),{unitId:n,subUnitId:s}=e;return t.deleteRule(n,s),!0}},xr={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-protection",async handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{rule:s,unitId:r}=e,a=s.subUnitId;if(await t.executeCommand(Ge.id,{unitId:r,rule:s,subUnitId:s.subUnitId})){const l=[{id:Ge.id,params:{unitId:r,rule:s,subUnitId:s.subUnitId}}],u=[{id:et.id,params:{unitId:r,subUnitId:a}}];n.pushUndoRedo({unitID:r,redoMutations:l,undoMutations:u})}return!0}},Wr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-range-theme-style",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s}=e,r=_s(o,e);return t.syncExecuteCommand(gt.id,e)?(n.pushUndoRedo({unitID:s,undoMutations:[{id:Rt.id,params:r}],redoMutations:[{id:gt.id,params:e}]}),!0):!1}},dl="sheet.command.append-row",$r={type:i.CommandType.COMMAND,id:dl,handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s,subUnitId:r,cellValue:a,insertRowNums:c,insertColumnNums:l,maxRows:u,maxColumns:d}=e,m={unitId:s,subUnitId:r,cellValue:a},h=me(o,m),g=[{id:H.id,params:m}],R=[{id:H.id,params:h}];if(c){const f={unitId:s,subUnitId:r,range:{startRow:u,endRow:u,startColumn:0,endColumn:d-1}},p=In(o,f);g.unshift({id:ae.id,params:f}),R.push({id:le.id,params:p})}if(l){const f={unitId:s,subUnitId:r,range:{startRow:0,endRow:u-1,startColumn:d,endColumn:d-1+l}},p=Ft(o,f);g.unshift({id:ce.id,params:f}),R.push({id:ne.id,params:p})}return i.sequenceExecute(g,t).result?(n.pushUndoRedo({unitID:s,undoMutations:R,redoMutations:g}),!0):!1}},kn={id:"sheet.command.clear-selection-content",type:i.CommandType.COMMAND,handler:(o,e)=>{var I;const t=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUndoRedoService),a=o.get(exports.SheetInterceptorService),c=t.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!c)return!1;const l=(e==null?void 0:e.unitId)||c.getUnitId(),u=c.getActiveSheet();if(!u)return!1;const d=(e==null?void 0:e.subUnitId)||u.getSheetId(),m=(e==null?void 0:e.ranges)||((I=s.getCurrentSelections())==null?void 0:I.map(v=>v.range));if(!(m!=null&&m.length))return!1;const h=jt(m,o,l,d),g={subUnitId:d,unitId:l,cellValue:js(h)},R=me(o,g),C=a.onCommandExecute({id:kn.id}),f=[{id:H.id,params:g},...C.redos],p=[...C.undos,{id:H.id,params:R}];return i.sequenceExecute(f,n).result?(r.pushUndoRedo({unitID:l,undoMutations:p,redoMutations:f}),!0):!1}},Xt="sheets.config",Vo={largeSheetCellCountThreshold:6e3,batchSize:3e3},gs={};var ml=Object.getOwnPropertyDescriptor,hl=(o,e,t,n)=>{for(var s=n>1?void 0:n?ml(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Rs=(o,e)=>(t,n)=>e(t,n,o);exports.SheetLazyExecuteScheduleService=class extends i.Disposable{constructor(t,n){super();S(this,"_tasks",new Map);S(this,"_idleCallbackId",null);S(this,"_beforeUnloadHandler",null);this._commandService=t,this._univerInstanceService=n,this._setupBeforeUnloadListener(),this.disposeWithMe(()=>{this._cancelAllTasks(),this._removeBeforeUnloadListener()})}hasPendingTasks(){return this._tasks.size>0}getPendingMutationsCount(){let t=0;for(const n of this._tasks.values())t+=n.mutations.length-n.currentIndex;return t}scheduleMutations(t,n,s){if(s.length===0)return;const r=`${t}_${n}`;this._cancelTask(r),this._tasks.set(r,{unitId:t,subUnitId:n,mutations:s,currentIndex:0}),this._scheduleNextIdle()}cancelScheduledMutations(t,n){const s=`${t}_${n}`;this._cancelTask(s)}_cancelTask(t){this._tasks.delete(t),this._tasks.size===0&&this._idleCallbackId!==null&&(typeof cancelIdleCallback<"u"&&cancelIdleCallback(this._idleCallbackId),this._idleCallbackId=null)}_cancelAllTasks(){this._tasks.clear(),this._idleCallbackId!==null&&(typeof cancelIdleCallback<"u"&&cancelIdleCallback(this._idleCallbackId),this._idleCallbackId=null)}_scheduleNextIdle(){this._idleCallbackId===null&&(typeof requestIdleCallback<"u"?this._idleCallbackId=requestIdleCallback(t=>this._processIdleTasks(t),{timeout:1e3*60}):this._idleCallbackId=setTimeout(()=>{this._processIdleTasks({didTimeout:!1,timeRemaining:()=>16})},16))}_processIdleTasks(t){this._idleCallbackId=null;for(const[n,s]of this._tasks){if(!this._isSheetExist(s.unitId,s.subUnitId)){this._tasks.delete(n);continue}for(s.currentIndex;s.currentIndex<s.mutations.length;){if(t.timeRemaining()<=0&&!t.didTimeout){this._scheduleNextIdle();return}const r=s.mutations[s.currentIndex];this._commandService.syncExecuteCommand(r.id,r.params,{onlyLocal:!0}),s.currentIndex++}this._tasks.delete(n)}this._tasks.size>0&&this._scheduleNextIdle()}_isSheetExist(t,n){const s=this._univerInstanceService.getUnit(t,i.UniverInstanceType.UNIVER_SHEET);return s?s.getSheetBySheetId(n)!==null:!1}_setupBeforeUnloadListener(){typeof window>"u"||(this._beforeUnloadHandler=t=>{if(this.hasPendingTasks())return t.preventDefault(),t.returnValue="",""},window.addEventListener("beforeunload",this._beforeUnloadHandler))}_removeBeforeUnloadListener(){typeof window>"u"||!this._beforeUnloadHandler||(window.removeEventListener("beforeunload",this._beforeUnloadHandler),this._beforeUnloadHandler=null)}};exports.SheetLazyExecuteScheduleService=hl([Rs(0,i.ICommandService),Rs(1,i.IUniverInstanceService)],exports.SheetLazyExecuteScheduleService);const Lo={id:"sheet.mutation.copy-worksheet-end",type:i.CommandType.MUTATION,handler:()=>!0},Ho=(o,e)=>({subUnitId:e.sheet.id,unitId:e.unitId,subUnitName:e.sheet.name}),vt={id:"sheet.mutation.insert-sheet",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService),{sheet:n,index:s,unitId:r,styles:a}=e,c=t.getUniverSheetInstance(r);return c?(a&&c.addStyles(a),c.addWorksheet(n.id,s,n)):!1}};function gl(o){let e=0;for(const t of Object.keys(o)){const n=o[Number(t)];n&&(e+=Object.keys(n).length)}return e}function Rl(o,e,t,n){const s=[];let r={},a=0;for(const u in t){const d=Number(u),m=t[d];if(!m)continue;const h=Object.keys(m).length;a>0&&a+h>n&&(s.push(r),r={},a=0),r[d]=m,a+=h,a>=n&&(s.push(r),r={},a=0)}a>0&&s.push(r);const c=s.length>0?s[0]:{},l=s.slice(1).map(u=>({id:H.id,params:{unitId:o,subUnitId:e,cellValue:u,__splitChunk__:!0}}));return{firstChunkCellData:c,remainingMutations:l}}const Vr="sheet.command.copy-sheet";function Cl(o,e,t,n,s,r,a){var _,b;const l=o.get(i.IConfigService).getConfig(Xt),u={...Vo,...l==null?void 0:l.largeSheetOperation},d=i.cloneWorksheetData(t.getConfig());d.name=Sl(e,r,d.name);const m=i.generateRandomId();d.id=m;const h=e.getSheetIndex(t),{cellData:g}=d,C=gl(g)>=u.largeSheetCellCountThreshold;let f,p=[];if(C){const{firstChunkCellData:T,remainingMutations:U}=Rl(n,m,g,u.batchSize),E={...d,cellData:T};f={index:h+1,sheet:E,unitId:n},p=U}else f={index:h+1,sheet:d,unitId:n};const w=Ho(o,f),I=a.onCommandExecute({id:Vr,params:{unitId:n,subUnitId:s,targetSubUnitId:d.id}}),v=[...(_=I.preRedos)!=null?_:[],{id:vt.id,params:f},...I.redos],M=[...(b=I.preUndos)!=null?b:[],{id:nt.id,params:w},...I.undos];return{redos:v,undos:M,unitId:n,newSheetId:m,isSplit:C,scheduledMutations:p}}const Lr={type:i.CommandType.COMMAND,id:Vr,handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),a=o.get(i.LocaleService),c=o.get(exports.SheetLazyExecuteScheduleService),l=k(s,e);if(!l)return!1;const{workbook:u,worksheet:d,unitId:m,subUnitId:h}=l,{redos:g,undos:R,newSheetId:C,isSplit:f,scheduledMutations:p}=Cl(o,u,d,m,h,a,r);if(i.sequenceExecute(g,t).result){if(f){if(n.pushUndoRedo({unitID:m,undoMutations:R,redoMutations:[]}),p.length>0){for(const I of p)t.syncExecuteCommand(I.id,I.params,{syncOnly:!0});t.syncExecuteCommand(Lo.id,{unitId:m,subUnitId:C},{syncOnly:!0}),c.scheduleMutations(m,C,p)}}else n.pushUndoRedo({unitID:m,undoMutations:R,redoMutations:g});return!0}return!1}};function Sl(o,e,t){let n=`${t} ${e.t("sheets.tabs.sheetCopy","")}`,s=2;for(;o.checkSheetName(n);)n=`${t} ${e.t("sheets.tabs.sheetCopy",`${s}`)}`,s++;return n}const Hr={type:i.CommandType.COMMAND,id:"sheet.command.delete-range-protection",async handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s,subUnitId:r,rule:a}=e,c={unitId:s,subUnitId:r,ruleIds:[a.id]};return await t.executeCommand(Pe.id,c)&&n.pushUndoRedo({unitID:s,redoMutations:[{id:Pe.id,params:c}],undoMutations:[{id:fe.id,params:{unitId:s,subUnitId:r,rules:[a]}}]}),!0}},Br={type:i.CommandType.COMMAND,id:"sheet.command.delete-worksheet-protection",handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{rule:s,unitId:r,subUnitId:a}=e;t.executeCommand(et.id,{unitId:r,subUnitId:a});const c=[{id:et.id,params:{unitId:r,subUnitId:a}}],l=[{id:Ge.id,params:{unitId:r,rule:s,subUnitId:a}}];return n.pushUndoRedo({unitID:r,redoMutations:c,undoMutations:l}),!0}},Fr={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-range-theme-style",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s}=e,r=bs(o,e);return t.syncExecuteCommand(Rt.id,e)?(n.pushUndoRedo({unitID:s,undoMutations:[{id:gt.id,params:r}],redoMutations:[{id:Rt.id,params:e}]}),!0):!1}},jr={id:"sheet.command.insert-defined-name",type:i.CommandType.COMMAND,handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService);if(!e)return!1;const s={...e};return t.syncExecuteCommand(Y.SetDefinedNameMutation.id,s)?(n.pushUndoRedo({unitID:e.unitId,undoMutations:[{id:Y.RemoveDefinedNameMutation.id,params:s}],redoMutations:[{id:Y.SetDefinedNameMutation.id,params:s}]}),!0):!1}},Gr={id:"sheet.command.insert-sheet",type:i.CommandType.COMMAND,handler:(o,e)=>{var f;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(i.LocaleService),a=Yn(s,{unitId:e==null?void 0:e.unitId});if(!a)return!1;const{unitId:c,workbook:l}=a;let u=l.getSheets().length;const d=e==null?void 0:e.sheet,m=d==null?void 0:d.id,h=i.mergeWorksheetSnapshotWithDefault(d||{});e?(u=(f=e.index)!=null?f:u,h.id=m||i.generateRandomId(),h.name=(d==null?void 0:d.name)||l.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`)):(h.id=i.generateRandomId(),h.name=l.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`));const g={index:u,sheet:h,unitId:c},R=Ho(o,g);return t.syncExecuteCommand(vt.id,g)?(n.pushUndoRedo({unitID:c,undoMutations:[{id:nt.id,params:R}],redoMutations:[{id:vt.id,params:g}]}),!0):!1}},wt={id:"sheet.mutation.register-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,rangeThemeStyleJson:n,themeName:s}=e,r=o.get(i.IUniverInstanceService),a=k(r),c=o.get(exports.SheetRangeThemeModel);if(!a)return!1;const l=new xe(s,n);return c.registerRangeThemeStyle(t,l),!0}},Pn={id:"sheet.mutation.unregister-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,themeName:n}=e,s=o.get(i.IUniverInstanceService),r=k(s),a=o.get(exports.SheetRangeThemeModel);return r?(a.unregisterRangeThemeStyle(t,n),!0):!1}},zr={id:"sheet.command.register-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(o,e)=>{if(!e)return!1;const{unitId:t,rangeThemeStyle:n}=e,s=o.get(i.IUniverInstanceService),r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService);if(!k(s))return!1;const l={unitId:t,themeName:n.getName(),rangeThemeStyleJson:n.toJson()},u={unitId:t,themeName:n.getName()};return r.syncExecuteCommand(wt.id,l)&&a.pushUndoRedo({unitID:t,undoMutations:[{id:Pn.id,params:u}],redoMutations:[{id:wt.id,params:l}]}),!0}},Bo={id:"sheet.command.remove-defined-name",type:i.CommandType.COMMAND,handler:(o,e)=>{var d,m;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetInterceptorService);if(!e)return!1;const r={...e},a=s.onCommandExecute({id:Bo.id,params:e}),c=[...(d=a.preRedos)!=null?d:[],{id:Y.RemoveDefinedNameMutation.id,params:r},...a.redos],l=[...(m=a.preUndos)!=null?m:[],{id:Y.SetDefinedNameMutation.id,params:r},...a.undos];return i.sequenceExecute(c,t)?(n.pushUndoRedo({unitID:e.unitId,undoMutations:l.filter(Boolean),redoMutations:c.filter(Boolean)}),!0):!1}},Nn={id:"sheet.command.remove-sheet",type:i.CommandType.COMMAND,handler:(o,e)=>{var _,b;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),a=o.get(i.IConfigService),c=k(s,e);if(!c)return!1;const{unitId:l,subUnitId:u,workbook:d,worksheet:m}=c;if(d.getSheets().length<=1)return!1;const h=a.getConfig(Xt),g={...Vo,...h==null?void 0:h.largeSheetOperation},C=Mr(m.getCellMatrix())>=g.largeSheetCellCountThreshold,f={subUnitId:u,unitId:l,subUnitName:m.getName()},p=C?null:pr(o,f),w=r.onCommandExecute({id:Nn.id,params:{unitId:l,subUnitId:u}}),I=[...(_=w.preRedos)!=null?_:[],{id:nt.id,params:f},...w.redos],v=C?[]:[...(b=w.preUndos)!=null?b:[],{id:vt.id,params:p},...w.undos];return i.sequenceExecute(I,t).result?(C?n.clearUndoRedo(l):n.pushUndoRedo({unitID:l,undoMutations:v,redoMutations:I}),!0):!1}},qr={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:(o,e)=>{var P;const t=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(i.IUniverInstanceService),a=(e==null?void 0:e.ranges)||((P=t.getCurrentSelections())==null?void 0:P.map(A=>A.range));if(!(a!=null&&a.length))return!1;const c=k(r);if(!c)return!1;const{subUnitId:l,unitId:u,worksheet:d}=c,m={unitId:u,subUnitId:l,ranges:a},g=d.getConfig().mergeData.filter(A=>a.some(x=>i.Rectangle.intersects(x,A)));if(!g.length)return!1;const R=se(o,m),C=t.getCurrentSelections();if(!(C!=null&&C.length))return!1;const f=i.Tools.deepClone(C),p=i.Tools.deepClone(C),w=p[p.length-1],{startRow:I,startColumn:v}=w.range;w.primary={startRow:I,startColumn:v,endRow:I,endColumn:v,actualRow:I,actualColumn:v,isMerged:!1,isMergedMainCell:!1};const M=fl(d,g),_={unitId:u,subUnitId:l,cellValue:M.redoParams.getMatrix()},b={unitId:u,subUnitId:l,cellValue:M.undoParams.getMatrix()},T=[{id:F.id,params:R},{id:H.id,params:_},{id:G.id,params:{selections:p}}],U=[{id:B.id,params:R},{id:H.id,params:b},{id:G.id,params:{selections:f}}];return i.sequenceExecute(T,n)?(s.pushUndoRedo({unitID:u,undoMutations:U,redoMutations:T}),!0):!1}};function fl(o,e){const t=new i.ObjectMatrix,n=new i.ObjectMatrix;return e.forEach(s=>{const{startRow:r,startColumn:a,endColumn:c,endRow:l}=s,u=o.getCellMatrix().getValue(r,a);if(u!=null&&u.s)for(let d=r;d<=l;d++)for(let m=a;m<=c;m++)(d!==r||m!==a)&&(t.setValue(d,m,{s:u.s}),n.setValue(d,m,null))}),{redoParams:t,undoParams:n}}class ot{constructor(){S(this,"_borderInfo",{type:i.BorderType.ALL,color:"#000000",style:i.BorderStyleTypes.THIN,activeBorderType:!1});S(this,"_borderInfo$",new O.BehaviorSubject(this._borderInfo));S(this,"borderInfo$",this._borderInfo$.asObservable())}dispose(){this._borderInfo$.complete()}setType(e){this._borderInfo.type=e,this.setActiveBorderType(!0),this._refresh()}setColor(e){this._borderInfo.color=e,this._refresh()}setStyle(e){this._borderInfo.style=e,this._refresh()}setActiveBorderType(e){this._borderInfo.activeBorderType=e}getBorderInfo(){return this._borderInfo}_refresh(){this._borderInfo$.next(this._borderInfo)}}function mn(o,e){const{startRow:t,startColumn:n,endRow:s,endColumn:r}=o;for(let a=t;a<=s;a++)for(let c=n;c<=r;c++)e(a,c)}const Fo=(o,e,t,n)=>{const{mr:s,worksheet:r}=o;e.startRow<0||e.startColumn<0||mn(e,(a,c)=>{var d,m;const l=r.getMergedCell(a,c);let u=t;if(l&&(t.bc_tr||t.ml_tr||t.bl_tr||t.tl_mr||t.tl_bc||t.tl_br)){if(n){const h=i.Tools.deepClone((d=s.getValue(l.startRow,l.startColumn))==null?void 0:d.s);u=h!=null&&h.bd?Object.assign(h.bd,t):t}s.setValue(l.startRow,l.startColumn,{s:{bd:u}})}else{if(n){const h=i.Tools.deepClone((m=s.getValue(a,c))==null?void 0:m.s);u=h!=null&&h.bd?Object.assign(h.bd,t):t}s.setValue(a,c,{s:{bd:u}})}})},pl=o=>{const e={startRow:o.startRow-1,startColumn:o.startColumn,endRow:o.startRow-1,endColumn:o.endColumn},t={startRow:o.startRow,startColumn:o.startColumn-1,endRow:o.endRow,endColumn:o.startColumn-1},n={startRow:o.endRow+1,startColumn:o.startColumn,endRow:o.endRow+1,endColumn:o.endColumn},s={startRow:o.startRow,startColumn:o.endColumn+1,endRow:o.endRow,endColumn:o.endColumn+1},r={startRow:o.startRow,startColumn:o.startColumn,endRow:o.startRow,endColumn:o.endColumn},a={startRow:o.startRow,startColumn:o.startColumn,endRow:o.endRow,endColumn:o.startColumn},c={startRow:o.endRow,startColumn:o.startColumn,endRow:o.endRow,endColumn:o.endColumn},l={startRow:o.startRow,startColumn:o.endColumn,endRow:o.endRow,endColumn:o.endColumn};return{topRangeOut:e,leftRangeOut:t,bottomRangeOut:n,rightRangeOut:s,topRange:r,leftRange:a,bottomRange:c,rightRange:l}};function Il(o,e,t){const{style:n,color:s,type:r}=o.getBorderInfo(),a=r===i.BorderType.TOP||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,c=r===i.BorderType.LEFT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,l=r===i.BorderType.BOTTOM||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,u=r===i.BorderType.RIGHT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,d=r===i.BorderType.VERTICAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,m=r===i.BorderType.HORIZONTAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,h=r.indexOf("tlbr")>-1,g=r.indexOf("tlbc")>-1,R=r.indexOf("tlmr")>-1,C=r.indexOf("bltr")>-1,f=r.indexOf("mltr")>-1,p=r.indexOf("bctr")>-1,w=t[0],{topRangeOut:I,leftRangeOut:v,bottomRangeOut:M,rightRangeOut:_,topRange:b,leftRange:T,bottomRange:U,rightRange:E}=pl(w),P=new i.ObjectMatrix,{worksheet:A,unitId:x,subUnitId:W}=e;return{worksheet:A,unitId:x,subUnitId:W,style:n,color:s,type:r,top:a,left:c,right:u,bottom:l,vertical:d,horizontal:m,tl_br:h,tl_bc:g,tl_mr:R,bl_tr:C,ml_tr:f,bc_tr:p,topRangeOut:I,leftRangeOut:v,bottomRangeOut:M,rightRangeOut:_,topRange:b,leftRange:T,bottomRange:U,rightRange:E,range:w,mr:P,borderStyle:{s:n,cl:{rgb:s}}}}const vl=o=>{const{range:e,mr:t,borderStyle:n,vertical:s,horizontal:r,worksheet:a}=o;s&&mn(e,(c,l)=>{var d,m,h;const u=a.getMergedCell(c,l);if(u){const g=(d=t.getValue(u.startRow,u.startColumn))==null?void 0:d.s;u.startColumn!==e.startColumn&&t.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}else{if(l!==e.endColumn){const g=(m=t.getValue(c,l))==null?void 0:m.s;t.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{r:i.Tools.deepClone(n)}):{r:i.Tools.deepClone(n)}}})}if(l!==e.startColumn){const g=(h=t.getValue(c,l))==null?void 0:h.s;t.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}}}),r&&mn(e,(c,l)=>{var d,m,h;const u=a.getMergedCell(c,l);if(u){const g=(d=t.getValue(u.startRow,u.startColumn))==null?void 0:d.s;u.startRow!==e.startRow&&t.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}else{if(c!==e.endRow){const g=(m=t.getValue(c,l))==null?void 0:m.s;t.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{b:i.Tools.deepClone(n)}):{b:i.Tools.deepClone(n)}}})}if(c!==e.startRow){const g=(h=t.getValue(c,l))==null?void 0:h.s;t.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}}})};function wl(o){const{borderStyle:e,tl_br:t,tl_bc:n,tl_mr:s,bl_tr:r,ml_tr:a,bc_tr:c}=o,l=(u,d,m)=>{Fo(o,u,d,m)};t&&l(o.range,{tl_br:i.Tools.deepClone(e)},!0),n&&l(o.range,{tl_bc:i.Tools.deepClone(e)},!0),s&&l(o.range,{tl_mr:i.Tools.deepClone(e)},!0),r&&l(o.range,{bl_tr:i.Tools.deepClone(e)},!0),a&&l(o.range,{ml_tr:i.Tools.deepClone(e)},!0),c&&l(o.range,{bc_tr:i.Tools.deepClone(e)},!0)}const Ml=o=>{const{top:e,left:t,right:n,bottom:s,borderStyle:r,bottomRange:a,topRange:c,leftRange:l,rightRange:u,bottomRangeOut:d,topRangeOut:m,leftRangeOut:h,rightRangeOut:g}=o,R=(C,f,p)=>{Fo(o,C,f,p)};e&&(R(m,{b:null}),R(c,{t:i.Tools.deepClone(r)},!0)),s&&(R(d,{t:null}),R(a,{b:i.Tools.deepClone(r)},!0)),t&&(R(h,{r:null}),R(l,{l:i.Tools.deepClone(r)},!0)),n&&(R(g,{l:null}),R(u,{r:i.Tools.deepClone(r)},!0))},yl=o=>{const{range:e,worksheet:t,mr:n,top:s,bottom:r,left:a,right:c,vertical:l,horizontal:u,tl_br:d,tl_bc:m,tl_mr:h,bl_tr:g,ml_tr:R,bc_tr:C,topRange:f,bottomRange:p,leftRange:w,rightRange:I,topRangeOut:v,bottomRangeOut:M,leftRangeOut:_,rightRangeOut:b}=o,T=(U,E,P)=>{Fo(o,U,E,P)};!s&&!r&&!a&&!c&&!l&&!u&&!d&&!m&&!h&&!g&&!R&&!C&&(mn(e,(U,E)=>{var A,x,W,$,z,j,q,te;const P=t.getMergedCell(U,E);if(P){if(P.endColumn!==e.endColumn){const V=(A=n.getValue(P.startRow,P.startColumn))==null?void 0:A.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{r:null}):{r:null}}})}if(P.startColumn!==e.startColumn){const V=(x=n.getValue(P.startRow,P.startColumn))==null?void 0:x.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{l:null}):{l:null}}})}if(P.endRow!==e.endRow){const V=(W=n.getValue(P.startRow,P.startColumn))==null?void 0:W.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{b:null}):{b:null}}})}if(P.startRow!==e.startRow){const V=($=n.getValue(P.startRow,P.startColumn))==null?void 0:$.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{t:null}):{t:null}}})}}else{if(E!==e.endColumn){const V=(z=n.getValue(U,E))==null?void 0:z.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{r:null}):{r:null}}})}if(E!==e.startColumn){const V=(j=n.getValue(U,E))==null?void 0:j.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{l:null}):{l:null}}})}if(U!==e.endRow){const V=(q=n.getValue(U,E))==null?void 0:q.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{b:null}):{b:null}}})}if(U!==e.startRow){const V=(te=n.getValue(U,E))==null?void 0:te.s;n.setValue(U,E,{s:{bd:V!=null&&V.bd?Object.assign(V.bd,{t:null}):{t:null}}})}}}),T(v,{b:null}),T(f,{t:null},!0),T(M,{t:null}),T(p,{b:null},!0),T(_,{r:null}),T(w,{l:null},!0),T(b,{l:null}),T(I,{r:null},!0),T(e,{tl_br:null},!0),T(e,{tl_bc:null},!0),T(e,{tl_mr:null},!0),T(e,{bl_tr:null},!0),T(e,{ml_tr:null},!0),T(e,{bc_tr:null},!0))},Tt={id:"sheet.command.set-border",type:i.CommandType.COMMAND,handler:(o,e)=>{var p;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(ot),c=k(s,e);if(!c)return!1;const l=(e==null?void 0:e.ranges)||((p=r.getCurrentSelections())==null?void 0:p.map(w=>w.range));if(!(l!=null&&l.length))return!1;const{activeBorderType:u}=a.getBorderInfo();if(!u)return!1;const d=Il(a,c,l);vl(d),Ml(d),wl(d),yl(d);const{unitId:m,subUnitId:h,mr:g}=d,R={unitId:m,subUnitId:h,cellValue:g.getData()},C=me(o,R);return t.syncExecuteCommand(H.id,R)?(n.pushUndoRedo({unitID:m,undoMutations:[{id:H.id,params:C}],redoMutations:[{id:H.id,params:R}]}),!0):!1}},Yr={id:"sheet.command.set-border-position",type:i.CommandType.COMMAND,handler:(o,e)=>{if(!e.value)return!1;const t=o.get(i.ICommandService);return o.get(ot).setType(e.value),t.syncExecuteCommand(Tt.id)}},Kr={id:"sheet.command.set-border-style",type:i.CommandType.COMMAND,handler:(o,e)=>{const t=o.get(i.ICommandService);return o.get(ot).setStyle(e.value),t.syncExecuteCommand(Tt.id)}},Jr={id:"sheet.command.set-border-color",type:i.CommandType.COMMAND,handler:(o,e)=>{const t=o.get(i.ICommandService);return o.get(ot).setColor(e.value),t.syncExecuteCommand(Tt.id)}},Xr={id:"sheet.command.set-border-basic",type:i.CommandType.COMMAND,handler:(o,e)=>{const{unitId:t,subUnitId:n,value:s,ranges:r}=e,{type:a,color:c,style:l}=s,u=o.get(i.ICommandService),d=o.get(ot);return d.setType(a),c&&d.setColor(c),d.setStyle(l),u.syncExecuteCommand(Tt.id,{unitId:t,subUnitId:n,ranges:r})}},Zr={type:i.CommandType.COMMAND,id:"sheet.command.set-col-data",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=k(s,e);if(!r)return!1;const{columnData:a}=e,{unitId:c,subUnitId:l,worksheet:u}=r,d={subUnitId:l,unitId:c,columnData:a},m=ks(d,u);return t.syncExecuteCommand(rt.id,d)?(n.pushUndoRedo({unitID:c,undoMutations:[{id:rt.id,params:m}],redoMutations:[{id:rt.id,params:d}]}),!0):!1}},Mt={type:i.CommandType.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:(o,e)=>{var p,w;const{unitId:t,subUnitId:n,ranges:s}=e,r=o.get(exports.SheetInterceptorService),a=o.get(i.ICommandService),c=o.get(i.IUniverInstanceService),l=k(c,{unitId:t,subUnitId:n});if(!l)return!1;const{worksheet:u}=l,d={unitId:t,subUnitId:n,ranges:s},m={unitId:t,subUnitId:n,reveal:!0,selections:s.map(I=>({range:I,primary:oe(I,u),style:null}))},h=Ia(o,d),g={unitId:t,subUnitId:n,selections:Qr(s).map(I=>({range:I,primary:oe(I,u),style:null}))},R=i.sequenceExecute([{id:St.id,params:d},{id:G.id,params:m}],a),C=r.onCommandExecute({id:Mt.id,params:e}),f=i.sequenceExecute([...C.redos],a);if(R.result&&f.result){const I=r.afterCommandExecute({id:Mt.id,params:e});return i.sequenceExecute(I.redos,a),o.get(i.IUndoRedoService).pushUndoRedo({unitID:t,undoMutations:[{id:Ct.id,params:h},{id:G.id,params:g},...(p=C.undos)!=null?p:[],...I.undos],redoMutations:[...(w=C.preRedos)!=null?w:[],{id:St.id,params:d},{id:G.id,params:m},...C.redos,...I.redos]}),!0}return!0}},jo={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:o=>{var u;const e=o.get(exports.SheetsSelectionsService),t=o.get(i.ICommandService),n=(u=e.getCurrentSelections())==null?void 0:u.map(d=>d.range).filter(d=>d.rangeType===i.RANGE_TYPE.COLUMN);if(!(n!=null&&n.length))return!1;const s=k(o.get(i.IUniverInstanceService));if(!s)return!1;const{worksheet:r,unitId:a,subUnitId:c}=s,l=n.map(d=>r.getHiddenCols(d.startColumn,d.endColumn)).flat();return t.executeCommand(Mt.id,{unitId:a,subUnitId:c,ranges:l})}},hn={type:i.CommandType.COMMAND,id:"sheet.command.set-col-hidden",handler:(o,e)=>{var w,I,v,M;const t=o.get(exports.SheetsSelectionsService),n=o.get(exports.SheetInterceptorService),s=o.get(i.IUniverInstanceService),r=o.get(i.ICommandService);let a=(w=e==null?void 0:e.ranges)!=null&&w.length?e.ranges:(I=t.getCurrentSelections())==null?void 0:I.map(_=>_.range).filter(_=>_.rangeType===i.RANGE_TYPE.COLUMN);if(!(a!=null&&a.length))return!1;const c=k(s,e);if(!c)return!1;const{worksheet:l,unitId:u,subUnitId:d}=c;a=_l(c.worksheet,a);const m={unitId:u,subUnitId:d,ranges:a},h={unitId:u,subUnitId:d,selections:Qr(a).map(_=>({range:_,primary:oe(_,l),style:null}))},g=pa(o,m),R={unitId:u,subUnitId:d,reveal:!0,selections:a.map(_=>({range:_,primary:oe(_,l),style:null}))},C=i.sequenceExecute([{id:Ct.id,params:m},{id:G.id,params:h}],r),f=n.onCommandExecute({id:hn.id,params:m}),p=i.sequenceExecute([...f.redos],r);if(C.result&&p.result){const _=n.afterCommandExecute({id:hn.id,params:m});return i.sequenceExecute(_.redos,r),o.get(i.IUndoRedoService).pushUndoRedo({unitID:u,undoMutations:[{id:St.id,params:g},{id:G.id,params:R},...(v=f.undos)!=null?v:[],..._.undos],redoMutations:[...(M=f.preRedos)!=null?M:[],{id:Ct.id,params:m},{id:G.id,params:h},...f.redos,..._.redos]}),!0}return!1}};function _l(o,e){const t=o.getRowCount()-1,n=o.getHiddenCols(),s=[];return e.forEach(r=>{const a=n.filter(c=>c.startColumn>=r.startColumn&&c.endColumn<=r.endColumn);if(a.length){let c=r.startColumn;a.forEach(l=>{l.startColumn>c&&(s.push({startColumn:c,endColumn:l.startColumn-1,startRow:0,endRow:t}),c=l.endColumn+1)}),c<=r.endColumn&&s.push({startColumn:c,endColumn:r.endColumn,startRow:0,endRow:t})}else s.push(r)}),s}function Qr(o){return bl(o).map(t=>{const n=t.startColumn===0?t.endColumn+1:t.startColumn-1;return{...t,startColumn:n,endColumn:n}})}function bl(o){const e=[];let t;return o.sort((n,s)=>n.startColumn-s.startColumn).forEach(n=>{if(!t){t=n;return}t.endColumn===n.startColumn-1?t.endColumn=n.endColumn:(e.push(t),t=n)}),e.push(t),e}const Go={id:"sheet.command.set-defined-name",type:i.CommandType.COMMAND,handler:(o,e)=>{var m,h;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetInterceptorService);if(!e)return!1;const r={...e},a=Y.SetDefinedNameMutationFactory(o,e),c=s.onCommandExecute({id:Go.id,params:e}),l=[...(m=c.preRedos)!=null?m:[],{id:Y.RemoveDefinedNameMutation.id,params:a},{id:Y.SetDefinedNameMutation.id,params:r},...c.redos],u=[...(h=c.preUndos)!=null?h:[],{id:Y.RemoveDefinedNameMutation.id,params:r},{id:Y.SetDefinedNameMutation.id,params:a},...c.undos];return i.sequenceExecute(l,t)?(n.pushUndoRedo({unitID:e.unitId,undoMutations:u.filter(Boolean),redoMutations:l.filter(Boolean)}),!0):!1}},zo=(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(s==null)throw new Error("worksheet is null error!");const a=s.getConfig().freeze;return{unitId:e.unitId,subUnitId:e.subUnitId,...a}},ke={id:"sheet.mutation.set-frozen",type:i.CommandType.MUTATION,handler:(o,e)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(e.subUnitId);if(!s)return!1;const r=s.getConfig(),{startRow:a,startColumn:c,ySplit:l,xSplit:u}=e;return r.freeze={startRow:a,startColumn:c,ySplit:l,xSplit:u},!0}},ei={type:i.CommandType.COMMAND,id:"sheet.command.set-frozen",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=k(s,{unitId:e.unitId,subUnitId:e.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:c,worksheet:l}=r,{startColumn:u,startRow:d,xSplit:m,ySplit:h}=e;if(d>=l.getRowCount()||u>=l.getColumnCount()||m>=l.getColumnCount()||h>=l.getRowCount())return!1;const g={unitId:a,subUnitId:c,...e},R=zo(o,g);return t.syncExecuteCommand(ke.id,g)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:ke.id,params:R}],redoMutations:[{id:ke.id,params:g}]}),!0):!1}},ti={type:i.CommandType.COMMAND,id:"sheet.command.cancel-frozen",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUniverInstanceService),s=o.get(i.IUndoRedoService),r=k(n,{unitId:e==null?void 0:e.unitId,subUnitId:e==null?void 0:e.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:c}=r,l={unitId:a,subUnitId:c,startRow:-1,startColumn:-1,xSplit:0,ySplit:0},u=zo(o,l);return t.syncExecuteCommand(ke.id,l)&&s.pushUndoRedo({unitID:a,undoMutations:[{id:ke.id,params:u}],redoMutations:[{id:ke.id,params:l}]}),!0}},ni={type:i.CommandType.COMMAND,id:"sheet.command.set-gridlines-color",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=k(s);if(!r)return!1;const{worksheet:a}=r,c=a.getConfig().gridlinesColor;if(c===(e==null?void 0:e.color))return!1;const{unitId:l,subUnitId:u}=r,d={color:e==null?void 0:e.color,unitId:l,subUnitId:u},m={color:c,unitId:l,subUnitId:u};return t.syncExecuteCommand(it.id,d)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:it.id,params:m}],redoMutations:[{id:it.id,params:d}]}),!0):!1}},Z={id:"sheet.mutation.set-range-protection",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,rule:s,ruleId:r}=e;return o.get(J).setRule(t,n,r,s),!0}},El=(o,e)=>{const{unitId:t,subUnitId:n,ruleId:s}=e,a=o.get(J).getRule(t,n,s);return a?{id:Z.id,params:{...e,rule:a}}:null},qe={id:"sheet.mutation.set-worksheet-protection",type:i.CommandType.MUTATION,handler:(o,e)=>{const{unitId:t,subUnitId:n,rule:s}=e;return o.get(Oe).setRule(t,n,s),!0}},oi={type:i.CommandType.COMMAND,id:"sheet.command.set-protection",async handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(J),{rule:r,oldRule:a}=e,{unitId:c,subUnitId:l}=r,u=[],d=[];return(a==null?void 0:a.unitType)===r.unitType?r.unitType===N.Worksheet?(u.push({id:qe.id,params:{unitId:c,subUnitId:l,rule:r}}),d.push({id:qe.id,params:{unitId:c,subUnitId:l,rule:a}})):(u.push({id:Z.id,params:{unitId:c,subUnitId:l,rule:r,ruleId:r.id}}),d.push({id:Z.id,params:{unitId:c,subUnitId:l,ruleId:a.id,rule:a}})):(a&&(a.unitType===N.Worksheet?(u.push({id:et.id,params:{unitId:c,subUnitId:l}}),d.push({id:Ge.id,params:{unitId:c,rule:a,subUnitId:a.subUnitId}})):a.unitType===N.SelectRange&&(u.push({id:Pe.id,params:{unitId:c,subUnitId:l,ruleIds:[a.id]}}),d.push({id:fe.id,params:{unitId:c,subUnitId:l,rules:[a]}}))),r.unitType===N.Worksheet?(u.push({id:Ge.id,params:{unitId:c,rule:r,subUnitId:r.subUnitId}}),d.unshift({id:et.id,params:{unitId:c,subUnitId:l}})):r.unitType===N.SelectRange&&(r.id=s.createRuleId(c,l),u.push({id:fe.id,params:{unitId:c,subUnitId:l,rules:[r]}}),d.unshift({id:Pe.id,params:{unitId:c,subUnitId:l,ruleIds:[r.id]}}))),i.sequenceExecute(u,t)&&n.pushUndoRedo({unitID:c,undoMutations:d,redoMutations:u}),!0}},si={type:i.CommandType.COMMAND,id:"sheet.command.set-row-data",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=k(s,e);if(!r)return!1;const{rowData:a}=e,{unitId:c,subUnitId:l,worksheet:u}=r,d={subUnitId:l,unitId:c,rowData:a},m=Ns(d,u);return t.syncExecuteCommand(at.id,d)?(n.pushUndoRedo({unitID:c,undoMutations:[{id:at.id,params:m}],redoMutations:[{id:at.id,params:d}]}),!0):!1}},yt={type:i.CommandType.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:(o,e)=>{var p,w,I;const{unitId:t,subUnitId:n,ranges:s}=e,r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(exports.SheetInterceptorService),l=k(o.get(i.IUniverInstanceService),{unitId:t,subUnitId:n});if(!l)return!1;const{worksheet:u}=l,d={unitId:t,subUnitId:n,ranges:s},m={unitId:t,subUnitId:n,reveal:!0,selections:s.map(v=>({range:v,primary:oe(v,u),style:null}))},h=ka(o,d),g={unitId:t,subUnitId:n,selections:ri(s).map(v=>({range:v,primary:oe(v,u),style:null}))},R=i.sequenceExecute([{id:Ye.id,params:d},{id:G.id,params:m}],r),C=c.onCommandExecute({id:yt.id,params:e}),f=i.sequenceExecute([...C.redos],r);if(R.result&&f.result){const v=c.afterCommandExecute({id:yt.id,params:e});return i.sequenceExecute(v.redos,r),a.pushUndoRedo({unitID:t,undoMutations:[...(p=C.preUndos)!=null?p:[],{id:Ke.id,params:h},{id:G.id,params:g},...(w=C.undos)!=null?w:[],...v.undos],redoMutations:[...(I=C.preRedos)!=null?I:[],{id:Ye.id,params:d},{id:G.id,params:m},...C.redos,...v.redos]}),!0}return!0}},qo={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:async o=>{var d;const e=o.get(exports.SheetsSelectionsService),t=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=(d=e.getCurrentSelections())==null?void 0:d.map(m=>m.range).filter(m=>m.rangeType===i.RANGE_TYPE.ROW);if(!(s!=null&&s.length))return!1;const r=k(t);if(!r)return!1;const{worksheet:a,unitId:c,subUnitId:l}=r,u=s.map(m=>a.getHiddenRows(m.startRow,m.endRow)).flat();return n.executeCommand(yt.id,{unitId:c,subUnitId:l,ranges:u})}},gn={type:i.CommandType.COMMAND,id:"sheet.command.set-rows-hidden",handler:(o,e)=>{var w,I,v,M,_,b;const t=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(i.IUniverInstanceService),a=o.get(exports.SheetInterceptorService);let c=(w=e==null?void 0:e.ranges)!=null&&w.length?e.ranges:(I=t.getCurrentSelections())==null?void 0:I.map(T=>T.range).filter(T=>T.rangeType===i.RANGE_TYPE.ROW);if(!(c!=null&&c.length))return!1;const l=k(r,e);if(!l)return!1;c=Tl(l.worksheet,c);const{unitId:u,subUnitId:d,worksheet:m}=l,h={unitId:u,subUnitId:d,ranges:c},g={unitId:u,subUnitId:d,selections:ri(c).map(T=>({range:T,primary:oe(T,m),style:null}))},R=Pa(o,h),C={unitId:u,subUnitId:d,reveal:!0,selections:c.map(T=>({range:T,primary:oe(T,m),style:null}))},f=a.onCommandExecute({id:gn.id,params:h});if(i.sequenceExecute([...(v=f.preRedos)!=null?v:[],{id:Ke.id,params:h},{id:G.id,params:g},...f.redos],n).result){const T=a.afterCommandExecute({id:gn.id,params:h});return i.sequenceExecute(T.redos,n),s.pushUndoRedo({unitID:u,undoMutations:[...(M=f.preUndos)!=null?M:[],{id:Ye.id,params:R},{id:G.id,params:C},...(_=f.undos)!=null?_:[],...T.undos],redoMutations:[...(b=f.preRedos)!=null?b:[],{id:Ke.id,params:h},{id:G.id,params:g},...f.redos,...T.redos]}),!0}return!0}};function Tl(o,e){const t=o.getMaxColumns()-1,n=o.getHiddenRows(),s=[];return e.forEach(r=>{const a=n.filter(c=>c.startRow>=r.startRow&&c.endRow<=r.endRow);if(a.length){let c=r.startRow;a.forEach(l=>{l.startRow>c&&(s.push({startRow:c,endRow:l.startRow-1,startColumn:0,endColumn:t}),c=l.endRow+1)}),c<=r.endRow&&s.push({startRow:c,endRow:r.endRow,startColumn:0,endColumn:t})}else s.push(r)}),s}function ri(o){return Ul(o).map(t=>{const n=t.startRow===0?t.endRow+1:t.startRow-1;return{...t,startRow:n,endRow:n}})}function Ul(o){const e=[];let t;return o.sort((n,s)=>n.startRow-s.startRow).forEach(n=>{if(!t){t=n;return}n.startRow===t.endRow+1?t.endRow=n.endRow:(e.push(t),t=n)}),e.push(t),e}const kl=["ff","fs","tr","tb"],Q={type:i.CommandType.COMMAND,id:"sheet.command.set-style",handler:(o,e)=>{var U;const t=o.get(i.IUniverInstanceService),n=k(t,e);if(!n)return!1;const{unitId:s,subUnitId:r,worksheet:a}=n,{range:c,style:l}=e,u=o.get(i.ICommandService),d=o.get(i.IUndoRedoService),m=o.get(exports.SheetsSelectionsService),h=c?[c]:(U=m.getCurrentSelections())==null?void 0:U.map(E=>E.range);if(!(h!=null&&h.length))return!1;const g=new i.ObjectMatrix,R=gc(a);if(i.Tools.isArray(l.value))for(let E=0;E<h.length;E++)R.forOperableEach(h[E],(P,A,x)=>{g.setValue(P,A,{s:{[l.type]:l.value[P-x.startRow][A-x.startColumn]}})});else for(let E=0;E<h.length;E++){const P={s:{[l.type]:l.value}};R.forOperableEach(h[E],(A,x)=>g.setValue(A,x,P))}const C={subUnitId:r,unitId:s,cellValue:g.getMatrix()},f=o.get(exports.SheetSkeletonService).getSkeleton(s,r),p=me(o,C),w=u.syncExecuteCommand(H.id,C),I=o.get(exports.SheetInterceptorService);let v=[],M=[];if(kl.includes(e==null?void 0:e.style.type)){const{suitableRanges:E,remainingRanges:P}=Kt(h,f),A=Do(E,a),{undos:x,redos:W}=I.generateMutationsOfAutoHeight({unitId:s,subUnitId:r,ranges:E,autoHeightRanges:E,lazyAutoHeightRanges:P,cellHeights:A});v=x,M=W}const{undos:_,redos:b}=I.onCommandExecute({id:Q.id,params:e}),T=i.sequenceExecute([...b,...M],u);return w&&T.result?(d.pushUndoRedo({unitID:C.unitId,undoMutations:[{id:H.id,params:p},..._,...v],redoMutations:[{id:H.id,params:C},...b,...M]}),!0):!1}},Pl={type:i.CommandType.COMMAND,id:"sheet.command.set-bold",handler:o=>{const e=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=k(o.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t,{actualRow:s,actualColumn:r}=e.primary,c={style:{type:"bl",value:n.getRange(s,r).getFontWeight()===i.FontWeight.BOLD?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,c)}},Nl={type:i.CommandType.COMMAND,id:"sheet.command.set-italic",handler:o=>{const e=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=k(o.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let s=!0;if(e.primary){const{startRow:a,startColumn:c}=e.primary;s=n.getRange(a,c).getFontStyle()===i.FontItalic.ITALIC}const r={style:{type:"it",value:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Ol={type:i.CommandType.COMMAND,id:"sheet.command.set-underline",handler:o=>{const e=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=k(o.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let s=!0;e.primary&&(s=!!n.getRange(e.primary.startRow,e.primary.startColumn).getUnderline().s);const r={style:{type:"ul",value:{s:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Dl={type:i.CommandType.COMMAND,id:"sheet.command.set-stroke",handler:o=>{const e=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=k(o.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let s=!0;e.primary&&(s=!!n.getRange(e.primary.actualRow,e.primary.actualColumn).getStrikeThrough().s);const r={style:{type:"st",value:{s:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Al={type:i.CommandType.COMMAND,id:"sheet.command.set-overline",handler:o=>{const e=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!e)return!1;const t=k(o.get(i.IUniverInstanceService));if(!t)return!1;const{worksheet:n}=t;let s=!0;e.primary&&(s=!!n.getRange(e.primary.startRow,e.primary.startColumn).getOverline().s);const r={style:{type:"ol",value:{s:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},xl={type:i.CommandType.COMMAND,id:"sheet.command.set-font-family",handler:(o,e)=>{if(!e)return!1;const t=o.get(i.ICommandService),n={style:{type:"ff",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},Wl={type:i.CommandType.COMMAND,id:"sheet.command.set-font-size",handler:(o,e)=>{if(!e)return!1;const t=o.get(i.ICommandService),n={style:{type:"fs",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},ii={type:i.CommandType.COMMAND,id:"sheet.command.set-text-color",handler:(o,e)=>{if(!e)return!1;const t=o.get(i.ICommandService),n={style:{type:"cl",value:{rgb:e.value}}};return t.syncExecuteCommand(Q.id,n)}},ai={type:i.CommandType.COMMAND,id:"sheet.command.reset-text-color",handler:o=>{const e=o.get(i.ICommandService),t={style:{type:"cl",value:{rgb:null}}};return e.syncExecuteCommand(Q.id,t)}},ci={type:i.CommandType.COMMAND,id:"sheet.command.set-background-color",handler:(o,e)=>{if(!e||!e.value)return!1;const t=o.get(i.ICommandService),n={style:{type:"bg",value:{rgb:e.value}}};return t.syncExecuteCommand(Q.id,n)}},li={type:i.CommandType.COMMAND,id:"sheet.command.reset-background-color",handler:o=>{const e=o.get(i.ICommandService),t={style:{type:"bg",value:{rgb:null}}};return e.syncExecuteCommand(Q.id,t)}},ui={type:i.CommandType.COMMAND,id:"sheet.command.set-vertical-text-align",handler:(o,e)=>{if(!e)return!1;const t=o.get(i.ICommandService),n={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"vt",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},di={type:i.CommandType.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:(o,e)=>{if(!e)return!1;const t=o.get(i.ICommandService),n={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"ht",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},mi={type:i.CommandType.COMMAND,id:"sheet.command.set-text-wrap",handler:(o,e)=>{if(!e)return!1;const t=o.get(i.ICommandService),n={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"tb",value:e.value}};return t.syncExecuteCommand(Q.id,n)}},hi={type:i.CommandType.COMMAND,id:"sheet.command.set-text-rotation",handler:(o,e)=>{if(!e)return!1;const t=typeof e.value=="number"?{a:e.value}:{a:0,v:i.BooleanNumber.TRUE},n=o.get(i.ICommandService),s={unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,style:{type:"tr",value:t}};return n.syncExecuteCommand(Q.id,s)}},$l=(o,e)=>{const r=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId).getSheetBySheetId(e.subUnitId).getConfig().tabColor;return{...i.Tools.deepClone(e),color:r}},Ot={id:"sheet.mutation.set-tab-color",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getSheetBySheetId(e.subUnitId);return n?(n.getConfig().tabColor=e.color,!0):!1}},gi={type:i.CommandType.COMMAND,id:"sheet.command.set-tab-color",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=k(o.get(i.IUniverInstanceService));if(!s)return!1;const{unitId:r,subUnitId:a}=s,c={color:e.value,unitId:r,subUnitId:a},l=$l(o,c);return t.syncExecuteCommand(Ot.id,c)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:Ot.id,params:l}],redoMutations:[{id:Ot.id,params:c}]}),!0):!1}},Yo={id:"sheet.mutation.set-workbook-name",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUnit(e.unitId,i.UniverInstanceType.UNIVER_SHEET);return t?(t.setName(e.name),!0):!1}},Ko={type:i.CommandType.COMMAND,id:"sheet.command.set-workbook-name",handler:(o,e)=>{var l;const t=o.get(i.ICommandService),n=o.get(exports.SheetInterceptorService);if(!Yn(o.get(i.IUniverInstanceService),e))return!1;const r=n.onCommandExecute({id:Ko.id,params:e}),a={name:e.name,unitId:e.unitId},c=[...(l=r.preRedos)!=null?l:[],{id:Yo.id,params:a},...r.redos];return i.sequenceExecute(c,t).result}},Vl=4,Jo={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-activate",handler:(o,e,t)=>{const n=o.get(i.ICommandService),s=k(o.get(i.IUniverInstanceService),e);if(!s)return!1;const{unitId:r,subUnitId:a}=s;return new Promise(c=>{setTimeout(()=>{const l=n.syncExecuteCommand(bt.id,{unitId:r,subUnitId:a},t);c(l)},Vl)})}},$t={type:i.CommandType.COMMAND,id:"sheet.command.delta-column-width",handler:async(o,e)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();if(!(n!=null&&n.length))return!1;const s=o.get(i.ICommandService),r=o.get(i.IUndoRedoService),a=k(o.get(i.IUniverInstanceService));if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,{anchorCol:d,deltaX:m}=e,g=c.getColumnWidth(d)+m,R=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,C=n.filter($=>$.range.rangeType===i.RANGE_TYPE.COLUMN),f=R?i.RANGE_TYPE.ALL:C.some(({range:$})=>{const{startColumn:z,endColumn:j}=$;return z<=d&&d<=j})?i.RANGE_TYPE.COLUMN:i.RANGE_TYPE.NORMAL;let p;if(f===i.RANGE_TYPE.ALL){const $=c.getRowCount(),z=new Array(c.getColumnCount()).fill(void 0).map((j,q)=>({startRow:0,endRow:$-1,startColumn:q,endColumn:q}));p={subUnitId:u,unitId:l,colWidth:g,ranges:z}}else f===i.RANGE_TYPE.COLUMN?p={subUnitId:u,unitId:l,ranges:C.map($=>i.Rectangle.clone($.range)),colWidth:g}:p={subUnitId:u,unitId:l,colWidth:g,ranges:[{startRow:0,endRow:c.getMaxRows()-1,startColumn:d,endColumn:d}]};const w=o.get(exports.SheetSkeletonService).getSkeleton(l,u),{suitableRanges:I,remainingRanges:v}=Kt(p.ranges,w);Do(I,c);const M=o.get(exports.SheetInterceptorService),{undos:_,redos:b}=M.onCommandExecute({id:$t.id,params:p}),T=Kn(p,c),U=s.syncExecuteCommand(Ae.id,p),{undos:E,redos:P}=M.generateMutationsOfAutoHeight({unitId:l,subUnitId:u,ranges:I,autoHeightRanges:I,lazyAutoHeightRanges:v}),{undos:A,redos:x}=o.get(exports.SheetInterceptorService).afterCommandExecute({id:$t.id,params:p}),W=i.sequenceExecute([...b,...x,...P],s);return U&&W.result&&r.pushUndoRedo({unitID:l,undoMutations:[{id:Ae.id,params:T},..._,...A,...E],redoMutations:[{id:Ae.id,params:p},...b,...x,...P]}),!0}},Vt={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:(o,e)=>{var M,_,b,T;const t=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(exports.SheetInterceptorService),a=(M=e==null?void 0:e.ranges)!=null&&M.length?e.ranges:(_=t.getCurrentSelections())==null?void 0:_.map(U=>U.range);if(!(a!=null&&a.length))return!1;const c=k(o.get(i.IUniverInstanceService),e);if(!c)return!1;const{subUnitId:l,unitId:u,worksheet:d}=c,m=o.get(exports.SheetSkeletonService).getSkeleton(u,l),h={subUnitId:l,unitId:u,ranges:a,colWidth:e.value},{suitableRanges:g,remainingRanges:R}=Kt(h.ranges,m);Do(g,d);const C=Kn(h,d),f=n.syncExecuteCommand(Ae.id,h),{undos:p,redos:w}=r.generateMutationsOfAutoHeight({unitId:u,subUnitId:l,ranges:g,autoHeightRanges:g,lazyAutoHeightRanges:R}),I=r.onCommandExecute({id:Vt.id,params:h}),v=i.sequenceExecute([...I.redos,...w],n);if(f&&v.result){const U=r.afterCommandExecute({id:Vt.id,params:h});return i.sequenceExecute(U.redos,n),s.pushUndoRedo({unitID:u,undoMutations:[...(b=I.preUndos)!=null?b:[],{id:Ae.id,params:C},...I.undos,...U.undos,...p],redoMutations:[...(T=I.preRedos)!=null?T:[],{id:Ae.id,params:h},...I.redos,...U.redos,...w]}),!0}return!1}};i.CommandType.COMMAND;const Ri={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-column-count",handler:(o,e)=>{const{unitId:t,subUnitId:n,columnCount:s}=e,r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(i.IUniverInstanceService);if(!k(c,e))return!1;const u={unitId:t,subUnitId:n,columnCount:s},d=Os(o,u);return r.syncExecuteCommand(ct.id,u)?(a.pushUndoRedo({unitID:t,undoMutations:[{id:ct.id,params:d}],redoMutations:[{id:ct.id,params:u}]}),!0):!1}},Ci={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-default-style",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s}=e,r=Ds(o,e);return t.syncExecuteCommand(lt.id,e)?(n.pushUndoRedo({unitID:s,undoMutations:[{id:lt.id,params:r}],redoMutations:[{id:lt.id,params:e}]}),!0):!1}},Si=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{hidden:n.isSheetHidden(),unitId:e.unitId,subUnitId:n.getSheetId()}},He={id:"sheet.mutation.set-worksheet-hidden",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(t==null)return!1;const n=t.getSheetBySheetId(e.subUnitId);return n?(n.getConfig().hidden=e.hidden,!0):!1}},fi={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.ErrorService),r=o.get(i.LocaleService),a=k(o.get(i.IUniverInstanceService),e);if(!a)return!1;const{workbook:c,worksheet:l,unitId:u,subUnitId:d}=a;if(l.getConfig().hidden===i.BooleanNumber.TRUE)return!1;const h={unitId:u,subUnitId:d,hidden:i.BooleanNumber.TRUE},g=Si(o,h);return c.getSheets().filter(p=>p.getConfig().hidden===i.BooleanNumber.FALSE).length===1?(s.emit(r.t("sheets.info.hideSheet")),!1):t.syncExecuteCommand(He.id,h)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:He.id,params:g}],redoMutations:[{id:He.id,params:h}]}),!0):!1}},Ll=(o,e)=>{const t=_e(o.get(i.IUniverInstanceService),e);if(!t)throw new Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");const{worksheet:n}=t;return{unitId:e.unitId,name:n.getName(),subUnitId:n.getSheetId()}},Lt={id:"sheet.mutation.set-worksheet-name",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(t==null)return!1;const n=t.getSheetBySheetId(e.subUnitId);return n?(n.getConfig().name=e.name,!0):!1}},On={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-name",handler:(o,e)=>{var R,C;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetInterceptorService),r=k(o.get(i.IUniverInstanceService),e);if(!r)return!1;const{unitId:a,subUnitId:c}=r,l={subUnitId:c,name:e.name,unitId:a},u=Ll(o,l),d=s.onCommandExecute({id:On.id,params:e}),m=[...(R=d.preRedos)!=null?R:[],{id:Lt.id,params:l},...d.redos],h=[...(C=d.preUndos)!=null?C:[],{id:Lt.id,params:u},...d.undos];return i.sequenceExecute(m,t).result?(n.pushUndoRedo({unitID:a,undoMutations:h,redoMutations:m}),!0):!1}},Hl=(o,e)=>({...i.Tools.deepClone(e),toOrder:e.fromOrder,fromOrder:e.toOrder}),Dt={id:"sheet.mutation.set-worksheet-order",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getConfig();return n.sheetOrder.splice(e.fromOrder,1),n.sheetOrder.splice(e.toOrder,0,e.subUnitId),!0}},Xo={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-order",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=k(o.get(i.IUniverInstanceService),e);if(!s)return!1;const{workbook:r,unitId:a,subUnitId:c}=s,u={fromOrder:r.getConfig().sheetOrder.indexOf(c),toOrder:e.order,unitId:a,subUnitId:c},d=Hl(o,u);return t.syncExecuteCommand(Dt.id,u)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:Dt.id,params:d}],redoMutations:[{id:Dt.id,params:u}]}),!0):!1}};class Ut{constructor(){S(this,"_model",new Map);S(this,"_pointChange",new O.Subject);S(this,"pointChange$",this._pointChange.asObservable())}addRule(e){this._ensureSubUnitMap(e.unitId).set(e.subUnitId,e),this._pointChange.next(e)}deleteRule(e,t){var s,r,a;const n=(s=this._model.get(e))==null?void 0:s.get(t);n&&((a=(r=this._model)==null?void 0:r.get(e))==null||a.delete(t),this._pointChange.next(n))}getRule(e,t){var n,s;return(s=(n=this._model)==null?void 0:n.get(e))==null?void 0:s.get(t)}toObject(){const e={};return[...this._model.keys()].forEach(n=>{const s=this._model.get(n);s!=null&&s.size&&(e[n]=[],[...s.keys()].forEach(a=>{const c=s.get(a);c&&e[n].push(c)}))}),e}fromObject(e){const t=new Map;Object.keys(e).forEach(n=>{const s=e[n];if(s!=null&&s.length){const r=new Map;s.forEach(a=>{r.set(a.subUnitId,a)}),t.set(n,r)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=new Map,this._model.set(e,t)),t}getTargetByPermissionId(e,t){const n=this._model.get(e);if(!n)return null;for(const[s,r]of n)if(r.permissionId===t)return[e,s]}}class Zo{constructor(e,t,n){S(this,"type",N.SelectRange);S(this,"subType",y.Delete);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${y.Delete}.${n}`}}class Qo{constructor(e,t,n){S(this,"type",N.SelectRange);S(this,"subType",y.ManageCollaborator);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${N.SelectRange}.${y.ManageCollaborator}.${n}`}}const ie=()=>[_n,ge,Qo,Zo],Le=[y.Edit,y.View,y.ManageCollaborator,y.Delete],Bl=(o="unitId",e="subUnitId",t="permissionId")=>ie().reduce((n,s)=>{const r=new s(o,e,t);return n[r.subType]=r.value,n},{}),_t=()=>[ue,co,to,mo,no,ao,En,so,ro,Un,bn,io,uo,Tn,tr,ho,lo,oo,ir,rr,or,nr],pi=[y.Edit,y.Print,y.Comment,y.View,y.Copy,y.Export,y.ManageCollaborator,y.CreateSheet,y.DeleteSheet,y.RenameSheet,y.HideSheet,y.Duplicate,y.Share,y.MoveSheet,y.CopySheet,y.RecoverHistory,y.ViewHistory,y.CreatePermissionObject,y.InsertRow,y.InsertColumn,y.DeleteRow,y.DeleteColumn],re=()=>[Re,zt,Mo,Co],Ce=()=>[go,Ro,So,fo,po,Io,wo,vo,yo,_o,xt,mt,ht,bo],rn=[y.Copy,y.DeleteColumn,y.DeleteRow,y.EditExtraObject,y.Filter,y.InsertColumn,y.InsertRow,y.InsertHyperlink,y.PivotTable,y.SetCellStyle,y.SetCellValue,y.SetColumnStyle,y.SetRowStyle,y.Sort];var Fl=Object.getOwnPropertyDescriptor,jl=(o,e,t,n)=>{for(var s=n>1?void 0:n?Fl(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},$e=(o,e)=>(t,n)=>e(t,n,o);const Gl="SHEET_WORKSHEET_PROTECTION_PLUGIN",zl="SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN";exports.WorksheetPermissionService=class extends i.RxDisposable{constructor(e,t,n,s,r,a,c,l){super(),this._permissionService=e,this._univerInstanceService=t,this._injector=n,this._worksheetProtectionRuleModel=s,this._worksheetProtectionPointRuleModel=r,this._resourceManagerService=a,this._rangeProtectionRuleModel=c,this._logService=l,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){const e=t=>{const n=t.getUnitId(),s=r=>{const a=r.getSheetId();[...re(),...Ce()].forEach(c=>{const l=new c(n,a);this._permissionService.addPermissionPoint(l)}),this._logService.debug("[WorksheetPermissionService]","Initialization completed",n,a)};t.getSheets().forEach(r=>{s(r)}),t.sheetCreated$.subscribe(r=>{s(r)}),t.sheetDisposed$.subscribe(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(n,a).forEach(l=>{[...ie()].forEach(u=>{const d=new u(n,a,l.permissionId);this._permissionService.deletePermissionPoint(d.id)})}),[...re(),...Ce()].forEach(l=>{const u=new l(n,a);this._permissionService.deletePermissionPoint(u.id)})})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).pipe(Nt.takeUntil(this.dispose$)).subscribe(e),this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(Nt.takeUntil(this.dispose$)).subscribe(t=>{t.getSheets().forEach(n=>{const s=t.getUnitId(),r=n.getSheetId();re().forEach(a=>{const c=new a(s,r);this._permissionService.deletePermissionPoint(c.id)})})})}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":break;case"delete":{re().forEach(t=>{const n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)});break}case"set":{re().forEach(t=>{const n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,e.rule)});break}}}))}_initRuleSnapshot(){const e=()=>{const n=this._worksheetProtectionRuleModel.toObject();return JSON.stringify(n)},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:Gl,businesses:[cn.UNIVER_SHEET],onLoad:(n,s)=>{this._worksheetProtectionRuleModel.fromObject(s),Object.keys(s).forEach(r=>{re().forEach(a=>{const c=new a(n,r);c.value=!1,this._permissionService.addPermissionPoint(c)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},onUnLoad:n=>{const s=this._univerInstanceService.getUnit(n);s&&(s.getSheets().forEach(r=>{const a=r.getSheetId();[...re(),...Ce()].forEach(c=>{const l=new c(n,a);this._permissionService.deletePermissionPoint(l.id)})}),_t().forEach(r=>{const a=new r(n);this._permissionService.deletePermissionPoint(a.id)})),this._worksheetProtectionRuleModel.deleteUnitModel(n)}}))}_initPointSnapshot(){const e=()=>{const n=this._worksheetProtectionPointRuleModel.toObject();return JSON.stringify(n)},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:zl,businesses:[cn.UNIVER_SHEET],onLoad:(n,s)=>{this._worksheetProtectionPointRuleModel.fromObject(s),Object.keys(s).forEach(r=>{Ce().forEach(a=>{const c=new a(n,r);this._permissionService.addPermissionPoint(c)})})},onUnLoad:n=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(n)}}))}};exports.WorksheetPermissionService=jl([$e(0,i.Inject(i.IPermissionService)),$e(1,i.Inject(i.IUniverInstanceService)),$e(2,i.Inject(i.Injector)),$e(3,i.Inject(Oe)),$e(4,i.Inject(Ut)),$e(5,i.Inject(i.IResourceManagerService)),$e(6,i.Inject(J)),$e(7,i.Inject(i.ILogService))],exports.WorksheetPermissionService);const Dn={id:"sheet.mutation.set-worksheet-permission-points",type:i.CommandType.MUTATION,handler:(o,e)=>{const{rule:t}=e;return o.get(Ut).addRule(t),!0}},Ii={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),{rule:n}=e;return t.executeCommand(Dn.id,{rule:n,unitId:n.unitId,subUnitId:n.subUnitId}),!0}},vi={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-protection",async handler(o,e){if(!e)return!1;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{rule:s,permissionId:r,oldRule:a}=e,{unitId:c,subUnitId:l}=s,u={...s,permissionId:r};if(await t.executeCommand(qe.id,{unitId:c,subUnitId:l,newRule:u})){const m=[{id:qe.id,params:{unitId:c,subUnitId:l,newRule:u}}],h=[{id:qe.id,params:{unitId:c,subUnitId:l,rule:a}}];n.pushUndoRedo({unitID:c,redoMutations:m,undoMutations:h})}return!0}},ql=(o,e)=>{const r=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId).getSheetBySheetId(e.subUnitId).getConfig().rightToLeft;return{...i.Tools.deepClone(e),rightToLeft:r}},an={id:"sheet.mutation.set-worksheet-right-to-left",type:i.CommandType.MUTATION,handler:(o,e)=>{const t=o.get(i.IUniverInstanceService).getUniverSheetInstance(e.unitId);if(!t)return!1;const n=t.getSheetBySheetId(e.subUnitId);if(!n)return!1;const s=n.getConfig();return s.rightToLeft=e.rightToLeft,!0}},Yl={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-right-to-left",handler:async(o,e)=>{var m;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=k(o.get(i.IUniverInstanceService),e);if(!s)return!1;const{unitId:r,subUnitId:a}=s;let c=i.BooleanNumber.FALSE;e&&(c=(m=e.rightToLeft)!=null?m:i.BooleanNumber.FALSE);const l={rightToLeft:c,unitId:r,subUnitId:a},u=ql(o,l);return t.syncExecuteCommand(an.id,l)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:an.id,params:u}],redoMutations:[{id:an.id,params:l}]}),!0):!1}},wi={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-row-count",handler:(o,e)=>{const{unitId:t,subUnitId:n,rowCount:s}=e,r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(i.IUniverInstanceService);if(!k(c,e))return!1;const u={unitId:t,subUnitId:n,rowCount:s},d=As(o,u);return r.syncExecuteCommand(ut.id,u)?(a.pushUndoRedo({unitID:t,undoMutations:[{id:ut.id,params:d}],redoMutations:[{id:ut.id,params:u}]}),!0):!1}},Ht={type:i.CommandType.COMMAND,id:"sheet.command.delta-row-height",handler:async(o,e)=>{var U,E;const n=o.get(exports.SheetsSelectionsService).getCurrentSelections(),s=o.get(exports.SheetInterceptorService);if(!(n!=null&&n.length))return!1;const r=k(o.get(i.IUniverInstanceService));if(!r)return!1;const{worksheet:a,subUnitId:c,unitId:l}=r,{anchorRow:u,deltaY:d}=e,h=a.getRowHeight(u)+d,g=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,R=n.filter(P=>P.range.rangeType===i.RANGE_TYPE.ROW),C=g?i.RANGE_TYPE.ALL:R.some(({range:P})=>{const{startRow:A,endRow:x}=P;return A<=u&&u<=x})?i.RANGE_TYPE.ROW:i.RANGE_TYPE.NORMAL;let f;if(C===i.RANGE_TYPE.ALL){const P=a.getColumnCount(),A=new Array(a.getRowCount()).fill(void 0).map((x,W)=>({startRow:W,endRow:W,startColumn:0,endColumn:P-1}));f={subUnitId:c,unitId:l,rowHeight:h,ranges:A}}else C===i.RANGE_TYPE.ROW?f={subUnitId:c,unitId:l,ranges:R.map(P=>i.Rectangle.clone(P.range)),rowHeight:h}:f={subUnitId:c,unitId:l,rowHeight:h,ranges:[{startRow:u,endRow:u,startColumn:0,endColumn:a.getMaxColumns()-1}]};const p=xs(f,a),w={unitId:l,subUnitId:c,ranges:f.ranges,autoHeightInfo:i.BooleanNumber.FALSE},I=Jn(w,a),v=o.get(i.ICommandService),M=o.get(i.IUndoRedoService),_=s.onCommandExecute({id:Ht.id,params:f}),b=i.sequenceExecute([{id:Te.id,params:f},{id:Se.id,params:w}],v),T=i.sequenceExecute([..._.redos],v);if(b.result&&T.result){const P=s.afterCommandExecute({id:Ht.id,params:f});return i.sequenceExecute(P.redos,v),M.pushUndoRedo({unitID:l,undoMutations:[...(U=_.preUndos)!=null?U:[],{id:Te.id,params:p},{id:Se.id,params:I},..._.undos,...P.undos],redoMutations:[...(E=_.preRedos)!=null?E:[],{id:Te.id,params:f},{id:Se.id,params:w},..._.redos,...P.redos]}),!0}return!1}},Bt={type:i.CommandType.COMMAND,id:"sheet.command.set-row-height",handler:(o,e)=>{var I,v,M,_;const t=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(i.IUniverInstanceService),a=o.get(exports.SheetInterceptorService),c=(I=e==null?void 0:e.ranges)!=null&&I.length?e.ranges:(v=t.getCurrentSelections())==null?void 0:v.map(b=>b.range);if(!(c!=null&&c.length))return!1;const l=k(r,e);if(!l)return!1;const{unitId:u,subUnitId:d,worksheet:m}=l,h={subUnitId:d,unitId:u,ranges:c,rowHeight:e.value},g=xs(h,m),R={unitId:u,subUnitId:d,ranges:h.ranges,autoHeightInfo:i.BooleanNumber.FALSE},C=Jn(R,m),f=i.sequenceExecute([{id:Te.id,params:h},{id:Se.id,params:R}],n),p=a.onCommandExecute({id:Bt.id,params:h}),w=i.sequenceExecute([...p.redos],n);if(f.result&&w.result){const b=a.afterCommandExecute({id:Bt.id,params:h});return i.sequenceExecute(b.redos,n),s.pushUndoRedo({unitID:u,undoMutations:[...(M=p.preRedos)!=null?M:[],{id:Te.id,params:g},{id:Se.id,params:C},...p.undos,...b.undos],redoMutations:[...(_=p.preRedos)!=null?_:[],{id:Te.id,params:h},{id:Se.id,params:R},...p.redos,...b.redos]}),!0}return!1}},An={type:i.CommandType.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:(o,e)=>{var b,T;const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUniverInstanceService),a=k(r,e);if(!a)return!1;const{unitId:c,subUnitId:l,worksheet:u}=a,d=(b=e==null?void 0:e.ranges)!=null&&b.length?e.ranges:(T=s.getCurrentSelections())==null?void 0:T.map(U=>U.range);if(!(d!=null&&d.length))return!1;const m={unitId:c,subUnitId:l,ranges:d,autoHeightInfo:i.BooleanNumber.TRUE},h=Jn(m,u),g=t.syncExecuteCommand(Se.id,m),R=o.get(exports.SheetSkeletonService).getSkeleton(c,l),{suitableRanges:C,remainingRanges:f}=Kt(m.ranges,R),p=o.get(exports.SheetInterceptorService),{undos:w,redos:I}=p.generateMutationsOfAutoHeight({unitId:c,subUnitId:l,ranges:C,autoHeightRanges:C,lazyAutoHeightRanges:f}),{undos:v,redos:M}=p.onCommandExecute({id:An.id,params:m}),_=i.sequenceExecute([...M,...I],t);return g&&_.result?(n.pushUndoRedo({unitID:c,undoMutations:[{id:Se.id,params:h},...v,...w],redoMutations:[{id:Se.id,params:m},...M,...I]}),!0):!1}},es={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-show",handler:(o,e)=>{const{unitId:t,subUnitId:n}=e,s=o.get(i.ICommandService),r=o.get(i.IUndoRedoService),a=o.get(i.IUniverInstanceService);if(!k(o.get(i.IUniverInstanceService)))return!1;const l=a.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return!1;const u=l.getSheetBySheetId(n);if(!u||u.getConfig().hidden===i.BooleanNumber.FALSE)return!1;const m={unitId:t,subUnitId:n,hidden:i.BooleanNumber.FALSE},h=Si(o,m),g=s.syncExecuteCommand(He.id,m),R={unitId:t,subUnitId:n},C=s.syncExecuteCommand(bt.id,R);return g&&C?(r.pushUndoRedo({unitID:t,undoMutations:[{id:He.id,params:h}],redoMutations:[{id:He.id,params:m}]}),!0):!1}},Mi={type:i.CommandType.COMMAND,id:"sheet.command.split-text-to-columns",handler:(o,e)=>{const{unitId:t,subUnitId:n,range:s,delimiter:r,customDelimiter:a,treatMultipleDelimitersAsOne:c}=e,l=o.get(i.ICommandService),u=o.get(i.IUniverInstanceService),d=o.get(i.IUndoRedoService);if(!k(o.get(i.IUniverInstanceService)))return!1;const h=u.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!h)return!1;const g=h.getSheetBySheetId(n);if(!g)return!1;const{lastRow:R,rs:C,maxLength:f}=Fs(g,s,r,a,c),p=g.getColumnCount(),{startColumn:w}=i.Range.transformRange(s,g);if(s.startColumn!==s.endColumn)return!1;const I=[],v=[],M=w+f+1-p;if(M>0){const P={unitId:t,subUnitId:n,range:{startRow:0,endRow:g.getRowCount()-1,startColumn:p-1,endColumn:p-1+M}};I.push({id:ce.id,params:P});const A=Ft(o,P);v.push({id:ne.id,params:A})}const _={startRow:s.startRow,endRow:R,startColumn:w,endColumn:w+f},b=new i.ObjectMatrix;for(let P=_.startRow;P<=_.endRow;P++)for(let A=_.startColumn;A<=_.endColumn;A++){const x=C[P-_.startRow];A===0&&(x==null?void 0:x.length)===1?b.setValue(P,A,g.getCell(P,A)):b.setValue(P,A,{v:(x==null?void 0:x[A-_.startColumn])||null,p:null,f:null,si:null,custom:null})}const T={unitId:t,subUnitId:n,cellValue:b.clone()},U=me(o,T);return I.push({id:H.id,params:T}),v.unshift({id:H.id,params:U}),i.sequenceExecute(I,l).result?(d.pushUndoRedo({unitID:t,undoMutations:v,redoMutations:I}),!0):!1}},yi={id:"sheet.command.toggle-cell-checkbox",type:i.CommandType.COMMAND,handler:(o,e)=>{if(!e)return!1;const{unitId:t,subUnitId:n,row:s,col:r,paragraphIndex:a}=e,l=o.get(i.IUniverInstanceService).getUnit(t,i.UniverInstanceType.UNIVER_SHEET),u=l==null?void 0:l.getSheetBySheetId(n),d=o.get(i.IUndoRedoService),m=o.get(i.ICommandService);if(!u)return!1;const h=u.getCell(s,r);if(!(h!=null&&h.p))return!1;const g=i.Tools.deepClone(h.p),R=new i.DocumentDataModel(g),C=i.BuildTextUtils.paragraph.bullet.toggleChecklist({document:R,paragraphIndex:a});if(!C)return!1;i.TextX.apply(R.getBody(),C.serialize());const f={unitId:t,subUnitId:n,cellValue:{[s]:{[r]:{p:g,t:i.CellValueType.STRING}}}},p={id:H.id,params:f},w=me(o,f),I={id:H.id,params:w},v=[p],M=[I];return d.pushUndoRedo({redoMutations:v,undoMutations:M,unitID:t}),m.syncExecuteCommand(p.id,p.params)}},_i={type:i.CommandType.COMMAND,id:"sheet.command.toggle-gridlines",handler:(o,e)=>{const t=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=k(s);if(!r)return!1;const{worksheet:a}=r,c=a.getConfig().showGridlines;if(c===(e==null?void 0:e.showGridlines))return!1;const{unitId:l,subUnitId:u}=r,d={showGridlines:c===i.BooleanNumber.TRUE?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE,unitId:l,subUnitId:u},m={showGridlines:c,unitId:l,subUnitId:u};return t.syncExecuteCommand(dt.id,d)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:dt.id,params:m}],redoMutations:[{id:dt.id,params:d}]}),!0):!1}},bi={id:"sheet.command.unregister-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(o,e)=>{var h;if(!e)return!1;const{unitId:t,themeName:n}=e,s=o.get(i.IUniverInstanceService),r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(exports.SheetRangeThemeModel);if(!k(s))return!1;const u={unitId:t,themeName:n},d={unitId:t,themeName:n,rangeThemeStyleJson:(h=c.getRangeThemeStyle(t,n))==null?void 0:h.toJson()};return r.syncExecuteCommand(wt.id,e)&&a.pushUndoRedo({unitID:t,undoMutations:[{id:wt.id,params:d}],redoMutations:[{id:Pn.id,params:u}]}),!0}},Ei={id:"sheet.mutation.add-range-theme",type:i.CommandType.MUTATION,handler:(o,e)=>{if(!e)return!1;const{styleJSON:t,unitId:n}=e,s=o.get(exports.SheetRangeThemeModel),r=new xe(t.name);return r.fromJson(t),s.registerRangeThemeStyle(n,r),!0}},Ti={id:"sheet.mutation.empty",type:i.CommandType.MUTATION,handler:()=>!0},Ui={id:"sheet.operation.mark-dirty-row-auto-height",type:i.CommandType.OPERATION,handler:()=>!0},ki={id:"sheet.operation.cancel-mark-dirty-row-auto-height",type:i.CommandType.OPERATION,handler:()=>!0},tt=i.createIdentifier("INumfmtService"),Kl=(o,e)=>{const t=o.get(tt),{values:n,unitId:s,subUnitId:r}=e,a=[],c=[];Object.keys(n).forEach(u=>{n[u].ranges.forEach(m=>{i.Range.foreach(m,(h,g)=>{const R=t.getValue(s,r,h,g);R?a.push({pattern:R.pattern,row:h,col:g}):c.push({startColumn:g,endColumn:g,startRow:h,endRow:h})})})});const l=[];if(a.length){const u=Rn(s,r,a);Object.keys(u.values).forEach(d=>{const m=u.values[d];m.ranges=Qn(m.ranges)}),l.push({id:xn.id,params:Rn(s,r,a)})}return c.length&&l.push({id:ts.id,params:{unitId:s,subUnitId:r,ranges:c}}),l},xn={id:"sheet.mutation.set.numfmt",type:i.CommandType.MUTATION,handler:(o,e)=>{if(!e)return!1;const{values:t,refMap:n}=e,s=o.get(tt),r=e.unitId,a=e.subUnitId,c=Object.keys(t).reduce((l,u)=>{const d=n[u],m=t[u].ranges;return d&&l.push({...d,ranges:m}),l},[]);return s.setValues(r,a,c),!0}},ts={id:"sheet.mutation.remove.numfmt",type:i.CommandType.MUTATION,handler:(o,e)=>{if(!e)return!1;const{unitId:t,subUnitId:n,ranges:s}=e;return o.get(tt).deleteValues(t,n,s),!0}},Jl=(o,e)=>{const t=o.get(tt),{ranges:n,unitId:s,subUnitId:r}=e,a=[];if(n.forEach(l=>{i.Range.foreach(l,(u,d)=>{const m=t.getValue(s,r,u,d);m&&a.push({pattern:m.pattern,row:u,col:d})})}),!a.length)return[];const c=Rn(s,r,a);return Object.keys(c.values).forEach(l=>{const u=c.values[l];u.ranges=Qn(u.ranges)}),[{id:xn.id,params:c}]},Rn=(o,e,t)=>{const n=Qa(t,"pattern"),s={},r={},a=ec();return Object.keys(n).forEach(c=>{const l=n[c],u=a();s[u]={pattern:c},l.forEach(d=>{r[u]||(r[u]={ranges:[]}),r[u].ranges.push(i.cellToRange(d.row,d.col))})}),{unitId:o,subUnitId:e,refMap:s,values:r}},Pi={id:"sheet.mutation.remove-range-theme",type:i.CommandType.MUTATION,handler:(o,e)=>{if(!e)return!1;const{styleName:t,unitId:n}=e;return o.get(exports.SheetRangeThemeModel).unregisterRangeThemeStyle(n,t),!0}},Ni={id:"sheet.mutation.set-range-theme",type:i.CommandType.MUTATION,handler:(o,e)=>{if(!e)return!1;const{unitId:t,styleName:n,style:s}=e,a=o.get(exports.SheetRangeThemeModel).getRangeThemeStyle(t,n);return a&&(s.headerRowStyle&&a.setHeaderRowStyle(s.headerRowStyle),s.firstRowStyle&&a.setFirstRowStyle(s.firstRowStyle),s.secondRowStyle&&a.setSecondRowStyle(s.secondRowStyle),s.lastRowStyle&&a.setLastRowStyle(s.lastRowStyle)),!0}},Oi={id:"sheet.operation.scroll-to-cell",type:i.CommandType.OPERATION,handler:()=>!0},Xl=(o,e,t)=>{const s=o.get(exports.SheetsSelectionsService).getCurrentSelections(),{value:r,selections:a,unitId:c,subUnitId:l}=e;if(s){const d=s[(s==null?void 0:s.length)-1].primary;if(d){const{actualColumn:m,actualRow:h}=d;let{startRow:g,startColumn:R,endRow:C,endColumn:f}=a[a.length-1];if(r===i.Dimension.COLUMNS){const v=t.find(M=>M.startColumn===m&&M.endColumn===m&&h===M.startRow);v&&(f=v.endColumn,g=v.startRow,C=v.endRow)}else if(r===i.Dimension.ROWS){const v=t.find(M=>M.startRow===h&&M.endRow===h&&m===M.startColumn);v&&(C=v.endRow,R=v.startColumn,f=v.endColumn)}const p={startRow:g,startColumn:R,endRow:C,endColumn:f,actualRow:h,actualColumn:m,isMerged:!0,isMergedMainCell:g===h&&R===m},w=s.map((v,M,_)=>({range:v.range,style:null,primary:M===_.length-1?p:null})),I={unitId:c,subUnitId:l,type:ee.ONLY_SET,selections:w};return{id:G.id,params:I}}return null}return null},Zl=(o,e)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections(),{unitId:s,subUnitId:r}=e;if(n&&n[(n==null?void 0:n.length)-1].primary){const l={unitId:s,subUnitId:r,type:ee.ONLY_SET,selections:[...n]};return{id:G.id,params:l}}return null},Di="maxCellsPerSheet",Ql=3e6;var eu=Object.getOwnPropertyDescriptor,tu=(o,e,t,n)=>{for(var s=n>1?void 0:n?eu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Cs=(o,e)=>(t,n)=>e(t,n,o);const nu="SHEET_DEFINED_NAME_PLUGIN",ou="AllDefaultWorkbook";exports.DefinedNameDataController=class extends i.Disposable{constructor(e,t){super(),this._definedNamesService=e,this._resourceManagerService=t,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){const e=n=>{const s=this._definedNamesService.getDefinedNameMap(n);return s?JSON.stringify(s):""},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:nu,businesses:[i.UniverInstanceType.UNIVER_SHEET],toJson:n=>e(n),parseJson:n=>t(n),onUnLoad:n=>{this._definedNamesService.removeUnitDefinedName(n)},onLoad:(n,s)=>{this._definedNamesService.registerDefinedNames(n,s)}}))}};exports.DefinedNameDataController=tu([Cs(0,Y.IDefinedNamesService),Cs(1,i.IResourceManagerService)],exports.DefinedNameDataController);var su=Object.getOwnPropertyDescriptor,ru=(o,e,t,n)=>{for(var s=n>1?void 0:n?su(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},$n=(o,e)=>(t,n)=>e(t,n,o);const iu=[ke.id],au=[ae.id,ce.id,le.id,ne.id,ve.id,we.id];exports.SheetsFreezeSyncController=class extends i.Disposable{constructor(t,n,s){var a,c;super();S(this,"_d",new i.DisposableCollection);S(this,"_enabled",!0);this._univerInstanceService=t,this._commandService=n,this._configService=s;const r=(c=(a=this._configService.getConfig(Xt))==null?void 0:a.freezeSync)!=null?c:!0;this.setEnabled(r)}getEnabled(){return this._enabled}setEnabled(t){t?this._d.dispose():this._initOnlyLocalListener(),this._enabled=t}_initOnlyLocalListener(){this._d.add(this._commandService.beforeCommandExecuted((t,n)=>{iu.includes(t.id)&&(n||(n={}),n.onlyLocal=!0)})),this._d.add(this._commandService.onCommandExecuted((t,n)=>{if(au.includes(t.id)&&(n!=null&&n.fromCollab)){const{id:s,params:r}=t;s===ae.id?this._handleInsertRowMutation(r,n):s===ce.id?this._handleInsertColMutation(r,n):s===le.id?this._handleRemoveRowMutation(r,n):s===ne.id?this._handleRemoveColMutation(r,n):s===ve.id?this._handleMoveRowsMutation(r,n):s===we.id&&this._handleMoveColsMutation(r,n)}}))}_handleInsertRowMutation(t,n){const{range:s,unitId:r,subUnitId:a}=t,c=this._getFreeze(r,a);if(c&&s.startRow<c.startRow){const l=s.endRow-s.startRow+1,u={...c,startRow:Math.max(1,c.startRow+l),ySplit:Math.max(1,c.ySplit+l)};this._sequenceExecute(r,a,u,n)}}_handleInsertColMutation(t,n){const{range:s,unitId:r,subUnitId:a}=t,c=this._getFreeze(r,a);if(c&&s.startColumn<c.startColumn){const l=s.endColumn-s.startColumn+1,u={...c,startColumn:Math.max(1,c.startColumn+l),xSplit:Math.max(1,c.xSplit+l)};this._sequenceExecute(r,a,u,n)}}_handleRemoveRowMutation(t,n){const{range:s,unitId:r,subUnitId:a}=t,c=this._getFreeze(r,a);if(c&&s.startRow<c.startRow){const l=Math.min(c.startRow,s.endRow+1)-s.startRow,u={...c,startRow:Math.max(1,c.startRow-l),ySplit:Math.max(1,c.ySplit-l)};this._sequenceExecute(r,a,u,n)}}_handleRemoveColMutation(t,n){const{range:s,unitId:r,subUnitId:a}=t,c=this._getFreeze(r,a);if(c&&s.startColumn<c.startColumn){const l=Math.min(c.startColumn,s.endColumn+1)-s.startColumn,u={...c,startColumn:Math.max(1,c.startColumn-l),xSplit:Math.max(1,c.xSplit-l)};this._sequenceExecute(r,a,u,n)}}_handleMoveRowsMutation(t,n){const{sourceRange:s,targetRange:r,unitId:a,subUnitId:c}=t,l=this._getFreeze(a,c);if(!l||l.startRow<=0||s.startRow>=l.startRow&&r.startRow>=l.startRow||s.endRow<l.startRow&&r.endRow<l.startRow)return;const u=s.endRow-s.startRow+1,d=Math.max(Math.min(l.startRow,s.endRow+1)-s.startRow,0),m={...l};r.startRow>=l.startRow?(m.startRow=Math.max(1,l.startRow-d),m.ySplit=Math.max(1,l.ySplit-d)):(m.startRow=l.startRow+u-d,m.ySplit=l.ySplit+u-d),this._sequenceExecute(a,c,m,n)}_handleMoveColsMutation(t,n){const{sourceRange:s,targetRange:r,unitId:a,subUnitId:c}=t,l=this._getFreeze(a,c);if(!l||l.startColumn<=0||s.startColumn>=l.startColumn&&r.startColumn>=l.startColumn||s.endColumn<l.startColumn&&r.endColumn<l.startColumn)return;const u=s.endColumn-s.startColumn+1,d=Math.max(Math.min(l.startColumn,s.endColumn+1)-s.startColumn,0),m={...l};r.startColumn>=l.startColumn?(m.startColumn=Math.max(1,l.startColumn-d),m.xSplit=Math.max(1,l.xSplit-d)):(m.startColumn=l.startColumn+u-d,m.xSplit=l.xSplit+u-d),this._sequenceExecute(a,c,m,n)}_getFreeze(t,n){const s=this._univerInstanceService.getUnit(t,i.UniverInstanceType.UNIVER_SHEET);if(!s)return null;const r=s.getSheetBySheetId(n);return r?r.getFreeze():null}_sequenceExecute(t,n,s,r){i.sequenceExecute([{id:ke.id,params:{...s,unitId:t,subUnitId:n,resetScroll:!1}}],this._commandService,r)}};exports.SheetsFreezeSyncController=ru([$n(0,i.Inject(i.IUniverInstanceService)),$n(1,i.ICommandService),$n(2,i.IConfigService)],exports.SheetsFreezeSyncController);var cu=Object.getOwnPropertyDescriptor,lu=(o,e,t,n)=>{for(var s=n>1?void 0:n?cu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},be=(o,e)=>(t,n)=>e(t,n,o);exports.SheetPermissionCheckController=class extends i.Disposable{constructor(t,n,s,r,a,c,l,u,d,m){super();S(this,"disposableCollection",new i.DisposableCollection);S(this,"_triggerPermissionUIEvent$",new O.Subject);S(this,"triggerPermissionUIEvent$",this._triggerPermissionUIEvent$.asObservable());this._commandService=t,this._univerInstanceService=n,this._permissionService=s,this._selectionManagerService=r,this._rangeProtectionRuleModel=a,this._worksheetProtectionRuleModel=c,this._localeService=l,this._lexerTreeBuilder=u,this._contextService=d,this._definedNamesService=m,this._initialize()}blockExecuteWithoutPermission(t){throw this._triggerPermissionUIEvent$.next(t),new i.CustomCommandExecutionError("have no permission")}_getPermissionCheck(t,n){let s=!0,r="";switch(t){case Et.id:i.isICellData(n.value)&&n.value.f?(s=this._permissionCheckWithFormula(n),r=this._localeService.t("permission.dialog.formulaErr")):s=this._permissionCheckBySetRangeValue({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[xt,Re]},n);break;case kn.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[xt,Re]},n==null?void 0:n.ranges,n==null?void 0:n.unitId,n==null?void 0:n.subUnitId),r=this._localeService.t("permission.dialog.editErr");break;case $t.id:case Vt.id:s=this.permissionCheckWithoutRange({worksheetTypes:[mt]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Ht.id:case Bt.id:case An.id:s=this.permissionCheckWithoutRange({worksheetTypes:[ht]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case It.id:case pt.id:s=this._permissionCheckByMoveCommand(n),r=this._localeService.t("permission.dialog.moveRowColErr");break;case ze.id:s=this._permissionCheckByMoveRangeCommand(n),r=this._localeService.t("permission.dialog.moveRangeErr");break;case Xo.id:s=this._permissionCheckByWorksheetCommand([ue,Tn]),r=this._localeService.t("permission.dialog.operatorSheetErr"),s===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case On.id:s=this._permissionCheckByWorksheetCommand([ue,Un]),r=this._localeService.t("permission.dialog.operatorSheetErr"),s===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case es.id:{const{unitId:a,subUnitId:c}=n;s=this._permissionCheckByWorksheetCommand([ue,bn],a,c),r=this._localeService.t("permission.dialog.operatorSheetErr"),s===!1&&this._worksheetProtectionRuleModel.resetOrder()}break;case Mt.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,mt]},n.ranges,n.unitId,n.subUnitId),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case yt.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,ht]},n.ranges,n.unitId,n.subUnitId),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case jo.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,mt]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case qo.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,ht]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case ft.id:s=this._permissionCheckWithInsertRangeMove("right"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Je.id:s=this._permissionCheckWithInsertRangeMove("bottom"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Fe.id:s=this._permissionCheckWithInsertRangeMove("left"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case je.id:s=this._permissionCheckWithInsertRangeMove("top"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break}s||this.blockExecuteWithoutPermission(r)}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(t=>{this._getPermissionCheck(t.id,t==null?void 0:t.params)})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{var n;if(t.id===Lt.id){const s=t.params,{unitId:r=(n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.getUnitId(),subUnitId:a}=s;if(!r||!a)return;const c=this._worksheetProtectionRuleModel.getRule(r,a),l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a);c&&this._worksheetProtectionRuleModel.ruleRefresh(c.permissionId),l.length&&this._rangeProtectionRuleModel.ruleRefresh(a)}}))}_permissionCheckWithInsertRangeMove(t){var d;const n=k(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=i.Tools.deepClone((d=this._selectionManagerService.getCurrentLastSelection())==null?void 0:d.range);return!(!c||(t==="top"||t==="bottom"?c.endRow=s.getRowCount()-1:(t==="left"||t==="right")&&(c.endColumn=s.getColumnCount()-1),this._rangeProtectionRuleModel.getSubunitRuleList(r,a).map(m=>m.ranges).flat().some(m=>i.Rectangle.getIntersects(c,m))))}_permissionCheckByWorksheetCommand(t,n,s){var d,m;const r=k(this._univerInstanceService,{unitId:n,subUnitId:s});if(!r)return!1;const{unitId:a,subUnitId:c}=r,l=this._worksheetProtectionRuleModel.getRule(a,c),u=this._rangeProtectionRuleModel.getSubunitRuleList(a,c).length>0;return l||u?(m=(d=this._permissionService.getPermissionPoint(new En(a).id))==null?void 0:d.value)!=null?m:!1:this._permissionService.composePermission(t.map(h=>new h(a).id)).every(h=>h.value)}permissionCheckWithoutRange(t){var g,R,C,f;const n=k(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=this._selectionManagerService.getCurrentLastSelection();if(!c)return!0;const l=(R=(g=c==null?void 0:c.primary)==null?void 0:g.actualRow)!=null?R:0,u=(f=(C=c==null?void 0:c.primary)==null?void 0:C.actualColumn)!=null?f:0,{workbookTypes:d,worksheetTypes:m,rangeTypes:h}=t;return!(d&&d.some(w=>{var M,_;const I=new w(r);return((_=(M=this._permissionService.getPermissionPoint(I.id))==null?void 0:M.value)!=null?_:!1)===!1})===!0||m&&m.some(w=>{var M,_;const I=new w(r,a);return((_=(M=this._permissionService.getPermissionPoint(I.id))==null?void 0:M.value)!=null?_:!1)===!1})===!0||h&&h.some(w=>{var b,T,U,E,P;const I=(T=(b=s.getCell(l,u))==null?void 0:b.selectionProtection)==null?void 0:T[0];if(!(I!=null&&I.ruleId))return!1;const v=(U=this._rangeProtectionRuleModel.getRule(r,a,I.ruleId))==null?void 0:U.permissionId;if(!v)return!1;const M=new w(r,a,v);return((P=(E=this._permissionService.getPermissionPoint(M.id))==null?void 0:E.value)!=null?P:!1)===!1})===!0)}permissionCheckWithRanges(t,n,s,r){var R;const a=k(this._univerInstanceService);if(!a)return!1;const{workbook:c,worksheet:l}=a;s||(s=c.getUnitId()),r||(r=l.getSheetId());const u=n!=null?n:(R=this._selectionManagerService.getCurrentSelections())==null?void 0:R.map(C=>C.range);if(!u)return!1;const{workbookTypes:d,worksheetTypes:m,rangeTypes:h}=t,g=[];return d&&g.push(...d.map(C=>new C(s).id)),m&&g.push(...m.map(C=>new C(s,r).id)),h&&this._rangeProtectionRuleModel.getSubunitRuleList(s,r).forEach(C=>{u.some(p=>C.ranges.some(w=>i.Rectangle.intersects(w,p)))&&g.push(...h.map(p=>new p(s,r,C.permissionId).id))}),g.length?this._permissionService.composePermission(g).every(C=>C.value):!0}_permissionCheckByMoveCommand(t){const n=k(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=t.toRange;c.endRow===s.getRowCount()-1?c.endColumn=c.startColumn:c.endRow=c.startRow;const l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((u,d)=>[...u,...d.ranges],[]).filter(u=>i.Rectangle.intersects(u,c));return l.length>0?!1:(l.forEach(u=>{var d,m;for(let h=u.startRow;h<=u.endRow;h++)for(let g=u.startColumn;g<=u.endColumn;g++){const R=(m=(d=s.getCell(h,g))==null?void 0:d.selectionProtection)==null?void 0:m[0];if((R==null?void 0:R[y.Edit])===!1)return!1}}),!0)}_permissionCheckByMoveRangeCommand(t){const n=k(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=t.toRange,l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((u,d)=>[...u,...d.ranges],[]).filter(u=>i.Rectangle.intersects(u,c));return l.length>0?!1:(l.forEach(u=>{var d,m;for(let h=u.startRow;h<=u.endRow;h++)for(let g=u.startColumn;g<=u.endColumn;g++){const R=(m=(d=s.getCell(h,g))==null?void 0:d.selectionProtection)==null?void 0:m[0];if((R==null?void 0:R[y.Edit])===!1)return!1}}),!0)}_permissionCheckBySetRangeValue(t,n){let s=[];n.range?s=[n.range]:s=[new i.ObjectMatrix(n.value).getDataRange()];const{unitId:r,subUnitId:a}=n;return this.permissionCheckWithRanges(t,s,r,a)}_permissionCheckWithFormula(t){var a,c,l,u,d;const n=t.value,s=t.range,r=n.f;if(r){const m=r.substring(1),h=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),g=(a=t.unitId)!=null?a:h.getUnitId(),R=this._definedNamesService.getValueByName(g,m);if(R){let C=R.formulaOrRefString;C.startsWith(Y.operatorToken.EQUALS)&&(C=C.slice(1));const f=C.split(",");for(let p=0;p<f.length;p++){const w=f[p],I=Y.deserializeRangeWithSheet(w);if(I.sheetName){const v=h.getSheetBySheetName(I.sheetName);if(!v)return!0;const{startRow:M,endRow:_,startColumn:b,endColumn:T}=I.range;for(let U=M;U<=_;U++)for(let E=b;E<=T;E++){const P=(l=(c=v.getCell(U,E))==null?void 0:c.selectionProtection)==null?void 0:l[0];if((P==null?void 0:P[y.View])===!1)return!1}}}return!0}else{const C=this._lexerTreeBuilder.sequenceNodesBuilder(r);if(!C)return!0;for(let f=0;f<C.length;f++){const p=C[f];if(typeof p=="string"||p.nodeType!==Y.sequenceNodeType.REFERENCE)continue;const{token:w}=p,I=Y.deserializeRangeWithSheetWithCache(w),v=I.unitId?this._univerInstanceService.getUnit(I.unitId):this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!v)return!0;let M=I.sheetName?v.getSheetBySheetName(I.sheetName):v.getActiveSheet();const _=v.getUnitId();if(I.sheetName){if(M=v.getSheetBySheetName(I.sheetName),!M)return!0;const P=M==null?void 0:M.getSheetId();if(!this._permissionService.getPermissionPoint(new zt(_,P).id))return!1}if(!M)return!0;const{startRow:b,endRow:T,startColumn:U,endColumn:E}=I.range;for(let P=b;P<=T;P++)for(let A=U;A<=E;A++){const x=(d=(u=M.getCell(P,A))==null?void 0:u.selectionProtection)==null?void 0:d[0];if((x==null?void 0:x[y.View])===!1)return!1}}return!0}}if(s){const m=k(this._univerInstanceService);if(!m)return!1;const h=t.unitId||m.unitId,g=t.subUnitId||m.subUnitId,C=this._rangeProtectionRuleModel.getSubunitRuleList(h,g).filter(p=>p.ranges.some(w=>i.Rectangle.intersects(w,s))).map(p=>new ge(h,g,p.permissionId).id);if(!this._permissionService.composePermission(C).every(p=>p.value))return!1}return!0}};exports.SheetPermissionCheckController=lu([be(0,i.ICommandService),be(1,i.IUniverInstanceService),be(2,i.IPermissionService),be(3,i.Inject(exports.SheetsSelectionsService)),be(4,i.Inject(J)),be(5,i.Inject(Oe)),be(6,i.Inject(i.LocaleService)),be(7,i.Inject(Y.LexerTreeBuilder)),be(8,i.IContextService),be(9,Y.IDefinedNamesService)],exports.SheetPermissionCheckController);var uu=Object.getOwnPropertyDescriptor,du=(o,e,t,n)=>{for(var s=n>1?void 0:n?uu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},kt=(o,e)=>(t,n)=>e(t,n,o);exports.WorkbookPermissionService=class extends i.Disposable{constructor(t,n,s,r,a){super();S(this,"_unitPermissionInitStateChange",new O.BehaviorSubject(!1));S(this,"unitPermissionInitStateChange$",this._unitPermissionInitStateChange.asObservable());this._permissionService=t,this._univerInstanceService=n,this._rangeProtectionRuleModel=s,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointModel=a,this._init()}_init(){const t=n=>{const s=n.getUnitId();_t().forEach(r=>{const a=new r(s);this._permissionService.addPermissionPoint(a)})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(n=>{t(n)}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{t(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{const s=n.getUnitId();n.getSheets().forEach(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(s,a).forEach(l=>{[...ie()].forEach(u=>{const d=new u(s,a,l.permissionId);this._permissionService.deletePermissionPoint(d.id)})}),[...re(),...Ce()].forEach(l=>{const u=new l(s,a);this._permissionService.deletePermissionPoint(u.id)})}),_t().forEach(r=>{const a=new r(s);this._permissionService.deletePermissionPoint(a.id)}),this._rangeProtectionRuleModel.deleteUnitModel(s),this._worksheetProtectionPointModel.deleteUnitModel(s),this._worksheetProtectionRuleModel.deleteUnitModel(s)}))}changeUnitInitState(t){this._unitPermissionInitStateChange.next(t)}};exports.WorkbookPermissionService=du([kt(0,i.Inject(i.IPermissionService)),kt(1,i.Inject(i.IUniverInstanceService)),kt(2,i.Inject(J)),kt(3,i.Inject(Oe)),kt(4,i.Inject(Ut))],exports.WorkbookPermissionService);var mu=Object.getOwnPropertyDescriptor,hu=(o,e,t,n)=>{for(var s=n>1?void 0:n?mu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Ee=(o,e)=>(t,n)=>e(t,n,o);exports.SheetPermissionInitController=class extends i.Disposable{constructor(e,t,n,s,r,a,c,l,u,d){super(),this._univerInstanceService=e,this._permissionService=t,this._authzIoService=n,this._rangeProtectionRuleModel=s,this._worksheetProtectionRuleModel=r,this._userManagerService=a,this._worksheetProtectionPointRuleModel=c,this._workbookPermissionService=l,this._undoRedoService=u,this._commandService=d}initPermission(){this._initRangePermissionFromSnapshot(),this._initRangePermissionChange(),this._initWorksheetPermissionFromSnapshot(),this._initWorksheetPermissionChange(),this._initWorksheetPermissionPointsChange(),this._initWorkbookPermissionFromSnapshot(),this._initUserChange(),this._refreshPermissionByCollaCreate()}refreshRangeProtectPermission(){this._initRangePermissionFromSnapshot()}async _initRangePermissionFromSnapshot(){const e=async t=>{const n=[],s=t.getUnitId(),r=t.getSheets(),a=new Map;if(r.forEach(c=>{const l=c.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(s,l).forEach(u=>{a.set(u.permissionId,u),n.push({objectID:u.permissionId,unitID:s,objectType:N.SelectRange,actions:Le})})}),!n.length){this._rangeProtectionRuleModel.changeRuleInitState(!0);return}this._authzIoService.batchAllowed(n).then(c=>{c.forEach(l=>{const u=a.get(l.objectID);if(u){if(!this._rangeProtectionRuleModel.getRule(s,u.subUnitId,u.id))return;ie().forEach(m=>{const h=new m(s,u.subUnitId,l.objectID),g=h.subType,R=l.actions.find(C=>C.action===g);(R==null?void 0:R.allowed)!==void 0&&this._permissionService.updatePermissionPoint(h.id,R.allowed)})}}),this._rangeProtectionRuleModel.changeRuleInitState(!0)})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(t=>e(t))),this._rangeProtectionRuleModel.changeRuleInitState(!0)}_initRangePermissionChange(){this.disposeWithMe(this._rangeProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:N.SelectRange,actions:Le}).then(t=>{this._rangeProtectionRuleModel.getRule(e.unitId,e.subUnitId,e.rule.id)&&(ie().forEach(s=>{if(e.type==="set"){const{rule:u,oldRule:d}=e;if(u.permissionId===(d==null?void 0:d.permissionId))return}const r=e.rule,a=new s(r.unitId,r.subUnitId,r.permissionId),c=a.subType,l=t.find(u=>u.action===c);l&&this._permissionService.updatePermissionPoint(a.id,l.allowed)}),this._rangeProtectionRuleModel.ruleRefresh(e.rule.permissionId))}):this._rangeProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId).length===0&&(this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId),[...Ce()].forEach(n=>{const s=new n(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(s.id,s.value)}))}))}async initWorkbookPermissionChange(e){var n;const t=e||((n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.getUnitId());if(t)return this._authzIoService.allowed({objectID:t,objectType:N.Workbook,unitID:t,actions:pi}).then(s=>{_t().forEach(r=>{const a=new r(t),c=a.subType,l=s.find(u=>u.action===c);l&&this._permissionService.updatePermissionPoint(a.id,l.allowed)})})}async _initWorkbookPermissionFromSnapshot(){await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(e=>this.initWorkbookPermissionChange(e.getUnitId()))),this._workbookPermissionService.changeUnitInitState(!0)}_initWorksheetPermissionChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:N.Worksheet,actions:Le}).then(t=>{const n=this._worksheetProtectionRuleModel.getRule(e.unitId,e.subUnitId);!n||n.permissionId!==e.rule.permissionId||(re().forEach(s=>{const r=new s(e.unitId,e.subUnitId),a=r.subType,c=t.find(l=>l.action===a);c&&this._permissionService.updatePermissionPoint(r.id,c.allowed)}),this._worksheetProtectionRuleModel.ruleRefresh(e.rule.permissionId))}):([...re(),...Ce()].forEach(t=>{const n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)}),this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId))}))}_initWorksheetPermissionPointsChange(){this.disposeWithMe(this._worksheetProtectionPointRuleModel.pointChange$.subscribe(e=>{this._authzIoService.allowed({objectID:e.permissionId,unitID:e.unitId,objectType:N.Worksheet,actions:rn}).then(t=>{const n=this._worksheetProtectionPointRuleModel.getRule(e.unitId,e.subUnitId);!n||n.permissionId!==e.permissionId||Ce().forEach(s=>{const r=new s(e.unitId,e.subUnitId),a=r.subType,c=t.find(l=>l.action===a);c&&this._permissionService.updatePermissionPoint(r.id,c.allowed)})})}))}async _initWorksheetPermissionFromSnapshot(){const e=async t=>{const n=[],s=t.getUnitId(),r=t.getSheets(),a=new Map;if(r.forEach(c=>{const l=c.getSheetId(),u=this._worksheetProtectionRuleModel.getRule(s,l);u&&(a.set(u.permissionId,u),n.push({objectID:u.permissionId,unitID:s,objectType:N.Worksheet,actions:Le}));const d=this._worksheetProtectionPointRuleModel.getRule(s,l);d&&(a.set(d.permissionId,d),n.push({objectID:d.permissionId,unitID:s,objectType:N.Worksheet,actions:rn}))}),!n.length){this._worksheetProtectionRuleModel.changeRuleInitState(!0);return}this._authzIoService.batchAllowed(n).then(c=>{c.forEach(l=>{const u=a.get(l.objectID);if(u){const d=this._worksheetProtectionRuleModel.getRule(s,u.subUnitId)||this._worksheetProtectionPointRuleModel.getRule(s,u.subUnitId);if(!d||d.permissionId!==l.objectID)return;[...re(),...Ce()].forEach(m=>{const h=new m(s,u.subUnitId),g=h.subType,R=l.actions.find(C=>C.action===g);(R==null?void 0:R.allowed)!==void 0&&this._permissionService.updatePermissionPoint(h.id,R.allowed)})}}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(t=>e(t))),this._worksheetProtectionRuleModel.changeRuleInitState(!0)}_initUserChange(){this.disposeWithMe(this._userManagerService.currentUser$.pipe(O.skip(1)).subscribe(()=>{const e=this._permissionService.getAllPermissionPoint();this._permissionService.clearPermissionMap(),this._worksheetProtectionRuleModel.changeRuleInitState(!1),this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(n=>{const s=n.getUnitId();_t().forEach(r=>{let a=new r(s);e.has(a.id)&&(a=e.get(a.id)),this._permissionService.addPermissionPoint(a)}),n.getSheets().forEach(r=>{const a=r.getSheetId();[...re(),...Ce()].forEach(l=>{let u=new l(s,a);e.has(u.id)&&(u=e.get(u.id)),this._permissionService.addPermissionPoint(u)}),this._rangeProtectionRuleModel.getSubunitRuleList(s,a).forEach(l=>{ie().forEach(u=>{let d=new u(s,a,l.permissionId);e.has(d.id)&&(d=e.get(d.id)),this._permissionService.addPermissionPoint(d)})})}),this._initWorkbookPermissionFromSnapshot(),this._initWorksheetPermissionFromSnapshot(),this._initRangePermissionFromSnapshot()})}))}refreshPermission(e,t){const n=this._worksheetProtectionRuleModel.getTargetByPermissionId(e,t);let s=!1;if(n){const[c,l]=n;this._authzIoService.allowed({objectID:t,unitID:e,objectType:N.Worksheet,actions:Le}).then(u=>{if(!this._worksheetProtectionRuleModel.getTargetByPermissionId(e,t))return;let m="";re().forEach(h=>{var f;const g=new h(e,l),R=g.subType,C=u.find(p=>p.action===R);C&&(((f=this._permissionService.getPermissionPoint(g.id))==null?void 0:f.value)!==C.allowed&&(s=!0),this._permissionService.updatePermissionPoint(g.id,C.allowed),m+=`${C.action}_${C.allowed}`)}),this._worksheetProtectionRuleModel.ruleRefresh(`${t}_${m}`),s&&this._undoRedoService.clearUndoRedo(e)})}const r=this._worksheetProtectionPointRuleModel.getTargetByPermissionId(e,t);if(r){const[c,l]=r;this._authzIoService.allowed({objectID:t,unitID:e,objectType:N.Worksheet,actions:rn}).then(u=>{this._worksheetProtectionPointRuleModel.getTargetByPermissionId(e,t)&&(Ce().forEach(m=>{var C;const h=new m(e,l),g=h.subType,R=u.find(f=>f.action===g);R&&(((C=this._permissionService.getPermissionPoint(h.id))==null?void 0:C.value)!==R.allowed&&(s=!0),this._permissionService.updatePermissionPoint(h.id,R.allowed))}),s&&this._undoRedoService.clearUndoRedo(e))})}const a=this._rangeProtectionRuleModel.getTargetByPermissionId(e,t);if(a){const[c,l]=a;this._authzIoService.allowed({objectID:t,unitID:e,objectType:N.SelectRange,actions:Le}).then(u=>{if(!this._rangeProtectionRuleModel.getTargetByPermissionId(e,t))return;let m="";ie().forEach(h=>{var f;const g=new h(e,l,t),R=g.subType,C=u.find(p=>p.action===R);C&&(((f=this._permissionService.getPermissionPoint(g.id))==null?void 0:f.value)!==C.allowed&&(s=!0),this._permissionService.updatePermissionPoint(g.id,C.allowed),m+=`${C.action}_${C.allowed}`)}),this._rangeProtectionRuleModel.ruleRefresh(`${t}_${m}`),s&&this._undoRedoService.clearUndoRedo(e)})}}_refreshPermissionByCollaCreate(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{if(t!=null&&t.fromCollab&&(e.id===fe.id||e.id===Ge.id||e.id===Dn.id)){const n=e.params;this._undoRedoService.clearUndoRedo(n.unitId)}}))}};exports.SheetPermissionInitController=hu([Ee(0,i.IUniverInstanceService),Ee(1,i.IPermissionService),Ee(2,i.IAuthzIoService),Ee(3,i.Inject(J)),Ee(4,i.Inject(Oe)),Ee(5,i.Inject(i.UserManagerService)),Ee(6,i.Inject(Ut)),Ee(7,i.Inject(exports.WorkbookPermissionService)),Ee(8,i.Inject(i.IUndoRedoService)),Ee(9,i.Inject(i.ICommandService))],exports.SheetPermissionInitController);var gu=Object.getOwnPropertyDescriptor,Ru=(o,e,t,n)=>{for(var s=n>1?void 0:n?gu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Vn=(o,e)=>(t,n)=>e(t,n,o);exports.ZebraCrossingCacheController=class extends i.Disposable{constructor(t,n,s){super();S(this,"_zebraCacheUpdateSubject",new O.Subject);this._commandService=t,this._sheetRangeThemeModel=n,this._univerInstanceService=s,this._init()}_init(){this._initializeCommandListener(),this._initTriggerCacheUpdateListener()}updateZebraCrossingCache(t,n){this._zebraCacheUpdateSubject.next({unitId:t,subUnitId:n})}_initializeCommandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{const{id:n}=t;let s,r;switch(n){case ae.id:{const a=t.params;s=a.unitId,r=a.subUnitId}break;case Ye.id:{const a=t.params;s=a.unitId,r=a.subUnitId}break;case Ke.id:{const a=t.params;s=a.unitId,r=a.subUnitId}break;case le.id:{const a=t.params;s=a.unitId,r=a.subUnitId}break;case Te.id:{const a=t.params;s=a.unitId,r=a.subUnitId}break}s&&r&&(this._sheetRangeThemeModel.refreshSheetRowVisibleFuncSet(s,r),this._sheetRangeThemeModel.refreshZebraCrossingCacheBySheet(s,r))}))}_initTriggerCacheUpdateListener(){this.disposeWithMe(this._zebraCacheUpdateSubject.subscribe(({unitId:t,subUnitId:n})=>{this._sheetRangeThemeModel.refreshSheetRowVisibleFuncSet(t,n),this._sheetRangeThemeModel.refreshZebraCrossingCacheBySheet(t,n)}))}};exports.ZebraCrossingCacheController=Ru([Vn(0,i.Inject(i.ICommandService)),Vn(1,i.Inject(exports.SheetRangeThemeModel)),Vn(2,i.Inject(i.IUniverInstanceService))],exports.ZebraCrossingCacheController);var Cu=Object.getOwnPropertyDescriptor,Su=(o,e,t,n)=>{for(var s=n>1?void 0:n?Cu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Ss=(o,e)=>(t,n)=>e(t,n,o);exports.RangeProtectionRenderModel=class{constructor(e,t){S(this,"_cache",new i.LRUMap(1e4));this._selectionProtectionRuleModel=e,this._permissionService=t,this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe(Nt.filter(e=>e.type===N.SelectRange),Nt.filter(e=>ie().some(t=>e instanceof t)),Nt.map(e=>e)).subscribe(e=>{const t=this._selectionProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId);for(const n of t)n.permissionId===e.permissionId&&n.ranges.forEach(s=>{i.Range.foreach(s,(r,a)=>{const c=this._createKey(e.unitId,e.subUnitId,r,a);this._cache.delete(c)})})}),this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{var t;e.rule.ranges.forEach(n=>{i.Range.foreach(n,(s,r)=>{const a=this._createKey(e.unitId,e.subUnitId,s,r);this._cache.delete(a)})}),e.type==="set"&&((t=e.oldRule)==null||t.ranges.forEach(n=>{i.Range.foreach(n,(s,r)=>{const a=this._createKey(e.unitId,e.subUnitId,s,r);this._cache.delete(a)})}))})}_createKey(e,t,n,s){return`${e}_${t}_${n}_${s}`}getCellInfo(e,t,n,s){const r=this._selectionProtectionRuleModel.getSubunitRuleList(e,t),a=[];if(!r||!r.length)return a;const c=this._createKey(e,t,n,s),l=this._cache.get(c);if(l)return l;const u=[];for(const d of r)if(d.ranges.some(m=>m.startRow<=n&&m.endRow>=n&&m.startColumn<=s&&m.endColumn>=s)){const m=ie().reduce((h,g)=>{var f;const R=new g(e,t,d.permissionId),C=this._permissionService.getPermissionPoint(R.id);return h[R.subType]=(f=C==null?void 0:C.value)!=null?f:R.value,h},{});u.push({...m,ruleId:d.id,ranges:d.ranges})}return this._cache.set(c,u),u}clear(){this._cache.clear()}};exports.RangeProtectionRenderModel=Su([Ss(0,i.Inject(J)),Ss(1,i.Inject(i.IPermissionService))],exports.RangeProtectionRenderModel);var fu=Object.getOwnPropertyDescriptor,pu=(o,e,t,n)=>{for(var s=n>1?void 0:n?fu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Ln=(o,e)=>(t,n)=>e(t,n,o);exports.RangeProtectionCache=class extends i.Disposable{constructor(t,n,s){super();S(this,"_cellRuleCache",new Map);S(this,"_permissionIdCache",new Map);S(this,"_cellInfoCache",new Map);S(this,"_rowInfoCache",new Map);S(this,"_colInfoCache",new Map);this._ruleModel=t,this._permissionService=n,this._univerInstanceService=s,this._initUpdateCellRuleCache(),this._initUpdateCellInfoCache(),this._initUpdateRowColInfoCache(),this._initCache()}_initCache(){this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(t=>{t.getSheets().forEach(n=>{const s=t.getUnitId(),r=n.getSheetId();this.reBuildCache(s,r)})})}_initUpdateCellInfoCache(){this._permissionService.permissionPointUpdate$.pipe(O.filter(t=>t.type===N.SelectRange),O.map(t=>t)).subscribe(t=>{const{subUnitId:n,unitId:s,permissionId:r}=t,a=this._permissionIdCache.get(r);if(!a)return;const c=this._ruleModel.getRule(s,n,a);if(!c)return;const l=this._ensureCellInfoMap(s,n);c.ranges.forEach(u=>{const{startRow:d,endRow:m,startColumn:h,endColumn:g}=u;for(let R=d;R<=m;R++)for(let C=h;C<=g;C++)l.delete(`${R}-${C}`)})}),this._ruleModel.ruleChange$.subscribe(t=>{var a;const{unitId:n,subUnitId:s}=t,r=this._ensureCellInfoMap(n,s);t.rule.ranges.forEach(c=>{i.Range.foreach(c,(l,u)=>{r.delete(`${l}-${u}`)})}),t.type==="set"&&((a=t.oldRule)==null||a.ranges.forEach(c=>{i.Range.foreach(c,(l,u)=>{this._cellInfoCache.delete(`${l}-${u}`)})}))})}_initUpdateCellRuleCache(){this._ruleModel.ruleChange$.subscribe(t=>{const{type:n}=t;n==="add"?this._addCellRuleCache(t):n==="delete"?this._deleteCellRuleCache(t):(this._deleteCellRuleCache({...t,rule:t.oldRule}),this._addCellRuleCache(t))})}_ensureRuleMap(t,n){let s=this._cellRuleCache.get(t);s||(s=new Map,this._cellRuleCache.set(t,s));let r=s.get(n);return r||(r=new Map,s.set(n,r)),r}_ensureCellInfoMap(t,n){let s=this._cellInfoCache.get(t);s||(s=new Map,this._cellInfoCache.set(t,s));let r=s.get(n);return r||(r=new Map,s.set(n,r)),r}_ensureRowColInfoMap(t,n,s){let r=s==="row"?this._rowInfoCache.get(t):this._colInfoCache.get(t);r||(r=new Map,s==="row"?this._rowInfoCache.set(t,r):this._colInfoCache.set(t,r));let a=r.get(n);return a||(a=new Map,r.set(n,a)),a}_addCellRuleCache(t){const{subUnitId:n,unitId:s,rule:r}=t,a=this._ensureRuleMap(s,n);r.ranges.forEach(c=>{const{startRow:l,endRow:u,startColumn:d,endColumn:m}=c;for(let h=l;h<=u;h++)for(let g=d;g<=m;g++)a.set(`${h}-${g}`,r.id)}),this._permissionIdCache.set(r.permissionId,r.id)}_deleteCellRuleCache(t){const{subUnitId:n,unitId:s,rule:r}=t,a=this._ensureRuleMap(s,n),c=this._ensureCellInfoMap(s,n);r.ranges.forEach(l=>{const{startRow:u,endRow:d,startColumn:m,endColumn:h}=l;for(let g=u;g<=d;g++)for(let R=m;R<=h;R++)a.delete(`${g}-${R}`),c.delete(`${g}-${R}`)}),this._permissionIdCache.delete(r.permissionId)}_getSelectionActions(t,n,s){var d,m,h,g,R,C,f,p,w,I,v,M;const r=(h=(m=this._permissionService.getPermissionPoint((d=new ge(t,n,s.permissionId))==null?void 0:d.id))==null?void 0:m.value)!=null?h:!1,a=(C=(R=this._permissionService.getPermissionPoint((g=new _n(t,n,s.permissionId))==null?void 0:g.id))==null?void 0:R.value)!=null?C:!1,c=(w=(p=this._permissionService.getPermissionPoint((f=new Qo(t,n,s.permissionId))==null?void 0:f.id))==null?void 0:p.value)!=null?w:!1,l=(M=(v=this._permissionService.getPermissionPoint((I=new Zo(t,n,s.permissionId))==null?void 0:I.id))==null?void 0:v.value)!=null?M:!1;return{[y.Edit]:r,[y.View]:a,[y.ManageCollaborator]:c,[y.Delete]:l}}reBuildCache(t,n){const s=this._ensureRuleMap(t,n),r=this._ensureCellInfoMap(t,n);s.clear(),r.clear();const a=this._ensureRowColInfoMap(t,n,"row"),c=this._ensureRowColInfoMap(t,n,"col");a.clear(),c.clear(),this._ruleModel.getSubunitRuleList(t,n).forEach(l=>{const u=this._getSelectionActions(t,n,l),d={...u,ruleId:l.id,ranges:l.ranges};l.ranges.forEach(m=>{const{startRow:h,endRow:g,startColumn:R,endColumn:C}=m;for(let f=h;f<=g;f++){const p=a.get(`${f}`);p?p.set(l.id,u):a.set(`${f}`,new Map([[l.id,u]]));for(let w=R;w<=C;w++){s.set(`${f}-${w}`,l.id),r.set(`${f}-${w}`,d);const I=c.get(`${w}`);I?I.set(l.id,u):c.set(`${w}`,new Map([[l.id,u]]))}}}),this._permissionIdCache.set(l.permissionId,l.id)})}getRowPermissionInfo(t,n,s,r){var l;const a=(l=this._rowInfoCache.get(t))==null?void 0:l.get(n);if(!a)return!0;const c=a.get(`${s}`);return c?r.every(u=>{for(const d of c.values())if(d[u]===!1)return!1;return!0}):!0}getColPermissionInfo(t,n,s,r){var l;const a=(l=this._colInfoCache.get(t))==null?void 0:l.get(n);if(!a)return!0;const c=a.get(`${s}`);return c?r.every(u=>{for(const d of c.values())if(d[u]===!1)return!1;return!0}):!0}_initUpdateRowColInfoCache(){this._permissionService.permissionPointUpdate$.pipe(O.filter(t=>t.type===N.SelectRange),O.map(t=>t)).subscribe({next:t=>{const{subUnitId:n,unitId:s,permissionId:r}=t,a=this._permissionIdCache.get(r);if(!a)return;const c=this._ruleModel.getRule(s,n,a);if(!c)return;const l=this._ensureRowColInfoMap(s,n,"row"),u=this._ensureRowColInfoMap(s,n,"col"),d=this._getSelectionActions(s,n,c);c.ranges.forEach(m=>{const{startRow:h,endRow:g,startColumn:R,endColumn:C}=m;for(let f=h;f<=g;f++){const p=l.get(`${f}`);p?p.set(a,d):l.set(`${f}`,new Map([[a,d]]));for(let w=R;w<=C;w++){const I=u.get(`${w}`);I?I.set(a,d):u.set(`${w}`,new Map([[a,d]]))}}})}}),this._ruleModel.ruleChange$.subscribe(t=>{if(t.type==="delete"){const{unitId:n,subUnitId:s,rule:r}=t,a=this._ensureRowColInfoMap(n,s,"row"),c=this._ensureRowColInfoMap(n,s,"col");r.ranges.forEach(l=>{const{startRow:u,endRow:d,startColumn:m,endColumn:h}=l;for(let g=u;g<=d;g++){const R=a.get(`${g}`);R==null||R.delete(r.id);for(let C=m;C<=h;C++){const f=c.get(`${C}`);f==null||f.delete(r.id)}}})}})}getCellInfo(t,n,s,r){var d,m;const a=this._ensureCellInfoMap(t,n),c=a.get(`${s}-${r}`);if(c)return c;const l=(m=(d=this._cellRuleCache.get(t))==null?void 0:d.get(n))==null?void 0:m.get(`${s}-${r}`);if(!l)return;const u=this._ruleModel.getRule(t,n,l);if(u){const g={...this._getSelectionActions(t,n,u),ruleId:l,ranges:u.ranges};return a.set(`${s}-${r}`,g),g}}deleteUnit(t){this._cellRuleCache.delete(t),this._cellInfoCache.delete(t),this._rowInfoCache.delete(t),this._colInfoCache.delete(t);const n=this._univerInstanceService.getUnit(t);n==null||n.getSheets().forEach(s=>{const r=s.getSheetId();this._ruleModel.getSubunitRuleList(t,r).forEach(a=>{this._permissionIdCache.delete(a.permissionId)})})}};exports.RangeProtectionCache=pu([Ln(0,i.Inject(J)),Ln(1,i.Inject(i.IPermissionService)),Ln(2,i.Inject(i.IUniverInstanceService))],exports.RangeProtectionCache);const Ai="ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY";var Iu=Object.getOwnPropertyDescriptor,vu=(o,e,t,n)=>{for(var s=n>1?void 0:n?Iu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Hn=(o,e)=>(t,n)=>e(t,n,o);let Cn=class extends i.Disposable{constructor(o,e,t){var s;super(),this._commandService=o,this._configService=e,this._dataSyncPrimaryController=t,[H,ce,ae,vt,Be,ve,we,ne,le,nt,F,ts,B,Yo,Lt,xn,At,Ti,Ke,Ye,Ui,ki,Lo].forEach(r=>{var a;this._commandService.registerCommand(r),(a=this._dataSyncPrimaryController)==null||a.registerSyncingMutations(r)}),((s=this._configService.getConfig(Ai))!=null?s:!1)||[$r,wn,kn,Mn,Lr,Fe,je,$t,Ht,Cr,Rr,Sr,fr,Po,ye,Je,ft,dr,ur,hr,mr,ko,Me,Gr,It,ze,pt,No,Yt,Oo,qt,Nn,dn,qr,li,ai,ci,Xr,Jr,Tt,Yr,Kr,hn,Ct,St,Vt,Zr,rt,ei,ke,ti,di,Et,Bt,gn,si,at,jo,qo,Mt,yt,Q,gi,Ot,ii,hi,mi,ui,Ko,Jo,bt,fi,He,On,Xo,Dt,Xn,Te,An,Se,Ae,wi,ut,Ri,ct,Qs,G,Oi,jr,Bo,Go,es,_i,dt,ni,it,Ii,Ge,qe,et,Dn,Ys,oi,Hr,xr,Br,vi,fe,Pe,Z,yi,lt,Ci,Mi,Rt,gt,Pn,wt,bi,zr,Wr,Fr,Ei,Ni,Pi].forEach(r=>this.disposeWithMe(this._commandService.registerCommand(r))),this._configService.setConfig(Di,Ql)}};Cn=vu([Hn(0,i.ICommandService),Hn(1,i.IConfigService),Hn(2,i.Optional(ji.DataSyncPrimaryController))],Cn);var wu=Object.getOwnPropertyDescriptor,Mu=(o,e,t,n)=>{for(var s=n>1?void 0:n?wu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},fs=(o,e)=>(t,n)=>e(t,n,o);let Sn=class extends i.Disposable{constructor(o,e){super(),this._univerInstanceService=o,this._commandService=e,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted(o=>{if(o.id!==Y.SetFormulaCalculationResultMutation.id)return;const e=o.params,{unitData:t}=e,n=Object.keys(t),s=[];for(let a=0;a<n.length;a++){const c=n[a],l=t[c];if(l==null)continue;const u=Object.keys(l);for(let d=0;d<u.length;d++){const m=u[d],h=l[m];if(h==null)continue;const g=this._getMergedCellData(c,m,h),R={subUnitId:m,unitId:c,cellValue:g};s.push({id:H.id,params:R})}}return s.every(a=>this._commandService.executeCommand(a.id,a.params,{onlyLocal:!0,fromFormula:!0}))}))}_getMergedCellData(o,e,t){const n=this._univerInstanceService.getUniverSheetInstance(o),s=n==null?void 0:n.getStyles(),r=n==null?void 0:n.getSheetBySheetId(e),a=r==null?void 0:r.getCellMatrix(),c=new i.ObjectMatrix(t);return c.forValue((l,u,d)=>{const m=a==null?void 0:a.getValue(l,u),h=Y.handleNumfmtInCell(m,d,s);c.setValue(l,u,h)}),c.getMatrix()}};Sn=Mu([fs(0,i.Inject(i.IUniverInstanceService)),fs(1,i.ICommandService)],Sn);var yu=Object.getOwnPropertyDescriptor,_u=(o,e,t,n)=>{for(var s=n>1?void 0:n?yu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},bu=(o,e)=>(t,n)=>e(t,n,o);let fn=class extends i.Disposable{constructor(o){super(),this._sheetInterceptorService=o,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{priority:11,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(o,e,t)=>{var s;if(!o)return t(o);const n=e.workbook.getStyles().getStyleByCell(o);return i.isDefaultFormat((s=n==null?void 0:n.n)==null?void 0:s.pattern)&&(o==null?void 0:o.t)===i.CellValueType.NUMBER&&o.v!==void 0&&o.v!==null&&i.isRealNum(o.v)&&((!o||o===e.rawData)&&(o={...e.rawData}),o.v=Y.stripErrorMargin(Number(o.v))),t(o)}}))}};fn=_u([bu(0,i.Inject(exports.SheetInterceptorService))],fn);var Eu=Object.getOwnPropertyDescriptor,Tu=(o,e,t,n)=>{for(var s=n>1?void 0:n?Eu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},en=(o,e)=>(t,n)=>e(t,n,o);let pn=class extends i.Disposable{constructor(o,e,t,n){super(),this._permissionService=o,this._worksheetProtectionRuleModel=e,this._sheetInterceptorService=t,this._rangeProtectionCache=n,this._initViewModelByRangeInterceptor(),this._initViewModelBySheetInterceptor()}_initViewModelByRangeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(o,e,t)=>{const{unitId:n,subUnitId:s,row:r,col:a}=e,c=this._rangeProtectionCache.getCellInfo(n,s,r,a);if(c){const l=c[y.View]===!1,u=!o||o===e.rawData?{...e.rawData}:o;return u.selectionProtection=[c],l?(delete u.s,delete u.v,delete u.p,u):t(u)}return t(o)}}))}_initViewModelBySheetInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(o,e,t)=>{var a,c,l,u,d;const{unitId:n,subUnitId:s}=e,r=this._worksheetProtectionRuleModel.getRule(n,s);if(r!=null&&r.permissionId){const m=[{[y.View]:(c=(a=this._permissionService.getPermissionPoint(new zt(n,s).id))==null?void 0:a.value)!=null?c:!1,[y.Edit]:(u=(l=this._permissionService.getPermissionPoint(new Re(n,s).id))==null?void 0:l.value)!=null?u:!1}],h=!((d=m[0])!=null&&d[y.View]),g=!o||o===e.rawData?{...o}:o;return g.hasWorksheetRule=!0,g.selectionProtection=m,h?(delete g.s,delete g.v,delete g.p,g):t(g)}return t(o)}}))}};pn=Tu([en(0,i.IPermissionService),en(1,i.Inject(Oe)),en(2,i.Inject(exports.SheetInterceptorService)),en(3,i.Inject(exports.RangeProtectionCache))],pn);const qn=i.createIdentifier("univer.exclusive-range-service");class xi extends i.Disposable{constructor(){super(...arguments);S(this,"_exclusiveRanges",new Map);S(this,"_exclusiveRangesChange$",new O.Subject);S(this,"exclusiveRangesChange$",this._exclusiveRangesChange$.asObservable())}_ensureUnitMap(t){return this._exclusiveRanges.has(t)||this._exclusiveRanges.set(t,new Map),this._exclusiveRanges.get(t)}_ensureSubunitMap(t,n){const s=this._ensureUnitMap(t);return s.has(n)||s.set(n,new Map),s.get(n)}_ensureFeature(t,n,s){const r=this._ensureSubunitMap(t,n);return r.has(s)||r.set(s,[]),r.get(s)}addExclusiveRange(t,n,s,r){const a=this._ensureFeature(t,n,s);a.push(...r),this._exclusiveRangesChange$.next({unitId:t,subUnitId:n,ranges:a.map(c=>c.range)})}getExclusiveRanges(t,n,s){var r,a;return(a=(r=this._exclusiveRanges.get(t))==null?void 0:r.get(n))==null?void 0:a.get(s)}clearExclusiveRanges(t,n,s){const r=this.getExclusiveRanges(t,n,s);this._exclusiveRangesChange$.next({unitId:t,subUnitId:n,ranges:(r==null?void 0:r.map(a=>a.range))||[]}),this._ensureFeature(t,n,s),this._exclusiveRanges.get(t).get(n).set(s,[])}clearExclusiveRangesByGroupId(t,n,s,r){const a=this.getExclusiveRanges(t,n,s);this._exclusiveRangesChange$.next({unitId:t,subUnitId:n,ranges:(a==null?void 0:a.map(l=>l.range))||[]});const c=this.getExclusiveRanges(t,n,s);if(c){const l=c.filter(u=>u.groupId!==r);this._exclusiveRanges.get(t).get(n).set(s,l)}}getInterestGroupId(t){const n=[];return t.forEach(s=>{var u;const r=s.range,{unitId:a,sheetId:c}=r;if(!a||!c)return;const l=(u=this._exclusiveRanges.get(a))==null?void 0:u.get(c);if(l)for(const d of l.keys()){const m=l.get(d);if(m){for(const h of m)if(i.Rectangle.intersects(r,h.range)){n.push(d);break}}}}),n}}var Uu=Object.getOwnPropertyDescriptor,ku=(o,e,t,n)=>{for(var s=n>1?void 0:n?Uu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Bn=(o,e)=>(t,n)=>e(t,n,o);exports.NumfmtService=class extends i.Disposable{constructor(e,t,n){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._logService=n}getValue(e,t,n,s){const r=this._univerInstanceService.getUniverSheetInstance(e);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(t);if(!a)return;const c=r.getStyles(),l=a.getCellRaw(n,s);if(l!=null&&l.s){const u=c.get(l.s);if(u!=null&&u.n)return u.n}return null}deleteValues(e,t,n){const s=this._univerInstanceService.getUniverSheetInstance(e);if(!s)return;const r=s==null?void 0:s.getSheetBySheetId(t);if(!r)return;const a=s.getStyles();n.forEach(c=>{i.Range.foreach(c,(l,u)=>{const d=r.getCellRaw(l,u);if(!d)return;const m=d==null?void 0:d.s,g={...m&&a.get(m)||{}};delete g.n;const R=a.setValue(g);d.s=R})})}setValues(e,t,n){const s=this._univerInstanceService.getUniverSheetInstance(e);if(!s)return;const r=s==null?void 0:s.getSheetBySheetId(t);if(!r)return;const a=s.getStyles(),c=r.getCellMatrix();n.forEach(l=>{l.ranges.forEach(u=>{i.Range.foreach(u,(d,m)=>{const h=r.getCellRaw(d,m);if(h){const R={...a.getStyleByCell(h)||{},n:{pattern:l.pattern}},C=a.setValue(R);h.s=C}else{const g={n:{pattern:l.pattern}},R=a.setValue(g);R&&c.setValue(d,m,{s:R})}})})})}};exports.NumfmtService=ku([Bn(0,i.IResourceManagerService),Bn(1,i.IUniverInstanceService),Bn(2,i.ILogService)],exports.NumfmtService);var Pu=Object.getOwnPropertyDescriptor,Nu=(o,e,t,n)=>{for(var s=n>1?void 0:n?Pu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Ve=(o,e)=>(t,n)=>e(t,n,o);const ps=[ce.id,ae.id,ne.id,le.id],Is=[ve.id,we.id];exports.RangeProtectionRefRangeService=class extends i.Disposable{constructor(t,n,s,r,a,c,l,u){super();S(this,"disposableCollection",new i.DisposableCollection);this._selectionProtectionRuleModel=t,this._univerInstanceService=n,this._commandService=s,this._refRangeService=r,this._selectionProtectionRenderModel=a,this._rangeProtectionCache=c,this._sheetInterceptorService=l,this._rangeProtectionRuleModel=u,this._onRefRangeChange(),this._correctPermissionRange(),this._initReBuildCache(),this._initRemoveSheet()}_onRefRangeChange(){const t=(s,r)=>{const a=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!a||!(a==null?void 0:a.getSheetBySheetId(r)))return;this.disposableCollection.dispose();const l=d=>this.refRangeHandle(d,s,r);this._selectionProtectionRuleModel.getSubunitRuleList(s,r).reduce((d,m)=>[...d,...m.ranges],[]).forEach(d=>{this.disposableCollection.add(this._refRangeService.registerRefRange(d,l,s,r))})};this.disposeWithMe(this._commandService.onCommandExecuted(s=>{if(s.id===Jo.id){const r=s.params,a=r.subUnitId,c=r.unitId;if(!a||!c)return;t(c,a)}if(s.id===Z.id||s.id===fe.id){const r=s.params,a=r.subUnitId,c=r.unitId;if(!a||!c)return;t(c,a)}}));const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(n){const s=n.getActiveSheet();if(!s)return;t(n.getUnitId(),s.getSheetId())}}refRangeHandle(t,n,s){switch(t.id){case pt.id:return this._getRefRangeMutationsByMoveRows(t.params,n,s);case It.id:return this._getRefRangeMutationsByMoveCols(t.params,n,s);case Me.id:return this._getRefRangeMutationsByInsertRows(t.params,n,s);case ye.id:return this._getRefRangeMutationsByInsertCols(t.params,n,s);case Yt.id:return this._getRefRangeMutationsByDeleteCols(t.params,n,s);case qt.id:return this._getRefRangeMutationsByDeleteRows(t.params,n,s)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(t,n,s){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(c=>c.ranges.some(l=>i.Rectangle.intersects(l,t.range))),a=t.range;if(r.length){const c=[],l=[];return r.forEach(u=>{const d=i.Tools.deepClone(u),m=d.ranges.reduce((h,g)=>{if(i.Rectangle.intersects(g,a)){const R=i.Tools.deepClone(g),{startColumn:C,endColumn:f}=a;if(C<=R.startColumn&&f>=R.endColumn)return h;C>=R.startColumn&&f<=R.endColumn?R.endColumn-=f-C+1:C<R.startColumn?(R.startColumn=C,R.endColumn-=f-C+1):f>R.endColumn&&(R.endColumn=C-1),this._checkIsRightRange(R)&&h.push(R)}return h},[]);d.ranges=m,d.ranges.length?(c.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:u.id}}),l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:u,ruleId:u.id}})):(c.push({id:Pe.id,params:{unitId:n,subUnitId:s,ruleIds:[u.id]}}),l.push({id:fe.id,params:{unitId:n,subUnitId:s,name:"",rules:[u]}}))}),{redos:c,undos:l}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(t,n,s){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(c=>c.ranges.some(l=>i.Rectangle.intersects(l,t.range))),a=t.range;if(r.length){const c=[],l=[];return r.forEach(u=>{const d=i.Tools.deepClone(u),m=d.ranges.reduce((h,g)=>{if(i.Rectangle.intersects(g,a)){const R=i.Tools.deepClone(g),{startRow:C,endRow:f}=a;if(C<=R.startRow&&f>=R.endRow)return h;C>=R.startRow&&f<=R.endRow?R.endRow-=f-C+1:C<R.startRow?(R.startRow=C,R.endRow-=f-C+1):f>R.endRow&&(R.endRow=C-1),this._checkIsRightRange(R)&&h.push(R)}return h},[]);d.ranges=m,c.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:u.id}}),l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:u,ruleId:u.id}})}),{redos:c,undos:l}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(t,n,s){const r=t.range.startColumn,a=t.range.endColumn-t.range.startColumn+1,c=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(l=>l.ranges.some(u=>r>u.startColumn&&r<=u.endColumn));if(c.length){const l=[],u=[];return c.forEach(d=>{const m=i.Tools.deepClone(d);let h=!1;m.ranges.forEach(g=>{r>g.startColumn&&r<=g.endColumn&&(g.endColumn+=a,h=!0)}),h&&(l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:d.id}}),u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:d.id}}))}),{redos:l,undos:u}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(t,n,s){const r=t.range.startRow,a=t.range.endRow-t.range.startRow+1,c=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(l=>l.ranges.some(u=>r>u.startRow&&r<=u.endRow));if(c.length){const l=[],u=[];return c.forEach(d=>{const m=i.Tools.deepClone(d);let h=!1;m.ranges.forEach(g=>{r>g.startRow&&r<=g.endRow&&(g.endRow+=a,h=!0)}),h&&(l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:d.id}}),u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:d.id}}))}),{redos:l,undos:u}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(t,n,s){const r=t.toRange,a=r.startRow,c=r.endRow-r.startRow+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(u=>u.ranges.some(d=>a>d.startRow&&a<=d.endRow));if(l.length){const u=[],d=[];return l.forEach(m=>{const h=i.Tools.deepClone(m),R=t.fromRange.startRow;let C=!1;h.ranges.forEach(f=>{a>f.startRow&&a<=f.endRow&&(R<f.startRow&&(f.startRow=f.startRow-c,f.endRow=f.endRow-c),f.endRow+=c,C=!0)}),C&&(u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:h,ruleId:m.id}}),d.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:m.id}}))}),{redos:u,undos:d}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(t,n,s){const r=t.toRange,a=r.startColumn,c=r.endColumn-r.startColumn+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(u=>u.ranges.some(d=>a>d.startColumn&&a<=d.endColumn));if(l.length){const u=[],d=[];return l.forEach(m=>{const h=i.Tools.deepClone(m),R=t.fromRange.startColumn;let C=!1;h.ranges.forEach(f=>{a>f.startColumn&&a<=f.endColumn&&(R<f.startColumn&&(f.startColumn=f.startColumn-c,f.endColumn=f.endColumn-c),f.endColumn+=c,C=!0)}),C&&(u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:h,ruleId:m.id}}),d.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:m.id}}))}),{redos:u,undos:d}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(Is.includes(t.id)){if(!t.params)return;const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!n)return;const s=n.getSheetBySheetId(t.params.subUnitId);if(!s)return;const{sourceRange:r,targetRange:a}=t.params,c=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,l=c?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,u=c?r.startRow:r.startColumn,d=c?a.startRow:a.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),s.getSheetId()).forEach(f=>{f.ranges.forEach(w=>{let{startRow:I,endRow:v,startColumn:M,endColumn:_}=w;i.Rectangle.intersects(w,r)||(c?u<I&&d>v?(I-=l,v-=l):u>v&&d<=I&&(I+=l,v+=l):u<M&&d>_?(M-=l,_-=l):u>_&&d<=M&&(M+=l,_+=l)),this._checkIsRightRange({startRow:I,endRow:v,startColumn:M,endColumn:_})&&(w.startColumn=M,w.endColumn=_,w.startRow=I,w.endRow=v)})}),this.disposableCollection.dispose();const{unitId:h,subUnitId:g}=t.params,R=f=>this.refRangeHandle(f,h,g);this._selectionProtectionRuleModel.getSubunitRuleList(h,g).reduce((f,p)=>[...f,...p.ranges],[]).forEach(f=>{this.disposableCollection.add(this._refRangeService.registerRefRange(f,R,h,g))}),this._selectionProtectionRenderModel.clear()}if(ps.includes(t.id)){const n=this._univerInstanceService.getUniverSheetInstance(t.params.unitId);if(!n)return;const s=n.getSheetBySheetId(t.params.subUnitId);if(!s)return;const r=t.params;if(!r)return;const{range:a}=r,c=t.id.includes("row"),l=t.id.includes("insert"),u=c?a.startRow:a.startColumn,d=c?a.endRow:a.endColumn,m=d-u+1;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),s.getSheetId()).forEach(p=>{p.ranges.forEach(I=>{let{startRow:v,endRow:M,startColumn:_,endColumn:b}=I;l?c?u<=v&&(v+=m,M+=m):u<=_&&(_+=m,b+=m):c?d<v&&(v-=m,M-=m):d<_&&(_-=m,b-=m),this._checkIsRightRange({startRow:v,endRow:M,startColumn:_,endColumn:b})&&(I.startColumn=_,I.endColumn=b,I.startRow=v,I.endRow=M)})}),this.disposableCollection.dispose();const{unitId:g,subUnitId:R}=t.params,C=p=>this.refRangeHandle(p,g,R);this._selectionProtectionRuleModel.getSubunitRuleList(g,R).reduce((p,w)=>[...p,...w.ranges],[]).forEach(p=>{this.disposableCollection.add(this._refRangeService.registerRefRange(p,C,g,R))}),this._selectionProtectionRenderModel.clear()}}))}_checkIsRightRange(t){return t.startRow<=t.endRow&&t.startColumn<=t.endColumn}_initReBuildCache(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(ps.includes(t.id)||Is.includes(t.id)){const{unitId:n,subUnitId:s}=t.params;this._rangeProtectionCache.reBuildCache(n,s)}}))}_initRemoveSheet(){this._sheetInterceptorService.interceptCommand({getMutations:t=>{const n=[],s=[],r=[],a=[];if(t.id===Nn.id){const c=t.params,l=[],u=[];this._rangeProtectionRuleModel.getSubunitRuleList(c.unitId,c.subUnitId).forEach(d=>{l.push(d.id),u.push(d)}),l.length&&u.length&&(r.push({id:Pe.id,params:{unitId:c.unitId,subUnitId:c.subUnitId,ruleIds:l}}),n.push({id:fe.id,params:{unitId:c.unitId,subUnitId:c.subUnitId,name:"",rules:u}}))}return{redos:s,undos:n,preRedos:r,preUndos:a}}})}};exports.RangeProtectionRefRangeService=Nu([Ve(0,i.Inject(J)),Ve(1,i.Inject(i.IUniverInstanceService)),Ve(2,i.ICommandService),Ve(3,i.Inject(exports.RefRangeService)),Ve(4,i.Inject(exports.RangeProtectionRenderModel)),Ve(5,i.Inject(exports.RangeProtectionCache)),Ve(6,i.Inject(exports.SheetInterceptorService)),Ve(7,i.Inject(J))],exports.RangeProtectionRefRangeService);var Ou=Object.getOwnPropertyDescriptor,Du=(o,e,t,n)=>{for(var s=n>1?void 0:n?Ou(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Pt=(o,e)=>(t,n)=>e(t,n,o);const Au="SHEET_RANGE_PROTECTION_PLUGIN";exports.RangeProtectionService=class extends i.Disposable{constructor(e,t,n,s,r){super(),this._selectionProtectionRuleModel=e,this._permissionService=t,this._resourceManagerService=n,this._selectionProtectionCache=s,this._univerInstanceService=r,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":{ie().forEach(t=>{const n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(n)});break}case"delete":{ie().forEach(t=>{const n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.deletePermissionPoint(n.id)});break}case"set":{e.oldRule.permissionId!==e.rule.permissionId&&ie().forEach(t=>{const n=new t(e.unitId,e.subUnitId,e.oldRule.permissionId);this._permissionService.deletePermissionPoint(n.id);const s=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(s)});break}}}))}_initSnapshot(){const e=n=>{const r=this._selectionProtectionRuleModel.toObject()[n];return r?JSON.stringify(r):""},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:Au,businesses:[cn.UNIVER_SHEET],onLoad:(n,s)=>{const r=this._selectionProtectionRuleModel.toObject();r[n]=s,this._selectionProtectionRuleModel.fromObject(r);const a=[];Object.keys(s).forEach(c=>{const l=s[c];this._selectionProtectionRuleModel.getSubunitRuleList(n,c).forEach(u=>{a.push({objectID:u.permissionId,unitID:n,objectType:N.SelectRange,actions:Le})}),l.forEach(u=>{ie().forEach(d=>{const m=new d(n,c,u.permissionId);m.value=!1,this._permissionService.addPermissionPoint(m)})}),this._selectionProtectionCache.reBuildCache(n,c)})},onUnLoad:n=>{this._selectionProtectionCache.deleteUnit(n)}}))}};exports.RangeProtectionService=Du([Pt(0,i.Inject(J)),Pt(1,i.Inject(i.IPermissionService)),Pt(2,i.Inject(i.IResourceManagerService)),Pt(3,i.Inject(exports.RangeProtectionCache)),Pt(4,i.Inject(i.IUniverInstanceService))],exports.RangeProtectionService);var xu=Object.getOwnPropertyDescriptor,Wu=(o,e,t,n)=>{for(var s=n>1?void 0:n?xu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},$u=(o,e)=>(t,n)=>e(t,n,o);exports.SheetRangeThemeService=class extends i.Disposable{constructor(e){super(),this._sheetRangeThemeModel=e}registerRangeTheme(e,t){this._sheetRangeThemeModel.registerRangeThemeStyle(e,t)}removeRangeThemeRule(e,t){this._sheetRangeThemeModel.removeRangeThemeRule(e,t)}getALLRegisterThemes(e){return this._sheetRangeThemeModel.getALLRegisteredTheme(e)}registerRangeThemeStyle(e,t){this._sheetRangeThemeModel.registerRangeThemeRule(e,t)}getAppliedRangeThemeStyle(e){return this._sheetRangeThemeModel.getRegisteredRangeThemeStyle(e)}getRegisteredRangeThemes(){return this._sheetRangeThemeModel.getRegisteredRangeThemes()}};exports.SheetRangeThemeService=Wu([$u(0,i.Inject(exports.SheetRangeThemeModel))],exports.SheetRangeThemeService);var Vu=Object.defineProperty,Lu=Object.getOwnPropertyDescriptor,Hu=(o,e,t)=>e in o?Vu(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,Bu=(o,e,t,n)=>{for(var s=n>1?void 0:n?Lu(e,t):e,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},vs=(o,e)=>(t,n)=>e(t,n,o),Wi=(o,e,t)=>Hu(o,typeof e!="symbol"?e+"":e,t);const Fu="SHEET_PLUGIN";exports.UniverSheetsPlugin=class extends i.Plugin{constructor(e=gs,t,n){super(),this._config=e,this._injector=t,this._configService=n;const{...s}=i.merge({},gs,this._config);this._configService.setConfig(Xt,s),this._initConfig(),this._initDependencies()}_initConfig(){var e,t,n;(e=this._config)!=null&&e.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig(Ai,!0),(t=this._config)!=null&&t.isRowStylePrecedeColumnStyle&&this._configService.setConfig(i.IS_ROW_STYLE_PRECEDE_COLUMN_STYLE,!0),(n=this._config)!=null&&n.autoHeightForMergedCells&&this._configService.setConfig(i.AUTO_HEIGHT_FOR_MERGED_CELLS,!0)}_initDependencies(){var t;const e=[[ot],[exports.SheetLazyExecuteScheduleService],[exports.SheetsSelectionsService],[exports.RefRangeService],[exports.WorkbookPermissionService],[tt,{useClass:exports.NumfmtService}],[exports.SheetInterceptorService],[exports.SheetRangeThemeService],[exports.SheetSkeletonService],[Cn],[exports.MergeCellController],[fn],[exports.DefinedNameDataController],[exports.ZebraCrossingCacheController],[exports.SheetsFreezeSyncController],[exports.WorksheetPermissionService],[Oe],[Ut],[pn],[exports.SheetPermissionInitController],[exports.SheetPermissionCheckController],[exports.SheetRangeThemeModel],[exports.RangeProtectionRenderModel],[J],[exports.RangeProtectionCache],[exports.RangeProtectionRefRangeService],[exports.RangeProtectionService],[qn,{useClass:xi,deps:[exports.SheetsSelectionsService]}]];(t=this._config)!=null&&t.notExecuteFormula||e.push([Sn]),i.registerDependencies(this._injector,i.mergeOverrideWithDependencies(e,this._config.override)),i.touchDependencies(this._injector,[[exports.SheetInterceptorService],[exports.RangeProtectionService],[qn],[exports.SheetPermissionInitController],[exports.SheetsFreezeSyncController]])}onStarting(){i.touchDependencies(this._injector,[[Cn],[exports.MergeCellController],[exports.WorkbookPermissionService],[exports.WorksheetPermissionService],[pn],[exports.SheetSkeletonService]])}onRendered(){i.touchDependencies(this._injector,[[tt]])}onReady(){i.touchDependencies(this._injector,[[Sn],[exports.DefinedNameDataController],[exports.ZebraCrossingCacheController],[exports.SheetRangeThemeModel],[fn],[exports.RangeProtectionRenderModel],[exports.RangeProtectionRefRangeService],[exports.RefRangeService],[exports.SheetPermissionCheckController]])}};Wi(exports.UniverSheetsPlugin,"pluginName",Fu);Wi(exports.UniverSheetsPlugin,"type",i.UniverInstanceType.UNIVER_SHEET);exports.UniverSheetsPlugin=Bu([i.DependentOn(Y.UniverFormulaEnginePlugin),vs(1,i.Inject(i.Injector)),vs(2,i.IConfigService)],exports.UniverSheetsPlugin);const ju={WorkbookCommentPermission:to,WorkbookCopyPermission:no,WorkbookCreateProtectPermission:oo,WorkbookCreateSheetPermission:so,WorkbookDeleteSheetPermission:ro,WorkbookDuplicatePermission:io,WorkbookEditablePermission:ue,WorkbookExportPermission:ao,WorkbookHideSheetPermission:bn,WorkbookHistoryPermission:sr,WorkbookManageCollaboratorPermission:En,WorkbookMoveSheetPermission:Tn,WorkbookPrintPermission:co,WorkbookRecoverHistoryPermission:lo,WorkbookRenameSheetPermission:Un,WorkbookSharePermission:uo,WorkbookViewHistoryPermission:ho,WorkbookViewPermission:mo,WorksheetCopyPermission:go,WorksheetDeleteColumnPermission:Ro,WorksheetDeleteProtectionPermission:Co,WorksheetDeleteRowPermission:So,WorksheetEditExtraObjectPermission:fo,WorksheetEditPermission:Re,WorksheetFilterPermission:po,WorksheetInsertColumnPermission:Io,WorksheetInsertHyperlinkPermission:vo,WorksheetInsertRowPermission:wo,WorksheetManageCollaboratorPermission:Mo,WorksheetPivotTablePermission:yo,WorksheetSetCellStylePermission:_o,WorksheetSetCellValuePermission:xt,WorksheetSetColumnStylePermission:mt,WorksheetSetRowStylePermission:ht,WorksheetSortPermission:bo,WorksheetViewPermission:zt,RangeProtectionPermissionEditPoint:ge,RangeProtectionPermissionViewPoint:_n},Gu=(o,e,t,n)=>{const s=o.get(i.IPermissionService),r=o.get(J),a=s.getPermissionPoint(new ue(e).id);if(!(a!=null&&a.value))return!1;const c=s.getPermissionPoint(new Re(e,t).id);if(!(c!=null&&c.value))return!1;const u=r.getSubunitRuleList(e,t).filter(d=>d.ranges.some(m=>n.some(h=>i.Rectangle.intersects(m,h))));return u.length?u.every(d=>{const m=d.permissionId,h=s.getPermissionPoint(new ge(e,t,m).id);return!!(h!=null&&h.value)}):!0},$i=(o,e,t,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,e),{startRow:c,endRow:l}=a;let u=t.startRow-n,d=e.getMergedCell(u,t.startColumn),m=!d||d.startRow===u&&d.startColumn===t.startColumn;for(;!e.getRowVisible(u)||!m;)u--,d=e.getMergedCell(u,t.startColumn),m=!d||d.startRow===u&&d.startColumn===t.startColumn;if(u>=c)return{...t,startRow:u,endRow:u};if(r){const h={...t,startRow:l,endRow:l};return Li(o,e,h,n,s,!1)}},Vi=(o,e,t,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,e),{startRow:c,endRow:l}=a;let u=t.endRow+n,d=e.getMergedCell(u,t.startColumn),m=!d||d.startRow===u&&d.startColumn===t.startColumn;for(;!e.getRowVisible(u)||!m;)u++,d=e.getMergedCell(u,t.startColumn),m=!d||d.startRow===u&&d.startColumn===t.startColumn;if(u<=l)return{...t,startRow:u,endRow:u};if(r){const h={...t,startRow:c,endRow:c};return Hi(o,e,h,n,s,!1)}},Li=(o,e,t,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,e),{startColumn:c,endColumn:l}=a;let u=t.startColumn-n,d=e.getMergedCell(t.startRow,u),m=!d||d.startRow===t.startRow&&d.startColumn===u;for(;!e.getColVisible(u)||!m;)u--,d=e.getMergedCell(t.startRow,u),m=!d||d.startRow===t.startRow&&d.startColumn===u;if(u>=c)return{...t,startColumn:u,endColumn:u};if(r){const h={...t,startColumn:l,endColumn:l};return $i(o,e,h,n,s,!1)}},Hi=(o,e,t,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,e),{startColumn:c,endColumn:l}=a;let u=t.endColumn+n,d=e.getMergedCell(t.startRow,u),m=!d||d.startRow===t.startRow&&d.startColumn===u;for(;!e.getColVisible(u)||!m;)u++,d=e.getMergedCell(t.startRow,u),m=!d||d.startRow===t.startRow&&d.startColumn===u;if(u<=l)return{...t,endColumn:u,startColumn:u};if(r){const h={...t,startColumn:c,endColumn:c};return Vi(o,e,h,n,s,!1)}};function tn(o,e,t){let n=null;return t.getMatrixWithMergedCells(o,e,o,e).forValue((r,a,c)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:c.rowSpan!==void 0||c.colSpan!==void 0,isMergedMainCell:c.rowSpan!==void 0&&c.colSpan!==void 0,endRow:r+(c.rowSpan!==void 0?c.rowSpan-1:0),endColumn:a+(c.colSpan!==void 0?c.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:e,actualRow:o,startRow:o,startColumn:e,endRow:o,endColumn:e,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}const zu=(o,e,t,n,s=1)=>{switch(n){case i.Direction.UP:return $i(o,e,t,s);case i.Direction.DOWN:return Vi(o,e,t,s);case i.Direction.LEFT:return Li(o,e,t,s);case i.Direction.RIGHT:return Hi(o,e,t,s)}},qu=(o,e,t)=>{let n,s=-1,r;for(let p=0;p<o.length;p++)if(o[p].primary){n=o[p],s=p,r=n.primary;break}if(s===-1)return null;const a=e===i.Direction.LEFT||e===i.Direction.UP,c=a?s-1>=0?s-1:o.length-1:s+1<o.length?s+1:0,l=o[c];if(!n||!r)return null;const u={...r},{startRow:d,startColumn:m,endRow:h,endColumn:g}=n.range,R=a?u.startRow===d&&u.startColumn===m:u.endRow===h&&u.endColumn===g,C=R&&a;if(!i.Rectangle.equals(n.range,u)){const p=R?l.range:zu(n.range,t,u,e);if(!p)return null;const w=C?tn(p.endRow,p.endColumn,t):tn(p.startRow,p.startColumn,t);return{startRow:w.startRow,startColumn:w.startColumn,endRow:w.endRow,endColumn:w.endColumn}}const f=C?tn(l.range.endRow,l.range.endColumn,t):tn(l.range.startRow,l.range.startColumn,t);return{startRow:f.startRow,startColumn:f.startColumn,endRow:f.endRow,endColumn:f.endColumn}};exports.AFTER_CELL_EDIT=nn;exports.AddMergeRedoSelectionsOperationFactory=Xl;exports.AddMergeUndoMutationFactory=he;exports.AddMergeUndoSelectionsOperationFactory=Zl;exports.AddRangeProtectionCommand=Ys;exports.AddRangeProtectionMutation=fe;exports.AddRangeThemeMutation=Ei;exports.AddWorksheetMergeAllCommand=al;exports.AddWorksheetMergeCommand=Jt;exports.AddWorksheetMergeHorizontalCommand=ll;exports.AddWorksheetMergeMutation=B;exports.AddWorksheetMergeVerticalCommand=cl;exports.AddWorksheetProtectionCommand=xr;exports.AddWorksheetProtectionMutation=Ge;exports.AppendRowCommand=$r;exports.BEFORE_CELL_EDIT=jn;exports.BorderStyleManagerService=ot;exports.COMMAND_LISTENER_SKELETON_CHANGE=Oa;exports.COMMAND_LISTENER_VALUE_CHANGE=Da;exports.CancelFrozenCommand=ti;exports.CancelMarkDirtyRowAutoHeightMutation=ki;exports.ClearSelectionAllCommand=wn;exports.ClearSelectionContentCommand=kn;exports.ClearSelectionFormatCommand=Mn;exports.CopySheetCommand=Lr;exports.CopyWorksheetEndMutation=Lo;exports.DISABLE_NORMAL_SELECTIONS=lc;exports.DeleteRangeMoveLeftCommand=Fe;exports.DeleteRangeMoveUpCommand=je;exports.DeleteRangeProtectionCommand=Hr;exports.DeleteRangeProtectionMutation=Pe;exports.DeleteWorksheetProtectionCommand=Br;exports.DeleteWorksheetProtectionMutation=et;exports.DeleteWorksheetRangeThemeStyleCommand=Fr;exports.DeleteWorksheetRangeThemeStyleMutation=Rt;exports.DeleteWorksheetRangeThemeStyleMutationFactory=bs;exports.DeltaColumnWidthCommand=$t;exports.DeltaRowHeightCommand=Ht;exports.EditStateEnum=qs;exports.EffectRefRangId=D;exports.EmptyMutation=Ti;exports.ExclusiveRangeService=xi;exports.FactoryAddRangeProtectionMutation=rc;exports.FactoryDeleteRangeProtectionMutation=sc;exports.FactorySetRangeProtectionMutation=El;exports.IExclusiveRangeService=qn;exports.INTERCEPTOR_POINT=De;exports.INumfmtService=tt;exports.IRefSelectionsService=Xs;exports.InsertColAfterCommand=Cr;exports.InsertColBeforeCommand=Rr;exports.InsertColByRangeCommand=Po;exports.InsertColCommand=ye;exports.InsertColMutation=ce;exports.InsertColMutationUndoFactory=Ft;exports.InsertDefinedNameCommand=jr;exports.InsertMultiColsLeftCommand=Sr;exports.InsertMultiColsRightCommand=fr;exports.InsertMultiRowsAboveCommand=mr;exports.InsertMultiRowsAfterCommand=hr;exports.InsertRangeMoveDownCommand=Je;exports.InsertRangeMoveRightCommand=ft;exports.InsertRowAfterCommand=dr;exports.InsertRowBeforeCommand=ur;exports.InsertRowByRangeCommand=ko;exports.InsertRowCommand=Me;exports.InsertRowMutation=ae;exports.InsertRowMutationUndoFactory=In;exports.InsertSheetCommand=Gr;exports.InsertSheetMutation=vt;exports.InsertSheetUndoMutationFactory=Ho;exports.InterceptCellContentPriority=ws;exports.MAX_CELL_PER_SHEET_KEY=Di;exports.MERGE_CELL_INTERCEPTOR_CHECK=Ar;exports.MarkDirtyRowAutoHeightMutation=Ui;exports.MoveColsCommand=It;exports.MoveColsMutation=we;exports.MoveColsMutationUndoFactory=Ts;exports.MoveRangeCommand=ze;exports.MoveRangeMutation=Be;exports.MoveRowsCommand=pt;exports.MoveRowsMutation=ve;exports.MoveRowsMutationUndoFactory=Es;exports.OperatorType=L;exports.PermissionPointsDefinitions=ju;exports.REF_SELECTIONS_ENABLED=Js;exports.RangeMergeUtil=ja;exports.RangeProtectionPermissionDeleteProtectionPoint=Zo;exports.RangeProtectionPermissionEditPoint=ge;exports.RangeProtectionPermissionManageCollaPoint=Qo;exports.RangeProtectionPermissionViewPoint=_n;exports.RangeProtectionRuleModel=J;exports.RangeThemeStyle=xe;exports.RegisterWorksheetRangeThemeStyleCommand=zr;exports.RegisterWorksheetRangeThemeStyleMutation=wt;exports.RemoveColByRangeCommand=Oo;exports.RemoveColCommand=Yt;exports.RemoveColMutation=ne;exports.RemoveDefinedNameCommand=Bo;exports.RemoveMergeUndoMutationFactory=se;exports.RemoveNumfmtMutation=ts;exports.RemoveRangeThemeMutation=Pi;exports.RemoveRowByRangeCommand=No;exports.RemoveRowCommand=qt;exports.RemoveRowMutation=le;exports.RemoveSheetCommand=Nn;exports.RemoveSheetMutation=nt;exports.RemoveSheetUndoMutationFactory=pr;exports.RemoveWorksheetMergeCommand=qr;exports.RemoveWorksheetMergeMutation=F;exports.ReorderRangeCommand=dn;exports.ReorderRangeMutation=At;exports.ReorderRangeUndoMutationFactory=Us;exports.ResetBackgroundColorCommand=li;exports.ResetTextColorCommand=ai;exports.SCOPE_WORKBOOK_VALUE_DEFINED_NAME=ou;exports.SELECTIONS_ENABLED=uc;exports.SELECTION_CONTROL_BORDER_BUFFER_COLOR=za;exports.SELECTION_CONTROL_BORDER_BUFFER_WIDTH=Ga;exports.SHEETS_PLUGIN_CONFIG_KEY=Xt;exports.ScrollToCellOperation=Oi;exports.SelectRangeCommand=Qs;exports.SelectionMoveType=ee;exports.SetBackgroundColorCommand=ci;exports.SetBoldCommand=Pl;exports.SetBorderBasicCommand=Xr;exports.SetBorderColorCommand=Jr;exports.SetBorderCommand=Tt;exports.SetBorderPositionCommand=Yr;exports.SetBorderStyleCommand=Kr;exports.SetColDataCommand=Zr;exports.SetColDataMutation=rt;exports.SetColDataMutationFactory=ks;exports.SetColHiddenCommand=hn;exports.SetColHiddenMutation=Ct;exports.SetColVisibleMutation=St;exports.SetColWidthCommand=Vt;exports.SetDefinedNameCommand=Go;exports.SetFontFamilyCommand=xl;exports.SetFontSizeCommand=Wl;exports.SetFrozenCommand=ei;exports.SetFrozenMutation=ke;exports.SetFrozenMutationFactory=zo;exports.SetGridlinesColorCommand=ni;exports.SetGridlinesColorMutation=it;exports.SetHorizontalTextAlignCommand=di;exports.SetItalicCommand=Nl;exports.SetNumfmtMutation=xn;exports.SetOverlineCommand=Al;exports.SetProtectionCommand=oi;exports.SetRangeProtectionMutation=Z;exports.SetRangeThemeMutation=Ni;exports.SetRangeValuesCommand=Et;exports.SetRangeValuesMutation=H;exports.SetRangeValuesUndoMutationFactory=me;exports.SetRowDataCommand=si;exports.SetRowDataMutation=at;exports.SetRowDataMutationFactory=Ns;exports.SetRowHeightCommand=Bt;exports.SetRowHiddenCommand=gn;exports.SetRowHiddenMutation=Ke;exports.SetRowVisibleMutation=Ye;exports.SetSelectedColsVisibleCommand=jo;exports.SetSelectedRowsVisibleCommand=qo;exports.SetSelectionsOperation=G;exports.SetSpecificColsVisibleCommand=Mt;exports.SetSpecificRowsVisibleCommand=yt;exports.SetStrikeThroughCommand=Dl;exports.SetStyleCommand=Q;exports.SetTabColorCommand=gi;exports.SetTabColorMutation=Ot;exports.SetTextColorCommand=ii;exports.SetTextRotationCommand=hi;exports.SetTextWrapCommand=mi;exports.SetUnderlineCommand=Ol;exports.SetVerticalTextAlignCommand=ui;exports.SetWorkbookNameCommand=Ko;exports.SetWorkbookNameMutation=Yo;exports.SetWorksheetActivateCommand=Jo;exports.SetWorksheetActiveOperation=bt;exports.SetWorksheetColWidthMutation=Ae;exports.SetWorksheetColWidthMutationFactory=Kn;exports.SetWorksheetColumnCountCommand=Ri;exports.SetWorksheetColumnCountMutation=ct;exports.SetWorksheetColumnCountUndoMutationFactory=Os;exports.SetWorksheetDefaultStyleCommand=Ci;exports.SetWorksheetDefaultStyleMutation=lt;exports.SetWorksheetDefaultStyleMutationFactory=Ds;exports.SetWorksheetHideCommand=fi;exports.SetWorksheetHideMutation=He;exports.SetWorksheetNameCommand=On;exports.SetWorksheetNameMutation=Lt;exports.SetWorksheetOrderCommand=Xo;exports.SetWorksheetOrderMutation=Dt;exports.SetWorksheetPermissionPointsCommand=Ii;exports.SetWorksheetPermissionPointsMutation=Dn;exports.SetWorksheetProtectionCommand=vi;exports.SetWorksheetProtectionMutation=qe;exports.SetWorksheetRangeThemeStyleCommand=Wr;exports.SetWorksheetRangeThemeStyleMutation=gt;exports.SetWorksheetRangeThemeStyleMutationFactory=_s;exports.SetWorksheetRightToLeftCommand=Yl;exports.SetWorksheetRightToLeftMutation=an;exports.SetWorksheetRowAutoHeightMutation=Xn;exports.SetWorksheetRowAutoHeightMutationFactory=Na;exports.SetWorksheetRowCountCommand=wi;exports.SetWorksheetRowCountMutation=ut;exports.SetWorksheetRowCountUndoMutationFactory=As;exports.SetWorksheetRowHeightMutation=Te;exports.SetWorksheetRowIsAutoHeightCommand=An;exports.SetWorksheetRowIsAutoHeightMutation=Se;exports.SetWorksheetShowCommand=es;exports.SheetSkeletonChangeType=Ws;exports.SheetValueChangeType=$s;exports.SplitDelimiterEnum=Bs;exports.SplitTextToColumnsCommand=Mi;exports.ToggleCellCheckboxCommand=yi;exports.ToggleGridlinesCommand=_i;exports.ToggleGridlinesMutation=dt;exports.UnitAction=y;exports.UnitObject=N;exports.UnregisterWorksheetRangeThemeStyleCommand=bi;exports.UnregisterWorksheetRangeThemeStyleMutation=Pn;exports.VALIDATE_CELL=on;exports.ViewStateEnum=zs;exports.WorkbookCommentPermission=to;exports.WorkbookCopyPermission=no;exports.WorkbookCopySheetPermission=tr;exports.WorkbookCreateProtectPermission=oo;exports.WorkbookCreateSheetPermission=so;exports.WorkbookDeleteColumnPermission=nr;exports.WorkbookDeleteRowPermission=or;exports.WorkbookDeleteSheetPermission=ro;exports.WorkbookDuplicatePermission=io;exports.WorkbookEditablePermission=ue;exports.WorkbookExportPermission=ao;exports.WorkbookHideSheetPermission=bn;exports.WorkbookHistoryPermission=sr;exports.WorkbookInsertColumnPermission=rr;exports.WorkbookInsertRowPermission=ir;exports.WorkbookManageCollaboratorPermission=En;exports.WorkbookMoveSheetPermission=Tn;exports.WorkbookPrintPermission=co;exports.WorkbookRecoverHistoryPermission=lo;exports.WorkbookRenameSheetPermission=Un;exports.WorkbookSelectionModel=Ks;exports.WorkbookSharePermission=uo;exports.WorkbookViewHistoryPermission=ho;exports.WorkbookViewPermission=mo;exports.WorksheetCopyPermission=go;exports.WorksheetDeleteColumnPermission=Ro;exports.WorksheetDeleteProtectionPermission=Co;exports.WorksheetDeleteRowPermission=So;exports.WorksheetEditExtraObjectPermission=fo;exports.WorksheetEditPermission=Re;exports.WorksheetFilterPermission=po;exports.WorksheetInsertColumnPermission=Io;exports.WorksheetInsertHyperlinkPermission=vo;exports.WorksheetInsertRowPermission=wo;exports.WorksheetManageCollaboratorPermission=Mo;exports.WorksheetPivotTablePermission=yo;exports.WorksheetProtectionPointModel=Ut;exports.WorksheetProtectionRuleModel=Oe;exports.WorksheetSelectProtectedCellsPermission=pc;exports.WorksheetSelectUnProtectedCellsPermission=Ic;exports.WorksheetSetCellStylePermission=_o;exports.WorksheetSetCellValuePermission=xt;exports.WorksheetSetColumnStylePermission=mt;exports.WorksheetSetRowStylePermission=ht;exports.WorksheetSortPermission=bo;exports.WorksheetViewPermission=zt;exports.addMergeCellsUtil=ul;exports.adjustRangeOnMutation=Or;exports.alignToMergedCellsBorders=Gt;exports.baseProtectionActions=Le;exports.checkCellValueType=Fn;exports.checkRangesEditablePermission=Gu;exports.convertPrimaryWithCoordToPrimary=Hs;exports.convertSelectionDataToRange=qa;exports.copyRangeStyles=We;exports.countCells=Mr;exports.createTopMatrixFromMatrix=Ls;exports.createTopMatrixFromRanges=Vs;exports.defaultLargeSheetOperationConfig=Vo;exports.defaultWorkbookPermissionPoints=pi;exports.defaultWorksheetPermissionPoint=rn;exports.expandToContinuousRange=Ba;exports.factoryRemoveNumfmtUndoMutation=Jl;exports.factorySetNumfmtUndoMutation=Kl;exports.findAllRectangle=Zn;exports.findFirstNonEmptyCell=nc;exports.followSelectionOperation=Ne;exports.generateNullCell=eo;exports.generateNullCellValue=js;exports.getAddMergeMutationRangeByType=$o;exports.getAllRangePermissionPoint=ie;exports.getAllWorkbookPermissionPoint=_t;exports.getAllWorksheetPermissionPoint=re;exports.getAllWorksheetPermissionPointByPointPanel=Ce;exports.getCellAtRowCol=dc;exports.getDefaultRangePermission=Bl;exports.getInsertRangeMutations=Eo;exports.getMoveRangeUndoRedoMutations=yn;exports.getNextPrimaryCell=qu;exports.getPrimaryForRange=oe;exports.getRemoveRangeMutations=To;exports.getSelectionsService=Zs;exports.getSeparateEffectedRangesOnCommand=zc;exports.getSheetCommandTarget=k;exports.getSheetCommandTargetWorkbook=Yn;exports.getSheetMutationTarget=_e;exports.getSkeletonChangedEffectedRange=xa;exports.getValueChangedEffectedRange=Aa;exports.getVisibleRanges=jt;exports.handleBaseInsertRange=Ze;exports.handleBaseMoveRowsCols=Wt;exports.handleBaseRemoveRange=Xe;exports.handleCommonDefaultRangeChangeWithEffectRefCommands=zn;exports.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests=jc;exports.handleDefaultRangeChangeWithEffectRefCommands=Gn;exports.handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests=Fc;exports.handleDeleteRangeMoveLeft=Pr;exports.handleDeleteRangeMoveUp=Nr;exports.handleDeleteRangeMutation=wc;exports.handleIRemoveCol=Wo;exports.handleIRemoveRow=br;exports.handleInsertCol=Tr;exports.handleInsertRangeMoveDown=Ur;exports.handleInsertRangeMoveRight=kr;exports.handleInsertRangeMutation=vc;exports.handleInsertRow=Er;exports.handleMoveCols=xo;exports.handleMoveRange=_r;exports.handleMoveRows=Ao;exports.isSingleCellSelection=hc;exports.rangeMerge=Qn;exports.rangeToDiscreteRange=Gs;exports.rotateRange=de;exports.runRefRangeMutations=Qe;exports.setEndForRange=mc;exports.splitRangeText=Fs;exports.transformCellsToRange=Rn;
