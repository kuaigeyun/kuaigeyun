(function(C,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("@univerjs/core"),require("@univerjs/engine-render"),require("@univerjs/sheets-numfmt"),require("@univerjs/sheets-ui"),require("@univerjs/sheets"),require("@univerjs/ui"),require("rxjs"),require("rxjs/operators"),require("react/jsx-runtime"),require("react"),require("@univerjs/design"),require("@univerjs/engine-formula")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/engine-render","@univerjs/sheets-numfmt","@univerjs/sheets-ui","@univerjs/sheets","@univerjs/ui","rxjs","rxjs/operators","react/jsx-runtime","react","@univerjs/design","@univerjs/engine-formula"],s):(C=typeof globalThis<"u"?globalThis:C||self,s(C.UniverSheetsNumfmtUi={},C.UniverCore,C.UniverEngineRender,C.UniverSheetsNumfmt,C.UniverSheetsUi,C.UniverSheets,C.UniverUi,C.rxjs,C.rxjs.operators,C.React,C.React,C.UniverDesign,C.UniverEngineFormula))})(this,(function(C,s,k,d,N,g,_,w,W,l,y,E,me){"use strict";var it=Object.defineProperty;var st=(C,s,k)=>s in C?it(C,s,{enumerable:!0,configurable:!0,writable:!0,value:k}):C[s]=k;var q=(C,s,k)=>st(C,typeof s!="symbol"?s+"":s,k);const ee={};var de=Object.getOwnPropertyDescriptor,ve=(e,t,r,n)=>{for(var i=n>1?void 0:n?de(t,r):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(i)||i);return i},$=(e,t)=>(r,n)=>t(r,n,e);const G="SHEET_NUMFMT_ALERT";let K=class extends s.Disposable{constructor(e,t,r,n,i,a,o){super(),this._context=e,this._hoverManagerService=t,this._cellAlertManagerService=r,this._localeService=n,this._zenZoneService=i,this._numfmtService=a,this._configService=o,this._init()}_init(){this._initCellAlertPopup(),this._initZenService()}_initCellAlertPopup(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe(w.debounceTime(100)).subscribe(e=>{var t,r;if(e){const n=e.location,i=this._context.unit,a=i.getActiveSheet();if(!a)return this._hideAlert();const o=n.unitId,p=n.subUnitId;let c;const u=a.getCell(n.row,n.col);if(u!=null&&u.s){const v=i.getStyles().get(u.s);v!=null&&v.n&&(c=v.n)}if(c||(c=this._numfmtService.getValue(o,p,n.row,n.col)),!c){this._hideAlert();return}if(s.isTextFormat(c.pattern)&&s.Tools.isDefine(u==null?void 0:u.v)&&s.isRealNum(u.v)){if((t=this._configService.getConfig(d.SHEETS_NUMFMT_PLUGIN_CONFIG_KEY))!=null&&t.disableTextFormatAlert)return;const v=this._cellAlertManagerService.currentAlert.get(G),m=(r=v==null?void 0:v.alert)==null?void 0:r.location;if(m&&m.row===n.row&&m.col===n.col&&m.subUnitId===n.subUnitId&&m.unitId===n.unitId){this._hideAlert();return}this._cellAlertManagerService.showAlert({type:N.CellAlertType.ERROR,title:this._localeService.t("info.error"),message:this._localeService.t("info.forceStringInfo"),location:n,width:200,height:74,key:G});return}}this._hideAlert()}))}_initZenService(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this._hideAlert()}))}_hideAlert(){this._cellAlertManagerService.removeAlert(G)}};K=ve([$(1,s.Inject(N.HoverManagerService)),$(2,s.Inject(N.CellAlertManagerService)),$(3,s.Inject(s.LocaleService)),$(4,_.IZenZoneService),$(5,s.Inject(g.INumfmtService)),$(6,s.IConfigService)],K);const Y={id:"sheet.operation.close.numfmt.panel",type:s.CommandType.OPERATION,handler:()=>!0},j={id:"sheet.operation.open.numfmt.panel",type:s.CommandType.OPERATION,handler:e=>(e.get(A).openPanel(),!0)};var pe=Object.getOwnPropertyDescriptor,he=(e,t,r,n)=>{for(var i=n>1?void 0:n?pe(t,r):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(i)||i);return i},fe=(e,t)=>(r,n)=>t(r,n,e);const Z=y.createContext([]);let F=class{constructor(e){this._localStorageService=e}_getKey(e){return`userHabitController_${e}`}async addHabit(e,t){const r=this._getKey(e);return this._localStorageService.getItem(r).then(n=>{n||this._localStorageService.setItem(r,t)})}markHabit(e,t){const r=this._getKey(e);this._localStorageService.getItem(r).then(n=>{if(n){const i=n.findIndex(a=>a===t);i>-1&&n.splice(i,1),n.unshift(t),this._localStorageService.setItem(r,n)}})}async getHabit(e,t){const r=this._getKey(e),n=await this._localStorageService.getItem(r);if(t&&n){const i=n.map((a,o,p)=>{const c=p.length;return{value:a,priority:c-o}});return t.sort((a,o)=>{var u,v;const p=((u=i.find(m=>m.value===a))==null?void 0:u.priority)||-1;return(((v=i.find(m=>m.value===o))==null?void 0:v.priority)||-1)-p})}return n||[]}deleteHabit(e){this._localStorageService.removeItem(e)}};F=he([fe(0,s.Inject(s.ILocalStorageService))],F);const te="numfmtCurrency",ge=e=>{const t=_.useDependency(F),[r,n]=y.useState(d.currencySymbols);return y.useEffect(()=>{t.addHabit("numfmtCurrency",[]).then(()=>{t.getHabit(te,[...d.currencySymbols]).then(a=>{n(a),e&&e(a)})})},[]),{userHabitCurrency:r,mark:a=>{t.markHabit(te,a)}}},Se=()=>{const e=y.useRef([]),[t,r]=y.useState({});return y.useEffect(()=>{e.current.forEach(i=>{i()}),e.current=[]},[t]),i=>{e.current.push(i),r({})}},ye=e=>!!d.getCurrencyType(e)&&e.startsWith("_("),_e=e=>{const{defaultPattern:t,action:r,onChange:n}=e,[i,a]=y.useState(()=>d.getDecimalFromPattern(t||"",2)),o=y.useContext(Z),[p,c]=y.useState(()=>d.getCurrencyType(t)||o[0]),u=y.useMemo(()=>o.map(b=>({label:b,value:b})),[]),m=_.useDependency(s.LocaleService).t;r.current=()=>d.setPatternDecimal(`_("${p}"* #,##0${i>0?".0":""}_)`,i);const f=b=>{c(b),n(d.setPatternDecimal(`_("${b}"* #,##0${i>0?".0":""}_)`,i))},S=b=>{const h=b||0;a(h),n(d.setPatternDecimal(`_("${p}"* #,##0${h>0?".0":""}_)`,h))};return l.jsxs("div",{children:[l.jsxs("div",{className:"univer-mt-4 univer-flex univer-justify-between",children:[l.jsxs("div",{className:"option",children:[l.jsx("div",{className:"univer-text-sm univer-text-gray-400",children:m("sheet.numfmt.decimalLength")}),l.jsx("div",{className:"univer-mt-2 univer-w-32",children:l.jsx(E.InputNumber,{value:i,step:1,precision:0,max:20,min:0,onChange:S})})]}),l.jsxs("div",{className:"option",children:[l.jsx("div",{className:"univer-text-sm univer-text-gray-400",children:m("sheet.numfmt.currencyType")}),l.jsx("div",{className:"univer-mt-2 univer-w-36",children:l.jsx(E.Select,{options:u,value:p,onChange:f})})]})]}),l.jsx("div",{className:"univer-mt-4 univer-text-sm univer-text-gray-400",children:m("sheet.numfmt.accountingDes")})]})},Ce=e=>!!d.getCurrencyType(e)&&!e.startsWith("_("),be=e=>{const r=_.useDependency(s.LocaleService).t,n=y.useContext(Z),[i,a]=y.useState(()=>d.getCurrencyType(e.defaultPattern)||n[0]),[o,p]=y.useState(()=>d.getDecimalFromPattern(e.defaultPattern||"",2)),[c,u]=y.useState(()=>{var I;const h=d.getCurrencyFormatOptions(i);return((I=h.find(M=>s.isPatternEqualWithoutDecimal(M.value,e.defaultPattern)))==null?void 0:I.value)||h[0].value}),v=y.useMemo(()=>d.getCurrencyFormatOptions(i),[i]),m=y.useMemo(()=>n.map(h=>({label:h,value:h})),[n]);e.action.current=()=>d.setPatternDecimal(c,o);const f=h=>{if(h===void 0)return;a(h);const P=d.getCurrencyFormatOptions(h)[0].value;u(P),e.onChange(d.setPatternDecimal(P,o))},S=h=>{h!==void 0&&(u(h),e.onChange(d.setPatternDecimal(h,o)))},b=h=>{p(h||0),e.onChange(d.setPatternDecimal(c,h||0))};return l.jsxs("div",{children:[l.jsxs("div",{className:"univer-mt-4 univer-flex univer-justify-between",children:[l.jsxs("div",{className:"option",children:[l.jsx("div",{className:"univer-text-sm univer-text-gray-400",children:r("sheet.numfmt.decimalLength")}),l.jsx("div",{className:"univer-mt-2 univer-w-32",children:l.jsx(E.InputNumber,{value:o,max:20,min:0,onChange:b})})]}),l.jsxs("div",{className:"option",children:[l.jsx("div",{className:"univer-text-sm univer-text-gray-400",children:r("sheet.numfmt.currencyType")}),l.jsx("div",{className:"univer-mt-2 univer-w-36",children:l.jsx(E.Select,{value:i,options:m,onChange:f})})]})]}),l.jsx("div",{className:"label univer-mt-4",children:r("sheet.numfmt.negType")}),l.jsx("div",{className:"univer-mt-2",children:l.jsx(E.SelectList,{value:c,options:v,onChange:S})}),l.jsx("div",{className:"univer-mt-4 univer-text-sm univer-text-gray-400",children:r("sheet.numfmt.currencyDes")})]})};function ne({ref:e,...t}){const{icon:r,id:n,className:i,extend:a,...o}=t,p=`univerjs-icon univerjs-icon-${n} ${i||""}`.trim(),c=y.useRef(`_${Ee()}`);return re(r,`${n}`,{defIds:r.defIds,idSuffix:c.current},{ref:e,className:p,...o},a)}function re(e,t,r,n,i){return y.createElement(e.tag,{key:t,...Ie(e,r,i),...n},(Te(e,r).children||[]).map((a,o)=>re(a,`${t}-${e.tag}-${o}`,r,void 0,i)))}function Ie(e,t,r){const n={...e.attrs};r!=null&&r.colorChannel1&&n.fill==="colorChannel1"&&(n.fill=r.colorChannel1),e.tag==="mask"&&n.id&&(n.id=n.id+t.idSuffix),Object.entries(n).forEach(([a,o])=>{a==="mask"&&typeof o=="string"&&(n[a]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))});const{defIds:i}=t;return!i||i.length===0||(e.tag==="use"&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(([a,o])=>{typeof o=="string"&&(n[a]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))})),n}function Te(e,t){var n;const{defIds:r}=t;return!r||r.length===0?e:e.tag==="defs"&&((n=e.children)!=null&&n.length)?{...e,children:e.children.map(i=>typeof i.attrs.id=="string"&&r&&r.includes(i.attrs.id)?{...i,attrs:{...i.attrs,id:i.attrs.id+t.idSuffix}}:i)}:e}function Ee(){return Math.random().toString(36).substring(2,8)}ne.displayName="UniverIcon";const Pe={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 3.75557C14.3887 3.98988 14.3887 4.36978 14.1544 4.6041L6.51409 12.2444C6.40157 12.3569 6.24896 12.4201 6.08983 12.4201C5.9307 12.4201 5.77808 12.3569 5.66556 12.2444L1.84541 8.42425C1.6111 8.18993 1.6111 7.81003 1.84541 7.57572C2.07973 7.34141 2.45963 7.34141 2.69394 7.57572L6.08983 10.9716L13.3059 3.75557C13.5402 3.52126 13.9201 3.52126 14.1544 3.75557Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ie=y.forwardRef(function(t,r){return y.createElement(ne,Object.assign({},t,{id:"check-mark-icon",ref:r,icon:Pe}))});ie.displayName="CheckMarkIcon";const z="customFormat",X="numfmt_custom_pattern";function Me(e){const{defaultPattern:t,action:r,onChange:n}=e,i=_.useDependency(F),a=_.useDependency(s.ILocalStorageService),o=_.useDependency(s.LocaleService),[p,c]=y.useState(t);r.current=()=>(i.markHabit(z,p),a.getItem(X).then((S=[])=>{const b=[...new Set([p,...S||[]])].splice(0,10).filter(h=>!!h);a.setItem(X,b)}),p);const[u,v]=y.useState([]);y.useEffect(()=>{a.getItem(X).then(S=>{const b=[...d.CURRENCYFORMAT.map(h=>h.suffix("$")),...d.DATEFMTLISG.map(h=>h.suffix),...d.NUMBERFORMAT.map(h=>h.suffix)];b.push(...S||[]),i.addHabit(z,[]).finally(()=>{i.getHabit(z,b).then(h=>{v([...new Set(h)])})})})},[]);const m=S=>{c(S),n(S)},f=()=>{n(p)};return l.jsxs("div",{children:[l.jsx("div",{className:"univer-mt-4 univer-text-sm univer-text-gray-400",children:o.t("sheet.numfmt.customFormat")}),l.jsx(E.Input,{placeholder:o.t("sheet.numfmt.customFormat"),onBlur:f,value:p,onChange:c,className:"univer-mt-2 univer-w-full"}),l.jsx("div",{className:E.clsx("univer-mt-2 univer-max-h-[400px] univer-overflow-auto univer-rounded-lg univer-p-2",E.borderClassName),children:u.map(S=>l.jsxs("div",{onClick:()=>m(S),className:"univer-flex univer-cursor-pointer univer-items-center univer-gap-1.5 univer-py-1.5 univer-text-sm",children:[l.jsx("div",{className:"univer-flex univer-w-4 univer-items-center univer-text-primary-600",children:p===S&&l.jsx(ie,{})}),l.jsx("div",{children:S})]},S))}),l.jsx("div",{className:"univer-mt-3 univer-text-sm univer-text-gray-600 dark:!univer-text-gray-200",children:o.t("sheet.numfmt.customFormatDes")})]})}const Ne=e=>{const t=s.numfmt.getFormatInfo(e);return d.getDateFormatOptions().map(r=>r.value).includes(e)||["date","datetime","time"].includes(t.type)};function De(e){const{onChange:t,defaultPattern:r}=e,n=y.useMemo(d.getDateFormatOptions,[]),i=_.useDependency(s.LocaleService),[a,o]=y.useState(()=>{if(r){const c=n.find(u=>u.value===r);if(c)return c.value}return n[0].value});e.action.current=()=>a;const p=c=>{c!==void 0&&(o(c),t(c))};return l.jsxs("div",{children:[l.jsx("div",{className:"univer-mt-4 univer-text-sm univer-text-gray-400",children:i.t("sheet.numfmt.dateType")}),l.jsx("div",{className:"univer-mt-2",children:l.jsx(E.SelectList,{value:a,options:n,onChange:p})}),l.jsx("div",{className:"univer-mt-3.5 univer-text-sm/5 univer-text-gray-600 dark:!univer-text-gray-200",children:i.t("sheet.numfmt.dateDes")})]})}const we=e=>!e,Ue=e=>{const r=_.useDependency(s.LocaleService).t;return e.action.current=()=>"",l.jsx("div",{children:l.jsx("div",{className:"univer-mt-3.5 univer-text-sm/5 univer-text-gray-600 dark:!univer-text-gray-200",children:r("sheet.numfmt.generalDes")})})},xe=e=>d.getNumberFormatOptions().some(t=>s.isPatternEqualWithoutDecimal(t.value,e));function Oe(e){const t=_.useDependency(s.LocaleService),r=y.useMemo(d.getNumberFormatOptions,[]),[n,i]=y.useState(()=>d.getDecimalFromPattern(e.defaultPattern||"",0)),[a,o]=y.useState(()=>{const m=r.find(f=>s.isPatternEqualWithoutDecimal(f.value,e.defaultPattern||""));return(m==null?void 0:m.value)||r[0].value}),p=y.useMemo(()=>d.setPatternDecimal(a,Number(n||0)),[a,n]),c=y.useMemo(()=>!d.isPatternHasDecimal(a),[a]),u=m=>{i(m||0),e.onChange(d.setPatternDecimal(a,Number(m||0)))},v=m=>{m!==void 0&&(i(d.getDecimalFromPattern(m,0)),o(m),e.onChange(m))};return e.action.current=()=>p,l.jsxs("div",{children:[l.jsx("div",{className:"univer-mt-4 univer-text-sm univer-text-gray-400",children:t.t("sheet.numfmt.decimalLength")}),l.jsx("div",{className:"univer-mt-2",children:l.jsx(E.InputNumber,{disabled:c,value:n,max:20,min:0,onChange:u})}),l.jsxs("div",{className:"univer-mt-4 univer-text-sm univer-text-gray-400",children:[" ",t.t("sheet.numfmt.negType")]}),l.jsx("div",{className:"univer-mt-2",children:l.jsx(E.SelectList,{onChange:v,options:r,value:a})}),l.jsx("div",{className:"univer-mt-3.5 univer-text-sm/5 univer-text-gray-600 dark:!univer-text-gray-200",children:t.t("sheet.numfmt.thousandthPercentileDes")})]})}const ke=e=>{const{defaultValue:t,defaultPattern:r,row:n,col:i}=e.value,a=_.useDependency(s.LocaleService),o=y.useRef(()=>""),p=a.t,c=Se(),u=y.useMemo(()=>[{label:"sheet.numfmt.general",component:Ue},{label:"sheet.numfmt.accounting",component:_e},{label:"sheet.numfmt.currency",component:be},{label:"sheet.numfmt.date",component:De},{label:"sheet.numfmt.thousandthPercentile",component:Oe},{label:"sheet.numfmt.customFormat",component:Me}].map(T=>({...T,label:p(T.label)})),[]),[v,m]=y.useState(I),[f,S]=y.useState(()=>`${n}_${i}`),{mark:b,userHabitCurrency:h}=ge(()=>S(`${n}_${i}_userCurrency'`)),P=y.useMemo(()=>{var T;return(T=u.find(L=>L.label===v))==null?void 0:T.component},[v]);function I(){return[we,ye,Ce,Ne,xe].reduce((L,nt,rt)=>L||(nt(r)?u[rt].label:""),"")||u[0].label}const M=u.map(T=>({label:T.label,value:T.label})),U=T=>{m(T),c(()=>e.onChange({type:"change",value:o.current()||""}))},x=y.useCallback(T=>{e.onChange({type:"change",value:T})},[]),O=()=>{const T=o.current()||"",L=d.getCurrencyType(T);L&&b(L),e.onChange({type:"confirm",value:T})},R=()=>{e.onChange({type:"cancel",value:""})},Q={onChange:x,defaultValue:t,defaultPattern:r,action:o};return y.useEffect(()=>{m(I()),S(`${n}_${i}`)},[n,i]),l.jsxs("div",{className:E.clsx("univer-flex univer-h-full univer-flex-col univer-justify-between univer-overflow-y-auto univer-pb-5",E.scrollbarClassName),children:[l.jsxs("div",{children:[l.jsx("div",{className:"univer-mt-3.5 univer-text-sm univer-text-gray-400",children:p("sheet.numfmt.numfmtType")}),l.jsx("div",{className:"univer-mt-2",children:l.jsx(E.Select,{className:"univer-w-full",value:v,options:M,onChange:U})}),l.jsx("div",{children:P&&l.jsx(Z.Provider,{value:h,children:y.createElement(P,{...Q,key:f})})})]}),l.jsxs("div",{className:"univer-mb-5 univer-mt-3.5 univer-flex univer-justify-end",children:[l.jsx(E.Button,{onClick:R,className:"univer-mr-3",children:p("sheet.numfmt.cancel")}),l.jsx(E.Button,{variant:"primary",onClick:O,children:p("sheet.numfmt.confirm")})]})]})};var $e=Object.getOwnPropertyDescriptor,Le=(e,t,r,n)=>{for(var i=n>1?void 0:n?$e(t,r):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(i)||i);return i},D=(e,t)=>(r,n)=>t(r,n,e);const se="SHEET_NUMFMT_PANEL";let A=class extends s.Disposable{constructor(t,r,n,i,a,o,p,c,u,v,m){super();q(this,"_previewPattern","");q(this,"_sidebarDisposable",null);this._sheetInterceptorService=t,this._themeService=r,this._univerInstanceService=n,this._commandService=i,this._selectionManagerService=a,this._renderManagerService=o,this._numfmtService=p,this._componentManager=c,this._sidebarService=u,this._localeService=v,this._sheetsNumfmtCellContentController=m,this._initRealTimeRenderingInterceptor(),this._initPanel(),this._initCommands(),this._initCloseListener(),this._commandExecutedListener(),this._initNumfmtLocalChange()}_initNumfmtLocalChange(){this.disposeWithMe(w.merge(this._sheetsNumfmtCellContentController.locale$,this._localeService.currentLocale$).subscribe(()=>{this._forceUpdate()}))}openPanel(){var P;const t=this._sidebarService,r=this._selectionManagerService,n=this._commandService,i=this._univerInstanceService,a=this._numfmtService,o=this._localeService,c=(((P=r.getCurrentSelections())==null?void 0:P.map(I=>I.range))||[])[0];if(!c)return!1;const u=i.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),v=u.getActiveSheet();if(!v)return!1;const m=v.getCellRaw(c.startRow,c.startColumn),f=a.getValue(u.getUnitId(),v.getSheetId(),c.startRow,c.startColumn);let S="";f&&(S=f.pattern);const b=(m==null?void 0:m.t)===s.CellValueType.NUMBER?m.v:12345678,h={onChange:I=>{var M;if(I.type==="change")this._previewPattern=I.value,this._forceUpdate();else if(I.type==="confirm"){const U=((M=r.getCurrentSelections())==null?void 0:M.map(R=>R.range))||[],x={values:[]},O=d.getPatternType(I.value);U.forEach(R=>{s.Range.foreach(R,(Q,T)=>{x.values.push({row:Q,col:T,pattern:I.value,type:O})})}),n.executeCommand(d.SetNumfmtCommand.id,x),t.close()}else I.type==="cancel"&&t.close()},value:{defaultPattern:S,defaultValue:b,row:c.startRow,col:c.startColumn}};return this._sidebarDisposable=t.open({header:{title:o.t("sheet.numfmt.title")},children:{label:se,...h},onClose:()=>{this._forceUpdate(),n.executeCommand(Y.id)}}),!0}_forceUpdate(t){var n;const r=this._renderManagerService.getRenderById(t!=null?t:this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET).getUnitId());r==null||r.with(N.SheetSkeletonManagerService).reCalculate(),(n=r==null?void 0:r.mainComponent)==null||n.makeDirty()}_initCommands(){[j,Y].forEach(t=>{this.disposeWithMe(this._commandService.registerCommand(t))})}_initPanel(){this.disposeWithMe(this._componentManager.register(se,ke))}_initRealTimeRenderingInterceptor(){const t=new w.Observable(n=>{this._commandService.onCommandExecuted(i=>{i.id===j.id&&n.next(!0),i.id===Y.id&&n.next(!1)})}),r=w.combineLatest([t,this._selectionManagerService.selectionMoveEnd$.pipe(W.map(n=>n?n.map(i=>i.range):[]))]);this.disposeWithMe(s.toDisposable(r.pipe(W.switchMap(([n,i])=>new w.Observable(a=>{const o=new s.DisposableCollection;return n&&i.length&&a.next({selectionRanges:i,disposableCollection:o}),()=>{o.dispose()}})),W.tap(()=>{this._previewPattern=null})).subscribe(({disposableCollection:n,selectionRanges:i})=>{var o,p;const a=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);this.openPanel(),n.add(this._sheetInterceptorService.intercept(g.INTERCEPTOR_POINT.CELL_CONTENT,{priority:99,effect:s.InterceptorEffectEnum.Value|s.InterceptorEffectEnum.Style,handler:(c,u,v)=>{var b;const{row:m,col:f}=u,S=v(c)||{};if(i.find(h=>h.startColumn<=f&&h.endColumn>=f&&h.startRow<=m&&h.endRow>=m)){const h=u.worksheet.getCellRaw(m,f),P=h==null?void 0:h.v,I=h==null?void 0:h.t;if(P==null||I!==s.CellValueType.NUMBER||this._previewPattern===null)return S;const M=d.getPatternPreviewIgnoreGeneral(this._previewPattern,P,this._sheetsNumfmtCellContentController.locale);if(M.color){const U=(b=this._themeService.getColorFromTheme(`${M.color}.500`))!=null?b:M.color;return{...S,v:M.result,t:s.CellValueType.STRING,s:{cl:{rgb:U}}}}return{...S,v:M.result,t:s.CellValueType.STRING}}return S}})),(p=(o=this._renderManagerService.getRenderById(a.getUnitId()))==null?void 0:o.mainComponent)==null||p.makeDirty()})))}_commandExecutedListener(){const t=[g.RemoveNumfmtMutation.id,g.SetNumfmtMutation.id];this.disposeWithMe(new w.Observable(r=>{const n=this._commandService.onCommandExecuted(i=>{if(t.includes(i.id)){const a=i.params;r.next(a.unitId)}});return()=>n.dispose()}).pipe(W.debounceTime(16)).subscribe(r=>this._forceUpdate(r)))}_initCloseListener(){this._univerInstanceService.getCurrentTypeOfUnit$(s.UniverInstanceType.UNIVER_SHEET).subscribe(t=>{var r;t||((r=this._sidebarDisposable)==null||r.dispose(),this._sidebarDisposable=null)})}};A=Le([D(0,s.Inject(g.SheetInterceptorService)),D(1,s.Inject(s.ThemeService)),D(2,s.IUniverInstanceService),D(3,s.ICommandService),D(4,s.Inject(g.SheetsSelectionsService)),D(5,k.IRenderManagerService),D(6,g.INumfmtService),D(7,s.Inject(_.ComponentManager)),D(8,_.ISidebarService),D(9,s.Inject(s.LocaleService)),D(10,s.Inject(d.SheetsNumfmtCellContentController))],A);var je=Object.getOwnPropertyDescriptor,Fe=(e,t,r,n)=>{for(var i=n>1?void 0:n?je(t,r):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(i)||i);return i},H=(e,t)=>(r,n)=>t(r,n,e);const Ae=()=>{let e=[];return{add:(i,a,o,p,c)=>e.push({unitId:i,subUnitId:a,row:o,col:p,value:c}),getEffects:()=>e,clean:()=>{e=[]}}};let B=class extends s.Disposable{constructor(t,r,n,i,a){super();q(this,"_collectEffectMutation",Ae());this._sheetInterceptorService=t,this._numfmtService=r,this._univerInstanceService=n,this._injector=i,this._editorBridgeService=a,this._initInterceptorEditorStart(),this._initInterceptorEditorEnd(),this._initInterceptorCommands()}_initInterceptorEditorStart(){this._editorBridgeService&&this.disposeWithMe(s.toDisposable(this._sheetInterceptorService.writeCellInterceptor.intercept(g.BEFORE_CELL_EDIT,{handler:(t,r,n)=>{const i=r.row,a=r.col,o=this._numfmtService.getValue(r.unitId,r.subUnitId,i,a);if(o)switch(d.getPatternType(o.pattern)){case"scientific":case"currency":case"grouped":case"number":{const c=r.worksheet.getCellRaw(i,a);return(c==null?void 0:c.t)===s.CellValueType.NUMBER&&(c==null?void 0:c.v)!==void 0&&c.v!==null&&s.isRealNum(c.v)&&(c.v=me.stripErrorMargin(Number(c.v))),n&&n(c)}case"percent":case"date":case"time":case"datetime":default:return n&&n(t)}return n(t)}})))}_initInterceptorEditorEnd(){this.disposeWithMe(s.toDisposable(this._sheetInterceptorService.writeCellInterceptor.intercept(g.AFTER_CELL_EDIT,{handler:(t,r,n)=>{var u,v,m;if(!(t!=null&&t.v)&&!(t!=null&&t.p))return n(t);this._collectEffectMutation.clean();const i=this._numfmtService.getValue(r.unitId,r.subUnitId,r.row,r.col),a=r.worksheet.getCellRaw(r.row,r.col);if(s.isTextFormat(i==null?void 0:i.pattern)||t.t===s.CellValueType.FORCE_STRING)return n(t);const o=(u=t.p)==null?void 0:u.body,p=(m=(v=t==null?void 0:t.p)==null?void 0:v.body)!=null&&m.dataStream?t.p.body.dataStream.replace(/\r\n$/,""):String(t.v),c=s.getNumfmtParseValueFilter(p);if(o)if(He(o)){const{dataStream:f}=o,S=f.replace(/\r\n$/,""),b=Number(S);if(Number.isNaN(b)&&!c)return n(t)}else return n(t);if(c){if(!c.z&&!(i!=null&&i.pattern)&&(a==null?void 0:a.t)!==s.CellValueType.STRING&&(a==null?void 0:a.t)!==s.CellValueType.FORCE_STRING&&s.willLoseNumericPrecision(p))return n({...t,p:void 0,v:p,t:s.CellValueType.FORCE_STRING});c.z&&this._collectEffectMutation.add(r.unitId,r.subUnitId,r.row,r.col,{pattern:c.z});const f=Number(c.v);return n({...t,p:void 0,v:f,t:s.CellValueType.NUMBER})}return n(t)}})))}_initInterceptorCommands(){const t=this;this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations(r){var n;switch(r.id){case g.SetRangeValuesCommand.id:{const i=t._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),a=i.getUnitId(),o=(n=i.getActiveSheet())==null?void 0:n.getSheetId();if(!o)return{redos:[],undos:[]};const p=t._collectEffectMutation.getEffects();if(t._collectEffectMutation.clean(),!p.length)return{redos:[],undos:[]};const c=p.filter(f=>{var S;return!!((S=f.value)!=null&&S.pattern)}).map(f=>({row:f.row,col:f.col,pattern:f.value.pattern})),u=p.filter(f=>{var S;return!((S=f.value)!=null&&S.pattern)}).map(f=>({startRow:f.row,endColumn:f.col,startColumn:f.col,endRow:f.row})),v=[],m=[];if(c.length){const f={id:g.SetNumfmtMutation.id,params:g.transformCellsToRange(a,o,c)};v.push(f),m.push(...g.factorySetNumfmtUndoMutation(t._injector,f.params))}if(u.length){const f={id:g.RemoveNumfmtMutation.id,params:{unitId:a,subUnitId:o,ranges:u}};v.push(f),m.push(...g.factoryRemoveNumfmtUndoMutation(t._injector,f.params))}return{redos:v,undos:m.reverse()}}}return{redos:[],undos:[]}}}))}dispose(){super.dispose(),this._collectEffectMutation.clean()}};B=Fe([H(0,s.Inject(g.SheetInterceptorService)),H(1,s.Inject(g.INumfmtService)),H(2,s.Inject(s.IUniverInstanceService)),H(3,s.Inject(s.Injector)),H(4,s.Optional(N.IEditorBridgeService))],B);function He(e){const{textRuns:t=[],paragraphs:r=[],customRanges:n,customBlocks:i=[]}=e,a=["va"];return!(t.some(o=>!!(o.ts&&Object.keys(o.ts).some(c=>a.includes(c))))||r.some(o=>o.bullet)||r.length>=2||n!=null&&n.length||i.length>0)}const ae=e=>[{label:"sheet.numfmt.general",pattern:null},{label:"sheet.numfmt.text",pattern:s.DEFAULT_TEXT_FORMAT_EXCEL},"|",{label:"sheet.numfmt.number",pattern:"0"},{label:"sheet.numfmt.percent",pattern:"0.00%"},{label:"sheet.numfmt.scientific",pattern:"0.00E+00"},"|",{label:"sheet.numfmt.accounting",pattern:`"${e}" #,##0.00_);[Red]("${e}"#,##0.00)`},{label:"sheet.numfmt.financialValue",pattern:"#,##0.00;[Red]#,##0.00"},{label:"sheet.numfmt.currency",pattern:`"${e}"#,##0.00_);[Red]("${e}"#,##0.00)`},{label:"sheet.numfmt.roundingCurrency",pattern:`"${e}"#,##0;[Red]"${e}"#,##0`},"|",{label:"sheet.numfmt.date",pattern:"yyyy-mm-dd;@"},{label:"sheet.numfmt.time",pattern:'am/pm h":"mm":"ss'},{label:"sheet.numfmt.dateTime",pattern:"yyyy-m-d am/pm h:mm"},{label:"sheet.numfmt.timeDuration",pattern:"h:mm:ss"},"|",{label:"sheet.numfmt.moreFmt",pattern:""}],Re=e=>({icon:new w.Observable(t=>{const r=e.get(s.LocaleService);return t.next(d.getCurrencySymbolIconByLocale(r.getCurrentLocale()).icon),r.localeChanged$.subscribe(()=>{t.next(d.getCurrencySymbolIconByLocale(r.getCurrentLocale()).icon)})}),id:d.SetCurrencyCommand.id,title:"sheet.numfmt.currency",tooltip:"sheet.numfmt.currency",type:_.MenuItemType.BUTTON,hidden$:_.getMenuHiddenObservable(e,s.UniverInstanceType.UNIVER_SHEET),disabled$:N.getCurrentRangeDisable$(e,{workbookTypes:[g.WorkbookEditablePermission],worksheetTypes:[g.WorksheetEditPermission,g.WorksheetSetCellStylePermission],rangeTypes:[g.RangeProtectionPermissionEditPoint]})}),We=e=>({icon:"AddDigitsIcon",id:d.AddDecimalCommand.id,title:"sheet.numfmt.addDecimal",tooltip:"sheet.numfmt.addDecimal",type:_.MenuItemType.BUTTON,hidden$:_.getMenuHiddenObservable(e,s.UniverInstanceType.UNIVER_SHEET),disabled$:N.getCurrentRangeDisable$(e,{workbookTypes:[g.WorkbookEditablePermission],worksheetTypes:[g.WorksheetEditPermission,g.WorksheetSetCellStylePermission],rangeTypes:[g.RangeProtectionPermissionEditPoint]})}),Be=e=>({icon:"ReduceDigitsIcon",id:d.SubtractDecimalCommand.id,title:"sheet.numfmt.subtractDecimal",tooltip:"sheet.numfmt.subtractDecimal",type:_.MenuItemType.BUTTON,hidden$:_.getMenuHiddenObservable(e,s.UniverInstanceType.UNIVER_SHEET),disabled$:N.getCurrentRangeDisable$(e,{workbookTypes:[g.WorkbookEditablePermission],worksheetTypes:[g.WorksheetEditPermission,g.WorksheetSetCellStylePermission],rangeTypes:[g.RangeProtectionPermissionEditPoint]})}),Ve=e=>({icon:"PercentIcon",id:d.SetPercentCommand.id,title:"sheet.numfmt.percent",tooltip:"sheet.numfmt.percent",type:_.MenuItemType.BUTTON,hidden$:_.getMenuHiddenObservable(e,s.UniverInstanceType.UNIVER_SHEET),disabled$:N.getCurrentRangeDisable$(e,{workbookTypes:[g.WorkbookEditablePermission],worksheetTypes:[g.WorksheetEditPermission,g.WorksheetSetCellStylePermission],rangeTypes:[g.RangeProtectionPermissionEditPoint]})}),qe=e=>{const t=e.get(s.IUniverInstanceService),r=e.get(s.ICommandService),n=e.get(s.LocaleService),i=e.get(g.SheetsSelectionsService),a=[g.RemoveNumfmtMutation.id,g.SetNumfmtMutation.id],o=N.deriveStateFromActiveSheet$(t,"",({workbook:p,worksheet:c})=>new w.Observable(u=>w.merge(i.selectionMoveEnd$,s.fromCallback(r.onCommandExecuted.bind(r)).pipe(w.filter(([v])=>a.includes(v.id)))).subscribe(()=>{var m,f;const v=i.getCurrentSelections();if(v&&v[0]){const S=v[0].range,b=S.startRow,h=S.startColumn,P=(f=p.getStyles().get((m=c.getCell(b,h))==null?void 0:m.s))==null?void 0:f.n,I=P==null?void 0:P.pattern,M=d.getCurrencySymbolByLocale(n.getCurrentLocale());let U=n.t("sheet.numfmt.general");if(s.isDefaultFormat(I)){u.next(U);return}if(I){const x=ae(M).filter(O=>typeof O=="object"&&O.pattern).find(O=>s.isPatternEqualWithoutDecimal(I,O.pattern));x&&typeof x=="object"&&x.pattern?U=n.t(x.label):U=n.t("sheet.numfmt.moreFmt")}u.next(U)}})));return{label:oe,id:j.id,tooltip:"sheet.numfmt.title",type:_.MenuItemType.SELECTOR,slot:!0,selections:[{label:{name:ce,hoverable:!1,selectable:!1}}],value$:o,hidden$:_.getMenuHiddenObservable(e,s.UniverInstanceType.UNIVER_SHEET),disabled$:N.getCurrentRangeDisable$(e,{workbookTypes:[g.WorkbookEditablePermission],worksheetTypes:[g.WorksheetSetCellStylePermission,g.WorksheetEditPermission],rangeTypes:[g.RangeProtectionPermissionEditPoint]})}},oe="sheet.numfmt.moreNumfmtType",ce="sheet.numfmt.moreNumfmtType.options";function Ge(e){const{value:t}=e,r=_.useDependency(s.LocaleService),n=t!=null?t:r.t("sheet.numfmt.general");return l.jsx("span",{className:"univer-text-sm",children:n})}function Ke(){const e=_.useDependency(s.ICommandService),t=_.useDependency(s.LocaleService),r=_.useDependency(_.ILayoutService),n=_.useDependency(d.SheetsNumfmtCellContentController),i=_.useDependency(g.SheetsSelectionsService),a=u=>{const v=i.getCurrentLastSelection();if(!v)return;const m=v.range,f=[];s.Range.foreach(m,(S,b)=>{u?f.push({row:S,col:b,pattern:u,type:d.getPatternType(u)}):f.push({row:S,col:b})}),e.executeCommand(d.SetNumfmtCommand.id,{values:f}),r.focus()},o=y.useMemo(()=>{const u=d.localeCurrencySymbolMap.get(t.getCurrentLocale());return ae(u)},[t]),p=u=>{if(u===0)a(null);else if(u===o.length-1)e.executeCommand(j.id),r.focus();else{const v=o[u];v.pattern&&a(v.pattern)}},c=1220;return l.jsx("div",{className:"univer-grid univer-gap-1 univer-p-1.5",children:o.map((u,v)=>u==="|"?l.jsx(E.Separator,{},v):l.jsxs("div",{className:"univer-flex univer-h-7 univer-items-center univer-justify-between univer-gap-6 univer-rounded univer-px-2 univer-text-sm hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700",onClick:()=>p(v),children:[l.jsx("span",{children:t.t(u.label)}),l.jsx("span",{className:"univer-text-xs univer-text-gray-500",children:u.pattern?d.getPatternPreview(u.pattern||"",c,n.locale).result.trim():""})]},v))})}const Ye={[_.RibbonStartGroup.LAYOUT]:{[j.id]:{order:9,menuItemFactory:qe},[d.SetPercentCommand.id]:{order:9.1,menuItemFactory:Ve},[d.SetCurrencyCommand.id]:{order:9.2,menuItemFactory:Re},[d.AddDecimalCommand.id]:{order:9.3,menuItemFactory:We},[d.SubtractDecimalCommand.id]:{order:9.4,menuItemFactory:Be}}};var Ze=Object.getOwnPropertyDescriptor,ze=(e,t,r,n)=>{for(var i=n>1?void 0:n?Ze(t,r):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(i)||i);return i},le=(e,t)=>(r,n)=>t(r,n,e);let V=class extends s.Disposable{constructor(e,t){super(),this._componentManager=e,this._menuManagerService=t,this._initMenu()}_initMenu(){this._menuManagerService.mergeMenu(Ye),[[oe,Ge],[ce,Ke]].forEach(([e,t])=>{this.disposeWithMe(this._componentManager.register(e,t))})}};V=ze([le(0,s.Inject(_.ComponentManager)),le(1,_.IMenuManagerService)],V);var Xe=Object.defineProperty,Je=Object.getOwnPropertyDescriptor,Qe=(e,t,r)=>t in e?Xe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,et=(e,t,r,n)=>{for(var i=n>1?void 0:n?Je(t,r):t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(i)||i);return i},J=(e,t)=>(r,n)=>t(r,n,e),ue=(e,t,r)=>Qe(e,typeof t!="symbol"?t+"":t,r);const tt="SHEET_NUMFMT_UI_PLUGIN";C.UniverSheetsNumfmtUIPlugin=class extends s.Plugin{constructor(t=ee,r,n,i){super(),this._config=t,this._injector=r,this._configService=n,this._renderManagerService=i;const{menu:a,...o}=s.merge({},ee,this._config);a&&this._configService.setConfig("menu",a,{merge:!0}),this._configService.setConfig("sheets-numfmt-ui.config",o)}onStarting(){s.registerDependencies(this._injector,[[A],[B],[F],[V]])}onRendered(){this._registerRenderModules(),s.touchDependencies(this._injector,[[A],[B],[V]])}_registerRenderModules(){[[K]].forEach(r=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(s.UniverInstanceType.UNIVER_SHEET,r))})}},ue(C.UniverSheetsNumfmtUIPlugin,"pluginName",tt),ue(C.UniverSheetsNumfmtUIPlugin,"type",s.UniverInstanceType.UNIVER_SHEET),C.UniverSheetsNumfmtUIPlugin=et([s.DependentOn(N.UniverSheetsUIPlugin,d.UniverSheetsNumfmtPlugin),J(1,s.Inject(s.Injector)),J(2,s.IConfigService),J(3,k.IRenderManagerService)],C.UniverSheetsNumfmtUIPlugin),Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})}));
