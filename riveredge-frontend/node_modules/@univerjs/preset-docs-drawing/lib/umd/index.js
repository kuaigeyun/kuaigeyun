// @univerjs/drawing-ui/index
(function(D,h){typeof exports=="object"&&typeof module<"u"?h(exports,require("@univerjs/core"),require("@univerjs/ui"),require("react/jsx-runtime"),require("@univerjs/design"),require("react"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/ui","react/jsx-runtime","@univerjs/design","react","@univerjs/drawing","@univerjs/engine-render","rxjs"],h):(D=typeof globalThis<"u"?globalThis:D||self,h(D.UniverDrawingUi={},D.UniverCore,D.UniverUi,D.React,D.UniverDesign,D.React,D.UniverDrawing,D.UniverEngineRender,D.rxjs))})(this,(function(D,h,A,f,U,C,E,y,Me){"use strict";var Et=Object.defineProperty;var Tt=(D,h,A)=>h in D?Et(D,h,{enumerable:!0,configurable:!0,writable:!0,value:A}):D[h]=A;var J=(D,h,A)=>Tt(D,typeof h!="symbol"?h+"":h,A);var be;var R=(s=>(s.default="0",s.left="1",s.center="2",s.right="3",s.top="4",s.middle="5",s.bottom="6",s.horizon="7",s.vertical="8",s))(R||{});const de={id:"sheet.operation.set-image-align",type:h.CommandType.OPERATION,handler:(s,r)=>!0},he={id:"sheet.operation.open-image-crop",type:h.CommandType.OPERATION,handler:(s,r)=>!0},Q={id:"sheet.operation.close-image-crop",type:h.CommandType.OPERATION,handler:(s,r)=>!0};var x=(s=>(s.FREE="0",s.R1_1="1",s.R16_9="2",s.R9_16="3",s.R5_4="4",s.R4_5="5",s.R4_3="6",s.R3_4="7",s.R3_2="8",s.R2_3="9",s))(x||{});const oe={id:"sheet.operation.Auto-image-crop",type:h.CommandType.OPERATION,handler:(s,r)=>!0},Ie={id:"sheet.operation.image-reset-size",type:h.CommandType.OPERATION,handler:(s,r)=>!0},Ze="drawing-ui.config",Oe={},Ee="COMPONENT_IMAGE_POPUP_MENU";function F({ref:s,...r}){const{icon:e,id:t,className:n,extend:i,...a}=r,o=`univerjs-icon univerjs-icon-${t} ${n||""}`.trim(),c=C.useRef(`_${Ye()}`);return Te(e,`${t}`,{defIds:e.defIds,idSuffix:c.current},{ref:s,className:o,...a},i)}function Te(s,r,e,t,n){return C.createElement(s.tag,{key:r,...Fe(s,e,n),...t},(ze(s,e).children||[]).map((i,a)=>Te(i,`${r}-${s.tag}-${a}`,e,void 0,n)))}function Fe(s,r,e){const t={...s.attrs};e!=null&&e.colorChannel1&&t.fill==="colorChannel1"&&(t.fill=e.colorChannel1),s.tag==="mask"&&t.id&&(t.id=t.id+r.idSuffix),Object.entries(t).forEach(([i,a])=>{i==="mask"&&typeof a=="string"&&(t[i]=a.replace(/url\(#(.*)\)/,`url(#$1${r.idSuffix})`))});const{defIds:n}=r;return!n||n.length===0||(s.tag==="use"&&t["xlink:href"]&&(t["xlink:href"]=t["xlink:href"]+r.idSuffix),Object.entries(t).forEach(([i,a])=>{typeof a=="string"&&(t[i]=a.replace(/url\(#(.*)\)/,`url(#$1${r.idSuffix})`))})),t}function ze(s,r){var t;const{defIds:e}=r;return!e||e.length===0?s:s.tag==="defs"&&((t=s.children)!=null&&t.length)?{...s,children:s.children.map(n=>typeof n.attrs.id=="string"&&e&&e.includes(n.attrs.id)?{...n,attrs:{...n.attrs,id:n.attrs.id+r.idSuffix}}:n)}:s}function Ye(){return Math.random().toString(36).substring(2,8)}F.displayName="UniverIcon";const Xe={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334C15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334C2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045ZM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334C3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999C15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999C2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544ZM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999C3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421C6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641C9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421C11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946C8.64077 14.6502 8.70566 14.6923 8.77482 14.7209C8.84557 14.7502 8.92314 14.7664 9.00449 14.7664C9.08585 14.7664 9.16342 14.7502 9.23416 14.7209C9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},Pe=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"bottom-icon",ref:e,icon:Xe}))});Pe.displayName="BottomIcon";const qe={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296C9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103C5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103C11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},Ne=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"create-copy-icon",ref:e,icon:qe}))});Ne.displayName="CreateCopyIcon";const Je={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Be=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"group-icon",ref:e,icon:Je}))});Be.displayName="GroupIcon";const Qe={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ue=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"more-down-icon",ref:e,icon:Qe}))});Ue.displayName="MoreDownIcon";const et={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},Re=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"move-down-icon",ref:e,icon:et}))});Re.displayName="MoveDownIcon";const tt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},je=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"move-up-icon",ref:e,icon:tt}))});je.displayName="MoveUpIcon";const rt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9C15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9ZM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9C2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9C13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665C15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665ZM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665C2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665C13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ae=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"topmost-icon",ref:e,icon:rt}))});Ae.displayName="TopmostIcon";const nt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Le=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"ungroup-icon",ref:e,icon:nt}))});Le.displayName="UngroupIcon";const it={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365ZM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365ZM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635ZM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635Z",fillRule:"evenodd",clipRule:"evenodd"}}]},xe=C.forwardRef(function(r,e){return C.createElement(F,Object.assign({},r,{id:"autofill-double-icon",ref:e,icon:it}))});xe.displayName="AutofillDoubleIcon";function He(s){var m;const{popup:r}=s,e=(m=r==null?void 0:r.extraProps)==null?void 0:m.menuItems;if(!e)return null;const t=A.useDependency(h.ICommandService),n=A.useDependency(h.LocaleService),[i,a]=C.useState(!1),[o,c]=C.useState(!1),u=()=>{c(!0)},l=()=>{c(!1)},g=v=>{a(v)},d=v=>{t.executeCommand(v.commandId,v.commandParams),a(!1)},p=i||o,S=e.filter(v=>!v.disable);return f.jsx("div",{onMouseEnter:u,onMouseLeave:l,children:f.jsx(U.DropdownMenu,{align:"start",items:S.map(v=>({type:"item",children:n.t(v.label),onSelect:()=>d(v)})),open:i,onOpenChange:g,children:f.jsxs("div",{className:U.clsx("univer-flex univer-items-center univer-gap-2 univer-rounded univer-p-1 hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-800",U.borderClassName,{"univer-bg-gray-100 dark:!univer-bg-gray-800":i,"univer-bg-white dark:!univer-bg-gray-900":!i}),children:[f.jsx(xe,{className:"univer-fill-primary-600 univer-text-gray-900 dark:!univer-text-white"}),p&&f.jsx(Ue,{className:"dark:!univer-text-white"})]})})})}var at=Object.getOwnPropertyDescriptor,st=(s,r,e,t)=>{for(var n=t>1?void 0:t?at(r,e):r,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=a(n)||n);return n},ke=(s,r)=>(e,t)=>r(e,t,s);let fe=class extends h.Disposable{constructor(s,r){super(),this._componentManager=s,this._commandService=r,this._init()}_initCustomComponents(){const s=this._componentManager;this.disposeWithMe(s.register(Ee,He))}_initCommands(){[he,Q,Ie,de,oe].forEach(s=>this.disposeWithMe(this._commandService.registerCommand(s)))}_init(){this._initCommands(),this._initCustomComponents()}};fe=st([ke(0,h.Inject(A.ComponentManager)),ke(1,h.ICommandService)],fe);function ce(s,r){const e=[];return s.forEach(t=>{const{oKey:n,left:i,top:a,height:o,width:c,angle:u}=t,l=r.getDrawingOKey(n);if(l==null)return e.push(null),!0;const{unitId:g,subUnitId:d,drawingId:p,drawingType:S}=l,m={unitId:g,subUnitId:d,drawingId:p,drawingType:S,transform:{left:i,top:a,height:o,width:c,angle:u}};S===h.DrawingTypeEnum.DRAWING_IMAGE&&(m.srcRect=t.srcRect),e.push(m)}),e}function Ge(s,r,e,t){const n=t.getDrawingByParam(s);if(n==null)return;const i=E.getDrawingShapeKeyByDrawingSearch(s),a=e.getObject(i);if(a&&!(a instanceof y.Group))return;if(a!=null){a.addObject(r);return}const o=new y.Group(i);e.addObject(o,y.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(o),o.addObject(r);const{transform:c}=n;c&&o.transformByState({left:c.left,top:c.top,angle:c.angle})}function $e(s,r){var i;const e=r?s.getUnit(r):s.getFocusedUnit();if(e==null)return;const t=e.getUnitId();let n;return e.type===h.UniverInstanceType.UNIVER_SHEET?n=(i=e.getActiveSheet())==null?void 0:i.getSheetId():(e.type===h.UniverInstanceType.UNIVER_DOC||e.type===h.UniverInstanceType.UNIVER_SLIDE)&&(n=t),{unitId:t,subUnitId:n,current:e}}var ot=Object.getOwnPropertyDescriptor,ct=(s,r,e,t)=>{for(var n=t>1?void 0:t?ot(r,e):r,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=a(n)||n);return n},pe=(s,r)=>(e,t)=>r(e,t,s);let me=class extends h.Disposable{constructor(r,e,t,n){super();J(this,"_sceneListenerOnDrawingMap",new WeakSet);this._currentUniverService=r,this._commandService=e,this._renderManagerService=t,this._drawingManagerService=n,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){const r=this._drawingManagerService.drawingManagerData,e=$e(this._currentUniverService);if(e==null)return;const{unitId:t,subUnitId:n}=e;Object.keys(r).forEach(i=>{Object.keys(r[i]).forEach(a=>{const o=r[i][a].data;o==null||i!==t||a!==n||Object.keys(o).forEach(c=>{o[c]&&this._insertDrawing([{unitId:i,subUnitId:a,drawingId:c}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(r=>{if(r.id===de.id){const e=r.params;if(e==null)return;this._drawingAlign(e)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(r=>{this._groupDrawings(r)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(r=>{this._ungroupDrawings(r)}))}_getSceneAndTransformerByDrawingSearch(r){if(r==null)return;const e=this._renderManagerService.getRenderById(r),t=e==null?void 0:e.scene;if(t==null)return null;const n=t.getTransformerByCreate();return{scene:t,transformer:n}}_groupDrawings(r){r.forEach(e=>{this._groupDrawing(e)})}_groupDrawing(r){const{parent:e,children:t}=r,{unitId:n,subUnitId:i,drawingId:a}=e,o=this._getSceneAndTransformerByDrawingSearch(e.unitId);if(o==null)return;const{scene:c,transformer:u}=o;this._commandService.syncExecuteCommand(Q.id);const l=[];if(t.forEach(p=>{const S=E.getDrawingShapeKeyByDrawingSearch(p),m=c.getObjectIncludeInGroup(S);if(m==null||l.includes(m))return;l.push(m);const{transform:v}=p;v!=null&&(m.classType===y.RENDER_CLASS_TYPE.GROUP?m.transformByState({left:v.left,top:v.top}):m.transformByState(v))}),l.length===0)return;const g=E.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:i,drawingId:a}),d=new y.Group(g);c.addObject(d,y.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(d),d.addObjects(...l),e.transform&&d.transformByState({left:e.transform.left,top:e.transform.top}),u.clearSelectedObjects(),u.setSelectedControl(d)}_ungroupDrawings(r){r.forEach(e=>{this._ungroupDrawing(e)})}_ungroupDrawing(r){const{parent:e,children:t}=r,n=this._getSceneAndTransformerByDrawingSearch(e.unitId);if(n==null)return;const{scene:i,transformer:a}=n;t.forEach(g=>{const d=E.getDrawingShapeKeyByDrawingSearch(g),p=i.getObjectIncludeInGroup(d);if(p==null)return!0;if(p==null)return;const{transform:S}=g;S!=null&&(p.classType===y.RENDER_CLASS_TYPE.GROUP?p.transformByState({left:S.left,top:S.top}):p.transformByState(S))});const o=E.getDrawingShapeKeyByDrawingSearch(e),c=i.getObject(o),{width:u,height:l}=c;c.getObjects().forEach(g=>{c.removeSelfObjectAndTransform(g.oKey,u,l)}),c.dispose(),a.clearSelectedObjects()}_drawingAlign(r){const{alignType:e}=r,t=this._drawingManagerService.getFocusDrawings();if(e===R.default)return;const n=[];let i=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,u=0;t.forEach(l=>{const{unitId:g,subUnitId:d,drawingId:p,drawingType:S}=l,m=this._drawingManagerService.getDrawingByParam({unitId:g,subUnitId:d,drawingId:p});if(m==null||m.transform==null)return;n.push({unitId:g,subUnitId:d,drawingId:p,drawingType:S,transform:m.transform});const{left:v=0,top:_=0,width:I=0,height:M=0}=m.transform;i=Math.min(i,v),a=Math.min(a,_),o=Math.max(o,v+I),c=Math.max(c,_+M),u++}),u!==0&&(this._sortDrawingTransform(n,e),this._applyAlignType(n,e,i,a,o,c,u))}_applyAlignType(r,e,t,n,i,a,o){const c=Math.round((i-t)/o*10)/10,u=Math.round((a-n)/o*10)/10,l=[],g=this._getSceneAndTransformerByDrawingSearch(r[0].unitId);if(g==null)return;const{scene:d,transformer:p}=g;r.forEach((S,m)=>{const{unitId:v,subUnitId:_,drawingId:I,transform:M,drawingType:N}=S,{left:j=0,top:b=0,width:T=0,height:O=0}=M;let B=j,P=b;switch(e){case R.left:B=t;break;case R.center:B=t+(i-t)/2-T/2;break;case R.right:B=i-T;break;case R.top:P=n;break;case R.middle:P=n+(a-n)/2-O/2;break;case R.bottom:P=a-O;break;case R.horizon:B=t+c*m;break;case R.vertical:P=n+u*m;break}(B!==j||P!==b)&&l.push({unitId:v,subUnitId:_,drawingId:I,drawingType:N,transform:{left:B,top:P}})}),this._drawingManagerService.featurePluginUpdateNotification(l),p.refreshControls().changeNotification()}_sortDrawingTransform(r,e){r.sort((t,n)=>{const i=t.transform,a=n.transform,{left:o=0,top:c=0,width:u=0,height:l=0}=i,{left:g=0,top:d=0,width:p=0,height:S=0}=a;switch(e){case R.left:return o-g;case R.center:return o+u/2-(g+p/2);case R.right:return o+u-(g+p);case R.top:return c-d;case R.middle:return c+l/2-(d+S/2);case R.bottom:return c+l-(d+S);case R.horizon:return o+u/2-(g+p/2);case R.vertical:return c+l/2-(d+S/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(r=>{this._drawingArrange(r)}))}_drawingArrange(r){const{unitId:e,subUnitId:t,drawingIds:n}=r,i=this._getSceneAndTransformerByDrawingSearch(e);if(i==null)return;const{scene:a}=i;n.forEach(o=>{const c=E.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:t,drawingId:o}),u=a.fuzzyMathObjects(c,!0);if(u==null||u.length===0)return;const l=this._drawingManagerService.getDrawingOrder(e,t).indexOf(o);for(const g of u)g.setProps({zIndex:l}),g.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(r=>{this._insertDrawing(r)}))}_insertDrawing(r){const e=[];r.forEach(t=>{const{unitId:n}=t;if(this._drawingManagerService.getDrawingByParam(t)==null)return;const a=this._getSceneAndTransformerByDrawingSearch(n);if(a==null)return;const{scene:o}=a;e.includes(o)||e.push(o)}),e.forEach(t=>{this._sceneListenerOnDrawingMap.has(t)||(this._addListenerOnDrawing(t),this._sceneListenerOnDrawingMap.add(t))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(r=>{r.forEach(e=>{var l;const{unitId:t,subUnitId:n,drawingId:i}=e,a=this._getSceneAndTransformerByDrawingSearch(t);if(a==null)return;const{scene:o}=a,c=E.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:n,drawingId:i}),u=o.fuzzyMathObjects(c,!0);if(u.length>0){for(const g of u)g.dispose();(l=o.getTransformer())==null||l.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(r=>{r.forEach(e=>{var T;const{unitId:t,subUnitId:n,drawingId:i}=e,a=this._drawingManagerService.getDrawingByParam(e);if(a==null)return;const{transform:o,drawingType:c}=a,u=this._getSceneAndTransformerByDrawingSearch(t);if(u==null)return;const{scene:l,transformer:g}=u;if(o==null)return!0;const{left:d=0,top:p=0,width:S=0,height:m=0,angle:v=0,flipX:_=!1,flipY:I=!1,skewX:M=0,skewY:N=0}=o,j=E.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:n,drawingId:i}),b=l.getObject(j);if(b==null)return!0;b.transformByState({left:d,top:p,width:S,height:m,angle:v,flipX:_,flipY:I,skewX:M,skewY:N}),(T=l.getTransformer())==null||T.debounceRefreshControls()})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(r=>{r.forEach(e=>{const{unitId:t,subUnitId:n,drawingId:i}=e,a=this._getSceneAndTransformerByDrawingSearch(t);if(a==null)return;const o=this._drawingManagerService.getDrawingByParam(e);if(o==null)return;const{transform:c}=o,{scene:u}=a,l=E.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:n,drawingId:i}),g=u.getObject(l);if(g==null||c==null)return!0;const{left:d=0,top:p=0,width:S=0,height:m=0,angle:v=0,flipX:_=!1,flipY:I=!1,skewX:M=0,skewY:N=0}=c;g.transformByState({left:d,top:p,width:S,height:m,angle:v,flipX:_,flipY:I,skewX:M,skewY:N})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(r=>{r.forEach(e=>{const{unitId:t,subUnitId:n,drawingId:i,visible:a}=e,o=this._getSceneAndTransformerByDrawingSearch(t);if(o==null)return;const{scene:c}=o,u=E.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:n,drawingId:i}),l=c.getObject(u);if(l==null)return!0;a?l.show():l.hide()})}))}_filterUpdateParams(r,e){return r.filter((t,n)=>{if(t==null)return!1;const{transform:i}=t;return h.checkIfMove(i,e==null?void 0:e[n])})}_addListenerOnDrawing(r){const e=r.getTransformerByCreate();let t=null;this.disposeWithMe(h.toDisposable(e.changeStart$.subscribe(n=>{const{objects:i}=n,a=Array.from(i.values()),o=[];t=a.map(c=>{const{left:u,top:l,height:g,width:d,angle:p,oKey:S,isInGroup:m}=c,v=this._drawingManagerService.getDrawingOKey(S);if(m||c instanceof y.Group){let _=c.ancestorGroup;if(_==null&&c instanceof y.Group&&(_=c),_==null)return null;const I=this._drawingManagerService.getDrawingOKey(_.oKey);if(I){const{unitId:M,subUnitId:N,drawingId:j}=I;o.push({unitId:M,subUnitId:N,drawingId:j});const{left:b,top:T,height:O,width:B,angle:P}=_;return{left:b,top:T,height:O,width:B,angle:P}}}else if(v!=null){const{unitId:_,subUnitId:I,drawingId:M}=v;return o.push({unitId:_,subUnitId:I,drawingId:M}),{left:u,top:l,height:g,width:d,angle:p}}return null}).filter(c=>c!=null),o.length>0?this._commandService.syncExecuteCommand(E.SetDrawingSelectedOperation.id,o):this._commandService.syncExecuteCommand(E.SetDrawingSelectedOperation.id,[])}))),this.disposeWithMe(h.toDisposable(e.changeEnd$.subscribe(n=>{const{objects:i}=n,a=this._filterUpdateParams(ce(i,this._drawingManagerService),t);a.length>0&&this._drawingManagerService.featurePluginUpdateNotification(a)})))}};me=ct([pe(0,h.IUniverInstanceService),pe(1,h.ICommandService),pe(2,y.IRenderManagerService),pe(3,E.IDrawingManagerService)],me);class le extends y.Shape{constructor(e,t){t==null&&(t={}),t.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24};super(e,t);J(this,"_srcRect");J(this,"_prstGeom");J(this,"_applyTransform");J(this,"_dragPadding",8);J(this,"_cacheCanvas");t!=null&&t.srcRect&&(this._srcRect=t.srcRect),t!=null&&t.prstGeom&&(this._prstGeom=t.prstGeom),t!=null&&t.applyTransform&&(this._applyTransform=t.applyTransform),t!=null&&t.dragPadding&&(this._dragPadding=t.dragPadding),this._applyProps()}refreshSrcRect(e,t){this._srcRect=e,this._applyTransform=t,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var e;super.dispose(),(e=this._cacheCanvas)==null||e.dispose(),this._srcRect=null}isHit(e){const t=this.getInverseCoord(e);return t.x>=-this.strokeWidth/2&&t.x<=this.width+this.strokeWidth/2&&t.y>=-this.strokeWidth/2&&t.y<=this.height+this.strokeWidth/2&&!this._inSurround(t)}_inSurround(e){const t=this._dragPadding;return e.x>=t-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2-t&&e.y>=t-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2-t}render(e,t){return this.visible?(e.save(),this._draw(e),e.restore(),this.makeDirty(!1),this):(this.makeDirty(!1),this)}_draw(e){var c,u;const n=this.getScene().getEngine(),{width:i,height:a}=n;this._initialCacheCanvas(),(c=this._cacheCanvas)==null||c.clear();const o=(u=this._cacheCanvas)==null?void 0:u.getContext();o!=null&&(o.save(),y.Rect.drawWith(o,{left:0,top:0,width:i,height:a,fill:"rgba(0, 0, 0, 0.5)"}),o.setTransform(e.getTransform()),this._clipForApplyObject(o),this._applyCache(e),o.restore())}_clipForApplyObject(e){let t=0;if(this._prstGeom!=null&&(t=1),e.globalCompositeOperation="destination-out",e.beginPath(),t===0){const n=this.transform.getMatrix();e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),e.rect(0,0,this.width,this.height),e.fill()}}_applyProps(){if(this._applyTransform==null)return;let e=0,t=0,n=0,i=0;const{left:a=0,top:o=0,width:c=0,height:u=0,angle:l}=this._applyTransform;if(this._srcRect!=null){const{left:p=0,top:S=0,right:m=0,bottom:v=0}=this._srcRect;e=p,t=S,n=m,i=v}const g=a+e,d=o+t;this.transformByState({left:g,top:d,width:a+c-n-g,height:o+u-i-d,angle:l})}_applyCache(e){if(!e||this._cacheCanvas==null)return;const t=this._cacheCanvas.getContext();t.save(),e.save(),e.setTransform(1,0,0,1,0,0),t.setTransform(1,0,0,1,0,0),e.drawImage(this._cacheCanvas.getCanvasEle(),0,0),e.restore(),t.restore()}_initialCacheCanvas(){if(this._cacheCanvas!=null)return;const e=this.getScene();if(e==null)return;this._cacheCanvas=new y.Canvas;const t=e.getEngine();this._cacheCanvas.setSize(t.width,t.height),t.onTransformChange$.subscribeEvent(()=>{var n;(n=this._cacheCanvas)==null||n.setSize(t.width,t.height),this.makeDirty(!0)})}}var lt=Object.getOwnPropertyDescriptor,ut=(s,r,e,t)=>{for(var n=t>1?void 0:t?lt(r,e):r,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=a(n)||n);return n},ie=(s,r)=>(e,t)=>r(e,t,s);let ve=class extends h.Disposable{constructor(r,e,t,n,i,a){super();J(this,"_sceneListenerOnImageMap",new WeakSet);this._commandService=r,this._drawingManagerService=e,this._renderManagerService=t,this._univerInstanceService=n,this._messageService=i,this._localeService=a,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(r=>{if(r.id!==oe.id)return;const e=r.params;if(e==null)return;const{cropType:t}=e,n=this._drawingManagerService.getFocusDrawings();if(n.length!==1)return;const i=n[0],{unitId:a,subUnitId:o,drawingId:c}=i,u=this._renderManagerService.getRenderById(a),l=u==null?void 0:u.scene;if(l==null)return!0;this._searchCropObject(l)!=null&&this._commandService.syncExecuteCommand(Q.id,{isAuto:!0});const d=E.getDrawingShapeKeyByDrawingSearch({unitId:a,subUnitId:o,drawingId:c}),p=l.getObject(d);if(!(p instanceof y.Image)){this._messageService.show({type:U.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}p!=null&&(this._updateCropperObject(t,p),this._commandService.executeCommand(he.id,{unitId:a,subUnitId:o,drawingId:c}))}))}_calculateSrcRectByRatio(r,e,t,n,i,a){const o=t/n,c=i/a;let u=t,l=n;o>c?u=n*c:l=t/c;const g=(t-u)/2,d=(n-l)/2;return{left:y.precisionTo(g,1),top:y.precisionTo(d,1),right:y.precisionTo(t-(g+u),1),bottom:y.precisionTo(n-(d+l),1)}}_updateCropperObject(r,e){const{left:t,top:n,width:i,height:a}=e.calculateTransformWithSrcRect();let o;switch(r){case x.R1_1:o=this._calculateSrcRectByRatio(t,n,i,a,1,1);break;case x.R16_9:o=this._calculateSrcRectByRatio(t,n,i,a,16,9);break;case x.R9_16:o=this._calculateSrcRectByRatio(t,n,i,a,9,16);break;case x.R5_4:o=this._calculateSrcRectByRatio(t,n,i,a,5,4);break;case x.R4_5:o=this._calculateSrcRectByRatio(t,n,i,a,4,5);break;case x.R4_3:o=this._calculateSrcRectByRatio(t,n,i,a,4,3);break;case x.R3_4:o=this._calculateSrcRectByRatio(t,n,i,a,3,4);break;case x.R3_2:o=this._calculateSrcRectByRatio(t,n,i,a,3,2);break;case x.R2_3:o=this._calculateSrcRectByRatio(t,n,i,a,2,3);break;case x.FREE:}if(o==null)return;e.setSrcRect(o);const{left:c=0,top:u=0,bottom:l=0,right:g=0}=o;e.transformByStateCloseCropper({left:t+c,top:n+u,width:i-g-c,height:a-l-u})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(r=>{if(r.id!==he.id)return;const e=r.params;if(e==null)return;const{unitId:t,subUnitId:n,drawingId:i}=e,a=this._renderManagerService.getRenderById(t),o=a==null?void 0:a.scene;if(o==null)return!0;if(this._sceneListenerOnImageMap.has(o)||(this._addListenerOnImage(o),this._sceneListenerOnImageMap.add(o)),this._drawingManagerService.getDrawingByParam({unitId:t,subUnitId:n,drawingId:i})==null)return;const u=E.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:n,drawingId:i}),l=o.getObject(u);if(l==null)return;if(!(l instanceof y.Image)){this._messageService.show({type:U.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}const g=o.getTransformer();g==null||g.clearControls();const d=new le(`${u}-crop`,{srcRect:l.srcRect,prstGeom:l.prstGeom,applyTransform:l.calculateTransformWithSrcRect()});o.addObject(d,l.getLayerIndex()+1).attachTransformerTo(d),g==null||g.createControlForCopper(d),this._addHoverForImageCopper(d),l.openRenderByCropper(),g==null||g.refreshControls(),d.makeDirty(!0),this._commandService.syncExecuteCommand(E.SetDrawingSelectedOperation.id,[{unitId:t,subUnitId:n,drawingId:i}])}))}_searchCropObject(r){const e=r.getAllObjectsByOrder();for(const t of e)if(t instanceof le)return t}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==Q.id)return;const t=this._univerInstanceService.getFocusedUnit();if(t==null)return;const n=t.getUnitId(),i=this._renderManagerService.getRenderById(n),a=i==null?void 0:i.scene;if(a==null)return!0;const o=this._searchCropObject(a);if(o==null)return;const c=this._getApplyObjectByCropObject(o);if(c==null)return;const u=a.getTransformerByCreate();u.detachFrom(o),u.clearCopperControl();const l=this._getSrcRectByTransformState(c,o),g=this._drawingManagerService.getDrawingOKey(c.oKey);if(g!=null){const{left:d,top:p,height:S,width:m}=o;this._drawingManagerService.featurePluginUpdateNotification([{...g,transform:{...g.transform,left:d,top:p,height:S,width:m},srcRect:l.srcRectAngle}])}c.setSrcRect({...l.srcRectAngle}),c.closeRenderByCropper(),c.makeDirty(!0),o==null||o.dispose()}));const r=this._univerInstanceService.getCurrentTypeOfUnit$(h.UniverInstanceType.UNIVER_SHEET).pipe(Me.switchMap(e=>e?e.activeSheet$:Me.of(null)));this.disposeWithMe(r.subscribe(()=>{this._commandService.syncExecuteCommand(Q.id)}))}_getApplyObjectByCropObject(r){const e=r.oKey,t=e.slice(0,e.length-5),n=r.getScene();if(!n)return null;const i=n.getObject(t);return i==null?null:i}_addListenerOnImage(r){const e=r.getTransformerByCreate();let t=null;this.disposeWithMe(e.changeStart$.subscribe(n=>{const{objects:i}=n,a=i.values().next().value;if(a==null||!(a instanceof le))return;const{left:o,top:c,height:u,width:l,angle:g}=a;t={left:o,top:c,height:u,width:l,angle:g},e.clearCopperControl()})),this.disposeWithMe(e.changeEnd$.subscribe(n=>{const{objects:i}=n,a=i.values().next().value;if(a==null||!(a instanceof le))return;const{left:o,top:c,height:u,width:l,angle:g}=a;if(!h.checkIfMove({left:o,top:c,height:u,width:l,angle:g},t))return;const d=this._getApplyObjectByCropObject(a);if(d==null)return;const p=this._getSrcRectByTransformState(d,a);a.refreshSrcRect(p.srcRect,d.getState()),e.createControlForCopper(a)})),this._endCropListener(r)}_addHoverForImageCopper(r){this.disposeWithMe(r.onPointerEnter$.subscribeEvent(()=>{r.cursor=y.CURSOR_TYPE.MOVE})),this.disposeWithMe(r.onPointerLeave$.subscribeEvent(()=>{r.cursor=y.CURSOR_TYPE.DEFAULT}))}_endCropListener(r){const e=r.getTransformerByCreate();this.disposeWithMe(e.clearControl$.subscribe(t=>{t===!0&&this._commandService.syncExecuteCommand(Q.id)}))}_getSrcRectByTransformState(r,e){const{left:t,top:n,height:i,width:a,strokeWidth:o,angle:c}=e,{left:u,top:l,width:g,height:d,angle:p,strokeWidth:S}=r,m=t-u,v=n-l,_={left:m,top:v,right:g-m-a,bottom:d-v-i},I={..._};if(p!==0){const M=t+a/2,N=n+i/2,j=new y.Vector2(M,N),b=g/2+u,T=d/2+l,O=new y.Vector2(b,T),B=new y.Vector2(u,l);B.rotateByPoint(y.degToRad(p),O);const P=B.clone();P.rotateByPoint(y.degToRad(-p),j);const G=t-P.x,H=n-P.y;I.left=G,I.top=H,I.right=g-G-a,I.bottom=d-H-i}return{srcRect:_,srcRectAngle:I}}};ve=ut([ie(0,h.ICommandService),ie(1,E.IDrawingManagerService),ie(2,y.IRenderManagerService),ie(3,h.IUniverInstanceService),ie(4,A.IMessageService),ie(5,h.Inject(h.LocaleService))],ve);var gt=Object.getOwnPropertyDescriptor,dt=(s,r,e,t)=>{for(var n=t>1?void 0:t?gt(r,e):r,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=a(n)||n);return n},ye=(s,r)=>(e,t)=>r(e,t,s);D.DrawingRenderService=class{constructor(r,e,t){this._drawingManagerService=r,this._imageIoService=e,this._galleryService=t}async renderImages(r,e){const{transform:t,drawingType:n,source:i,imageSourceType:a,srcRect:o,prstGeom:c,groupId:u,unitId:l,subUnitId:g,drawingId:d,isMultiTransform:p,transforms:S}=r;if(n!==h.DrawingTypeEnum.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||t==null)return;const m=p&&S?S:[t],v=[];for(const _ of m){const{left:I,top:M,width:N,height:j,angle:b,flipX:T,flipY:O,skewX:B,skewY:P}=_,G=m.indexOf(_),H=E.getDrawingShapeKeyByDrawingSearch({unitId:l,subUnitId:g,drawingId:d},p?G:void 0),V=e.getObject(H);if(V!=null){V.transformByState({left:I,top:M,width:N,height:j,angle:b,flipX:T,flipY:O,skewX:B,skewY:P});continue}const Y=this._drawingManagerService.getDrawingOrder(l,g),ae=Y.indexOf(d),te={..._,zIndex:ae===-1?Y.length-1:ae},re=this._imageIoService.getImageSourceCache(i,a);let se=!1;if(re!=null)te.image=re;else{if(a===E.ImageSourceType.UUID)try{te.url=await this._imageIoService.getImage(i)}catch(De){console.error(De);continue}else te.url=i;se=!0}if(e.getObject(H))continue;te.printable=!0;const X=new y.Image(H,te);se&&this._imageIoService.addImageSourceCache(i,a,X.getNative()),this._drawingManagerService.getDrawingVisible()&&(e.addObject(X,y.DRAWING_OBJECT_LAYER_INDEX),this._drawingManagerService.getDrawingEditable()&&e.attachTransformerTo(X),u&&Ge({drawingId:u,unitId:l,subUnitId:g},X,e,this._drawingManagerService),c!=null&&X.setPrstGeom(c),o!=null&&X.setSrcRect(o),v.push(X))}return v}renderFloatDom(r,e){const{transform:t,drawingType:n,groupId:i,unitId:a,subUnitId:o,drawingId:c,isMultiTransform:u,transforms:l}=r;if(n!==h.DrawingTypeEnum.DRAWING_DOM||!this._drawingManagerService.getDrawingVisible()||t==null)return;const g=u&&l?l:[t],d=[];for(const p of g){const{left:S,top:m,width:v,height:_,angle:I,flipX:M,flipY:N,skewX:j,skewY:b}=p,T=g.indexOf(p),O=E.getDrawingShapeKeyByDrawingSearch({unitId:a,subUnitId:o,drawingId:c},u?T:void 0),B=e.getObject(O);if(B!=null){B.transformByState({left:S,top:m,width:v,height:_,angle:I,flipX:M,flipY:N,skewX:j,skewY:b});continue}const P=this._drawingManagerService.getDrawingOrder(a,o),G=P.indexOf(c),H={...p,zIndex:G===-1?P.length-1:G};if(e.getObject(O))continue;H.printable=!1;const V=new y.Rect(O,H);this._drawingManagerService.getDrawingVisible()&&(e.addObject(V,y.DRAWING_OBJECT_LAYER_INDEX),this._drawingManagerService.getDrawingEditable()&&r.allowTransform!==!1&&e.attachTransformerTo(V),i&&Ge({drawingId:i,unitId:a,subUnitId:o},V,e,this._drawingManagerService),d.push(V))}return d}renderDrawing(r,e){const t=this._drawingManagerService.getDrawingByParam(r);if(t!=null)switch(t.drawingType){case h.DrawingTypeEnum.DRAWING_IMAGE:return this.renderImages(t,e)}}previewImage(r,e,t,n){this._galleryService.open({images:[e],onOpenChange:i=>{i||this._galleryService.close()}})}_adjustImageSize(r,e,t,n){if(r<=t&&e<=n)return{width:r,height:e};const i=t/r,a=n/e,o=Math.min(i,a);return{width:Math.floor(r*o),height:Math.floor(e*o)}}},D.DrawingRenderService=dt([ye(0,E.IDrawingManagerService),ye(1,E.IImageIoService),ye(2,A.IGalleryService)],D.DrawingRenderService);var ht=Object.getOwnPropertyDescriptor,ft=(s,r,e,t)=>{for(var n=t>1?void 0:t?ht(r,e):r,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=a(n)||n);return n},ee=(s,r)=>(e,t)=>r(e,t,s);let we=class extends h.Disposable{constructor(s,r,e,t,n,i,a){super(),this._commandService=s,this._renderManagerService=r,this._drawingManagerService=e,this._dialogService=t,this._imageIoService=n,this._currentUniverService=i,this._drawingRenderService=a,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(s=>{if(s.id===Ie.id){const r=s.params;if(r==null)return;this._resetImageSize(r)}}))}_getSceneAndTransformerByDrawingSearch(s){if(s==null)return;const r=this._renderManagerService.getRenderById(s),e=r==null?void 0:r.scene;if(e==null)return null;const t=e.getTransformerByCreate();return{scene:e,transformer:t}}_resetImageSize(s){const r=[],e=[];s.forEach(t=>{const{unitId:n,subUnitId:i,drawingId:a}=t,o=this._getSceneAndTransformerByDrawingSearch(n);if(o==null)return;const{scene:c}=o,u=E.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:i,drawingId:a}),l=c.getObject(u);if(l==null)return!0;const g=this._drawingManagerService.getDrawingByParam(t);if(g==null)return!0;if(g.drawingType!==h.DrawingTypeEnum.DRAWING_IMAGE)return;l.resetSize();const{width:d,height:p}=l.getNativeSize();e.includes(c)===!1&&e.push(c),r.push({...g,transform:{...g.transform,height:p,width:d,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(r),e.forEach(t=>{t.getTransformerByCreate().refreshControls().changeNotification()}),this._commandService.syncExecuteCommand(E.SetDrawingSelectedOperation.id,s)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(s=>{this._insertImages(s)}))}_insertImages(s){s.forEach(async r=>{var c;const{unitId:e,subUnitId:t}=r,n=this._getSceneAndTransformerByDrawingSearch(e),i=(c=$e(this._currentUniverService,e))==null?void 0:c.subUnitId;if(n==null||i!==t)return;const a=this._drawingManagerService.getDrawingByParam(r);if(a==null)return;const o=await this._drawingRenderService.renderImages(a,n.scene);if(this._drawingManagerService.refreshTransform([a]),!(o==null||o.length===0))for(const u of o)this._addHoverForImage(u),this._addDialogForImage(u)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(s=>{s.forEach(r=>{const{unitId:e,subUnitId:t,drawingId:n}=r,i=this._drawingManagerService.getDrawingByParam(r);if(i==null)return;const{transform:a,drawingType:o,srcRect:c,prstGeom:u,source:l,imageSourceType:g}=i;if(o!==h.DrawingTypeEnum.DRAWING_IMAGE)return;const d=this._getSceneAndTransformerByDrawingSearch(e);if(d==null)return;const{scene:p,transformer:S}=d;if(a==null)return!0;const m=E.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:t,drawingId:n}),v=p.getObject(m);if(v==null)return!0;v.setSrcRect(c),v.setPrstGeom(u),l!=null&&l.length>0&&(g===h.ImageSourceType.BASE64||g===h.ImageSourceType.URL)&&v.changeSource(l)})}))}_addHoverForImage(s){this.disposeWithMe(h.toDisposable(s.onPointerEnter$.subscribeEvent(()=>{s.cursor=y.CURSOR_TYPE.GRAB}))),this.disposeWithMe(h.toDisposable(s.onPointerLeave$.subscribeEvent(()=>{s.cursor=y.CURSOR_TYPE.DEFAULT})))}_addDialogForImage(s){this.disposeWithMe(h.toDisposable(s.onDblclick$.subscribeEvent(()=>{const r=`${s.oKey}-viewer-dialog`;this._drawingRenderService.previewImage(r,s.getNative().src,s.getNativeSize().width,s.getNativeSize().height)})))}};we=ft([ee(0,h.ICommandService),ee(1,y.IRenderManagerService),ee(2,E.IDrawingManagerService),ee(3,A.IDialogService),ee(4,E.IImageIoService),ee(5,h.IUniverInstanceService),ee(6,h.Inject(D.DrawingRenderService))],we);var pt=Object.getOwnPropertyDescriptor,mt=(s,r,e,t)=>{for(var n=t>1?void 0:t?pt(r,e):r,i=s.length-1,a;i>=0;i--)(a=s[i])&&(n=a(n)||n);return n},Ve=(s,r)=>(e,t)=>r(e,t,s);const vt="UNIVER_DRAWING_UI_PLUGIN";D.UniverDrawingUIPlugin=(be=class extends h.Plugin{constructor(r=Oe,e,t){super(),this._config=r,this._injector=e,this._configService=t;const{menu:n,...i}=h.merge({},Oe,this._config);n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(Ze,i)}onStarting(){this._initDependencies()}onRendered(){this._injector.get(me),this._injector.get(fe),this._injector.get(ve),this._injector.get(we)}_initDependencies(){[[D.DrawingRenderService],[me],[fe],[ve],[we]].forEach(e=>this._injector.add(e))}},J(be,"pluginName",vt),be),D.UniverDrawingUIPlugin=mt([Ve(1,h.Inject(h.Injector)),Ve(2,h.IConfigService)],D.UniverDrawingUIPlugin);const wt=s=>{const r=A.useDependency(h.ICommandService),e=A.useDependency(h.LocaleService),{alignShow:t}=s,[n,i]=C.useState(R.default),a=[{label:e.t("image-panel.align.default"),value:R.default},{options:[{label:e.t("image-panel.align.left"),value:R.left},{label:e.t("image-panel.align.center"),value:R.center},{label:e.t("image-panel.align.right"),value:R.right}]},{options:[{label:e.t("image-panel.align.top"),value:R.top},{label:e.t("image-panel.align.middle"),value:R.middle},{label:e.t("image-panel.align.bottom"),value:R.bottom}]},{options:[{label:e.t("image-panel.align.horizon"),value:R.horizon},{label:e.t("image-panel.align.vertical"),value:R.vertical}]}];function o(c){i(c),r.executeCommand(de.id,{alignType:c})}return f.jsxs("div",{className:U.clsx("univer-relative univer-w-full",{"univer-hidden":!t}),children:[f.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:f.jsx("div",{children:e.t("image-panel.align.title")})}),f.jsx("div",{className:"univer-relative univer-mt-2.5 univer-flex univer-h-full",children:f.jsx("div",{className:"univer-w-full univer-text-gray-900 dark:!univer-text-white",children:f.jsx(U.Select,{value:n,options:a,onChange:o})})})]})},St=s=>{const{arrangeShow:r,drawings:e}=s,t=A.useDependency(h.LocaleService),n=A.useDependency(E.IDrawingManagerService),[i,a]=C.useState(e);C.useEffect(()=>{const c=n.focus$.subscribe(u=>{a(u)});return()=>{c.unsubscribe()}},[]);const o=c=>{const u=i[0].unitId,l=i[0].subUnitId,g=i.map(d=>d.drawingId);n.featurePluginOrderUpdateNotification({unitId:u,subUnitId:l,drawingIds:g,arrangeType:c})};return f.jsxs("div",{className:U.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!r}),children:[f.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:f.jsx("div",{children:t.t("image-panel.arrange.title")})}),f.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2",children:[f.jsxs(U.Button,{onClick:()=>{o(h.ArrangeTypeEnum.forward)},children:[f.jsx(je,{}),t.t("image-panel.arrange.forward")]}),f.jsxs(U.Button,{onClick:()=>{o(h.ArrangeTypeEnum.backward)},children:[f.jsx(Re,{}),t.t("image-panel.arrange.backward")]}),f.jsxs(U.Button,{onClick:()=>{o(h.ArrangeTypeEnum.front)},children:[f.jsx(Ae,{}),t.t("image-panel.arrange.front")]}),f.jsxs(U.Button,{onClick:()=>{o(h.ArrangeTypeEnum.back)},children:[f.jsx(Pe,{}),t.t("image-panel.arrange.back")]})]})]})},Ct=s=>{const r=A.useDependency(h.LocaleService),e=A.useDependency(y.IRenderManagerService),t=A.useDependency(E.IDrawingManagerService),{hasGroup:n,drawings:i}=s,[a,o]=C.useState(!1),[c,u]=C.useState(!0),[l,g]=C.useState(!0),d=()=>{const m=t.getFocusDrawings(),{unitId:v,subUnitId:_}=m[0],I=h.generateRandomId(10),M=y.getGroupState(0,0,m.map(b=>b.transform||{})),N={unitId:v,subUnitId:_,drawingId:I,drawingType:h.DrawingTypeEnum.DRAWING_GROUP,transform:M},j=m.map(b=>{const T=b.transform||{left:0,top:0},{unitId:O,subUnitId:B,drawingId:P}=b;return{unitId:O,subUnitId:B,drawingId:P,transform:{...T,left:T.left-M.left,top:T.top-M.top},groupId:I}});t.featurePluginGroupUpdateNotification([{parent:N,children:j}])},p=m=>{if(m.drawingType!==h.DrawingTypeEnum.DRAWING_GROUP)return;const{unitId:v,subUnitId:_,drawingId:I,transform:M={width:0,height:0}}=m;if(M==null)return;const N=t.getDrawingsByGroup({unitId:v,subUnitId:_,drawingId:I});if(N.length===0)return;const j=N.map(b=>{const{transform:T}=b,{unitId:O,subUnitId:B,drawingId:P}=b,G=y.transformObjectOutOfGroup(T||{},M,M.width||0,M.height||0);return{unitId:O,subUnitId:B,drawingId:P,transform:{...T,...G},groupId:void 0}});return{parent:m,children:j}},S=()=>{const v=t.getFocusDrawings().map(_=>p(_)).filter(_=>_!=null);v.length!==0&&t.featurePluginUngroupUpdateNotification(v)};return C.useEffect(()=>{const m=i[0];if(m==null)return;const{unitId:v}=m,_=e.getRenderById(v),I=_==null?void 0:_.scene;if(I==null)return;const M=I.getTransformerByCreate(),N=M.clearControl$.subscribe(b=>{b===!0&&o(!1)}),j=M.changeStart$.subscribe(b=>{const{objects:T}=b,O=ce(T,t),B=O.filter(V=>(V==null?void 0:V.drawingType)===h.DrawingTypeEnum.DRAWING_GROUP);let P=!1,G=!1;O.length>1&&(P=!0),B.length>0&&(G=!0),o(P||G),u(P),g(G)});return()=>{j.unsubscribe(),N.unsubscribe()}},[]),f.jsxs("div",{className:U.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":n===!0&&a===!1||n===!1}),children:[f.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:f.jsx("div",{children:r.t("image-panel.group.title")})}),f.jsxs("div",{className:"univer-flex univer-items-center univer-justify-center univer-gap-2",children:[f.jsxs(U.Button,{className:U.clsx({"univer-hidden":!c}),onClick:d,children:[f.jsx(Be,{}),r.t("image-panel.group.group")]}),f.jsxs(U.Button,{className:U.clsx({"univer-hidden":!l}),onClick:S,children:[f.jsx(Le,{}),r.t("image-panel.group.unGroup")]})]})]})},Se=20,Ce=20,We=[-360,360],_e=300,_t=s=>{var Ke;const r=A.useDependency(h.LocaleService),e=A.useDependency(E.IDrawingManagerService),t=A.useDependency(y.IRenderManagerService),{drawings:n,transformShow:i}=s,a=n[0];if(a==null)return;const o=a.transform;if(o==null)return;const{unitId:c,subUnitId:u,drawingId:l,drawingType:g}=a,d=t.getRenderById(c),p=d==null?void 0:d.scene;if(p==null)return;const S=(Ke=p.getEngine())==null?void 0:Ke.activeScene;if(S==null)return;const m=p.getTransformerByCreate(),{width:v=0,height:_=0,left:I=0,top:M=0,angle:N=0}=o,[j,b]=C.useState(v),[T,O]=C.useState(_),[B,P]=C.useState(I),[G,H]=C.useState(M),[V,Y]=C.useState(N),[ae,te]=C.useState(m.keepRatio),re=(w,L,$,W)=>{const{width:k,height:q}=S,{ancestorLeft:K,ancestorTop:Z}=p;let z=w,ne=L,ue=$,ge=W;return w+K<0&&(z=-K),L+Z<0&&(ne=-Z),ue=k-z-K,ue<Se&&(ue=Se),ge=q-ne-Z,ge<Ce&&(ge=Ce),w+ue+K>k&&(z=k-$-K),L+ge+Z>q&&(ne=q-W-Z),{limitLeft:z,limitTop:ne,limitWidth:ue,limitHeight:ge}},se=w=>{const{objects:L}=w,$=ce(L,e);if($.length!==1)return;const W=$[0];if(W==null)return;const{transform:k}=W;if(k==null)return;const{width:q,height:K,left:Z,top:z,angle:ne}=k;q!=null&&b(q),K!=null&&O(K),Z!=null&&P(Z),z!=null&&H(z),ne!=null&&Y(ne)};C.useEffect(()=>{const w=[m.changeStart$.subscribe(L=>{se(L)}),m.changing$.subscribe(L=>{se(L)}),m.changeEnd$.subscribe(L=>{se(L)}),e.focus$.subscribe(L=>{if(L.length!==1)return;const $=e.getDrawingByParam(L[0]);if($==null)return;const W=$.transform;if(W==null)return;const{width:k,height:q,left:K,top:Z,angle:z}=W;k!=null&&b(k),q!=null&&O(q),K!=null&&P(K),Z!=null&&H(Z),z!=null&&Y(z)})];return()=>{w.forEach(L=>L.unsubscribe())}},[]);const X=h.debounce(w=>{if(w==null)return;const{limitWidth:L,limitHeight:$}=re(B,G,w,T);w=Math.min(w,L);const W={unitId:c,subUnitId:u,drawingId:l,drawingType:g,transform:{width:w}};if(ae){let k=w/j*T;if(k=Math.max(k,Ce),k>$)return;O(k),W.transform.height=k}b(w),e.featurePluginUpdateNotification([W]),m.refreshControls().changeNotification()},_e),De=h.debounce(w=>{if(w==null)return;const{limitHeight:L,limitWidth:$}=re(B,G,j,w);w=Math.min(w,L);const W={unitId:c,subUnitId:u,drawingId:l,drawingType:g,transform:{height:w}};if(ae){let k=w/T*j;if(k=Math.max(k,Se),k>$)return;b(k),W.transform.width=k}O(w),e.featurePluginUpdateNotification([W]),m.refreshControls().changeNotification()},_e),bt=h.debounce(w=>{if(w==null)return;const{limitLeft:L}=re(w,G,j,T);w=L;const $={unitId:c,subUnitId:u,drawingId:l,drawingType:g,transform:{left:w}};P(w),e.featurePluginUpdateNotification([$]),m.refreshControls().changeNotification()},_e),Dt=h.debounce(w=>{if(w==null)return;const{limitTop:L}=re(B,w,j,T);w=L;const $={unitId:c,subUnitId:u,drawingId:l,drawingType:g,transform:{top:w}};H(w),e.featurePluginUpdateNotification([$]),m.refreshControls().changeNotification()},_e),Mt=w=>{if(w==null)return;const L={unitId:c,subUnitId:u,drawingId:l,drawingType:g,transform:{angle:w}};Y(w),e.featurePluginUpdateNotification([L]),m.refreshControls().changeNotification()},Ot=w=>{te(w),m.keepRatio=w};return f.jsxs("div",{className:U.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!i}),children:[f.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:f.jsx("div",{children:r.t("image-panel.transform.title")})}),f.jsxs("div",{className:"univer-grid univer-grid-cols-3 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[f.jsxs("div",{children:[f.jsx("span",{children:r.t("image-panel.transform.width")}),f.jsx(U.InputNumber,{precision:1,value:j,min:Se,onChange:w=>{X(w)}})]}),f.jsxs("div",{children:[f.jsx("span",{children:r.t("image-panel.transform.height")}),f.jsx(U.InputNumber,{precision:1,value:T,min:Ce,onChange:w=>{De(w)}})]}),f.jsxs("div",{children:[f.jsx("span",{children:r.t("image-panel.transform.lock")}),f.jsx("div",{className:"univer-text-center",children:f.jsx(U.Checkbox,{checked:ae,onChange:Ot})})]})]}),f.jsxs("div",{className:"univer-grid univer-grid-cols-3 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[f.jsxs("div",{children:[f.jsx("span",{children:r.t("image-panel.transform.x")}),f.jsx(U.InputNumber,{precision:1,value:B,onChange:w=>{bt(w)}})]}),f.jsxs("div",{children:[f.jsx("span",{children:r.t("image-panel.transform.y")}),f.jsx(U.InputNumber,{precision:1,value:G,onChange:w=>{Dt(w)}})]}),f.jsxs("div",{children:[f.jsx("span",{children:r.t("image-panel.transform.rotate")}),f.jsx(U.InputNumber,{precision:1,value:V,min:We[0],max:We[1],onChange:Mt})]})]})]})},It=s=>{const r=A.useDependency(h.ICommandService),e=A.useDependency(h.LocaleService),{drawings:t,cropperShow:n}=s;if(t[0]==null)return;const[a,o]=C.useState(x.FREE),c=C.useRef(!1),u=[{label:e.t("image-panel.crop.mode"),value:x.FREE},{label:"1:1",value:x.R1_1},{label:"16:9",value:x.R16_9},{label:"9:16",value:x.R9_16},{label:"5:4",value:x.R5_4},{label:"4:5",value:x.R4_5},{label:"4:3",value:x.R4_3},{label:"3:4",value:x.R3_4},{label:"3:2",value:x.R3_2},{label:"2:3",value:x.R2_3}];C.useEffect(()=>{const d=r.onCommandExecuted(p=>{if(p.id===Q.id){const S=p.params;S!=null&&S.isAuto||(c.current=!1)}});return()=>{d==null||d.dispose()}},[]);function l(d){o(d),c.current&&r.executeCommand(oe.id,{cropType:d})}const g=d=>{r.executeCommand(oe.id,{cropType:d}),c.current=!0};return f.jsxs("div",{className:U.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!n}),children:[f.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:f.jsx("div",{children:e.t("image-panel.crop.title")})}),f.jsxs("div",{className:"univer-flex univer-items-center univer-justify-center univer-gap-2",children:[f.jsxs(U.Button,{onClick:()=>{g(a)},children:[f.jsx(Ne,{}),e.t("image-panel.crop.start")]}),f.jsx(U.Select,{value:a,options:u,onChange:l})]})]})},yt=s=>{const r=A.useDependency(E.IDrawingManagerService),e=A.useDependency(y.IRenderManagerService),t=A.useDependency(h.LocaleService),{drawings:n,hasArrange:i=!0,hasTransform:a=!0,hasAlign:o=!0,hasCropper:c=!0,hasGroup:u=!0}=s,l=n[0];if(l==null)return;const{unitId:g}=l,d=e.getRenderById(g),p=d==null?void 0:d.scene;if(p==null)return;const S=p.getTransformerByCreate(),[m,v]=C.useState(!0),[_,I]=C.useState(!0),[M,N]=C.useState(!1),[j,b]=C.useState(!0),[T,O]=C.useState(!1);return C.useEffect(()=>{const B=S.clearControl$.subscribe(H=>{H===!0&&(v(!1),I(!1),N(!1),b(!1),O(!0))}),P=S.changeStart$.subscribe(H=>{const{objects:V}=H,Y=ce(V,r);Y.length===0?(v(!1),I(!1),N(!1),b(!1),O(!0)):Y.length===1?(v(!0),I(!0),N(!1),b(!0),O(!1)):(v(!0),I(!1),N(!0),b(!1),O(!1))}),G=r.focus$.subscribe(H=>{H.length===0?(v(!1),I(!1),N(!1),b(!1),O(!0)):H.length===1?(v(!0),I(!0),N(!1),b(!0),O(!1)):(v(!0),I(!1),N(!0),b(!1),O(!1))});return()=>{P.unsubscribe(),B.unsubscribe(),G.unsubscribe()}},[]),f.jsxs(f.Fragment,{children:[f.jsx("div",{className:U.clsx("univer-h-full",{"univer-hidden":!T}),children:f.jsx("div",{className:"univer-flex univer-h-full univer-items-center univer-justify-center",children:f.jsx("span",{children:t.t("image-panel.null")})})}),f.jsx(St,{arrangeShow:i===!0?m:!1,drawings:n}),f.jsx(_t,{transformShow:a===!0?_:!1,drawings:n}),f.jsx(wt,{alignShow:o===!0?M:!1,drawings:n}),f.jsx(It,{cropperShow:c===!0?j:!1,drawings:n}),f.jsx(Ct,{hasGroup:u,drawings:n})]})};D.AutoImageCropOperation=oe,D.COMPONENT_IMAGE_POPUP_MENU=Ee,D.CloseImageCropOperation=Q,D.DrawingCommonPanel=yt,D.ImageCropperObject=le,D.ImagePopupMenu=He,D.ImageResetSizeOperation=Ie,D.OpenImageCropOperation=he,D.SetDrawingAlignOperation=de,D.getUpdateParams=ce,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})}));


// @univerjs/docs-drawing/index
(function(t,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],r):(t=typeof globalThis<"u"?globalThis:t||self,r(t.UniverDocsDrawing={},t.UniverCore,t.UniverDrawing))})(this,(function(t,r,g){"use strict";var P=Object.defineProperty;var N=(t,r,g)=>r in t?P(t,r,{enumerable:!0,configurable:!0,writable:!0,value:g}):t[r]=g;var w=(t,r,g)=>N(t,typeof r!="symbol"?r+"":r,g);var d;class u extends g.UnitDrawingService{}const _=r.createIdentifier("univer.doc.plugin.doc-drawing.service");var S=Object.getOwnPropertyDescriptor,U=(c,i,a,e)=>{for(var n=e>1?void 0:e?S(i,a):i,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=o(n)||n);return n},D=(c,i)=>(a,e)=>i(a,e,c);const l="DOC_DRAWING_PLUGIN";t.DocDrawingController=class extends r.Disposable{constructor(i,a,e,n){super(),this._docDrawingService=i,this._drawingManagerService=a,this._resourceManagerService=e,this._univerInstanceService=n,this._init()}_init(){this._initSnapshot()}_initSnapshot(){const i=e=>{const n=this._univerInstanceService.getUnit(e,r.UniverInstanceType.UNIVER_DOC);if(n){const s=n.getSnapshot().drawings,o=n.getSnapshot().drawingsOrder,v={data:s!=null?s:{},order:o!=null?o:[]};return JSON.stringify(v)}return""},a=e=>{if(!e)return{data:{},order:[]};try{return JSON.parse(e)}catch{return{data:{},order:[]}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:l,businesses:[r.UniverInstanceType.UNIVER_DOC],toJson:e=>i(e),parseJson:e=>a(e),onUnLoad:e=>{this._setDrawingDataForUnit(e,{data:{},order:[]})},onLoad:(e,n)=>{var s,o;this._setDrawingDataForUnit(e,{data:(s=n.data)!=null?s:{},order:(o=n.order)!=null?o:[]})}}))}_setDrawingDataForUnit(i,a){const e=this._univerInstanceService.getUnit(i);e!=null&&(e.resetDrawing(a.data,a.order),this.loadDrawingDataForUnit(i))}loadDrawingDataForUnit(i){const a=this._univerInstanceService.getUnit(i,r.UniverInstanceType.UNIVER_DOC);if(!a)return!1;const e=i,n=a.getDrawings(),s=a.getDrawingsOrder();if(!n||!s)return!1;Object.keys(n).forEach(v=>{const O=n[v];n[v]={...O}});const o={[e]:{unitId:i,subUnitId:e,data:n,order:s}};return this._docDrawingService.registerDrawingData(i,o),this._drawingManagerService.registerDrawingData(i,o),!0}},t.DocDrawingController=U([D(0,_),D(1,g.IDrawingManagerService),D(2,r.IResourceManagerService),D(3,r.IUniverInstanceService)],t.DocDrawingController);const I="docs-drawing.config",h={};var p=Object.getOwnPropertyDescriptor,C=(c,i,a,e)=>{for(var n=e>1?void 0:e?p(i,a):i,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=o(n)||n);return n},f=(c,i)=>(a,e)=>i(a,e,c);t.UniverDocsDrawingPlugin=(d=class extends r.Plugin{constructor(i=h,a,e){super(),this._config=i,this._injector=a,this._configService=e;const{...n}=r.merge({},h,this._config);this._configService.setConfig(I,n)}onStarting(){[[t.DocDrawingController],[u],[_,{useClass:u}]].forEach(i=>this._injector.add(i)),r.touchDependencies(this._injector,[[t.DocDrawingController]])}},w(d,"pluginName",l),w(d,"type",r.UniverInstanceType.UNIVER_DOC),d),t.UniverDocsDrawingPlugin=C([f(1,r.Inject(r.Injector)),f(2,r.IConfigService)],t.UniverDocsDrawingPlugin),t.DOCS_DRAWING_PLUGIN=l,t.DocDrawingService=u,t.IDocDrawingService=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));


// @univerjs/docs-drawing-ui/index
(function(E,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/core"),require("@univerjs/docs-drawing"),require("@univerjs/docs"),require("@univerjs/docs-ui"),require("@univerjs/engine-render"),require("@univerjs/design"),require("@univerjs/drawing"),require("@univerjs/ui"),require("rxjs"),require("@univerjs/drawing-ui"),require("react/jsx-runtime"),require("react")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/docs-drawing","@univerjs/docs","@univerjs/docs-ui","@univerjs/engine-render","@univerjs/design","@univerjs/drawing","@univerjs/ui","rxjs","@univerjs/drawing-ui","react/jsx-runtime","react"],i):(E=typeof globalThis<"u"?globalThis:E||self,i(E.UniverDocsDrawingUi={},E.UniverCore,E.UniverDocsDrawing,E.UniverDocs,E.UniverDocsUi,E.UniverEngineRender,E.UniverDesign,E.UniverDrawing,E.UniverUi,E.rxjs,E.UniverDrawingUi,E.React,E.React))})(this,(function(E,i,Q,k,W,L,$,X,B,Z,he,S,Y){"use strict";var ln=Object.defineProperty;var gn=(E,i,Q)=>i in E?ln(E,i,{enumerable:!0,configurable:!0,writable:!0,value:Q}):E[i]=Q;var le=(E,i,Q)=>gn(E,typeof i!="symbol"?i+"":i,Q);const Re={id:"doc.command.remove-doc-image",type:i.CommandType.COMMAND,handler:(s,e)=>{var P,b,N,H;const t=s.get(i.ICommandService),n=s.get(i.IUniverInstanceService),r=s.get(L.IRenderManagerService),o=n.getCurrentUniverDocInstance();if(e==null||o==null)return!1;const a=r.getRenderById(e.unitId).with(W.DocSelectionRenderService),{drawings:d}=e,l=(P=a.getSegment())!=null?P:"",c=new i.TextX,g=i.JSONX.getInstance(),h=(N=(b=o.getSelfOrHeaderFooterModel(l).getBody())==null?void 0:b.customBlocks)!=null?N:[],u=d.map(R=>h.find(w=>w.blockId===R.drawingId)).filter(R=>!!R).sort((R,w)=>R.startIndex>w.startIndex?1:-1),f=d[0].unitId,p=new i.MemoryCursor;p.reset();const v=u[0].startIndex,I=[{startOffset:v,endOffset:v}],m={id:k.RichTextEditingMutation.id,params:{unitId:f,actions:[],textRanges:I}},T=[];for(const R of u){const{startIndex:w}=R;w>p.cursor&&c.push({t:i.TextXActionType.RETAIN,len:w-p.cursor}),c.push({t:i.TextXActionType.DELETE,len:1}),p.moveCursorTo(w+1)}const y=W.getRichTextEditPath(o,l);T.push(g.editOp(c.serialize(),y));for(const R of u){const{blockId:w}=R,U=((H=o.getDrawings())!=null?H:{})[w],F=o.getDrawingsOrder().indexOf(w),q=g.removeOp(["drawings",w],U),_=g.removeOp(["drawingsOrder",F],w);T.push(q),T.push(_)}return m.params.actions=T.reduce((R,w)=>i.JSONX.compose(R,w),null),!!t.syncExecuteCommand(m.id,m.params)}},Xe={id:"doc.command.delete-drawing",type:i.CommandType.COMMAND,handler:s=>{const e=s.get(i.ICommandService),n=s.get(Q.IDocDrawingService).getFocusDrawings();if(n.length===0)return!1;const{unitId:r}=n[0],o=n.map(a=>{const{unitId:d,subUnitId:l,drawingId:c,drawingType:g}=a;return{unitId:d,subUnitId:l,drawingId:c,drawingType:g}});return e.executeCommand(Re.id,{unitId:r,drawings:o})}},$e={id:"doc.command.group-doc-image",type:i.CommandType.COMMAND,handler:(s,e)=>{s.get(i.ICommandService),s.get(i.IUndoRedoService);const t=s.get(Q.IDocDrawingService);if(!e)return!1;const n=[];e.forEach(({parent:g,children:h})=>{n.push(g.unitId),h.forEach(u=>{n.push(u.unitId)})});const r=t.getGroupDrawingOp(e),{unitId:o,subUnitId:a,undo:d,redo:l,objects:c}=r;return!1}},Ne={id:"doc.command.insert-doc-image",type:i.CommandType.COMMAND,handler:(s,e)=>{var b,N,H,R;if(e==null)return!1;const t=s.get(i.ICommandService),n=s.get(k.DocSelectionManagerService),r=s.get(i.IUniverInstanceService),o=n.getActiveTextRange(),a=r.getCurrentUniverDocInstance();if(o==null||a==null)return!1;const d=a.getUnitId(),{drawings:l}=e,{collapsed:c,startOffset:g,segmentId:h}=o,u=a.getSelfOrHeaderFooterModel(h).getBody();if(u==null)return!1;const f=new i.TextX,p=i.JSONX.getInstance(),v=[],I=(N=(b=a.getSnapshot().drawingsOrder)==null?void 0:b.length)!=null?N:0;let m=0;if(c)g>0&&f.push({t:i.TextXActionType.RETAIN,len:g});else{const w=i.BuildTextUtils.selection.delete([o],u,0,null,!1);f.push(...w);const U=W.getCustomBlockIdsInSelections(u,[o]),z=(H=a.getDrawings())!=null?H:{},F=(R=a.getDrawingsOrder())!=null?R:[],q=U.sort((_,D)=>F.indexOf(_)>F.indexOf(D)?-1:F.indexOf(_)<F.indexOf(D)?1:0);if(q.length>0)for(const _ of q){const D=z[_],A=F.indexOf(_);if(D==null||A<0)continue;const M=p.removeOp(["drawings",_],D),j=p.removeOp(["drawingsOrder",A],_);v.push(M),v.push(j),m++}}f.push({t:i.TextXActionType.INSERT,body:{dataStream:"\b".repeat(l.length),customBlocks:l.map((w,U)=>({startIndex:U,blockId:w.drawingId}))},len:l.length});const T=W.getRichTextEditPath(a,h),y=p.editOp(f.serialize(),T);v.push(y);for(const w of l){const{drawingId:U}=w,z=p.insertOp(["drawings",U],w),F=p.insertOp(["drawingsOrder",I-m],U);v.push(z),v.push(F)}const O={id:k.RichTextEditingMutation.id,params:{unitId:d,actions:[],textRanges:[]}};return O.params.actions=v.reduce((w,U)=>i.JSONX.compose(w,U),null),!!t.syncExecuteCommand(O.id,O.params)}},ze={id:"doc.command.set-drawing-arrange",type:i.CommandType.COMMAND,handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(Q.IDocDrawingService);if(e==null)return!1;const{unitId:r,subUnitId:o,drawingIds:a,arrangeType:d}=e,l={unitId:r,subUnitId:o,drawingIds:a};let c;if(d===i.ArrangeTypeEnum.forward?c=n.getForwardDrawingsOp(l):d===i.ArrangeTypeEnum.backward?c=n.getBackwardDrawingOp(l):d===i.ArrangeTypeEnum.front?c=n.getFrontDrawingsOp(l):d===i.ArrangeTypeEnum.back&&(c=n.getBackDrawingsOp(l)),c==null)return!1;const{redo:g}=c;if(g==null)return!1;const h=[];let u=i.Tools.deepClone(g);u=u.slice(3),u.unshift("drawingsOrder"),h.push(u);const f={id:k.RichTextEditingMutation.id,params:{unitId:r,actions:[],textRanges:null}};return f.params.actions=h.reduce((v,I)=>i.JSONX.compose(v,I),null),!!t.syncExecuteCommand(f.id,f.params)}},qe={id:"doc.command.ungroup-doc-image",type:i.CommandType.COMMAND,handler:(s,e)=>{s.get(i.ICommandService),s.get(i.IUndoRedoService);const t=s.get(Q.IDocDrawingService);if(!e)return!1;const n=[];e.forEach(({parent:g,children:h})=>{n.push(g.unitId),h.forEach(u=>{n.push(u.unitId)})});const r=t.getUngroupDrawingOp(e),{unitId:o,subUnitId:a,undo:d,redo:l,objects:c}=r;return!1}};class xe{constructor(){le(this,"_refreshDrawings$",new Z.BehaviorSubject(null));le(this,"refreshDrawings$",this._refreshDrawings$.asObservable())}refreshDrawings(e){this._refreshDrawings$.next(e)}}var _t=Object.getOwnPropertyDescriptor,Dt=(s,e,t,n)=>{for(var r=n>1?void 0:n?_t(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},ne=(s,e)=>(t,n)=>e(t,n,s);let Fe=class extends i.Disposable{constructor(s,e,t,n,r,o,a,d,l,c,g,h,u){super(),this._context=s,this._commandService=e,this._docSelectionManagerService=t,this._renderManagerSrv=n,this._imageIoService=r,this._docDrawingService=o,this._drawingManagerService=a,this._contextService=d,this._messageService=l,this._localeService=c,this._docSelectionRenderService=g,this._docRefreshDrawingsService=h,this._fileOpenerService=u,this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener(),this._transformDrawingListener(),this._editAreaChangeListener()}dispose(){super.dispose(),delete this._context}async insertDocImage(){const s=await this._fileOpenerService.openFile({multiple:!0,accept:X.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(t=>`.${t.replace("image/","")}`).join(",")}),e=s.length;return e>X.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:$.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(X.DRAWING_IMAGE_COUNT_LIMIT))}),!1):e===0?!1:(await this._insertFloatImages(s),!0)}async _insertFloatImages(s){let e=[];try{e=await Promise.all(s.map(r=>this._imageIoService.saveImage(r)))}catch(r){const o=r.message;let a="";switch(o){case X.ImageUploadStatusType.ERROR_EXCEED_SIZE:a=this._localeService.t("update-status.exceedMaxSize",String(X.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)));break;case X.ImageUploadStatusType.ERROR_IMAGE_TYPE:a=this._localeService.t("update-status.invalidImageType");break;case X.ImageUploadStatusType.ERROR_IMAGE:a=this._localeService.t("update-status.invalidImage");break}this._messageService.show({type:$.MessageType.Error,content:a})}if(e.length===0)return;const{unitId:t}=this._context,n=[];for(const r of e){if(r==null)continue;const{imageId:o,imageSourceType:a,source:d,base64Cache:l}=r,{width:c,height:g,image:h}=await X.getImageSize(l||"");this._imageIoService.addImageSourceCache(o,a,h);let u=1;if(c>X.DRAWING_IMAGE_WIDTH_LIMIT||g>X.DRAWING_IMAGE_HEIGHT_LIMIT){const I=X.DRAWING_IMAGE_WIDTH_LIMIT/c,m=X.DRAWING_IMAGE_HEIGHT_LIMIT/g;u=Math.min(I,m)}const f=this._getImagePosition(c*u,g*u);if(f==null)return;const p={unitId:t,subUnitId:t,drawingId:o,drawingType:i.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:a,source:d,transform:W.docDrawingPositionToTransform(f),docTransform:f,behindDoc:i.BooleanNumber.FALSE,title:"",description:"",layoutType:i.PositionedObjectLayoutType.INLINE,wrapText:i.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0};this._isInsertInHeaderFooter()&&(p.isMultiTransform=i.BooleanNumber.TRUE,p.transforms=p.transform?[p.transform]:null),n.push(p)}this._commandService.executeCommand(Ne.id,{unitId:t,drawings:n})}_isInsertInHeaderFooter(){var n;const{unitId:s}=this._context,e=(n=this._renderManagerSrv.getRenderById(s))==null?void 0:n.with(k.DocSkeletonManagerService).getViewModel(),t=e==null?void 0:e.getEditArea();return t===L.DocumentEditArea.HEADER||t===L.DocumentEditArea.FOOTER}_getImagePosition(s,e){const t=this._docSelectionRenderService.getActiveTextRange(),n=(t==null?void 0:t.getAbsolutePosition())||{left:0};return{size:{width:s,height:e},positionH:{relativeFrom:i.ObjectRelativeFromH.PAGE,posOffset:n.left},positionV:{relativeFrom:i.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(s=>{const{unitId:e,subUnitId:t,drawingIds:n,arrangeType:r}=s;this._commandService.executeCommand(ze.id,{unitId:e,subUnitId:t,drawingIds:n,arrangeType:r})}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(s=>{this._commandService.executeCommand($e.id,s)})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(s=>{this._commandService.executeCommand(qe.id,s)}))}_getCurrentSceneAndTransformer(){const{scene:s,mainComponent:e}=this._context;if(s==null||e==null)return;const t=s.getTransformerByCreate(),{docsLeft:n,docsTop:r}=e.getOffsetConfig();return{scene:s,transformer:t,docsLeft:n,docsTop:r}}_transformDrawingListener(){const s=this._getCurrentSceneAndTransformer();if(s&&s.transformer)this.disposeWithMe(s.transformer.changeEnd$.pipe(Z.debounceTime(30)).subscribe(e=>{this._docSelectionManagerService.refreshSelection()}));else throw new Error("transformer is not init")}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(s=>{var r;const{transformer:e,docsLeft:t,docsTop:n}=(r=this._getCurrentSceneAndTransformer())!=null?r:{};if(s==null||s.length===0)this._contextService.setContextValue(i.FOCUSING_COMMON_DRAWINGS,!1),this._docDrawingService.focusDrawing([]),e&&e.resetProps({zeroTop:0,zeroLeft:0});else{this._contextService.setContextValue(i.FOCUSING_COMMON_DRAWINGS,!0),this._docDrawingService.focusDrawing(s),this._setDrawingSelections(s);const o=this._docSelectionRenderService.getSegment(),a=this._findSegmentIdByDrawingId(s[0].drawingId);o!==a&&this._docSelectionRenderService.setSegment(a),e&&e.resetProps({zeroTop:n,zeroLeft:t})}}))}_findSegmentIdByDrawingId(s){var a,d,l;const{unit:e}=this._context,{body:t,headers:n={},footers:r={}}=e.getSnapshot();if(((a=t==null?void 0:t.customBlocks)!=null?a:[]).some(c=>c.blockId===s))return"";for(const c of Object.keys(n))if((d=n[c].body.customBlocks)!=null&&d.some(g=>g.blockId===s))return c;for(const c of Object.keys(r))if((l=r[c].body.customBlocks)!=null&&l.some(g=>g.blockId===s))return c;return""}_updateDrawingsEditStatus(){var d;const{unit:s,scene:e,unitId:t}=this._context,n=(d=this._renderManagerSrv.getRenderById(t))==null?void 0:d.with(k.DocSkeletonManagerService).getViewModel();if(n==null||s==null)return;const r=s.getSnapshot(),{drawings:o={}}=r,a=n.getEditArea()===L.DocumentEditArea.BODY;for(const l of Object.keys(o)){const c=o[l],g=X.getDrawingShapeKeyByDrawingSearch({unitId:t,drawingId:c.drawingId,subUnitId:t}),h=e.fuzzyMathObjects(g,!0);if(h.length)for(const u of h){e.detachTransformerFrom(u);try{u.setOpacity(.5)}catch{}if(a&&c.isMultiTransform!==i.BooleanNumber.TRUE||!a&&c.isMultiTransform===i.BooleanNumber.TRUE){c.allowTransform!==!1&&e.attachTransformerTo(u);try{u.setOpacity(1)}catch{}}}}}_editAreaChangeListener(){var t;const{unitId:s}=this._context,e=(t=this._renderManagerSrv.getRenderById(s))==null?void 0:t.with(k.DocSkeletonManagerService).getViewModel();e!=null&&(this._updateDrawingsEditStatus(),this.disposeWithMe(e.editAreaChange$.subscribe(()=>{this._updateDrawingsEditStatus()})),this.disposeWithMe(this._docRefreshDrawingsService.refreshDrawings$.subscribe(n=>{n!=null&&queueMicrotask(()=>{this._updateDrawingsEditStatus()})})),this.disposeWithMe(this._commandService.onCommandExecuted(async n=>{n.id===k.RichTextEditingMutation.id&&queueMicrotask(()=>{this._updateDrawingsEditStatus()})})))}_setDrawingSelections(s){var r,o;const{unit:e}=this._context,t=(o=(r=e.getSnapshot().body)==null?void 0:r.customBlocks)!=null?o:[],n=s.map(a=>{const d=a.drawingId,l=t.find(c=>c.blockId===d);return l?l.startIndex:null}).filter(a=>a!==null).map(a=>({startOffset:a,endOffset:a+1}));this._docSelectionManagerService.replaceDocRanges(n)}};Fe=Dt([ne(1,i.ICommandService),ne(2,i.Inject(k.DocSelectionManagerService)),ne(3,L.IRenderManagerService),ne(4,X.IImageIoService),ne(5,Q.IDocDrawingService),ne(6,X.IDrawingManagerService),ne(7,i.IContextService),ne(8,B.IMessageService),ne(9,i.Inject(i.LocaleService)),ne(10,i.Inject(W.DocSelectionRenderService)),ne(11,i.Inject(xe)),ne(12,B.ILocalFileService)],Fe);const Ke={id:"doc.command.insert-float-image",type:i.CommandType.COMMAND,handler:s=>{var n,r;const e=s.get(i.IUniverInstanceService),t=s.get(L.IRenderManagerService);return(r=(n=L.getCurrentTypeOfRenderer(i.UniverInstanceType.UNIVER_DOC,e,t))==null?void 0:n.with(Fe).insertDocImage())!=null?r:!1}};var ie=(s=>(s.INLINE="inline",s.BEHIND_TEXT="behindText",s.IN_FRONT_OF_TEXT="inFrontOfText",s.WRAP_SQUARE="wrapSquare",s.WRAP_TOP_AND_BOTTOM="wrapTopAndBottom",s))(ie||{});const Tt={inline:i.PositionedObjectLayoutType.INLINE,wrapSquare:i.PositionedObjectLayoutType.WRAP_SQUARE,wrapTopAndBottom:i.PositionedObjectLayoutType.WRAP_TOP_AND_BOTTOM,inFrontOfText:i.PositionedObjectLayoutType.WRAP_NONE,behindText:i.PositionedObjectLayoutType.WRAP_NONE};function rt(s,e,t,n,r,o,a){var f,p;const d=new i.TextX,l=i.JSONX.getInstance(),c=[],g=o.getSelfOrHeaderFooterModel(e).getBody(),h=o.getSelfOrHeaderFooterModel(s).getBody();if(g==null||h==null)return;const u=(p=(f=g.customBlocks)==null?void 0:f.find(v=>v.blockId===r))==null?void 0:p.startIndex;if(u!=null){if(n=Math.min(h.dataStream.length-2,n),s===e){if(n<u?(n>0&&d.push({t:i.TextXActionType.RETAIN,len:n}),d.push({t:i.TextXActionType.INSERT,body:{dataStream:"\b",customBlocks:[{startIndex:0,blockId:r}]},len:1}),d.push({t:i.TextXActionType.RETAIN,len:u-n}),d.push({t:i.TextXActionType.DELETE,len:1})):(u>0&&d.push({t:i.TextXActionType.RETAIN,len:u}),d.push({t:i.TextXActionType.DELETE,len:1}),n-u-1>0&&d.push({t:i.TextXActionType.RETAIN,len:n-u-1}),d.push({t:i.TextXActionType.INSERT,body:{dataStream:"\b",customBlocks:[{startIndex:0,blockId:r}]},len:1})),n!==u){const v=W.getRichTextEditPath(o,e),I=l.editOp(d.serialize(),v);c.push(I)}}else{u>0&&d.push({t:i.TextXActionType.RETAIN,len:u}),d.push({t:i.TextXActionType.DELETE,len:1});let v=W.getRichTextEditPath(o,e),I=l.editOp(d.serialize(),v);c.push(I),d.empty(),n>0&&d.push({t:i.TextXActionType.RETAIN,len:n}),d.push({t:i.TextXActionType.INSERT,body:{dataStream:"\b",customBlocks:[{startIndex:0,blockId:r}]},len:1}),v=W.getRichTextEditPath(o,s),I=l.editOp(d.serialize(),v),c.push(I),a.setSegment(s),a.setSegmentPage(t)}return c}}const st={id:"doc.command.update-doc-drawing-wrapping-style",type:i.CommandType.COMMAND,handler:(s,e)=>{var N,H;if(e==null)return!1;const{drawings:t,wrappingStyle:n,unitId:r}=e,o=s.get(i.ICommandService),a=s.get(i.IUniverInstanceService),l=s.get(L.IRenderManagerService).getRenderById(r),c=l==null?void 0:l.with(k.DocSkeletonManagerService).getSkeleton().getSkeletonData(),g=l==null?void 0:l.with(k.DocSkeletonManagerService).getViewModel(),h=l==null?void 0:l.scene,u=a.getCurrentUniverDocInstance();if(u==null||c==null||h==null||g==null)return!1;const f=g.getEditArea(),p=h.getTransformerByCreate(),{pages:v,skeHeaders:I,skeFooters:m}=c,T=i.JSONX.getInstance(),y=[],{drawings:O={}}=u.getSnapshot();for(const R of t){const{drawingId:w}=R,U=O[w].layoutType,z=Tt[n];if(U!==z){const D=T.replaceOp(["drawings",w,"layoutType"],U,z);y.push(D)}if(n==="behindText"||n==="inFrontOfText"){const D=O[w].behindDoc,A=n==="behindText"?i.BooleanNumber.TRUE:i.BooleanNumber.FALSE;if(D!==A){const M=T.replaceOp(["drawings",w,"behindDoc"],D,A);y.push(M)}}if(n==="inline")continue;let F=null,q=0,_=0;for(const D of v){const{headerId:A,footerId:M,marginTop:j,marginLeft:G,marginBottom:C,pageWidth:x,pageHeight:K}=D;switch(f){case L.DocumentEditArea.HEADER:{const V=(N=I.get(A))==null?void 0:N.get(x);V!=null&&V.skeDrawings.has(w)&&(F=V.skeDrawings.get(w),q=V.marginTop,_=G);break}case L.DocumentEditArea.FOOTER:{const V=(H=m.get(M))==null?void 0:H.get(x);V!=null&&V.skeDrawings.has(w)&&(F=V.skeDrawings.get(w),q=K-C+V.marginTop,_=G);break}case L.DocumentEditArea.BODY:{D.skeDrawings.has(w)&&(F=D.skeDrawings.get(w),q=j,_=G);break}}if(F!=null)break}if(F!=null){const{aTop:D,aLeft:A}=F,M=O[w].docTransform.positionH;let j=A;M.relativeFrom===i.ObjectRelativeFromH.MARGIN?j-=_:M.relativeFrom===i.ObjectRelativeFromH.COLUMN&&(j-=F.columnLeft);const G={relativeFrom:M.relativeFrom,posOffset:j};if(M.posOffset!==G.posOffset){const V=T.replaceOp(["drawings",w,"docTransform","positionH"],M,G);y.push(V)}const C=O[w].docTransform.positionV;let x=D;C.relativeFrom===i.ObjectRelativeFromV.PAGE?x+=q:C.relativeFrom===i.ObjectRelativeFromV.LINE?x-=F.lineTop:C.relativeFrom===i.ObjectRelativeFromV.PARAGRAPH&&(x-=F.blockAnchorTop);const K={relativeFrom:C.relativeFrom,posOffset:x};if(C.posOffset!==K.posOffset){const V=T.replaceOp(["drawings",w,"docTransform","positionV"],C,K);y.push(V)}}}const P={id:k.RichTextEditingMutation.id,params:{unitId:r,actions:[],textRanges:null}};P.params.actions=y.reduce((R,w)=>i.JSONX.compose(R,w),null);const b=o.syncExecuteCommand(P.id,P.params);return p.refreshControls(),!!b}},ot={id:"doc.command.update-doc-drawing-distance",type:i.CommandType.COMMAND,handler:(s,e)=>{if(e==null)return!1;const t=s.get(i.ICommandService),r=s.get(i.IUniverInstanceService).getCurrentUniverDocInstance();if(r==null)return!1;const{drawings:o,dist:a,unitId:d}=e,l=i.JSONX.getInstance(),c=[],{drawings:g={}}=r.getSnapshot();for(const f of o){const{drawingId:p}=f;for(const[v,I]of Object.entries(a)){const m=g[p][v];if(m!==I){const T=l.replaceOp(["drawings",p,v],m,I);c.push(T)}}}const h={id:k.RichTextEditingMutation.id,params:{unitId:d,actions:[],textRanges:null}};return h.params.actions=c.reduce((f,p)=>i.JSONX.compose(f,p),null),!!t.syncExecuteCommand(h.id,h.params)}},at={id:"doc.command.update-doc-drawing-wrap-text",type:i.CommandType.COMMAND,handler:(s,e)=>{if(e==null)return!1;const t=s.get(i.ICommandService),r=s.get(i.IUniverInstanceService).getCurrentUniverDocInstance();if(r==null)return!1;const{drawings:o,wrapText:a,unitId:d}=e,l=i.JSONX.getInstance(),c=[],{drawings:g={}}=r.getSnapshot();for(const f of o){const{drawingId:p}=f,v=g[p].wrapText;if(v!==a){const I=l.replaceOp(["drawings",p,"wrapText"],v,a);c.push(I)}}const h={id:k.RichTextEditingMutation.id,params:{unitId:d,actions:[],textRanges:null}};return h.params.actions=c.reduce((f,p)=>i.JSONX.compose(f,p),null),!!t.syncExecuteCommand(h.id,h.params)}},Oe={id:"doc.command.update-drawing-doc-transform",type:i.CommandType.COMMAND,handler:(s,e)=>{if(e==null)return!1;const t=s.get(i.ICommandService),n=s.get(i.IUniverInstanceService),o=s.get(L.IRenderManagerService).getRenderById(e.unitId),a=o==null?void 0:o.scene;if(a==null)return!1;const d=a.getTransformerByCreate(),l=n.getCurrentUniverDocInstance();if(l==null)return!1;const{drawings:c,unitId:g}=e,h=i.JSONX.getInstance(),u=[],{drawings:f={}}=l.getSnapshot();for(const I of c){const{drawingId:m,key:T,value:y}=I,O=f[m].docTransform[T];if(!i.Tools.diffValue(O,y)){const P=h.replaceOp(["drawings",m,"docTransform",T],O,y);u.push(P)}}const p={id:k.RichTextEditingMutation.id,params:{unitId:g,actions:[],textRanges:null,debounce:!0}};p.params.actions=u.reduce((I,m)=>i.JSONX.compose(I,m),null);const v=t.syncExecuteCommand(p.id,p.params);return d.refreshControls(),!!v}},ct={id:"doc.command.move-inline-drawing",type:i.CommandType.COMMAND,handler:(s,e)=>{var H,R;if(e==null)return!1;const t=s.get(L.IRenderManagerService),n=(H=t.getRenderById(e.unitId))==null?void 0:H.with(W.DocSelectionRenderService),r=s.get(xe),o=t.getRenderById(e.unitId),a=o==null?void 0:o.scene,d=o==null?void 0:o.with(k.DocSkeletonManagerService).getSkeleton();if(a==null||n==null)return!1;const l=a.getTransformerByCreate(),c=s.get(i.ICommandService),h=s.get(i.IUniverInstanceService).getCurrentUniverDocInstance();if(h==null)return!1;const{drawing:u,unitId:f,offset:p,segmentId:v,segmentPage:I,needRefreshDrawings:m}=e;if(m)return r.refreshDrawings(d),l.refreshControls(),!0;const T=[],{drawingId:y}=u,O=(R=n.getSegment())!=null?R:"",P=rt(v,O,I,p,y,h,n);if(P==null||P.length===0)return r.refreshDrawings(d),l.refreshControls(),!1;T.push(...P);const b={id:k.RichTextEditingMutation.id,params:{unitId:f,actions:[],textRanges:null}};b.params.actions=T.reduce((w,U)=>i.JSONX.compose(w,U),null);const N=c.syncExecuteCommand(b.id,b.params);return l.refreshControls(),!!N}},dt={id:"doc.command.transform-non-inline-drawing",type:i.CommandType.COMMAND,handler:(s,e)=>{var F,q;if(e==null)return!1;const t=s.get(L.IRenderManagerService),n=(F=t.getRenderById(e.unitId))==null?void 0:F.with(W.DocSelectionRenderService),r=t.getRenderById(e.unitId),o=r==null?void 0:r.scene;if(o==null||n==null)return!1;const a=o.getTransformerByCreate(),d=s.get(i.ICommandService),c=s.get(i.IUniverInstanceService).getCurrentUniverDocInstance();if(c==null)return!1;const{drawing:g,unitId:h,offset:u,docTransform:f,segmentId:p,segmentPage:v}=e,I=[],{drawingId:m}=g,T=(q=n.getSegment())!=null?q:"",y=rt(p,T,v,u,m,c,n);if(y==null)return!1;y.length>0&&I.push(...y);const O=i.JSONX.getInstance(),{drawings:P={}}=c.getSnapshot(),b=P[m].docTransform,{positionH:N,positionV:H,size:R,angle:w}=b;if(!i.Tools.diffValue(N,f.positionH)){const _=O.replaceOp(["drawings",m,"docTransform","positionH"],N,f.positionH);I.push(_)}if(!i.Tools.diffValue(H,f.positionV)){const _=O.replaceOp(["drawings",m,"docTransform","positionV"],H,f.positionV);I.push(_)}if(!i.Tools.diffValue(R,f.size)){const _=O.replaceOp(["drawings",m,"docTransform","size"],R,f.size);I.push(_)}if(!i.Tools.diffValue(w,f.angle)){const _=O.replaceOp(["drawings",m,"docTransform","angle"],w,f.angle);I.push(_)}const U={id:k.RichTextEditingMutation.id,params:{unitId:h,actions:[],textRanges:null,debounce:!0}};U.params.actions=I.reduce((_,D)=>i.JSONX.compose(_,D),null);const z=d.syncExecuteCommand(U.id,U.params);return a.refreshControls(),!!z}},De={id:"doc.command.move-drawing",type:i.CommandType.COMMAND,handler:(s,e)=>{const t=s.get(i.ICommandService),n=s.get(Q.IDocDrawingService),r=s.get(i.IUniverInstanceService),o=s.get(L.IRenderManagerService),{direction:a}=e,d=n.getFocusDrawings();if(d.length===0)return!1;const l=d[0].unitId,c=o.getRenderById(l),g=c==null?void 0:c.scene;if(g==null)return!1;const h=g.getTransformerByCreate(),u=r.getUniverDocInstance(l),f=d.map(v=>{var b,N,H,R,w;const{drawingId:I}=v,m=(b=u==null?void 0:u.getSnapshot().drawings)==null?void 0:b[I];if(m==null||m.layoutType===i.PositionedObjectLayoutType.INLINE)return null;const{positionH:T,positionV:y}=m.docTransform,O={...T},P={...y};return a===i.Direction.UP?P.posOffset=((N=P.posOffset)!=null?N:0)-2:a===i.Direction.DOWN?P.posOffset=((H=P.posOffset)!=null?H:0)+2:a===i.Direction.LEFT?O.posOffset=((R=O.posOffset)!=null?R:0)-2:a===i.Direction.RIGHT&&(O.posOffset=((w=O.posOffset)!=null?w:0)+2),{drawingId:I,key:a===i.Direction.UP||a===i.Direction.DOWN?"positionV":"positionH",value:a===i.Direction.UP||a===i.Direction.DOWN?P:O}}).filter(v=>v!=null);if(f.length===0)return!1;const p=t.syncExecuteCommand(Oe.id,{unitId:l,subUnitId:l,drawings:f});return h.refreshControls(),!!p}},lt={id:"doc.operation.clear-drawing-transformer",type:i.CommandType.MUTATION,handler:(s,e)=>{const t=s.get(L.IRenderManagerService);return e.forEach(n=>{var r,o;(o=(r=t.getRenderById(n))==null?void 0:r.scene.getTransformer())==null||o.debounceRefreshControls()}),!0}},gt="COMPONENT_DOC_DRAWING_PANEL",Ye={id:"sidebar.operation.doc-image",type:i.CommandType.COMMAND,handler:async(s,e)=>{const t=s.get(B.ISidebarService),n=s.get(i.LocaleService),r=s.get(X.IDrawingManagerService);switch(e.value){case"open":t.open({header:{title:n.t("docImage.panel.title")},children:{label:gt},onClose:()=>{r.focusDrawing(null)},width:360});break;case"close":default:t.close();break}return!0}},Je={id:"doc.operation.edit-doc-image",type:i.CommandType.OPERATION,handler:(s,e)=>{const t=s.get(X.IDrawingManagerService),n=s.get(i.ICommandService);return e==null?!1:(t.focusDrawing([e]),n.executeCommand(Ye.id,{value:"open"}),!0)}};var yt=Object.getOwnPropertyDescriptor,Ot=(s,e,t,n)=>{for(var r=n>1?void 0:n?yt(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},Te=(s,e)=>(t,n)=>e(t,n,s);function ut(s,e,t=1,n=0){const{top:r,left:o,bottom:a,right:d}=s,l=d-o,c=a-r,g=e.getViewport(W.VIEWPORT_KEY.VIEW_MAIN),{viewportScrollX:h,viewportScrollY:u}=g,{scaleX:f,scaleY:p}=e.getAncestorScale();return{startX:(o-h)*f,startY:(r-u)*p,endX:(o+l-h)*f,endY:(r+c-u)*p,width:l*f,height:c*p,rotate:n,absolute:{left:!1,top:!1},opacity:t!=null?t:1}}function Ze(s,e){const{top:t,left:n,width:r,height:o,angle:a,opacity:d}=s;return ut({top:t,left:n,bottom:t+o,right:n+r},e.scene,d,a)}E.DocFloatDomController=class extends i.Disposable{constructor(t,n,r,o,a,d){super();le(this,"_domLayerInfoMap",new Map);this._renderManagerService=t,this._drawingManagerService=n,this._drawingRenderService=r,this._canvasFloatDomService=o,this._univerInstanceService=a,this._commandService=d,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddRemoveListener(),this._initScrollAndZoomEvent()}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const n=this._renderManagerService.getRenderById(t);if(n==null)return null;const r=n.scene,o=r.getTransformerByCreate();return{scene:r,transformer:o,renderUnit:n,canvas:n.engine.getCanvasElement()}}_drawingAddRemoveListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{this._insertRects(t)})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(n=>{this._removeDom(n.drawingId)})}))}_insertRects(t){t.forEach(async n=>{const{unitId:r}=n;if(!this._univerInstanceService.getUnit(r,i.UniverInstanceType.UNIVER_DOC))return;const a=this._getSceneAndTransformerByDrawingSearch(r);if(a==null)return;const d=this._drawingManagerService.getDrawingByParam(n);if(d==null)return;const l=await this._drawingRenderService.renderFloatDom(d,a.scene);if(!(l==null||l.length===0))for(const c of l){this._addHoverForRect(c);const g=new i.DisposableCollection,h=Ze(c,a.renderUnit),u=new Z.BehaviorSubject(h),f=a.canvas,p=d.data,v={dispose:g,rect:c,position$:u,unitId:r};this._canvasFloatDomService.addFloatDom({position$:u,id:d.drawingId,componentKey:d.componentKey,onPointerDown:m=>{f.dispatchEvent(new PointerEvent(m.type,m))},onPointerMove:m=>{f.dispatchEvent(new PointerEvent(m.type,m))},onPointerUp:m=>{f.dispatchEvent(new PointerEvent(m.type,m))},onWheel:m=>{f.dispatchEvent(new WheelEvent(m.type,m))},data:p,unitId:r});const I=c.onTransformChange$.subscribeEvent(()=>{const m=Ze(c,a.renderUnit);u.next(m)});g.add(()=>{this._canvasFloatDomService.removeFloatDom(d.drawingId)}),I&&g.add(I),this._domLayerInfoMap.set(d.drawingId,v)}})}_addHoverForRect(t){this.disposeWithMe(i.toDisposable(t.onPointerEnter$.subscribeEvent(()=>{t.cursor=L.CURSOR_TYPE.GRAB}))),this.disposeWithMe(i.toDisposable(t.onPointerLeave$.subscribeEvent(()=>{t.cursor=L.CURSOR_TYPE.DEFAULT})))}_removeDom(t){const n=this._domLayerInfoMap.get(t);if(!n)return;const{unitId:r}=n;this._domLayerInfoMap.delete(t),n.dispose.dispose();const o=this._getSceneAndTransformerByDrawingSearch(r);o&&o.scene.removeObject(n.rect)}_initScrollAndZoomEvent(){const t=n=>{const r=this._getSceneAndTransformerByDrawingSearch(n);r&&this._domLayerInfoMap.forEach(o=>{if(o.unitId!==n)return;const a=Ze(o.rect,r.renderUnit);o.position$.next(a)})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_DOC).pipe(Z.map(n=>{if(!n)return null;const r=n.getUnitId(),o=this._renderManagerService.getRenderById(r);return o?{render:o,unitId:r}:null}),Z.switchMap(n=>n?i.fromEventSubject(n.render.scene.getViewport(W.VIEWPORT_KEY.VIEW_MAIN).onScrollAfter$).pipe(Z.map(()=>({unitId:n.unitId}))):Z.of(null))).subscribe(n=>{if(!n)return;const{unitId:r}=n;t(r)})),this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id===W.SetDocZoomRatioOperation.id){const r=n.params,{unitId:o}=r;t(o)}}))}insertFloatDom(t,n){var I,m,T;const r=this._univerInstanceService.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_DOC);if(!r)return!1;const o=this._getSceneAndTransformerByDrawingSearch(r.getUnitId());if(!o)return!1;const l=(I=o.renderUnit.with(k.DocSkeletonManagerService).getSkeleton().getSkeletonData())==null?void 0:I.pages[0];if(!l)return!1;const{pageWidth:c,marginLeft:g,marginRight:h}=l,u=c-g-h,f={size:{width:(m=n.width)!=null?m:u,height:n.height},positionH:{relativeFrom:i.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:i.ObjectRelativeFromV.PAGE,posOffset:0},angle:0},p=(T=n.drawingId)!=null?T:i.generateRandomId(),v={unitId:r.getUnitId(),drawings:[{drawingId:p,drawingType:i.DrawingTypeEnum.DRAWING_DOM,subUnitId:r.getUnitId(),unitId:r.getUnitId(),...t,title:"",description:"",docTransform:f,layoutType:i.PositionedObjectLayoutType.INLINE,transform:W.docDrawingPositionToTransform(f)}]};return this._commandService.syncExecuteCommand(Ne.id,v),p}},E.DocFloatDomController=Ot([Te(0,L.IRenderManagerService),Te(1,X.IDrawingManagerService),Te(2,i.Inject(he.DrawingRenderService)),Te(3,i.Inject(B.CanvasFloatDomService)),Te(4,i.IUniverInstanceService),Te(5,i.ICommandService)],E.DocFloatDomController);const Mt="docs-drawing-ui.config",ht={},pt=-1e3,ft=1e3,bt=s=>{const e=B.useDependency(i.ICommandService),t=B.useDependency(i.LocaleService),n=B.useDependency(X.IDrawingManagerService),r=B.useDependency(L.IRenderManagerService),o=B.useDependency(i.IUniverInstanceService),{drawings:a}=s,d=a[0];if(d==null)return;const{unitId:l}=d,c=o.getUniverDocInstance(l),g=c==null?void 0:c.getSnapshot().documentStyle.documentFlavor,h=r.getRenderById(l),u=h==null?void 0:h.scene;if(u==null)return;const f=u.getTransformerByCreate(),p=[{label:t.t("image-position.column"),value:String(i.ObjectRelativeFromH.COLUMN)},{label:t.t("image-position.page"),value:String(i.ObjectRelativeFromH.PAGE)},{label:t.t("image-position.margin"),value:String(i.ObjectRelativeFromH.MARGIN)}],v=[{label:t.t("image-position.line"),value:String(i.ObjectRelativeFromV.LINE),disabled:g===i.DocumentFlavor.MODERN},{label:t.t("image-position.page"),value:String(i.ObjectRelativeFromV.PAGE),disabled:g===i.DocumentFlavor.MODERN},{label:t.t("image-position.margin"),value:String(i.ObjectRelativeFromV.MARGIN),disabled:g===i.DocumentFlavor.MODERN},{label:t.t("image-position.paragraph"),value:String(i.ObjectRelativeFromV.PARAGRAPH)}],[I,m]=Y.useState(!0),[T,y]=Y.useState({relativeFrom:i.ObjectRelativeFromH.PAGE,posOffset:0}),[O,P]=Y.useState({relativeFrom:i.ObjectRelativeFromV.PAGE,posOffset:0}),[b,N]=Y.useState(!0),[H,R]=Y.useState(!0);function w(D,A){var C;D==="positionH"?y(A):P(A);const M=n.getFocusDrawings();if(M.length===0)return;const j=M.map(x=>({unitId:x.unitId,subUnitId:x.subUnitId,drawingId:x.drawingId}));e.executeCommand(Oe.id,{unitId:M[0].unitId,subUnitId:M[0].unitId,drawings:j.map(x=>({drawingId:x.drawingId,key:D,value:A}))});const G=(C=r.getRenderById(l))==null?void 0:C.with(W.DocSelectionRenderService);G&&G.blur(),f.refreshControls()}function U(D){var te,ge,ue;const A=T.relativeFrom,M=T.posOffset,j=Number(D);if(A===j)return;const G=n.getFocusDrawings();if(G.length===0)return;const C=G[0].drawingId,x=G[0].unitId;let K=null,V=0;const J=(te=r.getRenderById(x))==null?void 0:te.with(k.DocSkeletonManagerService).getSkeleton(),re=J==null?void 0:J.getSkeletonData();if(re==null)return;const{pages:ye,skeHeaders:Ie,skeFooters:Pe}=re;for(const oe of ye){const{marginLeft:pe,skeDrawings:fe,headerId:we,footerId:Se,pageWidth:me}=oe;if(fe.has(C)){K=fe.get(C),V=pe;break}const ae=(ge=Ie.get(we))==null?void 0:ge.get(me);if(ae!=null&&ae.skeDrawings.has(C)){K=ae==null?void 0:ae.skeDrawings.get(C),V=pe;break}const ce=(ue=Pe.get(Se))==null?void 0:ue.get(me);if(ce!=null&&ce.skeDrawings.has(C)){K=ce==null?void 0:ce.skeDrawings.get(C),V=pe;break}}if(K==null)return;let se=0;A===i.ObjectRelativeFromH.COLUMN?se-=K.columnLeft:A===i.ObjectRelativeFromH.MARGIN&&(se-=V),j===i.ObjectRelativeFromH.COLUMN?se+=K.columnLeft:j===i.ObjectRelativeFromH.MARGIN?se+=V:i.ObjectRelativeFromH.PAGE;const ee={relativeFrom:j,posOffset:(M!=null?M:0)-se};w("positionH",ee)}function z(D){var fe,we,Se,me,ae,ce;const A=O.relativeFrom,M=O.posOffset,j=Number(D);if(A===j)return;const G=n.getFocusDrawings();if(G.length===0)return;const{drawingId:C,unitId:x}=G[0],K=o.getUniverDocInstance(x),V=(fe=r.getRenderById(x))==null?void 0:fe.with(k.DocSkeletonManagerService).getSkeleton(),J=(we=r.getRenderById(x))==null?void 0:we.with(W.DocSelectionRenderService),re=J==null?void 0:J.getSegment(),ye=J==null?void 0:J.getSegmentPage(),Ie=(me=(Se=K==null?void 0:K.getSelfOrHeaderFooterModel(re).getBody())==null?void 0:Se.customBlocks)==null?void 0:me.find(_e=>_e.blockId===C);if(Ie==null||V==null||J==null)return;const{startIndex:Pe}=Ie,se=V.findNodeByCharIndex(Pe,re,ye),ee=(ae=se==null?void 0:se.parent)==null?void 0:ae.parent,te=ee==null?void 0:ee.parent,ge=te==null?void 0:te.lines.find(_e=>_e.paragraphIndex===(ee==null?void 0:ee.paragraphIndex)&&_e.paragraphStart),ue=(ce=te==null?void 0:te.parent)==null?void 0:ce.parent;if(se==null||ee==null||ge==null||te==null||ue==null)return;let oe=0;A===i.ObjectRelativeFromV.PARAGRAPH?oe-=ge.top:A===i.ObjectRelativeFromV.LINE?oe-=ee.top:A===i.ObjectRelativeFromV.PAGE&&(oe+=ue.marginTop),j===i.ObjectRelativeFromV.PARAGRAPH?oe+=ge.top:j===i.ObjectRelativeFromV.LINE?oe+=ee.top:j===i.ObjectRelativeFromV.PAGE&&(oe-=ue.marginTop);const pe={relativeFrom:j,posOffset:(M!=null?M:0)-oe};w("positionV",pe)}function F(D){var x;const A=c==null?void 0:c.getSnapshot(),M=(x=A==null?void 0:A.drawings)==null?void 0:x[D.drawingId];if(M==null)return;const{layoutType:j}=M,{positionH:G,positionV:C}=M.docTransform;y(G),P(C),m(j===i.PositionedObjectLayoutType.INLINE),N(C.relativeFrom===i.ObjectRelativeFromV.PARAGRAPH||C.relativeFrom===i.ObjectRelativeFromV.LINE)}function q(){const D=n.getFocusDrawings();D.length!==0&&F(D[0])}function _(D){N(D),z(String(D?i.ObjectRelativeFromV.PARAGRAPH:i.ObjectRelativeFromV.PAGE))}return Y.useEffect(()=>{q();const D=n.focus$.subscribe(M=>{if(M.length===0){R(!1);return}R(!0),F(M[0])}),A=e.onCommandExecuted(async M=>{M.id===k.RichTextEditingMutation.id&&q()});return()=>{D.unsubscribe(),A.dispose()}},[]),S.jsxs("div",{className:$.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!H}),children:[S.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-position.title")})}),S.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-position.horizontal")})}),S.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-position.absolutePosition")}),S.jsx($.InputNumber,{min:pt,max:ft,precision:1,disabled:I,value:T.posOffset,onChange:D=>{w("positionH",{relativeFrom:T.relativeFrom,posOffset:D})}})]}),S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-position.toTheRightOf")}),S.jsx($.Select,{value:String(T.relativeFrom),disabled:I,options:p,onChange:U})]})]}),S.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-position.vertical")})}),S.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-position.absolutePosition")}),S.jsx($.InputNumber,{min:pt,max:ft,precision:1,disabled:I,value:O.posOffset,onChange:D=>{w("positionV",{relativeFrom:O.relativeFrom,posOffset:D})}})]}),S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-position.bellow")}),S.jsx($.Select,{disabled:I,value:String(O.relativeFrom),options:v,onChange:z})]})]}),S.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-position.options")})}),S.jsx("div",{children:S.jsx($.Checkbox,{disabled:I,checked:b,onChange:_,children:t.t("image-position.moveObjectWithText")})})]})},Le=0,Ue=100,Ct=s=>{const e=B.useDependency(i.ICommandService),t=B.useDependency(i.LocaleService),n=B.useDependency(X.IDrawingManagerService),r=B.useDependency(L.IRenderManagerService),o=B.useDependency(i.IUniverInstanceService),{drawings:a}=s,d=a[0];if(d==null)return null;const{unitId:l}=d,c=o.getUniverDocInstance(l),g=r.getRenderById(l);if((g==null?void 0:g.scene)==null)return null;const[u,f]=Y.useState(!0),[p,v]=Y.useState(!0),[I,m]=Y.useState(!0),[T,y]=Y.useState(ie.INLINE),[O,P]=Y.useState(""),[b,N]=Y.useState({distT:0,distL:0,distB:0,distR:0}),[H,R]=Y.useState(!0);function w(_){y(_);const D=n.getFocusDrawings();if(D.length===0)return;const{unitId:A,subUnitId:M}=D[0],j=D.map(({unitId:G,subUnitId:C,drawingId:x})=>({unitId:G,subUnitId:C,drawingId:x}));e.executeCommand(st.id,{unitId:A,subUnitId:M,drawings:j,wrappingStyle:_})}function U(_){P(_);const D=n.getFocusDrawings();if(D.length===0)return;const A=D.map(M=>({unitId:M.unitId,subUnitId:M.subUnitId,drawingId:M.drawingId}));e.executeCommand(at.id,{unitId:D[0].unitId,subUnitId:D[0].unitId,drawings:A,wrapText:_})}function z(_,D){if(_==null)return;const A={...b,[D]:_};N(A);const M=n.getFocusDrawings();if(M.length===0)return;const j=M.map(G=>({unitId:G.unitId,subUnitId:G.subUnitId,drawingId:G.drawingId}));e.executeCommand(ot.id,{unitId:M[0].unitId,subUnitId:M[0].unitId,drawings:j,dist:{[D]:_}})}function F(){const _=n.getFocusDrawings();_.length!==0&&q(_[0])}function q(_){var J,re;const D=(re=(J=c==null?void 0:c.getSnapshot())==null?void 0:J.drawings)==null?void 0:re[_.drawingId];if(D==null)return;const{distT:A=0,distL:M=0,distB:j=0,distR:G=0,layoutType:C=i.PositionedObjectLayoutType.INLINE,behindDoc:x=i.BooleanNumber.FALSE,wrapText:K=i.WrapTextType.BOTH_SIDES}=D;if(N({distT:A,distL:M,distB:j,distR:G}),P(K),f(C!==i.PositionedObjectLayoutType.WRAP_SQUARE),C===i.PositionedObjectLayoutType.WRAP_NONE||C===i.PositionedObjectLayoutType.INLINE?v(!0):v(!1),C===i.PositionedObjectLayoutType.WRAP_NONE||C===i.PositionedObjectLayoutType.INLINE||C===i.PositionedObjectLayoutType.WRAP_TOP_AND_BOTTOM?m(!0):m(!1),C===i.PositionedObjectLayoutType.WRAP_NONE)x===i.BooleanNumber.TRUE?y(ie.BEHIND_TEXT):y(ie.IN_FRONT_OF_TEXT);else switch(C){case i.PositionedObjectLayoutType.INLINE:y(ie.INLINE);break;case i.PositionedObjectLayoutType.WRAP_SQUARE:y(ie.WRAP_SQUARE);break;case i.PositionedObjectLayoutType.WRAP_TOP_AND_BOTTOM:y(ie.WRAP_TOP_AND_BOTTOM);break;default:throw new Error(`Unsupported layout type: ${C}`)}}return Y.useEffect(()=>{F();const _=n.focus$.subscribe(A=>{if(A.length===0){R(!1);return}R(!0),q(A[0])}),D=e.onCommandExecuted(async A=>{A.id===k.RichTextEditingMutation.id&&F()});return()=>{_.unsubscribe(),D.dispose()}},[]),S.jsxs("div",{className:$.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!H}),children:[S.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-text-wrap.title")})}),S.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-text-wrap.wrappingStyle")})}),S.jsx("div",{children:S.jsxs($.RadioGroup,{value:T,onChange:w,direction:"vertical",children:[S.jsx($.Radio,{value:ie.INLINE,children:t.t("image-text-wrap.inline")}),S.jsx($.Radio,{value:ie.WRAP_SQUARE,children:t.t("image-text-wrap.square")}),S.jsx($.Radio,{value:ie.WRAP_TOP_AND_BOTTOM,children:t.t("image-text-wrap.topAndBottom")}),S.jsx($.Radio,{value:ie.BEHIND_TEXT,children:t.t("image-text-wrap.behindText")}),S.jsx($.Radio,{value:ie.IN_FRONT_OF_TEXT,children:t.t("image-text-wrap.inFrontText")})]})}),S.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-text-wrap.wrapText")})}),S.jsx("div",{children:S.jsxs($.RadioGroup,{disabled:u,value:O,onChange:U,direction:"horizontal",children:[S.jsx($.Radio,{value:i.WrapTextType.BOTH_SIDES,children:t.t("image-text-wrap.bothSide")}),S.jsx($.Radio,{value:i.WrapTextType.LEFT,children:t.t("image-text-wrap.leftOnly")}),S.jsx($.Radio,{value:i.WrapTextType.RIGHT,children:t.t("image-text-wrap.rightOnly")})]})}),S.jsx("div",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:S.jsx("div",{children:t.t("image-text-wrap.distanceFromText")})}),S.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-text-wrap.top")}),S.jsx($.InputNumber,{min:Le,max:Ue,disabled:p,precision:1,value:b.distT,onChange:_=>{z(_,"distT")}})]}),S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-text-wrap.left")}),S.jsx($.InputNumber,{min:Le,max:Ue,disabled:I,precision:1,value:b.distL,onChange:_=>{z(_,"distL")}})]})]}),S.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-text-wrap.bottom")}),S.jsx($.InputNumber,{min:Le,max:Ue,disabled:p,precision:1,value:b.distB,onChange:_=>{z(_,"distB")}})]}),S.jsxs("div",{children:[S.jsx("span",{children:t.t("image-text-wrap.right")}),S.jsx($.InputNumber,{min:Le,max:Ue,disabled:I,precision:1,value:b.distR,onChange:_=>{z(_,"distR")}})]})]})]})},Et=()=>{const s=B.useDependency(X.IDrawingManagerService),e=s.getFocusDrawings(),[t,n]=Y.useState(e);return Y.useEffect(()=>{const r=s.focus$.subscribe(o=>{n(o)});return()=>{r.unsubscribe()}},[]),!!(t!=null&&t.length)&&S.jsxs("div",{className:"univer-text-sm",children:[S.jsx(he.DrawingCommonPanel,{drawings:t,hasAlign:!1,hasCropper:!1,hasGroup:!1,hasTransform:!1}),S.jsx(Ct,{drawings:t}),S.jsx(bt,{drawings:t})]})},Qe="doc.menu.image",mt=Ke.id,Pt=s=>{const e=s.get(k.DocSelectionManagerService),t=s.get(i.IUniverInstanceService);return new Z.Observable(n=>{const r=e.textSelection$.subscribe(()=>{var a;const o=e.getActiveTextRange();if(o){const{segmentId:d,startOffset:l,endOffset:c}=o,g=t.getCurrentUniverDocInstance(),h=(a=g==null?void 0:g.getSelfOrHeaderFooterModel(d).getBody())==null?void 0:a.tables;if(h&&h.length&&h.some(u=>{const{startIndex:f,endIndex:p}=u;return l>=f&&l<p||c>=f&&c<p})){n.next(!0);return}}else{n.next(!0);return}n.next(!1)});return()=>r.unsubscribe()})};function At(s){return{id:Qe,type:B.MenuItemType.SUBITEMS,icon:"AddImageIcon",tooltip:"docImage.title",disabled$:Pt(s),hidden$:B.getMenuHiddenObservable(s,i.UniverInstanceType.UNIVER_DOC,void 0,i.DOCS_ZEN_EDITOR_UNIT_ID_KEY)}}function Rt(s){return{id:mt,title:"docImage.upload.float",type:B.MenuItemType.BUTTON,hidden$:B.getMenuHiddenObservable(s,i.UniverInstanceType.UNIVER_DOC,void 0,i.DOCS_ZEN_EDITOR_UNIT_ID_KEY)}}const Nt={[B.RibbonInsertGroup.MEDIA]:{[Qe]:{order:0,menuItemFactory:At,[mt]:{order:0,menuItemFactory:Rt}}}};function Me(s){return s.getContextValue(i.FOCUSING_UNIVER_EDITOR)&&s.getContextValue(i.FOCUSING_COMMON_DRAWINGS)}const xt={id:De.id,description:"shortcut.drawing-move-down",group:"4_drawing-view",binding:B.KeyCode.ARROW_DOWN,priority:100,preconditions:Me,staticParameters:{direction:i.Direction.DOWN}},Ft={id:De.id,description:"shortcut.drawing-move-up",group:"4_drawing-view",binding:B.KeyCode.ARROW_UP,priority:100,preconditions:Me,staticParameters:{direction:i.Direction.UP}},Lt={id:De.id,description:"shortcut.drawing-move-left",group:"4_drawing-view",binding:B.KeyCode.ARROW_LEFT,priority:100,preconditions:Me,staticParameters:{direction:i.Direction.LEFT}},Ut={id:De.id,description:"shortcut.drawing-move-right",group:"4_drawing-view",binding:B.KeyCode.ARROW_RIGHT,priority:100,preconditions:Me,staticParameters:{direction:i.Direction.RIGHT}},Bt={id:Xe.id,description:"shortcut.drawing-delete",group:"4_drawing-view",preconditions:Me,binding:B.KeyCode.DELETE,mac:B.KeyCode.BACKSPACE};var jt=Object.getOwnPropertyDescriptor,kt=(s,e,t,n)=>{for(var r=n>1?void 0:n?jt(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},Be=(s,e)=>(t,n)=>e(t,n,s);let je=class extends i.Disposable{constructor(s,e,t,n){super(),this._componentManager=s,this._menuManagerService=e,this._commandService=t,this._shortcutService=n,this._init()}_initCustomComponents(){const s=this._componentManager;this.disposeWithMe(s.register(gt,Et))}_initMenus(){this._menuManagerService.mergeMenu(Nt)}_initCommands(){[Ke,Ne,st,ot,at,Oe,ct,dt,Re,Ye,lt,Je,$e,qe,De,Xe,ze].forEach(s=>this.disposeWithMe(this._commandService.registerCommand(s)))}_initShortcuts(){[xt,Ft,Lt,Ut,Bt].forEach(s=>{this.disposeWithMe(this._shortcutService.registerShortcut(s))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};je=kt([Be(0,i.Inject(B.ComponentManager)),Be(1,B.IMenuManagerService),Be(2,i.ICommandService),Be(3,B.IShortcutService)],je);var Wt=Object.getOwnPropertyDescriptor,Ht=(s,e,t,n)=>{for(var r=n>1?void 0:n?Wt(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},be=(s,e)=>(t,n)=>e(t,n,s);function Gt(s){var n,r,o,a;if(i.JSONX.isNoop(s)||!Array.isArray(s))return null;const e=s.find(d=>Array.isArray(d)&&(d==null?void 0:d[0])==="drawings");if(e==null||!Array.isArray(e)||e.length<3||typeof e[1]=="string"&&typeof e[2]!="object"||Array.isArray(e[1])&&typeof e[1][1]!="object")return null;const t=[];if(Array.isArray(e==null?void 0:e[1]))for(const d of e)Array.isArray(d)&&t.push({type:(n=d==null?void 0:d[1])!=null&&n.i?"add":"remove",drawingId:d==null?void 0:d[0],drawing:(r=d==null?void 0:d[1])==null?void 0:r.i});else t.push({type:(o=e[2])!=null&&o.i?"add":"remove",drawingId:e[1],drawing:(a=e[2])==null?void 0:a.i});return t}function Vt(s){if(!Array.isArray(s)||s.length<3||s[0]!=="drawingsOrder")return[];const e=[];for(let t=1;t<s.length;t++){const n=s[t];if(Array.isArray(n)&&typeof n[0]=="number"&&typeof n[1]=="object")e.push(n[0]);else{e.length=0;break}}return e}let ke=class extends i.Disposable{constructor(s,e,t,n,r){super(),this._univerInstanceService=s,this._commandService=e,this._drawingManagerService=t,this._docDrawingService=n,this._renderManagerService=r,this._initialize()}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(s=>{if(s.id!==k.RichTextEditingMutation.id)return;const e=s.params,{unitId:t,actions:n}=e,r=Gt(n);if(r!=null)for(const{type:o,drawingId:a,drawing:d}of r)o==="add"?this._addDrawings(t,[d]):this._removeDrawings(t,[a])})),this.disposeWithMe(this._commandService.onCommandExecuted(s=>{if(s.id!==k.RichTextEditingMutation.id)return;const e=s.params,{unitId:t,actions:n}=e;Vt(n).length>0&&this._updateDrawingsOrder(t)})),this.disposeWithMe(this._commandService.onCommandExecuted(s=>{var a;if(s.id!==i.UndoCommand.id&&s.id!==i.RedoCommand.id)return;const e=(a=this._univerInstanceService.getCurrentUniverDocInstance())==null?void 0:a.getUnitId(),t=this._drawingManagerService.getFocusDrawings();if(e==null||t.length===0)return;const n=this._renderManagerService.getRenderById(e),r=n==null?void 0:n.scene;if(r==null)return!1;r.getTransformerByCreate().refreshControls()}))}_addDrawings(s,e){const t=this._drawingManagerService,n=this._docDrawingService,r=this._docDrawingService.getBatchAddOp(e),{subUnitId:o,redo:a,objects:d}=r;t.applyJson1(s,o,a),n.applyJson1(s,o,a),t.addNotification(d),n.addNotification(d)}_removeDrawings(s,e){const t=this._drawingManagerService,n=this._docDrawingService,r=this._docDrawingService.getBatchRemoveOp(e.map(l=>({unitId:s,subUnitId:s,drawingId:l}))),{subUnitId:o,redo:a,objects:d}=r;t.applyJson1(s,o,a),n.applyJson1(s,o,a),t.removeNotification(d),n.removeNotification(d)}_updateDrawingsOrder(s){const e=this._univerInstanceService.getUniverDocInstance(s);if(e==null)return;const t=e.getSnapshot().drawingsOrder;if(t==null)return;const n=this._drawingManagerService,r=this._docDrawingService;n.setDrawingOrder(s,s,t),r.setDrawingOrder(s,s,t);const o={unitId:s,subUnitId:s,drawingIds:t};n.orderNotification(o),r.orderNotification(o)}};ke=Ht([be(0,i.IUniverInstanceService),be(1,i.ICommandService),be(2,X.IDrawingManagerService),be(3,Q.IDocDrawingService),be(4,L.IRenderManagerService)],ke);const Xt=s=>{const{floatDomInfos:e,scene:t,offset:n,bound:r}=s,o=r.right-r.left,a=r.bottom-r.top,d=Y.useMemo(()=>e.map(l=>{const{width:c=0,height:g=0,left:h=0,top:u=0}=l.transform,p=ut({left:h,right:h+c,top:u,bottom:u+g},t),v={position$:new Z.BehaviorSubject(p),position:p,id:l.drawingId,componentKey:l.componentKey,onPointerMove:()=>{},onPointerDown:()=>{},onPointerUp:()=>{},onWheel:()=>{},unitId:l.unitId,data:l.data};return[l.drawingId,v]}).filter(([l,c])=>!(c.position.endX<0||c.position.endY<0||c.position.startX>o||c.position.startY>a)),[e,t,n,o,a]);return S.jsx("div",{className:"univer-absolute univer-left-0 univer-top-0",children:d.map(([l,c])=>S.jsx(B.PrintFloatDomSingle,{layer:c,id:l,position:c.position},l))})};var $t=Object.getOwnPropertyDescriptor,zt=(s,e,t,n)=>{for(var r=n>1?void 0:n?$t(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},Ce=(s,e)=>(t,n)=>e(t,n,s);let We=class extends i.Disposable{constructor(s,e,t,n,r){super(),this._docPrintInterceptorService=s,this._drawingRenderService=e,this._drawingManagerService=t,this._componetManager=n,this._injector=r,this._initPrinting(),this._initPrintingDom()}_initPrinting(){this.disposeWithMe(this._docPrintInterceptorService.interceptor.intercept(this._docPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(s,e,t)=>{const{unitId:n,scene:r}=e,o=this._drawingManagerService.getDrawingDataForUnit(n),a=o==null?void 0:o[n];return a&&a.order.forEach(d=>{const l=a.data[d];l.drawingType!==i.DrawingTypeEnum.DRAWING_CHART&&l.drawingType!==i.DrawingTypeEnum.DRAWING_DOM&&this._drawingRenderService.renderDrawing(l,r)}),t()}}))}_initPrintingDom(){this.disposeWithMe(this._docPrintInterceptorService.interceptor.intercept(this._docPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_DOM_COLLECT,{handler:(s,e,t)=>{const{unitId:n}=e,r=this._drawingManagerService.getDrawingDataForUnit(n),o=r==null?void 0:r[n];if(o){const a=o.order.map(l=>{const c=o.data[l];if(c.drawingType===i.DrawingTypeEnum.DRAWING_CHART)return{...c,componentKey:this._componetManager.get(i.DOC_DRAWING_PRINTING_COMPONENT_KEY)};if(c.drawingType===i.DrawingTypeEnum.DRAWING_DOM){const g=this._docPrintInterceptorService.getPrintComponent(c.componentKey);return{...c,componentKey:this._componetManager.get(g||c.componentKey)}}return null}).filter(Boolean),d=B.connectInjector(Xt,this._injector);return $.render(S.jsx(d,{unitId:n,floatDomInfos:a,scene:e.scene,skeleton:e.skeleton,offset:e.offset,bound:e.bound}),e.root),s==null||s.add(()=>{$.unmount(e.root)}),t(s)}}}))}};We=zt([Ce(0,i.Inject(W.DocPrintInterceptorService)),Ce(1,i.Inject(he.DrawingRenderService)),Ce(2,X.IDrawingManagerService),Ce(3,i.Inject(B.ComponentManager)),Ce(4,i.Inject(i.Injector))],We);var qt=Object.getOwnPropertyDescriptor,Kt=(s,e,t,n)=>{for(var r=n>1?void 0:n?qt(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},He=(s,e)=>(t,n)=>e(t,n,s);const Yt="__InlineDrawingAnchor__";function vt(s){const{path:e}=s;return e.some(t=>t==="cells")}let Ge=class extends i.Disposable{constructor(e,t,n,r){super();le(this,"_liquid",new L.Liquid);le(this,"_listenerOnImageMap",new Set);le(this,"_transformerCache",new Map);le(this,"_anchorShape");this._commandService=e,this._univerInstanceService=t,this._drawingManagerService=n,this._renderManagerService=r,this._init()}_init(){this._listenDrawingFocus()}_listenDrawingFocus(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{if(e.length!==0)for(const t of e){const{unitId:n}=t;this._listenerOnImageMap.has(n)||(this._listenTransformerChange(n),this._listenerOnImageMap.add(n))}}))}_listenTransformerChange(e){var r;const t=(r=this._getSceneAndTransformerByDrawingSearch(e))==null?void 0:r.transformer;if(t==null)return;this.disposeWithMe(i.toDisposable(t.changeStart$.subscribe(o=>{var d;this._transformerCache.clear();const{objects:a}=o;for(const l of a.values()){const{oKey:c,width:g,height:h,left:u,top:f,angle:p}=l,v=this._drawingManagerService.getDrawingOKey(c);if(v==null)continue;const I=this._univerInstanceService.getUniverDocInstance(v.unitId),m=(d=I==null?void 0:I.getSnapshot().drawings)==null?void 0:d[v.drawingId];if((m==null?void 0:m.layoutType)===i.PositionedObjectLayoutType.INLINE)try{l.setOpacity(.2)}catch{}m!=null&&this._transformerCache.set(v.drawingId,{drawing:m,top:f,left:u,width:g,height:h,angle:p})}})));const n=i.throttle(this._updateMultipleDrawingDocTransform.bind(this),50);i.throttle(this._nonInlineDrawingTransform.bind(this),50),this.disposeWithMe(i.toDisposable(t.changing$.subscribe(o=>{const{objects:a,offsetX:d,offsetY:l}=o;if(a.size>1)n(a);else if(a.size===1){const c=this._transformerCache.values().next().value,g=a.values().next().value,{width:h,height:u,top:f,left:p,angle:v}=g;if(c&&h===c.width&&u===c.height&&f===c.top&&p===c.left&&v===c.angle)return;c&&(c.drawing.layoutType,i.PositionedObjectLayoutType.INLINE),c&&c.drawing.layoutType===i.PositionedObjectLayoutType.INLINE&&d!=null&&l!=null&&this._updateInlineDrawingAnchor(c.drawing,d,l)}}))),this.disposeWithMe(i.toDisposable(t.changeEnd$.subscribe(o=>{const{objects:a,offsetX:d,offsetY:l}=o;for(const c of a.values()){const g=this._drawingManagerService.getDrawingOKey(c.oKey);if(g==null)continue;const h=this._transformerCache.get(g==null?void 0:g.drawingId);if((h==null?void 0:h.drawing.layoutType)===i.PositionedObjectLayoutType.INLINE)try{c.setOpacity(1)}catch{}}if(this._anchorShape&&this._anchorShape.hide(),a.size>1)this._updateMultipleDrawingDocTransform(a);else if(a.size===1){const c=this._transformerCache.values().next().value,g=a.values().next().value,{width:h,height:u,top:f,left:p,angle:v}=g;if(c&&h===c.width&&u===c.height&&f===c.top&&p===c.left&&v===c.angle)return;c&&c.drawing.layoutType===i.PositionedObjectLayoutType.INLINE?h!==c.width||u!==c.height||v!==c.angle?this._updateDrawingSize(c,g):d!=null&&l!=null&&this._moveInlineDrawing(c.drawing,d,l):c&&this._nonInlineDrawingTransform(c.drawing,g)}this._transformerCache.clear()})))}_updateMultipleDrawingDocTransform(e){if(e.size<1)return;const t=[];let n,r;for(const o of e.values()){const{oKey:a,left:d,top:l,angle:c}=o;let{width:g,height:h}=o;const u=this._drawingManagerService.getDrawingOKey(a);if(u==null)continue;n==null&&(n=u.unitId),r==null&&(r=u.subUnitId);const f=this._transformerCache.get(u.drawingId);if(f==null)continue;const{drawing:p,top:v,left:I,width:m,height:T,angle:y}=f,{width:O,height:P}=this._getPageContentSize(p);if(g=Math.min(g,O),h=Math.min(h,P),(m!==g||T!==h)&&t.push({drawingId:u.drawingId,key:"size",value:{width:g,height:h}}),y!==c&&t.push({drawingId:u.drawingId,key:"angle",value:c}),v!==l||I!==d){const b=l-v,N=d-I;b!==0&&t.push({drawingId:u.drawingId,key:"positionV",value:{relativeFrom:p.docTransform.positionV.relativeFrom,posOffset:p.docTransform.positionV.posOffset+b}}),N!==0&&t.push({drawingId:u.drawingId,key:"positionH",value:{relativeFrom:p.docTransform.positionH.relativeFrom,posOffset:p.docTransform.positionH.posOffset+N}})}}t.length>0&&n&&r&&this._commandService.executeCommand(Oe.id,{unitId:n,subUnitId:r,drawings:t})}_updateDrawingAnchor(e){if(this._transformerCache.size!==1)return;const t=this._transformerCache.values().next().value,n=e.values().next().value;this._getDrawingAnchor(t.drawing,n)}_updateInlineDrawingAnchor(e,t,n){var o;if(this._transformerCache.size!==1)return;const{contentBoxPointGroup:r}=(o=this._getInlineDrawingAnchor(e,t,n))!=null?o:{};r!=null&&this._createOrUpdateInlineAnchor(e.unitId,r)}_getInlineDrawingAnchor(e,t,n){var F,q;const r=this._renderManagerService.getRenderById(e.unitId),o=r==null?void 0:r.with(k.DocSkeletonManagerService).getSkeleton();if(r==null)return;const{mainComponent:a,scene:d}=r,l=a,c=d.getViewports()[0],{pageLayoutType:g=L.PageLayoutType.VERTICAL,pageMarginLeft:h,pageMarginTop:u}=l.getOffsetConfig();let f=null,p=!1,v=-1,I="";const m=.5,T=this._getTransformCoordForDocumentOffset(l,c,t,n);if(T==null)return;const y=(F=this._renderManagerService.getRenderById(e.unitId))==null?void 0:F.with(W.DocSelectionRenderService);if(y==null)return;const O=o==null?void 0:o.findNodeByCoord(T,g,h,u,{strict:!1,segmentId:y.getSegment(),segmentPage:y.getSegmentPage()});if(O){const{node:_,ratioX:D,segmentPage:A,segmentId:M}=O;p=D<m,f=_,v=A,I=M}if(f==null)return;const P=o==null?void 0:o.findPositionByGlyph(f,v),b=this._getDocObject();if(P==null||o==null||b==null||vt(P))return;const N={...P,isBack:p},H=b.document.getOffsetConfig(),R=new W.NodePositionConvertToCursor(H,o),{cursorList:w,contentBoxPointGroup:U}=R.getRangePointData(N,N),{startOffset:z}=(q=W.getOneTextSelectionRange(w))!=null?q:{};if(z!=null)return{offset:z,contentBoxPointGroup:U,segmentId:I,segmentPage:v}}_getDrawingAnchor(e,t){var ge,ue,oe,pe,fe,we,Se,me,ae,ce,_e;const n=this._renderManagerService.getRenderById(e.unitId),r=n==null?void 0:n.with(k.DocSkeletonManagerService).getSkeleton(),o=r==null?void 0:r.getSkeletonData();if(o==null||n==null)return;const{pages:a,skeHeaders:d,skeFooters:l}=o,{mainComponent:c,scene:g}=n,h=c,u=g.getViewports()[0],{pageLayoutType:f=L.PageLayoutType.VERTICAL,pageMarginLeft:p,pageMarginTop:v,docsLeft:I,docsTop:m}=h.getOffsetConfig(),{left:T,top:y,angle:O}=t;let{width:P,height:b}=t;const{positionV:N,positionH:H}=e.docTransform,{width:R,height:w}=this._getPageContentSize(e);P=Math.min(P,R),b=Math.min(b,w);let U=null,z="",F=-1;const q=!1,_={...e.docTransform,size:{width:P,height:b},angle:O},{x:D,y:A}=g.getViewportScrollXY(u),M=this._getTransformCoordForDocumentOffset(h,u,T-D,y-A);if(M==null)return;const j=(ge=this._renderManagerService.getRenderById(e.unitId))==null?void 0:ge.with(W.DocSelectionRenderService);if(j==null)return;const G=r==null?void 0:r.findNodeByCoord(M,f,p,v,{strict:!1,segmentId:j.getSegment(),segmentPage:j.getSegmentPage()});if(G){const{node:de,segmentPage:nt,segmentId:it}=G;U=de,F=nt,z=it}if(U==null)return;const C=(ue=U.parent)==null?void 0:ue.parent,x=C==null?void 0:C.parent,K=(oe=x==null?void 0:x.lines.find(de=>de.paragraphIndex===(C==null?void 0:C.paragraphIndex)&&de.paragraphStart))!=null?oe:x==null?void 0:x.lines[0],V=(pe=x==null?void 0:x.parent)==null?void 0:pe.parent;if(C==null||x==null||K==null||V==null)return;this._liquid.reset();const J=V.type;for(const de of a){const{headerId:nt,footerId:it,pageHeight:an,pageWidth:wt,marginLeft:St,marginBottom:cn}=de,dn=a.indexOf(de);if(F>-1&&dn===F){switch(J){case L.DocumentSkeletonPageType.HEADER:{const Ae=(fe=d.get(nt))==null?void 0:fe.get(wt);if(Ae)this._liquid.translatePagePadding({marginTop:Ae.marginTop,marginLeft:St});else throw new Error("header skeleton not found");break}case L.DocumentSkeletonPageType.FOOTER:{const Ae=(we=l.get(it))==null?void 0:we.get(wt);if(Ae)this._liquid.translatePagePadding({marginTop:an-cn+Ae.marginTop,marginLeft:St});else throw new Error("footer skeleton not found");break}}break}if(this._liquid.translatePagePadding(de),de===V)break;this._liquid.restorePagePadding(de),this._liquid.translatePage(de,f,p,v)}switch(N.relativeFrom===i.ObjectRelativeFromV.LINE?U=C.divides[0].glyphGroup[0]:U=(ce=(ae=(me=(Se=K.divides)==null?void 0:Se[0])==null?void 0:me.glyphGroup)==null?void 0:ae[0])!=null?ce:U,_.positionH={relativeFrom:H.relativeFrom,posOffset:T-this._liquid.x-I},H.relativeFrom){case i.ObjectRelativeFromH.MARGIN:{_.positionH.posOffset=T-this._liquid.x-I-V.marginLeft;break}case i.ObjectRelativeFromH.COLUMN:{_.positionH.posOffset=T-this._liquid.x-I-x.left;break}}switch(_.positionV={relativeFrom:N.relativeFrom,posOffset:y-this._liquid.y-m},N.relativeFrom){case i.ObjectRelativeFromV.PAGE:{_.positionV.posOffset=y-this._liquid.y-m-V.marginTop;break}case i.ObjectRelativeFromV.LINE:{_.positionV.posOffset=y-this._liquid.y-m-C.top;break}case i.ObjectRelativeFromV.PARAGRAPH:{_.positionV.posOffset=y-this._liquid.y-m-K.top;break}}if(U==null)return;const re=r==null?void 0:r.findPositionByGlyph(U,F),ye=this._getDocObject();if(re==null||r==null||ye==null||vt(re))return;const Ie={...re,isBack:q},Pe=ye.document.getOffsetConfig(),se=new W.NodePositionConvertToCursor(Pe,r),{cursorList:ee}=se.getRangePointData(Ie,Ie),{startOffset:te}=(_e=W.getOneTextSelectionRange(ee))!=null?_e:{};if(te!=null)return{offset:te,docTransform:_,segmentId:z,segmentPage:F}}_updateDrawingSize(e,t){const n=[],{drawing:r,width:o,height:a,angle:d}=e,{unitId:l,subUnitId:c}=r;let{width:g,height:h,angle:u}=t;const{width:f,height:p}=this._getPageContentSize(r);g=Math.min(f,g),h=Math.min(p,h),(g!==o||h!==a)&&n.push({drawingId:r.drawingId,key:"size",value:{width:g,height:h}}),u!==d&&n.push({drawingId:r.drawingId,key:"angle",value:u}),n.length>0&&l&&c&&this._commandService.executeCommand(Oe.id,{unitId:l,subUnitId:c,drawings:n})}_moveInlineDrawing(e,t,n){const r=this._getInlineDrawingAnchor(e,t,n),{offset:o,segmentId:a,segmentPage:d}=r!=null?r:{};return this._commandService.executeCommand(ct.id,{unitId:e.unitId,subUnitId:e.unitId,drawing:e,offset:o,segmentId:a,segmentPage:d,needRefreshDrawings:o==null})}_limitDrawingInPage(e,t){const n=this._renderManagerService.getRenderById(e.unitId),{left:r,top:o,width:a,height:d,angle:l}=t,c=n==null?void 0:n.with(k.DocSkeletonManagerService).getSkeleton(),g=c==null?void 0:c.getSkeletonData(),{pages:h}=g!=null?g:{};if(g==null||n==null||h==null)return{left:r,top:o,width:a,height:d,angle:l};const{mainComponent:u}=n,f=u,{top:p,pageLayoutType:v,pageMarginLeft:I,pageMarginTop:m}=f;let T=o;this._liquid.reset();for(const y of h){const{marginBottom:O,pageHeight:P}=y,b=h.indexOf(y),N=h[b+1];if(N==null)continue;if(i.Tools.hasIntersectionBetweenTwoRanges(o,o+d,this._liquid.y+p+P-O,this._liquid.y+p+P+m+N.marginTop)){const R=o+d/2,w=this._liquid.y+p+P+m/2;R<w?T=Math.min(o,this._liquid.y+p+P-O-d):T=Math.max(o,this._liquid.y+p+P+m+N.marginTop)}this._liquid.translatePage(y,v,I,m)}return{left:r,top:T,width:a,height:d,angle:l}}_nonInlineDrawingTransform(e,t,n=!1){const r=e.isMultiTransform===i.BooleanNumber.TRUE?t:this._limitDrawingInPage(e,t);if(n&&r.top!==t.top)return;const o=this._getDrawingAnchor(e,r),{offset:a,docTransform:d,segmentId:l,segmentPage:c}=o!=null?o:{};return a==null||d==null?this._updateMultipleDrawingDocTransform(new Map([[e.drawingId,t]])):this._commandService.executeCommand(dt.id,{unitId:e.unitId,subUnitId:e.unitId,drawing:e,offset:a,docTransform:d,segmentId:l,segmentPage:c})}_getSceneAndTransformerByDrawingSearch(e){if(e==null)return;const t=this._renderManagerService.getRenderById(e),n=t==null?void 0:t.scene;if(n==null)return;const r=n.getTransformerByCreate();return{scene:n,transformer:r}}_getTransformCoordForDocumentOffset(e,t,n,r){const{documentTransform:o}=e.getOffsetConfig(),a=t.transformVector2SceneCoord(L.Vector2.FromArray([n,r]));if(a)return o.clone().invert().applyPoint(a)}_createOrUpdateInlineAnchor(e,t){const n=this._renderManagerService.getRenderById(e);if(n==null)return;const{mainComponent:r,scene:o}=n,a=r,{docsLeft:d,docsTop:l}=a.getOffsetConfig(),c=W.getAnchorBounding(t),{left:g,top:h,height:u}=c,f=g+d,p=h+l;if(this._anchorShape){this._anchorShape.transformByState({left:f,top:p,height:u}),this._anchorShape.show();return}const v=6,I=new L.Rect(Yt+i.generateRandomId(v),{left:f,top:p,height:u,strokeWidth:2,stroke:L.getColor(i.COLORS.darkGray,1),evented:!1});this._anchorShape=I,o.addObject(I,W.TEXT_RANGE_LAYER_INDEX)}_getDocObject(){return W.getDocObject(this._univerInstanceService,this._renderManagerService)}_getPageContentSize(e){const t=this._renderManagerService.getRenderById(e.unitId),n=t==null?void 0:t.with(k.DocSkeletonManagerService).getSkeleton(),r=500,o=500,a=n==null?void 0:n.getSkeletonData();if(a==null||t==null)return{width:r,height:o};const{pages:d}=a;let l=null;for(const c of d){const{skeDrawings:g}=c;if(g.has(e.drawingId)){l=c;break}}if(l){const{pageWidth:c,pageHeight:g,marginLeft:h,marginBottom:u,marginRight:f,marginTop:p}=l;return{width:Math.max(r,c-h-f),height:Math.max(o,g-p-u)}}else return{width:r,height:o}}};Ge=Kt([He(0,i.ICommandService),He(1,i.IUniverInstanceService),He(2,X.IDrawingManagerService),He(3,L.IRenderManagerService)],Ge);var Jt=Object.getOwnPropertyDescriptor,Zt=(s,e,t,n)=>{for(var r=n>1?void 0:n?Jt(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},Ee=(s,e)=>(t,n)=>e(t,n,s);let Ve=class extends i.RxDisposable{constructor(e,t,n,r,o){super();le(this,"_initImagePopupMenu",new Set);le(this,"_disposePopups",[]);this._drawingManagerService=e,this._canvasPopManagerService=t,this._renderManagerService=n,this._univerInstanceService=r,this._contextService=o,this._init()}_init(){this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_DOC).pipe(Z.takeUntil(this.dispose$)).subscribe(e=>this._create(e))),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_DOC).pipe(Z.takeUntil(this.dispose$)).subscribe(e=>this._dispose(e))),this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_DOC).forEach(e=>this._create(e))}_dispose(e){const t=e.getUnitId();this._disposePopups.length&&(this._disposePopups.forEach(n=>n.dispose()),this._disposePopups.length=0),this._renderManagerService.removeRender(t)}_create(e){if(!e)return;const t=e.getUnitId();this._renderManagerService.has(t)&&!this._initImagePopupMenu.has(t)&&(this._popupMenuListener(t),this._initImagePopupMenu.add(t))}_hasCropObject(e){const t=e.getAllObjects();for(const n of t)if(n instanceof he.ImageCropperObject)return!0;return!1}_popupMenuListener(e){var o;const t=(o=this._renderManagerService.getRenderById(e))==null?void 0:o.scene;if(!t)return;const n=t.getTransformerByCreate();if(!n)return;const r=this._disposePopups;this.disposeWithMe(n.createControl$.subscribe(()=>{if(this._hasCropObject(t))return;const a=n.getSelectedObjectMap();if(r.forEach(m=>m.dispose()),r.length=0,a.size>1)return;const d=a.values().next().value;if(!d)return;const l=d.oKey,c=this._drawingManagerService.getDrawingOKey(l);if(!c||c.drawingType===i.DrawingTypeEnum.DRAWING_DOM)return;const{unitId:g,subUnitId:h,drawingId:u,drawingType:f}=c,p=this._canvasPopManagerService.attachPopupToObject(d,{componentKey:he.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:this._getImageMenuItems(g,h,u,f)}},g);r.push(this.disposeWithMe(p)),!this._drawingManagerService.getFocusDrawings().find(m=>m.unitId===g&&m.subUnitId===h&&m.drawingId===u)&&this._drawingManagerService.focusDrawing([{unitId:g,subUnitId:h,drawingId:u}])})),this.disposeWithMe(n.clearControl$.subscribe(()=>{r.forEach(a=>a.dispose()),r.length=0,this._contextService.setContextValue(i.FOCUSING_COMMON_DRAWINGS,!1),this._drawingManagerService.focusDrawing(null)})),this.disposeWithMe(n.changing$.subscribe(()=>{r.forEach(a=>a.dispose()),r.length=0})),this.disposeWithMe(n.changeStart$.subscribe(()=>{r.forEach(a=>a.dispose()),r.length=0}))}_getImageMenuItems(e,t,n,r){return[{label:"image-popup.edit",index:0,commandId:Je.id,commandParams:{unitId:e,subUnitId:t,drawingId:n},disable:!0},{label:"image-popup.delete",index:1,commandId:Re.id,commandParams:{unitId:e,drawings:[{unitId:e,subUnitId:t,drawingId:n}]},disable:!1},{label:"image-popup.crop",index:2,commandId:he.OpenImageCropOperation.id,commandParams:{unitId:e,subUnitId:t,drawingId:n},disable:!0},{label:"image-popup.reset",index:3,commandId:he.ImageResetSizeOperation.id,commandParams:[{unitId:e,subUnitId:t,drawingId:n}],disable:!0}]}};Ve=Zt([Ee(0,X.IDrawingManagerService),Ee(1,i.Inject(W.DocCanvasPopManagerService)),Ee(2,L.IRenderManagerService),Ee(3,i.IUniverInstanceService),Ee(4,i.IContextService)],Ve);var Qt=Object.getOwnPropertyDescriptor,en=(s,e,t,n)=>{for(var r=n>1?void 0:n?Qt(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},ve=(s,e)=>(t,n)=>e(t,n,s);let et=class extends i.Disposable{constructor(e,t,n,r,o,a,d,l){super();le(this,"_liquid",new L.Liquid);this._context=e,this._docSkeletonManagerService=t,this._commandService=n,this._editorService=r,this._drawingManagerService=o,this._docRefreshDrawingsService=a,this._univerInstanceService=d,this._lifecycleService=l,this._initialize(),this._commandExecutedListener()}_initialize(){this._initialRenderRefresh(),this._drawingInitializeListener(),this._initResize()}_initialRenderRefresh(){this.disposeWithMe(this._docSkeletonManagerService.currentSkeleton$.subscribe(e=>{e!=null&&this._refreshDrawing(e)})),this.disposeWithMe(this._docRefreshDrawingsService.refreshDrawings$.subscribe(e=>{e!=null&&this._refreshDrawing(e)}))}_commandExecutedListener(){const e=[k.RichTextEditingMutation.id,W.SetDocZoomRatioOperation.id];this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(e.includes(t.id)){const n=t.params,{unitId:r}=n,{unitId:o,mainComponent:a}=this._context;if(r!==o)return;const d=this._docSkeletonManagerService.getSkeleton();if(d==null)return;if(this._editorService.isEditor(o)&&o!==i.DOCS_ZEN_EDITOR_UNIT_ID_KEY){a==null||a.makeDirty();return}this._refreshDrawing(d)}}))}_initResize(){this.disposeWithMe(i.fromEventSubject(this._context.engine.onTransformChange$).pipe(Z.filter(e=>e.type===L.TRANSFORM_CHANGE_OBSERVABLE_TYPE.resize),Z.debounceTime(16)).subscribe(()=>{var n;const e=this._docSkeletonManagerService.getSkeleton(),{scene:t}=this._context;(n=t.getTransformer())==null||n.refreshControls(),this._refreshDrawing(e)}))}_refreshDrawing(e){var T,y;const t=e==null?void 0:e.getSkeletonData(),{mainComponent:n,unitId:r}=this._context,o=n;if(!t)return;const{left:a,top:d,pageLayoutType:l,pageMarginLeft:c,pageMarginTop:g}=o,{pages:h,skeHeaders:u,skeFooters:f}=t,p={};this._liquid.reset();for(let O=0,P=h.length;O<P;O++){const b=h[O],{headerId:N,footerId:H,pageWidth:R}=b;if(N){const w=(T=u.get(N))==null?void 0:T.get(R);w&&this._calculateDrawingPosition(r,w,a,d,p,w.marginTop,b.marginLeft)}if(H){const w=(y=f.get(H))==null?void 0:y.get(R);w&&this._calculateDrawingPosition(r,w,a,d,p,b.pageHeight-b.marginBottom+w.marginTop,b.marginLeft)}this._calculateDrawingPosition(r,b,a,d,p,b.marginTop,b.marginLeft),this._liquid.translatePage(b,l,c,g)}const v=Object.values(p),I=v.filter(O=>!O.isMultiTransform),m=v.filter(O=>O.isMultiTransform);I.length>0&&this._drawingManagerService.refreshTransform(I),this._handleMultiDrawingsTransform(m)}_handleMultiDrawingsTransform(e){const{scene:t,unitId:n}=this._context,r=t.getTransformerByCreate();e.forEach(l=>{const c=this._drawingManagerService.getDrawingByParam(l);c!=null&&(c.transform=l.transform,c.transforms=l.transforms,c.isMultiTransform=l.isMultiTransform)});const a=[...r.getSelectedObjectMap().keys()],d=Object.values(this._drawingManagerService.getDrawingData(n,n)).filter(l=>l.isMultiTransform===i.BooleanNumber.TRUE);this._drawingManagerService.removeNotification(d),e.length>0&&this._drawingManagerService.addNotification(e);for(const l of a){const c=t.getObject(l);c&&r.setSelectedControl(c)}}_calculateDrawingPosition(e,t,n,r,o,a,d){const{skeDrawings:l}=t;this._liquid.translatePagePadding({marginTop:a,marginLeft:d}),l.forEach(c=>{const{aLeft:g,aTop:h,height:u,width:f,angle:p,drawingId:v,drawingOrigin:I}=c,m=I.layoutType===i.PositionedObjectLayoutType.WRAP_NONE&&I.behindDoc===i.BooleanNumber.TRUE,{isMultiTransform:T=i.BooleanNumber.FALSE}=I,y={left:g+n+this._liquid.x,top:h+r+this._liquid.y,width:f,height:u,angle:p};o[v]==null?o[v]={unitId:e,subUnitId:e,drawingId:v,behindText:m,transform:y,transforms:[y],isMultiTransform:T}:T===i.BooleanNumber.TRUE&&o[v].transforms.push(y)}),this._liquid.restorePagePadding({marginTop:a,marginLeft:d})}_drawingInitializeListener(){const e=()=>{const t=this._docSkeletonManagerService.getSkeleton();t!=null&&(this._refreshDrawing(t),this._drawingManagerService.initializeNotification(this._context.unitId))};this._lifecycleService.stage>=i.LifecycleStages.Rendered?this._docSkeletonManagerService.getSkeleton()?e():setTimeout(e,500):this.disposeWithMe(this._lifecycleService.lifecycle$.pipe(Z.filter(t=>t===i.LifecycleStages.Rendered)).subscribe(e))}};et=en([ve(1,i.Inject(k.DocSkeletonManagerService)),ve(2,i.ICommandService),ve(3,W.IEditorService),ve(4,X.IDrawingManagerService),ve(5,i.Inject(xe)),ve(6,i.IUniverInstanceService),ve(7,i.Inject(i.LifecycleService))],et);var tn=Object.defineProperty,nn=Object.getOwnPropertyDescriptor,rn=(s,e,t)=>e in s?tn(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,sn=(s,e,t,n)=>{for(var r=n>1?void 0:n?nn(e,t):e,o=s.length-1,a;o>=0;o--)(a=s[o])&&(r=a(r)||r);return r},tt=(s,e)=>(t,n)=>e(t,n,s),It=(s,e,t)=>rn(s,typeof e!="symbol"?e+"":e,t);const on="DOC_DRAWING_UI_PLUGIN";E.UniverDocsDrawingUIPlugin=class extends i.Plugin{constructor(e=ht,t,n,r){super(),this._config=e,this._injector=t,this._renderManagerSrv=n,this._configService=r;const{...o}=i.merge({},ht,this._config);this._configService.setConfig(Mt,o)}onStarting(){[[je],[Ve],[Ge],[ke],[xe],[E.DocFloatDomController],[We]].forEach(t=>this._injector.add(t))}onReady(){[[Fe],[et]].forEach(e=>this._renderManagerSrv.registerRenderModule(i.UniverInstanceType.UNIVER_DOC,e)),this._injector.get(ke),this._injector.get(je),this._injector.get(Ge),this._injector.get(We)}onRendered(){this._injector.get(Ve),this._injector.get(E.DocFloatDomController)}},It(E.UniverDocsDrawingUIPlugin,"type",i.UniverInstanceType.UNIVER_DOC),It(E.UniverDocsDrawingUIPlugin,"pluginName",on),E.UniverDocsDrawingUIPlugin=sn([i.DependentOn(he.UniverDrawingUIPlugin,X.UniverDrawingPlugin,Q.UniverDocsDrawingPlugin,B.UniverUIPlugin),tt(1,i.Inject(i.Injector)),tt(2,L.IRenderManagerService),tt(3,i.IConfigService)],E.UniverDocsDrawingUIPlugin),E.ClearDocDrawingTransformerOperation=lt,E.DOCS_IMAGE_MENU_ID=Qe,E.DeleteDocDrawingsCommand=Xe,E.EditDocDrawingOperation=Je,E.GroupDocDrawingCommand=$e,E.InsertDocDrawingCommand=Ne,E.InsertDocImageCommand=Ke,E.MoveDocDrawingsCommand=De,E.RemoveDocDrawingCommand=Re,E.SetDocDrawingArrangeCommand=ze,E.SidebarDocDrawingOperation=Ye,E.UngroupDocDrawingCommand=qe,Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})}));


// index
(function(i,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("@univerjs/core"),require("@univerjs/docs-drawing"),require("@univerjs/docs-drawing-ui"),require("@univerjs/drawing"),require("@univerjs/drawing-ui")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/docs-drawing","@univerjs/docs-drawing-ui","@univerjs/drawing","@univerjs/drawing-ui"],e):(i=typeof globalThis<"u"?globalThis:i||self,e(i.UniverPresetDocsDrawing={},i.UniverCore,i.UniverDocsDrawing,i.UniverDocsDrawingUi,i.UniverDrawing,i.UniverDrawingUi))})(this,(function(i,e,r,n,u,s){"use strict";function o(v={}){const{collaboration:d=!1}=v;return{plugins:[[u.UniverDrawingPlugin,{override:d?[[e.IImageIoService,null]]:[]}],s.UniverDrawingUIPlugin,r.UniverDocsDrawingPlugin,n.UniverDocsDrawingUIPlugin].filter(t=>!!t)}}i.UniverDocsDrawingPreset=o,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})}));
