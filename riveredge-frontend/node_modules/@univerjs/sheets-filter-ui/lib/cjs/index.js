"use strict";var st=Object.defineProperty;var nt=(r,e,t)=>e in r?st(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var _=(r,e,t)=>nt(r,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const u=require("@univerjs/core"),c=require("@univerjs/sheets-filter"),$=require("@univerjs/sheets-ui"),g=require("@univerjs/ui"),z=require("@univerjs/engine-render"),y=require("@univerjs/sheets"),S=require("rxjs"),Fe=require("@univerjs/rpc"),N=require("@univerjs/design"),O=require("react"),m=require("react/jsx-runtime");var w=(r=>(r[r.FIRST=0]="FIRST",r[r.SECOND=1]="SECOND",r))(w||{}),F=(r=>(r.NONE="none",r.STARTS_WITH="startsWith",r.DOES_NOT_START_WITH="doesNotStartWith",r.ENDS_WITH="endsWith",r.DOES_NOT_END_WITH="doesNotEndWith",r.CONTAINS="contains",r.DOES_NOT_CONTAIN="doesNotContain",r.EQUALS="equals",r.NOT_EQUALS="notEquals",r.EMPTY="empty",r.NOT_EMPTY="notEmpty",r.BETWEEN="between",r.NOT_BETWEEN="notBetween",r.CUSTOM="custom",r))(F||{}),f;(r=>{r.NONE={label:"sheets-filter.conditions.none",operator:F.NONE,order:w.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.NONE]: should not have initial form params!")},testMappingParams:i=>i.operator1===F.NONE,mapToFilterColumn:()=>null,testMappingFilterColumn:i=>!i.customFilters&&!i.filters?{}:!1},r.EMPTY={label:"sheets-filter.conditions.empty",operator:F.EMPTY,order:w.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.EMPTY]: should not have initial form params!")},testMappingParams:({operator1:i})=>i===F.EMPTY,mapToFilterColumn:()=>({customFilters:{customFilters:[{val:""}]}}),testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.val===""&&o.operator===void 0?{operator1:F.EMPTY}:!1}},r.NOT_EMPTY={label:"sheets-filter.conditions.not-empty",operator:F.NOT_EMPTY,order:w.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.NOT_EMPTY]: should not have initial form params!")},testMappingParams:({operator1:i})=>i===F.NOT_EMPTY,mapToFilterColumn:()=>({customFilters:{customFilters:[{val:"",operator:c.CustomFilterOperator.NOT_EQUALS}]}}),testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.val===" "&&o.operator===c.CustomFilterOperator.NOT_EQUALS?{operator1:F.NOT_EMPTY}:!1}},r.TEXT_CONTAINS={label:"sheets-filter.conditions.text-contains",operator:F.CONTAINS,order:w.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:F.CONTAINS,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===F.CONTAINS},mapToFilterColumn:i=>{const{val1:o}=i;return o===""?null:{customFilters:{customFilters:[{val:`*${o}*`}]}}},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0],l=o.val.toString();return!o.operator&&l.startsWith("*")&&l.endsWith("*")?{operator1:F.CONTAINS,val1:l.slice(1,-1)}:!1}},r.DOES_NOT_CONTAIN={label:"sheets-filter.conditions.does-not-contain",operator:F.DOES_NOT_CONTAIN,order:w.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:F.DOES_NOT_CONTAIN,val1:""}),mapToFilterColumn:i=>({customFilters:{customFilters:[{val:`*${i.val1}*`,operator:c.CustomFilterOperator.NOT_EQUALS}]}}),testMappingParams:i=>{const[o]=j(i);return o===F.DOES_NOT_CONTAIN},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0],l=o.val.toString();return o.operator===c.CustomFilterOperator.NOT_EQUALS&&l.startsWith("*")&&l.endsWith("*")?{operator1:F.DOES_NOT_CONTAIN,val1:l.slice(1,-1)}:!1}},r.STARTS_WITH={label:"sheets-filter.conditions.starts-with",operator:F.STARTS_WITH,order:w.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:F.STARTS_WITH,val1:""}),mapToFilterColumn:i=>({customFilters:{customFilters:[{val:`${i.val1}*`}]}}),testMappingParams:i=>{const[o]=j(i);return o===F.STARTS_WITH},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0],l=o.val.toString();return!o.operator&&l.endsWith("*")&&!l.startsWith("*")?{operator1:F.STARTS_WITH,val1:l.slice(0,-1)}:!1}},r.ENDS_WITH={label:"sheets-filter.conditions.ends-with",operator:F.ENDS_WITH,order:w.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:F.ENDS_WITH,val1:""}),mapToFilterColumn:i=>({customFilters:{customFilters:[{val:`*${i.val1}`}]}}),testMappingParams:i=>{const[o]=j(i);return o===F.ENDS_WITH},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0],l=o.val.toString();return!o.operator&&l.startsWith("*")&&!l.endsWith("*")?{operator1:F.ENDS_WITH,val1:l.slice(1)}:!1}},r.EQUALS={label:"sheets-filter.conditions.equals",operator:F.EQUALS,order:w.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:F.EQUALS,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===F.EQUALS},mapToFilterColumn:i=>{const{val1:o}=i;return o===""?null:{customFilters:{customFilters:[{val:o}]}}},testMappingFilterColumn:i=>{var o,l,h;return((l=(o=i.filters)==null?void 0:o.filters)==null?void 0:l.length)===1?{operator1:F.EQUALS,val1:""}:((h=i.customFilters)==null?void 0:h.customFilters.length)===1&&!i.customFilters.customFilters[0].operator?{operator1:F.EQUALS,val1:i.customFilters.customFilters[0].val.toString()}:!1}},r.GREATER_THAN={label:"sheets-filter.conditions.greater-than",operator:c.CustomFilterOperator.GREATER_THAN,numOfParameters:1,order:w.FIRST,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.GREATER_THAN,val1:""}),mapToFilterColumn:i=>({customFilters:{customFilters:[{val:i.val1,operator:c.CustomFilterOperator.GREATER_THAN}]}}),testMappingParams:i=>{const[o]=j(i);return o===c.CustomFilterOperator.GREATER_THAN},testMappingFilterColumn:i=>{var l;if(((l=i.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.operator!==c.CustomFilterOperator.GREATER_THAN?!1:{operator1:c.CustomFilterOperator.GREATER_THAN,val1:o.val.toString()}}},r.GREATER_THAN_OR_EQUAL={label:"sheets-filter.conditions.greater-than-or-equal",operator:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,numOfParameters:1,order:w.FIRST,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL},mapToFilterColumn:i=>({customFilters:{customFilters:[{val:i.val1,operator:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL}]}}),testMappingFilterColumn:i=>{var l;if(((l=i.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.operator!==c.CustomFilterOperator.GREATER_THAN_OR_EQUAL?!1:{operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:o.val.toString()}}},r.LESS_THAN={label:"sheets-filter.conditions.less-than",operator:c.CustomFilterOperator.LESS_THAN,numOfParameters:1,order:w.FIRST,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.LESS_THAN,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===c.CustomFilterOperator.LESS_THAN},mapToFilterColumn:i=>({customFilters:{customFilters:[{val:i.val1,operator:c.CustomFilterOperator.LESS_THAN}]}}),testMappingFilterColumn:i=>{var l;if(((l=i.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.operator!==c.CustomFilterOperator.LESS_THAN?!1:{operator1:c.CustomFilterOperator.LESS_THAN,val1:o.val.toString()}}},r.LESS_THAN_OR_EQUAL={label:"sheets-filter.conditions.less-than-or-equal",operator:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,numOfParameters:1,order:w.FIRST,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===c.CustomFilterOperator.LESS_THAN_OR_EQUAL},mapToFilterColumn:i=>({customFilters:{customFilters:[{val:i.val1,operator:c.CustomFilterOperator.LESS_THAN_OR_EQUAL}]}}),testMappingFilterColumn:i=>{var l;if(((l=i.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.operator!==c.CustomFilterOperator.LESS_THAN_OR_EQUAL?!1:{operator1:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val1:o.val.toString()}}},r.EQUAL={label:"sheets-filter.conditions.equal",operator:c.CustomFilterOperator.EQUAL,numOfParameters:1,order:w.FIRST,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.EQUAL,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===c.CustomFilterOperator.EQUAL},mapToFilterColumn:i=>({customFilters:{customFilters:[{val:i.val1,operator:c.CustomFilterOperator.EQUAL}]}}),testMappingFilterColumn:i=>{var l;if(((l=i.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.operator!==c.CustomFilterOperator.EQUAL?!1:{operator1:c.CustomFilterOperator.EQUAL,val1:o.val.toString()}}},r.NOT_EQUAL={label:"sheets-filter.conditions.not-equal",operator:c.CustomFilterOperator.NOT_EQUALS,numOfParameters:1,order:w.FIRST,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.NOT_EQUALS,val1:""}),testMappingParams:i=>{const[o]=j(i);return o===c.CustomFilterOperator.NOT_EQUALS},mapToFilterColumn:i=>({customFilters:{customFilters:[{val:i.val1,operator:c.CustomFilterOperator.NOT_EQUALS}]}}),testMappingFilterColumn:i=>{var l;if(((l=i.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const o=i.customFilters.customFilters[0];return o.operator!==c.CustomFilterOperator.NOT_EQUALS?!1:{operator1:c.CustomFilterOperator.NOT_EQUALS,val1:o.val.toString()}}},r.BETWEEN={label:"sheets-filter.conditions.between",operator:F.BETWEEN,order:w.SECOND,numOfParameters:2,getDefaultFormParams:()=>({and:!0,operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:"",operator2:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:""}),testMappingParams:i=>{const{and:o,operator1:l,operator2:h}=i;if(!o)return!1;const d=[l,h];return d.includes(c.CustomFilterOperator.GREATER_THAN_OR_EQUAL)&&d.includes(c.CustomFilterOperator.LESS_THAN_OR_EQUAL)},mapToFilterColumn:i=>{const{val1:o,val2:l,operator1:h}=i,d=h===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL;return{customFilters:{and:u.BooleanNumber.TRUE,customFilters:[{val:d?o:l,operator:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL},{val:d?l:o,operator:c.CustomFilterOperator.LESS_THAN_OR_EQUAL}]}}},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==2)return!1;const[o,l]=i.customFilters.customFilters;return o.operator===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&l.operator===c.CustomFilterOperator.LESS_THAN_OR_EQUAL&&i.customFilters.and?{and:!0,operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:o.val.toString(),operator2:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:l.val.toString()}:l.operator===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&o.operator===c.CustomFilterOperator.LESS_THAN_OR_EQUAL&&i.customFilters.and?{and:!0,operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:l.val.toString(),operator2:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:o.val.toLocaleString()}:!1}},r.NOT_BETWEEN={label:"sheets-filter.conditions.not-between",operator:F.NOT_BETWEEN,order:w.SECOND,numOfParameters:2,getDefaultFormParams:()=>({operator1:c.CustomFilterOperator.LESS_THAN,val1:"",operator2:c.CustomFilterOperator.GREATER_THAN,val2:""}),testMappingParams:i=>{const{and:o,operator1:l,operator2:h}=i;if(o)return!1;const d=[l,h];return d.includes(c.CustomFilterOperator.GREATER_THAN)&&d.includes(c.CustomFilterOperator.LESS_THAN)},mapToFilterColumn:i=>{const{val1:o,val2:l,operator1:h}=i,d=h===c.CustomFilterOperator.GREATER_THAN;return{customFilters:{customFilters:[{val:d?o:l,operator:c.CustomFilterOperator.GREATER_THAN},{val:d?l:o,operator:c.CustomFilterOperator.LESS_THAN}]}}},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==2)return!1;const[o,l]=i.customFilters.customFilters;return o.operator===c.CustomFilterOperator.LESS_THAN&&l.operator===c.CustomFilterOperator.GREATER_THAN&&!i.customFilters.and?{operator1:c.CustomFilterOperator.LESS_THAN,val1:o.val.toString(),operator2:c.CustomFilterOperator.GREATER_THAN,val2:l.val.toString()}:l.operator===c.CustomFilterOperator.LESS_THAN&&o.operator===c.CustomFilterOperator.GREATER_THAN&&!i.customFilters.and?{operator1:c.CustomFilterOperator.GREATER_THAN,val1:l.val.toString(),operator2:c.CustomFilterOperator.LESS_THAN,val2:o.val.toLocaleString()}:!1}},r.CUSTOM={label:"sheets-filter.conditions.custom",operator:F.CUSTOM,order:w.SECOND,numOfParameters:2,getDefaultFormParams:()=>({operator1:F.NONE,val1:"",operator2:F.NONE,val2:""}),testMappingParams:()=>!0,mapToFilterColumn:i=>{const{and:o,val1:l,val2:h,operator1:d,operator2:p}=i;function T(x,A){for(const L of r.ALL_CONDITIONS)if(L.operator===x)return L.mapToFilterColumn({val1:A,operator1:x})}const v=!d||d===r.NONE.operator,C=!p||p===r.NONE.operator;if(v&&C)return r.NONE.mapToFilterColumn({});if(v)return T(p,h);if(C)return T(d,l);const E=T(d,l),b=T(p,h),R={customFilters:[E.customFilters.customFilters[0],b.customFilters.customFilters[0]]};return o&&(R.and=u.BooleanNumber.TRUE),{customFilters:R}},testMappingFilterColumn:i=>{var h;if(((h=i.customFilters)==null?void 0:h.customFilters.length)!==2)return!1;const o=i.customFilters.customFilters.map(d=>a({customFilters:{customFilters:[d]}})),l={operator1:o[0][0].operator,val1:o[0][1].val1,operator2:o[1][0].operator,val2:o[1][1].val1};return i.customFilters.and&&(l.and=!0),l}},r.ALL_CONDITIONS=[r.NONE,r.EMPTY,r.NOT_EMPTY,r.TEXT_CONTAINS,r.DOES_NOT_CONTAIN,r.STARTS_WITH,r.ENDS_WITH,r.EQUALS,r.GREATER_THAN,r.GREATER_THAN_OR_EQUAL,r.LESS_THAN,r.LESS_THAN_OR_EQUAL,r.EQUAL,r.NOT_EQUAL,r.BETWEEN,r.NOT_BETWEEN,r.CUSTOM];function e(i){const o=r.ALL_CONDITIONS.find(l=>l.operator===i);if(!o)throw new Error(`[SheetsFilter]: no condition item found for operator: ${i}`);return o}r.getItemByOperator=e;function t(i,o){for(const l of r.ALL_CONDITIONS.filter(h=>h.numOfParameters===o))if(l.numOfParameters!==0&&l.testMappingParams(i))return l;for(const l of r.ALL_CONDITIONS)if(l.testMappingParams(i))return l;throw new Error("[SheetsFilter]: no condition item can be mapped from the filter map params!")}r.testMappingParams=t;function s(i){const o=r.ALL_CONDITIONS.find(l=>l.operator===i);return(o==null?void 0:o.numOfParameters)===0?{operator1:o.operator}:o.getDefaultFormParams()}r.getInitialFormParams=s;function n(i,o){return i.mapToFilterColumn(o)}r.mapToFilterColumn=n;function a(i){if(!i)return[r.NONE,{}];for(const o of r.ALL_CONDITIONS){const l=o.testMappingFilterColumn(i);if(l)return[o,l]}return[r.NONE,{}]}r.testMappingFilterColumn=a})(f||(f={}));function j(r){const{operator1:e,operator2:t,val1:s,val2:n}=r;if(e&&t)throw new Error("Both operator1 and operator2 are set!");if(!e&&!t)throw new Error("Neither operator1 and operator2 and both not set!");return e?[e,s]:[t,n]}function Re(r){const e=[],t=[];let s=0,n=0;function a(i){i.leaf&&(i.checked?(e.push(i),s+=i.count):(t.push(i),n+=i.count)),i.children&&i.children.forEach(a)}return r.forEach(a),{checkedItems:e,uncheckedItems:t,checked:s,unchecked:n}}var ot=Object.getOwnPropertyDescriptor,lt=(r,e,t,s)=>{for(var n=s>1?void 0:s?ot(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},Ne=(r,e)=>(t,s)=>e(t,s,r);const Le="sheets-filter.generate-filter-values.service",fe=u.createIdentifier(Le);let Pe=class extends u.Disposable{constructor(r,e,t){super(),this._localeService=r,this._univerInstanceService=e,this._logService=t}async getFilterValues(r){var p;const{unitId:e,subUnitId:t,filteredOutRowsByOtherColumns:s,filterColumn:n,filters:a,blankChecked:i,iterateRange:o,alreadyChecked:l}=r,h=this._univerInstanceService.getUnit(e),d=(p=this._univerInstanceService.getUnit(e))==null?void 0:p.getSheetBySheetId(t);return!h||!d?[]:(this._logService.debug("[SheetsGenerateFilterValuesService]","getFilterValues for",{unitId:e,subUnitId:t}),Qe(a,this._localeService,o,d,new Set(s),n,new Set(l.map(String)),i,h.getStyles()))}};Pe=lt([Ne(0,u.Inject(u.LocaleService)),Ne(1,u.IUniverInstanceService),Ne(2,u.ILogService)],Pe);function Qe(r,e,t,s,n,a,i,o,l){var b,R,x,A,L,M,V,Q,J,k;const h=new Map,d=new Map,p="yyyy-mm-dd",T="empty",v=!r&&((a==null?void 0:a.filterBy)===c.FilterBy.COLORS||(a==null?void 0:a.filterBy)===c.FilterBy.CONDITIONS)&&((b=a.filteredOutRows)==null?void 0:b.size);let C=0;for(const I of s.iterateByColumn(t,!1,!1)){const{row:Ee,rowSpan:me=1}=I;let ee=0;for(;ee<me;){const it=Ee+ee;if(n.has(it)){ee++;continue}const Z=I!=null&&I.value?u.extractPureTextFromCell(I.value):"";if(!Z){C+=1,ee+=me;continue}const de=(R=I.value)!=null&&R.v&&!I.value.p?(L=(A=l.get((x=I.value)==null?void 0:x.s))==null?void 0:A.n)==null?void 0:L.pattern:"",Me=de&&u.numfmt.getFormatInfo(de).isDate;let Ue=!1;if(Me){const{year:B,month:G,day:P}=u.numfmt.getFormatDateInfo(de);Ue=B||G||P}if(de&&Me&&Ue){const B=(M=s.getCellRaw(I.row,I.col))==null?void 0:M.v;if(!B){ee++;continue}const G=u.numfmt.format(p,Number(B)),[P,D,oe]=G.split("-").map(Number);let K=h.get(`${P}`);K||(K={title:`${P}`,key:`${P}`,children:[],count:0,leaf:!1,checked:!1},h.set(`${P}`,K),d.set(`${P}`,[`${P}`]));let W=(V=K.children)==null?void 0:V.find(Ie=>Ie.key===`${P}-${D}`);W||(W={title:e.t(`sheets-filter.date.${D}`),key:`${P}-${D}`,children:[],count:0,leaf:!1,checked:!1},(Q=K.children)==null||Q.push(W),d.set(`${P}-${D}`,[`${P}`,`${P}-${D}`]));const Oe=(J=W==null?void 0:W.children)==null?void 0:J.find(Ie=>Ie.key===`${P}-${D}-${oe}`);Oe?(Oe.originValues.add(Z),Oe.count++,W.count++,K.count++):((k=W.children)==null||k.push({title:`${oe}`,key:`${P}-${D}-${oe}`,count:1,originValues:new Set([Z]),leaf:!0,checked:v?!1:i.size?i.has(Z):!o}),W.count++,K.count++,d.set(`${P}-${D}-${oe}`,[`${P}`,`${P}-${D}`,`${P}-${D}-${oe}`]))}else{const B=Z;let G=h.get(B);G?G.count++:(G={title:Z,leaf:!0,checked:v?!1:i.size?i.has(Z):!o,key:B,count:1},h.set(B,G),d.set(B,[B]))}ee++}}const E=v?!1:r?o:!0;if(C>0){const I={title:e.t("sheets-filter.panel.empty"),count:C,leaf:!0,checked:E,key:T};h.set("empty",I),d.set("empty",[T])}return{filterTreeItems:at(Array.from(h.values())),filterTreeMapCache:d}}function at(r){return Array.from(r).sort((e,t)=>e.children&&!t.children?-1:!e.children&&t.children?1:ct(e.title,t.title)).map(e=>(e.children&&e.children.sort((t,s)=>{const n=Number.parseInt(t.key.split("-")[1],10),a=Number.parseInt(s.key.split("-")[1],10);return n-a}).forEach(t=>{t.children&&t.children.sort((s,n)=>{const a=Number.parseInt(s.key.split("-")[2],10),i=Number.parseInt(n.key.split("-")[2],10);return a-i})}),e))}const ke=r=>!Number.isNaN(Number(r))&&!Number.isNaN(Number.parseFloat(r));function ct(r,e){const t=ke(r),s=ke(e);return t&&s?Number.parseFloat(r)-Number.parseFloat(e):t&&!s?-1:!t&&s?1:r.localeCompare(e)}function Ae(r,e){for(const t of r){if(t.key===e)return t;if(t.children){const s=Ae(t.children,e);if(s)return s}}return null}function Ge(r){return r.leaf?r.checked:r.children?r.children.every(e=>Ge(e)):!0}function le(r,e){r.leaf&&(e!==void 0?r.checked=e:r.checked=!r.checked),r.children&&r.children.forEach(t=>le(t,e))}function Ye(r,e){const t=[];return r.forEach(s=>{const n=s.originValues?e.some(o=>Array.from(s.originValues).some(l=>l.toLowerCase().includes(o.toLowerCase()))):!1,a=!n&&e.some(o=>s.title.toLowerCase().includes(o.toLowerCase()));if(n||a)t.push({...s});else if(s.children){const o=Ye(s.children,e);if(o.length>0){const l=o.reduce((h,d)=>h+d.count,0);t.push({...s,count:l,children:o})}}}),t}var ut=Object.getOwnPropertyDescriptor,Te=(r,e,t,s)=>{for(var n=s>1?void 0:s?ut(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},ce=(r,e)=>(t,s)=>e(t,s,r);u.createIdentifier("sheets-filter-ui.sheets-filter-panel.service");let q=class extends u.Disposable{constructor(e,t){super();_(this,"_filterBy$",new S.BehaviorSubject(c.FilterBy.VALUES));_(this,"filterBy$",this._filterBy$.asObservable());_(this,"_filterByModel$",new S.ReplaySubject(1));_(this,"filterByModel$",this._filterByModel$.asObservable());_(this,"_filterByModel",null);_(this,"_hasCriteria$",new S.BehaviorSubject(!1));_(this,"hasCriteria$",this._hasCriteria$.asObservable());_(this,"_filterModel",null);_(this,"_col$",new S.BehaviorSubject(-1));_(this,"col$",this._col$.asObservable());_(this,"_filterHeaderListener",null);this._injector=e,this._refRangeService=t}get filterBy(){return this._filterBy$.getValue()}get filterByModel(){return this._filterByModel}set filterByModel(e){this._filterByModel=e,this._filterByModel$.next(e)}get filterModel(){return this._filterModel}get col(){return this._col$.getValue()}dispose(){this._filterBy$.complete(),this._filterByModel$.complete(),this._hasCriteria$.complete()}setupCol(e,t){this.terminate(),this._filterModel=e,this._col$.next(t);const s=e.getFilterColumn(t);if(s){const n=s.getColumnData();if(n.customFilters){this._hasCriteria$.next(!0),this._setupByConditions(e,t);return}if(n.colorFilters){this._hasCriteria$.next(!0),this._setupByColors(e,t);return}if(n.filters){this._hasCriteria$.next(!0),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t)}changeFilterBy(e){if(!this._filterModel||this.col===-1)return!1;switch(e){case c.FilterBy.VALUES:this._setupByValues(this._filterModel,this.col);break;case c.FilterBy.COLORS:this._setupByColors(this._filterModel,this.col);break;case c.FilterBy.CONDITIONS:this._setupByConditions(this._filterModel,this.col);break}return!0}terminate(){return this._filterModel=null,this._col$.next(-1),this._disposeFilterHeaderChangeListener(),!0}_disposeFilterHeaderChangeListener(){var e;(e=this._filterHeaderListener)==null||e.dispose(),this._filterHeaderListener=null}_listenToFilterHeaderChange(e,t){this._disposeFilterHeaderChangeListener();const s=e.unitId,n=e.subUnitId,a=e.getRange(),i={startColumn:t,startRow:a.startRow,endRow:a.startRow,endColumn:t};this._filterHeaderListener=this._refRangeService.watchRange(s,n,i,(o,l)=>{if(!l)this.terminate();else{const h=l.startColumn-o.startColumn;h!==0&&this._filterByModel.deltaCol(h)}})}async _setupByValues(e,t){this._disposePreviousModel();const s=e.getRange();if(s.startRow===s.endRow)return!1;const n=await _e.fromFilterColumn(this._injector,e,t);return this.filterByModel=n,this._filterBy$.next(c.FilterBy.VALUES),this._listenToFilterHeaderChange(e,t),!0}async _setupByColors(e,t){this._disposePreviousModel();const s=e.getRange();if(s.startRow===s.endRow)return!1;const n=await ge.fromFilterColumn(this._injector,e,t);return this.filterByModel=n,this._filterBy$.next(c.FilterBy.COLORS),this._listenToFilterHeaderChange(e,t),!0}_setupByConditions(e,t){this._disposePreviousModel();const s=e.getRange();if(s.startRow===s.endRow)return!1;const n=ve.fromFilterColumn(this._injector,e,t,e.getFilterColumn(t));return this.filterByModel=n,this._filterBy$.next(c.FilterBy.CONDITIONS),this._listenToFilterHeaderChange(e,t),!0}_disposePreviousModel(){var e;(e=this._filterByModel)==null||e.dispose(),this.filterByModel=null}};q=Te([ce(0,u.Inject(u.Injector)),ce(1,u.Inject(y.RefRangeService))],q);let ve=class extends u.Disposable{constructor(e,t,s,n,a){super();_(this,"canApply$",S.of(!0));_(this,"_conditionItem$");_(this,"conditionItem$");_(this,"_filterConditionFormParams$");_(this,"filterConditionFormParams$");this._filterModel=e,this.col=t,this._commandService=a,this._conditionItem$=new S.BehaviorSubject(s),this.conditionItem$=this._conditionItem$.asObservable(),this._filterConditionFormParams$=new S.BehaviorSubject(n),this.filterConditionFormParams$=this._filterConditionFormParams$.asObservable()}static fromFilterColumn(e,t,s,n){const[a,i]=f.testMappingFilterColumn(n==null?void 0:n.getColumnData());return e.createInstance(ve,t,s,a,i)}get conditionItem(){return this._conditionItem$.getValue()}get filterConditionFormParams(){return this._filterConditionFormParams$.getValue()}dispose(){super.dispose(),this._conditionItem$.complete(),this._filterConditionFormParams$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;const e=f.mapToFilterColumn(this.conditionItem,this.filterConditionFormParams);return this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:e})}onPrimaryConditionChange(e){const t=f.ALL_CONDITIONS.find(s=>s.operator===e);if(!t)throw new Error(`[ByConditionsModel]: condition item not found for operator: ${e}!`);this._conditionItem$.next(t),this._filterConditionFormParams$.next(f.getInitialFormParams(e))}onConditionFormChange(e){const t={...this.filterConditionFormParams,...e};if(t.and!==!0&&delete t.and,typeof e.and<"u"||typeof e.operator1<"u"||typeof e.operator2<"u"){const s=f.testMappingParams(t,this.conditionItem.numOfParameters);this._conditionItem$.next(s)}this._filterConditionFormParams$.next(t)}};ve=Te([ce(4,u.ICommandService)],ve);let _e=class extends u.Disposable{constructor(e,t,s,n,a){super();_(this,"_rawFilterItems$");_(this,"rawFilterItems$");_(this,"filterItems$");_(this,"_filterItems",[]);_(this,"_treeMapCache");_(this,"canApply$");_(this,"_manuallyUpdateFilterItems$");_(this,"_searchString$");_(this,"searchString$");this._filterModel=e,this.col=t,this._commandService=a,this._treeMapCache=n,this._searchString$=new S.BehaviorSubject(""),this.searchString$=this._searchString$.asObservable(),this._rawFilterItems$=new S.BehaviorSubject(s),this.rawFilterItems$=this._rawFilterItems$.asObservable(),this._manuallyUpdateFilterItems$=new S.Subject,this.filterItems$=S.merge(S.combineLatest([this._searchString$.pipe(S.throttleTime(500,void 0,{leading:!0,trailing:!0}),S.startWith(void 0)),this._rawFilterItems$]).pipe(S.map(([i,o])=>{if(!i)return o;const h=i.toLowerCase().split(/\s+/).filter(d=>!!d);return Ye(o,h)})),this._manuallyUpdateFilterItems$).pipe(S.shareReplay(1)),this.canApply$=this.filterItems$.pipe(S.map(i=>Re(i).checked>0)),this.disposeWithMe(this.filterItems$.subscribe(i=>this._filterItems=i))}static async fromFilterColumn(e,t,s){const n=e.get(u.IUniverInstanceService),a=e.get(u.LocaleService),i=e.get(fe,u.Quantity.OPTIONAL),{unitId:o,subUnitId:l}=t,h=n.getUniverSheetInstance(o);if(!h)throw new Error(`[ByValuesModel]: Workbook not found for filter model with unitId: ${o}!`);const d=h==null?void 0:h.getSheetBySheetId(l);if(!d)throw new Error(`[ByValuesModel]: Worksheet not found for filter model with unitId: ${o} and subUnitId: ${l}!`);const p=t.getRange(),T=s,v=t.getFilterColumn(s),C=v==null?void 0:v.getColumnData().filters,E=new Set(C==null?void 0:C.filters),b=!!(C&&C.blank),R=t.getFilteredOutRowsExceptCol(s),x={...p,startRow:p.startRow+1,startColumn:T,endColumn:T};let A,L;if(i){const M=await i.getFilterValues({unitId:o,subUnitId:l,filteredOutRowsByOtherColumns:Array.from(R),filterColumn:v,filters:!!C,blankChecked:b,iterateRange:x,alreadyChecked:Array.from(E)});A=M.filterTreeItems,L=M.filterTreeMapCache}else{const M=Qe(!!C,a,x,d,R,v,E,b,h.getStyles());A=M.filterTreeItems,L=M.filterTreeMapCache}return e.createInstance(_e,t,s,A,L)}get rawFilterItems(){return this._rawFilterItems$.getValue()}get filterItems(){return this._filterItems}get treeMapCache(){return this._treeMapCache}dispose(){this._rawFilterItems$.complete(),this._searchString$.complete()}deltaCol(e){this.col+=e}setSearchString(e){this._searchString$.next(e)}onCheckAllToggled(e){const t=u.Tools.deepClone(this._filterItems);t.forEach(s=>le(s,e)),this._manuallyUpdateFilterItems(t)}onFilterCheckToggled(e){const t=u.Tools.deepClone(this._filterItems),s=Ae(t,e.key);if(!s)return;const n=Ge(s);le(s,!n),this._manuallyUpdateFilterItems(t)}onFilterOnly(e){const t=u.Tools.deepClone(this._filterItems);t.forEach(s=>le(s,!1)),e.forEach(s=>{const n=Ae(t,s);n&&le(n,!0)}),this._manuallyUpdateFilterItems(t)}_manuallyUpdateFilterItems(e){this._manuallyUpdateFilterItems$.next(e)}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;const e=Re(this._filterItems),{checked:t,checkedItems:s}=e,n=this.rawFilterItems;let a=0;for(const h of n)a+=h.count;const i=t===0,o=e.checked===a,l={colId:this.col};if(i)throw new Error("[ByValuesModel]: no checked items!");if(o)return this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});{l.filters={};const h=s.filter(p=>p.key!=="empty");h.length>0&&(l.filters={filters:h.flatMap(p=>p.originValues?Array.from(p.originValues):[p.title])}),h.length!==s.length&&(l.filters.blank=!0)}return this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:l})}};_e=Te([ce(4,u.ICommandService)],_e);let ge=class extends u.Disposable{constructor(e,t,s,n,a){super();_(this,"canApply$",S.of(!0));_(this,"_cellFillColors$");_(this,"cellFillColors$");_(this,"_cellTextColors$");_(this,"cellTextColors$");this._filterModel=e,this.col=t,this._commandService=a,this._cellFillColors$=new S.BehaviorSubject(Array.from(s.values())),this.cellFillColors$=this._cellFillColors$.asObservable(),this._cellTextColors$=new S.BehaviorSubject(Array.from(n.values())),this.cellTextColors$=this._cellTextColors$.asObservable()}static async fromFilterColumn(e,t,s){var x,A,L;const n=e.get(u.IUniverInstanceService),{unitId:a,subUnitId:i}=t,o=n.getUniverSheetInstance(a);if(!o)throw new Error(`[ByColorsModel]: Workbook not found for filter model with unitId: ${a}!`);const l=o==null?void 0:o.getSheetBySheetId(i);if(!l)throw new Error(`[ByColorsModel]: Worksheet not found for filter model with unitId: ${a} and subUnitId: ${i}!`);const h=t.getRange(),d=s,p=(x=t.getFilterColumn(s))==null?void 0:x.getColumnData().colorFilters,T=t.getFilteredOutRowsExceptCol(s),v={...h,startRow:h.startRow+1,startColumn:d,endColumn:d},C=new Map,E=new Set((A=p==null?void 0:p.cellFillColors)!=null?A:[]),b=new Map,R=new Set((L=p==null?void 0:p.cellTextColors)!=null?L:[]);for(const M of l.iterateByColumn(v,!1,!0)){const{row:V,col:Q,value:J}=M;if(T.has(V))continue;const k=l.getComposedCellStyleByCellData(V,Q,J);if(k.bg&&k.bg.rgb){const I=new u.ColorKit(k.bg.rgb).toRgbString();C.has(I)||C.set(I,{color:I,checked:E.has(I)})}else C.set("default-fill-color",{color:null,checked:E.has(null)});if(k.cl&&k.cl.rgb){const I=new u.ColorKit(k.cl.rgb).toRgbString();b.has(I)||b.set(I,{color:I,checked:R.has(I)})}else b.set("default-font-color",{color:z.COLOR_BLACK_RGB,checked:R.has(z.COLOR_BLACK_RGB)})}return e.createInstance(ge,t,s,C,b)}get cellFillColors(){return this._cellFillColors$.getValue()}get cellTextColors(){return this._cellTextColors$.getValue()}dispose(){super.dispose(),this._cellFillColors$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}onFilterCheckToggled(e,t=!0){const s=t?this.cellFillColors:this.cellTextColors,n=[];let a=!1;for(let i=0;i<s.length;i++){const o=s[i];if(o.color===e.color){a=!0,n.push({color:o.color,checked:!o.checked});continue}n.push({color:o.color,checked:o.checked})}a&&(this._resetColorsCheckedStatus(!t),t?this._cellFillColors$.next([...n]):this._cellTextColors$.next([...n]))}_resetColorsCheckedStatus(e=!0){const t=e?this.cellFillColors:this.cellTextColors,s=[];for(let n=0;n<t.length;n++)s.push({color:t[n].color,checked:!1});e?this._cellFillColors$.next([...s]):this._cellTextColors$.next([...s])}async apply(){if(this._disposed)return!1;const e=this.cellFillColors.filter(n=>n.checked).map(n=>n.color),t=this.cellTextColors.filter(n=>n.checked).map(n=>n.color);if(e.length===0&&t.length===0)return this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});const s={colId:this.col};return e.length>0?s.colorFilters={cellFillColors:e}:t.length>0&&(s.colorFilters={cellTextColors:t}),this._commandService.executeCommand(c.SetSheetsFilterCriteriaCommand.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:s})}};ge=Te([ce(4,u.ICommandService)],ge);const ie="FILTER_PANEL_OPENED",ue={id:"sheet.operation.open-filter-panel",type:u.CommandType.OPERATION,handler:(r,e)=>{const t=r.get(u.IContextService),s=r.get(c.SheetsFilterService),n=r.get(q),a=r.get(u.ICommandService),i=r.has($.IEditorBridgeService)?r.get($.IEditorBridgeService):null;i!=null&&i.isVisible().visible&&a.syncExecuteCommand($.SetCellEditVisibleOperation.id,{visible:!1});const{unitId:o,subUnitId:l,col:h}=e,d=s.getFilterModel(o,l);return d?(n.setupCol(d,h),t.getContextValue(ie)||t.setContextValue(ie,!0),!0):!1}},re={id:"sheet.operation.close-filter-panel",type:u.CommandType.OPERATION,handler:r=>{const e=r.get(u.IContextService),t=r.get(q),s=r.get(g.ILayoutService,u.Quantity.OPTIONAL);return e.getContextValue(ie)?(e.setContextValue(ie,!1),s==null||s.focus(),t.terminate()):!1}},$e={id:"sheet.operation.apply-filter",type:u.CommandType.OPERATION,handler:(r,e)=>{const{filterBy:t}=e;return r.get(q).changeFilterBy(t)}},qe="sheets-filter-ui.config",Ce={};var ht=Object.getOwnPropertyDescriptor,mt=(r,e,t,s)=>{for(var n=s>1?void 0:s?ht(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},te=(r,e)=>(t,s)=>e(t,s,r);let se=class extends u.Disposable{constructor(r,e,t,s,n,a){super(),this._sheetsFilterService=r,this._localeService=e,this._commandService=t,this._sheetPermissionCheckPermission=s,this._injector=n,this._sheetsSelectionService=a,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(r=>{var e,t,s;if(r.id===c.SmartToggleSheetsFilterCommand.id){const n=this._injector.get(u.IUniverInstanceService),a=y.getSheetCommandTarget(n);if(!a)return;const{unitId:i,subUnitId:o,worksheet:l}=a,h=(e=this._sheetsFilterService.getFilterModel(i,o))==null?void 0:e.getRange();let d;if(h)d=this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[y.RangeProtectionPermissionViewPoint],worksheetTypes:[y.WorksheetFilterPermission,y.WorksheetViewPermission]},[h],i,o);else{const p=(t=this._sheetsSelectionService.getCurrentLastSelection())==null?void 0:t.range;if(p){let T={...p};T=p.startColumn===p.endColumn&&p.startRow===p.endRow?y.expandToContinuousRange(T,{left:!0,right:!0,up:!0,down:!0},l):T,d=this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[y.RangeProtectionPermissionViewPoint],worksheetTypes:[y.WorksheetViewPermission,y.WorksheetFilterPermission]},[T],i,o)}else d=this._sheetPermissionCheckPermission.permissionCheckWithoutRange({rangeTypes:[y.RangeProtectionPermissionViewPoint],worksheetTypes:[y.WorksheetViewPermission,y.WorksheetFilterPermission]})}d||this._sheetPermissionCheckPermission.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.filterErr"))}if(r.id===ue.id){const n=r.params,{unitId:a,subUnitId:i}=n,o=(s=this._sheetsFilterService.getFilterModel(a,i))==null?void 0:s.getRange(),l=u.Tools.deepClone(o);l&&(l.startColumn=n.col,l.endColumn=n.col,this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[y.RangeProtectionPermissionViewPoint],worksheetTypes:[y.WorksheetFilterPermission,y.WorksheetViewPermission]},[l],a,i)||this._sheetPermissionCheckPermission.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.filterErr")))}}))}};se=mt([te(0,u.Inject(c.SheetsFilterService)),te(1,u.Inject(u.LocaleService)),te(2,u.ICommandService),te(3,u.Inject(y.SheetPermissionCheckController)),te(4,u.Inject(u.Injector)),te(5,u.Inject(y.SheetsSelectionsService))],se);const Y=16,dt=new Path2D("M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z");class je{static drawNoCriteria(e,t,s,n){e.save(),z.Rect.drawWith(e,{radius:2,width:Y,height:Y,fill:n}),e.lineCap="square",e.strokeStyle=s,e.scale(t/Y,t/Y),e.beginPath(),e.lineWidth=1,e.lineCap="round",e.moveTo(3,4),e.lineTo(13,4),e.moveTo(4.5,8),e.lineTo(11.5,8),e.moveTo(6,12),e.lineTo(10,12),e.stroke(),e.restore()}static drawHasCriteria(e,t,s,n){e.save(),z.Rect.drawWith(e,{radius:2,width:Y,height:Y,fill:n}),e.scale(t/Y,t/Y),e.fillStyle=s,e.fill(dt),e.restore()}}var pt=Object.getOwnPropertyDescriptor,ft=(r,e,t,s)=>{for(var n=s>1?void 0:s?pt(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},be=(r,e)=>(t,s)=>e(t,s,r);const H=16,ae=1;let we=class extends z.Shape{constructor(e,t,s,n,a){super(e,t);_(this,"_cellWidth",0);_(this,"_cellHeight",0);_(this,"_filterParams");_(this,"_hovered",!1);this._contextService=s,this._commandService=n,this._themeService=a,this.setShapeProps(t),this.onPointerDown$.subscribeEvent(i=>this.onPointerDown(i)),this.onPointerEnter$.subscribeEvent(()=>this.onPointerEnter()),this.onPointerLeave$.subscribeEvent(()=>this.onPointerLeave())}setShapeProps(e){typeof e.cellHeight<"u"&&(this._cellHeight=e.cellHeight),typeof e.cellWidth<"u"&&(this._cellWidth=e.cellWidth),typeof e.filterParams<"u"&&(this._filterParams=e.filterParams),this.transformByState({width:e.width,height:e.height})}_draw(e){const t=this._cellHeight,s=this._cellWidth,n=H-s,a=H-t;e.save();const i=new Path2D;i.rect(n,a,s,t),e.clip(i);const{hasCriteria:o}=this._filterParams,l=this._themeService.getColorFromTheme("primary.600"),h=this._hovered?this._themeService.getColorFromTheme("gray.50"):"rgba(255, 255, 255, 1.0)";o?je.drawHasCriteria(e,H,l,h):je.drawNoCriteria(e,H,l,h),e.restore()}onPointerDown(e){if(e.button===2)return;const{col:t,unitId:s,subUnitId:n}=this._filterParams;this._contextService.getContextValue(ie)||!this._commandService.hasCommand(ue.id)||setTimeout(()=>{this._commandService.executeCommand(ue.id,{unitId:s,subUnitId:n,col:t})},200)}onPointerEnter(){this._hovered=!0,this.makeDirty(!0)}onPointerLeave(){this._hovered=!1,this.makeDirty(!0)}};we=ft([be(2,u.IContextService),be(3,u.ICommandService),be(4,u.Inject(u.ThemeService))],we);var vt=Object.getOwnPropertyDescriptor,_t=(r,e,t,s)=>{for(var n=s>1?void 0:s?vt(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},X=(r,e)=>(t,s)=>e(t,s,r);const gt=1e3,Ct=5e3;function St(r,e,t,s){switch(s){case u.VerticalAlign.TOP:return r+ae;case u.VerticalAlign.MIDDLE:return r+Math.max(0,(t-H)/2);case u.VerticalAlign.BOTTOM:default:return e-H-ae}}let xe=class extends u.RxDisposable{constructor(e,t,s,n,a,i,o,l){super();_(this,"_filterRangeShape",null);_(this,"_buttonRenderDisposable",null);_(this,"_filterButtonShapes",[]);this._context=e,this._injector=t,this._sheetSkeletonManagerService=s,this._sheetsFilterService=n,this._themeService=a,this._sheetInterceptorService=i,this._commandService=o,this._selectionRenderService=l,this._initRenderer()}dispose(){super.dispose(),this._disposeRendering()}_initRenderer(){this._sheetSkeletonManagerService.currentSkeleton$.pipe(S.switchMap(e=>{var o,l;if(!e)return S.of(null);const{unit:t,unitId:s}=this._context,n=((o=t.getActiveSheet())==null?void 0:o.getSheetId())||"",a=(l=this._sheetsFilterService.getFilterModel(s,n))!=null?l:void 0,i=()=>({unitId:s,worksheetId:n,filterModel:a,range:a==null?void 0:a.getRange(),skeleton:e.skeleton});return u.fromCallback(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(S.filter(([h])=>{var d;return h.type===u.CommandType.MUTATION&&((d=h.params)==null?void 0:d.unitId)===t.getUnitId()&&(c.FILTER_MUTATIONS.has(h.id)||h.id===y.SetRangeValuesMutation.id)}),S.throttleTime(20,void 0,{leading:!1,trailing:!0}),S.map(i),S.startWith(i()))}),S.takeUntil(this.dispose$)).subscribe(e=>{this._disposeRendering(),!(!e||!e.range)&&(this._renderRange(e.range,e.skeleton),this._renderButtons(e))})}_renderRange(e,t){const{scene:s}=this._context,{rowHeaderWidth:n,columnHeaderHeight:a}=t,i=this._filterRangeShape=new $.SelectionControl(s,gt,this._themeService,{rowHeaderWidth:n,columnHeaderHeight:a,enableAutoFill:!1,highlightHeader:!1}),o={range:e,primary:null,style:{fill:"rgba(0, 0, 0, 0.0)"}},l=$.attachSelectionWithCoord(o,t);i.updateRangeBySelectionWithCoord(l),i.setEvent(!1),s.makeDirty(!0)}_renderButtons(e){const{range:t,filterModel:s,unitId:n,skeleton:a,worksheetId:i}=e,{unit:o,scene:l}=this._context,h=o.getSheetBySheetId(i);if(!h)return;this._interceptCellContent(n,i,e.range);const{startColumn:d,endColumn:p,startRow:T}=t;for(let v=d;v<=p;v++){const C=`sheets-filter-button-${v}`,E=$.getCoordByCell(T,v,l,a),b=h.getComposedCellStyle(T,v),R=(b==null?void 0:b.vt)||u.VerticalAlign.BOTTOM,{startX:x,startY:A,endX:L,endY:M}=E,V=L-x,Q=M-A;if(Q<=ae||V<=ae)continue;const J=!!s.getFilterColumn(v),k=L-H-ae,I=St(A,M,Q,R),Ee={left:k,top:I,height:H,width:H,zIndex:Ct,cellHeight:Q,cellWidth:V,filterParams:{unitId:n,subUnitId:i,col:v,hasCriteria:J}},me=this._injector.createInstance(we,C,Ee);this._filterButtonShapes.push(me)}l.addObjects(this._filterButtonShapes),l.makeDirty()}_interceptCellContent(e,t,s){const{startRow:n,startColumn:a,endColumn:i}=s;this._buttonRenderDisposable=this._sheetInterceptorService.intercept(y.INTERCEPTOR_POINT.CELL_CONTENT,{effect:u.InterceptorEffectEnum.Style,handler:(o,l,h)=>{const{row:d,col:p,unitId:T,subUnitId:v}=l;return T!==e||v!==t||d!==n||p<a||p>i||((!o||o===l.rawData)&&(o={...l.rawData}),o.fontRenderExtension={...o==null?void 0:o.fontRenderExtension,rightOffset:H}),h(o)},priority:10})}_disposeRendering(){var e,t;(e=this._filterRangeShape)==null||e.dispose(),this._filterButtonShapes.forEach(s=>s.dispose()),(t=this._buttonRenderDisposable)==null||t.dispose(),this._filterRangeShape=null,this._buttonRenderDisposable=null,this._filterButtonShapes=[]}};xe=_t([X(1,u.Inject(u.Injector)),X(2,u.Inject($.SheetSkeletonManagerService)),X(3,u.Inject(c.SheetsFilterService)),X(4,u.Inject(u.ThemeService)),X(5,u.Inject(y.SheetInterceptorService)),X(6,u.ICommandService),X(7,$.ISheetSelectionRenderService)],xe);var Ft=Object.getOwnPropertyDescriptor,Tt=(r,e,t,s)=>{for(var n=s>1?void 0:s?Ft(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},Be=(r,e)=>(t,s)=>e(t,s,r);let he=class extends u.RxDisposable{constructor(r,e){super(),this._renderManagerService=r,this._sheetsRenderService=e,[c.SetSheetsFilterRangeMutation,c.SetSheetsFilterCriteriaMutation,c.RemoveSheetsFilterMutation,c.ReCalcSheetsFilterMutation].forEach(t=>this.disposeWithMe(this._sheetsRenderService.registerSkeletonChangingMutations(t.id))),this.disposeWithMe(this._renderManagerService.registerRenderModule(u.UniverInstanceType.UNIVER_SHEET,[xe]))}};he=Tt([Be(0,z.IRenderManagerService),Be(1,u.Inject($.SheetsRenderService))],he);var Et=Object.defineProperty,Ot=Object.getOwnPropertyDescriptor,It=(r,e,t)=>e in r?Et(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Nt=(r,e,t,s)=>{for(var n=s>1?void 0:s?Ot(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},De=(r,e)=>(t,s)=>e(t,s,r),Ze=(r,e,t)=>It(r,typeof e!="symbol"?e+"":e,t);const bt="SHEET_FILTER_UI_PLUGIN";exports.UniverSheetsFilterMobileUIPlugin=class extends u.Plugin{constructor(e=Ce,t,s){super(),this._config=e,this._injector=t,this._configService=s;const{menu:n,...a}=u.merge({},Ce,this._config);n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(qe,a)}onStarting(){[[se],[he]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(se)}onRendered(){this._injector.get(he)}};Ze(exports.UniverSheetsFilterMobileUIPlugin,"type",u.UniverInstanceType.UNIVER_SHEET);Ze(exports.UniverSheetsFilterMobileUIPlugin,"pluginName",bt);exports.UniverSheetsFilterMobileUIPlugin=Nt([u.DependentOn(c.UniverSheetsFilterPlugin),De(1,u.Inject(u.Injector)),De(2,u.IConfigService)],exports.UniverSheetsFilterMobileUIPlugin);function ne({ref:r,...e}){const{icon:t,id:s,className:n,extend:a,...i}=e,o=`univerjs-icon univerjs-icon-${s} ${n||""}`.trim(),l=O.useRef(`_${Pt()}`);return Ke(t,`${s}`,{defIds:t.defIds,idSuffix:l.current},{ref:r,className:o,...i},a)}function Ke(r,e,t,s,n){return O.createElement(r.tag,{key:e,...yt(r,t,n),...s},(Rt(r,t).children||[]).map((a,i)=>Ke(a,`${e}-${r.tag}-${i}`,t,void 0,n)))}function yt(r,e,t){const s={...r.attrs};t!=null&&t.colorChannel1&&s.fill==="colorChannel1"&&(s.fill=t.colorChannel1),r.tag==="mask"&&s.id&&(s.id=s.id+e.idSuffix),Object.entries(s).forEach(([a,i])=>{a==="mask"&&typeof i=="string"&&(s[a]=i.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:n}=e;return!n||n.length===0||(r.tag==="use"&&s["xlink:href"]&&(s["xlink:href"]=s["xlink:href"]+e.idSuffix),Object.entries(s).forEach(([a,i])=>{typeof i=="string"&&(s[a]=i.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),s}function Rt(r,e){var s;const{defIds:t}=e;return!t||t.length===0?r:r.tag==="defs"&&((s=r.children)!=null&&s.length)?{...r,children:r.children.map(n=>typeof n.attrs.id=="string"&&t&&t.includes(n.attrs.id)?{...n,attrs:{...n.attrs,id:n.attrs.id+e.idSuffix}}:n)}:r}function Pt(){return Math.random().toString(36).substring(2,8)}ne.displayName="UniverIcon";const At={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M10 1.05957C10.356 1.05957 10.6816 1.26162 10.8408 1.58008L18.8408 17.5801L18.8799 17.668C19.0486 18.1134 18.8551 18.6232 18.4199 18.8408C17.9557 19.0727 17.3913 18.8841 17.1592 18.4199L10 4.10156L2.84082 18.4199C2.60871 18.8841 2.04434 19.0727 1.58008 18.8408C1.11587 18.6087 0.92731 18.0443 1.15918 17.5801L9.15918 1.58008C9.31841 1.26162 9.64395 1.05957 10 1.05957Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M15.3337 11.7261L15.4294 11.731C15.9035 11.779 16.2732 12.1798 16.2732 12.6665C16.2732 13.1532 15.9035 13.554 15.4294 13.602L15.3337 13.6069H4.66675C4.1476 13.6069 3.72632 13.1856 3.72632 12.6665C3.72632 12.1474 4.1476 11.7261 4.66675 11.7261H15.3337Z"}}]},Xe=O.forwardRef(function(e,t){return O.createElement(ne,Object.assign({},e,{id:"a-icon",ref:t,icon:At}))});Xe.displayName="AIcon";const wt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M17.0596 10C17.0596 6.10087 13.8992 2.94043 10 2.94043C6.10087 2.94043 2.94043 6.10087 2.94043 10C2.94043 13.8992 6.10087 17.0596 10 17.0596C13.8992 17.0596 17.0596 13.8992 17.0596 10ZM18.9404 10C18.9404 14.9374 14.9374 18.9404 10 18.9404C5.06257 18.9404 1.05957 14.9374 1.05957 10C1.05957 5.06257 5.06257 1.05957 10 1.05957C14.9374 1.05957 18.9404 5.06257 18.9404 10Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.29492 4.13476C4.63911 3.79057 5.1845 3.76906 5.55371 4.07031L5.625 4.13476L16.0244 14.5352L16.0889 14.6064C16.3902 14.9757 16.3686 15.52 16.0244 15.8643C15.6573 16.2313 15.0624 16.2313 14.6953 15.8643L4.29492 5.46484L4.23047 5.39355C3.92922 5.02434 3.95073 4.47895 4.29492 4.13476Z"}}]},ze=O.forwardRef(function(e,t){return O.createElement(ne,Object.assign({},e,{id:"ban-icon",ref:t,icon:wt}))});ze.displayName="BanIcon";const xt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.32182 2.60967C2.98161 2.60967 2.79671 3.0074 3.01601 3.2675L6.85819 7.8246C6.94943 7.93282 6.99947 8.06981 6.99947 8.21136V12.7338C6.99947 12.898 7.0998 13.0455 7.2525 13.1058L8.73833 13.6928C9.00085 13.7965 9.28531 13.6031 9.28531 13.3208V8.21136C9.28531 8.06981 9.33535 7.93282 9.42659 7.8246L13.2688 3.2675C13.4881 3.0074 13.3032 2.60967 12.963 2.60967H3.32182ZM2.09858 4.04101C1.22139 3.0006 1.96097 1.40967 3.32182 1.40967H12.963C14.3238 1.40967 15.0634 3.0006 14.1862 4.04101L10.4853 8.43054V13.3208C10.4853 14.4498 9.34747 15.2237 8.29742 14.8089L6.81158 14.2219C6.20078 13.9806 5.79947 13.3905 5.79947 12.7338V8.43054L2.09858 4.04101Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Je=O.forwardRef(function(e,t){return O.createElement(ne,Object.assign({},e,{id:"filter-icon",ref:t,icon:xt}))});Je.displayName="FilterIcon";const Lt={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.00016 1.33203C6.68162 1.33203 5.39269 1.72302 4.29636 2.45557C3.20004 3.18811 2.34555 4.2293 1.84097 5.44747C1.33638 6.66565 1.20436 8.00609 1.4616 9.2993C1.71883 10.5925 2.35377 11.7804 3.28612 12.7127C4.21847 13.6451 5.40636 14.28 6.69956 14.5373C7.99277 14.7945 9.33321 14.6625 10.5514 14.1579C11.7696 13.6533 12.8108 12.7988 13.5433 11.7025C14.2758 10.6062 14.6668 9.31724 14.6668 7.9987C14.6649 6.23118 13.9619 4.53662 12.7121 3.2868C11.4622 2.03697 9.76768 1.33397 8.00016 1.33203ZM7.66683 3.9987C7.86461 3.9987 8.05795 4.05735 8.2224 4.16723C8.38685 4.27711 8.51502 4.43329 8.59071 4.61601C8.6664 4.79874 8.6862 4.99981 8.64762 5.19379C8.60903 5.38777 8.51379 5.56595 8.37394 5.7058C8.23409 5.84566 8.0559 5.9409 7.86192 5.97948C7.66794 6.01807 7.46687 5.99826 7.28415 5.92258C7.10142 5.84689 6.94524 5.71872 6.83536 5.55427C6.72548 5.38982 6.66683 5.19648 6.66683 4.9987C6.66683 4.73348 6.77219 4.47913 6.95972 4.29159C7.14726 4.10405 7.40162 3.9987 7.66683 3.9987ZM9.3335 11.332H6.66683C6.49002 11.332 6.32045 11.2618 6.19543 11.1368C6.0704 11.0117 6.00016 10.8422 6.00016 10.6654C6.00016 10.4886 6.0704 10.319 6.19543 10.194C6.32045 10.0689 6.49002 9.9987 6.66683 9.9987H7.3335V7.9987H6.66683C6.49002 7.9987 6.32045 7.92846 6.19543 7.80343C6.0704 7.67841 6.00016 7.50884 6.00016 7.33203C6.00016 7.15522 6.0704 6.98565 6.19543 6.86063C6.32045 6.7356 6.49002 6.66536 6.66683 6.66536H8.00016C8.17698 6.66536 8.34655 6.7356 8.47157 6.86063C8.59659 6.98565 8.66683 7.15522 8.66683 7.33203V9.9987H9.3335C9.51031 9.9987 9.67988 10.0689 9.8049 10.194C9.92993 10.319 10.0002 10.4886 10.0002 10.6654C10.0002 10.8422 9.92993 11.0117 9.8049 11.1368C9.67988 11.2618 9.51031 11.332 9.3335 11.332Z"}}]},et=O.forwardRef(function(e,t){return O.createElement(ne,Object.assign({},e,{id:"info-icon",ref:t,icon:Lt}))});et.displayName="InfoIcon";const $t={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8 15C11.866 15 15 11.866 15 8C15 4.13401 11.866 1 8 1C4.13401 1 1 4.13401 1 8C1 11.866 4.13401 15 8 15ZM11.7245 6.42417C11.9588 6.18985 11.9588 5.80995 11.7245 5.57564C11.4901 5.34132 11.1102 5.34132 10.8759 5.57564L7.3002 9.15137L5.72446 7.57564C5.49014 7.34132 5.11025 7.34132 4.87593 7.57564C4.64162 7.80995 4.64162 8.18985 4.87593 8.42417L6.87593 10.4242C7.11025 10.6585 7.49014 10.6585 7.72446 10.4242L11.7245 6.42417Z",fillRule:"evenodd",clipRule:"evenodd"}}]},tt=O.forwardRef(function(e,t){return O.createElement(ne,Object.assign({},e,{id:"success-icon",ref:t,icon:$t}))});tt.displayName="SuccessIcon";function Mt(r){const{model:e}=r,t=g.useDependency(u.LocaleService),s=g.useObservable(e.cellFillColors$,[],!0),n=g.useObservable(e.cellTextColors$,[],!0),a=O.useCallback(o=>{e.onFilterCheckToggled(o)},[e]),i=O.useCallback(o=>{e.onFilterCheckToggled(o,!1)},[e]);return m.jsx("div",{"data-u-comp":"sheets-filter-panel-colors-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:m.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:N.clsx("univer-mt-2 univer-box-border univer-flex univer-h-[300px] univer-flex-grow univer-flex-col univer-gap-4 univer-overflow-auto univer-rounded-md univer-px-2 univer-py-2.5",N.borderClassName),children:[s.length>1&&m.jsxs("div",{children:[m.jsx("div",{className:"univer-mb-2 univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:t.t("sheets-filter.panel.filter-by-cell-fill-color")}),m.jsx("div",{className:"univer-grid univer-grid-cols-8 univer-items-center univer-justify-start univer-gap-2",children:s.map((o,l)=>m.jsxs("div",{className:"univer-relative univer-h-6 univer-w-6",onClick:()=>a(o),children:[o.color?m.jsx("button",{type:"button",className:N.clsx("univer-box-border univer-h-6 univer-w-6 univer-cursor-pointer univer-rounded-full univer-border univer-border-solid univer-border-transparent univer-bg-gray-300 univer-transition-shadow hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white"),style:{backgroundColor:o.color}}):m.jsx(ze,{className:"univer-h-6 univer-w-6 univer-cursor-pointer univer-rounded-full hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white"}),o.checked&&m.jsx(He,{})]},`sheets-filter-cell-fill-color-${l}`))})]}),n.length>1&&m.jsxs("div",{children:[m.jsx("div",{className:"univer-mb-2 univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:t.t("sheets-filter.panel.filter-by-cell-text-color")}),m.jsx("div",{className:"univer-grid univer-grid-cols-8 univer-items-center univer-justify-start univer-gap-2",children:n.map((o,l)=>m.jsxs("div",{className:"univer-relative univer-h-6 univer-w-6",onClick:()=>i(o),children:[m.jsx("div",{className:"univer-box-border univer-flex univer-h-full univer-w-full univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-full univer-border univer-border-solid univer-border-[rgba(13,13,13,0.06)] univer-p-0.5 hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white dark:!univer-border-[rgba(255,255,255,0.06)]",children:m.jsx(Xe,{style:{color:o.color}})}),o.checked&&m.jsx(He,{})]},`sheets-filter-cell-text-color-${l}`))})]}),s.length<=1&&n.length<=1&&m.jsx("div",{className:"univer-flex univer-h-full univer-w-full univer-items-center univer-justify-center univer-text-sm univer-text-gray-900 dark:!univer-text-gray-200",children:t.t("sheets-filter.panel.filter-by-color-none")})]})})}function He(){return m.jsx("div",{className:"univer-absolute -univer-bottom-0.5 -univer-right-0.5 univer-flex univer-h-3 univer-w-3 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-full univer-bg-white",children:m.jsx(tt,{className:"univer-h-full univer-w-full univer-font-bold univer-text-[#418F1F]"})})}function Ut(r){var v,C;const{model:e}=r,t=g.useDependency(u.LocaleService),s=g.useObservable(e.conditionItem$,void 0),n=g.useObservable(e.filterConditionFormParams$,void 0),a=n!=null&&n.and?"AND":"OR",i=O.useCallback(E=>{e.onConditionFormChange({and:E==="AND"})},[e]),o=kt(t),l=O.useCallback(E=>{e.onPrimaryConditionChange(E)},[e]),h=jt(t),d=O.useCallback(E=>{e.onConditionFormChange(E)},[e]),p=t.t("sheets-filter.panel.input-values-placeholder");function T(E,b,R){const x=f.getItemByOperator(E).numOfParameters===1;return m.jsxs(m.Fragment,{children:[R==="operator2"&&m.jsxs(N.RadioGroup,{value:a,onChange:i,children:[m.jsx(N.Radio,{value:"AND",children:t.t("sheets-filter.panel.and")}),m.jsx(N.Radio,{value:"OR",children:t.t("sheets-filter.panel.or")})]}),m.jsx(N.Select,{value:E,options:h,onChange:A=>d({[R]:A})}),x&&m.jsx("div",{children:m.jsx(N.Input,{className:"univer-mt-2",value:b,placeholder:p,onChange:A=>d({[R==="operator1"?"val1":"val2"]:A})})})]})}return m.jsx("div",{"data-u-comp":"sheets-filter-panel-conditions-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:s&&n&&m.jsxs(m.Fragment,{children:[m.jsx(N.Select,{value:s.operator,options:o,onChange:l}),f.getItemByOperator(s.operator).numOfParameters!==0?m.jsxs("div",{"data-u-comp":"sheets-filter-panel-conditions-container-inner",className:N.clsx("univer-mt-2 univer-flex-grow univer-overflow-hidden univer-rounded-md univer-p-2",N.borderClassName),children:[s.numOfParameters>=1&&T(n.operator1,(v=n.val1)!=null?v:"","operator1"),s.numOfParameters>=2&&T(n.operator2,(C=n.val2)!=null?C:"","operator2"),m.jsxs("div",{"data-u-comp":"sheets-filter-panel-conditions-desc",className:"univer-mt-2 univer-text-xs univer-text-gray-500",children:[t.t("sheets-filter.panel.?"),m.jsx("br",{}),t.t("sheets-filter.panel.*")]})]}):null]})})}function kt(r){const e=r.getCurrentLocale();return O.useMemo(()=>[{options:[{label:r.t(f.NONE.label),value:f.NONE.operator}]},{options:[{label:r.t(f.EMPTY.label),value:f.EMPTY.operator},{label:r.t(f.NOT_EMPTY.label),value:f.NOT_EMPTY.operator}]},{options:[{label:r.t(f.TEXT_CONTAINS.label),value:f.TEXT_CONTAINS.operator},{label:r.t(f.DOES_NOT_CONTAIN.label),value:f.DOES_NOT_CONTAIN.operator},{label:r.t(f.STARTS_WITH.label),value:f.STARTS_WITH.operator},{label:r.t(f.ENDS_WITH.label),value:f.ENDS_WITH.operator},{label:r.t(f.EQUALS.label),value:f.EQUALS.operator}]},{options:[{label:r.t(f.GREATER_THAN.label),value:f.GREATER_THAN.operator},{label:r.t(f.GREATER_THAN_OR_EQUAL.label),value:f.GREATER_THAN_OR_EQUAL.operator},{label:r.t(f.LESS_THAN.label),value:f.LESS_THAN.operator},{label:r.t(f.LESS_THAN_OR_EQUAL.label),value:f.LESS_THAN_OR_EQUAL.operator},{label:r.t(f.EQUAL.label),value:f.EQUAL.operator},{label:r.t(f.NOT_EQUAL.label),value:f.NOT_EQUAL.operator},{label:r.t(f.BETWEEN.label),value:f.BETWEEN.operator},{label:r.t(f.NOT_BETWEEN.label),value:f.NOT_BETWEEN.operator}]},{options:[{label:r.t(f.CUSTOM.label),value:f.CUSTOM.operator}]}],[e,r])}function jt(r){const e=r.getCurrentLocale();return O.useMemo(()=>f.ALL_CONDITIONS.filter(t=>t.numOfParameters!==2).map(t=>({label:r.t(t.label),value:t.operator})),[e,r])}function Bt(r){const{model:e}=r,t=g.useDependency(u.LocaleService),s=g.useObservable(e.searchString$,"",!0),n=g.useObservable(e.filterItems$,void 0,!0),a=t.t("sheets-filter.panel.filter-only"),i=Re(n),o=i.checked>0&&i.unchecked===0,l=i.checked>0&&i.unchecked>0,h=e.treeMapCache,d=O.useCallback(()=>{e.onCheckAllToggled(!o)},[e,o]),p=O.useCallback(v=>{e.setSearchString(v)},[e]);function T(v){let C=[];return v.forEach(E=>{E.checked&&C.push(E.key),E.children&&(C=C.concat(T(E.children)))}),C}return m.jsxs("div",{"data-u-comp":"sheets-filter-panel-values-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:[m.jsx(N.Input,{autoFocus:!0,value:s,placeholder:t.t("sheets-filter.panel.search-placeholder"),onChange:p}),m.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:N.clsx("univer-mt-2 univer-box-border univer-flex univer-flex-grow univer-flex-col univer-overflow-hidden univer-rounded-md univer-px-2 univer-py-2.5",N.borderClassName),children:[m.jsx("div",{"data-u-comp":"sheets-filter-panel-values-item",className:"univer-box-border univer-h-8 univer-w-full univer-py-0.5",children:m.jsxs("div",{"data-u-comp":"sheets-filter-panel-values-item-inner",className:"univer-box-border univer-flex univer-h-7 univer-items-center univer-rounded-md univer-pb-0 univer-pl-5 univer-pr-0.5 univer-pt-0 univer-text-sm",children:[m.jsx(N.Checkbox,{indeterminate:l,disabled:n.length===0,checked:o,onChange:d}),m.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-text",className:"univer-mx-1 univer-inline-block univer-flex-shrink univer-truncate univer-text-gray-900 dark:!univer-text-white",children:`${t.t("sheets-filter.panel.select-all")}`}),m.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-count",className:"univer-text-gray-400 dark:!univer-text-gray-500",children:`(${i.checked}/${i.checked+i.unchecked})`})]})}),m.jsx("div",{"data-u-comp":"sheets-filter-panel-values-virtual",className:"univer-flex-grow",children:m.jsx(N.Tree,{data:n,defaultExpandAll:!1,valueGroup:T(n),onChange:v=>{e.onFilterCheckToggled(v)},defaultCache:h,itemHeight:28,treeNodeClassName:`
                          univer-pr-2 univer-border-box univer-rounded-md
                          [&:hover_a]:univer-inline-block
                          hover:univer-bg-gray-50 univer-h-full
                          univer-text-gray-900 dark:hover:!univer-bg-gray-900
                          dark:!univer-text-white
                        `,attachRender:v=>m.jsxs("div",{className:"univer-ml-1 univer-flex univer-h-5 univer-flex-1 univer-cursor-pointer univer-items-center univer-justify-between univer-text-sm univer-text-primary-500",children:[m.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-count",className:"univer-text-gray-400 dark:!univer-text-gray-500",children:`(${v.count})`}),m.jsx("a",{className:"univer-box-border univer-hidden univer-h-4 univer-whitespace-nowrap univer-px-1.5",onClick:()=>{const C=[];v.children?v.children.forEach(E=>{E.children?E.children.forEach(b=>{C.push(b.key)}):C.push(E.key)}):C.push(v.key),e.onFilterOnly(C)},children:a})]})})})]})]})}function Dt(){const r=g.useDependency(c.SheetsFilterSyncController);if(!g.useObservable(r.visible$,void 0,!0))return null;const t=g.useDependency(u.LocaleService),s=g.useDependency(g.IMessageService),n=g.useObservable(r.enabled$,void 0,!0);return m.jsxs("div",{className:"univer-mt-2 univer-flex univer-items-center univer-justify-between univer-text-sm univer-text-gray-900 dark:!univer-text-gray-200",children:[m.jsxs("div",{className:"univer-flex univer-items-center univer-gap-1",children:[m.jsx("span",{children:t.t("sheets-filter.sync.title")}),m.jsx(N.Tooltip,{title:n?t.t("sheets-filter.sync.statusTips.off"):t.t("sheets-filter.sync.statusTips.on"),asChild:!0,children:m.jsx(et,{className:"univer-block"})})]}),m.jsx(N.Switch,{defaultChecked:n,onChange:a=>{const i=a?t.t("sheets-filter.sync.switchTips.on"):t.t("sheets-filter.sync.switchTips.off");r.setEnabled(a),s.show({content:i,type:N.MessageType.Success,duration:2e3})}})]})}function Ht(){var b;const r=g.useDependency(q),e=g.useDependency(u.LocaleService),t=g.useDependency(u.ICommandService),s=g.useObservable(r.filterBy$,void 0,!0),n=g.useObservable(r.filterByModel$,void 0,!1),a=g.useObservable(()=>(n==null?void 0:n.canApply$)||S.of(!1),void 0,!1,[n]),i=Wt(e),o=!g.useObservable(r.hasCriteria$),l=O.useCallback(R=>{t.executeCommand($e.id,{filterBy:R})},[t]),h=O.useCallback(async()=>{await(n==null?void 0:n.clear()),t.executeCommand(re.id)},[n,t]),d=O.useCallback(()=>{t.executeCommand(re.id)},[t]),p=O.useCallback(async()=>{await(n==null?void 0:n.apply()),t.executeCommand(re.id)},[n,t]),v=(b=g.useDependency(c.SheetsFilterService).activeFilterModel)==null?void 0:b.getRange(),C=r.col,E=g.useComponentsOfPart($.SheetsUIPart.FILTER_PANEL_EMBED_POINT);return m.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:"univer-box-border univer-flex univer-max-h-[500px] univer-w-[400px] univer-flex-col univer-rounded-lg univer-bg-white univer-p-4 univer-shadow-lg dark:!univer-border-gray-600 dark:!univer-bg-gray-700",children:[m.jsx(g.ComponentContainer,{components:E,sharedProps:{range:v,colIndex:C,onClose:d}}),m.jsx("div",{className:"univer-mb-1 univer-flex-shrink-0 univer-flex-grow-0",children:m.jsx(N.Segmented,{value:s,items:i,onChange:R=>l(R)})}),n?m.jsx("div",{"data-u-comp":"sheets-filter-panel-content",className:"univer-flex-shrink univer-flex-grow univer-pt-2",children:s===c.FilterBy.VALUES?m.jsx(Bt,{model:n}):s===c.FilterBy.COLORS?m.jsx(Mt,{model:n}):m.jsx(Ut,{model:n})}):m.jsx("div",{className:"univer-flex-1"}),m.jsx(Dt,{}),m.jsxs("div",{"data-u-comp":"sheets-filter-panel-footer",className:"univer-mt-4 univer-inline-flex univer-flex-shrink-0 univer-flex-grow-0 univer-flex-nowrap univer-justify-between univer-overflow-hidden",children:[m.jsx(N.Button,{variant:"link",onClick:h,disabled:o,children:e.t("sheets-filter.panel.clear-filter")}),m.jsxs("span",{className:"univer-flex univer-gap-2",children:[m.jsx(N.Button,{variant:"default",onClick:d,children:e.t("sheets-filter.panel.cancel")}),m.jsx(N.Button,{disabled:!a,variant:"primary",onClick:p,children:e.t("sheets-filter.panel.confirm")})]})]})]})}function Wt(r){const e=r.getCurrentLocale();return O.useMemo(()=>[{label:r.t("sheets-filter.panel.by-values"),value:c.FilterBy.VALUES},{label:r.t("sheets-filter.panel.by-colors"),value:c.FilterBy.COLORS},{label:r.t("sheets-filter.panel.by-conditions"),value:c.FilterBy.CONDITIONS}],[e,r])}function Vt(r){const e=r.get(c.SheetsFilterService);return{id:c.SmartToggleSheetsFilterCommand.id,type:g.MenuItemType.BUTTON_SELECTOR,icon:"FilterIcon",tooltip:"sheets-filter.toolbar.smart-toggle-filter-tooltip",hidden$:g.getMenuHiddenObservable(r,u.UniverInstanceType.UNIVER_SHEET),activated$:e.activeFilterModel$.pipe(S.map(t=>!!t)),disabled$:$.getObservableWithExclusiveRange$(r,$.getCurrentRangeDisable$(r,{worksheetTypes:[y.WorksheetFilterPermission,y.WorksheetViewPermission],rangeTypes:[y.RangeProtectionPermissionViewPoint]}))}}function Qt(r){const e=r.get(c.SheetsFilterService);return{id:c.ClearSheetsFilterCriteriaCommand.id,type:g.MenuItemType.BUTTON,title:"sheets-filter.toolbar.clear-filter-criteria",hidden$:g.getMenuHiddenObservable(r,u.UniverInstanceType.UNIVER_SHEET),disabled$:e.activeFilterModel$.pipe(S.switchMap(t=>{var s;return(s=t==null?void 0:t.hasCriteria$.pipe(S.map(n=>!n)))!=null?s:S.of(!0)}))}}function Gt(r){const e=r.get(c.SheetsFilterService);return{id:c.ReCalcSheetsFilterCommand.id,type:g.MenuItemType.BUTTON,title:"sheets-filter.toolbar.re-calc-filter-conditions",hidden$:g.getMenuHiddenObservable(r,u.UniverInstanceType.UNIVER_SHEET),disabled$:e.activeFilterModel$.pipe(S.switchMap(t=>{var s;return(s=t==null?void 0:t.hasCriteria$.pipe(S.map(n=>!n)))!=null?s:S.of(!0)}))}}const Yt={[g.RibbonDataGroup.ORGANIZATION]:{[c.SmartToggleSheetsFilterCommand.id]:{order:2,menuItemFactory:Vt,[c.ClearSheetsFilterCriteriaCommand.id]:{order:0,menuItemFactory:Qt},[c.ReCalcSheetsFilterCommand.id]:{order:1,menuItemFactory:Gt}}}},qt={id:c.SmartToggleSheetsFilterCommand.id,binding:g.KeyCode.L|g.MetaKeys.CTRL_COMMAND|g.MetaKeys.SHIFT,description:"sheets-filter.shortcut.smart-toggle-filter",preconditions:$.whenSheetEditorFocused,group:"4_sheet-edit"};var Zt=Object.getOwnPropertyDescriptor,Kt=(r,e,t,s)=>{for(var n=s>1?void 0:s?Zt(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},U=(r,e)=>(t,s)=>e(t,s,r);const We="FILTER_PANEL_POPUP";let Se=class extends he{constructor(e,t,s,n,a,i,o,l,h,d,p,T,v){super(v,T);_(this,"_popupDisposable");this._injector=e,this._componentManager=t,this._sheetsFilterPanelService=s,this._sheetCanvasPopupService=n,this._sheetsFilterService=a,this._localeService=i,this._shortcutService=o,this._commandService=l,this._menuManagerService=h,this._contextService=d,this._messageService=p,this._initCommands(),this._initShortcuts(),this._initMenuItems(),this._initUI()}dispose(){super.dispose(),this._closeFilterPopup()}_initShortcuts(){[qt].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_initCommands(){[c.SmartToggleSheetsFilterCommand,c.RemoveSheetFilterCommand,c.SetSheetFilterRangeCommand,c.SetSheetsFilterCriteriaCommand,c.ClearSheetsFilterCriteriaCommand,c.ReCalcSheetsFilterCommand,$e,ue,re].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))})}_initMenuItems(){this._menuManagerService.mergeMenu(Yt)}_initUI(){[[We,Ht],["FilterIcon",Je]].forEach(([e,t])=>{this.disposeWithMe(this._componentManager.register(e,t))}),this.disposeWithMe(this._contextService.subscribeContextValue$(ie).pipe(S.distinctUntilChanged()).subscribe(e=>{e?this._openFilterPopup():this._closeFilterPopup()})),this.disposeWithMe(this._sheetsFilterService.errorMsg$.subscribe(e=>{e&&this._messageService.show({type:N.MessageType.Error,content:this._localeService.t(e)})}))}_openFilterPopup(){const e=this._sheetsFilterPanelService.filterModel;if(!e)throw new Error("[SheetsFilterUIController]: no filter model when opening filter popup!");const t=e.getRange(),s=this._sheetsFilterPanelService.col,{startRow:n}=t;this._popupDisposable=this._sheetCanvasPopupService.attachPopupToCell(n,s,{componentKey:We,direction:"horizontal",onClickOutside:()=>this._commandService.syncExecuteCommand(re.id),offset:[5,0]})}_closeFilterPopup(){var e;(e=this._popupDisposable)==null||e.dispose(),this._popupDisposable=null}};Se=Kt([U(0,u.Inject(u.Injector)),U(1,u.Inject(g.ComponentManager)),U(2,u.Inject(q)),U(3,u.Inject($.SheetCanvasPopManagerService)),U(4,u.Inject(c.SheetsFilterService)),U(5,u.Inject(u.LocaleService)),U(6,g.IShortcutService),U(7,u.ICommandService),U(8,g.IMenuManagerService),U(9,u.IContextService),U(10,g.IMessageService),U(11,u.Inject($.SheetsRenderService)),U(12,z.IRenderManagerService)],Se);var Xt=Object.defineProperty,zt=Object.getOwnPropertyDescriptor,Jt=(r,e,t)=>e in r?Xt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,er=(r,e,t,s)=>{for(var n=s>1?void 0:s?zt(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},ye=(r,e)=>(t,s)=>e(t,s,r),rt=(r,e,t)=>Jt(r,typeof e!="symbol"?e+"":e,t);const tr="SHEET_FILTER_UI_PLUGIN";exports.UniverSheetsFilterUIPlugin=class extends u.Plugin{constructor(e=Ce,t,s,n){super(),this._config=e,this._injector=t,this._configService=s,this._rpcChannelService=n;const{menu:a,...i}=u.merge({},Ce,this._config);a&&this._configService.setConfig("menu",a,{merge:!0}),this._configService.setConfig(qe,i)}onStarting(){u.registerDependencies(this._injector,[[q],[se],[Se]]),this._config.useRemoteFilterValuesGenerator&&this._rpcChannelService&&this._injector.add([fe,{useFactory:()=>Fe.toModule(this._rpcChannelService.requestChannel(Le))}])}onReady(){u.touchDependencies(this._injector,[[se]])}onRendered(){u.touchDependencies(this._injector,[[Se]])}};rt(exports.UniverSheetsFilterUIPlugin,"type",u.UniverInstanceType.UNIVER_SHEET);rt(exports.UniverSheetsFilterUIPlugin,"pluginName",tr);exports.UniverSheetsFilterUIPlugin=er([u.DependentOn(c.UniverSheetsFilterPlugin),ye(1,u.Inject(u.Injector)),ye(2,u.IConfigService),ye(3,u.Optional(Fe.IRPCChannelService))],exports.UniverSheetsFilterUIPlugin);var rr=Object.getOwnPropertyDescriptor,ir=(r,e,t,s)=>{for(var n=s>1?void 0:s?rr(e,t):e,a=r.length-1,i;a>=0;a--)(i=r[a])&&(n=i(n)||n);return n},Ve=(r,e)=>(t,s)=>e(t,s,r),pe;exports.UniverSheetsFilterUIWorkerPlugin=(pe=class extends u.Plugin{constructor(e,t,s){super(),this._config=e,this._injector=t,this._rpcChannelService=s}onStarting(){[[fe,{useClass:Pe}]].forEach(e=>this._injector.add(e))}onReady(){this._rpcChannelService.registerChannel(Le,Fe.fromModule(this._injector.get(fe)))}},_(pe,"type",u.UniverInstanceType.UNIVER_SHEET),_(pe,"pluginName","SHEET_FILTER_UI_WORKER_PLUGIN"),pe);exports.UniverSheetsFilterUIWorkerPlugin=ir([Ve(1,u.Inject(u.Injector)),Ve(2,Fe.IRPCChannelService)],exports.UniverSheetsFilterUIWorkerPlugin);exports.ChangeFilterByOperation=$e;exports.CloseFilterPanelOperation=re;exports.OpenFilterPanelOperation=ue;
