"use strict";var C=Object.defineProperty;var b=(V,t,e)=>t in V?C(V,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):V[t]=e;var v=(V,t,e)=>b(V,typeof t!="symbol"?t+"":t,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("@univerjs/core"),s=require("@univerjs/sheets-data-validation"),f=require("@univerjs/sheets/facade"),I=require("@univerjs/data-validation"),T=require("@univerjs/engine-formula"),k=require("@univerjs/core/facade"),y=require("rxjs");class S{constructor(t){v(this,"_rule");this._rule=t!=null?t:{uid:r.generateRandomId(),ranges:void 0,type:r.DataValidationType.CUSTOM}}build(){return new p(this._rule)}copy(){return new S({...this._rule,uid:r.generateRandomId()})}getAllowInvalid(){return this._rule.errorStyle!==r.DataValidationErrorStyle.STOP}getCriteriaType(){return this._rule.type}getCriteriaValues(){return[this._rule.operator,this._rule.formula1,this._rule.formula2]}getHelpText(){return this._rule.error}requireCheckbox(t,e){return this._rule.type=r.DataValidationType.CHECKBOX,this._rule.formula1=t,this._rule.formula2=e,this}requireDateAfter(t){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.operator=r.DataValidationOperator.GREATER_THAN,this}requireDateBefore(t){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.LESS_THAN,this}requireDateBetween(t,e){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=e.toLocaleDateString(),this._rule.operator=r.DataValidationOperator.BETWEEN,this}requireDateEqualTo(t){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.EQUAL,this}requireDateNotBetween(t,e){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=e.toLocaleDateString(),this._rule.operator=r.DataValidationOperator.NOT_BETWEEN,this}requireDateOnOrAfter(t){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.GREATER_THAN_OR_EQUAL,this}requireDateOnOrBefore(t){return this._rule.type=r.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.LESS_THAN_OR_EQUAL,this}requireFormulaSatisfied(t){return this._rule.type=r.DataValidationType.CUSTOM,this._rule.formula1=t,this._rule.formula2=void 0,this}requireNumberBetween(t,e,i){return this._rule.formula1=`${t}`,this._rule.formula2=`${e}`,this._rule.operator=r.DataValidationOperator.BETWEEN,this._rule.type=i?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.EQUAL,this._rule.type=e?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberGreaterThan(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.GREATER_THAN,this._rule.type=e?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberGreaterThanOrEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.GREATER_THAN_OR_EQUAL,this._rule.type=e?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberLessThan(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.LESS_THAN,this._rule.type=e?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberLessThanOrEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.LESS_THAN_OR_EQUAL,this._rule.type=e?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberNotBetween(t,e,i){return this._rule.formula1=`${t}`,this._rule.formula2=`${e}`,this._rule.operator=r.DataValidationOperator.NOT_BETWEEN,this._rule.type=i?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireNumberNotEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=r.DataValidationOperator.NOT_EQUAL,this._rule.type=e?r.DataValidationType.WHOLE:r.DataValidationType.DECIMAL,this}requireValueInList(t,e,i){return this._rule.type=e?r.DataValidationType.LIST_MULTIPLE:r.DataValidationType.LIST,this._rule.formula1=t.join(","),this._rule.formula2=void 0,this._rule.showDropDown=i!=null?i:!0,this}requireValueInRange(t,e,i){return this._rule.type=e?r.DataValidationType.LIST_MULTIPLE:r.DataValidationType.LIST,this._rule.formula1=`=${T.serializeRangeToRefString({unitId:t.getUnitId(),sheetName:t.getSheetName(),range:t.getRange()})}`,this._rule.formula2=void 0,this._rule.showDropDown=i!=null?i:!0,this}setAllowInvalid(t){return this._rule.errorStyle=t?r.DataValidationErrorStyle.WARNING:r.DataValidationErrorStyle.STOP,this}setAllowBlank(t){return this._rule.allowBlank=t,this}setOptions(t){return Object.assign(this._rule,t),this}}class p{constructor(t,e,i){v(this,"rule");v(this,"_worksheet");v(this,"_injector");this._injector=i,this.rule=t,this._worksheet=e}getAllowInvalid(){return this.rule.errorStyle!==r.DataValidationErrorStyle.STOP}getCriteriaType(){return this.rule.type}getCriteriaValues(){return[this.rule.operator,this.rule.formula1,this.rule.formula2]}getHelpText(){return this.rule.error}copy(){return new S(this.rule)}getApplied(){if(!this._worksheet)return!1;const e=this._injector.get(I.DataValidationModel).getRuleById(this._worksheet.getUnitId(),this._worksheet.getSheetId(),this.rule.uid);return!!(e&&e.ranges.length)}getRanges(){if(!this.getApplied())return[];const t=this._injector.get(r.IUniverInstanceService).getUnit(this._worksheet.getUnitId());return this.rule.ranges.map(e=>this._injector.createInstance(f.FRange,t,this._worksheet,e))}getUnitId(){var t;return(t=this._worksheet)==null?void 0:t.getUnitId()}getSheetId(){var t;return(t=this._worksheet)==null?void 0:t.getSheetId()}setCriteria(t,e,i=!0){if(this.getApplied()&&!this._injector.get(r.ICommandService).syncExecuteCommand(s.UpdateSheetDataValidationSettingCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,setting:{operator:e[0],formula1:e[1],formula2:e[2],type:this.rule.type,allowBlank:i}}))throw new Error("setCriteria failed");return this.rule.operator=e[0],this.rule.formula1=e[1],this.rule.formula2=e[2],this.rule.type=t,this.rule.allowBlank=i,this}setOptions(t){if(this.getApplied()&&!this._injector.get(r.ICommandService).syncExecuteCommand(s.UpdateSheetDataValidationOptionsCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,options:{...I.getRuleOptions(this.rule),...t}}))throw new Error("setOptions failed");return Object.assign(this.rule,t),this}setRanges(t){if(this.getApplied()&&!this._injector.get(r.ICommandService).syncExecuteCommand(s.UpdateSheetDataValidationRangeCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,ranges:t.map(a=>a.getRange())}))throw new Error("setRanges failed");return this.rule.ranges=t.map(e=>e.getRange()),this}delete(){return this.getApplied()?this._injector.get(r.ICommandService).syncExecuteCommand(s.RemoveSheetDataValidationCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid}):!1}}class U extends f.FRange{setDataValidation(t){if(!t)return this._commandService.syncExecuteCommand(s.ClearRangeDataValidationCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),ranges:[this._range]}),this;const e={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),rule:{...t.rule,ranges:[this._range]}};return this._commandService.syncExecuteCommand(s.AddSheetDataValidationCommand.id,e),this}getDataValidation(){const e=this._injector.get(s.SheetsDataValidationValidatorService).getDataValidation(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]);return e&&new p(e,this._worksheet,this._injector)}getDataValidations(){return this._injector.get(s.SheetsDataValidationValidatorService).getDataValidations(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]).map(e=>new p(e,this._worksheet,this._injector))}async getValidatorStatus(){return this._injector.get(s.SheetsDataValidationValidatorService).validatorRanges(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range])}async getDataValidationErrorAsync(){const t=this._workbook.getUnitId(),e=this._worksheet.getSheetId();return this._collectValidationErrorsForRange(t,e,[this._range])}async _collectValidationErrorsForRange(t,e,i){if(!i.length)return[];const a=this._injector.get(s.SheetsDataValidationValidatorService),o=this._worksheet,u=o.getName(),l=[];for(const n of i){const h=[];for(let c=n.startRow;c<=n.endRow;c++)for(let d=n.startColumn;d<=n.endColumn;d++)h.push((async()=>{var g;try{if(await a.validatorCell(t,e,c,d)!==r.DataValidationStatus.VALID){const D=this._injector.get(s.SheetDataValidationModel).getRuleByLocation(t,e,c,d);if(D){const E=((g=o.getCell(c,d))==null?void 0:g.v)||null,w=this._createDataValidationError(u,c,d,D,E);l.push(w)}}}catch(m){console.warn(`Failed to validate cell [${c}, ${d}]:`,m)}})());await Promise.all(h)}return l}_createDataValidationError(t,e,i,a,o){return{sheetName:t,row:e,column:i,ruleId:a.uid,inputValue:o,rule:a}}}f.FRange.extend(U);class A extends k.FUniver{static newDataValidation(){return new S}newDataValidation(){return new S}_initialize(t){const e=t.get(r.ICommandService);this.registerEventHandler(this.Event.SheetDataValidationChanged,()=>t.has(s.SheetDataValidationModel)?t.get(s.SheetDataValidationModel).ruleChange$.subscribe(a=>{const{unitId:o,subUnitId:u,rule:l,oldRule:n,type:h}=a,c=this.getSheetTarget(o,u);if(!c)return;const{workbook:d,worksheet:g}=c,m=new p(l,g.getSheet(),this._injector);this.fireEvent(this.Event.SheetDataValidationChanged,{origin:a,worksheet:g,workbook:d,changeType:h,oldRule:n,rule:m})}):{dispose:()=>{}}),this.registerEventHandler(this.Event.SheetDataValidatorStatusChanged,()=>t.has(s.SheetDataValidationModel)?t.get(s.SheetDataValidationModel).validStatusChange$.subscribe(a=>{const{unitId:o,subUnitId:u,ruleId:l,status:n,row:h,col:c}=a,d=this.getSheetTarget(o,u);if(!d)return;const{workbook:g,worksheet:m}=d,_=m.getDataValidation(l);_&&this.fireEvent(this.Event.SheetDataValidatorStatusChanged,{workbook:g,worksheet:m,row:h,column:c,rule:_,status:n})}):{dispose:()=>{}}),this.registerEventHandler(this.Event.BeforeSheetDataValidationAdd,()=>e.beforeCommandExecuted(i=>{if(i.id===s.AddSheetDataValidationCommand.id){const a=i.params,o=this.getSheetTarget(a.unitId,a.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,n={worksheet:l,workbook:u,rule:a.rule};if(this.fireEvent(this.Event.BeforeSheetDataValidationAdd,n),n.cancel)throw new r.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationCriteriaUpdate,()=>e.beforeCommandExecuted(i=>{if(i.id===s.UpdateSheetDataValidationSettingCommand.id){const a=i.params,o=this.getSheetTarget(a.unitId,a.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,n=l.getDataValidation(a.ruleId);if(!n)return;const h={worksheet:l,workbook:u,rule:n,ruleId:a.ruleId,newCriteria:a.setting};if(this.fireEvent(this.Event.BeforeSheetDataValidationCriteriaUpdate,h),h.cancel)throw new r.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationRangeUpdate,()=>e.beforeCommandExecuted(i=>{if(i.id===s.UpdateSheetDataValidationRangeCommand.id){const a=i.params,o=this.getSheetTarget(a.unitId,a.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,n=l.getDataValidation(a.ruleId);if(!n)return;const h={worksheet:l,workbook:u,rule:n,ruleId:a.ruleId,newRanges:a.ranges};if(this.fireEvent(this.Event.BeforeSheetDataValidationRangeUpdate,h),h.cancel)throw new r.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationOptionsUpdate,()=>e.beforeCommandExecuted(i=>{if(i.id===s.UpdateSheetDataValidationOptionsCommand.id){const a=i.params,o=this.getSheetTarget(a.unitId,a.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,n=l.getDataValidation(a.ruleId);if(!n)return;const h={worksheet:l,workbook:u,rule:n,ruleId:a.ruleId,newOptions:a.options};if(this.fireEvent(this.Event.BeforeSheetDataValidationOptionsUpdate,h),h.cancel)throw new r.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationDelete,()=>e.beforeCommandExecuted(i=>{if(i.id===s.RemoveSheetDataValidationCommand.id){const a=i.params,o=this.getSheetTarget(a.unitId,a.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,n=l.getDataValidation(a.ruleId);if(!n)return;const h={worksheet:l,workbook:u,rule:n,ruleId:a.ruleId};if(this.fireEvent(this.Event.BeforeSheetDataValidationDelete,h),h.cancel)throw new r.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationDeleteAll,()=>e.beforeCommandExecuted(i=>{if(i.id===s.RemoveSheetAllDataValidationCommand.id){const a=i.params,o=this.getSheetTarget(a.unitId,a.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,n={worksheet:l,workbook:u,rules:l.getDataValidations()};if(this.fireEvent(this.Event.BeforeSheetDataValidationDeleteAll,n),n.cancel)throw new r.CanceledError}}))}}k.FUniver.extend(A);class R extends f.FWorkbook{_initialize(){Object.defineProperty(this,"_dataValidationModel",{get(){return this._injector.get(s.SheetDataValidationModel)}})}getValidatorStatus(){return this._injector.get(s.SheetsDataValidationValidatorService).validatorWorkbook(this._workbook.getUnitId())}async getAllDataValidationErrorAsync(){const t=this._workbook.getUnitId(),e=this._dataValidationModel.getSubUnitIds(t),i=[];for(const a of e){const o=await this._collectValidationErrorsForSheet(t,a);i.push(...o)}return i}async _collectValidationErrorsForSheet(t,e){const i=this._dataValidationModel.getRules(t,e);if(!i.length)return[];const a=i.flatMap(o=>o.ranges);return this._collectValidationErrorsForRange(t,e,a)}async _collectValidationErrorsForRange(t,e,i){if(!i.length)return[];const a=this._injector.get(s.SheetsDataValidationValidatorService),u=this._workbook.getSheetBySheetId(e);if(!u)throw new Error(`Cannot find worksheet with sheetId: ${e}`);const l=u.getName(),n=[];for(const h of i){const c=[];for(let d=h.startRow;d<=h.endRow;d++)for(let g=h.startColumn;g<=h.endColumn;g++)c.push((async()=>{var m;try{if(await a.validatorCell(t,e,d,g)!==r.DataValidationStatus.VALID){const D=this._dataValidationModel.getRuleByLocation(t,e,d,g);if(D){const E=((m=u.getCell(d,g))==null?void 0:m.v)||null,w=this._createDataValidationError(l,d,g,D,E);n.push(w)}}}catch(_){console.warn(`Failed to validate cell [${d}, ${g}]:`,_)}})());await Promise.all(c)}return n}_createDataValidationError(t,e,i,a,o){return{sheetName:t,row:e,column:i,ruleId:a.uid,inputValue:o,rule:a}}onDataValidationChange(t){return r.toDisposable(this._dataValidationModel.ruleChange$.pipe(y.filter(e=>e.unitId===this._workbook.getUnitId())).subscribe(t))}onDataValidationStatusChange(t){return r.toDisposable(this._dataValidationModel.validStatusChange$.pipe(y.filter(e=>e.unitId===this._workbook.getUnitId())).subscribe(t))}onBeforeAddDataValidation(t){return r.toDisposable(this._commandService.beforeCommandExecuted((e,i)=>{const a=e.params;if(e.id===s.AddSheetDataValidationCommand.id){if(a.unitId!==this._workbook.getUnitId())return;if(t(a,i)===!1)throw new Error("Command is stopped by the hook onBeforeAddDataValidation")}}))}onBeforeUpdateDataValidationCriteria(t){return r.toDisposable(this._commandService.beforeCommandExecuted((e,i)=>{const a=e.params;if(e.id===s.UpdateSheetDataValidationSettingCommand.id){if(a.unitId!==this._workbook.getUnitId())return;if(t(a,i)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationCriteria")}}))}onBeforeUpdateDataValidationRange(t){return r.toDisposable(this._commandService.beforeCommandExecuted((e,i)=>{const a=e.params;if(e.id===s.UpdateSheetDataValidationRangeCommand.id){if(a.unitId!==this._workbook.getUnitId())return;if(t(a,i)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationRange")}}))}onBeforeUpdateDataValidationOptions(t){return r.toDisposable(this._commandService.beforeCommandExecuted((e,i)=>{const a=e.params;if(e.id===s.UpdateSheetDataValidationOptionsCommand.id){if(a.unitId!==this._workbook.getUnitId())return;if(t(a,i)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationOptions")}}))}onBeforeDeleteDataValidation(t){return r.toDisposable(this._commandService.beforeCommandExecuted((e,i)=>{const a=e.params;if(e.id===s.RemoveSheetDataValidationCommand.id){if(a.unitId!==this._workbook.getUnitId())return;if(t(a,i)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteDataValidation")}}))}onBeforeDeleteAllDataValidation(t){return r.toDisposable(this._commandService.beforeCommandExecuted((e,i)=>{const a=e.params;if(e.id===s.RemoveSheetAllDataValidationCommand.id){if(a.unitId!==this._workbook.getUnitId())return;if(t(a,i)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteAllDataValidation")}}))}}f.FWorkbook.extend(R);class O extends f.FWorksheet{getDataValidations(){return this._injector.get(I.DataValidationModel).getRules(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>new p(e,this._worksheet,this._injector))}getValidatorStatus(){return this._injector.get(s.SheetsDataValidationValidatorService).validatorWorksheet(this._workbook.getUnitId(),this._worksheet.getSheetId())}getValidatorStatusAsync(){return this.getValidatorStatus()}getDataValidation(t){const i=this._injector.get(I.DataValidationModel).getRuleById(this._workbook.getUnitId(),this._worksheet.getSheetId(),t);return i?new p(i,this._worksheet,this._injector):null}async getAllDataValidationErrorAsync(){const t=this._workbook.getUnitId(),e=this._worksheet.getSheetId();return this._collectValidationErrorsForSheet(t,e)}async _collectValidationErrorsForSheet(t,e){const a=this._injector.get(I.DataValidationModel).getRules(t,e);if(!a.length)return[];const o=a.flatMap(u=>u.ranges);return this._collectValidationErrorsForRange(t,e,o)}async _collectValidationErrorsForRange(t,e,i){if(!i.length)return[];const a=this._injector.get(s.SheetsDataValidationValidatorService),o=this._worksheet,u=o.getName(),l=[];for(const n of i){const h=[];for(let c=n.startRow;c<=n.endRow;c++)for(let d=n.startColumn;d<=n.endColumn;d++)h.push((async()=>{var g;try{if(await a.validatorCell(t,e,c,d)!==r.DataValidationStatus.VALID){const D=this._injector.get(s.SheetDataValidationModel).getRuleByLocation(t,e,c,d);if(D){const E=((g=o.getCell(c,d))==null?void 0:g.v)||null,w=this._createDataValidationError(u,c,d,D,E);l.push(w)}}}catch(m){console.warn(`Failed to validate cell [${c}, ${d}]:`,m)}})());await Promise.all(h)}return l}_createDataValidationError(t,e,i,a,o){return{sheetName:t,row:e,column:i,ruleId:a.uid,inputValue:o,rule:a}}}f.FWorksheet.extend(O);class B{get SheetDataValidationChanged(){return"SheetDataValidationChanged"}get SheetDataValidatorStatusChanged(){return"SheetDataValidatorStatusChanged"}get BeforeSheetDataValidationAdd(){return"BeforeSheetDataValidationAdd"}get BeforeSheetDataValidationDelete(){return"BeforeSheetDataValidationDelete"}get BeforeSheetDataValidationDeleteAll(){return"BeforeSheetDataValidationDeleteAll"}get BeforeSheetDataValidationCriteriaUpdate(){return"BeforeSheetDataValidationCriteriaUpdate"}get BeforeSheetDataValidationRangeUpdate(){return"BeforeSheetDataValidationRangeUpdate"}get BeforeSheetDataValidationOptionsUpdate(){return"BeforeSheetDataValidationOptionsUpdate"}}k.FEventName.extend(B);exports.FDataValidation=p;exports.FDataValidationBuilder=S;
