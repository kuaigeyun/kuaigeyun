"use strict";var U=Object.defineProperty;var p=(i,e,t)=>e in i?U(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var _=(i,e,t)=>p(i,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("@univerjs/core"),h=require("@univerjs/drawing");class d extends h.UnitDrawingService{}const v=o.createIdentifier("univer.doc.plugin.doc-drawing.service");var f=Object.getOwnPropertyDescriptor,I=(i,e,t,r)=>{for(var n=r>1?void 0:r?f(e,t):e,a=i.length-1,s;a>=0;a--)(s=i[a])&&(n=s(n)||n);return n},g=(i,e)=>(t,r)=>e(t,r,i);const l="DOC_DRAWING_PLUGIN";exports.DocDrawingController=class extends o.Disposable{constructor(e,t,r,n){super(),this._docDrawingService=e,this._drawingManagerService=t,this._resourceManagerService=r,this._univerInstanceService=n,this._init()}_init(){this._initSnapshot()}_initSnapshot(){const e=r=>{const n=this._univerInstanceService.getUnit(r,o.UniverInstanceType.UNIVER_DOC);if(n){const a=n.getSnapshot().drawings,s=n.getSnapshot().drawingsOrder,c={data:a!=null?a:{},order:s!=null?s:[]};return JSON.stringify(c)}return""},t=r=>{if(!r)return{data:{},order:[]};try{return JSON.parse(r)}catch{return{data:{},order:[]}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:l,businesses:[o.UniverInstanceType.UNIVER_DOC],toJson:r=>e(r),parseJson:r=>t(r),onUnLoad:r=>{this._setDrawingDataForUnit(r,{data:{},order:[]})},onLoad:(r,n)=>{var a,s;this._setDrawingDataForUnit(r,{data:(a=n.data)!=null?a:{},order:(s=n.order)!=null?s:[]})}}))}_setDrawingDataForUnit(e,t){const r=this._univerInstanceService.getUnit(e);r!=null&&(r.resetDrawing(t.data,t.order),this.loadDrawingDataForUnit(e))}loadDrawingDataForUnit(e){const t=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_DOC);if(!t)return!1;const r=e,n=t.getDrawings(),a=t.getDrawingsOrder();if(!n||!a)return!1;Object.keys(n).forEach(c=>{const S=n[c];n[c]={...S}});const s={[r]:{unitId:e,subUnitId:r,data:n,order:a}};return this._docDrawingService.registerDrawingData(e,s),this._drawingManagerService.registerDrawingData(e,s),!0}};exports.DocDrawingController=I([g(0,v),g(1,h.IDrawingManagerService),g(2,o.IResourceManagerService),g(3,o.IUniverInstanceService)],exports.DocDrawingController);const C="docs-drawing.config",u={};var O=Object.getOwnPropertyDescriptor,P=(i,e,t,r)=>{for(var n=r>1?void 0:r?O(e,t):e,a=i.length-1,s;a>=0;a--)(s=i[a])&&(n=s(n)||n);return n},w=(i,e)=>(t,r)=>e(t,r,i),D;exports.UniverDocsDrawingPlugin=(D=class extends o.Plugin{constructor(e=u,t,r){super(),this._config=e,this._injector=t,this._configService=r;const{...n}=o.merge({},u,this._config);this._configService.setConfig(C,n)}onStarting(){[[exports.DocDrawingController],[d],[v,{useClass:d}]].forEach(e=>this._injector.add(e)),o.touchDependencies(this._injector,[[exports.DocDrawingController]])}},_(D,"pluginName",l),_(D,"type",o.UniverInstanceType.UNIVER_DOC),D);exports.UniverDocsDrawingPlugin=P([w(1,o.Inject(o.Injector)),w(2,o.IConfigService)],exports.UniverDocsDrawingPlugin);exports.DOCS_DRAWING_PLUGIN=l;exports.DocDrawingService=d;exports.IDocDrawingService=v;
