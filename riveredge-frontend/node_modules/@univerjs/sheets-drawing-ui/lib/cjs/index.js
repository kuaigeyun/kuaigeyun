"use strict";var Jt=Object.defineProperty;var Qt=(i,r,e)=>r in i?Jt(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e;var ne=(i,r,e)=>Qt(i,typeof r!="symbol"?r+"":r,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("@univerjs/engine-render"),E=require("@univerjs/sheets-ui"),l=require("@univerjs/core"),S=require("@univerjs/sheets-drawing"),C=require("@univerjs/sheets"),F=require("@univerjs/design"),Je=require("@univerjs/docs-ui"),j=require("@univerjs/drawing"),k=require("@univerjs/ui"),$t=require("@univerjs/docs-drawing"),he=require("@univerjs/drawing-ui"),O=require("rxjs"),B=require("react/jsx-runtime"),G=require("react");function Z(i,r,e){const{from:t,to:n,flipY:s=!1,flipX:o=!1,angle:a=0,skewX:d=0,skewY:g=0}=i,u=e.getCurrent();if(u==null)return;const c=E.convertPositionSheetOverGridToAbsolute(u.unitId,u.sheetId,{from:t,to:n},e);let{left:m,top:h,width:p,height:w}=c;const f=e.getCurrentSkeleton(),v=f.rowHeaderWidth+f.columnTotalWidth,_=f.columnHeaderHeight+f.rowTotalHeight;return m+p>v&&(m=v-p),h+w>_&&(h=_-w),{flipY:s,flipX:o,angle:a,skewX:d,skewY:g,left:m,top:h,width:p,height:w}}function Y(i,r){const{left:e=0,top:t=0,width:n=0,height:s=0,flipY:o=!1,flipX:a=!1,angle:d=0,skewX:g=0,skewY:u=0}=i,c=r.getCellWithCoordByOffset(e,t);if(c==null)return;const m={column:c.actualColumn,columnOffset:x.precisionTo(e-c.startX,1),row:c.actualRow,rowOffset:x.precisionTo(t-c.startY,1)},h=r.getCellWithCoordByOffset(e+n,t+s);if(h==null)return;const p={column:h.actualColumn,columnOffset:x.precisionTo(e+n-h.startX,1),row:h.actualRow,rowOffset:x.precisionTo(t+s-h.startY,1)};return{flipY:o,flipX:a,angle:d,skewX:g,skewY:u,from:m,to:p}}const X={id:"sheet.operation.clear-drawing-transformer",type:l.CommandType.MUTATION,handler:(i,r)=>{const e=i.get(x.IRenderManagerService);return r.forEach(t=>{var n,s;(s=(n=e.getRenderById(t))==null?void 0:n.scene.getTransformer())==null||s.debounceRefreshControls()}),!0}},Me={id:"sheet.command.remove-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{var _,y,T;const e=i.get(l.ICommandService),t=i.get(l.IUndoRedoService),n=i.get(C.SheetInterceptorService),s=i.get(S.ISheetDrawingService);if(!r)return!1;const{drawings:o}=r,a=[];o.forEach(D=>{const{unitId:M}=D;a.push(M)});const d=s.getBatchRemoveOp(o),{unitId:g,subUnitId:u,undo:c,redo:m,objects:h}=d,p=n.onCommandExecute({id:Me.id,params:r}),w={id:S.SetDrawingApplyMutation.id,params:{unitId:g,subUnitId:u,op:m,objects:h,type:S.DrawingApplyType.REMOVE}},f={id:S.SetDrawingApplyMutation.id,params:{unitId:g,subUnitId:u,op:c,objects:h,type:S.DrawingApplyType.INSERT}};return l.sequenceExecute([...(_=p.preRedos)!=null?_:[],w,...p.redos],e)?(t.pushUndoRedo({unitID:g,undoMutations:[...(y=p.preUndos)!=null?y:[],f,...p.undos,{id:X.id,params:a}],redoMutations:[...(T=p.preRedos)!=null?T:[],w,...p.redos,{id:X.id,params:a}]}),!0):!1}},_t={id:"sheet.command.delete-drawing",type:l.CommandType.COMMAND,handler:i=>{const r=i.get(l.ICommandService),t=i.get(S.ISheetDrawingService).getFocusDrawings();if(t.length===0)return!1;const n=t[0].unitId,s=t.map(o=>{const{unitId:a,subUnitId:d,drawingId:g,drawingType:u}=o;return{unitId:a,subUnitId:d,drawingId:g,drawingType:u}});return r.executeCommand(Me.id,{unitId:n,drawings:s})}};function en(i){const r=[];return i.forEach(e=>{const{parent:t,children:n}=e,{unitId:s,subUnitId:o,drawingId:a}=t,d=x.getGroupState(0,0,n.map(c=>c.transform||{})),g=n.map(c=>{const m=c.transform||{left:0,top:0},{unitId:h,subUnitId:p,drawingId:w}=c;return{unitId:h,subUnitId:p,drawingId:w,transform:{...m,left:m.left-d.left,top:m.top-d.top},groupId:a}}),u={unitId:s,subUnitId:o,drawingId:a,drawingType:l.DrawingTypeEnum.DRAWING_GROUP,transform:d};r.push({parent:u,children:g})}),r}function tn(i){const r=[];return i.forEach(e=>{const{parent:t,children:n}=e,{unitId:s,subUnitId:o,drawingId:a,transform:d={width:0,height:0}}=t;if(d==null)return;const g=n.map(c=>{const{transform:m}=c,{unitId:h,subUnitId:p,drawingId:w}=c,f=x.transformObjectOutOfGroup(m||{},d,d.width||0,d.height||0);return{unitId:h,subUnitId:p,drawingId:w,transform:f,groupId:void 0}}),u={unitId:s,subUnitId:o,drawingId:a,drawingType:l.DrawingTypeEnum.DRAWING_GROUP,transform:{left:0,top:0}};r.push({parent:u,children:g})}),r}const It={id:"sheet.command.group-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const e=i.get(l.ICommandService),t=i.get(l.IUndoRedoService),n=i.get(S.ISheetDrawingService);if(!r)return!1;const s=[];r.forEach(({parent:h,children:p})=>{s.push(h.unitId),p.forEach(w=>{s.push(w.unitId)})});const o=n.getGroupDrawingOp(r),{unitId:a,subUnitId:d,undo:g,redo:u,objects:c}=o;return e.syncExecuteCommand(S.SetDrawingApplyMutation.id,{op:u,unitId:a,subUnitId:d,objects:c,type:S.DrawingApplyType.GROUP})?(t.pushUndoRedo({unitID:a,undoMutations:[{id:S.SetDrawingApplyMutation.id,params:{op:g,unitId:a,subUnitId:d,objects:tn(c),type:S.DrawingApplyType.UNGROUP}},{id:X.id,params:s}],redoMutations:[{id:S.SetDrawingApplyMutation.id,params:{op:u,unitId:a,subUnitId:d,objects:c,type:S.DrawingApplyType.GROUP}},{id:X.id,params:s}]}),!0):!1}},Ne={id:"sheet.command.insert-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{var _,y,T;const e=i.get(l.ICommandService),t=i.get(l.IUndoRedoService),n=i.get(S.ISheetDrawingService),s=i.get(C.SheetInterceptorService);if(!r)return!1;const o=r.drawings,a=o.map(D=>D.unitId),d=n.getBatchAddOp(o),{unitId:g,subUnitId:u,undo:c,redo:m,objects:h}=d,p=s.onCommandExecute({id:Ne.id,params:r}),w={id:S.SetDrawingApplyMutation.id,params:{op:m,unitId:g,subUnitId:u,objects:h,type:S.DrawingApplyType.INSERT}},f={id:S.SetDrawingApplyMutation.id,params:{op:c,unitId:g,subUnitId:u,objects:h,type:S.DrawingApplyType.REMOVE}};return l.sequenceExecute([...(_=p.preRedos)!=null?_:[],w,...p.redos],e)?(t.pushUndoRedo({unitID:g,undoMutations:[...(y=p.preUndos)!=null?y:[],f,...p.undos,{id:X.id,params:a}],redoMutations:[...(T=p.preRedos)!=null?T:[],w,...p.redos,{id:X.id,params:a}]}),!0):!1}},Dt={id:"sheet.command.set-drawing-arrange",type:l.CommandType.COMMAND,handler:(i,r)=>{const e=i.get(l.ICommandService),t=i.get(l.IUndoRedoService);if(!r)return!1;const n=i.get(S.ISheetDrawingService),{unitId:s,subUnitId:o,drawingIds:a,arrangeType:d}=r,g={unitId:s,subUnitId:o,drawingIds:a};let u;if(d===l.ArrangeTypeEnum.forward?u=n.getForwardDrawingsOp(g):d===l.ArrangeTypeEnum.backward?u=n.getBackwardDrawingOp(g):d===l.ArrangeTypeEnum.front?u=n.getFrontDrawingsOp(g):d===l.ArrangeTypeEnum.back&&(u=n.getBackDrawingsOp(g)),u==null)return!1;const{objects:c,redo:m,undo:h}=u;return e.syncExecuteCommand(S.SetDrawingApplyMutation.id,{op:m,unitId:s,subUnitId:o,objects:c,type:S.DrawingApplyType.ARRANGE})?(t.pushUndoRedo({unitID:s,undoMutations:[{id:S.SetDrawingApplyMutation.id,params:{op:h,unitId:s,subUnitId:o,objects:c,type:S.DrawingApplyType.ARRANGE}}],redoMutations:[{id:S.SetDrawingApplyMutation.id,params:{op:m,unitId:s,subUnitId:o,objects:c,type:S.DrawingApplyType.ARRANGE}}]}),!0):!1}},je={id:"sheet.command.set-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const e=i.get(l.ICommandService),t=i.get(l.IUndoRedoService),n=i.get(S.ISheetDrawingService);if(!r)return!1;const{drawings:s}=r,o=n.getBatchUpdateOp(s),{unitId:a,subUnitId:d,undo:g,redo:u,objects:c}=o;return e.syncExecuteCommand(S.SetDrawingApplyMutation.id,{unitId:a,subUnitId:d,op:u,objects:c,type:S.DrawingApplyType.UPDATE})?(t.pushUndoRedo({unitID:a,undoMutations:[{id:S.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:d,op:g,objects:c,type:S.DrawingApplyType.UPDATE}},{id:X.id,params:[a]}],redoMutations:[{id:S.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:d,op:u,objects:c,type:S.DrawingApplyType.UPDATE}},{id:X.id,params:[a]}]}),!0):!1}},Ct={id:"sheet.command.ungroup-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const e=i.get(l.ICommandService),t=i.get(l.IUndoRedoService),n=i.get(S.ISheetDrawingService);if(!r)return!1;const s=[];r.forEach(({parent:h,children:p})=>{s.push(h.unitId),p.forEach(w=>{s.push(w.unitId)})});const o=n.getUngroupDrawingOp(r),{unitId:a,subUnitId:d,undo:g,redo:u,objects:c}=o;return e.syncExecuteCommand(S.SetDrawingApplyMutation.id,{op:u,unitId:a,subUnitId:d,objects:c,type:S.DrawingApplyType.UNGROUP})?(t.pushUndoRedo({unitID:a,undoMutations:[{id:S.SetDrawingApplyMutation.id,params:{op:g,unitId:a,subUnitId:d,objects:en(c),type:S.DrawingApplyType.GROUP}},{id:X.id,params:s}],redoMutations:[{id:S.SetDrawingApplyMutation.id,params:{op:u,unitId:a,subUnitId:d,objects:c,type:S.DrawingApplyType.UNGROUP}},{id:X.id,params:s}]}),!0):!1}};var nn=Object.getOwnPropertyDescriptor,rn=(i,r,e,t)=>{for(var n=t>1?void 0:t?nn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},re=(i,r)=>(e,t)=>r(e,t,i);function sn(i,r,e){const t=e*Math.PI/180,n=Math.abs(i*Math.cos(t))+Math.abs(r*Math.sin(t)),s=Math.abs(i*Math.sin(t))+Math.abs(r*Math.cos(t));return{rotatedWidth:n,rotatedHeight:s}}function pt(i,r,e,t,n){var _;const{rotatedHeight:s,rotatedWidth:o}=sn(e,t,n),d=i.get(x.IRenderManagerService).getRenderById(r.unitId);if(!d)return!1;const u=(_=d.with(E.SheetSkeletonManagerService).getSkeletonParam(r.subUnitId))==null?void 0:_.skeleton;if(u==null)return!1;const c=u.getCellByIndex(r.row,r.col),m=c.mergeInfo.endX-c.mergeInfo.startX-2,h=c.mergeInfo.endY-c.mergeInfo.startY-2,p=o/s,f=Math.ceil(Math.min(m,h*p))/o,v=!f||Number.isNaN(f)?.001:f;return{width:e*v,height:t*v}}exports.SheetDrawingUpdateController=class extends l.Disposable{constructor(e,t,n,s,o,a,d,g,u,c,m,h,p){super();ne(this,"_workbookSelections");this._context=e,this._skeletonManagerService=t,this._commandService=n,this._selectionRenderService=s,this._imageIoService=o,this._fileOpenerService=a,this._sheetDrawingService=d,this._drawingManagerService=g,this._contextService=u,this._messageService=c,this._localeService=m,this._injector=p,this._workbookSelections=h.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){const e=await this._fileOpenerService.openFile({multiple:!0,accept:j.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(n=>`.${n.replace("image/","")}`).join(",")}),t=e.length;return t>j.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(j.DRAWING_IMAGE_COUNT_LIMIT))}),!1):t===0?!1:(e.forEach(async n=>await this.insertFloatImageByFile(n)),!0)}async insertCellImage(){const t=(await this._fileOpenerService.openFile({multiple:!1,accept:j.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(n=>`.${n.replace("image/","")}`).join(",")}))[0];return t?(await this._insertCellImage(t),!0):!1}insertCellImageByFile(e,t){return this._insertCellImage(e,t)}async insertFloatImageByFile(e){let t;try{t=await this._imageIoService.saveImage(e)}catch(y){const T=y.message;T===j.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(j.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):T===j.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):T===j.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(t==null)return;const n=this._getUnitInfo(),{unitId:s,subUnitId:o}=n,{imageId:a,imageSourceType:d,source:g,base64Cache:u}=t,{width:c,height:m,image:h}=await j.getImageSize(u||""),{width:p,height:w}=this._context.scene;this._imageIoService.addImageSourceCache(g,d,h);let f=1;if(c>j.DRAWING_IMAGE_WIDTH_LIMIT||m>j.DRAWING_IMAGE_HEIGHT_LIMIT){const y=j.DRAWING_IMAGE_WIDTH_LIMIT/c,T=j.DRAWING_IMAGE_HEIGHT_LIMIT/m;f=Math.max(y,T)}const v=this._getImagePosition(c*f,m*f,p,w);if(v==null)return;const _={unitId:s,subUnitId:o,drawingId:a,drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:d,source:g,transform:Z(v,this._selectionRenderService,this._skeletonManagerService),sheetTransform:v};return this._commandService.executeCommand(Ne.id,{unitId:s,drawings:[_]})}async _insertCellImage(e,t){var T,D;let n;try{n=await this._imageIoService.saveImage(e)}catch(M){const I=M.message;I===j.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(j.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):I===j.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):I===j.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:F.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(n==null)return!1;const{imageId:s,imageSourceType:o,source:a,base64Cache:d}=n,{width:g,height:u,image:c}=await j.getImageSize(d||"");this._imageIoService.addImageSourceCache(a,o,c);const m=this._workbookSelections.getCurrentLastSelection();if(!m)return!1;let h=m.primary.actualRow,p=m.primary.actualColumn;m.primary.isMerged&&(h=m.primary.startRow,p=m.primary.startColumn);const w=l.createDocumentModelWithStyle("",{}),f=pt(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:h,col:p},g,u,0);if(!f)return!1;const v={size:{width:f.width,height:f.height},positionH:{relativeFrom:l.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:l.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0},_={unitId:w.getUnitId(),subUnitId:w.getUnitId(),drawingId:s,drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:o,source:a,transform:Je.docDrawingPositionToTransform(v),docTransform:v,behindDoc:l.BooleanNumber.FALSE,title:"",description:"",layoutType:l.PositionedObjectLayoutType.INLINE,wrapText:l.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},y=l.BuildTextUtils.drawing.add({documentDataModel:w,drawings:[_],selection:{collapsed:!0,startOffset:0,endOffset:0}});return y?(w.apply(y),this._commandService.syncExecuteCommand(C.SetRangeValuesCommand.id,{value:{[(T=t==null?void 0:t.row)!=null?T:h]:{[(D=t==null?void 0:t.col)!=null?D:p]:{p:w.getSnapshot(),t:1}}},unitId:t==null?void 0:t.unitId,subUnitId:t==null?void 0:t.subUnitId})):!1}async insertCellImageByUrl(e,t){var h,p;const{width:n,height:s,image:o}=await j.getImageSize(e||"");this._imageIoService.addImageSourceCache(e,l.ImageSourceType.URL,o);const a=this._workbookSelections.getCurrentLastSelection();if(!a)return!1;const d=l.createDocumentModelWithStyle("",{}),g=pt(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:a.primary.actualRow,col:a.primary.actualColumn},n,s,0);if(!g)return!1;const u={size:{width:g.width,height:g.height},positionH:{relativeFrom:l.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:l.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0},c={unitId:d.getUnitId(),subUnitId:d.getUnitId(),drawingId:l.generateRandomId(),drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:l.ImageSourceType.URL,source:e,transform:Je.docDrawingPositionToTransform(u),docTransform:u,behindDoc:l.BooleanNumber.FALSE,title:"",description:"",layoutType:l.PositionedObjectLayoutType.INLINE,wrapText:l.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},m=l.BuildTextUtils.drawing.add({documentDataModel:d,drawings:[c],selection:{collapsed:!0,startOffset:0,endOffset:0}});return m?(d.apply(m),this._commandService.syncExecuteCommand(C.SetRangeValuesCommand.id,{value:{[(h=t==null?void 0:t.row)!=null?h:a.primary.actualRow]:{[(p=t==null?void 0:t.col)!=null?p:a.primary.actualColumn]:{p:d.getSnapshot(),t:1}}},unitId:t==null?void 0:t.unitId,subUnitId:t==null?void 0:t.subUnitId})):!1}_getUnitInfo(){const e=this._context.unit,t=e.getActiveSheet(),n=e.getUnitId(),s=t.getSheetId();return{unitId:n,subUnitId:s}}_getImagePosition(e,t,n,s){const o=this._workbookSelections.getCurrentSelections();let a={startRow:0,endRow:0,startColumn:0,endColumn:0};o&&o.length>0&&(a=o[o.length-1].range);const d=E.attachRangeWithCoord(this._skeletonManagerService.getCurrent().skeleton,a);if(d==null)return;let{startColumn:g,startRow:u,startX:c,startY:m}=d,h=!1;if(c+e>n&&(c=n-e,c<0&&(c=0,e=n),h=!0),m+t>s&&(m=s-t,m<0&&(m=0,t=s),h=!0),h){const v=this._selectionRenderService.getCellWithCoordByOffset(c,m);if(v==null)return;c=v.startX,m=v.startY,g=v.actualColumn,u=v.actualRow}const p={column:g,columnOffset:0,row:u,rowOffset:0},w=this._selectionRenderService.getCellWithCoordByOffset(c+e,m+t);if(w==null)return;const f={column:w.actualColumn,columnOffset:c+e-w.startX,row:w.actualRow,rowOffset:m+t-w.startY};return{from:p,to:f}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(e=>{const{unitId:t,subUnitId:n,drawingIds:s,arrangeType:o}=e;this._commandService.executeCommand(Dt.id,{unitId:t,subUnitId:n,drawingIds:s,arrangeType:o})}))}_updateImageListener(){this.disposeWithMe(this._drawingManagerService.featurePluginUpdate$.subscribe(e=>{const t=[];e.length!==0&&(e.forEach(n=>{const{unitId:s,subUnitId:o,drawingId:a,drawingType:d,transform:g}=n;if(g==null)return;const u=this._sheetDrawingService.getDrawingByParam({unitId:s,subUnitId:o,drawingId:a});if(u==null||u.unitId!==this._context.unitId)return;const c=Y({...u.transform,...g},this._selectionRenderService);if(c==null)return;const m={...n,transform:{...u.transform,...g,...Z(c,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...c}};t.push(m)}),t.length>0&&this._commandService.executeCommand(je.id,{unitId:e[0].unitId,drawings:t}))}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(e=>{this._commandService.executeCommand(It.id,e);const{unitId:t,subUnitId:n,drawingId:s}=e[0].parent;this._commandService.syncExecuteCommand(j.SetDrawingSelectedOperation.id,[{unitId:t,subUnitId:n,drawingId:s}])})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(e=>{this._commandService.executeCommand(Ct.id,e)}))}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(e=>{e==null||e.length===0?(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._sheetDrawingService.focusDrawing(e))}))}};exports.SheetDrawingUpdateController=rn([re(1,l.Inject(E.SheetSkeletonManagerService)),re(2,l.ICommandService),re(3,E.ISheetSelectionRenderService),re(4,j.IImageIoService),re(5,k.ILocalFileService),re(6,S.ISheetDrawingService),re(7,j.IDrawingManagerService),re(8,l.IContextService),re(9,k.IMessageService),re(10,l.Inject(l.LocaleService)),re(11,l.Inject(C.SheetsSelectionsService)),re(12,l.Inject(l.Injector))],exports.SheetDrawingUpdateController);const ke={id:"sheet.command.insert-float-image",type:l.CommandType.COMMAND,handler:async(i,r)=>{var o,a;const e=i.get(l.IUniverInstanceService),t=i.get(x.IRenderManagerService),n=(o=x.getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET,e,t))==null?void 0:o.with(exports.SheetDrawingUpdateController);if(!n)return!1;const s=r==null?void 0:r.files;if(s){const d=s.map(g=>n.insertFloatImageByFile(g));return(await Promise.all(d)).every(g=>g)}else return(a=n.insertFloatImage())!=null?a:!1}},yt={id:"sheet.command.insert-cell-image",type:l.CommandType.COMMAND,handler:i=>{var t,n;const r=i.get(l.IUniverInstanceService),e=i.get(x.IRenderManagerService);return(n=(t=x.getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET,r,e))==null?void 0:t.with(exports.SheetDrawingUpdateController).insertCellImage())!=null?n:!1}},Te={id:"sheet.command.move-drawing",type:l.CommandType.COMMAND,handler:(i,r)=>{const e=i.get(l.ICommandService),t=i.get(S.ISheetDrawingService),n=i.get(E.ISheetSelectionRenderService),{direction:s}=r,o=t.getFocusDrawings();if(o.length===0)return!1;const a=o[0].unitId,d=o.map(u=>{const{transform:c}=u;if(c==null)return null;const m={...c},{left:h=0,top:p=0}=c;return s===l.Direction.UP?m.top=p-1:s===l.Direction.DOWN?m.top=p+1:s===l.Direction.LEFT?m.left=h-1:s===l.Direction.RIGHT&&(m.left=h+1),{...u,transform:m,sheetTransform:Y(m,n)}}).filter(u=>u!=null);return e.syncExecuteCommand(je.id,{unitId:a,drawings:d})?(e.syncExecuteCommand(X.id,[a]),!0):!1}};var on=Object.getOwnPropertyDescriptor,an=(i,r,e,t)=>{for(var n=t>1?void 0:t?on(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},ut=(i,r)=>(e,t)=>r(e,t,i),ge=(i=>(i.CELL_ADDRESS="cellAddress",i.COLUMN_VALUE="columnValue",i))(ge||{});const ct=l.createIdentifier("sheets-drawing-ui.batch-save-images.service");function ft(i){let r="",e=i;for(;e>=0;)r=String.fromCharCode(e%26+65)+r,e=Math.floor(e/26)-1;return r}function Qe(i,r){return`${ft(r)}${i+1}`}function cn(i){const r=Qe(i.startRow,i.startColumn),e=Qe(i.endRow,i.endColumn);return r===e?r:`${r}:${e}`}function Pt(i){var r,e,t,n;return!!((e=(r=i==null?void 0:i.p)==null?void 0:r.drawingsOrder)!=null&&e.length&&((n=(t=i==null?void 0:i.p)==null?void 0:t.drawingsOrder)==null?void 0:n.length)>0)}function Nt(i){var t,n,s;if(!((n=(t=i.p)==null?void 0:t.drawingsOrder)!=null&&n.length)||!((s=i.p)!=null&&s.drawings))return null;const r=i.p.drawingsOrder[0],e=i.p.drawings[r];return!e||!("source"in e)||!("imageSourceType"in e)?null:e}function gt(i,r){if(r===l.ImageSourceType.BASE64){const e=i.match(/^data:image\/(\w+);/);if(e)return e[1]==="jpeg"?"jpg":e[1]}if(r===l.ImageSourceType.URL){const e=i.match(/\.(\w+)(?:\?|$)/);if(e)return e[1].toLowerCase()}return"png"}async function jt(i,r){if(r===l.ImageSourceType.BASE64)return(await fetch(i)).blob();if(r===l.ImageSourceType.URL)return(await fetch(i)).blob();throw new Error("UUID image type requires additional handling")}exports.BatchSaveImagesService=class extends l.Disposable{constructor(r,e,t){super(),this._univerInstanceService=r,this._selectionService=e,this._imageIoService=t}getCellImagesInSelection(){const r=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET);if(!r)return[];const e=r.getActiveSheet();if(!e)return[];const t=this._selectionService.getCurrentSelections();if(!t||t.length===0)return[];const n=e.getCellMatrix(),s=[];for(const o of t){const{startRow:a,endRow:d,startColumn:g,endColumn:u}=o.range;for(let c=a;c<=d;c++)for(let m=g;m<=u;m++){const h=n.getValue(c,m);if(Pt(h)){const p=Nt(h);p&&s.push({row:c,col:m,cellAddress:Qe(c,m),source:p.source,imageSourceType:p.imageSourceType,imageId:p.drawingId})}}}return s}getCellImagesFromRanges(r,e,t){const n=this._univerInstanceService.getUnit(r,l.UniverInstanceType.UNIVER_SHEET);if(!n)return[];const s=n.getSheetBySheetId(e);if(!s)return[];const o=s.getCellMatrix(),a=[];for(const d of t){const{startRow:g,endRow:u,startColumn:c,endColumn:m}=d;for(let h=g;h<=u;h++)for(let p=c;p<=m;p++){const w=o.getValue(h,p);if(Pt(w)){const f=Nt(w);f&&a.push({row:h,col:p,cellAddress:Qe(h,p),source:f.source,imageSourceType:f.imageSourceType,imageId:f.drawingId})}}}return a}getDataColumns(){var m,h,p,w;const r=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET);if(!r)return[];const e=r.getActiveSheet();if(!e)return[];const t=this._selectionService.getCurrentSelections();if(!t||t.length===0)return[];const n=e.getCellMatrix(),s=n.getDataRange();let o=1/0,a=-1/0;const d=new Set;for(const f of t){o=Math.min(o,f.range.startRow),a=Math.max(a,f.range.endRow);for(let v=f.range.startColumn;v<=f.range.endColumn;v++)d.add(v)}const g=new Set;for(let f=s.startColumn;f<=s.endColumn;f++)if(!d.has(f))for(let v=o;v<=a;v++){const _=n.getValue(v,f);if(_&&(((m=_.v)==null?void 0:m.toString())||((w=(p=(h=_.p)==null?void 0:h.body)==null?void 0:p.dataStream)==null?void 0:w.trim())||"")){g.add(f);break}}const u=[],c=Array.from(g).sort((f,v)=>f-v);for(const f of c)u.push({index:f,label:ft(f)});return u}getDataColumnsForRanges(r,e,t){var p,w,f,v;const n=this._univerInstanceService.getUnit(r,l.UniverInstanceType.UNIVER_SHEET);if(!n)return[];const s=n.getSheetBySheetId(e);if(!s)return[];const o=s.getCellMatrix(),a=o.getDataRange();let d=1/0,g=-1/0;const u=new Set;for(const _ of t){d=Math.min(d,_.startRow),g=Math.max(g,_.endRow);for(let y=_.startColumn;y<=_.endColumn;y++)u.add(y)}const c=new Set;for(let _=a.startColumn;_<=a.endColumn;_++)if(!u.has(_))for(let y=d;y<=g;y++){const T=o.getValue(y,_);if(T&&(((p=T.v)==null?void 0:p.toString())||((v=(f=(w=T.p)==null?void 0:w.body)==null?void 0:f.dataStream)==null?void 0:v.trim())||"")){c.add(_);break}}const m=[],h=Array.from(c).sort((_,y)=>_-y);for(const _ of h)m.push({index:_,label:ft(_)});return m}getSelectionRangeNotation(){const r=this._selectionService.getCurrentSelections();return!r||r.length===0?"":r.map(e=>cn(e.range)).join(", ")}getSelectionRowRange(){const r=this._selectionService.getCurrentSelections();if(!r||r.length===0)return null;let e=1/0,t=-1/0;for(const n of r)e=Math.min(e,n.range.startRow),t=Math.max(t,n.range.endRow);return{startRow:e,endRow:t}}getSelectionColumnIndices(){const r=this._selectionService.getCurrentSelections();if(!r||r.length===0)return new Set;const e=new Set;for(const t of r)for(let n=t.range.startColumn;n<=t.range.endColumn;n++)e.add(n);return e}generateFileName(r,e){var o,a,d,g;const t=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET),n=gt(r.source,r.imageSourceType),s=[];for(const u of e.fileNameParts)if(u==="cellAddress")s.push(r.cellAddress);else if(u==="columnValue"&&e.columnIndex!==void 0){const c=t==null?void 0:t.getActiveSheet();if(c){const h=c.getCellMatrix().getValue(r.row,e.columnIndex);if(h){const p=((o=h.v)==null?void 0:o.toString())||((g=(d=(a=h.p)==null?void 0:a.body)==null?void 0:d.dataStream)==null?void 0:g.trim())||"";if(p){const w=p.replace(/[<>:"/\\|?*]/g,"_").trim();w&&s.push(w)}}}}return s.length===0?`${r.cellAddress}.${n}`:`${s.join("_")}.${n}`}generateFileNameWithContext(r,e,t,n){var d,g,u,c;const s=this._univerInstanceService.getUnit(t,l.UniverInstanceType.UNIVER_SHEET),o=gt(r.source,r.imageSourceType),a=[];for(const m of e.fileNameParts)if(m==="cellAddress")a.push(r.cellAddress);else if(m==="columnValue"&&e.columnIndex!==void 0){const h=s==null?void 0:s.getSheetBySheetId(n);if(h){const w=h.getCellMatrix().getValue(r.row,e.columnIndex);if(w){const f=((d=w.v)==null?void 0:d.toString())||((c=(u=(g=w.p)==null?void 0:g.body)==null?void 0:u.dataStream)==null?void 0:c.trim())||"";if(f){const v=f.replace(/[<>:"/\\|?*]/g,"_").trim();v&&a.push(v)}}}}return a.length===0?`${r.cellAddress}.${o}`:`${a.join("_")}.${o}`}async saveImages(r,e){var s;const t=await window.showDirectoryPicker({mode:"readwrite"}),n=new Map;for(const o of r){let a=this.generateFileName(o,e);const d=a.replace(/\.\w+$/,""),g=((s=a.match(/\.\w+$/))==null?void 0:s[0])||".png",u=n.get(d)||0;u>0&&(a=`${d}_${u}${g}`),n.set(d,u+1);try{const c=await this._getImageBlob(o),h=await(await t.getFileHandle(a,{create:!0})).createWritable();await h.write(c),await h.close()}catch(c){throw console.error(`Failed to save image ${a}:`,c),c}}}async saveImagesWithContext(r,e,t,n){var a;const s=await window.showDirectoryPicker({mode:"readwrite"}),o=new Map;for(const d of r){let g=this.generateFileNameWithContext(d,e,t,n);const u=g.replace(/\.\w+$/,""),c=((a=g.match(/\.\w+$/))==null?void 0:a[0])||".png",m=o.get(u)||0;m>0&&(g=`${u}_${m}${c}`),o.set(u,m+1);try{const h=await this._getImageBlob(d),w=await(await s.getFileHandle(g,{create:!0})).createWritable();await w.write(h),await w.close()}catch(h){throw console.error(`Failed to save image ${g}:`,h),h}}}async downloadSingleImage(r){const e=gt(r.source,r.imageSourceType),t=`${r.cellAddress}.${e}`;try{const n=await this._getImageBlob(r),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}catch(n){throw console.error(`Failed to download image ${t}:`,n),n}}async _getImageBlob(r){if(r.imageSourceType===l.ImageSourceType.UUID){const e=await this._imageIoService.getImage(r.source);return jt(e,l.ImageSourceType.URL)}return jt(r.source,r.imageSourceType)}};exports.BatchSaveImagesService=an([ut(0,l.IUniverInstanceService),ut(1,l.Inject(C.SheetsSelectionsService)),ut(2,l.IImageIoService)],exports.BatchSaveImagesService);const Ce="sheet.dialog.batch-save-images",ye={id:"sheet.command.save-cell-images",type:l.CommandType.COMMAND,handler:async i=>{const r=i.get(k.IDialogService),e=i.get(ct),t=e.getCellImagesInSelection();if(t.length===1)try{return await e.downloadSingleImage(t[0]),!0}catch(a){return console.error("Failed to download image:",a),!1}const n=i.get(l.LocaleService),s=e.getSelectionRangeNotation(),o=`${n.t("sheetImage.save.title")} (${s})`;return r.open({id:Ce,draggable:!0,width:360,title:{title:o},children:{label:Ce},destroyOnClose:!0,preservePositionOnDestroy:!0,onClose:()=>r.close(Ce)}),!0}},Bt="COMPONENT_SHEET_DRAWING_PANEL",Mt={id:"sidebar.operation.sheet-image",type:l.CommandType.COMMAND,handler:async(i,r)=>{const e=i.get(k.ISidebarService),t=i.get(l.LocaleService),n=i.get(l.IUniverInstanceService),s=i.get(l.ICommandService);if(!C.getSheetCommandTarget(n))return!1;switch(r.value){case"open":e.open({header:{title:t.t("sheetImage.panel.title")},children:{label:Bt},onClose:()=>{s.syncExecuteCommand(j.SetDrawingSelectedOperation.id,[])},width:360});break;case"close":default:e.close();break}return!0}},Tt={id:"sheet.operation.edit-sheet-image",type:l.CommandType.OPERATION,handler:(i,r)=>{const e=i.get(l.ICommandService);return r==null?!1:(e.syncExecuteCommand(j.SetDrawingSelectedOperation.id,[r]),e.executeCommand(Mt.id,{value:"open"}),!0)}},dn="sheets-drawing-ui.config",kt={};var ln=Object.getOwnPropertyDescriptor,un=(i,r,e,t)=>{for(var n=t>1?void 0:t?ln(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},se=(i,r)=>(e,t)=>r(e,t,i);let et=class extends l.RxDisposable{constructor(r,e,t,n,s,o,a,d,g,u){super();ne(this,"_initImagePopupMenu",new Set);this._injector=r,this._localeService=e,this._drawingManagerService=t,this._canvasPopManagerService=n,this._renderManagerService=s,this._univerInstanceService=o,this._messageService=a,this._contextService=d,this._ioService=g,this._commandService=u,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(O.takeUntil(this.dispose$)).subscribe(r=>this._create(r)),this._univerInstanceService.getTypeOfUnitDisposed$(l.UniverInstanceType.UNIVER_SHEET).pipe(O.takeUntil(this.dispose$)).subscribe(r=>this._dispose(r)),this._univerInstanceService.getAllUnitsForType(l.UniverInstanceType.UNIVER_SHEET).forEach(r=>this._create(r)),this._setupLoadingStatus()}_setupLoadingStatus(){const r="image-upload-loading";let e;this.disposeWithMe(this._ioService.change$.subscribe(t=>{t>0&&!e?e=this._messageService.show({id:r,type:F.MessageType.Loading,content:`${this._localeService.t("uploadLoading.loading")}: ${t}`,duration:0}):t===0&&(e==null||e.dispose(),e=void 0)}))}_dispose(r){super.dispose();const e=r.getUnitId();this._renderManagerService.removeRender(e)}_create(r){if(!r)return;const e=r.getUnitId();this._renderManagerService.has(e)&&!this._initImagePopupMenu.has(e)&&(this._popupMenuListener(e),this._initImagePopupMenu.add(e))}_hasCropObject(r){const e=r.getAllObjectsByOrder();for(const t of e)if(t instanceof he.ImageCropperObject)return!0;return!1}_popupMenuListener(r){var s;const e=(s=this._renderManagerService.getRenderById(r))==null?void 0:s.scene;if(!e)return;const t=e.getTransformerByCreate();if(!t)return;let n;this.disposeWithMe(t.createControl$.subscribe(()=>{if(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._hasCropObject(e))return;const o=t.getSelectedObjectMap();if(o.size>1){n==null||n.dispose();return}const a=o.values().next().value;if(!a)return;const d=a.oKey,g=this._drawingManagerService.getDrawingOKey(d);if(!g)return;const{unitId:u,subUnitId:c,drawingId:m,drawingType:h}=g,p=g.data;if(p&&p.disablePopup)return;n==null||n.dispose();const w=this._canvasPopManagerService.getFeatureMenu(u,c,m,h);n=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(a,{componentKey:he.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:w||this._getImageMenuItems(u,c,m,h)}}))})),this.disposeWithMe(t.clearControl$.subscribe(()=>{n==null||n.dispose(),this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._commandService.syncExecuteCommand(j.SetDrawingSelectedOperation.id,[])})),this.disposeWithMe(this._contextService.contextChanged$.subscribe(o=>{o[l.FOCUSING_COMMON_DRAWINGS]===!1&&(n==null||n.dispose())})),this.disposeWithMe(t.changing$.subscribe(()=>{n==null||n.dispose()}))}_getImageMenuItems(r,e,t,n){return[{label:"image-popup.edit",index:0,commandId:Tt.id,commandParams:{unitId:r,subUnitId:e,drawingId:t},disable:n===l.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:Me.id,commandParams:{unitId:r,drawings:[{unitId:r,subUnitId:e,drawingId:t}]},disable:!1},{label:"image-popup.crop",index:2,commandId:he.OpenImageCropOperation.id,commandParams:{unitId:r,subUnitId:e,drawingId:t},disable:n===l.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:he.ImageResetSizeOperation.id,commandParams:[{unitId:r,subUnitId:e,drawingId:t}],disable:n===l.DrawingTypeEnum.DRAWING_DOM}]}};et=un([se(0,l.Inject(l.Injector)),se(1,l.Inject(l.LocaleService)),se(2,j.IDrawingManagerService),se(3,l.Inject(E.SheetCanvasPopManagerService)),se(4,x.IRenderManagerService),se(5,l.IUniverInstanceService),se(6,k.IMessageService),se(7,l.IContextService),se(8,l.IImageIoService),se(9,l.ICommandService)],et);var gn=Object.getOwnPropertyDescriptor,hn=(i,r,e,t)=>{for(var n=t>1?void 0:t?gn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},Ke=(i,r)=>(e,t)=>r(e,t,i);let wt=class extends l.Disposable{constructor(r,e,t,n,s){super();ne(this,"_isSetCursor",!1);this._context=r,this._hoverManagerService=e,this._selectionsService=t,this._drawingRenderService=n,this._sheetSkeletonManagerService=s,this._initHover(),this._initImageClick()}_initHover(){this.disposeWithMe(this._hoverManagerService.currentRichTextNoDistinct$.pipe(O.throttleTime(33)).subscribe(r=>{var t,n;let e=[];r!==null&&(e=this._selectionsService.getWorkbookSelections(this._context.unitId).getCurrentSelections()),e.length>0&&(r==null?void 0:r.unitId)===this._context.unitId&&(r!=null&&r.drawing)&&e.length===1&&((t=e[0].primary)==null?void 0:t.actualRow)===r.row&&((n=e[0].primary)==null?void 0:n.actualColumn)===r.col?(this._isSetCursor=!0,this._context.scene.setCursor(x.CURSOR_TYPE.ZOOM_IN)):this._isSetCursor&&(this._isSetCursor=!1,this._context.scene.resetCursor())}))}_initImageClick(){this.disposeWithMe(this._hoverManagerService.currentClickedCell$.subscribe(r=>{var e;if(r!=null&&r.drawing&&this._isSetCursor){const t=r.drawing.drawing.drawingOrigin,n=(e=this._sheetSkeletonManagerService.getCurrentSkeleton())==null?void 0:e.imageCacheMap.getImage(t.imageSourceType,t.source);if(!n)return;this._drawingRenderService.previewImage("preview-cell-image",n.src,n.width,n.height),this._context.scene.resetCursor(),this._isSetCursor=!1}}))}};wt=hn([Ke(1,l.Inject(E.HoverManagerService)),Ke(2,l.Inject(C.SheetsSelectionsService)),Ke(3,l.Inject(he.DrawingRenderService)),Ke(4,l.Inject(E.SheetSkeletonManagerService))],wt);var mn=Object.getOwnPropertyDescriptor,pn=(i,r,e,t)=>{for(var n=t>1?void 0:t?mn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},ze=(i,r)=>(e,t)=>r(e,t,i);let St=class extends l.Disposable{constructor(i,r,e,t,n){super(),this._context=i,this._sheetDrawingService=r,this._drawingManagerService=e,this._sheetSelectionRenderService=t,this._sheetSkeletonManagerService=n,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);const i=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(const r in i){const e=i[r];for(const t in e.data){const n=e.data[t];n.sheetTransform&&(n.transform=Z(n.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService))}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}};St=pn([ze(1,S.ISheetDrawingService),ze(2,j.IDrawingManagerService),ze(3,l.Inject(E.ISheetSelectionRenderService)),ze(4,l.Inject(E.SheetSkeletonManagerService))],St);var fn=Object.getOwnPropertyDescriptor,wn=(i,r,e,t)=>{for(var n=t>1?void 0:t?fn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},Ie=(i,r)=>(e,t)=>r(e,t,i);function Lt(i,r,e){var t,n,s,o;if(((n=(t=e==null?void 0:e.p)==null?void 0:t.body)==null?void 0:n.dataStream.length)===3&&((o=(s=e.p)==null?void 0:s.drawingsOrder)==null?void 0:o.length)===1){const a=e.p.drawings[e.p.drawingsOrder[0]],d=pt(i,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},a.docTransform.size.width,a.docTransform.size.height,a.docTransform.angle);if(d)return a.transform.width=d.width,a.transform.height=d.height,a.docTransform.size.width=d.width,a.docTransform.size.height=d.height,a.transform.left=0,a.transform.top=0,a.docTransform.positionH.posOffset=0,a.docTransform.positionV.posOffset=0,e.p.documentStyle.pageSize.width=1/0,e.p.documentStyle.pageSize.height=1/0,!0}return!1}let tt=class extends l.Disposable{constructor(i,r,e,t,n,s){super(),this._commandService=i,this._sheetInterceptorService=r,this._injector=e,this._drawingManagerService=t,this._docDrawingController=n,this._editorBridgeService=s,this._handleInitEditor(),this._initCellContentInterceptor()}_handleInitEditor(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(i=>{i.visible?i.visible&&(this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)):this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)})),this.disposeWithMe(this._commandService.onCommandExecuted(i=>{i.id===Je.ReplaceSnapshotCommand.id&&i.params.unitId===l.DOCS_ZEN_EDITOR_UNIT_ID_KEY&&(this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY))}))}_initCellContentInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(C.INTERCEPTOR_POINT.CELL_CONTENT,{effect:l.InterceptorEffectEnum.Style,priority:C.InterceptCellContentPriority.CELL_IMAGE,handler:(i,r,e)=>{var t;return i!=null&&i.p&&((t=i.p.drawingsOrder)!=null&&t.length)&&(i===r.rawData&&(i={...r.rawData}),i.interceptorStyle||(i.interceptorStyle={}),i.interceptorStyle.tr={a:0},Lt(this._injector,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},i)),e(i)}}))}};tt=wn([Ie(0,l.ICommandService),Ie(1,l.Inject(C.SheetInterceptorService)),Ie(2,l.Inject(l.Injector)),Ie(3,j.IDrawingManagerService),Ie(4,l.Inject($t.DocDrawingController)),Ie(5,l.Inject(E.IEditorBridgeService))],tt);var Sn=Object.getOwnPropertyDescriptor,vn=(i,r,e,t)=>{for(var n=t>1?void 0:t?Sn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},xt=(i,r)=>(e,t)=>r(e,t,i);let nt=class extends l.Disposable{constructor(i,r){super(),this._autoFillService=i,this._injector=r,this._initAutoFillHooks()}_initAutoFillHooks(){this.disposeWithMe(this._autoFillService.addHook({id:"sheet-cell-image-autofill",onBeforeSubmit:(i,r,e,t)=>{new l.ObjectMatrix(t).forValue((n,s,o)=>{Lt(this._injector,{unitId:i.unitId,subUnitId:i.subUnitId,row:n,col:s},o)})}}))}};nt=vn([xt(0,l.Inject(E.IAutoFillService)),xt(1,l.Inject(l.Injector))],nt);var _n=Object.getOwnPropertyDescriptor,In=(i,r,e,t)=>{for(var n=t>1?void 0:t?_n(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},Oe=(i,r)=>(e,t)=>r(e,t,i);const Dn=[l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY,l.DOCS_FORMULA_BAR_EDITOR_UNIT_ID_KEY,l.DOCS_ZEN_EDITOR_UNIT_ID_KEY];let rt=class extends l.Disposable{constructor(i,r,e,t,n){super(),this._commandService=i,this._univerInstanceService=r,this._dialogService=e,this._renderManagerService=t,this._localeService=n,this._initDocImageCopyPasteHooks()}_setCellImage(i){var n;const r=l.createDocumentModelWithStyle("",{}),e=(n=x.getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:n.with(E.EditingRenderController),t=l.BuildTextUtils.drawing.add({documentDataModel:r,drawings:[i],selection:{collapsed:!0,startOffset:0,endOffset:0}});t&&(r.apply(t),e&&e.submitCellData(r))}_initDocImageCopyPasteHooks(){this.disposeWithMe(this._commandService.beforeCommandExecuted(i=>{var r,e;if(i.id===Je.InnerPasteCommand.id){const t=i.params,{doc:n}=t,s=this._univerInstanceService.getCurrentUnitOfType(l.UniverInstanceType.UNIVER_DOC);if(s==null||!Object.keys((r=n.drawings)!=null?r:{}).length)return;const o=s.getUnitId();if(Dn.includes(o)){if(o!==l.DOCS_ZEN_EDITOR_UNIT_ID_KEY){const a=()=>{this._dialogService.close("sheet-cell-image-copy-paste"),this._commandService.syncExecuteCommand(E.SetCellEditVisibleOperation.id,{visible:!1})};((e=s.getBody())==null?void 0:e.dataStream)===`\r
`?(this._commandService.syncExecuteCommand(E.SetCellEditVisibleOperation.id,{visible:!1}),this._setCellImage(Object.values(n.drawings)[0])):this._dialogService.open({id:"sheet-cell-image-copy-paste",title:{label:this._localeService.t("cell-image.pasteTitle")},children:{label:this._localeService.t("cell-image.pasteContent")},width:320,destroyOnClose:!0,onClose:a,showOk:!0,showCancel:!0,onOk:()=>{a(),this._setCellImage(Object.values(n.drawings)[0])},onCancel:a})}throw new Error("Sheet cell image copy paste is not supported in this unit")}}}))}};rt=In([Oe(0,l.ICommandService),Oe(1,l.IUniverInstanceService),Oe(2,k.IDialogService),Oe(3,x.IRenderManagerService),Oe(4,l.Inject(l.LocaleService))],rt);var Cn=Object.getOwnPropertyDescriptor,yn=(i,r,e,t)=>{for(var n=t>1?void 0:t?Cn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},Ue=(i,r)=>(e,t)=>r(e,t,i);const Ft="image/png";function Mn(i){const r=i.split(","),e=atob(r[1]),t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return new Blob([n],{type:Ft})}function Tn(i){const r=new ClipboardItem({[Ft]:Mn(i)});navigator.clipboard.write([r]).catch(e=>{console.error("Could not copy image using clipboard API: ",e)})}function Rn(){function i(){const t=document.createElement("input");return t.style.position="absolute",t.style.height="1px",t.style.width="1px",t.style.opacity="0",t}const r=document.activeElement,e=i();return document.body.appendChild(e),e.focus(),()=>{e.blur(),document.body.removeChild(e),r instanceof HTMLElement&&r.focus()}}const Wt=[E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_COL_WIDTH,E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_VALUE,E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMAT,E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA];let it=class extends l.Disposable{constructor(r,e,t,n,s){super();ne(this,"_copyInfo");this._sheetClipboardService=r,this._renderManagerService=e,this._drawingService=t,this._clipboardInterfaceService=n,this._commandService=s,this._initCopyPaste()}get _focusedDrawings(){return this._drawingService.getFocusDrawings()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:(r,e,t,n)=>{this._copyInfo=null;const s=this._focusedDrawings;if(s.length>0){const[o]=s;if(o.drawingType!==l.DrawingTypeEnum.DRAWING_IMAGE)return;if(n===E.COPY_TYPE.CUT){const d={unitId:r,drawings:[o]};this._commandService.executeCommand(Me.id,d)}setTimeout(()=>{const d=Rn();o.drawingType===l.DrawingTypeEnum.DRAWING_IMAGE&&o.imageSourceType===j.ImageSourceType.BASE64?Tn(o.source):this._clipboardInterfaceService.writeText(""),d()},200);const a={unitId:o.unitId,subUnitId:o.subUnitId,drawings:[o]};this._copyInfo=a}else{const o=this._createDrawingsCopyInfoByRange(r,e,t);this._copyInfo=o}},onPasteCells:(r,e,t,n)=>{if(!this._copyInfo)return{redos:[],undos:[]};const{copyType:s=E.COPY_TYPE.COPY,pasteType:o}=n,{range:a}=r||{},{range:d,unitId:g,subUnitId:u}=e;return this._copyInfo.copyRange?this._generateRangeDrawingsPasteMutations({pasteType:o,unitId:g,subUnitId:u,pasteRange:d},{copyRange:a,copyType:s}):this._generateSingleDrawingPasteMutations({pasteTo:e,pasteType:o},E.COPY_TYPE.COPY)},onPastePlainText:(r,e)=>({undos:[],redos:[]}),onPasteUnrecognized:r=>this._copyInfo?this._generateSingleDrawingPasteMutations({pasteTo:r,pasteType:E.PREDEFINED_HOOK_NAME.DEFAULT_PASTE},E.COPY_TYPE.COPY):{undos:[],redos:[]},onPasteFiles:(r,e)=>{if(this._copyInfo)return this._generateSingleDrawingPasteMutations({pasteTo:r,pasteType:E.PREDEFINED_HOOK_NAME.DEFAULT_PASTE},E.COPY_TYPE.COPY);{const t=e.filter(n=>n.type.includes("image"));if(t.length)return{undos:[],redos:[{id:ke.id,params:{files:t}}]}}return{undos:[],redos:[]}}})}_createDrawingsCopyInfoByRange(r,e,t){var m;const n=(m=this._renderManagerService.getRenderById(r))==null?void 0:m.with(E.SheetSkeletonManagerService);if(!n)return;const s=n.attachRangeWithCoord(t);if(!s)return;const{startX:o,endX:a,startY:d,endY:g}=s,u=this._drawingService.getDrawingData(r,e),c=this._focusedDrawings.slice();if(Object.keys(u).forEach(h=>{const p=u[h];if(p.drawingType!==l.DrawingTypeEnum.DRAWING_IMAGE)return;const{transform:w}=p;if(p.anchorType!==S.SheetDrawingAnchorType.Both||!w)return;const{left:f=0,top:v=0,width:_=0,height:y=0}=w,{drawingStartX:T,drawingEndX:D,drawingStartY:M,drawingEndY:I}={drawingStartX:f,drawingEndX:f+_,drawingStartY:v,drawingEndY:v+y};o<=T&&D<=a&&d<=M&&I<=g&&c.push(p)}),c.length)return{copyRange:t,drawings:c,unitId:r,subUnitId:e}}_generateSingleDrawingPasteMutations(r,e){const{pasteType:t,pasteTo:n}=r;if(Wt.includes(t))return{redos:[],undos:[]};const{unitId:s,subUnitId:o,range:a}=n,d=this._renderManagerService.getRenderById(s),g=d==null?void 0:d.with(E.SheetSkeletonManagerService),u=d==null?void 0:d.with(E.ISheetSelectionRenderService),c=this._copyInfo;if(!g||!u)return{redos:[],undos:[]};const{drawings:m}=c,h=E.discreteRangeToRange(a);return this._generateMutations(m,{unitId:s,subUnitId:o,isCut:e===E.COPY_TYPE.CUT,getTransform:(p,w)=>{var _;const f=g.attachRangeWithCoord({startRow:h.startRow,endRow:h.endRow,startColumn:h.startColumn,endColumn:h.endColumn}),v={...p,left:f==null?void 0:f.startX,top:f==null?void 0:f.startY};return{transform:v,sheetTransform:(_=Y(v,u))!=null?_:w}}})}_generateMutations(r,e){const{unitId:t,subUnitId:n,getTransform:s,isCut:o}=e,a=[],d=[],{_drawingService:g}=this;return r.forEach(u=>{const{transform:c,sheetTransform:m}=u;if(!c)return;const h=s(c,m),p={...u,unitId:t,subUnitId:n,drawingId:o?u.drawingId:l.generateRandomId(),transform:h.transform,sheetTransform:h.sheetTransform};if(o){const{undo:w,redo:f,objects:v}=g.getBatchUpdateOp([p]);a.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,type:S.DrawingApplyType.UPDATE,op:f,objects:v}}),d.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,type:S.DrawingApplyType.UPDATE,op:w,objects:v}})}else{const{undo:w,redo:f,objects:v}=g.getBatchAddOp([p]);a.push({id:S.SetDrawingApplyMutation.id,params:{op:f,unitId:t,subUnitId:n,objects:v,type:S.DrawingApplyType.INSERT}}),d.push({id:S.SetDrawingApplyMutation.id,params:{op:w,unitId:t,subUnitId:n,objects:v,type:S.DrawingApplyType.REMOVE}})}}),{redos:a,undos:d}}_generateRangeDrawingsPasteMutations(r,e){var A;const{unitId:t,subUnitId:n,pasteType:s,pasteRange:o}=r,{copyRange:a,copyType:d}=e;if(Wt.includes(s))return{redos:[],undos:[]};const g=(A=this._renderManagerService.getRenderById(t))==null?void 0:A.with(E.SheetSkeletonManagerService);if(!g||!this._copyInfo)return{redos:[],undos:[]};const{drawings:u}=this._copyInfo;if(!a)return this._generateSingleDrawingPasteMutations({pasteTo:{unitId:t,subUnitId:n,range:E.discreteRangeToRange(o)},pasteType:s},d);const{ranges:[c,m],mapFunc:h}=E.virtualizeDiscreteRanges([a,o]),{row:p,col:w}=h(c.startRow,c.startColumn),{row:f,col:v}=h(m.startRow,m.startColumn),_=g.attachRangeWithCoord({startRow:p,endRow:p,startColumn:w,endColumn:w}),y=g.attachRangeWithCoord({startRow:f,endRow:f,startColumn:v,endColumn:v});if(!_||!y||!this._copyInfo)return{redos:[],undos:[]};const T=y.startX-_.startX,D=y.startY-_.startY,M=f-p,I=v-w;return this._generateMutations(u,{unitId:t,subUnitId:n,getTransform:(b,P)=>{var N,U;return{transform:{...b,left:((N=b==null?void 0:b.left)!=null?N:0)+T,top:((U=b==null?void 0:b.top)!=null?U:0)+D},sheetTransform:{...P,to:{...P.to,row:P.to.row+M,column:P.to.column+I},from:{...P.from,row:P.from.row+M,column:P.from.column+I}}}},isCut:d===E.COPY_TYPE.CUT})}};it=yn([Ue(0,E.ISheetClipboardService),Ue(1,x.IRenderManagerService),Ue(2,j.IDrawingManagerService),Ue(3,k.IClipboardInterfaceService),Ue(4,l.ICommandService)],it);var bn=Object.getOwnPropertyDescriptor,En=(i,r,e,t)=>{for(var n=t>1?void 0:t?bn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},Ae=(i,r)=>(e,t)=>r(e,t,i);let st=class extends l.Disposable{constructor(i,r,e,t,n){super(),this._drawingManagerService=i,this._renderManagerService=r,this._permissionService=e,this._univerInstanceService=t,this._userManagerService=n,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$,e=O.combineLatest([i,r]);this.disposeWithMe(e.pipe(O.switchMap(([t,n])=>t?t.activeSheet$.pipe(O.tap(s=>{if(!s){this._drawingManagerService.setDrawingVisible(!1);return}const o=t.getUnitId(),a=s.getSheetId();this._permissionService.composePermission([new C.WorkbookViewPermission(o).id,new C.WorksheetViewPermission(o,a).id]).every(g=>g.value)?this._drawingManagerService.setDrawingVisible(!0):this._handleDrawingVisibilityFalse(t,s)})):(this._drawingManagerService.setDrawingVisible(!1),O.EMPTY))).subscribe())}_handleDrawingVisibilityFalse(i,r){this._drawingManagerService.setDrawingVisible(!1);const e=i.getUnitId(),t=r.getSheetId(),n=this._drawingManagerService.getDrawingData(e,t),s=Object.values(n),o=this._renderManagerService.getRenderById(e),a=o==null?void 0:o.scene;if(!a)return;a.getAllObjectsByOrder().forEach(g=>{g.classType===x.RENDER_CLASS_TYPE.IMAGE&&s.some(u=>g.oKey.includes(u.drawingId))&&a.removeObject(g)})}_initDrawingEditable(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$,e=O.combineLatest([i,r]);this.disposeWithMe(e.pipe(O.switchMap(([t,n])=>t?t.activeSheet$.pipe(O.tap(s=>{if(!s){this._drawingManagerService.setDrawingEditable(!1);return}const o=t.getUnitId(),a=s.getSheetId();this._permissionService.composePermission([new C.WorkbookEditablePermission(o).id,new C.WorksheetEditPermission(o,a).id]).every(g=>g.value)?this._drawingManagerService.setDrawingEditable(!0):this._handleDrawingEditableFalse(t,s)})):(this._drawingManagerService.setDrawingEditable(!1),O.EMPTY))).subscribe())}_handleDrawingEditableFalse(i,r){this._drawingManagerService.setDrawingEditable(!1);const e=i.getUnitId(),t=r.getSheetId(),n=this._drawingManagerService.getDrawingData(e,t),s=Object.values(n),o=this._renderManagerService.getRenderById(e),a=o==null?void 0:o.scene;if(!a)return;a.getAllObjectsByOrder().forEach(g=>{g.classType===x.RENDER_CLASS_TYPE.IMAGE&&s.some(u=>g.oKey.includes(u.drawingId))&&a.detachTransformerFrom(g)})}_initViewPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$;this.disposeWithMe(O.combineLatest([i,r]).pipe(O.switchMap(([e,t])=>e?e.activeSheet$.pipe(O.switchMap(n=>{if(!n)return O.EMPTY;const s=e.getUnitId(),o=n.getSheetId(),a=this._renderManagerService.getRenderById(s),d=a==null?void 0:a.scene;if(!d)return O.EMPTY;const g=d.getTransformerByCreate();return this._permissionService.composePermission$([new C.WorkbookViewPermission(s).id,new C.WorksheetViewPermission(s,o).id]).pipe(O.map(c=>c.every(m=>m.value)),O.distinctUntilChanged()).pipe(O.map(c=>({permission:c,scene:d,transformer:g,unitId:s,subUnitId:o})))})):O.EMPTY)).subscribe({next:({permission:e,scene:t,transformer:n,unitId:s,subUnitId:o})=>{this._drawingManagerService.setDrawingVisible(e);const a=t.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(s,o),g=Object.values(d);e?this._drawingManagerService.addNotification(g):(a.forEach(u=>{u.classType===x.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&t.removeObject(u)}),n.clearSelectedObjects())},complete:()=>{this._drawingManagerService.setDrawingVisible(!0);const e=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET),t=e==null?void 0:e.getActiveSheet(),n=e==null?void 0:e.getUnitId(),s=t==null?void 0:t.getSheetId();if(!n||!s)return;const o=this._drawingManagerService.getDrawingData(n,s),a=Object.values(o);this._drawingManagerService.addNotification(a)}}))}_initEditPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$;this.disposeWithMe(O.combineLatest([i,r]).pipe(O.switchMap(([e,t])=>e?e.activeSheet$.pipe(O.switchMap(n=>{if(!n)return O.EMPTY;const s=e.getUnitId(),o=n.getSheetId(),a=this._renderManagerService.getRenderById(s),d=a==null?void 0:a.scene;if(!d)return O.EMPTY;const g=d.getTransformerByCreate();return this._permissionService.composePermission$([new C.WorkbookEditablePermission(s).id,new C.WorksheetEditPermission(s,o).id]).pipe(O.map(c=>c.every(m=>m.value)),O.distinctUntilChanged()).pipe(O.map(c=>({permission:c,scene:d,transformer:g,unitId:s,subUnitId:o})))})):O.EMPTY)).subscribe({next:({permission:e,scene:t,transformer:n,unitId:s,subUnitId:o})=>{this._drawingManagerService.setDrawingEditable(e);const a=t.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(s,o),g=Object.values(d);e?(a.forEach(u=>{u.classType===x.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&t.attachTransformerTo(u)}),this._drawingManagerService.addNotification(g)):(a.forEach(u=>{u.classType===x.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&t.detachTransformerFrom(u)}),n.clearSelectedObjects())},complete:()=>{const e=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET);if(!e)return;const t=e.getUnitId(),n=e.getActiveSheet();if(!n)return;const s=n.getSheetId(),o=this._renderManagerService.getRenderById(t),a=o==null?void 0:o.scene;if(!a)return;const d=this._drawingManagerService.getDrawingData(t,s),g=Object.values(d);this._drawingManagerService.setDrawingEditable(!0),a.getAllObjectsByOrder().forEach(c=>{c.classType===x.RENDER_CLASS_TYPE.IMAGE&&g.some(m=>c.oKey.includes(m.drawingId))&&a.detachTransformerFrom(c)})}}))}};st=En([Ae(0,j.IDrawingManagerService),Ae(1,x.IRenderManagerService),Ae(2,l.IPermissionService),Ae(3,l.IUniverInstanceService),Ae(4,l.Inject(l.UserManagerService))],st);var On=Object.getOwnPropertyDescriptor,Un=(i,r,e,t)=>{for(var n=t>1?void 0:t?On(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},me=(i,r)=>(e,t)=>r(e,t,i);const Yt="univer-sheet-float-dom-";function Gt(i,r,e,t,n,s=!1){const{scaleX:o,scaleY:a}=r.getAncestorScale(),d=r.getViewport(x.SHEET_VIEWPORT_KEY.VIEW_MAIN),g=t.getFreeze(),{startColumn:u,startRow:c,xSplit:m,ySplit:h}=g,p={left:!0,top:!0};if(!d)return{...i,absolute:p};const{left:w,right:f,top:v,bottom:_}=i;let{top:y,left:T,viewportScrollX:D,viewportScrollY:M}=d;const{boundsOfViewArea:I,scrollDirectionResponse:A}=n||{},{rowHeaderWidth:b,columnHeaderHeight:P}=e,N={top:s?0:P,left:s?0:b};I&&(l.Tools.isDefine(N.top)&&(N.top=I.top),l.Tools.isDefine(N.left)&&(N.left=I.left)),A==="HORIZONTAL"&&(M=0),A==="VERTICAL"&&(D=0);let U=0,R=0;const W=e.rowStartY(c-h)+P,L=e.colStartX(u-m)+b,J=e.rowStartY(c)+P,ee=e.colStartX(u)+b;if(m===0)p.left=!1,U=(w-D)*o,R=(f-D)*o;else{const z=w-(L-b),Q=f-(L-b);f<ee?(U=z*o,R=Q*o):w<=ee&&f>=ee?(U=z*o,R=Math.max(T,(f-D)*o)):w>ee&&(p.left=!1,U=Math.max((w-D)*o,T),R=Math.max((f-D)*o,T))}let K=0,q=0;if(h===0)p.top=!1,K=(v-M)*a,q=(_-M)*a;else{const z=v-(W-P),Q=_-(W-P);_<J?(K=z*a,q=Q*a):v<=J&&_>=J?(K=z*a,q=Math.max(y,(_-M)*a)):v>J&&(p.top=!1,K=Math.max((v-M)*a,y),q=Math.max((_-M)*a,y))}return U=Math.max(U,N.left),K=Math.max(K,N.top),R=Math.max(R,N.left),q=Math.max(q,N.top),{left:U,right:R,top:K,bottom:q,absolute:p}}const oe=(i,r,e,t,n)=>{const{left:s,top:o,width:a,height:d,angle:g}=i,u={left:s,right:s+a,top:o,bottom:o+d},c=Gt(u,r,e,t,n),{scaleX:m,scaleY:h}=r.getAncestorScale();return{startX:c.left,endX:c.right,startY:c.top,endY:c.bottom,rotate:g,width:a*m,height:d*h,absolute:c.absolute}};exports.SheetCanvasFloatDomManagerService=class extends l.Disposable{constructor(e,t,n,s,o,a,d){super();ne(this,"_domLayerInfoMap",new Map);ne(this,"_transformChange$",new O.Subject);ne(this,"transformChange$",this._transformChange$.asObservable());ne(this,"_add$",new O.Subject);ne(this,"add$",this._add$.asObservable());ne(this,"_remove$",new O.Subject);ne(this,"remove$",this._remove$.asObservable());this._renderManagerService=e,this._univerInstanceService=t,this._commandService=n,this._drawingManagerService=s,this._canvasFloatDomService=o,this._sheetDrawingService=a,this._lifecycleService=d,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe(O.filter(e=>e===l.LifecycleStages.Rendered),O.take(1)).subscribe(()=>{this._scrollUpdateListener()})}getFloatDomInfo(e){return this._domLayerInfoMap.get(e)}getFloatDomsBySubUnitId(e,t){return Array.from(this._domLayerInfoMap.values()).filter(n=>n.subUnitId===t&&n.unitId===e)}_getSceneAndTransformerByDrawingSearch(e){if(e==null)return;const t=this._renderManagerService.getRenderById(e),n=t==null?void 0:t.scene;if(t==null||n==null)return null;const s=n.getTransformerByCreate(),o=t.engine.getCanvasElement();return{scene:n,transformer:s,renderUnit:t,canvas:o}}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{e.forEach(t=>{var Q;const{unitId:n,subUnitId:s,drawingId:o}=t,a=C.getSheetCommandTarget(this._univerInstanceService,{unitId:n,subUnitId:s}),d=this._drawingManagerService.getDrawingByParam(t),g=this._univerInstanceService.getUnit(n,l.UniverInstanceType.UNIVER_SHEET);if(!g)return;const u=g.getActiveSheet().getSheetId();if(!d||!a)return;const c=(Q=this._renderManagerService.getRenderById(n))==null?void 0:Q.with(E.SheetSkeletonManagerService).getSkeletonParam(s);if(!c)return;const{transform:m,drawingType:h,data:p}=d;if(h!==l.DrawingTypeEnum.DRAWING_DOM&&h!==l.DrawingTypeEnum.DRAWING_CHART)return;const w=this._getSceneAndTransformerByDrawingSearch(n);if(w==null)return;const{scene:f,canvas:v}=w;if(m==null)return!0;if(u!==s)return;const{left:_,top:y,width:T,height:D,angle:M,flipX:I,flipY:A,skewX:b,skewY:P}=m,N=j.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:s,drawingId:o}),U=f.getObject(N);if(U!=null){U.transformByState({left:_,top:y,width:T,height:D,angle:M,flipX:I,flipY:A,skewX:b,skewY:P});return}const R={left:_,top:y,width:T,height:D,zIndex:this._drawingManagerService.getDrawingOrder(n,s).length-1},W=h===l.DrawingTypeEnum.DRAWING_CHART;if(R.rotateEnabled=!1,W){const H=p?p.backgroundColor:"white";R.fill=H,p&&p.border&&(R.stroke=p.border),R.paintFirst="stroke",R.strokeWidth=1,R.borderEnabled=!1,R.radius=8}const L=new x.Rect(N,R);W&&L.setObjectType(x.ObjectType.CHART),f.addObject(L,x.DRAWING_OBJECT_LAYER_INDEX),d.allowTransform!==!1&&f.attachTransformerTo(L);const J=new l.DisposableCollection,ee=oe(L,w.renderUnit.scene,c.skeleton,a.worksheet),K=new O.BehaviorSubject(ee),q=`${Yt}${l.generateRandomId(6)}`,ie={dispose:J,rect:L,position$:K,unitId:n,subUnitId:s,id:o,domId:q};this._canvasFloatDomService.addFloatDom({position$:K,id:o,domId:q,componentKey:d.componentKey,onPointerDown:H=>{v.dispatchEvent(new PointerEvent(H.type,H))},onPointerMove:H=>{v.dispatchEvent(new PointerEvent(H.type,H))},onPointerUp:H=>{v.dispatchEvent(new PointerEvent(H.type,H))},onWheel:H=>{v.dispatchEvent(new WheelEvent(H.type,H))},data:p,unitId:n});const z=L.onTransformChange$.subscribeEvent(()=>{const H=oe(L,w.renderUnit.scene,c.skeleton,a.worksheet);K.next(H)});J.add(()=>{this._canvasFloatDomService.removeFloatDom(o)}),z&&J.add(z),this._domLayerInfoMap.set(o,ie)})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(t=>{var m;const{unitId:n,subUnitId:s,drawingId:o}=t,a=j.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:s,drawingId:o}),d=this._getSceneAndTransformerByDrawingSearch(n);if(d==null)return;const{transformer:g,scene:u}=d,c=u.getObject(a);c!=null&&c.oKey&&(g.clearControlByIds([c==null?void 0:c.oKey]),(m=u.getTransformer())==null||m.clearSelectedObjects())})}))}_scrollUpdateListener(){const e=(t,n)=>{var g;const s=this._getSceneAndTransformerByDrawingSearch(t),o=Array.from(this._domLayerInfoMap.keys()).map(u=>({id:u,...this._domLayerInfoMap.get(u)})).filter(u=>u.subUnitId===n&&u.unitId===t).map(u=>u.id),a=C.getSheetCommandTarget(this._univerInstanceService,{unitId:t,subUnitId:n}),d=(g=this._renderManagerService.getRenderById(t))==null?void 0:g.with(E.SheetSkeletonManagerService).getSkeletonParam(n);!s||!a||!d||o.forEach(u=>{const c=this._domLayerInfoMap.get(u);if(c){const m=oe(c.rect,s.renderUnit.scene,d.skeleton,a.worksheet,c);c.position$.next(m)}})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(O.switchMap(t=>t?t.activeSheet$:O.of(null)),O.map(t=>{if(!t)return null;const n=t.getUnitId(),s=this._renderManagerService.getRenderById(n);return s?{render:s,unitId:n,subUnitId:t.getSheetId()}:null}),O.switchMap(t=>t?l.fromEventSubject(t.render.scene.getViewport(x.SHEET_VIEWPORT_KEY.VIEW_MAIN).onScrollAfter$).pipe(O.map(()=>({unitId:t.unitId,subUnitId:t.subUnitId}))):O.of(null))).subscribe(t=>{if(!t)return;const{unitId:n,subUnitId:s}=t;e(n,s)})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===E.SetZoomRatioOperation.id){const n=t.params,{unitId:s}=n;Array.from(this._domLayerInfoMap.values()).filter(a=>a.unitId===s).map(a=>a.subUnitId).forEach(a=>{e(s,a)})}else if(t.id===C.SetFrozenMutation.id){const{unitId:n,subUnitId:s}=t.params;e(n,s)}else if(t.id===C.SetSelectionsOperation.id){const{unitId:n,subUnitId:s}=t.params;e(n,s)}}))}updateFloatDomProps(e,t,n,s){const o=this._domLayerInfoMap.get(n),a=this._getSceneAndTransformerByDrawingSearch(e);if(o&&a){const{scene:d}=a,g=j.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:t,drawingId:n}),u=d.getObject(g);u&&u instanceof x.Rect&&u.setProps(s)}}_getPosition(e,t){var h;const{startX:n,endX:s,startY:o,endY:a}=e,d=(h=this._renderManagerService.getRenderById(t))==null?void 0:h.with(E.ISheetSelectionRenderService);if(d==null)return;const g=d.getCellWithCoordByOffset(n,o);if(g==null)return;const u={column:g.actualColumn,columnOffset:n-g.startX,row:g.actualRow,rowOffset:o-g.startY},c=d.getCellWithCoordByOffset(s,a);if(c==null)return;const m={column:c.actualColumn,columnOffset:s-c.startX,row:c.actualRow,rowOffset:a-c.startY};return{from:u,to:m}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(t=>{const n=this._drawingManagerService.getDrawingByParam(t);if(!n||n.drawingType!==l.DrawingTypeEnum.DRAWING_DOM&&n.drawingType!==l.DrawingTypeEnum.DRAWING_CHART)return;const s={...n.transform};this._transformChange$.next({id:t.drawingId,value:s}),this._canvasFloatDomService.updateFloatDom(t.drawingId,{...n});const o=this._getSceneAndTransformerByDrawingSearch(t.unitId);if(o&&n.drawingType!==l.DrawingTypeEnum.DRAWING_CHART){const{scene:a}=o,d=this._domLayerInfoMap.get(t.drawingId);d!=null&&d.rect&&(n.allowTransform===!1?a.detachTransformerFrom(d.rect):a.attachTransformerTo(d.rect))}})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(t=>{this._removeDom(t.drawingId)})}))}addFloatDomToPosition(e,t){const n=C.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!n)throw new Error("cannot find current target!");const{unitId:s,subUnitId:o}=n,{initPosition:a,componentKey:d,data:g,allowTransform:u=!0}=e,c=t!=null?t:l.generateRandomId(),m=this._getPosition(a,s);if(m==null)return;const h={unitId:s,subUnitId:o,drawingId:c,drawingType:e.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:d,sheetTransform:m,transform:{left:a.startX,top:a.startY,width:a.endX-a.startX,height:a.endY-a.startY},data:g,allowTransform:u};return this._commandService.executeCommand(Ne.id,{unitId:s,drawings:[h]}),this._add$.next({unitId:s,subUnitId:o,id:c}),{id:c,dispose:()=>{this._removeDom(c,!0)}}}_removeDom(e,t=!1){const n=this._domLayerInfoMap.get(e);if(!n)return;const{unitId:s,subUnitId:o}=n;this._domLayerInfoMap.delete(e),n.dispose.dispose();const a=this._getSceneAndTransformerByDrawingSearch(s);if(a&&a.scene.removeObject(n.rect),t){const d=this._drawingManagerService.getDrawingByParam({unitId:s,subUnitId:o,drawingId:e});if(!d)return;const g=this._sheetDrawingService.getBatchRemoveOp([d]),{redo:u,objects:c}=g;this._commandService.syncExecuteCommand(S.SetDrawingApplyMutation.id,{unitId:s,subUnitId:o,op:u,objects:c,type:S.DrawingApplyType.REMOVE})}}addFloatDomToRange(e,t,n,s){var I,A,b;const o=C.getSheetCommandTarget(this._univerInstanceService,{unitId:t.unitId,subUnitId:t.subUnitId});if(!o)throw new Error("cannot find current target!");const{unitId:a,subUnitId:d}=o,g=this._getSceneAndTransformerByDrawingSearch(a);if(!g)return;const u=this._renderManagerService.getRenderById(a);if(!u)return;const c=(I=this._renderManagerService.getRenderById(a))==null?void 0:I.with(E.SheetSkeletonManagerService).getWorksheetSkeleton(d);if(!c)return;const{componentKey:m,data:h,allowTransform:p=!0}=t,w=s!=null?s:l.generateRandomId(),{position:f,position$:v}=this._createRangePositionObserver(e,u,c.skeleton);if(this._getPosition(f,a)==null)return;const y=g.scene,{scaleX:T}=y.getAncestorScale(),D=qe(f,n,T),M={unitId:a,subUnitId:d,drawingId:w,drawingType:t.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:m,transform:{left:D.startX,top:D.startY,width:D.width,height:D.height},data:h,allowTransform:p};{const{unitId:P,subUnitId:N,drawingId:U}=M,R=C.getSheetCommandTarget(this._univerInstanceService,{unitId:P,subUnitId:N}),W=M,L=this._univerInstanceService.getUnit(P,l.UniverInstanceType.UNIVER_SHEET);if(!L)return;const J=L.getActiveSheet().getSheetId();if(!W||!R)return;const ee=(A=this._renderManagerService.getRenderById(P))==null?void 0:A.with(E.SheetSkeletonManagerService);if(!ee)return;const K=ee.getWorksheetSkeleton(N);if(!K)return;const{transform:q,drawingType:ie,data:z}=W;if(ie!==l.DrawingTypeEnum.DRAWING_DOM&&ie!==l.DrawingTypeEnum.DRAWING_CHART)return;const Q=this._getSceneAndTransformerByDrawingSearch(P);if(Q==null)return;const{scene:H,canvas:fe}=Q;if(q==null||J!==N)return;const{left:We,top:$e,width:Be,height:Le,angle:dt,flipX:lt,flipY:Fe,skewX:Ye,skewY:we}=q,Ge=j.getDrawingShapeKeyByDrawingSearch({unitId:P,subUnitId:N,drawingId:U}),ae=H.getObject(Ge);if(ae!=null){ae.transformByState({left:We,top:$e,width:Be,height:Le,angle:dt,flipX:lt,flipY:Fe,skewX:Ye,skewY:we});return}const te={left:We,top:$e,width:Be,height:Le,zIndex:this._drawingManagerService.getDrawingOrder(P,N).length-1},Se=ie===l.DrawingTypeEnum.DRAWING_CHART;if(Se){const $=z?z.backgroundColor:"white";te.fill=$,te.rotateEnabled=!1,z&&z.border&&(te.stroke=z.border),te.paintFirst="stroke",te.strokeWidth=1,te.borderEnabled=!1,te.radius=8}const ce=new x.Rect(Ge,te);Se&&ce.setObjectType(x.ObjectType.CHART),H.addObject(ce,x.DRAWING_OBJECT_LAYER_INDEX),W.allowTransform!==!1&&H.attachTransformerTo(ce);const de=new l.DisposableCollection,He=H.getMainViewport(),{rowHeaderWidth:ve,columnHeaderHeight:Re}=K.skeleton,Ve={top:Re,left:ve,bottom:He.bottom,right:He.right},le={dispose:de,rect:ce,boundsOfViewArea:Ve,domAnchor:n,unitId:P,subUnitId:N},V=oe(ce,Q.renderUnit.scene,K.skeleton,R.worksheet,le),_e=new O.BehaviorSubject(V);le.position$=_e;let be={position$:_e,id:U,componentKey:W.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:$=>{fe.dispatchEvent(new WheelEvent($.type,$))},data:z,unitId:P};t.eventPassThrough&&(be={...be,onPointerDown:$=>{fe.dispatchEvent(new PointerEvent($.type,$))},onPointerMove:$=>{fe.dispatchEvent(new PointerEvent($.type,$))},onPointerUp:$=>{fe.dispatchEvent(new PointerEvent($.type,$))}}),this._canvasFloatDomService.addFloatDom(be),this.disposeWithMe(v.subscribe($=>{var Et,Ot,Ut,At;const bt=qe({startX:$.startX,startY:$.startY,endX:$.endX,endY:$.endY,width:(Et=n.width)!=null?Et:$.width,height:(Ot=n.height)!=null?Ot:$.height,absolute:{left:f.absolute.left,top:f.absolute.top}},n),zt=j.getDrawingShapeKeyByDrawingSearch({unitId:P,subUnitId:N,drawingId:U}),qt=new x.Rect(zt,{left:bt.startX,top:bt.startY,width:(Ut=n.width)!=null?Ut:$.width,height:(At=n.height)!=null?At:$.height,zIndex:this._drawingManagerService.getDrawingOrder(P,N).length-1}),Zt=oe(qt,Q.renderUnit.scene,K.skeleton,R.worksheet,le);_e.next(Zt)}));const Ee=(b=this._renderManagerService.getRenderById(P))==null?void 0:b.with(E.SheetSkeletonManagerService);Ee==null||Ee.currentSkeleton$.subscribe($=>{$&&K.sheetId!==$.sheetId&&this._removeDom(w,!0)});const Xe=ce.onTransformChange$.subscribeEvent(()=>{const $=oe(ce,Q.renderUnit.scene,K.skeleton,R.worksheet,le);_e.next($)});de.add(()=>{this._canvasFloatDomService.removeFloatDom(U)}),Xe&&de.add(Xe),this._domLayerInfoMap.set(U,le)}return{id:w,dispose:()=>{this._removeDom(w,!0)}}}addFloatDomToColumnHeader(e,t,n,s){var D,M,I;const o=C.getSheetCommandTarget(this._univerInstanceService,{unitId:t.unitId,subUnitId:t.subUnitId});if(!o)throw new Error("cannot find current target!");const{unitId:a,subUnitId:d}=o;if(!this._getSceneAndTransformerByDrawingSearch(a))return;const u=this._renderManagerService.getRenderById(a);if(!u)return;const c=(D=this._renderManagerService.getRenderById(a))==null?void 0:D.with(E.SheetSkeletonManagerService).getWorksheetSkeleton(d);if(!c)return;const{componentKey:m,data:h,allowTransform:p=!0}=t,w=s!=null?s:l.generateRandomId(),{position:f,position$:v}=this._createRangePositionObserver({startRow:0,endRow:0,startColumn:e,endColumn:e},u,c.skeleton),_=f;if(_.startY=0,this._getPosition(f,a)==null)return;const T={unitId:a,subUnitId:d,drawingId:w,drawingType:t.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:m,transform:{left:_.startX,top:_.startY,width:_.width,height:_.height},data:h,allowTransform:p};{const{unitId:A,subUnitId:b,drawingId:P}=T,N=C.getSheetCommandTarget(this._univerInstanceService,{unitId:A,subUnitId:b}),U=T,R=this._univerInstanceService.getUnit(A,l.UniverInstanceType.UNIVER_SHEET);if(!R)return;const W=R.getActiveSheet().getSheetId();if(!U||!N)return;const L=(M=this._renderManagerService.getRenderById(A))==null?void 0:M.with(E.SheetSkeletonManagerService);if(!L)return;const J=L.getWorksheetSkeleton(b);if(!J)return;const{transform:ee,data:K}=U,q=this._getSceneAndTransformerByDrawingSearch(A);if(q==null)return;const{scene:ie,canvas:z}=q;if(ee==null||W!==b)return;const{left:Q,top:H,width:fe,height:We,angle:$e,flipX:Be,flipY:Le,skewX:dt,skewY:lt}=ee,Fe=j.getDrawingShapeKeyByDrawingSearch({unitId:A,subUnitId:b,drawingId:P}),Ye=ie.getObject(Fe);if(Ye!=null){Ye.transformByState({left:Q,top:H,width:fe,height:We,angle:$e,flipX:Be,flipY:Le,skewX:dt,skewY:lt});return}const we=qe({startX:_.startX,startY:0,endX:f.endX,endY:f.endY,width:n.width,height:n.height,absolute:{left:f.absolute.left,top:f.absolute.top}},n),Ge={left:we.startX,top:we.startY,width:we.width,height:we.height,zIndex:this._drawingManagerService.getDrawingOrder(A,b).length-1},ae=new x.Rect(Fe,Ge);ie.addObject(ae,x.DRAWING_OBJECT_LAYER_INDEX),U.allowTransform!==!1&&ie.attachTransformerTo(ae);const te=new l.DisposableCollection,Se=ie.getMainViewport(),ce={top:0,left:Se.left,bottom:Se.bottom,right:Se.right},de={dispose:te,rect:ae,unitId:A,subUnitId:b,boundsOfViewArea:ce,domAnchor:n,scrollDirectionResponse:"HORIZONTAL"},He=oe(ae,q.renderUnit.scene,J.skeleton,N.worksheet,de),ve=new O.BehaviorSubject(He);de.position$=ve;let Re={position$:ve,id:P,componentKey:U.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:V=>{z.dispatchEvent(new WheelEvent(V.type,V))},data:K,unitId:A};t.eventPassThrough&&(Re={...Re,onPointerDown:V=>{z.dispatchEvent(new PointerEvent(V.type,V))},onPointerMove:V=>{z.dispatchEvent(new PointerEvent(V.type,V))},onPointerUp:V=>{z.dispatchEvent(new PointerEvent(V.type,V))}}),this._canvasFloatDomService.addFloatDom(Re);const Ve=ae.onTransformChange$.subscribeEvent(()=>{const V=oe(ae,q.renderUnit.scene,J.skeleton,N.worksheet,de);ve.next(V)});this.disposeWithMe(v.subscribe(V=>{const _e=qe({startX:V.startX,startY:0,endX:V.endX,endY:V.endY,width:n.width,height:n.height,absolute:{left:f.absolute.left,top:f.absolute.top}},n),be=j.getDrawingShapeKeyByDrawingSearch({unitId:A,subUnitId:b,drawingId:P}),Ee=new x.Rect(be,{left:_e.startX,top:0,width:n.width,height:n.height,zIndex:this._drawingManagerService.getDrawingOrder(A,b).length-1}),Xe=oe(Ee,q.renderUnit.scene,J.skeleton,N.worksheet,de);ve.next(Xe)}));const le=(I=this._renderManagerService.getRenderById(A))==null?void 0:I.with(E.SheetSkeletonManagerService);le==null||le.currentSkeleton$.subscribe(V=>{V&&c.sheetId!==V.sheetId&&this._removeDom(w,!0)}),te.add(()=>{this._canvasFloatDomService.removeFloatDom(P)}),Ve&&te.add(Ve),this._domLayerInfoMap.set(P,de)}return{id:w,dispose:()=>{this._removeDom(w,!0)}}}_createRangePositionObserver(e,t,n){let{startRow:s,startColumn:o}=e;const a=Pe(s,o,n),d=new O.BehaviorSubject(a),g=Pe(e.endRow,e.endColumn,n),u=new O.BehaviorSubject(g),c=()=>{const v=Pe(s,o,n),_=Pe(e.endRow,e.endColumn,n);d.next(v),u.next(_)},m=new l.DisposableCollection;m.add(t.engine.clientRect$.subscribe(()=>c())),m.add(this._commandService.onCommandExecuted(v=>{if(v.id===C.SetWorksheetRowAutoHeightMutation.id&&v.params.rowsAutoHeightInfo.findIndex(y=>y.row===s)>-1){c();return}(C.COMMAND_LISTENER_SKELETON_CHANGE.indexOf(v.id)>-1||v.id===E.SetScrollOperation.id||v.id===E.SetZoomRatioOperation.id)&&c()}));const h=(v,_)=>{s=v,o=_,c()},p=()=>({rotate:0,width:g.right-a.left,height:g.bottom-a.top,absolute:{left:!0,top:!0},startX:a.left,startY:a.top,endX:g.right,endY:g.bottom}),w=d.pipe(O.map(v=>{const _=Pe(e.endRow,e.endColumn,n);return{rotate:0,width:_.right-v.left,height:_.bottom-v.top,absolute:{left:!0,top:!0},startX:v.left,startY:v.top,endX:_.right,endY:_.bottom}})),f=p();return{position$:w,position:f,updateRowCol:h,topLeftPos$:d,rightBottomPos$:u,disposable:m}}};exports.SheetCanvasFloatDomManagerService=Un([me(0,l.Inject(x.IRenderManagerService)),me(1,l.IUniverInstanceService),me(2,l.Inject(l.ICommandService)),me(3,j.IDrawingManagerService),me(4,l.Inject(k.CanvasFloatDomService)),me(5,S.ISheetDrawingService),me(6,l.Inject(l.LifecycleService))],exports.SheetCanvasFloatDomManagerService);function Pe(i,r,e){const t=e.getCellWithCoordByIndex(i,r),n=t.isMergedMainCell?t.mergeInfo:t;return{left:n.startX,right:n.endX,top:n.startY,bottom:n.endY}}function qe(i,r,e){var g,u;e=e!=null?e:1;const t=i.endX-i.startX,n=i.endY-i.startY,s=(g=r==null?void 0:r.width)!=null?g:t,o=(u=r==null?void 0:r.height)!=null?u:n;let a=0,d=0;if(r){if(r.horizonOffsetAlign==="right"){const c=Ze(r.marginX,t*e);a=i.endX-c-s}else a=i.startX+Ze(r.marginX,t);if(r.verticalOffsetAlign==="bottom"){const c=Ze(r.marginY,n*e);d=i.endY-c-o}else d=i.startY+Ze(r.marginY,n)}return{rotate:0,startX:a,startY:d,endX:i.endX,endY:i.endY,width:s,height:o,absolute:{left:i.absolute.left,top:i.absolute.top}}}function Ze(i,r){if(i===void 0)return 0;if(typeof i=="number")return i;const e=Number.parseFloat(i);return r*e/100}const An=i=>{const{floatDomInfos:r,scene:e,skeleton:t,worksheet:n}=i,s=G.useMemo(()=>r.map(o=>{const{width:a,height:d,angle:g,left:u,top:c}=o.transform,m=Gt({left:u!=null?u:0,right:(u!=null?u:0)+(a!=null?a:0),top:c!=null?c:0,bottom:(c!=null?c:0)+(d!=null?d:0)},e,t,n,void 0,!0),{scaleX:h,scaleY:p}=e.getAncestorScale(),w={startX:m.left,endX:m.right,startY:m.top,endY:m.bottom,rotate:g,width:a*h,height:d*p,absolute:m.absolute},f={position$:new O.BehaviorSubject(w),position:w,id:o.drawingId,componentKey:o.componentKey,onPointerMove:()=>{},onPointerDown:()=>{},onPointerUp:()=>{},onWheel:()=>{},unitId:o.unitId,data:o.data};return[o.drawingId,f]}),[r,e,t,n]);return B.jsx("div",{style:{position:"absolute",top:0,left:0},children:s.map(([o,a])=>B.jsx(k.PrintFloatDomSingle,{layer:a,id:o,position:a.position},o))})};var Pn=Object.getOwnPropertyDescriptor,Nn=(i,r,e,t)=>{for(var n=t>1?void 0:t?Pn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},pe=(i,r)=>(e,t)=>r(e,t,i);let ot=class extends l.Disposable{constructor(i,r,e,t,n,s,o){super(),this._sheetPrintInterceptorService=i,this._drawingRenderService=r,this._drawingManagerService=e,this._renderManagerService=t,this._canvasFloatDomManagerService=n,this._componetManager=s,this._injector=o,this._initPrinting(),this._initPrintingDom()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(i,r,e)=>{const{unitId:t,scene:n,subUnitId:s}=r,o=this._drawingManagerService.getDrawingDataForUnit(t),a=o==null?void 0:o[s];return a&&a.order.forEach(d=>{const g=a.data[d];g.drawingType!==l.DrawingTypeEnum.DRAWING_CHART&&g.drawingType!==l.DrawingTypeEnum.DRAWING_DOM&&this._drawingRenderService.renderDrawing(g,n)}),e()}})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:(i,r,e)=>{const{unitId:t,subUnitId:n}=r,s=this._renderManagerService.getRenderById(t);if(!s)return e(i);const o=s.with(E.SheetSkeletonManagerService).getSkeletonParam(n);if(!o)return e(i);const a=this._drawingManagerService.getDrawingDataForUnit(t),d=a==null?void 0:a[r.subUnitId];if(!d)return e(i);const{scaleX:g,scaleY:u}=s.scene,c=i?{...i}:{startColumn:0,endColumn:0,endRow:0,startRow:0},m=d.order.map(h=>d.data[h]);return m.length?(m.forEach(h=>{if(!h.groupId&&h.transform&&l.Tools.isDefine(h.transform.left)&&l.Tools.isDefine(h.transform.top)&&l.Tools.isDefine(h.transform.width)&&l.Tools.isDefine(h.transform.height)){const p=o.skeleton.getCellIndexByOffset(h.transform.left,h.transform.top,g,u,{x:0,y:0}),w=o.skeleton.getCellIndexByOffset(h.transform.left+h.transform.width,h.transform.top+h.transform.height,g,u,{x:0,y:0});p.column<c.startColumn&&(c.startColumn=p.column),p.row<c.startRow&&(c.startRow=p.row),c.endRow<w.row&&(c.endRow=w.row),c.endColumn<w.column&&(c.endColumn=w.column)}}),e(c)):e(i)}}))}_initPrintingDom(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_DOM_COLLECT,{handler:(i,r,e)=>{const{unitId:t,subUnitId:n}=r,s=this._drawingManagerService.getDrawingDataForUnit(t),o=s==null?void 0:s[n];if(o){const a=o.order.map(g=>{const u=o.data[g];if(u.drawingType===l.DrawingTypeEnum.DRAWING_CHART)return{...u,componentKey:this._componetManager.get(l.PRINT_CHART_COMPONENT_KEY)};if(u.drawingType===l.DrawingTypeEnum.DRAWING_DOM){const c=this._sheetPrintInterceptorService.getPrintComponent(u.componentKey);return{...u,componentKey:this._componetManager.get(c||u.componentKey)}}return null}).filter(Boolean),d=k.connectInjector(An,this._injector);return F.render(B.jsx(d,{floatDomInfos:a,scene:r.scene,skeleton:r.skeleton,worksheet:r.worksheet}),r.root),i==null||i.add(()=>{F.unmount(r.root)}),e(i)}}}))}};ot=Nn([pe(0,l.Inject(E.SheetPrintInterceptorService)),pe(1,l.Inject(he.DrawingRenderService)),pe(2,j.IDrawingManagerService),pe(3,x.IRenderManagerService),pe(4,l.Inject(exports.SheetCanvasFloatDomManagerService)),pe(5,l.Inject(k.ComponentManager)),pe(6,l.Inject(l.Injector))],ot);var jn=Object.getOwnPropertyDescriptor,kn=(i,r,e,t)=>{for(var n=t>1?void 0:t?jn(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},ue=(i,r)=>(e,t)=>r(e,t,i);const xn=[C.InsertRowCommand.id,C.InsertColCommand.id,C.RemoveRowCommand.id,C.RemoveColCommand.id,C.DeleteRangeMoveLeftCommand.id,C.DeleteRangeMoveUpCommand.id,C.InsertRangeMoveDownCommand.id,C.InsertRangeMoveRightCommand.id,C.DeltaRowHeightCommand.id,C.SetRowHeightCommand.id,C.DeltaColumnWidthCommand.id,C.SetColWidthCommand.id,C.SetRowHiddenCommand.id,C.SetSpecificRowsVisibleCommand.id,C.SetSpecificColsVisibleCommand.id,C.SetColHiddenCommand.id,C.MoveColsCommand.id,C.MoveRowsCommand.id,C.MoveRangeCommand.id],Wn=[C.SetRowVisibleMutation.id,C.SetRowHiddenMutation.id,C.SetColVisibleMutation.id,C.SetColHiddenMutation.id,C.SetWorksheetRowHeightMutation.id,C.SetWorksheetColWidthMutation.id];let vt=class extends l.Disposable{constructor(i,r,e,t,n,s,o,a,d){super(),this._context=i,this._renderManagerService=r,this._commandService=e,this._selectionRenderService=t,this._skeletonManagerService=n,this._sheetInterceptorService=s,this._sheetDrawingService=o,this._drawingManagerService=a,this._univerInstanceService=d,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptAfterCommand({getMutations:i=>{if(!xn.includes(i.id))return{redos:[],undos:[]};if(i.params==null)return{redos:[],undos:[]};const r=i.id;if(r===C.InsertRowCommand.id)return this._moveRowInterceptor(i.params,"insert");if([C.MoveColsCommand.id,C.MoveRowsCommand.id,C.MoveRangeCommand.id].includes(r))return this._moveRangeInterceptor(i.params);if(r===C.InsertColCommand.id)return this._moveColInterceptor(i.params,"insert");if(r===C.RemoveRowCommand.id)return this._moveRowInterceptor(i.params,"remove");if(r===C.RemoveColCommand.id)return this._moveColInterceptor(i.params,"remove");if(r===C.DeleteRangeMoveLeftCommand.id){const{range:e}=i.params;return this._getRangeMoveUndo(e,0)}else if(r===C.DeleteRangeMoveUpCommand.id){const{range:e}=i.params;return this._getRangeMoveUndo(e,1)}else if(r===C.InsertRangeMoveDownCommand.id){const{range:e}=i.params;return this._getRangeMoveUndo(e,2)}else if(r===C.InsertRangeMoveRightCommand.id){const{range:e}=i.params;return this._getRangeMoveUndo(e,3)}else if(r===C.SetRowHiddenCommand.id||r===C.SetSpecificRowsVisibleCommand.id){const e=i.params,{unitId:t,subUnitId:n,ranges:s}=e;return this._getDrawingUndoForRowVisible(t,n,s)}else if(r===C.SetSpecificColsVisibleCommand.id||r===C.SetColHiddenCommand.id){const e=i.params,{unitId:t,subUnitId:n,ranges:s}=e;return this._getDrawingUndoForColVisible(t,n,s)}else if(r===C.DeltaRowHeightCommand.id||r===C.SetRowHeightCommand.id||r===C.DeltaColumnWidthCommand.id||r===C.SetColWidthCommand.id){const e=i.params,{unitId:t,subUnitId:n,ranges:s}=e,o=r===C.DeltaRowHeightCommand.id||r===C.SetRowHeightCommand.id;return this._getDrawingUndoForRowAndColSize(t,n,s,o)}return{redos:[],undos:[]}}}))}_getRangeMoveUndo(i,r){const e=C.getSheetCommandTarget(this._univerInstanceService);if(e==null)return{redos:[],undos:[]};const t=e.unitId,n=e.subUnitId,s=[],o=[],a=this._sheetDrawingService.getDrawingData(t,n),d=[],g=[];if(Object.keys(a).forEach(u=>{const c=a[u],{updateDrawings:m,deleteDrawings:h}=this._getUpdateOrDeleteDrawings(i,r,c);d.push(...m),g.push(...h)}),d.length===0&&g.length===0)return{redos:[],undos:[]};if(d.length>0){const u=this._sheetDrawingService.getBatchUpdateOp(d),{undo:c,redo:m,objects:h}=u;s.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:m,objects:h,type:S.DrawingApplyType.UPDATE}}),o.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:c,objects:h,type:S.DrawingApplyType.UPDATE}})}if(g.length>0){const u=this._sheetDrawingService.getBatchRemoveOp(g),c=u.undo,m=u.redo,h=u.objects;s.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:m,objects:h,type:S.DrawingApplyType.REMOVE}}),o.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:c,objects:h,type:S.DrawingApplyType.INSERT}})}return s.push({id:X.id,params:[t]}),o.push({id:X.id,params:[t]}),{redos:s,undos:o}}_getUpdateOrDeleteDrawings(i,r,e){const t=[],n=[],{sheetTransform:s,anchorType:o=S.SheetDrawingAnchorType.Position,transform:a,unitId:d,subUnitId:g,drawingId:u}=e,{from:c,to:m}=s,{row:h,column:p}=c,{row:w,column:f}=m;if(s==null||a==null)return{updateDrawings:t,deleteDrawings:n};const{startRow:v,endRow:_,startColumn:y,endColumn:T}=i;let D=null,M=null;if(r===0&&h>=v&&w<=_)if(p>=y&&f<=T)n.push({unitId:d,subUnitId:g,drawingId:u});else{const I=this._shrinkCol(s,a,y,T,o);D=I==null?void 0:I.newSheetTransform,M=I==null?void 0:I.newTransform}else if(r===1&&p>=y&&f<=T)if(h>=v&&w<=_)n.push({unitId:d,subUnitId:g,drawingId:u});else{const I=this._shrinkRow(s,a,v,_,o);D=I==null?void 0:I.newSheetTransform,M=I==null?void 0:I.newTransform}else if(r===2){const I=this._expandRow(s,a,v,_,o);D=I==null?void 0:I.newSheetTransform,M=I==null?void 0:I.newTransform}else if(r===3){const I=this._expandCol(s,a,y,T,o);D=I==null?void 0:I.newSheetTransform,M=I==null?void 0:I.newTransform}if(D!=null&&M!=null){const I=Z(D,this._selectionRenderService,this._skeletonManagerService);t.push({...e,sheetTransform:D,transform:I})}return{updateDrawings:t,deleteDrawings:n}}_remainDrawingSize(i,r,e){const t=Y({...i},this._selectionRenderService);t!=null&&r.push({...e,sheetTransform:t})}_getDrawingUndoForColVisible(i,r,e){const t=this._drawingManagerService.getDrawingData(i,r),n=[],s=[];if(Object.keys(t).forEach(u=>{const c=t[u],{sheetTransform:m,transform:h,anchorType:p=S.SheetDrawingAnchorType.Position}=c;if(p===S.SheetDrawingAnchorType.None)this._remainDrawingSize(h,n,c);else{const{from:w,to:f}=m,{row:v,column:_}=w,{row:y,column:T}=f;for(let D=0;D<e.length;D++){const M=e[D],{startRow:I,endRow:A,startColumn:b,endColumn:P}=M;if(T<b)continue;if(p===S.SheetDrawingAnchorType.Position){let R=null,W=null;if(_>=b&&_<=P){const L=this._skeletonManagerService.attachRangeWithCoord({startColumn:_,endColumn:P,startRow:w.row,endRow:f.row});if(L==null)return;W={...h,left:L.startX}}if(W!=null&&(R=Y(W,this._selectionRenderService),R!=null&&W!=null)){n.push({...c,sheetTransform:R,transform:W});break}this._remainDrawingSize(h,n,c);continue}if(_>=b&&T<=P)continue;let N=null,U=null;if(_>=b&&_<=P){const R=this._skeletonManagerService.attachRangeWithCoord({startColumn:_,endColumn:P,startRow:w.row,endRow:f.row});if(R==null)return;U={...h,left:(R==null?void 0:R.startX)||0,width:((h==null?void 0:h.width)||0)-R.endX+R.startX}}else if(T>=b&&T<=P){const R=this._skeletonManagerService.attachRangeWithCoord({startColumn:b,endColumn:T,startRow:w.row,endRow:f.row});if(R==null)return;U={...h,left:R.startX-((h==null?void 0:h.width)||0)}}else{const R=this._skeletonManagerService.attachRangeWithCoord({startColumn:b,endColumn:P,startRow:w.row,endRow:f.row});if(R==null)return;if(U={...h,width:((h==null?void 0:h.width)||0)-R.endX+R.startX},N=Y(U,this._selectionRenderService),N!=null&&U!=null){s.push({...c,sheetTransform:N,transform:U});break}}if(U!=null&&(N=Y(U,this._selectionRenderService)),U!=null&&N!=null){n.push({...c,sheetTransform:N,transform:U});break}else this._remainDrawingSize(h,n,c)}}}),n.length===0&&s.length===0)return{redos:[],undos:[]};const{redos:o,undos:a}=this._createUndoAndRedoMutation(i,r,n),d=[],g=[];if(s.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,s);d.push(...u),g.push(...c)}return{redos:o,undos:a,preRedos:d,preUndos:g}}_createUndoAndRedoMutation(i,r,e){const t=this._sheetDrawingService.getBatchUpdateOp(e),{undo:n,redo:s,objects:o}=t,a=[{id:S.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:s,objects:o,type:S.DrawingApplyType.UPDATE}},{id:X.id,params:[i]}],d=[{id:S.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:n,objects:o,type:S.DrawingApplyType.UPDATE}},{id:X.id,params:[i]}];return{redos:a,undos:d}}_getDrawingUndoForRowVisible(i,r,e){const t=this._drawingManagerService.getDrawingData(i,r),n=[],s=[];if(Object.keys(t).forEach(u=>{const c=t[u],{sheetTransform:m,transform:h,anchorType:p=S.SheetDrawingAnchorType.Position}=c;if(p===S.SheetDrawingAnchorType.None)this._remainDrawingSize(h,n,c);else{const{from:w,to:f}=m,{row:v,column:_}=w,{row:y,column:T}=f;for(let D=0;D<e.length;D++){const M=e[D],{startRow:I,endRow:A,startColumn:b,endColumn:P}=M;if(y<I)continue;if(p===S.SheetDrawingAnchorType.Position){let R=null,W=null;if(v>=I&&v<=A){const L=this._skeletonManagerService.attachRangeWithCoord({startColumn:w.column,endColumn:f.column,startRow:v,endRow:A});if(L==null)return;W={...h,top:L.startY}}if(W!=null&&(R=Y(W,this._selectionRenderService),R!=null&&W!=null)){n.push({...c,sheetTransform:R,transform:W});break}this._remainDrawingSize(h,n,c);continue}if(v>=I&&y<=A)continue;let N=null,U=null;if(v>=I&&v<=A){const R=this._skeletonManagerService.attachRangeWithCoord({startColumn:w.column,endColumn:f.column,startRow:v,endRow:A});if(R==null)return;U={...h,top:(R==null?void 0:R.startY)||0,height:((h==null?void 0:h.height)||0)-R.endY+R.startY}}else if(y>=I&&y<=A){const R=this._skeletonManagerService.attachRangeWithCoord({startColumn:w.column,endColumn:f.column,startRow:I,endRow:y});if(R==null)return;U={...h,top:R.startY-((h==null?void 0:h.height)||0)}}else{const R=this._skeletonManagerService.attachRangeWithCoord({startColumn:w.column,endColumn:f.column,startRow:I,endRow:A});if(R==null)return;if(U={...h,height:((h==null?void 0:h.height)||0)-R.endY+R.startY},N=Y(U,this._selectionRenderService),N!=null&&U!=null){s.push({...c,sheetTransform:N,transform:U});break}}if(U!=null&&(N=Y(U,this._selectionRenderService)),U!=null&&N!=null){n.push({...c,sheetTransform:N,transform:U});break}else this._remainDrawingSize(h,n,c)}}}),n.length===0&&s.length===0)return{redos:[],undos:[]};const{redos:o,undos:a}=this._createUndoAndRedoMutation(i,r,n),d=[],g=[];if(s.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,s);d.push(...u),g.push(...c)}return{redos:o,undos:a,preRedos:d,preUndos:g}}_getDrawingUndoForRowAndColSize(i,r,e,t){const n=this._drawingManagerService.getDrawingData(i,r),s=[];return Object.keys(n).forEach(o=>{const a=n[o],{sheetTransform:d,transform:g,anchorType:u=S.SheetDrawingAnchorType.Position}=a;if(u===S.SheetDrawingAnchorType.None)this._remainDrawingSize(g,s,a);else{const{from:c,to:m}=d,{row:h,column:p}=c,{row:w,column:f}=m;for(let v=0;v<e.length;v++){const _=e[v],{startRow:y,endRow:T,startColumn:D,endColumn:M}=_;if(w<y||f<D)continue;if(u===S.SheetDrawingAnchorType.Position&&(h<=y&&w>=T||p<=D&&f>=M)){this._remainDrawingSize(g,s,a);continue}const I=Z({...d},this._selectionRenderService,this._skeletonManagerService);if(I!=null){s.push({...a,transform:I});break}}}}),s.length===0?{redos:[],undos:[]}:this._createUndoAndRedoMutation(i,r,s)}_getUnitIdAndSubUnitId(i,r){let e,t;if(r==="insert")e=i.unitId,t=i.subUnitId;else{const n=C.getSheetCommandTarget(this._univerInstanceService);if(n==null)return;e=n.unitId,t=n.subUnitId}return{unitId:e,subUnitId:t}}_moveRangeInterceptor(i){var y,T;const{toRange:r,fromRange:e}=i,t=C.getSheetCommandTarget(this._univerInstanceService);if(!t)return{redos:[],undos:[]};const{unitId:n,subUnitId:s}=t,o=(T=(y=this._renderManagerService.getRenderById(n))==null?void 0:y.with(E.SheetSkeletonManagerService))==null?void 0:T.getCurrentSkeleton();if(!o)return{redos:[],undos:[]};const a=E.attachRangeWithCoord(o,e);if(!a)return{redos:[],undos:[]};const{startX:d,endX:g,startY:u,endY:c}=a,m=this._sheetDrawingService.getDrawingData(n,s),h=[];Object.keys(m).forEach(D=>{const M=m[D];if(M.anchorType!==S.SheetDrawingAnchorType.Both)return;const{transform:I}=M;if(!I)return;const{left:A=0,top:b=0,width:P=0,height:N=0}=I,{drawingStartX:U,drawingEndX:R,drawingStartY:W,drawingEndY:L}={drawingStartX:A,drawingEndX:A+P,drawingStartY:b,drawingEndY:b+N};d<=U&&R<=g&&u<=W&&L<=c&&h.push(M)});const p=[],w=[],f=r.startRow-e.startRow,v=r.startColumn-e.startColumn,_=h.map(D=>{const M=D.sheetTransform,I={to:{...M.to,row:M.to.row+f,column:M.to.column+v},from:{...M.from,row:M.from.row+f,column:M.from.column+v}},A=Z(I,this._selectionRenderService,this._skeletonManagerService);return{unitId:n,subUnitId:s,drawingId:D.drawingId,transform:A,sheetTransform:I}});if(_.length){const D=this._sheetDrawingService.getBatchUpdateOp(_),{undo:M,redo:I,objects:A}=D;p.push({id:S.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:s,op:I,objects:A,type:S.DrawingApplyType.UPDATE}}),w.push({id:S.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:s,op:M,objects:A,type:S.DrawingApplyType.UPDATE}})}return{redos:p,undos:w}}_moveRowInterceptor(i,r){const e=this._getUnitIdAndSubUnitId(i,r);if(e==null)return{redos:[],undos:[]};const{unitId:t,subUnitId:n}=e,{range:s}=i,o=s.startRow,a=s.endRow,d=[],g=[],u=this._sheetDrawingService.getDrawingData(t,n),c=[],m=[];if(Object.keys(u).forEach(h=>{const p=u[h],{sheetTransform:w,transform:f,anchorType:v=S.SheetDrawingAnchorType.Position}=p;if(w==null||f==null)return;let _,y;if(r==="insert"){const D=this._expandRow(w,f,o,a,v);_=D==null?void 0:D.newSheetTransform,y=D==null?void 0:D.newTransform}else{const{from:D,to:M}=w,{row:I}=D,{row:A}=M;if(v===S.SheetDrawingAnchorType.Both&&I>=o&&A<=a)m.push({unitId:t,subUnitId:n,drawingId:h});else{const b=this._shrinkRow(w,f,o,a,v);_=b==null?void 0:b.newSheetTransform,y=b==null?void 0:b.newTransform}}if(!_||!y)return;const T={unitId:t,subUnitId:n,drawingId:h,transform:y,sheetTransform:_};c.push(T)}),c.length===0&&m.length===0)return{redos:[],undos:[]};if(c.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(c),{undo:p,redo:w,objects:f}=h;d.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:w,objects:f,type:S.DrawingApplyType.UPDATE}}),g.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:p,objects:f,type:S.DrawingApplyType.UPDATE}})}if(m.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(m),p=h.undo,w=h.redo,f=h.objects;d.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:w,objects:f,type:S.DrawingApplyType.REMOVE}}),g.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:p,objects:f,type:S.DrawingApplyType.INSERT}})}return d.push({id:X.id,params:[t]}),g.push({id:X.id,params:[t]}),{redos:d,undos:g}}_moveColInterceptor(i,r){const e=this._getUnitIdAndSubUnitId(i,r);if(e==null)return{redos:[],undos:[]};const{unitId:t,subUnitId:n}=e,{range:s}=i,o=s.startColumn,a=s.endColumn,d=[],g=[],u=this._sheetDrawingService.getDrawingData(t,n),c=[],m=[];if(Object.keys(u).forEach(h=>{const p=u[h],{sheetTransform:w,transform:f,anchorType:v=S.SheetDrawingAnchorType.Position}=p;if(w==null||f==null)return;let _,y;if(r==="insert"){const D=this._expandCol(w,f,o,a,v);_=D==null?void 0:D.newSheetTransform,y=D==null?void 0:D.newTransform}else{const{from:D,to:M}=w,{column:I}=D,{column:A}=M;if(v===S.SheetDrawingAnchorType.Both&&I>=o&&A<=a)m.push({unitId:t,subUnitId:n,drawingId:h});else{const b=this._shrinkCol(w,f,o,a,v);_=b==null?void 0:b.newSheetTransform,y=b==null?void 0:b.newTransform}}if(!_||!y)return;const T={unitId:t,subUnitId:n,drawingId:h,transform:y,sheetTransform:_};c.push(T)}),c.length===0&&m.length===0)return{redos:[],undos:[]};if(c.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(c),{undo:p,redo:w,objects:f}=h;d.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:w,objects:f,type:S.DrawingApplyType.UPDATE}}),g.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:p,objects:f,type:S.DrawingApplyType.UPDATE}})}if(m.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(m),p=h.undo,w=h.redo,f=h.objects;d.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:w,objects:f,type:S.DrawingApplyType.REMOVE}}),g.push({id:S.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:n,op:p,objects:f,type:S.DrawingApplyType.INSERT}})}return d.push({id:X.id,params:[t]}),g.push({id:X.id,params:[t]}),{redos:d,undos:g}}_expandCol(i,r,e,t,n=S.SheetDrawingAnchorType.Position){const s=t-e+1,{from:o,to:a}=i,{column:d}=o,{column:g}=a;if(n===S.SheetDrawingAnchorType.None)return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>=e){const m=this._skeletonManagerService.attachRangeWithCoord({startColumn:e,endColumn:t,startRow:o.row,endRow:a.row});if(m==null)return;c={...r,left:(r.left||0)+m.endX-m.startX},u=Y(c,this._selectionRenderService)}else if(g>=t)if(n===S.SheetDrawingAnchorType.Both)u={from:{...o},to:{...a,column:g+s}},c=Z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkCol(i,r,e,t,n=S.SheetDrawingAnchorType.Position){const s=t-e+1,{from:o,to:a}=i,{column:d}=o,{column:g}=a;if(n===S.SheetDrawingAnchorType.None)return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>t)u={from:{...o,column:d-s},to:{...a,column:g-s}},c=Z(u,this._selectionRenderService,this._skeletonManagerService);else{if(d>=e&&g<=t)return null;if(d<e&&g>t)if(n===S.SheetDrawingAnchorType.Both)u={from:{...o},to:{...a,column:g-s}},c=Z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};else if(d>=e&&d<=t){if(d===e)c={...r,left:(r.left||0)-i.from.columnOffset};else{const m=this._skeletonManagerService.attachRangeWithCoord({startColumn:e,endColumn:d-1,startRow:o.row,endRow:a.row});if(m==null)return;c={...r,left:(r.left||0)-m.endX+m.startX-i.from.columnOffset}}u=Y(c,this._selectionRenderService)}else if(g>=e&&g<=t&&n===S.SheetDrawingAnchorType.Both){const m=this._skeletonManagerService.attachRangeWithCoord({startColumn:e-1,endColumn:e-1,startRow:o.row,endRow:a.row});if(m==null)return;u={from:{...o},to:{...a,column:e-1,columnOffset:m.endX-m.startX}},c=Z(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_expandRow(i,r,e,t,n=S.SheetDrawingAnchorType.Position){const s=t-e+1,{from:o,to:a}=i,{row:d}=o,{row:g}=a;if(n===S.SheetDrawingAnchorType.None)return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>=e){const m=this._skeletonManagerService.attachRangeWithCoord({startRow:e,endRow:t,startColumn:o.column,endColumn:a.column});if(m==null)return;c={...r,top:(r.top||0)+m.endY-m.startY},u=Y(c,this._selectionRenderService)}else if(g>=t)if(n===S.SheetDrawingAnchorType.Both)u={from:{...o},to:{...a,row:g+s}},c=Z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkRow(i,r,e,t,n=S.SheetDrawingAnchorType.Position){const s=t-e+1,{from:o,to:a}=i,{row:d}=o,{row:g}=a;if(n===S.SheetDrawingAnchorType.None)return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>t)u={from:{...o,row:d-s},to:{...a,row:g-s}},c=Z(u,this._selectionRenderService,this._skeletonManagerService);else{if(d>=e&&g<=t)return null;if(d<e&&g>t)if(n===S.SheetDrawingAnchorType.Both)u={from:{...o},to:{...a,row:g-s}},c=Z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:Y({...r},this._selectionRenderService),newTransform:r};else if(d>=e&&d<=t){if(d===e)c={...r,top:(r.top||0)-i.from.rowOffset};else{const m=this._skeletonManagerService.attachRangeWithCoord({startRow:e,endRow:d-1,startColumn:o.column,endColumn:a.column});if(m==null)return;c={...r,top:(r.top||0)-m.endY+m.startY-i.from.rowOffset}}u=Y(c,this._selectionRenderService)}else if(g>=e&&g<=t&&n===S.SheetDrawingAnchorType.Both){const m=this._skeletonManagerService.attachRangeWithCoord({startColumn:o.column,endColumn:o.column,startRow:e-1,endRow:e-1});if(m==null)return;u={from:{...o},to:{...a,row:e-1,rowOffset:m.endY-m.startY}},c=Z(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{if(i.id===C.SetWorksheetActiveOperation.id){const{unitId:r,subUnitId:e}=i.params;this._updateDrawings(r,e)}})),this.disposeWithMe(this._context.activated$.subscribe(i=>{const{unit:r,unitId:e}=this._context;if(i){const t=r.getActiveSheet().getSheetId();this._updateDrawings(e,t)}else this._clearDrawings(e)}))}_clearDrawings(i){setTimeout(()=>{const r=this._drawingManagerService.drawingManagerData,e=[];Object.keys(r).forEach(t=>{const n=r[t];n!=null&&Object.keys(n).forEach(s=>{const o=n[s].data;o!=null&&Object.keys(o).forEach(a=>{t===i&&e.push(o[a])})})}),this._drawingManagerService.removeNotification(e)})}_updateDrawings(i,r){setTimeout(()=>{const e=this._drawingManagerService.drawingManagerData,t=[],n=[];Object.keys(e).forEach(s=>{const o=e[s];o!=null&&Object.keys(o).forEach(a=>{const d=o[a].data;d!=null&&Object.keys(d).forEach(g=>{if(s===i&&a===r){const u=d[g];u.transform=Z(u.sheetTransform,this._selectionRenderService,this._skeletonManagerService),t.push(d[g])}else n.push(d[g])})})}),this._drawingManagerService.removeNotification(n),this._drawingManagerService.addNotification(t)},0)}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{Wn.includes(i.id)&&requestIdleCallback(()=>{const r=i.params,{unitId:e,subUnitId:t,ranges:n}=r;this._refreshDrawingTransform(e,t,n)})}))}_refreshDrawingTransform(i,r,e){const t=this._drawingManagerService.getDrawingData(i,r),n=[];Object.keys(t).forEach(s=>{const o=t[s],{sheetTransform:a,transform:d,anchorType:g=S.SheetDrawingAnchorType.Position}=o;if(g===S.SheetDrawingAnchorType.None)return!0;const{from:u,to:c}=a,{row:m,column:h}=u,{row:p,column:w}=c;for(let f=0;f<e.length;f++){const v=e[f],{startRow:_,endRow:y,startColumn:T,endColumn:D}=v;if(l.Rectangle.intersects({startRow:_,endRow:y,startColumn:T,endColumn:D},{startRow:m,endRow:p,startColumn:h,endColumn:w})||m>y||h>D){const M=g===S.SheetDrawingAnchorType.Position,I=Z(a,this._selectionRenderService,this._skeletonManagerService);n.push({...o,transform:{...I,width:M?d==null?void 0:d.width:I==null?void 0:I.width,height:M?d==null?void 0:d.height:I==null?void 0:I.height}});break}}}),n.length!==0&&(this._drawingManagerService.refreshTransform(n),this._commandService.syncExecuteCommand(X.id,[i]))}};vt=kn([ue(1,x.IRenderManagerService),ue(2,l.ICommandService),ue(3,E.ISheetSelectionRenderService),ue(4,l.Inject(E.SheetSkeletonManagerService)),ue(5,l.Inject(C.SheetInterceptorService)),ue(6,S.ISheetDrawingService),ue(7,j.IDrawingManagerService),ue(8,l.IUniverInstanceService)],vt);function Ht({ref:i,...r}){const{icon:e,id:t,className:n,extend:s,...o}=r,a=`univerjs-icon univerjs-icon-${t} ${n||""}`.trim(),d=G.useRef(`_${Ln()}`);return Vt(e,`${t}`,{defIds:e.defIds,idSuffix:d.current},{ref:i,className:a,...o},s)}function Vt(i,r,e,t,n){return G.createElement(i.tag,{key:r,...$n(i,e,n),...t},(Bn(i,e).children||[]).map((s,o)=>Vt(s,`${r}-${i.tag}-${o}`,e,void 0,n)))}function $n(i,r,e){const t={...i.attrs};e!=null&&e.colorChannel1&&t.fill==="colorChannel1"&&(t.fill=e.colorChannel1),i.tag==="mask"&&t.id&&(t.id=t.id+r.idSuffix),Object.entries(t).forEach(([s,o])=>{s==="mask"&&typeof o=="string"&&(t[s]=o.replace(/url\(#(.*)\)/,`url(#$1${r.idSuffix})`))});const{defIds:n}=r;return!n||n.length===0||(i.tag==="use"&&t["xlink:href"]&&(t["xlink:href"]=t["xlink:href"]+r.idSuffix),Object.entries(t).forEach(([s,o])=>{typeof o=="string"&&(t[s]=o.replace(/url\(#(.*)\)/,`url(#$1${r.idSuffix})`))})),t}function Bn(i,r){var t;const{defIds:e}=r;return!e||e.length===0?i:i.tag==="defs"&&((t=i.children)!=null&&t.length)?{...i,children:i.children.map(n=>typeof n.attrs.id=="string"&&e&&e.includes(n.attrs.id)?{...n,attrs:{...n.attrs,id:n.attrs.id+r.idSuffix}}:n)}:i}function Ln(){return Math.random().toString(36).substring(2,8)}Ht.displayName="UniverIcon";const Fn={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M2.35381 3.65517C2.35381 2.88198 2.98061 2.25518 3.75381 2.25518H8.10381C8.43518 2.25518 8.70381 1.98655 8.70381 1.65518C8.70381 1.3238 8.43518 1.05518 8.10381 1.05518H3.75381C2.31787 1.05518 1.15381 2.21923 1.15381 3.65517V12.3552C1.15381 13.7911 2.31787 14.9552 3.75381 14.9552H12.4538C13.8897 14.9552 15.0538 13.7911 15.0538 12.3552V8.00518C15.0538 7.6738 14.7852 7.40518 14.4538 7.40518C14.1224 7.40518 13.8538 7.6738 13.8538 8.00518V9.24469L12.3428 8.11143C11.8294 7.72642 11.1111 7.77744 10.6573 8.23119L9.11281 9.77567L6.84342 7.83047C6.34812 7.40592 5.61375 7.41815 5.13289 7.85896L2.35381 10.4064V3.65517ZM2.35381 12.0343V12.3552C2.35381 13.1284 2.98061 13.7552 3.75381 13.7552H12.4538C13.227 13.7552 13.8538 13.1284 13.8538 12.3552V10.7447L11.6228 9.07144C11.5871 9.04469 11.5373 9.04827 11.5058 9.07971L10.0266 10.5589L11.2057 11.5696C11.4573 11.7853 11.4865 12.164 11.2708 12.4156C11.0552 12.6672 10.6764 12.6964 10.4248 12.4807L6.06245 8.74157C6.02809 8.71212 5.97713 8.71296 5.94377 8.74353L2.35381 12.0343Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M10.3911 3.84419C10.6254 3.60988 11.0053 3.60988 11.2396 3.84419L11.8818 4.48643V1.93496C11.8818 1.60359 12.1505 1.33496 12.4818 1.33496C12.8132 1.33496 13.0818 1.60359 13.0818 1.93496V4.48676L13.7244 3.84419C13.9587 3.60988 14.3386 3.60988 14.5729 3.84419C14.8072 4.07851 14.8072 4.45841 14.5729 4.69272L12.9063 6.35939C12.6719 6.5937 12.292 6.5937 12.0577 6.35939L10.3911 4.69272C10.1568 4.45841 10.1568 4.07851 10.3911 3.84419Z"}}]},Xt=G.forwardRef(function(r,e){return G.createElement(Ht,Object.assign({},r,{id:"download-image-icon",ref:e,icon:Fn}))});Xt.displayName="DownloadImageIcon";function Yn(){const i=k.useDependency(l.LocaleService),r=k.useDependency(k.IDialogService),e=k.useDependency(ct),[t,n]=G.useState([ge.CELL_ADDRESS]),[s,o]=G.useState(!1),[a,d]=G.useState(null),g=G.useMemo(()=>e.getCellImagesInSelection(),[e]),u=G.useMemo(()=>e.getDataColumns(),[e]),c=G.useMemo(()=>e.getSelectionRowRange(),[e]),m=u.length>0,h=G.useMemo(()=>u.map(M=>({label:M.label,value:String(M.index)})),[u]),[p,w]=G.useState(()=>h.length>0?h[0].value:"0"),f=G.useMemo(()=>{if(!t.includes(ge.COLUMN_VALUE)||!c)return[];const I=Number(p);return[{startRow:c.startRow,endRow:c.endRow,startColumn:I,endColumn:I}]},[t,p,c]);E.useHighlightRange(f);const v=G.useCallback(M=>{M.length!==0&&n(M)},[]),_=G.useCallback(M=>{w(String(M))},[]),y=G.useCallback(()=>{r.close(Ce)},[r]),T=G.useCallback(async()=>{if(g.length!==0){o(!0),d(null);try{await e.saveImages(g,{fileNameParts:t,columnIndex:t.includes(ge.COLUMN_VALUE)?Number(p):void 0}),r.close(Ce)}catch(M){console.error("Failed to save images:",M),d(i.t("sheetImage.save.error"))}finally{o(!1)}}},[e,g,t,p,r,i]),D=t.includes(ge.COLUMN_VALUE);return B.jsxs("div",{className:"univer-flex univer-flex-col",children:[B.jsx(F.FormLayout,{label:i.t("sheetImage.save.imageCount"),children:B.jsx("div",{className:"univer-text-sm univer-text-gray-600",children:g.length})}),B.jsx(F.FormLayout,{label:i.t("sheetImage.save.fileNameConfig"),children:B.jsxs(F.CheckboxGroup,{value:t,onChange:v,direction:"vertical",children:[B.jsx(F.Checkbox,{value:ge.CELL_ADDRESS,disabled:!m,children:i.t("sheetImage.save.useRowCol")}),m&&B.jsx(F.Checkbox,{value:ge.COLUMN_VALUE,children:i.t("sheetImage.save.useColumnValue")})]})}),D&&B.jsx(F.FormLayout,{label:i.t("sheetImage.save.selectColumn"),children:B.jsx(F.Select,{value:p,options:h,onChange:_})}),a&&B.jsx("div",{className:"univer-text-xs univer-text-red-500",children:a}),B.jsxs("div",{className:"univer-flex univer-justify-end univer-gap-2 univer-border-t univer-border-gray-200 univer-pt-3",children:[B.jsx(F.Button,{onClick:y,disabled:s,children:i.t("sheetImage.save.cancel")}),B.jsx(F.Button,{variant:"primary",onClick:T,disabled:s||g.length===0,children:s?i.t("sheetImage.save.saving"):i.t("sheetImage.save.confirm")})]})]})}const Gn=i=>{var _;const r=k.useDependency(l.ICommandService),e=k.useDependency(l.LocaleService),t=k.useDependency(j.IDrawingManagerService),n=k.useDependency(x.IRenderManagerService),{drawings:s}=i,o=s[0];if(o==null)return;const{unitId:a}=o,d=n.getRenderById(a),g=d==null?void 0:d.scene;if(g==null)return;const u=g.getTransformerByCreate(),[c,m]=G.useState(!0),h=(_=o.anchorType)!=null?_:S.SheetDrawingAnchorType.Position,[p,w]=G.useState(h);function f(y,T){const D=[];return y.forEach(M=>{const{oKey:I}=M,A=T.getDrawingOKey(I);if(A==null)return D.push(null),!0;const{unitId:b,subUnitId:P,drawingId:N,drawingType:U,anchorType:R,sheetTransform:W}=A;D.push({unitId:b,subUnitId:P,drawingId:N,anchorType:R,sheetTransform:W,drawingType:U})}),D}G.useEffect(()=>{const y=u.clearControl$.subscribe(D=>{D===!0&&m(!1)}),T=u.changeStart$.subscribe(D=>{var A;const{objects:M}=D,I=f(M,t);if(I.length===0)m(!1);else if(I.length>=1){m(!0);const b=((A=I[0])==null?void 0:A.anchorType)||S.SheetDrawingAnchorType.Position;w(b)}});return()=>{T.unsubscribe(),y.unsubscribe()}},[]);function v(y){w(y);const T=t.getFocusDrawings();if(T.length===0)return;const D=T.map(M=>({unitId:M.unitId,subUnitId:M.subUnitId,drawingId:M.drawingId,anchorType:y}));r.executeCommand(je.id,{unitId:T[0].unitId,drawings:D})}return B.jsxs("div",{className:F.clsx("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!c}),children:[B.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:B.jsx("div",{children:e.t("drawing-anchor.title")})}),B.jsx("div",{children:B.jsxs(F.RadioGroup,{value:p,onChange:v,direction:"vertical",children:[B.jsx(F.Radio,{value:S.SheetDrawingAnchorType.Both,children:e.t("drawing-anchor.both")}),B.jsx(F.Radio,{value:S.SheetDrawingAnchorType.Position,children:e.t("drawing-anchor.position")}),B.jsx(F.Radio,{value:S.SheetDrawingAnchorType.None,children:e.t("drawing-anchor.none")})]})})]})},Hn=()=>{const i=k.useDependency(j.IDrawingManagerService),r=i.getFocusDrawings(),[e,t]=G.useState(r);return G.useEffect(()=>{const n=i.focus$.subscribe(s=>{t(s)});return()=>{n.unsubscribe()}},[]),!!(e!=null&&e.length)&&B.jsxs("div",{className:"univer-text-sm",children:[B.jsx(he.DrawingCommonPanel,{drawings:e}),B.jsx(Gn,{drawings:e})]})},Rt="sheet.menu.image";function Vn(i){return{id:Rt,type:k.MenuItemType.SUBITEMS,icon:"AddImageIcon",tooltip:"sheetImage.title",hidden$:k.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET),disabled$:E.getCurrentRangeDisable$(i,{workbookTypes:[C.WorkbookEditablePermission],worksheetTypes:[C.WorksheetEditPermission],rangeTypes:[C.RangeProtectionPermissionEditPoint]})}}function Xn(i){return{id:ke.id,title:"sheetImage.upload.float",type:k.MenuItemType.BUTTON,hidden$:k.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET)}}function Kn(i){return{id:yt.id,title:"sheetImage.upload.cell",type:k.MenuItemType.BUTTON,hidden$:k.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET)}}function zn(i){var r,e,t,n;return!!((e=(r=i==null?void 0:i.p)==null?void 0:r.drawingsOrder)!=null&&e.length&&((n=(t=i==null?void 0:i.p)==null?void 0:t.drawingsOrder)==null?void 0:n.length)>0)}function qn(i,r){const e=i.getActiveSheet();if(!e)return!1;const t=e.getCellMatrix(),{startRow:n,endRow:s,startColumn:o,endColumn:a}=r;for(let d=n;d<=s;d++)for(let g=o;g<=a;g++){const u=t.getValue(d,g);if(zn(u))return!0}return!1}function Zn(){return"showDirectoryPicker"in window}function ht(i){const r=i.get(l.IUniverInstanceService),e=i.get(C.SheetsSelectionsService),t=O.combineLatest([k.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET),r.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(O.switchMap(n=>n?e.selectionMoveEnd$.pipe(O.map(()=>{if(!Zn())return!0;const s=e.getCurrentSelections();if(!s||s.length===0)return!0;for(const o of s)if(qn(n,o.range))return!1;return!0})):O.of(!0)))]).pipe(O.map(([n,s])=>n||s));return{id:ye.id,type:k.MenuItemType.BUTTON,icon:"DownloadImageIcon",title:"sheetImage.save.menuLabel",hidden$:t}}const Jn={[k.RibbonInsertGroup.MEDIA]:{[Rt]:{order:0,menuItemFactory:Vn,[ke.id]:{order:0,menuItemFactory:Xn},[yt.id]:{order:1,menuItemFactory:Kn}}},[k.ContextMenuPosition.MAIN_AREA]:{[k.ContextMenuGroup.OTHERS]:{[ye.id]:{order:10,menuItemFactory:ht}}},[k.ContextMenuPosition.COL_HEADER]:{[k.ContextMenuGroup.OTHERS]:{[ye.id]:{order:10,menuItemFactory:ht}}},[k.ContextMenuPosition.ROW_HEADER]:{[k.ContextMenuGroup.OTHERS]:{[ye.id]:{order:10,menuItemFactory:ht}}}};function xe(i){return!i.getContextValue(l.FOCUSING_FX_BAR_EDITOR)&&!i.getContextValue(l.EDITOR_ACTIVATED)&&!i.getContextValue(l.FOCUSING_PANEL_EDITOR)&&i.getContextValue(l.FOCUSING_COMMON_DRAWINGS)}const Qn={id:Te.id,description:"shortcut.drawing-move-down",group:"4_drawing-view",binding:k.KeyCode.ARROW_DOWN,priority:100,preconditions:xe,staticParameters:{direction:l.Direction.DOWN}},er={id:Te.id,description:"shortcut.drawing-move-up",group:"4_drawing-view",binding:k.KeyCode.ARROW_UP,priority:100,preconditions:xe,staticParameters:{direction:l.Direction.UP}},tr={id:Te.id,description:"shortcut.drawing-move-left",group:"4_drawing-view",binding:k.KeyCode.ARROW_LEFT,priority:100,preconditions:xe,staticParameters:{direction:l.Direction.LEFT}},nr={id:Te.id,description:"shortcut.drawing-move-right",group:"4_drawing-view",binding:k.KeyCode.ARROW_RIGHT,priority:100,preconditions:xe,staticParameters:{direction:l.Direction.RIGHT}},rr={id:_t.id,description:"shortcut.drawing-delete",group:"4_drawing-view",preconditions:xe,binding:k.KeyCode.DELETE,mac:k.KeyCode.BACKSPACE};var ir=Object.getOwnPropertyDescriptor,sr=(i,r,e,t)=>{for(var n=t>1?void 0:t?ir(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},De=(i,r)=>(e,t)=>r(e,t,i);let at=class extends l.Disposable{constructor(i,r,e,t,n,s){super(),this._componentManager=i,this._menuManagerService=r,this._commandService=e,this._shortcutService=t,this._drawingManagerService=n,this._sheetsSelectionsService=s,this._init()}_initCustomComponents(){const i=this._componentManager;this.disposeWithMe(i.register(Bt,Hn)),this.disposeWithMe(i.register(Ce,Yn)),this.disposeWithMe(i.register("DownloadImageIcon",Xt))}_initMenus(){this._menuManagerService.mergeMenu(Jn)}_initCommands(){[ke,yt,Ne,Me,je,Mt,X,Tt,It,Ct,Te,_t,Dt,ye].forEach(i=>this.disposeWithMe(this._commandService.registerCommand(i)))}_initShortcuts(){[Qn,er,tr,nr,rr].forEach(i=>{this.disposeWithMe(this._shortcutService.registerShortcut(i))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};at=sr([De(0,l.Inject(k.ComponentManager)),De(1,k.IMenuManagerService),De(2,l.ICommandService),De(3,k.IShortcutService),De(4,j.IDrawingManagerService),De(5,l.Inject(C.SheetsSelectionsService))],at);var or=Object.defineProperty,ar=Object.getOwnPropertyDescriptor,cr=(i,r,e)=>r in i?or(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e,dr=(i,r,e,t)=>{for(var n=t>1?void 0:t?ar(r,e):r,s=i.length-1,o;s>=0;s--)(o=i[s])&&(n=o(n)||n);return n},mt=(i,r)=>(e,t)=>r(e,t,i),Kt=(i,r,e)=>cr(i,typeof r!="symbol"?r+"":r,e);const lr="SHEET_IMAGE_UI_PLUGIN";exports.UniverSheetsDrawingUIPlugin=class extends l.Plugin{constructor(r=kt,e,t,n){super(),this._config=r,this._injector=e,this._renderManagerService=t,this._configService=n;const{menu:s,...o}=l.merge({},kt,this._config);s&&this._configService.setConfig("menu",s,{merge:!0}),this._configService.setConfig(dn,o)}onStarting(){l.registerDependencies(this._injector,[[exports.SheetCanvasFloatDomManagerService],[at],[et],[ot],[st],[it],[tt],[nt],[rt],[ct,{useClass:exports.BatchSaveImagesService}]]),l.touchDependencies(this._injector,[[exports.SheetCanvasFloatDomManagerService]])}onReady(){l.touchDependencies(this._injector,[[it],[rt]])}onRendered(){this._registerRenderModules(),l.touchDependencies(this._injector,[[st],[ot],[at],[tt],[nt]])}onSteady(){this._injector.get(et)}_registerRenderModules(){[[exports.SheetDrawingUpdateController],[vt],[St],[wt]].forEach(r=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(l.UniverInstanceType.UNIVER_SHEET,r))})}};Kt(exports.UniverSheetsDrawingUIPlugin,"type",l.UniverInstanceType.UNIVER_SHEET);Kt(exports.UniverSheetsDrawingUIPlugin,"pluginName",lr);exports.UniverSheetsDrawingUIPlugin=dr([l.DependentOn(j.UniverDrawingPlugin,$t.UniverDocsDrawingPlugin,he.UniverDrawingUIPlugin,S.UniverSheetsDrawingPlugin),mt(1,l.Inject(l.Injector)),mt(2,x.IRenderManagerService),mt(3,l.IConfigService)],exports.UniverSheetsDrawingUIPlugin);exports.ClearSheetDrawingTransformerOperation=X;exports.DeleteDrawingsCommand=_t;exports.EditSheetDrawingOperation=Tt;exports.FileNamePart=ge;exports.GroupSheetDrawingCommand=It;exports.IBatchSaveImagesService=ct;exports.InsertFloatImageCommand=ke;exports.InsertSheetDrawingCommand=Ne;exports.MoveDrawingsCommand=Te;exports.RemoveSheetDrawingCommand=Me;exports.SHEETS_IMAGE_MENU_ID=Rt;exports.SHEET_FLOAT_DOM_PREFIX=Yt;exports.SaveCellImagesCommand=ye;exports.SetDrawingArrangeCommand=Dt;exports.SetSheetDrawingCommand=je;exports.SidebarSheetDrawingOperation=Mt;exports.UngroupSheetDrawingCommand=Ct;exports.calcSheetFloatDomPosition=oe;exports.drawingPositionToTransform=Z;exports.transformToDrawingPosition=Y;
