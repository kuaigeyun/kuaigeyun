"use strict";var T=Object.defineProperty;var E=(I,e,o)=>e in I?T(I,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):I[e]=o;var R=(I,e,o)=>E(I,typeof e!="symbol"?e+"":e,o);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("@univerjs/core"),b=require("@univerjs/sheets-thread-comment"),f=require("@univerjs/sheets/facade"),a=require("@univerjs/thread-comment"),x=require("@univerjs/engine-formula"),y=require("rxjs"),S=require("@univerjs/core/facade");var A=Object.getOwnPropertyDescriptor,B=(I,e,o,t)=>{for(var n=t>1?void 0:t?A(e,o):e,r=I.length-1,s;r>=0;r--)(s=I[r])&&(n=s(n)||n);return n},p=(I,e)=>(o,t)=>e(o,t,I);class U{constructor(e){R(this,"_comment",{id:m.generateRandomId(),ref:"",threadId:"",dT:"",personId:"",text:m.RichTextBuilder.newEmptyData().body,attachments:[],unitId:"",subUnitId:""});e&&(this._comment=e)}static create(e){return new U(e)}get personId(){return this._comment.personId}get dateTime(){return this._comment.dT}get content(){return m.RichTextValue.createByBody(this._comment.text)}get id(){return this._comment.id}get threadId(){return this._comment.threadId}copy(){return k.create(m.Tools.deepClone(this._comment))}}class k extends U{static create(e){return new k(e)}setContent(e){return e instanceof m.RichTextValue?this._comment.text=e.getData().body:this._comment.text=e,this}setPersonId(e){return this._comment.personId=e,this}setDateTime(e){return this._comment.dT=a.getDT(e),this}setId(e){return this._comment.id=e,this}setThreadId(e){return this._comment.threadId=e,this}build(){return this._comment}}exports.FThreadComment=class{constructor(e,o,t,n,r,s,c){this._thread=e,this._parent=o,this._injector=t,this._commandService=n,this._univerInstanceService=r,this._threadCommentModel=s,this._userManagerService=c}_getRef(){var t;const e=((t=this._parent)==null?void 0:t.ref)||this._thread.ref;return x.deserializeRangeWithSheet(e).range}getIsRoot(){return!this._parent}getCommentData(){const{children:e,...o}=this._thread;return o}getReplies(){var t;const e=this._getRef(),o=this._threadCommentModel.getCommentWithChildren(this._thread.unitId,this._thread.subUnitId,e.startRow,e.startColumn);return(t=o==null?void 0:o.children)==null?void 0:t.map(n=>this._injector.createInstance(exports.FThreadComment,n))}getRange(){const e=this._univerInstanceService.getUnit(this._thread.unitId,m.UniverInstanceType.UNIVER_SHEET);if(!e)return null;const o=e.getSheetBySheetId(this._thread.subUnitId);if(!o)return null;const t=this._getRef();return this._injector.createInstance(f.FRange,e,o,t)}getContent(){return this._thread.text}getRichText(){const e=this._thread.text;return m.RichTextValue.create({body:e,documentStyle:{},id:"d"})}deleteAsync(){return this._commandService.executeCommand(this.getIsRoot()?a.DeleteCommentTreeCommand.id:a.DeleteCommentCommand.id,{commentId:this._thread.id,unitId:this._thread.unitId,subUnitId:this._thread.subUnitId})}delete(){return this.deleteAsync()}async update(e){return this.updateAsync(e)}async updateAsync(e){const o=e instanceof m.RichTextValue?e.getData().body:e,t=a.getDT();return await this._commandService.executeCommand(a.UpdateCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,payload:{commentId:this._thread.id,text:o,updated:!0,updateT:t}})}resolve(e){return this.resolveAsync(e)}resolveAsync(e){return this._commandService.executeCommand(a.ResolveCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,commentId:this._thread.id,resolved:e!=null?e:!this._thread.resolved})}replyAsync(e){var t;const o=e.build();return this._commandService.executeCommand(a.AddCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,comment:{id:m.generateRandomId(),parentId:this._thread.id,threadId:this._thread.threadId,ref:((t=this._parent)==null?void 0:t.ref)||this._thread.ref,unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,text:o.text,attachments:o.attachments,dT:o.dT||a.getDT(),personId:o.personId||this._userManagerService.getCurrentUser().userID}})}};exports.FThreadComment=B([p(2,m.Inject(m.Injector)),p(3,m.ICommandService),p(4,m.IUniverInstanceService),p(5,m.Inject(b.SheetsThreadCommentModel)),p(6,m.Inject(m.UserManagerService))],exports.FThreadComment);class D extends f.FRange{getComment(){const o=this._injector.get(b.SheetsThreadCommentModel),t=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),r=o.getByLocation(t,n,this._range.startRow,this._range.startColumn);if(!r)return null;const s=o.getComment(t,n,r);return s?this._injector.createInstance(exports.FThreadComment,s):null}getComments(){const o=this._injector.get(b.SheetsThreadCommentModel),t=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),r=[];return m.Range.foreach(this._range,(s,c)=>{const u=o.getByLocation(t,n,s,c);if(u){const i=o.getComment(t,n,u);i&&r.push(this._injector.createInstance(exports.FThreadComment,i))}}),r}addComment(e){var h;const o=this._injector,t=(h=this.getComment())==null?void 0:h.getCommentData(),n=o.get(m.ICommandService),r=o.get(m.UserManagerService),s=this._workbook.getUnitId(),c=this._worksheet.getSheetId(),u=`${m.Tools.chatAtABC(this._range.startColumn)}${this._range.startRow+1}`,i=r.getCurrentUser(),d=e instanceof k?e.build():{text:e};return n.executeCommand(a.AddCommentCommand.id,{unitId:s,subUnitId:c,comment:{text:d.text,dT:d.dT||a.getDT(),attachments:[],id:d.id||m.generateRandomId(),ref:u,personId:d.personId||i.userID,parentId:t==null?void 0:t.id,unitId:s,subUnitId:c,threadId:(t==null?void 0:t.threadId)||m.generateRandomId()}})}clearComment(){var s;const e=this._injector,o=(s=this.getComment())==null?void 0:s.getCommentData(),t=e.get(m.ICommandService),n=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return o?t.executeCommand(a.DeleteCommentTreeCommand.id,{unitId:n,subUnitId:r,threadId:o.threadId,commentId:o.id}):Promise.resolve(!0)}clearComments(){const o=this.getComments().map(t=>t.deleteAsync());return Promise.all(o).then(()=>!0)}addCommentAsync(e){return this.addComment(e)}clearCommentAsync(){return this.clearComment()}clearCommentsAsync(){return this.clearComments()}}f.FRange.extend(D);class j extends f.FWorkbook{_initialize(){Object.defineProperty(this,"_threadCommentModel",{get(){return this._injector.get(a.ThreadCommentModel)}})}getComments(){return this._threadCommentModel.getUnit(this._workbook.getUnitId()).map(e=>this._injector.createInstance(exports.FThreadComment,e.root))}clearComments(){const o=this.getComments().map(t=>t.deleteAsync());return Promise.all(o).then(()=>!0)}onThreadCommentChange(e){return m.toDisposable(this._threadCommentModel.commentUpdate$.pipe(y.filter(o=>o.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddThreadComment(e){return m.toDisposable(this._commandService.beforeCommandExecuted((o,t)=>{const n=o.params;if(o.id===a.AddCommentCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(e(n,t)===!1)throw new Error("Command is stopped by the hook onBeforeAddThreadComment")}}))}onBeforeUpdateThreadComment(e){return m.toDisposable(this._commandService.beforeCommandExecuted((o,t)=>{const n=o.params;if(o.id===a.UpdateCommentCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(e(n,t)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateThreadComment")}}))}onBeforeDeleteThreadComment(e){return m.toDisposable(this._commandService.beforeCommandExecuted((o,t)=>{const n=o.params;if(o.id===a.DeleteCommentCommand.id||o.id===a.DeleteCommentTreeCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(e(n,t)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteThreadComment")}}))}}f.FWorkbook.extend(j);class F extends f.FWorksheet{getComments(){return this._injector.get(b.SheetsThreadCommentModel).getSubUnitAll(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(t=>this._injector.createInstance(exports.FThreadComment,t))}clearComments(){const o=this.getComments().map(t=>t.deleteAsync());return Promise.all(o).then(()=>!0)}onCommented(e){return this._injector.get(m.ICommandService).onCommandExecuted(t=>{if(t.id===a.AddCommentCommand.id){const n=t.params;e(n)}})}getCommentById(e){const t=this._injector.get(b.SheetsThreadCommentModel).getComment(this._workbook.getUnitId(),this._worksheet.getSheetId(),e);if(t)return this._injector.createInstance(exports.FThreadComment,t)}}f.FWorksheet.extend(F);const v={CommentAdded:"CommentAdded",BeforeCommentAdd:"BeforeCommentAdd",CommentUpdated:"CommentUpdated",BeforeCommentUpdate:"BeforeCommentUpdate",CommentDeleted:"CommentDeleted",BeforeCommentDelete:"BeforeCommentDelete",CommentResolved:"CommentResolved",BeforeCommentResolve:"BeforeCommentResolve"};class M extends S.FEventName{get CommentAdded(){return v.CommentAdded}get BeforeCommentAdd(){return v.BeforeCommentAdd}get CommentUpdated(){return v.CommentUpdated}get BeforeCommentUpdate(){return v.BeforeCommentUpdate}get CommentDeleted(){return v.CommentDeleted}get BeforeCommentDelete(){return v.BeforeCommentDelete}get CommentResolved(){return v.CommentResolved}get BeforeCommentResolve(){return v.BeforeCommentResolve}}S.FEventName.extend(M);class P extends S.FUniver{_initialize(e){const o=e.get(m.ICommandService);this.registerEventHandler(this.Event.CommentAdded,()=>o.onCommandExecuted(t=>{var d,h,C,g,l;if(t.id!==a.AddCommentCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(d=this.getActiveWorkbook)==null?void 0:d.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{comment:u}=c,i=s.getRange(u.ref).getComment();i&&this.fireEvent(this.Event.CommentAdded,{workbook:r,worksheet:s,row:(C=(h=i.getRange())==null?void 0:h.getRow())!=null?C:0,col:(l=(g=i.getRange())==null?void 0:g.getColumn())!=null?l:0,comment:i})})),this.registerEventHandler(this.Event.CommentUpdated,()=>o.onCommandExecuted(t=>{var d,h,C,g,l;if(t.id!==a.UpdateCommentCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(d=this.getActiveWorkbook)==null?void 0:d.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{commentId:u}=c.payload,i=s.getCommentById(u);i&&this.fireEvent(this.Event.CommentUpdated,{workbook:r,worksheet:s,row:(C=(h=i.getRange())==null?void 0:h.getRow())!=null?C:0,col:(l=(g=i.getRange())==null?void 0:g.getColumn())!=null?l:0,comment:i})})),this.registerEventHandler(this.Event.CommentDeleted,()=>o.onCommandExecuted(t=>{var i;if(t.id!==a.DeleteCommentCommand.id&&t.id!==a.DeleteCommentTreeCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{commentId:u}=c;this.fireEvent(this.Event.CommentDeleted,{workbook:r,worksheet:s,commentId:u})})),this.registerEventHandler(this.Event.CommentResolved,()=>o.onCommandExecuted(t=>{var h,C,g;if(t.id!==a.ResolveCommentCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(h=this.getActiveWorkbook)==null?void 0:h.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{commentId:u,resolved:i}=c,d=s.getComments().find(l=>l.getCommentData().id===u);d&&this.fireEvent(this.Event.CommentResolved,{workbook:r,worksheet:s,row:(C=d.getRange().getRow())!=null?C:0,col:(g=d.getRange().getColumn())!=null?g:0,comment:d,resolved:i})})),this.registerEventHandler(this.Event.BeforeCommentAdd,()=>o.beforeCommandExecuted(t=>{var h,C,g;if(t.id!==a.AddCommentCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(h=this.getActiveWorkbook)==null?void 0:h.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{comment:u}=c,i=s.getActiveRange();if(!i)return;const d={workbook:r,worksheet:s,row:(C=i.getRow())!=null?C:0,col:(g=i.getColumn())!=null?g:0,comment:U.create(u)};if(this.fireEvent(this.Event.BeforeCommentAdd,d),d.cancel)throw new m.CanceledError})),this.registerEventHandler(this.Event.BeforeCommentUpdate,()=>o.beforeCommandExecuted(t=>{var h,C,g,l,_;if(t.id!==a.UpdateCommentCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(h=this.getActiveWorkbook)==null?void 0:h.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{commentId:u,text:i}=c.payload,d=s.getCommentById(u);if(d){const w={workbook:r,worksheet:s,row:(g=(C=d.getRange())==null?void 0:C.getRow())!=null?g:0,col:(_=(l=d.getRange())==null?void 0:l.getColumn())!=null?_:0,comment:d,newContent:m.RichTextValue.createByBody(i)};if(this.fireEvent(this.Event.BeforeCommentUpdate,w),w.cancel)throw new m.CanceledError}})),this.registerEventHandler(this.Event.BeforeCommentDelete,()=>o.beforeCommandExecuted(t=>{var d,h,C,g,l;if(t.id!==a.DeleteCommentCommand.id&&t.id!==a.DeleteCommentTreeCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(d=this.getActiveWorkbook)==null?void 0:d.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{commentId:u}=c,i=s.getCommentById(u);if(i){const _={workbook:r,worksheet:s,row:(C=(h=i.getRange())==null?void 0:h.getRow())!=null?C:0,col:(l=(g=i.getRange())==null?void 0:g.getColumn())!=null?l:0,comment:i};if(this.fireEvent(this.Event.BeforeCommentDelete,_),_.cancel)throw new m.CanceledError}})),this.registerEventHandler(this.Event.BeforeCommentResolve,()=>o.beforeCommandExecuted(t=>{var h,C,g;if(t.id!==a.ResolveCommentCommand.id)return;const n=t.params;if(!n)return;const r=n.unitId?this.getUniverSheet(n.unitId):(h=this.getActiveWorkbook)==null?void 0:h.call(this);if(!r)return;const s=r.getSheetBySheetId(n.subUnitId||n.sheetId)||r.getActiveSheet();if(!s)return;const c=t.params,{commentId:u,resolved:i}=c,d=s.getComments().find(l=>l.getCommentData().id===u);if(d){const l={workbook:r,worksheet:s,row:(C=d.getRange().getRow())!=null?C:0,col:(g=d.getRange().getColumn())!=null?g:0,comment:d,resolved:i};if(this.fireEvent(this.Event.BeforeCommentResolve,l),l.cancel)throw new m.CanceledError}}))}newTheadComment(e){return new k(e)}}S.FUniver.extend(P);
