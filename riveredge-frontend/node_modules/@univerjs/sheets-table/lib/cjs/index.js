"use strict";var $e=Object.defineProperty;var Ae=(n,e,t)=>e in n?$e(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var T=(n,e,t)=>Ae(n,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("@univerjs/core"),S=require("@univerjs/sheets"),D=require("rxjs"),ae=require("@univerjs/engine-formula");var v=(n=>(n.Insert="insert",n.Delete="delete",n))(v||{}),y=(n=>(n.Row="row",n.Col="column",n))(y||{}),se=(n=>(n.None="none",n.String="string",n.Number="number",n.Date="date",n.Bool="bool",n.Checkbox="checkbox",n.List="list",n))(se||{}),q=(n=>(n.manual="manual",n.condition="condition",n))(q||{}),N=(n=>(n.Date="date",n.Number="number",n.String="string",n.Logic="logic",n))(N||{}),F=(n=>(n.Equal="equal",n.NotEqual="notEqual",n.GreaterThan="greaterThan",n.GreaterThanOrEqual="greaterThanOrEqual",n.LessThan="lessThan",n.LessThanOrEqual="lessThanOrEqual",n.Between="between",n.NotBetween="notBetween",n.Above="above",n.Below="below",n.TopN="topN",n))(F||{}),U=(n=>(n.Equal="equal",n.NotEqual="notEqual",n.Contains="contains",n.NotContains="notContains",n.StartsWith="startsWith",n.EndsWith="endsWith",n))(U||{}),b=(n=>(n.Equal="equal",n.NotEqual="notEqual",n.After="after",n.AfterOrEqual="afterOrEqual",n.Before="before",n.BeforeOrEqual="beforeOrEqual",n.Between="between",n.NotBetween="notBetween",n.Today="today",n.Yesterday="yesterday",n.Tomorrow="tomorrow",n.ThisWeek="thisWeek",n.LastWeek="lastWeek",n.NextWeek="nextWeek",n.ThisMonth="thisMonth",n.LastMonth="lastMonth",n.NextMonth="nextMonth",n.ThisQuarter="thisQuarter",n.LastQuarter="lastQuarter",n.NextQuarter="nextQuarter",n.ThisYear="thisYear",n.LastYear="lastYear",n.NextYear="nextYear",n.YearToDate="yearToDate",n.Quarter="quarter",n.Month="month",n.M1="m1",n.M2="m2",n.M3="m3",n.M4="m4",n.M5="m5",n.M6="m6",n.M7="m7",n.M8="m8",n.M9="m9",n.M10="m10",n.M11="m11",n.M12="m12",n.Q1="q1",n.Q2="q2",n.Q3="q3",n.Q4="q4",n))(b||{}),E=(n=>(n[n.FilteredSortNone=1]="FilteredSortNone",n[n.FilteredSortAsc=2]="FilteredSortAsc",n[n.FilteredSortDesc=3]="FilteredSortDesc",n[n.FilterNoneSortNone=4]="FilterNoneSortNone",n[n.FilterNoneSortAsc=5]="FilterNoneSortAsc",n[n.FilterNoneSortDesc=6]="FilterNoneSortDesc",n))(E||{}),L=(n=>(n.Asc="asc",n.Desc="desc",n.None="none",n))(L||{});function H(n,e){return`${e} ${n}`}const le="TRUE",ue="FALSE",Be=n=>{var t;return((t=n.body)==null?void 0:t.dataStream.replace(/\r\n$/,""))||""};function Te(n){if(n){const{v:e,t,p:a}=n;return a?Be(a):(t===c.CellValueType.FORCE_STRING||t===c.CellValueType.STRING)&&e!==void 0&&e!==null?String(e):t===c.CellValueType.BOOLEAN?e?le:ue:t===c.CellValueType.NUMBER?String(e):typeof e==="boolean"?e?le:ue:e==null?"":String(e)}return""}function Le(n,e){if(n!=null)switch(e){case L.Asc:return E.FilteredSortAsc;case L.Desc:return E.FilteredSortDesc;default:return E.FilteredSortNone}else switch(e){case L.Asc:return E.FilterNoneSortAsc;case L.Desc:return E.FilterNoneSortDesc;default:return E.FilterNoneSortNone}}function Ce(n){return n?n.filterType===q.condition:!1}function We(n){return n?n.filterType===q.manual:!1}const x={s:c.BorderStyleTypes.THIN,cl:{rgb:"rgb(95, 101, 116)"}},pe="sheets-table.config",ce={},qe={headerRowStyle:{bd:{t:x}},headerColumnStyle:{bd:{l:x}},lastColumnStyle:{bd:{r:x}},lastRowStyle:{bd:{b:x}}},Ve=(n,e)=>{if(n==="headerRowStyle"){if(!e.bd)return{...e,bd:{t:x}}}else if(n==="lastRowStyle"){if(!e.bd)return{...e,bd:{b:x}}}else if(n==="lastColumnStyle"){if(!e.bd)return{...e,bd:{r:x}}}else if(n==="headerColumnStyle"&&!e.bd)return{...e,bd:{l:x}};return e},Pe=[[["#6280F9","#FFFFFF","#BAC6F8","#D2DAFA"],["#fff"]],[["#16BDCA","#FFFFFF","#EDFAFA","#AFECEF"],["#000"]],[["#31C48D","#FFFFFF","#F3FAF7","#BCF0DA"],["#fff"]],[["#AC94FA","#FFFFFF","#F6F5FF","#EDEBFE"],["#fff"]],[["#F17EBB","#FFFFFF","#FDF2F8","#FCE8F3"],["#fff"]],[["#F98080","#FFFFFF","#FDF2F2","#FDE8E8"],["#fff"]]],Re=Pe.map((n,e)=>{const[t,a]=n,[r,s,o,l]=t,[u]=a;return{name:`table-default-${e}`,style:{headerRowStyle:{bg:{rgb:r},cl:{rgb:u},bd:{t:x}},headerColumnStyle:{bd:{l:x}},firstRowStyle:{bg:{rgb:s}},secondRowStyle:{bg:{rgb:o}},lastRowStyle:{bg:{rgb:l},bd:{b:x}},lastColumnStyle:{bd:{r:x}}}}});class W{constructor(e,t){T(this,"dataType");T(this,"id");T(this,"displayName");T(this,"formula");T(this,"meta");T(this,"style");this.id=e,this.displayName=t,this.dataType=se.String,this.formula="",this.meta={},this.style={}}getMeta(){return this.meta}setMeta(e){this.meta=e}getDisplayName(){return this.displayName}toJSON(){return{id:this.id,displayName:this.displayName,dataType:this.dataType,formula:this.formula,meta:this.meta,style:this.style}}fromJSON(e){this.id=e.id,this.displayName=e.displayName,this.dataType=e.dataType,this.formula=e.formula,this.meta=e.meta,this.style=e.style}}const He=n=>n.getMonth()<=2,Je=n=>{const e=n.getMonth();return e>2&&e<=5},ke=n=>{const e=n.getMonth();return e>5&&e<=8},je=n=>{const e=n.getMonth();return e>8&&e<=11},Qe=n=>n.getMonth()===0,Ye=n=>n.getMonth()===1,Ge=n=>n.getMonth()===2,Xe=n=>n.getMonth()===3,ze=n=>n.getMonth()===4,Ke=n=>n.getMonth()===5,Ze=n=>n.getMonth()===6,et=n=>n.getMonth()===7,tt=n=>n.getMonth()===8,nt=n=>n.getMonth()===9,at=n=>n.getMonth()===10,rt=n=>n.getMonth()===11,st=(n,e=new Date)=>n.toDateString()===e.toDateString(),ot=(n,e=new Date)=>{const t=new Date(e);return t.setDate(t.getDate()+1),n.toDateString()===t.toDateString()},it=(n,e=new Date)=>{const t=new Date(e);return t.setDate(t.getDate()-1),n.toDateString()===t.toDateString()},V=n=>{const e=n.getDay(),t=n.getDate()-e+(e===0?-6:1),a=new Date(n);return a.setDate(t),a},we=10080*60*1e3,lt=(n,e=new Date)=>{const t=V(n),a=V(e);return t.toDateString()===a.toDateString()},ut=(n,e=new Date)=>{const t=V(n),a=new Date(V(e).getTime()+we);return t.toDateString()===a.toDateString()},ct=(n,e=new Date)=>{const t=V(n),a=new Date(V(e).getTime()-we);return t.toDateString()===a.toDateString()},dt=(n,e=new Date)=>n.getFullYear()===e.getFullYear()&&n.getMonth()===e.getMonth(),ht=n=>{const e=new Date(n);return e.setHours(0,0,0,0),e.setDate(1),e},gt=(n,e=new Date)=>{const t=new Date(e);t.setHours(0,0,0,0),t.setMonth(t.getMonth()+1,1);const a=new Date(t);a.setMonth(a.getMonth()+1,0);const r=n.getTime();return r>=t.getTime()&&r<a.getTime()},mt=(n,e=new Date)=>{const t=ht(e),a=new Date(t);a.setMonth(a.getMonth()+1,0);const r=n.getTime();return r>=t.getTime()&&r<a.getTime()},oe=n=>{const e=new Date(n);e.setHours(0,0,0,0),e.setDate(1);const t=e.getMonth();return e.setMonth(t-t%3),e},bt=(n,e=new Date)=>{const t=oe(e),a=new Date(t);a.setMonth(a.getMonth()+3);const r=n.getTime();return r>=t.getTime()&&r<a.getTime()},St=(n,e=new Date)=>{const t=oe(e),a=new Date(t);a.setMonth(a.getMonth()+3);const r=new Date(a);r.setMonth(r.getMonth()+3,0);const s=n.getTime();return s>=a.getTime()&&s<r.getTime()},Tt=(n,e=new Date)=>{const t=oe(e),a=new Date(t);a.setMonth(a.getMonth()-3);const r=new Date(t);r.setDate(0);const s=n.getTime();return s>=a.getTime()&&s<r.getTime()},Ct=(n,e=new Date)=>n.getFullYear()===e.getFullYear(),pt=(n,e=new Date)=>n.getFullYear()===e.getFullYear()+1,Rt=(n,e=new Date)=>n.getFullYear()===e.getFullYear()-1,wt=(n,e=new Date)=>{const t=new Date(e);t.setHours(0,0,0,0),t.setMonth(0,1);const a=n.getTime();return a>=t.getTime()&&a<e.getTime()};function It(n){switch(n.compareType){case b.Equal:{const e=new Date(n.expectedValue);return t=>t.getTime()===e.getTime()}case b.NotEqual:{const e=new Date(n.expectedValue);return t=>t.getTime()!==e.getTime()}case b.After:{const e=new Date(n.expectedValue);return t=>t.getTime()>e.getTime()}case b.Before:{const e=new Date(n.expectedValue);return t=>t.getTime()<e.getTime()}case b.AfterOrEqual:{const e=new Date(n.expectedValue);return t=>t.getTime()>=e.getTime()}case b.BeforeOrEqual:{const e=new Date(n.expectedValue);return t=>t.getTime()<=e.getTime()}case b.Between:return e=>{const[t,a]=n.expectedValue;return e.getTime()>=new Date(t).getTime()&&e.getTime()<=new Date(a).getTime()};case b.NotBetween:return e=>{const[t,a]=n.expectedValue;return e.getTime()<new Date(t).getTime()||e.getTime()>new Date(a).getTime()};case b.Today:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>st(t,e)}case b.Yesterday:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>it(t,e)}case b.Tomorrow:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>ot(t,e)}case b.ThisWeek:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>lt(t,e)}case b.LastWeek:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>ct(t,e)}case b.NextWeek:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>ut(t,e)}case b.ThisMonth:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>dt(t,e)}case b.LastMonth:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>mt(t,e)}case b.NextMonth:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>gt(t,e)}case b.ThisQuarter:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>bt(t,e)}case b.LastQuarter:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>Tt(t,e)}case b.NextQuarter:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>St(t,e)}case b.ThisYear:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>Ct(t,e)}case b.LastYear:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>Rt(t,e)}case b.NextYear:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>pt(t,e)}case b.YearToDate:{const e=n.anchorTime?new Date(n.anchorTime):new Date;return t=>wt(t,e)}case b.M1:return Qe;case b.M2:return Ye;case b.M3:return Ge;case b.M4:return Xe;case b.M5:return ze;case b.M6:return Ke;case b.M7:return Ze;case b.M8:return et;case b.M9:return tt;case b.M10:return nt;case b.M11:return at;case b.M12:return rt;case b.Q1:return He;case b.Q2:return Je;case b.Q3:return ke;case b.Q4:return je;default:throw new Error("Unsupported compare type")}}class ft{constructor(){T(this,"heap");this.heap=[]}swap(e,t){const a=this.heap[e];this.heap[e]=this.heap[t],this.heap[t]=a}getParentIndex(e){return Math.floor((e-1)/2)}getLeftIndex(e){return e*2+1}getRightIndex(e){return e*2+2}size(){return this.heap.length}peek(){return this.heap[0]}include(e){return this.heap.includes(e)}}class _t extends ft{constructor(){super()}shiftUp(e){if(e===0)return;const t=this.getParentIndex(e);this.heap[t]>this.heap[e]&&(this.swap(t,e),this.shiftUp(t))}shiftDown(e){const t=this.getLeftIndex(e),a=this.getRightIndex(e);this.heap[t]<this.heap[e]&&(this.swap(t,e),this.shiftDown(t)),this.heap[a]<this.heap[e]&&(this.swap(a,e),this.shiftDown(a))}insert(e){this.heap.push(e),this.shiftUp(this.heap.length-1)}pop(){this.heap[0]=this.heap.pop(),this.shiftDown(0)}}const vt=(n,e)=>{const t=new _t;for(const a of n)t.insert(a),t.size()>e&&t.pop();return t.heap},Mt=(n,e)=>n>e,Ft=(n,e)=>n<e,yt=(n,e,t)=>vt(n,e).includes(t);function Dt(n,e){switch(n.compareType){case F.Equal:{const t=Number(n.expectedValue);return a=>a===t}case F.NotEqual:{const t=Number(n.expectedValue);return a=>a!==t}case F.GreaterThan:{const t=Number(n.expectedValue);return a=>a>t}case F.GreaterThanOrEqual:{const t=Number(n.expectedValue);return a=>a>=t}case F.LessThan:{const t=Number(n.expectedValue);return a=>a<t}case F.LessThanOrEqual:{const t=Number(n.expectedValue);return a=>a<=t}case F.Between:{const[t,a]=n.expectedValue,r=Number(t),s=Number(a);return r>s?o=>o>=s&&o<=r:o=>o>=r&&o<=s}case F.NotBetween:{const[t,a]=n.expectedValue,r=Number(t),s=Number(a);return r>s?o=>o<s||o>r:o=>o<r||o>s}case F.Above:{const t=e.average;return a=>Mt(a,t)}case F.Below:{const t=e.average;return a=>Ft(a,t)}case F.TopN:{const t=e.list,a=Number(n.expectedValue);return r=>yt(t,a,r)}}}const Nt=(n,e)=>c.createREGEXFromWildChar(e).test(n),xt=(n,e)=>!c.createREGEXFromWildChar(e).test(n),Ot=(n,e)=>c.createREGEXFromWildChar(`*${e}*`).test(n),Ut=(n,e)=>!c.createREGEXFromWildChar(`*${e}*`).test(n),Et=(n,e)=>c.createREGEXFromWildChar(`${e}*`).test(n),$t=(n,e)=>c.createREGEXFromWildChar(`*${e}`).test(n);function At(n){switch(n.compareType){case U.Equal:return e=>Nt(e,n.expectedValue);case U.NotEqual:return e=>xt(e,n.expectedValue);case U.Contains:return e=>Ot(e,n.expectedValue);case U.NotContains:return e=>Ut(e,n.expectedValue);case U.StartsWith:return e=>Et(e,n.expectedValue);case U.EndsWith:return e=>$t(e,n.expectedValue);default:return console.error(`Unknown filter operator: ${n.compareType}`),e=>!0}}const Bt=new Set([F.Above,F.Below,F.TopN]);b.Today,b.Yesterday,b.Tomorrow,b.ThisWeek,b.LastWeek,b.NextWeek,b.ThisMonth,b.LastMonth,b.NextMonth,b.ThisQuarter,b.LastQuarter,b.NextQuarter,b.NextYear,b.ThisYear,b.LastYear,b.YearToDate;function Ie(n){return Bt.has(n)}function Lt(n,e){if(Ie(n.filterInfo.compareType))return t=>!0;switch(n.filterInfo.conditionType){case N.Date:return It(n.filterInfo);case N.Number:return Dt(n.filterInfo,e);case N.String:return At(n.filterInfo);case N.Logic:default:return t=>!0}}function X(n,e,t,a){switch(a){case N.Date:{const r=de(n,e,t);return r?Vt(r):null}case N.Number:return de(n,e,t);case N.String:default:return qt(n,e,t)}}const Wt=n=>{var t;return((t=n.body)==null?void 0:t.dataStream.replace(/\r\n$/,""))||""};function qt(n,e,t){const a=n.getCell(e,t);if(!a)return null;const{v:r,t:s,p:o}=a;if(o)return Wt(o);if(typeof r=="string")return s===c.CellValueType.BOOLEAN?r.toUpperCase():r;if(typeof r=="number")return s===c.CellValueType.BOOLEAN?r?"TRUE":"FALSE":r;if(typeof r=="boolean")return r?"TRUE":"FALSE";if(r!==void 0)return String(r)}function de(n,e,t){const a=n.getCell(e,t);if(!a)return null;const{v:r,t:s,p:o}=a;return o?null:typeof r=="string"&&s===c.CellValueType.NUMBER?Number(n.getCellRaw(e,t).v):Number(r)}function Vt(n){const e=new Date(Date.UTC(1900,0,1,0,0,0)),t=new Date(Date.UTC(1900,1,28,0,0,0));let a=n-1;return a>(t.getTime()-e.getTime())/(1e3*3600*24)&&(a-=1),a<0&&(a=n),new Date(e.getTime()+a*(1e3*3600*24))}class he{constructor(){T(this,"_tableColumnFilterList");T(this,"_tableSortInfo");T(this,"_filterOutRows");this._tableColumnFilterList=[]}setColumnFilter(e,t){t?this._tableColumnFilterList[e]=t:this._tableColumnFilterList[e]=void 0}setSortState(e,t){this._tableSortInfo={columnIndex:e,sortState:t}}getColumnFilter(e){return this._tableColumnFilterList[e]}getFilterState(e){var a;const t=((a=this._tableSortInfo)==null?void 0:a.columnIndex)===e?this._tableSortInfo.sortState:L.None;return Le(this._tableColumnFilterList[e],t)}getSortState(){var e;return(e=this._tableSortInfo)!=null?e:{}}getFilterStates(e){const t=[],{startColumn:a,endColumn:r}=e;for(let s=a;s<=r;s++)t.push(this.getFilterState(s-a));return t}getFilterOutRows(){return this._filterOutRows}doFilter(e,t){const a=new Set,r=this._tableColumnFilterList;for(let s=0;s<r.length;s++)r[s]&&this.doColumnFilter(e,t,s,a);return this._filterOutRows=a,a}doColumnFilter(e,t,a,r){const s=this._tableColumnFilterList[a];if(s&&e){const{startRow:o,endRow:l,startColumn:u}=t,i=u+a,d=this.getExecuteFunc(e,t,a,s);for(let g=o;g<=l;g++){const h=Ce(s)?s.filterInfo.conditionType:N.String;X(e,g,i,h)===null?r.add(g):d(X(e,g,i,h))||r.add(g)}}}_getNumberCalculatedOptions(e,t,a){const{startRow:r,endRow:s,startColumn:o}=t,l=o+a,u=[];let i=0,d=0;for(let g=r;g<=s;g++){const h=X(e,g,l,N.Number);h!==null&&(u.push(h),i++,d+=h)}return{list:u,average:i>0?d/i:0}}getExecuteFunc(e,t,a,r){if(r.filterType===q.manual){const s=new Set(r.values);return o=>s.has(o)}else if(r.filterType===q.condition){const o=Ie(r.filterInfo.compareType)?this._getNumberCalculatedOptions(e,t,a):void 0;return Lt(r,o)}else return s=>!0}toJSON(){return{tableColumnFilterList:this._tableColumnFilterList,tableSortInfo:this._tableSortInfo}}fromJSON(e){var t;this._tableColumnFilterList=(t=e.tableColumnFilterList)!=null?t:[],e.tableSortInfo&&(this._tableSortInfo=e.tableSortInfo)}dispose(){this._tableColumnFilterList=[]}}class ge{constructor(e,t,a,r,s={}){T(this,"_id");T(this,"_name");T(this,"_tableStyleId");T(this,"_showHeader");T(this,"_showFooter");T(this,"_range");T(this,"_columns",new Map);T(this,"_columnOrder",[]);T(this,"tableMeta");T(this,"_tableFilters");T(this,"_subUnitId");this._id=e,this._range=a,this._name=t,this._tableFilters=new he,this._init(r,s)}_init(e,t){var o,l;this._tableStyleId=t==null?void 0:t.tableStyleId,this._showHeader=(o=t==null?void 0:t.showHeader)!=null?o:!0,this._showFooter=!1;const a=this.getRange(),r=a.startColumn,s=a.endColumn;for(let u=r;u<=s;u++){const i=u-r;let d,g;(l=t.columns)!=null&&l[i]?(d=t.columns[i].id,g=t.columns[i].displayName):(d=c.generateRandomId(),g=e[u-r]);const h=new W(d,g);this._columns.set(d,h),this._columnOrder.push(d)}t.filters&&t.filters.forEach((i,d)=>{i&&this._tableFilters.setColumnFilter(d,i)})}setTableFilterColumn(e,t){this._tableFilters.setColumnFilter(e,t)}getTableFilterColumn(e){return this._tableFilters.getColumnFilter(e)}getTableFilters(){return this._tableFilters}getTableFilterRange(){const e=this.getRange(),t=this.isShowHeader(),a=this.isShowFooter(),{startRow:r,startColumn:s,endRow:o,endColumn:l}=e,u=t?r+1:r,i=a?o-1:o;return{startRow:u,startColumn:s,endRow:i,endColumn:l}}setColumns(e){this._columns.clear(),this._columnOrder=[],e.forEach(t=>{const a=new W(t.id,t.displayName);a.fromJSON(t),this._columns.set(t.id,a),this._columnOrder.push(t.id)})}getColumnsCount(){return this._columnOrder.length}insertColumn(e,t){const a=t.id;this._columns.set(a,t),this._columnOrder.splice(e,0,a)}removeColumn(e){const t=this._columnOrder[e];this._columns.delete(t),this._columnOrder.splice(e,1)}setTableMeta(e){this.tableMeta=e}getTableMeta(){return this.tableMeta}getColumn(e){return this._columns.get(e)}getTableColumnByIndex(e){const t=this._columnOrder[e];return this.getColumn(t)}getColumnNameByIndex(e){var a;const t=this._columnOrder[e];return((a=this.getColumn(t))==null?void 0:a.getDisplayName())||""}getId(){return this._id}getRangeInfo(){return{...this._range}}getRange(){return{...this._range}}setRange(e){this._range=e}setDisplayName(e){this._name=e}getDisplayName(){return this._name}getSubunitId(){return this._subUnitId}setSubunitId(e){this._subUnitId=e}getTableStyleId(){var e;return(e=this._tableStyleId)!=null?e:Re[0].name}setTableStyleId(e){this._tableStyleId=e}isShowHeader(){var e;return(e=this._showHeader)!=null?e:!0}setShowHeader(e){this._showHeader=e}isShowFooter(){var e;return(e=this._showFooter)!=null?e:!1}getTableInfo(){return{id:this._id,subUnitId:this._subUnitId,name:this._name,range:this.getRangeInfo(),meta:this.tableMeta,showHeader:this._showHeader,columns:this._columnOrder.map(e=>this._columns.get(e).toJSON())}}getTableConfig(){return{name:this.getDisplayName(),range:this.getRangeInfo(),options:{showHeader:this._showHeader,showFooter:this._showFooter},tableStyleId:this._tableStyleId}}getFilterStates(e){return this._tableFilters.getFilterStates(e)}toJSON(){const e=[];return this._columns.forEach(t=>{e.push(t.toJSON())}),{id:this._id,name:this._name,range:this.getRangeInfo(),options:{showHeader:this._showHeader,showFooter:this._showFooter,tableStyleId:this._tableStyleId},filters:this._tableFilters.toJSON(),columns:e,meta:this.tableMeta}}fromJSON(e){var a,r;this._id=e.id,this._name=e.name,this._range=e.range,this.tableMeta=e.meta,this._tableStyleId=e.options.tableStyleId||"",this._showHeader=(a=e.options.showHeader)!=null?a:!0,this._showFooter=(r=e.options.showFooter)!=null?r:!0,e.columns.forEach(s=>{const o=new W(s.id,s.displayName);o.fromJSON(s),this._columns.set(s.id,o),this._columnOrder.push(s.id)}),this._tableFilters=new he,this._tableFilters.fromJSON(e.filters)}dispose(){this._id="",this._name="",this._tableStyleId="",this._showHeader=!0,this._showFooter=!0,delete this._range,this._columns.clear(),this._columnOrder=[]}}var Pt=Object.getOwnPropertyDescriptor,Ht=(n,e,t,a)=>{for(var r=a>1?void 0:a?Pt(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},me=(n,e)=>(t,a)=>e(t,a,n);exports.TableManager=class extends c.Disposable{constructor(t,a){super();T(this,"_tableMap");T(this,"_tableAdd$",new D.Subject);T(this,"tableAdd$",this._tableAdd$.asObservable());T(this,"_tableDelete$",new D.Subject);T(this,"tableDelete$",this._tableDelete$.asObservable());T(this,"_tableNameChanged$",new D.Subject);T(this,"tableNameChanged$",this._tableNameChanged$.asObservable());T(this,"_tableRangeChanged$",new D.Subject);T(this,"tableRangeChanged$",this._tableRangeChanged$.asObservable());T(this,"_tableThemeChanged$",new D.Subject);T(this,"tableThemeChanged$",this._tableThemeChanged$.asObservable());T(this,"_tableFilterChanged$",new D.Subject);T(this,"tableFilterChanged$",this._tableFilterChanged$.asObservable());T(this,"_tableInitStatus",new D.BehaviorSubject(!1));T(this,"tableInitStatus$",this._tableInitStatus.asObservable());this._univerInstanceService=t,this._localeService=a,this._tableMap=new Map}_ensureUnit(t){return this._tableMap.has(t)||this._tableMap.set(t,new Map),this._tableMap.get(t)}getColumnHeader(t,a,r,s){var h;const o=(h=this._univerInstanceService.getUnit(t))==null?void 0:h.getSheetBySheetId(a),{startRow:l,startColumn:u,endColumn:i}=r,d=[],g=s!=null?s:"Column";for(let m=u;m<=i;m++)d.push(Te(o==null?void 0:o.getCell(l,m))||H(m-u+1,g));return d}addTable(t,a,r,s,o,l,u){var m;const i=l!=null?l:c.generateRandomId(),d=o||this.getColumnHeader(t,a,s),g=new ge(i,r,s,d,u);if(g.setSubunitId(a),this._ensureUnit(t).set(i,g),this._tableAdd$.next({unitId:t,subUnitId:a,range:s,tableName:r,tableId:i,tableStyleId:u==null?void 0:u.tableStyleId}),u!=null&&u.filters){const p=(m=this._univerInstanceService.getUnit(t))==null?void 0:m.getSheetBySheetId(a);g.getTableFilters().doFilter(p,s),this._tableFilterChanged$.next({unitId:t,subUnitId:a,tableId:i})}return i}addFilter(t,a,r,s){const o=this.getTable(t,a);if(o){o.getTableFilters().setColumnFilter(r,s);const u=o.getSubunitId();this._tableFilterChanged$.next({unitId:t,subUnitId:u,tableId:a})}}getFilterRanges(t,a){const r=this._tableMap.get(t);if(!r)return[];const s=[];return r.forEach(o=>{o.getSubunitId()===a&&o.isShowHeader()&&s.push(o.getRange())}),s}getSheetFilterRangeWithState(t,a){const r=this._tableMap.get(t);if(!r)return[];const s=[];return r.forEach(o=>{o.getSubunitId()===a&&o.isShowHeader()&&s.push({tableId:o.getId(),range:o.getRange(),states:o.getFilterStates(o.getRange())})}),s}getTable(t,a){const r=this._tableMap.get(t);if(r)return r.get(a)}getUniqueTableName(t,a){const r=this._tableMap.get(t);if(!r)return a;const s=new Set(Array.from(r.values()).map(u=>u.getDisplayName()));let o=a,l=1;for(;s.has(o);)o=`${a}-${l}`,l++;return o}getTableById(t,a){return this.getTable(t,a)}getTableList(t){const a=this._tableMap.get(t);return a?Array.from(a.values()).map(r=>({...r.getTableInfo(),unitId:t})):[]}getTablesBySubunitId(t,a){const r=this._tableMap.get(t);return r?Array.from(r.values()).filter(s=>s.getSubunitId()===a):[]}getTablesInfoBySubunitId(t,a){return this.getTablesBySubunitId(t,a).map(r=>({id:r.getId(),name:r.getDisplayName(),range:r.getRange()}))}deleteTable(t,a){const r=this._tableMap.get(t),s=r==null?void 0:r.get(a);if(s){const o=s.getTableInfo(),l=s.getTableStyleId();r==null||r.delete(a);const{subUnitId:u,range:i,name:d}=o;this._tableDelete$.next({unitId:t,subUnitId:u,tableId:a,range:i,tableName:d,tableStyleId:l})}}operationTableRowCol(t,a,r){const s=this.getTableById(t,a);if(!s)return;const{operationType:o,rowColType:l,index:u,count:i,columnsJson:d}=r,g=s.getRange(),h={...g};if(o===v.Insert){if(l==="row")h.endRow+=i;else if(l==="column"){h.endColumn+=i;for(let m=0;m<i;m++){const p=this._localeService.t("sheets-table.columnPrefix"),C=new W(c.generateRandomId(),H(s.getColumnsCount()+1+m,p));d!=null&&d[m]&&C.fromJSON(d[m]);const w=u+m-g.startColumn;s.insertColumn(w,C)}}}else if(l==="row")h.endRow-=i;else if(l==="column"){h.endColumn-=i;for(let m=i-1;m>=0;m--){const p=u+m-g.startColumn;s.removeColumn(p)}}s.setRange(h),this._tableRangeChanged$.next({unitId:t,subUnitId:s.getSubunitId(),tableId:a,range:h,oldRange:g})}updateTableRange(t,a,r){const s=this.getTableById(t,a);if(!s)return;const o=s.getRange(),l=r.newRange;if(l.startColumn<o.startColumn){const u=o.startColumn-l.startColumn,i=this._localeService.t("sheets-table.columnPrefix");for(let d=0;d<u;d++)s.insertColumn(o.startColumn,new W(c.generateRandomId(),H(s.getColumnsCount()+1,i)))}else if(l.startColumn>o.startColumn){const u=l.startColumn-o.startColumn;for(let i=u-1;i>=0;i--){const d=l.startColumn+i-o.startColumn;s.removeColumn(d)}}if(l.endColumn<o.endColumn){const u=o.endColumn-l.endColumn;for(let i=u-1;i>=0;i--){const d=l.endColumn+i-o.startColumn;s.removeColumn(d)}}else if(l.endColumn>o.endColumn){const u=l.endColumn-o.endColumn;for(let i=0;i<u;i++)s.insertColumn(o.endColumn,new W(c.generateRandomId(),H(s.getColumnsCount()+1,"Column")))}s.setRange(l),this._tableRangeChanged$.next({unitId:t,subUnitId:s.getSubunitId(),tableId:a,range:l,oldRange:o})}setTableByConfig(t,a,r){var m;const s=this._tableMap.get(t),o=s==null?void 0:s.get(a);if(!o)return;const l=o.getSubunitId(),{name:u,updateRange:i,rowColOperation:d,theme:g,options:h}=r;if(u){const p=o.getDisplayName();o.setDisplayName(u),this._tableNameChanged$.next({unitId:t,subUnitId:l,tableId:a,tableName:u,oldTableName:p})}if(d&&this.operationTableRowCol(t,a,d),i&&this.updateTableRange(t,a,i),g){const p=(m=o.getTableStyleId())!=null?m:"default";o.setTableStyleId(g),this._tableThemeChanged$.next({unitId:t,subUnitId:l,tableId:a,theme:g,oldTheme:p})}h&&h.showHeader!==void 0&&o.setShowHeader(h.showHeader)}toJSON(t){const a={},r=this._tableMap.get(t);return r&&r.forEach(s=>{const o=s.getSubunitId();if(!a[o]){const l=new Set;this.getTablesBySubunitId(t,o).forEach(i=>{const d=i.getTableFilters().getFilterOutRows();if(d)for(const g of d)l.add(g)}),a[o]={tables:[],tableFilteredOutRows:Array.from(l)}}a[o].tables.push(s.toJSON())}),a}fromJSON(t,a){const r=this._ensureUnit(t);Object.keys(a).forEach(o=>{const l=S.getSheetCommandTarget(this._univerInstanceService,{unitId:t,subUnitId:o});if(!l)return;const u=l.worksheet;let i;a[o].tables?i=a[o].tables:Array.isArray(a[o])&&(i=a[o]),i&&i.forEach(d=>{const g=this.getColumnHeader(t,o,d.range),h=new ge(d.id,d.name,d.range,g,d.options);if(h.setTableMeta(d.meta),d.columns.length&&h.setColumns(d.columns),d.filters){const m=h.getTableFilters();m.fromJSON(d.filters),m.doFilter(u,h.getTableFilterRange())}h.setSubunitId(o),r.set(d.id,h),this._tableAdd$.next({unitId:t,subUnitId:o,range:d.range,tableName:d.name,tableId:d.id})})}),this._tableInitStatus.next(!0)}deleteUnitId(t){this._tableMap.delete(t)}dispose(){super.dispose(),this._tableMap.forEach(t=>{t.forEach(a=>a.dispose()),t.clear()}),this._tableMap.clear()}};exports.TableManager=Ht([me(0,c.IUniverInstanceService),me(1,c.Inject(c.LocaleService))],exports.TableManager);var Jt=Object.getOwnPropertyDescriptor,kt=(n,e,t,a)=>{for(var r=a>1?void 0:a?Jt(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},jt=(n,e)=>(t,a)=>e(t,a,n);exports.SheetTableService=class extends c.Disposable{constructor(e){super(),this._tableManager=e}getTableInfo(e,t){const a=this._tableManager.getTable(e,t);if(a)return{unitId:e,...a.getTableInfo()}}getTableList(e){return this._tableManager.getTableList(e)}addTable(e,t,a,r,s,o,l){return this._tableManager.addTable(e,t,a,r,s,o,l)}deleteTable(e,t,a){this._tableManager.deleteTable(e,a)}getTableMeta(e,t){var a;return(a=this._tableManager.getTable(e,t))==null?void 0:a.getTableMeta()}setTableMeta(e,t,a){var r;(r=this._tableManager.getTable(e,t))==null||r.setTableMeta(a)}getTableColumnMeta(e,t,a){var r,s;return(s=(r=this._tableManager.getTable(e,t))==null?void 0:r.getTableColumnByIndex(a))==null?void 0:s.getMeta()}selTableColumnMeta(e,t,a,r){var s,o;(o=(s=this._tableManager.getTable(e,t))==null?void 0:s.getTableColumnByIndex(a))==null||o.setMeta(r)}addFilter(e,t,a,r){this._tableManager.addFilter(e,t,a,r)}getCellValueWithConditionType(e,t,a,r=N.String){return X(e,t,a,r)}};exports.SheetTableService=kt([jt(0,c.Inject(exports.TableManager))],exports.SheetTableService);const $={id:"sheet.mutation.add-table",type:c.CommandType.MUTATION,handler:(n,e)=>{const{tableId:t,unitId:a,subUnitId:r,name:s,range:o,header:l,options:u}=e;return n.get(exports.SheetTableService).addTable(a,r,s,o,l,t,u),!0}},A={id:"sheet.mutation.delete-table",type:c.CommandType.MUTATION,handler:(n,e)=>{const{unitId:t,subUnitId:a,tableId:r}=e;return n.get(exports.SheetTableService).deleteTable(t,a,r),!0}},fe={id:"sheet.command.add-table",type:c.CommandType.COMMAND,handler:(n,e)=>{var C;if(!e)return!1;const t=n.get(c.IUndoRedoService),a=n.get(c.ICommandService),r=n.get(c.LocaleService),s=(C=e.id)!=null?C:c.generateRandomId();let o=e.name;if(!o){const R=n.get(exports.TableManager).getTableList(e.unitId).length;o=`${r.t("sheets-table.tablePrefix")}${R+1}`}const l=[],u=[],i=n.get(exports.TableManager),{unitId:d,subUnitId:g,range:h}=e,m=i.getColumnHeader(d,g,h,r.t("sheets-table.columnPrefix"));return l.push({id:$.id,params:{...e,tableId:s,name:o,header:m}}),u.push({id:A.id,params:{tableId:s,unitId:e.unitId}}),c.sequenceExecute(l,a)&&t.pushUndoRedo({unitID:e.unitId,undoMutations:u,redoMutations:l}),!0}},_e={id:"sheet.command.delete-table",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const t=n.get(c.IUndoRedoService),a=n.get(c.ICommandService),r=n.get(exports.TableManager),s=n.get(c.ILogService),o=[],l=[],u=r.getTable(e.unitId,e.tableId),i=u==null?void 0:u.toJSON();return i?(o.push({id:A.id,params:{...e}}),l.push({id:$.id,params:{unitId:e.unitId,subUnitId:e.subUnitId,tableId:e.tableId,name:i.name,range:i.range,options:i.options}}),c.sequenceExecute(o,a)&&t.pushUndoRedo({unitID:e.unitId,undoMutations:l,redoMutations:o}),!0):(s.error("[TableManager]: Table not found"),!1)}},z={id:"sheet.mutation.set-table-filter",type:c.CommandType.MUTATION,handler:(n,e)=>{const{tableId:t,unitId:a,column:r,tableFilter:s}=e;return n.get(exports.TableManager).addFilter(a,t,r,s),!0}},ve={id:"sheet.command.set-table-filter",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const t=n.get(c.IUndoRedoService),a=n.get(c.ICommandService),r=e.tableId||c.generateRandomId(),s=[],o=[];return s.push({id:z.id,params:{...e,tableId:r}}),o.push({id:z.id,params:{...e,tableId:r,tableFilter:void 0}}),c.sequenceExecute(s,a)&&t.pushUndoRedo({unitID:e.unitId,undoMutations:o,redoMutations:s}),!0}},Me="SHEET_TABLE_PLUGIN",k="SHEET_TABLE",Fe="table-custom";var Qt=Object.getOwnPropertyDescriptor,Yt=(n,e,t,a)=>{for(var r=a>1?void 0:a?Qt(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},j=(n,e)=>(t,a)=>e(t,a,n);exports.SheetsTableController=class extends c.Disposable{constructor(t,a,r,s){super();T(this,"_tableRangeRTree",new Map);this._univerInstanceService=t,this._sheetInterceptorService=a,this._tableManager=r,this._resourceManagerService=s,this._initSnapshot(),this._initSheetChange(),this.registerTableChangeEvent(),this.registerTableHeaderInterceptor()}getContainerTableWithRange(t,a,r){const s=this._ensureTableRangeRTree(t),l=Array.from(s.bulkSearch([{unitId:t,sheetId:a,range:r}])).find(u=>{const i=this._tableManager.getTable(t,String(u));return i?c.Rectangle.contains(i.getRange(),r):!1});if(l)return this._tableManager.getTable(t,String(l))}_ensureTableRangeRTree(t){return this._tableRangeRTree.has(t)||this._tableRangeRTree.set(t,new c.RTree),this._tableRangeRTree.get(t)}registerTableChangeEvent(){this.disposeWithMe(this._tableManager.tableAdd$.subscribe(t=>{const{range:a,tableId:r,unitId:s,subUnitId:o}=t;this._ensureTableRangeRTree(s).insert({unitId:s,sheetId:o,id:r,range:{...a}})})),this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(t=>{const{range:a,tableId:r,unitId:s,subUnitId:o,oldRange:l}=t,u=this._ensureTableRangeRTree(s);u.remove({unitId:s,sheetId:o,id:r,range:{...l}}),u.insert({unitId:s,sheetId:o,id:r,range:{...a}})})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(t=>{const{tableId:a,unitId:r,subUnitId:s,range:o}=t;this._ensureTableRangeRTree(r).remove({unitId:r,sheetId:s,id:a,range:{...o}})}))}registerTableHeaderInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(S.INTERCEPTOR_POINT.CELL_CONTENT,{effect:c.InterceptorEffectEnum.Value,handler:(t,a,r)=>{const{row:s,col:o,unitId:l,subUnitId:u}=a,i=this._ensureTableRangeRTree(l);if((t==null?void 0:t.v)===void 0&&i){const g=Array.from(i.bulkSearch([{unitId:l,sheetId:u,range:{startColumn:o,endColumn:o,startRow:s,endRow:s}}]));if(g.length>0){const h=this._tableManager.getTable(l,g[0]);if(h){const m=h.getRange(),p=o-m.startColumn;if(m.startRow===s){const w=h.getColumnNameByIndex(p);return(!t||t===a.rawData)&&(t={...a.rawData}),t.v=w,r(t)}}}}return r(t)}}))}_toJson(t){return this._tableManager.toJSON(t)}_fromJSON(t,a){return this._tableManager.fromJSON(t,a)}_deleteUnitId(t){this._tableManager.deleteUnitId(t)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t=>JSON.stringify(this._toJson(t)),parseJson:t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}},businesses:[c.UniverInstanceType.UNIVER_SHEET],pluginName:Me,onLoad:(t,a)=>{this._fromJSON(t,a)},onUnLoad:t=>{this._deleteUnitId(t)}}))}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:t=>{var a;if(t.id===S.RemoveSheetCommand.id){const r=t.params,s=r.unitId||this._univerInstanceService.getCurrentUnitOfType(c.UniverInstanceType.UNIVER_SHEET).getUnitId(),o=r.subUnitId||((a=this._univerInstanceService.getCurrentUnitOfType(c.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:a.getSheetId());if(!s||!o)return{redos:[],undos:[]};const l=this._tableManager.getTablesBySubunitId(s,o);if(l.length===0)return{redos:[],undos:[]};const u=[],i=[];return l.forEach(d=>{const g=d.toJSON();u.push({id:A.id,params:{unitId:s,subUnitId:o,tableId:g.id}}),i.push({id:$.id,params:{unitId:s,subUnitId:o,name:g.name,range:g.range,tableId:g.id,options:{...g.options,columns:g.columns,filters:g.filters.tableColumnFilterList}}})}),{redos:u,undos:i}}else if(t.id===S.CopySheetCommand.id){const r=t.params,{unitId:s,subUnitId:o,targetSubUnitId:l}=r;if(!s||!o||!l)return{redos:[],undos:[]};const u=this._tableManager.getTablesBySubunitId(s,o);if(u.length===0)return{redos:[],undos:[]};const i=[],d=[];return u.forEach(g=>{const h=g.toJSON(),m=c.generateRandomId();i.push({id:$.id,params:{unitId:s,subUnitId:l,name:h.name,range:{...h.range,sheetId:l},tableId:m,options:{...h.options,columns:h.columns,filters:h.filters.tableColumnFilterList}}}),d.push({id:A.id,params:{unitId:s,subUnitId:l,tableId:m}})}),{redos:i,undos:d}}return{redos:[],undos:[]}}}))}dispose(){super.dispose(),this._tableRangeRTree.clear()}};exports.SheetsTableController=Yt([j(0,c.Inject(c.IUniverInstanceService)),j(1,c.Inject(S.SheetInterceptorService)),j(2,c.Inject(exports.TableManager)),j(3,c.Inject(c.IResourceManagerService))],exports.SheetsTableController);const I={id:"sheet.mutation.set-sheet-table",type:c.CommandType.MUTATION,handler:(n,e)=>{if(!e)return!1;const{unitId:t,tableId:a,config:r}=e;return n.get(exports.TableManager).setTableByConfig(t,a,r),!0}},ye={id:"sheet.command.add-table-theme",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const t=n.get(exports.TableManager),{unitId:a,tableId:r,themeStyle:s}=e,o=[],l=[],u=t.getTableById(a,r);if(!u)return!1;const i=u.getSubunitId();o.push({id:S.AddRangeThemeMutation.id,params:{unitId:a,subUnitId:i,styleJSON:s.toJson()}}),o.push({id:I.id,params:{unitId:a,subUnitId:i,tableId:r,config:{theme:s.getName()}}}),l.push({id:I.id,params:{unitId:a,subUnitId:i,tableId:r,config:{themeStyle:u.getTableStyleId()}}}),l.push({id:S.RemoveRangeThemeMutation.id,params:{unitId:a,subUnitId:i,styleName:s.getName()}});const d=n.get(c.ICommandService);return c.sequenceExecute(o,d)&&n.get(c.IUndoRedoService).pushUndoRedo({unitID:a,undoMutations:l,redoMutations:o}),!0}},De={id:"sheet.command.remove-table-theme",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const{unitId:t,tableId:a,themeName:r}=e,s=n.get(exports.TableManager),o=n.get(S.SheetRangeThemeModel),l=s.getTableById(t,a);if(!l)return!1;const u=l.getSubunitId(),i=[],d=[],g=o.getRegisteredRangeThemes().filter(R=>R==null?void 0:R.startsWith("table-default"));let m=o.getRegisteredRangeThemes().filter(R=>R==null?void 0:R.startsWith(Fe)).find(R=>R!==r);m||(m=g[0]),i.push({id:I.id,params:{unitId:t,subUnitId:u,tableId:a,config:{theme:m}}}),i.push({id:S.RemoveRangeThemeMutation.id,params:{unitId:t,subUnitId:u,styleName:r}});const p=o.getDefaultRangeThemeStyle(r);p&&(d.push({id:S.AddRangeThemeMutation.id,params:{unitId:t,subUnitId:u,styleJSON:p.toJson()}}),d.push({id:I.id,params:{unitId:t,subUnitId:u,tableId:a,config:{theme:r}}}));const C=n.get(c.ICommandService);return c.sequenceExecute(i,C)&&n.get(c.IUndoRedoService).pushUndoRedo({unitID:t,redoMutations:i,undoMutations:d}),!0}},Ne={id:"sheet.command.set-table-config",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const{unitId:t,tableId:a,name:r,updateRange:s,rowColOperation:o,theme:l}=e,u=n.get(exports.TableManager),i=u.getTableById(t,a);if(!i)return!1;const d={},g={},h=n.get(c.LocaleService),p=n.get(c.IUniverInstanceService).getCurrentUnitOfType(c.UniverInstanceType.UNIVER_SHEET),C=new Set;if(p&&(p.getSheets().forEach(f=>{C.add(f.getName())}),u.getTableList(t).forEach(f=>{C.add(f.name)})),r){if(!c.customNameCharacterCheck(r,C))return n.get(c.ILogService).warn(h.t("sheets-table.tableNameError")),!1;d.name=i.getDisplayName(),g.name=r}o&&(d.rowColOperation={operationType:o.operationType===v.Insert?v.Delete:v.Insert,rowColType:o.rowColType,index:o.index,count:o.count},g.rowColOperation=o),s&&(d.updateRange={newRange:i.getRange()},g.updateRange=s),l&&(d.theme=i.getTableStyleId(),g.theme=l);const w={unitId:t,subUnitId:i.getSubunitId(),tableId:a,config:g};return n.get(c.ICommandService).executeCommand(I.id,w),n.get(c.IUndoRedoService).pushUndoRedo({unitID:t,undoMutations:[{id:I.id,params:{unitId:t,subUnitId:i.getSubunitId(),tableId:a,config:d}}],redoMutations:[{id:I.id,params:w}]}),!0}},xe={id:"sheet.command.table-insert-row",type:c.CommandType.COMMAND,handler:n=>{const e=n.get(c.IUniverInstanceService),t=S.getSheetCommandTarget(e);if(!t)return!1;const{workbook:a,worksheet:r,unitId:s,subUnitId:o}=t,u=n.get(S.SheetsSelectionsService).getCurrentSelections();if(!u.length||u.length>1)return!1;n.get(exports.TableManager);const d=u[0].range,h=n.get(exports.SheetsTableController).getContainerTableWithRange(s,o,d);if(!h)return!1;const m=d.endRow-d.startRow+1,C=r.getRowCount()-1,w=r.getCellMatrix().getDataRange().endRow,R=[],_=[];if(C-w<m)R.push({id:S.InsertRowMutation.id,params:{unitId:s,subUnitId:o,range:{...d}}}),R.push({id:I.id,params:{unitId:s,subUnitId:o,tableId:h.getId(),config:{updateRange:{newRange:{...h.getRange(),endRow:h.getRange().endRow+m}}}}}),_.push({id:I.id,params:{unitId:s,subUnitId:o,tableId:h.getId(),config:{updateRange:{newRange:h.getRange()}}}}),_.push({id:S.RemoveRowMutation.id,params:{unitId:s,subUnitId:o,range:{...d}}});else{const M={...h.getRange()};R.push({id:I.id,params:{unitId:s,subUnitId:o,tableId:h.getId(),config:{updateRange:{newRange:{...M,endRow:M.endRow+m}}}}}),_.push({id:I.id,params:{unitId:s,subUnitId:o,tableId:h.getId(),config:{updateRange:{newRange:{...M}}}}});const P=S.getMoveRangeUndoRedoMutations(n,{unitId:s,subUnitId:o,range:{startRow:d.startRow,endRow:w,startColumn:M.startColumn,endColumn:M.endColumn}},{unitId:s,subUnitId:o,range:{startRow:d.startRow+m,endRow:w+m,startColumn:M.startColumn,endColumn:M.endColumn}});P&&(R.push(...P.redos),_.push(...P.undos))}const O=n.get(c.ICommandService);return c.sequenceExecute(R,O)&&n.get(c.IUndoRedoService).pushUndoRedo({unitID:s,undoMutations:_,redoMutations:R}),!0}},Oe={id:"sheet.command.table-insert-col",type:c.CommandType.COMMAND,handler:n=>{const e=n.get(c.IUniverInstanceService),t=S.getSheetCommandTarget(e);if(!t)return!1;const{worksheet:a,unitId:r,subUnitId:s}=t,l=n.get(S.SheetsSelectionsService).getCurrentSelections();if(!l.length||l.length>1)return!1;const i=l[0].range,g=n.get(exports.SheetsTableController).getContainerTableWithRange(r,s,i);if(!g)return!1;const h=i.endColumn-i.startColumn+1,p=a.getColumnCount()-1,C=a.getCellMatrix().getDataRange().endColumn,w=[],R=[];if(p-C<h)w.push({id:S.InsertColMutation.id,params:{unitId:r,subUnitId:s,range:{...i}}}),w.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:g.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:i.startColumn,count:h}}}}),R.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:g.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:i.startColumn,count:h}}}}),R.push({id:S.RemoveColMutation.id,params:{unitId:r,subUnitId:s,range:{...i}}});else{const f=g.getRange();w.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:g.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:i.startColumn,count:h}}}}),R.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:g.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:i.startColumn,count:h}}}});const M=S.getMoveRangeUndoRedoMutations(n,{unitId:r,subUnitId:s,range:{startRow:f.startRow,endRow:f.endRow,startColumn:i.startColumn,endColumn:C}},{unitId:r,subUnitId:s,range:{startRow:f.startRow,endRow:f.endRow,startColumn:i.startColumn+h,endColumn:C+h}});M&&(w.push(...M.redos),R.push(...M.undos))}const _=n.get(c.ICommandService);return c.sequenceExecute(w,_)&&n.get(c.IUndoRedoService).pushUndoRedo({unitID:r,undoMutations:R,redoMutations:w}),!0}},Ue={id:"sheet.command.table-remove-row",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const t=n.get(c.IUniverInstanceService),a=S.getSheetCommandTarget(t);if(!a)return!1;const{unitId:r,subUnitId:s}=a,l=n.get(S.SheetsSelectionsService).getCurrentSelections();if(!l.length||l.length>1)return!1;const i=l[0].range,g=n.get(exports.SheetsTableController).getContainerTableWithRange(r,s,i);if(!g)return!1;const h=i.endRow-i.startRow+1,m=[],p=[],C=g.getRange();m.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:g.getId(),config:{updateRange:{newRange:{...C,endRow:C.endRow-h}}}}}),p.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:g.getId(),config:{updateRange:{newRange:{...C}}}}});const R=a.worksheet.getCellMatrix().getDataRange().endRow,_=S.getMoveRangeUndoRedoMutations(n,{unitId:r,subUnitId:s,range:{startRow:i.endRow+1,endRow:R,startColumn:C.startColumn,endColumn:C.endColumn}},{unitId:r,subUnitId:s,range:{startRow:i.startRow,endRow:R-h,startColumn:C.startColumn,endColumn:C.endColumn}});_&&(m.push(..._.redos),p.push(..._.undos));const O=n.get(c.ICommandService);return c.sequenceExecute(m,O)&&n.get(c.IUndoRedoService).pushUndoRedo({unitID:r,undoMutations:p,redoMutations:m}),!0}},Ee={id:"sheet.command.table-remove-col",type:c.CommandType.COMMAND,handler:(n,e)=>{if(!e)return!1;const t=n.get(c.IUniverInstanceService),a=S.getSheetCommandTarget(t);if(!a)return!1;const{workbook:r,unitId:s,subUnitId:o}=a;n.get(exports.TableManager);const u=n.get(S.SheetsSelectionsService).getCurrentSelections();if(!u.length||u.length>1)return!1;const d=u[0].range,h=n.get(exports.SheetsTableController).getContainerTableWithRange(s,o,d);if(!h)return!1;const m=d.endColumn-d.startColumn+1,p=[],C=[],w=h.getRange();p.push({id:I.id,params:{unitId:s,subUnitId:o,tableId:h.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:d.startColumn,count:m}}}});const R=[],_=d.startColumn-w.startColumn;for(let J=0;J<m;J++){const ie=h.getTableInfo().columns[_+J];ie&&R.push(ie)}C.push({id:I.id,params:{unitId:s,subUnitId:o,tableId:h.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:d.startColumn,count:m,columnsJson:R}}}});const f=a.worksheet.getCellMatrix().getDataRange().endColumn,M=S.getMoveRangeUndoRedoMutations(n,{unitId:s,subUnitId:o,range:{startRow:w.startRow,endRow:w.endRow,startColumn:d.endColumn+1,endColumn:f}},{unitId:s,subUnitId:o,range:{startRow:w.startRow,endRow:w.endRow,startColumn:d.startColumn,endColumn:f-m}});M&&(p.push(...M.redos),C.push(...M.undos));const P=n.get(c.ICommandService);return c.sequenceExecute(p,P)&&n.get(c.IUndoRedoService).pushUndoRedo({unitID:s,undoMutations:C,redoMutations:p}),!0}};var Gt=Object.getOwnPropertyDescriptor,Xt=(n,e,t,a)=>{for(var r=a>1?void 0:a?Gt(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},be=(n,e)=>(t,a)=>e(t,a,n);let K=class extends c.Disposable{constructor(n,e){super(),this._tableManager=n,this._commandService=e,this._initRangeListener()}_initRangeListener(){this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(n=>{const{tableId:e,unitId:t}=n,a=this._tableManager.getTableById(t,e);a&&this._updateSuperTable(t,a)})),this.disposeWithMe(this._tableManager.tableAdd$.subscribe(n=>{const{tableId:e,unitId:t}=n,a=this._tableManager.getTableById(t,e);a&&this._updateSuperTable(t,a)})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(n=>{const{unitId:e,tableName:t}=n;this._commandService.executeCommand(ae.RemoveSuperTableMutation.id,{unitId:e,tableName:t})})),this.disposeWithMe(this._tableManager.tableNameChanged$.subscribe(n=>{const{tableId:e,unitId:t,oldTableName:a}=n;this._commandService.executeCommand(ae.RemoveSuperTableMutation.id,{unitId:t,tableName:a});const r=this._tableManager.getTableById(t,e);r&&this._updateSuperTable(t,r)}))}_updateSuperTable(n,e){const t=e.getTableInfo(),a=t.name,r=t.columns,s=new Map;r.forEach((o,l)=>{s.set(o.displayName,l)}),this._commandService.executeCommand(ae.SetSuperTableMutation.id,{unitId:n,tableName:a,reference:{range:t.range,sheetId:t.subUnitId,titleMap:s}})}};K=Xt([be(0,c.Inject(exports.TableManager)),be(1,c.ICommandService)],K);var zt=Object.getOwnPropertyDescriptor,Kt=(n,e,t,a)=>{for(var r=a>1?void 0:a?zt(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},Se=(n,e)=>(t,a)=>e(t,a,n);let Z=class extends c.Disposable{constructor(n,e){super(),this._tableManager=n,this._exclusiveRangeService=e,this._initRangeListener()}_initRangeListener(){this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(n=>{const{range:e,tableId:t,unitId:a,subUnitId:r}=n;this._exclusiveRangeService.clearExclusiveRangesByGroupId(a,r,k,t),this._exclusiveRangeService.addExclusiveRange(a,r,k,[{range:{...e},groupId:t}])})),this.disposeWithMe(this._tableManager.tableAdd$.subscribe(n=>{const{tableId:e,unitId:t,subUnitId:a,range:r}=n;this._exclusiveRangeService.addExclusiveRange(t,a,k,[{range:{...r},groupId:e}])})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(n=>{const{tableId:e,unitId:t,subUnitId:a}=n;this._exclusiveRangeService.clearExclusiveRangesByGroupId(t,a,k,e)}))}};Z=Kt([Se(0,c.Inject(exports.TableManager)),Se(1,c.Inject(S.IExclusiveRangeService))],Z);var Zt=Object.getOwnPropertyDescriptor,en=(n,e,t,a)=>{for(var r=a>1?void 0:a?Zt(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},B=(n,e)=>(t,a)=>e(t,a,n);let ee=class extends c.Disposable{constructor(n,e,t,a,r,s,o){super(),this._commandService=n,this._refRangeService=e,this._univerInstanceService=t,this._injector=a,this._sheetInterceptorService=r,this._tableManager=s,this._localeService=o,this._initCommandInterceptor(),this._initCommandListener()}_initCommandInterceptor(){const n=this;this._sheetInterceptorService.interceptCommand({getMutations(e){const t={redos:[],undos:[]},{id:a,params:r}=e;switch(a){case S.InsertRowCommand.id:return n._generateTableMutationWithInsertRow(r);case S.InsertColCommand.id:return n._generateTableMutationWithInsertCol(r);case S.RemoveRowCommand.id:return n._generateTableMutationWithRemoveRow(r);case S.RemoveColCommand.id:return n._generateTableMutationWithRemoveCol(r)}return t}})}_generateTableMutationWithInsertRow(n){const e=[],t=[],a=S.getSheetCommandTarget(this._univerInstanceService);if(!a)return{undos:e,redos:t};const{unitId:r,subUnitId:s}=a,o=this._tableManager.getTablesBySubunitId(r,s);if(!o.length)return{undos:e,redos:t};const{range:l}=n;return o.forEach(u=>{const i=u.getRange();if(l.startRow>i.startRow&&l.startRow<=i.endRow){const d=l.endRow-l.startRow+1;t.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:u.getId(),config:{updateRange:{newRange:{...i,endRow:i.endRow+d}}}}}),e.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:u.getId(),config:{updateRange:{newRange:{...i}}}}})}}),{undos:e,redos:t}}_generateTableMutationWithInsertCol(n){const e=[],t=[],a=S.getSheetCommandTarget(this._univerInstanceService);if(!a)return{undos:e,redos:t};const{unitId:r,subUnitId:s}=a,o=this._tableManager.getTablesBySubunitId(r,s);if(!o.length)return{undos:e,redos:t};const{range:l}=n;return o.forEach(u=>{const i=u.getRange();if(l.startColumn>i.startColumn&&l.startColumn<=i.endColumn){const d=l.endColumn-l.startColumn+1;t.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:l.startColumn,count:d}}}}),e.push({id:I.id,params:{unitId:r,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:l.startColumn,count:d}}}})}}),{undos:e,redos:t}}_generateTableMutationWithRemoveRow(n){const e=[],t=[],a=[],r=[],s=S.getSheetCommandTarget(this._univerInstanceService);if(!s)return{undos:e,redos:t,preRedos:a,preUndos:r};const{unitId:o,subUnitId:l}=s,u=this._tableManager.getTablesBySubunitId(o,l);if(!u.length)return{undos:e,redos:t,preRedos:a,preUndos:r};const{range:i}=n,d=i.endRow-i.startRow+1;return u.forEach(g=>{const h=g.getRange();if(c.Rectangle.intersects(h,i))if(i.startRow<=h.startRow&&i.endRow>=h.startRow){a.push({id:A.id,params:{unitId:o,subUnitId:l,tableId:g.getId()}});const m=g.toJSON();e.push({id:$.id,params:{unitId:o,subUnitId:l,tableId:m.id,name:m.name,range:m.range,options:m.options}})}else i.startRow>h.startRow&&i.startRow<=h.endRow?(t.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{updateRange:{newRange:{...h,endRow:h.endRow-d}}}}}),e.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{updateRange:{newRange:{...h}}}}})):i.startRow<h.endRow&&i.endRow>=h.endRow&&(t.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{updateRange:{newRange:{...h,endRow:i.startRow-1}}}}}),e.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{updateRange:{newRange:{...h}}}}}))}),{undos:e,redos:t,preRedos:a,preUndos:r}}_generateTableMutationWithRemoveCol(n){const e=[],t=[],a=[],r=[],s=S.getSheetCommandTarget(this._univerInstanceService);if(!s)return{undos:e,redos:t,preRedos:a,preUndos:r};const{unitId:o,subUnitId:l}=s,u=this._tableManager.getTablesBySubunitId(o,l);if(!u.length)return{undos:e,redos:t,preRedos:a,preUndos:r};const{range:i}=n,d=i.endColumn-i.startColumn+1;return u.forEach(g=>{const h=g.getRange();if(c.Rectangle.intersects(h,i)){if(i.startColumn<=h.startColumn&&i.endColumn>=h.endColumn){a.push({id:A.id,params:{unitId:o,subUnitId:l,tableId:g.getId()}});const m=g.toJSON(),{startRow:p,startColumn:C,endColumn:w}=m.range,R=this._univerInstanceService.getUnit(o),_=R==null?void 0:R.getSheetBySheetId(l);if(!_)return{undos:e,redos:t,preRedos:a,preUndos:r};const O=[];for(let f=C;f<=w;f++)O.push(Te(_==null?void 0:_.getCell(p,f))||H(f-C+1,this._localeService.t("sheets-table.columnPrefix")));e.push({id:$.id,params:{unitId:o,subUnitId:l,tableId:m.id,name:m.name,header:O,range:m.range,options:m.options}})}else if(i.startColumn<=h.startColumn&&i.endColumn>=h.startColumn){const m=i.endColumn-h.startColumn+1;t.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:h.startColumn,count:m}}}});const p=[];for(let C=0;C<m;C++){const w=g.getTableColumnByIndex(C);w&&p.push(w.toJSON())}e.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:h.startColumn,count:m,columnsJson:p}}}})}else if(i.startColumn>h.startColumn&&i.endColumn>h.endColumn){const m=h.endColumn-i.startColumn+1;t.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:i.startColumn,count:m}}}});const p=[],C=i.startColumn-h.startColumn;for(let w=0;w<m;w++){const R=g.getTableColumnByIndex(w+C);R&&p.push(R.toJSON())}e.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:i.startColumn,count:d,columnsJson:p}}}})}else if(i.startColumn>h.startColumn&&i.endColumn<=h.endColumn){t.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{rowColOperation:{operationType:v.Delete,rowColType:y.Col,index:i.startColumn,count:d}}}});const m=[],p=i.startColumn-h.startColumn;for(let C=0;C<d;C++){const w=g.getTableColumnByIndex(C+p);w&&m.push(w.toJSON())}e.push({id:I.id,params:{unitId:o,subUnitId:l,tableId:g.getId(),config:{rowColOperation:{operationType:v.Insert,rowColType:y.Col,index:i.startColumn,count:d,columnsJson:m}}}})}}}),{undos:e,redos:t,preRedos:a,preUndos:r}}_initCommandListener(){this._commandService.onCommandExecuted(n=>{if(n.id===S.InsertRowMutation.id){const e=n.params,{unitId:t,subUnitId:a,range:r}=e,s=r.endRow-r.startRow+1;this._tableManager.getTablesBySubunitId(t,a).forEach(l=>{const u=l.getRange();r.startRow<=u.startRow&&this._tableManager.updateTableRange(t,l.getId(),{newRange:{...u,startRow:u.startRow+s,endRow:u.endRow+s}})})}else if(n.id===S.InsertColMutation.id){const e=n.params,{unitId:t,subUnitId:a,range:r}=e,s=r.endColumn-r.startColumn+1;this._tableManager.getTablesBySubunitId(t,a).forEach(l=>{const u=l.getRange();r.startColumn<=u.startColumn&&this._tableManager.updateTableRange(t,l.getId(),{newRange:{...u,startColumn:u.startColumn+s,endColumn:u.endColumn+s}})})}else if(n.id===S.RemoveRowMutation.id){const e=n.params,{unitId:t,subUnitId:a,range:r}=e,s=r.endRow-r.startRow+1;this._tableManager.getTablesBySubunitId(t,a).forEach(l=>{const u=l.getRange();r.startRow<u.startRow&&this._tableManager.updateTableRange(t,l.getId(),{newRange:{...u,startRow:u.startRow-s,endRow:u.endRow-s}})})}else if(n.id===S.RemoveColMutation.id){const e=n.params,{unitId:t,subUnitId:a,range:r}=e,s=r.endColumn-r.startColumn+1;this._tableManager.getTablesBySubunitId(t,a).forEach(l=>{const u=l.getRange();r.startColumn<u.startColumn&&this._tableManager.updateTableRange(t,l.getId(),{newRange:{...u,startColumn:u.startColumn-s,endColumn:u.endColumn-s}})})}})}};ee=en([B(0,c.Inject(c.ICommandService)),B(1,c.Inject(S.RefRangeService)),B(2,c.Inject(c.IUniverInstanceService)),B(3,c.Inject(c.Injector)),B(4,c.Inject(S.SheetInterceptorService)),B(5,c.Inject(exports.TableManager)),B(6,c.Inject(c.LocaleService))],ee);var tn=Object.getOwnPropertyDescriptor,nn=(n,e,t,a)=>{for(var r=a>1?void 0:a?tn(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},Q=(n,e)=>(t,a)=>e(t,a,n);let te=class extends c.Disposable{constructor(e,t,a,r){super();T(this,"_defaultThemeIndex",0);T(this,"_allThemes",[]);this._tableManager=e,this._sheetRangeThemeService=t,this._sheetRangeThemeModel=a,this._configService=r,this._initUserTableTheme(),this.registerTableChangeEvent(),this._initDefaultTableTheme()}registerTableChangeEvent(){this.disposeWithMe(this._tableManager.tableAdd$.subscribe(e=>{const{range:t,tableId:a,unitId:r,subUnitId:s,tableStyleId:o}=e,l=this._tableManager.getTable(r,a),u=o||this._allThemes[this._defaultThemeIndex].name;l.setTableStyleId(u),this._sheetRangeThemeService.registerRangeThemeStyle(u,{unitId:r,subUnitId:s,range:{...t}})})),this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(e=>{const{range:t,oldRange:a,tableId:r,unitId:s,subUnitId:o}=e,l=this._tableManager.getTable(s,r);let u=l.getTableStyleId();u||(u=this._allThemes[this._defaultThemeIndex].name,l.setTableStyleId(u)),this._sheetRangeThemeService.removeRangeThemeRule(u,{unitId:s,subUnitId:o,range:{...a}}),this._sheetRangeThemeService.registerRangeThemeStyle(u,{unitId:s,subUnitId:o,range:{...t}})})),this.disposeWithMe(this._tableManager.tableThemeChanged$.subscribe(e=>{const{theme:t,oldTheme:a,tableId:r,unitId:s,subUnitId:o}=e,u=this._tableManager.getTable(s,r).getRange();this._sheetRangeThemeService.removeRangeThemeRule(a,{unitId:s,subUnitId:o,range:{...u}}),this._sheetRangeThemeService.registerRangeThemeStyle(t,{unitId:s,subUnitId:o,range:{...u}})})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(e=>{const{range:t,unitId:a,subUnitId:r,tableStyleId:s=this._allThemes[this._defaultThemeIndex].name}=e;this._sheetRangeThemeService.removeRangeThemeRule(s,{unitId:a,subUnitId:r,range:{...t}})}))}_initUserTableTheme(){const e=this._configService.getConfig(pe)||{},t=e.defaultThemeIndex||0,a=e.userThemes||[];this._defaultThemeIndex=t,this._allThemes=a.concat(Re)}_initDefaultTableTheme(){for(let e=0;e<this._allThemes.length;e++){const{name:t,style:a}=this._allThemes[e],r=new S.RangeThemeStyle(t,a);this._sheetRangeThemeModel.registerDefaultRangeTheme(r)}}dispose(){super.dispose(),this._allThemes=[],this._defaultThemeIndex=0}};te=nn([Q(0,c.Inject(exports.TableManager)),Q(1,c.Inject(S.SheetRangeThemeService)),Q(2,c.Inject(S.SheetRangeThemeModel)),Q(3,c.IConfigService)],te);var an=Object.getOwnPropertyDescriptor,rn=(n,e,t,a)=>{for(var r=a>1?void 0:a?an(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},Y=(n,e)=>(t,a)=>e(t,a,n);let ne=class extends c.Disposable{constructor(e,t,a,r){super();T(this,"_tableFilteredOutRows$",new D.BehaviorSubject(new Set));T(this,"tableFilteredOutRows$",this._tableFilteredOutRows$.asObservable());T(this,"_subscription",null);this._tableManager=e,this._sheetInterceptorService=t,this._univerInstanceService=a,this._zebraCrossingCacheController=r,this.registerFilterChangeEvent(),this.initTableHiddenRowIntercept(),this._initFilteredOutRows()}get tableFilteredOutRows(){return this._tableFilteredOutRows$.value}set tableFilteredOutRows(e){this._tableFilteredOutRows$.next(e)}initTableHiddenRowIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(S.INTERCEPTOR_POINT.ROW_FILTERED,{priority:100,handler:(e,t,a)=>{if(e)return!0;const r=this.tableFilteredOutRows.has(t.row);return r?!0:a(r)}}))}_initFilteredOutRows(){this._tableManager.tableInitStatus$.pipe(D.filter(e=>e),D.switchMap(()=>this._univerInstanceService.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_SHEET)),D.filter(e=>e!=null),D.switchMap(e=>e.activeSheet$),D.filter(e=>e!=null)).subscribe(()=>{const e=S.getSheetCommandTarget(this._univerInstanceService);if(!e)return;const{unitId:t,subUnitId:a}=e;this.tableFilteredOutRows.clear(),this._tableManager.getTablesBySubunitId(t,a).forEach(s=>{const o=s.getTableFilters().getFilterOutRows();if(o)for(const l of o)this.tableFilteredOutRows.add(l)})})}registerFilterChangeEvent(){this.disposeWithMe(this._tableManager.tableFilterChanged$.subscribe(e=>{var i;const{unitId:t,subUnitId:a,tableId:r}=e,s=(i=this._univerInstanceService.getUnit(t))==null?void 0:i.getSheetBySheetId(a),o=this._tableManager.getTable(t,r);if(!s||!o)return;this.tableFilteredOutRows.clear(),o.getTableFilters().doFilter(s,o.getTableFilterRange()),this._tableManager.getTablesBySubunitId(t,a).forEach(d=>{const g=d.getTableFilters().getFilterOutRows();if(g)for(const h of g)this.tableFilteredOutRows.add(h)}),this._zebraCrossingCacheController.updateZebraCrossingCache(t,a)}))}dispose(){var e;super.dispose(),(e=this._subscription)==null||e.unsubscribe()}};ne=rn([Y(0,c.Inject(exports.TableManager)),Y(1,c.Inject(S.SheetInterceptorService)),Y(2,c.Inject(c.IUniverInstanceService)),Y(3,c.Inject(S.ZebraCrossingCacheController))],ne);var sn=Object.getOwnPropertyDescriptor,on=(n,e,t,a)=>{for(var r=a>1?void 0:a?sn(e,t):e,s=n.length-1,o;s>=0;s--)(o=n[s])&&(r=o(r)||r);return r},re=(n,e)=>(t,a)=>e(t,a,n),G;exports.UniverSheetsTablePlugin=(G=class extends c.Plugin{constructor(e=ce,t,a,r){super(),this._config=e,this._injector=t,this._configService=a,this._commandService=r;const{...s}=c.merge({},ce,this._config);this._configService.setConfig(pe,s),this._initRegisterCommand()}onStarting(){c.registerDependencies(this._injector,[[exports.TableManager],[te],[exports.SheetsTableController],[exports.SheetTableService],[ne],[Z],[ee],[K]])}onReady(){c.touchDependencies(this._injector,[[K],[Z],[ee],[te],[exports.SheetsTableController],[exports.SheetTableService],[ne]]),c.touchDependencies(this._injector,[[exports.TableManager]])}_initRegisterCommand(){[fe,$,_e,A,z,ve,Ne,I,ye,De,xe,Oe,Ue,Ee].forEach(e=>this._commandService.registerCommand(e))}},T(G,"pluginName",Me),T(G,"type",c.UniverInstanceType.UNIVER_SHEET),G);exports.UniverSheetsTablePlugin=on([re(1,c.Inject(c.Injector)),re(2,c.IConfigService),re(3,c.Inject(c.ICommandService))],exports.UniverSheetsTablePlugin);exports.AddSheetTableCommand=fe;exports.AddSheetTableMutation=$;exports.AddTableThemeCommand=ye;exports.DeleteSheetTableCommand=_e;exports.DeleteSheetTableMutation=A;exports.RemoveTableThemeCommand=De;exports.SHEET_TABLE_CUSTOM_THEME_PREFIX=Fe;exports.SetSheetTableCommand=Ne;exports.SetSheetTableFilterCommand=ve;exports.SetSheetTableFilterMutation=z;exports.SetSheetTableMutation=I;exports.SheetTableInsertColCommand=Oe;exports.SheetTableInsertRowCommand=xe;exports.SheetTableRemoveColCommand=Ee;exports.SheetTableRemoveRowCommand=Ue;exports.SheetsTableButtonStateEnum=E;exports.SheetsTableSortStateEnum=L;exports.TableColumnDataTypeEnum=se;exports.TableColumnFilterTypeEnum=q;exports.TableConditionTypeEnum=N;exports.TableDateCompareTypeEnum=b;exports.TableNumberCompareTypeEnum=F;exports.TableStringCompareTypeEnum=U;exports.customEmptyThemeWithBorderStyle=qe;exports.isConditionFilter=Ce;exports.isManualFilter=We;exports.processStyleWithBorderStyle=Ve;
