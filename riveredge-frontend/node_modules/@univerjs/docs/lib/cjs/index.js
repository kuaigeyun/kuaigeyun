"use strict";var G=Object.defineProperty;var z=(r,i,e)=>i in r?G(r,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[i]=e;var d=(r,i,e)=>z(r,typeof i!="symbol"?i+"":i,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const c=require("@univerjs/core"),D=require("@univerjs/engine-render"),v=require("rxjs"),C={id:"doc.operation.set-selections",type:c.CommandType.OPERATION,handler:()=>!0};var W=Object.getOwnPropertyDescriptor,J=(r,i,e,t)=>{for(var n=t>1?void 0:t?W(i,e):i,s=r.length-1,o;s>=0;s--)(o=r[s])&&(n=o(n)||n);return n},k=(r,i)=>(e,t)=>i(e,t,r);exports.DocSelectionManagerService=class extends c.RxDisposable{constructor(e,t){super();d(this,"_currentSelection",null);d(this,"_textSelectionInfo",new Map);d(this,"_textSelection$",new v.Subject);d(this,"textSelection$",this._textSelection$.asObservable());d(this,"_refreshSelection$",new v.BehaviorSubject(null));d(this,"refreshSelection$",this._refreshSelection$.asObservable());this._commandService=e,this._univerInstanceService=t,this._listenCurrentUnit()}_listenCurrentUnit(){this._univerInstanceService.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_DOC).pipe(v.takeUntil(this.dispose$)).subscribe(e=>{if(e==null)return;const t=e.getUnitId();this._setCurrentSelectionNotRefresh({unitId:t,subUnitId:t})})}__getCurrentSelection(){return this._currentSelection}getSelectionInfo(e=this._currentSelection){return this._getTextRanges(e)}refreshSelection(e=this._currentSelection){e!=null&&this._refresh(e)}__TEST_ONLY_setCurrentSelection(e){this._currentSelection=e,this._refresh(e)}getTextRanges(e=this._currentSelection){var t;return(t=this._getTextRanges(e))==null?void 0:t.textRanges}getRectRanges(e=this._currentSelection){var t;return(t=this._getTextRanges(e))==null?void 0:t.rectRanges}getDocRanges(e=this._currentSelection){var o,a;const t=(o=this.getTextRanges(e))!=null?o:[],n=(a=this.getRectRanges(e))!=null?a:[];return[...t,...n].filter(l=>l.startOffset!=null&&l.endOffset!=null).sort((l,u)=>l.startOffset>u.startOffset?1:l.startOffset<u.startOffset?-1:0)}getActiveTextRange(){const e=this._getTextRanges(this._currentSelection);if(e==null)return;const{textRanges:t}=e;return t.find(n=>n.isActive)}getActiveRectRange(){const e=this._getTextRanges(this._currentSelection);if(e==null)return;const{rectRanges:t}=e;return t.find(n=>n.isActive)}__TEST_ONLY_add(e,t=!0){this._currentSelection!=null&&this._addByParam({...this._currentSelection,textRanges:e,rectRanges:[],segmentId:"",segmentPage:-1,isEditing:t,style:D.NORMAL_TEXT_SELECTION_PLUGIN_STYLE})}replaceTextRanges(e,t=!0,n){return this.replaceDocRanges(e,this._currentSelection,t,n)}replaceDocRanges(e,t=this._currentSelection,n=!0,s){if(t==null)return;const{unitId:o,subUnitId:a}=t;this._refreshSelection$.next({unitId:o,subUnitId:a,docRanges:e,isEditing:n,options:s})}__replaceTextRangesWithNoRefresh(e,t){if(this._currentSelection==null)return;const n={...e,...t};this._replaceByParam(n),this._textSelection$.next(n);const{unitId:s,subUnitId:o,segmentId:a,style:l,textRanges:u,rectRanges:g,isEditing:_}=n,f=[...u,...g].filter(h=>h.startOffset!=null&&h.endOffset!=null).sort((h,S)=>h.startOffset>S.startOffset?1:h.startOffset<S.startOffset?-1:0);this._commandService.executeCommand(C.id,{unitId:s,subUnitId:o,segmentId:a,style:l,isEditing:_,ranges:f})}dispose(){this._textSelection$.complete(),this._refreshSelection$.complete()}_setCurrentSelectionNotRefresh(e){this._currentSelection=e}_getTextRanges(e){var s;if(e==null)return;const{unitId:t,subUnitId:n=""}=e;return(s=this._textSelectionInfo.get(t))==null?void 0:s.get(n)}_refresh(e){const t=this._getTextRanges(e);if(t==null)return;const{textRanges:n,rectRanges:s}=t,o=[...n,...s],{unitId:a,subUnitId:l}=e;this._refreshSelection$.next({unitId:a,subUnitId:l,docRanges:o,isEditing:!1})}_replaceByParam(e){const{unitId:t,subUnitId:n,...s}=e;this._textSelectionInfo.has(t)||this._textSelectionInfo.set(t,new Map),this._textSelectionInfo.get(t).set(n,{...s})}_addByParam(e){const{unitId:t,subUnitId:n,...s}=e;this._textSelectionInfo.has(t)||this._textSelectionInfo.set(t,new Map);const o=this._textSelectionInfo.get(t);o.has(n)?o.get(n).textRanges.push(...e.textRanges):o.set(n,{...s})}};exports.DocSelectionManagerService=J([k(0,c.ICommandService),k(1,c.IUniverInstanceService)],exports.DocSelectionManagerService);var Y=Object.getOwnPropertyDescriptor,K=(r,i,e,t)=>{for(var n=t>1?void 0:t?Y(i,e):i,s=r.length-1,o;s>=0;s--)(o=r[s])&&(n=o(n)||n);return n},V=(r,i)=>(e,t)=>i(e,t,r);exports.DocSkeletonManagerService=class extends c.RxDisposable{constructor(e,t,n){super();d(this,"_skeleton");d(this,"_docViewModel");d(this,"_currentSkeleton$",new v.BehaviorSubject(null));d(this,"currentSkeleton$",this._currentSkeleton$.asObservable());d(this,"_currentSkeletonBefore$",new v.BehaviorSubject(null));d(this,"currentSkeletonBefore$",this._currentSkeletonBefore$.asObservable());d(this,"_currentViewModel$",new v.BehaviorSubject(null));d(this,"currentViewModel$",this._currentViewModel$.asObservable());this._context=e,this._localeService=t,this._univerInstanceService=n,this._init(),this._univerInstanceService.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_DOC).pipe(v.takeUntil(this.dispose$)).subscribe(s=>{s&&s.getUnitId()===this._context.unitId&&this._update(s)})}dispose(){super.dispose(),this._currentSkeletonBefore$.complete(),this._currentSkeleton$.complete()}getSkeleton(){return this._skeleton}getViewModel(){return this._docViewModel}_init(){const e=this._context.unit;this._update(e)}_update(e){const t=this._context.unitId;if(e.getBody()==null)return;this._docViewModel&&c.isInternalEditorID(t)?(this._docViewModel.reset(e),this._context.unit=e):this._docViewModel||(this._docViewModel=this._buildDocViewModel(e)),this._skeleton||(this._skeleton=this._buildSkeleton(this._docViewModel));const n=this._skeleton;n.calculate(),this._currentSkeletonBefore$.next(n),this._currentSkeleton$.next(n),this._currentViewModel$.next(this._docViewModel)}_buildSkeleton(e){return D.DocumentSkeleton.create(e,this._localeService)}_buildDocViewModel(e){return new D.DocumentViewModel(e)}};exports.DocSkeletonManagerService=K([V(1,c.Inject(c.LocaleService)),V(2,c.IUniverInstanceService)],exports.DocSkeletonManagerService);class b extends c.RxDisposable{constructor(){super();d(this,"_docStateChangeParams$",new v.BehaviorSubject(null));d(this,"docStateChangeParams$",this._docStateChangeParams$.asObservable())}emitStateChangeInfo(e){this._docStateChangeParams$.next(e)}dispose(){super.dispose(),this._docStateChangeParams$.complete()}}const j="doc.mutation.rich-text-editing",x={id:j,type:c.CommandType.MUTATION,handler:(r,i)=>{var P,B;const{unitId:e,segmentId:t="",actions:n,textRanges:s,prevTextRanges:o,trigger:a,noHistory:l,isCompositionEnd:u,noNeedSetTextRange:g,debounce:_,isEditing:f=!0,isSync:h,syncer:S}=i,m=r.get(c.IUniverInstanceService),p=r.get(D.IRenderManagerService),R=r.get(b),I=m.getUniverDocInstance(e),E=(P=p.getRenderById(e))==null?void 0:P.with(exports.DocSkeletonManagerService).getViewModel();if(I==null||E==null)throw new Error(`DocumentDataModel or documentViewModel not found for unitId: ${e}`);const N=r.get(exports.DocSelectionManagerService),T=(B=N.getDocRanges())!=null?B:[],F=!!I.getSnapshot().disabled;if(c.JSONX.isNoop(n)||n&&n.length===0||F)return{unitId:e,actions:[],textRanges:T};const $=c.JSONX.invertWithDoc(n,I.getSnapshot());I.apply(n),E.reset(I),!g&&s&&a!=null&&!h&&queueMicrotask(()=>{N.replaceDocRanges(s,{unitId:e,subUnitId:e},f,i.options)});const L={commandId:j,unitId:e,segmentId:t,trigger:a,noHistory:l,debounce:_,redoState:{actions:n,textRanges:s},undoState:{actions:$,textRanges:o!=null?o:T},isCompositionEnd:u,isSync:h,syncer:S};return R.emitStateChangeInfo(L),{unitId:e,actions:$,textRanges:T}}},q={id:"doc.mutation.rename-doc",type:c.CommandType.MUTATION,handler:(r,i)=>{const t=r.get(c.IUniverInstanceService).getUnit(i.unitId,c.UniverInstanceType.UNIVER_DOC);return t?(t.setName(i.name),!0):!1}},H="docs.config",A={};var Q=Object.getOwnPropertyDescriptor,Z=(r,i,e,t)=>{for(var n=t>1?void 0:t?Q(i,e):i,s=r.length-1,o;s>=0;s--)(o=r[s])&&(n=o(n)||n);return n},y=(r,i)=>(e,t)=>i(e,t,r);let M=class extends c.Disposable{constructor(r,i,e){super(),this._commandService=r,this._textSelectionManagerService=i,this._univerInstanceService=e,this._initSelectionChange()}_transformCustomRange(r,i){var o;const{startOffset:e,endOffset:t,collapsed:n}=i,s=(o=r.getCustomRanges())==null?void 0:o.filter(a=>!a.wholeEntity||e<=a.startIndex&&t>a.endIndex?!1:n?a.startIndex<e&&a.endIndex>=t:c.BuildTextUtils.range.isIntersects(e,t-1,a.startIndex,a.endIndex));if(s!=null&&s.length){let a=e,l=t;return s.forEach(u=>{a=Math.min(u.startIndex,a),l=Math.max(u.endIndex+1,l)}),{...i,startOffset:a,endOffset:l,collapsed:a===l}}return i}_initSelectionChange(){this.disposeWithMe(this._commandService.onCommandExecuted(r=>{if(r.id===C.id){const i=r.params,{unitId:e,ranges:t,isEditing:n}=i,s=this._univerInstanceService.getUnit(e);if(!s)return;const o=t.map(a=>this._transformCustomRange(s,a));o.some((a,l)=>t[l]!==a)&&this._textSelectionManagerService.replaceTextRanges(o,n)}}))}};M=Z([y(0,c.ICommandService),y(1,c.Inject(exports.DocSelectionManagerService)),y(2,c.IUniverInstanceService)],M);var ee=Object.getOwnPropertyDescriptor,te=(r,i,e,t)=>{for(var n=t>1?void 0:t?ee(i,e):i,s=r.length-1,o;s>=0;s--)(o=r[s])&&(n=o(n)||n);return n},X=(r,i)=>(e,t)=>i(e,t,r);const ne="DOCS_PLUGIN";var U;exports.UniverDocsPlugin=(U=class extends c.Plugin{constructor(i=A,e,t){super(),this._config=i,this._injector=e,this._configService=t;const{...n}=c.merge({},A,this._config);this._configService.setConfig(H,n)}onStarting(){this._initializeDependencies(),this._initializeCommands()}_initializeCommands(){[x,q,C].forEach(i=>{this._injector.get(c.ICommandService).registerCommand(i)})}_initializeDependencies(){[[exports.DocSelectionManagerService],[b],[M]].forEach(i=>this._injector.add(i))}onReady(){this._injector.get(M)}},d(U,"pluginName",ne),U);exports.UniverDocsPlugin=te([X(1,c.Inject(c.Injector)),X(2,c.IConfigService)],exports.UniverDocsPlugin);const ie=c.createInterceptorKey("CUSTOM_RANGE"),se=c.createInterceptorKey("CUSTOM_DECORATION"),O={CUSTOM_RANGE:ie,CUSTOM_DECORATION:se};var re=Object.getOwnPropertyDescriptor,oe=(r,i,e,t)=>{for(var n=t>1?void 0:t?re(i,e):i,s=r.length-1,o;s>=0;s--)(o=r[s])&&(n=o(n)||n);return n},ce=(r,i)=>(e,t)=>i(e,t,r);exports.DocInterceptorService=class extends c.Disposable{constructor(e,t){super();d(this,"_interceptorsByName",new Map);this._context=e,this._docSkeletonManagerService=t;const n=this._docSkeletonManagerService.getViewModel(),s=n.getDataModel().getUnitId();if(s===c.DOCS_NORMAL_EDITOR_UNIT_ID_KEY||s===c.DOCS_FORMULA_BAR_EDITOR_UNIT_ID_KEY)return;this.disposeWithMe(this.interceptDocumentViewModel(n)),this.disposeWithMe(this.intercept(O.CUSTOM_RANGE,{priority:-1,handler:(a,l,u)=>u(a)}));let o=new c.DisposableCollection;n.segmentViewModels$.subscribe(a=>{o.dispose(),o=new c.DisposableCollection,a.forEach(l=>{o.add(this.interceptDocumentViewModel(l))})}),this.disposeWithMe(o)}intercept(e,t){const n=e;this._interceptorsByName.has(n)||this._interceptorsByName.set(n,[]);const s=this._interceptorsByName.get(n);return s.push(t),this._interceptorsByName.set(n,s.sort((o,a)=>{var l,u;return((l=a.priority)!=null?l:0)-((u=o.priority)!=null?u:0)})),this.disposeWithMe(c.toDisposable(()=>c.remove(this._interceptorsByName.get(n),t)))}fetchThroughInterceptors(e){const t=e,n=this._interceptorsByName.get(t);return c.composeInterceptors(n||[])}interceptDocumentViewModel(e){const t=new c.DisposableCollection;return t.add(e.registerCustomRangeInterceptor({getCustomRange:n=>{var s;return this.fetchThroughInterceptors(O.CUSTOM_RANGE)(e.getCustomRangeRaw(n),{index:n,unitId:e.getDataModel().getUnitId(),customRanges:(s=e.getDataModel().getCustomRanges())!=null?s:[]})},getCustomDecoration:n=>{var s;return this.fetchThroughInterceptors(O.CUSTOM_DECORATION)(e.getCustomDecorationRaw(n),{index:n,unitId:e.getDataModel().getUnitId(),customDecorations:(s=e.getDataModel().getCustomDecorations())!=null?s:[]})}})),t}};exports.DocInterceptorService=oe([ce(1,c.Inject(exports.DocSkeletonManagerService))],exports.DocInterceptorService);function w(r,i=""){if(!i)return["body"];const{headers:e,footers:t}=r.getSnapshot();if(e==null&&t==null)throw new Error("Document data model must have headers or footers when update by segment id");if((e==null?void 0:e[i])!=null)return["headers",i,"body"];if((t==null?void 0:t[i])!=null)return["footers",i,"body"];throw new Error("Segment id not found in headers or footers")}function ae(r,i,e){const{unitId:t,segmentId:n}=i,o=r.get(c.IUniverInstanceService).getUnit(t);if(!o)return!1;const a={id:x.id,params:{unitId:i.unitId,actions:[],textRanges:void 0}},l=c.JSONX.getInstance(),u=c.BuildTextUtils.customRange.add({...i,body:e});if(!u)return!1;const g=w(o,n);return a.params.actions=l.editOp(u.serialize(),g),a}function le(r,i){var I;const{rangeId:e,rangeType:t,wholeEntity:n,properties:s,unitId:o,selections:a}=i,l=r.get(exports.DocSelectionManagerService),u=r.get(c.IUniverInstanceService),g=a!=null?a:l.getTextRanges({unitId:o,subUnitId:o}),_=(I=g==null?void 0:g[0])==null?void 0:I.segmentId;if(!(g!=null&&g.length))return!1;const f=u.getUnit(o,c.UniverInstanceType.UNIVER_DOC);if(!f)return!1;const h=f.getSelfOrHeaderFooterModel(_).getBody();if(!h)return!1;const S=c.BuildTextUtils.customRange.add({ranges:g,rangeId:e,rangeType:t,segmentId:_,wholeEntity:n,properties:s,body:h});if(!S)return!1;const m=c.JSONX.getInstance(),p={id:x.id,params:{unitId:o,actions:[],textRanges:S.selections,segmentId:_},textX:S},R=w(f,_);return p.params.actions=m.editOp(S.serialize(),R),p}function ue(r,i){const{unitId:e,segmentId:t,insert:n}=i,o=r.get(c.IUniverInstanceService).getUnit(e);if(!o)return!1;const a={id:x.id,params:{unitId:i.unitId,actions:[],textRanges:void 0,segmentId:t}},l=c.JSONX.getInstance(),u=c.BuildTextUtils.customRange.delete({documentDataModel:o,rangeId:i.rangeId,insert:n,segmentId:t});if(!u)return!1;const g=w(o,t);return a.params.actions=l.editOp(u.serialize(),g),a.params.textRanges=u.selections,a}function de(r,i){var S,m,p,R;const{unitId:e,body:t,doc:n}=i;let s=n;if(s||(s=r.get(c.IUniverInstanceService).getUnit(e)),!s)return!1;const o=(S=i.selection)==null?void 0:S.segmentId,a=(m=s.getSelfOrHeaderFooterModel(o))==null?void 0:m.getBody();if(!a)return!1;const l=r.get(exports.DocSelectionManagerService),u=(p=i.selection)!=null?p:l.getActiveTextRange();if(!u||!a)return!1;const g=(R=i.textRanges)!=null?R:[{startOffset:u.startOffset+t.dataStream.length,endOffset:u.startOffset+t.dataStream.length,collapsed:!0,segmentId:o}],_=c.BuildTextUtils.selection.replace({selection:u,body:t,doc:s});if(!_)return!1;const f={id:x.id,params:{unitId:e,actions:[],textRanges:g,debounce:!0,segmentId:o},textX:_},h=c.JSONX.getInstance();return f.params.actions=h.editOp(_.serialize()),f}exports.DOC_INTERCEPTOR_POINT=O;exports.DocStateEmitService=b;exports.RichTextEditingMutation=x;exports.SetTextSelectionsOperation=C;exports.addCustomRangeBySelectionFactory=le;exports.addCustomRangeFactory=ae;exports.deleteCustomRangeFactory=ue;exports.replaceSelectionFactory=de;
