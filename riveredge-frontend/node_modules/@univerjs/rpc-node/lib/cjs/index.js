"use strict";var p=Object.defineProperty;var R=(n,e,r)=>e in n?p(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var l=(n,e,r)=>R(n,typeof e!="symbol"?e+"":e,r);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const S=require("node:child_process"),h=require("node:process"),c=require("@univerjs/core"),t=require("@univerjs/rpc"),g=require("rxjs"),N="rpc-node.main-thread.config",P={},I="rpc-node.worker-thread.config",v={};var m=Object.getOwnPropertyDescriptor,f=(n,e,r,o)=>{for(var s=o>1?void 0:o?m(e,r):e,i=n.length-1,a;i>=0;i--)(a=n[i])&&(s=a(s)||s);return s},d=(n,e)=>(r,o)=>e(r,o,n),u;exports.UniverRPCNodeMainPlugin=(u=class extends c.Plugin{constructor(r=P,o,s){super();l(this,"_child",null);this._config=r,this._injector=o,this._configService=s;const{...i}=c.merge({},P,this._config);this._configService.setConfig(N,i)}onStarting(){const{workerSrc:r}=this._config;if(!r)throw new Error("[UniverRPCNodeMainPlugin] workerSrc is required for UniverRPCNodeMainPlugin");const[o,s]=y(this._injector,r);[[t.IRPCChannelService,{useFactory:()=>new t.ChannelService(o)}],[t.DataSyncPrimaryController],[t.IRemoteSyncService,{useClass:t.RemoteSyncPrimaryService}]].forEach(a=>this._injector.add(a)),this._injector.get(t.DataSyncPrimaryController),this._child=s}dispose(){if(super.dispose(),this._child){try{this._child.kill()}catch(r){console.error("Failed to kill child process:",r)}this._child=null}}},l(u,"pluginName","UNIVER_RPC_NODE_MAIN_PLUGIN"),u);exports.UniverRPCNodeMainPlugin=f([d(1,c.Inject(c.Injector)),d(2,c.IConfigService)],exports.UniverRPCNodeMainPlugin);var _;exports.UniverRPCNodeWorkerPlugin=(_=class extends c.Plugin{constructor(e=v,r,o){super(),this._config=e,this._injector=r,this._configService=o;const{...s}=c.merge({},v,this._config);this._configService.setConfig(I,s)}onStarting(){[[t.DataSyncReplicaController],[t.IRPCChannelService,{useFactory:()=>new t.ChannelService(U())}],[t.IRemoteInstanceService,{useClass:t.WebWorkerRemoteInstanceService}]].forEach(e=>this._injector.add(e)),this._injector.get(t.DataSyncReplicaController)}},l(_,"pluginName","UNIVER_RPC_NODE_WORKER_PLUGIN"),_);exports.UniverRPCNodeWorkerPlugin=f([d(1,c.Inject(c.Injector)),d(2,c.IConfigService)],exports.UniverRPCNodeWorkerPlugin);function y(n,e){const r=n.get(c.ILogService),o=S.fork(e);return o.on("spawn",()=>r.log("Child computing process spawned!")),o.on("error",i=>r.error(i)),[{send(i){o.send(i)},onMessage:new g.Observable(i=>{const a=C=>{i.next(C)};return o.on("message",a),()=>o.off("message",a)}).pipe(g.shareReplay(1))},o]}function U(){return{send(n){h.send(n)},onMessage:new g.Observable(n=>{const e=r=>{n.next(r)};return h.on("message",e),()=>h.off("message",e)}).pipe(g.shareReplay(1))}}
