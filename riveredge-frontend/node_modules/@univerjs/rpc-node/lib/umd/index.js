(function(e,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("node:child_process"),require("node:process"),require("@univerjs/core"),require("@univerjs/rpc"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","node:child_process","node:process","@univerjs/core","@univerjs/rpc","rxjs"],o):(e=typeof globalThis<"u"?globalThis:e||self,o(e.UniverRpcNode={},e.node_child_process,e.process,e.UniverCore,e.UniverRpc,e.rxjs))})(this,(function(e,o,l,a,s,g){"use strict";var U=Object.defineProperty;var j=(e,o,l)=>o in e?U(e,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[o]=l;var _=(e,o,l)=>j(e,typeof o!="symbol"?o+"":o,l);var f,P;const S="rpc-node.main-thread.config",v={},N="rpc-node.worker-thread.config",C={};var p=Object.getOwnPropertyDescriptor,R=(t,r,n,i)=>{for(var d=i>1?void 0:i?p(r,n):r,c=t.length-1,u;c>=0;c--)(u=t[c])&&(d=u(d)||d);return d},h=(t,r)=>(n,i)=>r(n,i,t);e.UniverRPCNodeMainPlugin=(f=class extends a.Plugin{constructor(n=v,i,d){super();_(this,"_child",null);this._config=n,this._injector=i,this._configService=d;const{...c}=a.merge({},v,this._config);this._configService.setConfig(S,c)}onStarting(){const{workerSrc:n}=this._config;if(!n)throw new Error("[UniverRPCNodeMainPlugin] workerSrc is required for UniverRPCNodeMainPlugin");const[i,d]=m(this._injector,n);[[s.IRPCChannelService,{useFactory:()=>new s.ChannelService(i)}],[s.DataSyncPrimaryController],[s.IRemoteSyncService,{useClass:s.RemoteSyncPrimaryService}]].forEach(u=>this._injector.add(u)),this._injector.get(s.DataSyncPrimaryController),this._child=d}dispose(){if(super.dispose(),this._child){try{this._child.kill()}catch(n){console.error("Failed to kill child process:",n)}this._child=null}}},_(f,"pluginName","UNIVER_RPC_NODE_MAIN_PLUGIN"),f),e.UniverRPCNodeMainPlugin=R([h(1,a.Inject(a.Injector)),h(2,a.IConfigService)],e.UniverRPCNodeMainPlugin),e.UniverRPCNodeWorkerPlugin=(P=class extends a.Plugin{constructor(r=C,n,i){super(),this._config=r,this._injector=n,this._configService=i;const{...d}=a.merge({},C,this._config);this._configService.setConfig(N,d)}onStarting(){[[s.DataSyncReplicaController],[s.IRPCChannelService,{useFactory:()=>new s.ChannelService(I())}],[s.IRemoteInstanceService,{useClass:s.WebWorkerRemoteInstanceService}]].forEach(r=>this._injector.add(r)),this._injector.get(s.DataSyncReplicaController)}},_(P,"pluginName","UNIVER_RPC_NODE_WORKER_PLUGIN"),P),e.UniverRPCNodeWorkerPlugin=R([h(1,a.Inject(a.Injector)),h(2,a.IConfigService)],e.UniverRPCNodeWorkerPlugin);function m(t,r){const n=t.get(a.ILogService),i=o.fork(r);return i.on("spawn",()=>n.log("Child computing process spawned!")),i.on("error",c=>n.error(c)),[{send(c){i.send(c)},onMessage:new g.Observable(c=>{const u=y=>{c.next(y)};return i.on("message",u),()=>i.off("message",u)}).pipe(g.shareReplay(1))},i]}function I(){return{send(t){l.send(t)},onMessage:new g.Observable(t=>{const r=n=>{t.next(n)};return l.on("message",r),()=>l.off("message",r)}).pipe(g.shareReplay(1))}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
