{"version":3,"file":"index.js","names":["props: React.PropsWithChildren<{ dependencies: Dependency[] }>","context: { injector: Injector | null }","childInjector: Injector","Comp: React.ComponentType<P>","injector: Injector","props: P","dependencies: Dependency[]","component: React.Component<T>","id: DependencyIdentifier<T>","quantity?: Quantity","lookUp?: LookUp","thisComponent: React.Component<T>","id: DependencyIdentifier<T>","quantityOrLookUp?: Quantity | LookUp","lookUp?: LookUp","o: ObservableOrFn<T>","observable: Nullable<ObservableOrFn<T>>","defaultValue?: undefined","shouldHaveSyncValue?: true","deps?: any[]","innerDefaultValue: T | undefined","subscription: Subscription | null","update$: Observable<void>","globalObject: any"],"sources":["../../../src/react-bindings/reactContext.tsx","../../../src/react-bindings/reactComponent.tsx","../../../src/react-bindings/reactDecorators.ts","../../../src/react-bindings/reactHooks.tsx","../../../src/react-bindings/reactRx.tsx","../../../src/react-bindings/publicApi.ts"],"sourcesContent":["import type { Injector } from '@wendellhu/redi';\nimport { createContext } from 'react';\n\nexport interface IRediContext {\n  injector: Injector | null;\n}\n\nexport const RediContext = createContext<IRediContext>({\n  injector: null,\n});\nRediContext.displayName = 'RediContext';\n\nexport const RediProvider = RediContext.Provider;\nexport const RediConsumer = RediContext.Consumer;\n","import type { Dependency } from '@wendellhu/redi';\nimport { Injector } from '@wendellhu/redi';\nimport React, { useEffect, useRef } from 'react';\nimport { RediConsumer, RediProvider } from './reactContext';\n\nfunction RediInjector(\n  props: React.PropsWithChildren<{ dependencies: Dependency[] }>,\n) {\n  const { children, dependencies } = props;\n  const childInjectorRef = useRef<Injector | null>(null);\n\n  // dispose the injector when the container Injector unmounts\n  useEffect(() => () => childInjectorRef.current?.dispose(), []);\n\n  return (\n    <RediConsumer>\n      {(context: { injector: Injector | null }) => {\n        let childInjector: Injector;\n\n        /* istanbul ignore next -- @preserve */\n        if (childInjectorRef.current) {\n          childInjector = childInjectorRef.current;\n        } else {\n          childInjector = context.injector\n            ? context.injector.createChild(dependencies)\n            : new Injector(dependencies);\n\n          childInjectorRef.current = childInjector;\n        }\n\n        return (\n          <RediProvider value={{ injector: childInjector }}>\n            {children}\n          </RediProvider>\n        );\n      }}\n    </RediConsumer>\n  );\n}\n\n/**\n * @param Comp\n * @param injector\n * @returns A component type that can be rendered.\n */\nexport function connectInjector<P>(\n  Comp: React.ComponentType<P>,\n  injector: Injector,\n): React.ComponentType<P> {\n  return function ComponentWithInjector(props: P) {\n    return (\n      <RediProvider value={{ injector }}>\n        <Comp {...(props as P & React.JSX.IntrinsicAttributes)} />\n      </RediProvider>\n    );\n  };\n}\n\nexport function connectDependencies<P>(\n  Comp: React.ComponentType<P>,\n  dependencies: Dependency[],\n): React.ComponentType<P> {\n  return function ComponentWithInjector(props: P) {\n    return (\n      <RediInjector dependencies={dependencies}>\n        <Comp {...(props as P & React.JSX.IntrinsicAttributes)} />\n      </RediInjector>\n    );\n  };\n}\n","import type { DependencyIdentifier, LookUp } from '@wendellhu/redi';\nimport type { IRediContext } from './reactContext';\nimport { Quantity, RediError } from '@wendellhu/redi';\n\nclass ClassComponentNotInRediContextError<T> extends RediError {\n  constructor(component: React.Component<T>) {\n    super(\n      `You should make \"RediContext\" as ${component.constructor.name}'s default context type. ` +\n      'If you want to use multiple context, please check this on React doc site. ' +\n      'https://reactjs.org/docs/context.html#classcontexttype',\n    );\n  }\n}\n\nexport function WithDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantity?: Quantity,\n  lookUp?: LookUp,\n): any {\n  return function () {\n    return {\n      get(): T | T[] | null {\n        const thisComponent: React.Component<T> = this as any;\n\n        const context = thisComponent.context as IRediContext | null;\n        if (!context || !context.injector) {\n          throw new ClassComponentNotInRediContextError(thisComponent);\n        }\n\n        const injector = context.injector;\n        const thing = injector.get(id, quantity || Quantity.REQUIRED, lookUp);\n\n        return thing;\n      },\n    };\n  };\n}\n","import type {\n  DependencyIdentifier,\n  Injector,\n  LookUp,\n  Quantity,\n} from '@wendellhu/redi';\nimport { RediError } from '@wendellhu/redi';\nimport { useContext, useMemo } from 'react';\nimport { RediContext } from './reactContext';\n\nclass HooksNotInRediContextError extends RediError {\n  constructor() {\n    super('Using dependency injection outside of a RediContext.');\n  }\n}\n\nexport function useInjector(): Injector {\n  const injectionContext = useContext(RediContext);\n  if (!injectionContext.injector) {\n    throw new HooksNotInRediContextError();\n  }\n\n  return injectionContext.injector;\n}\n\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  lookUp?: LookUp,\n): T;\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantity: Quantity.MANY,\n  lookUp?: LookUp,\n): T[];\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantity: Quantity.OPTIONAL,\n  lookUp?: LookUp,\n): T | null;\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantity: Quantity.REQUIRED,\n  lookUp?: LookUp,\n): T;\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantity: Quantity,\n  lookUp?: LookUp,\n): T | T[] | null;\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantity?: Quantity,\n  lookUp?: LookUp,\n): T | T[] | null;\nexport function useDependency<T>(\n  id: DependencyIdentifier<T>,\n  quantityOrLookUp?: Quantity | LookUp,\n  lookUp?: LookUp,\n): T | T[] | null {\n  const injector = useInjector();\n  return useMemo(\n    () => injector.get<T>(id, quantityOrLookUp, lookUp),\n    [id, quantityOrLookUp, lookUp],\n  );\n}\n","import type { Observable, Subscription } from 'rxjs';\nimport { RediError } from '@wendellhu/redi';\nimport { useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';\n\ntype ObservableOrFn<T> = Observable<T> | (() => Observable<T>);\ntype Nullable<T> = T | undefined | null;\n\nfunction unwrap<T>(o: ObservableOrFn<T>): Observable<T> {\n  if (typeof o === 'function') {\n    return o();\n  }\n\n  return o;\n}\n\nexport function useObservable<T>(observable: Nullable<ObservableOrFn<T>>): T;\nexport function useObservable<T>(\n  observable: Nullable<ObservableOrFn<T>>,\n  defaultValue: T,\n): T;\nexport function useObservable<T>(\n  observable: Nullable<ObservableOrFn<T>>,\n  defaultValue: undefined,\n  shouldHaveSyncValue: true,\n  deps?: any[],\n): T;\nexport function useObservable<T>(\n  observable: Nullable<ObservableOrFn<T>>,\n  defaultValue?: undefined,\n  shouldHaveSyncValue?: true,\n  deps?: any[],\n): T | undefined;\n/**\n * Subscribe to an observable and return its value. The component will re-render when the observable emits a new value.\n *\n * @param observable An observable or a function that returns an observable\n * @param defaultValue The default value of the observable. It the `observable` can omit an initial value, this value will be neglected.\n * @param shouldHaveSyncValue If the observable should have a sync value. If it does not have a sync value, an error will be thrown.\n * @param deps A dependency array to decide if we should re-subscribe when the `observable` is a function.\n * @returns Value or null.\n */\nexport function useObservable<T>(\n  observable: Nullable<ObservableOrFn<T>>,\n  defaultValue?: undefined,\n  shouldHaveSyncValue?: true,\n  deps?: any[],\n): T | undefined {\n  if (typeof observable === 'function' && !deps) {\n    throw new RediError(\n      'Expected deps to be provided when observable is a function!',\n    );\n  }\n\n  const observableRef = useRef<Observable<T> | null>(null);\n  const receivedSyncValueRef = useRef<boolean>(false);\n  const subscribedRef = useRef<boolean>(false);\n\n  const destObservable = useMemo(\n    () => observable,\n    [...(typeof deps !== 'undefined' ? deps : [observable])],\n  );\n\n  // This state is only for trigger React to re-render. We do not use `setValue` directly because it may cause\n  // memory leaking.\n  const [_, setRenderCounter] = useState<number>(0);\n\n  const valueRef = useRef<T | undefined>(\n    (() => {\n      let innerDefaultValue: T | undefined;\n      if (destObservable) {\n        const sub = unwrap(destObservable).subscribe((value) => {\n          receivedSyncValueRef.current = true;\n          innerDefaultValue = value;\n        });\n\n        sub.unsubscribe();\n      }\n\n      return innerDefaultValue ?? defaultValue;\n    })(),\n  );\n\n  useLayoutEffect(() => {\n    subscribedRef.current = false;\n\n    let subscription: Subscription | null = null;\n\n    if (destObservable) {\n      observableRef.current = unwrap(destObservable);\n      subscription = observableRef.current.subscribe((value) => {\n        if (\n          receivedSyncValueRef.current &&\n          !subscribedRef.current &&\n          value === valueRef.current\n        ) {\n          subscribedRef.current = true;\n          return;\n        }\n\n        subscribedRef.current = true;\n        valueRef.current = value;\n        setRenderCounter((prev) => prev + 1);\n      });\n    }\n\n    return () => subscription?.unsubscribe();\n  }, [destObservable]);\n\n  if (shouldHaveSyncValue && !receivedSyncValueRef.current) {\n    throw new Error(\n      '[redi]: Expect `shouldHaveSyncValue` but not getting a sync value!',\n    );\n  }\n\n  return valueRef.current;\n}\n\n/**\n * subscribe to a signal that emits whenever data updates and re-render\n *\n * @param update$ a signal that the data the functional component depends has updated\n */\nexport function useUpdateBinder(update$: Observable<void>): void {\n  const [, dumpSet] = useState(0);\n\n  useEffect(() => {\n    const subscription = update$.subscribe(() => dumpSet((prev) => prev + 1));\n    return () => subscription.unsubscribe();\n  }, []);\n}\n","/* eslint-disable node/prefer-global/process */\n\nexport { connectDependencies, connectInjector } from './reactComponent';\nexport { RediConsumer, RediContext, RediProvider } from './reactContext';\nexport { WithDependency } from './reactDecorators';\nexport { useDependency, useInjector } from './reactHooks';\nexport * from './reactRx';\n\nconst __REDI_CONTEXT_LOCK__ = 'REDI_CONTEXT_LOCK';\nconst isNode =\n  typeof process !== 'undefined' &&\n  process.versions != null &&\n  process.versions.node != null;\n\nconst globalObject: any =\n  (typeof globalThis !== 'undefined' && globalThis) ||\n  (typeof window !== 'undefined' && window) ||\n  // eslint-disable-next-line no-restricted-globals\n  (typeof global !== 'undefined' && global);\n\nif (!globalObject[__REDI_CONTEXT_LOCK__]) {\n  globalObject[__REDI_CONTEXT_LOCK__] = true;\n} else if (!isNode) {\n  console.error(\n    '[redi]: \"RediContext\" is already created. You may import \"RediContext\" from different paths. Use \"import { RediContext } from \\'@wendellhu/redi/react-bindings\\'; instead.\"',\n  );\n}\n"],"mappings":"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"}