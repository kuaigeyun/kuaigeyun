{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["editable/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import { CloseOutlined, EditOutlined, MessageOutlined } from '@ant-design/icons'\nimport { Field, isVoidField } from '@formily/core'\nimport { observer, ReactFC, useField } from '@formily/react'\nimport { Popover as AntdPopover } from 'antd'\nimport { PopoverProps } from 'antd/lib/popover'\nimport cls from 'classnames'\nimport React, { useLayoutEffect, useRef, useState } from 'react'\nimport { BaseItem, IFormItemProps } from '../form-item'\nimport { useClickAway, usePrefixCls } from '../__builtins__'\nimport useStyle from './style'\n\nconst useParentPattern = () => {\n  const field = useField<Field>()\n  return field?.parent?.pattern || field?.form?.pattern\n}\n\nconst useEditable = (): [boolean, (payload: boolean) => void] => {\n  const pattern = useParentPattern()\n  const field = useField<Field>()\n  useLayoutEffect(() => {\n    if (pattern === 'editable') {\n      return field.setPattern('readPretty')\n    }\n  }, [pattern])\n  return [\n    field.pattern === 'editable',\n    (payload: boolean) => {\n      if (pattern !== 'editable') return\n      field.setPattern(payload ? 'editable' : 'readPretty')\n    },\n  ]\n}\n\nconst useFormItemProps = (): IFormItemProps => {\n  const field = useField()\n  if (isVoidField(field)) return {}\n  if (!field) return {}\n  const takeMessage = () => {\n    if (field.selfErrors.length) return field.selfErrors\n    if (field.selfWarnings.length) return field.selfWarnings\n    if (field.selfSuccesses.length) return field.selfSuccesses\n  }\n\n  return {\n    feedbackStatus:\n      field.validateStatus === 'validating' ? 'pending' : field.validateStatus,\n    feedbackText: takeMessage(),\n    extra: field.description,\n  }\n}\n\nconst InternalEditable: ReactFC<IFormItemProps> = observer((props) => {\n  const [editable, setEditable] = useEditable()\n  const pattern = useParentPattern()\n  const itemProps = useFormItemProps()\n  const field = useField<Field>()\n  const basePrefixCls = usePrefixCls()\n  const prefixCls = usePrefixCls('formily-editable')\n  const [wrapSSR, hashId] = useStyle(prefixCls)\n  const ref = useRef<boolean>()\n  const innerRef = useRef<HTMLDivElement>(null)\n  const recover = () => {\n    if (ref.current && !field?.errors?.length) {\n      setEditable(false)\n    }\n  }\n  const renderEditHelper = () => {\n    if (editable) return\n    return (\n      <BaseItem {...props} {...itemProps}>\n        {pattern === 'editable' && (\n          <EditOutlined className={`${prefixCls}-edit-btn`} />\n        )}\n        {pattern !== 'editable' && (\n          <MessageOutlined className={`${prefixCls}-edit-btn`} />\n        )}\n      </BaseItem>\n    )\n  }\n\n  const renderCloseHelper = () => {\n    if (!editable) return\n    return (\n      <BaseItem {...props}>\n        <CloseOutlined className={`${prefixCls}-close-btn`} />\n      </BaseItem>\n    )\n  }\n\n  useClickAway((e) => {\n    const target = e.target as HTMLElement\n    if (target?.closest(`.${basePrefixCls}-select-dropdown`)) return\n    if (target?.closest(`.${basePrefixCls}-picker-dropdown`)) return\n    if (target?.closest(`.${basePrefixCls}-cascader-menus`)) return\n    recover()\n  }, innerRef)\n\n  const onClick = (e: React.MouseEvent<HTMLDivElement, MouseEvent>) => {\n    const target = e.target as HTMLElement\n    const close =\n      innerRef.current?.querySelector(`.${prefixCls}-close-btn`) || null\n    if (target?.contains(close) || close?.contains(target)) {\n      recover()\n    } else if (!ref.current) {\n      setTimeout(() => {\n        setEditable(true)\n        setTimeout(() => {\n          innerRef.current?.querySelector('input')?.focus()\n        })\n      })\n    }\n  }\n\n  ref.current = editable\n\n  return wrapSSR(\n    <div className={cls(prefixCls, hashId)} ref={innerRef} onClick={onClick}>\n      <div className={`${prefixCls}-content`}>\n        <BaseItem {...props} {...itemProps}>\n          {props.children}\n        </BaseItem>\n        {renderEditHelper()}\n        {renderCloseHelper()}\n      </div>\n    </div>\n  )\n})\n\nconst Popover = observer((props: PopoverProps) => {\n  const field = useField<Field>()\n  const pattern = useParentPattern()\n  const [open, setOpen] = useState(false)\n  const prefixCls = usePrefixCls('formily-editable')\n  const [wrapSSR, hashId] = useStyle(prefixCls)\n  const closePopover = async () => {\n    try {\n      await field.form.validate(`${field.address}.*`)\n    } finally {\n      const errors = field.form.queryFeedbacks({\n        type: 'error',\n        address: `${field.address}.*`,\n      })\n      if (errors?.length) return\n      setOpen(false)\n    }\n  }\n  const openPopover = () => {\n    setOpen(true)\n  }\n  return wrapSSR(\n    <AntdPopover\n      {...props}\n      title={props.title || field.title}\n      open={open}\n      className={cls(prefixCls, hashId, props.className)}\n      content={props.children}\n      trigger=\"click\"\n      destroyTooltipOnHide\n      onOpenChange={(open) => {\n        if (open) {\n          openPopover()\n        } else {\n          closePopover()\n        }\n      }}\n    >\n      <div>\n        <BaseItem className={`${prefixCls}-trigger`}>\n          <div className={`${prefixCls}-content`}>\n            <span className={`${prefixCls}-preview`}>\n              {props.title || field.title}\n            </span>\n            {pattern === 'editable' && (\n              <EditOutlined className={`${prefixCls}-edit-btn`} />\n            )}\n            {pattern !== 'editable' && (\n              <MessageOutlined className={`${prefixCls}-edit-btn`} />\n            )}\n          </div>\n        </BaseItem>\n      </div>\n    </AntdPopover>\n  )\n})\nexport const Editable = Object.assign(InternalEditable, { Popover })\n\nexport default Editable\n"]}