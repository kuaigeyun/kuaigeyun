{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["form-dialog/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import { createForm, Form, IFormProps } from '@formily/core'\nimport { FormProvider, Observer, observer, ReactFC } from '@formily/react'\nimport { toJS } from '@formily/reactive'\nimport {\n  applyMiddleware,\n  IMiddleware,\n  isBool,\n  isFn,\n  isNum,\n  isStr,\n} from '@formily/shared'\nimport { Modal, ModalProps } from 'antd'\nimport React, { Fragment, useLayoutEffect, useRef, useState } from 'react'\nimport { createPortal } from 'react-dom'\nimport {\n  createPortalProvider,\n  createPortalRoot,\n  loading,\n  usePrefixCls,\n} from '../__builtins__'\n\ntype FormDialogRenderer =\n  | React.ReactElement\n  | ((form: Form) => React.ReactElement)\n\ntype ModalTitle = string | number | React.ReactElement\n\nconst isModalTitle = (props: any): props is ModalTitle => {\n  return (\n    isNum(props) || isStr(props) || isBool(props) || React.isValidElement(props)\n  )\n}\n\nconst getModelProps = (props: any): IModalProps => {\n  if (isModalTitle(props)) {\n    return {\n      title: props,\n    }\n  } else {\n    return props\n  }\n}\n\nexport interface IFormDialog {\n  forOpen(middleware: IMiddleware<IFormProps>): IFormDialog\n  forConfirm(middleware: IMiddleware<Form>): IFormDialog\n  forCancel(middleware: IMiddleware<Form>): IFormDialog\n  open(props?: IFormProps): Promise<any>\n  close(): void\n}\n\nexport interface IModalProps extends ModalProps {\n  onOk?: (event: React.MouseEvent<HTMLElement>) => void | boolean\n  onCancel?: (event: React.MouseEvent<HTMLElement>) => void | boolean\n  loadingText?: React.ReactNode\n}\n\ninterface IEnv {\n  form: Form | null\n  host: HTMLDivElement\n  promise: Promise<any> | null\n  openMiddlewares: IMiddleware<IFormProps>[]\n  confirmMiddlewares: IMiddleware<Form>[]\n  cancelMiddlewares: IMiddleware<Form>[]\n}\n\nexport function FormDialog(\n  title: IModalProps,\n  id: string,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(\n  title: IModalProps,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(\n  title: ModalTitle,\n  id: string,\n  renderer: FormDialogRenderer\n): IFormDialog\nexport function FormDialog(\n  title: ModalTitle,\n  renderer: FormDialogRenderer\n): IFormDialog\n\nexport function FormDialog(title: any, id: any, renderer?: any): IFormDialog {\n  if (isFn(id) || React.isValidElement(id)) {\n    renderer = id\n    id = 'form-dialog'\n  }\n  const env: IEnv = {\n    host: document.createElement('div'),\n    form: null as unknown as Form,\n    promise: null,\n    openMiddlewares: [],\n    confirmMiddlewares: [],\n    cancelMiddlewares: [],\n  }\n  const root = createPortalRoot(env.host, id)\n  const props = getModelProps(title)\n  const modal = {\n    ...props,\n    afterClose: () => {\n      props?.afterClose?.()\n      root.unmount()\n    },\n  }\n  const DialogContent = observer(() => {\n    return <Fragment>{isFn(renderer) ? renderer(env.form) : renderer}</Fragment>\n  })\n  const renderDialog = (\n    open = true,\n    resolve?: () => any,\n    reject?: () => any\n  ) => {\n    const { form } = env\n    if (!form) return null\n    return (\n      <Observer>\n        {() => (\n          <Modal\n            {...modal}\n            open={open}\n            confirmLoading={form.submitting}\n            onCancel={(e) => {\n              if (modal?.onCancel?.(e) !== false) {\n                reject?.()\n              }\n            }}\n            onOk={async (e) => {\n              if (modal?.onOk?.(e) !== false) {\n                resolve?.()\n              }\n            }}\n          >\n            <FormProvider form={form}>\n              <DialogContent />\n            </FormProvider>\n          </Modal>\n        )}\n      </Observer>\n    )\n  }\n\n  document.body.appendChild(env.host)\n  const formDialog = {\n    forOpen: (middleware: IMiddleware<IFormProps>) => {\n      if (isFn(middleware)) {\n        env.openMiddlewares.push(middleware)\n      }\n      return formDialog\n    },\n    forConfirm: (middleware: IMiddleware<Form>) => {\n      if (isFn(middleware)) {\n        env.confirmMiddlewares.push(middleware)\n      }\n      return formDialog\n    },\n    forCancel: (middleware: IMiddleware<Form>) => {\n      if (isFn(middleware)) {\n        env.cancelMiddlewares.push(middleware)\n      }\n      return formDialog\n    },\n    open: async (props: IFormProps) => {\n      if (env.promise) return env.promise\n      env.promise = new Promise(async (resolve, reject) => {\n        try {\n          props = await loading(modal.loadingText, () =>\n            applyMiddleware(props, env.openMiddlewares)\n          )\n          env.form = env.form || createForm(props)\n        } catch (e) {\n          reject(e)\n        }\n        root.render(() =>\n          renderDialog(\n            true,\n            () => {\n              env.form\n                ?.submit(async () => {\n                  await applyMiddleware(env.form, env.confirmMiddlewares)\n                  resolve(toJS(env.form?.values))\n                  formDialog.close()\n                })\n                .catch(() => {})\n            },\n            async () => {\n              await loading(modal.loadingText, () =>\n                applyMiddleware(env.form, env.cancelMiddlewares)\n              )\n              formDialog.close()\n            }\n          )\n        )\n      })\n      return env.promise\n    },\n    close: () => {\n      if (!env.host) return\n      root.render(() => renderDialog(false))\n    },\n  }\n  return formDialog\n}\n\nconst DialogFooter: ReactFC = (props) => {\n  const ref = useRef<HTMLDivElement>(null)\n  const [footer, setFooter] = useState<HTMLDivElement>()\n  const footerRef = useRef<HTMLDivElement>()\n  const prefixCls = usePrefixCls('modal')\n  useLayoutEffect(() => {\n    const content = ref.current?.closest(`.${prefixCls}-content`)\n    if (content) {\n      if (!footerRef.current) {\n        footerRef.current = content.querySelector(\n          `.${prefixCls}-footer`\n        ) as HTMLDivElement\n        if (!footerRef.current) {\n          footerRef.current = document.createElement('div')\n          footerRef.current.classList.add(`${prefixCls}-footer`)\n          content.appendChild(footerRef.current)\n        }\n      }\n      setFooter(footerRef.current)\n    }\n  })\n\n  footerRef.current = footer\n\n  return (\n    <div ref={ref} style={{ display: 'none' }}>\n      {footer && createPortal(props.children, footer)}\n    </div>\n  )\n}\n\nFormDialog.Footer = DialogFooter\n\nFormDialog.Portal = createPortalProvider('form-dialog')\n\nexport default FormDialog\n"]}