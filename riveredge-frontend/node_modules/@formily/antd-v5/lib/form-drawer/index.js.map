{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["form-drawer/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  createForm,\n  Form,\n  IFormProps,\n  onFormSubmitSuccess,\n} from '@formily/core'\nimport { FormProvider, observer, ReactFC } from '@formily/react'\nimport { toJS } from '@formily/reactive'\nimport {\n  applyMiddleware,\n  IMiddleware,\n  isBool,\n  isFn,\n  isNum,\n  isStr,\n} from '@formily/shared'\nimport { Drawer, DrawerProps } from 'antd'\nimport React, { Fragment, useLayoutEffect, useRef, useState } from 'react'\nimport { createPortal } from 'react-dom'\nimport {\n  createPortalProvider,\n  createPortalRoot,\n  loading,\n  usePrefixCls,\n} from '../__builtins__'\n\ntype FormDrawerRenderer =\n  | React.ReactElement\n  | ((form: Form) => React.ReactElement)\n\ntype DrawerTitle = string | number | React.ReactElement\n\ntype EventType =\n  | React.KeyboardEvent<HTMLDivElement>\n  | React.MouseEvent<HTMLDivElement | HTMLButtonElement>\n\nconst isDrawerTitle = (props: any): props is DrawerTitle => {\n  return (\n    isNum(props) || isStr(props) || isBool(props) || React.isValidElement(props)\n  )\n}\n\nconst getDrawerProps = (props: any): IDrawerProps => {\n  if (isDrawerTitle(props)) {\n    return {\n      title: props,\n    }\n  } else {\n    return props\n  }\n}\n\nexport interface IFormDrawer {\n  forOpen(middleware: IMiddleware<IFormProps>): IFormDrawer\n  open(props?: IFormProps): Promise<any>\n  close(): void\n}\n\nexport interface IDrawerProps extends DrawerProps {\n  onClose?: (e: EventType) => void | boolean\n  loadingText?: React.ReactNode\n}\ninterface IEnv {\n  form: Form | null\n  host: HTMLDivElement\n  promise: Promise<any> | null\n  openMiddlewares: IMiddleware<IFormProps>[]\n}\n\nexport function FormDrawer(\n  title: IDrawerProps,\n  id: string,\n  renderer: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: IDrawerProps,\n  id: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: DrawerTitle,\n  id: string,\n  renderer: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: DrawerTitle,\n  id: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(title: any, id: any, renderer?: any): IFormDrawer {\n  if (isFn(id) || React.isValidElement(id)) {\n    renderer = id\n    id = 'form-drawer'\n  }\n  const env: IEnv = {\n    host: document.createElement('div'),\n    openMiddlewares: [],\n    form: null,\n    promise: null,\n  }\n  const root = createPortalRoot(env.host, id)\n  const props = getDrawerProps(title)\n  const drawer = {\n    width: '40%',\n    ...props,\n    onClose: (e: any) => {\n      if (props?.onClose?.(e) !== false) {\n        formDrawer.close()\n      }\n    },\n    afterOpenChange: (open: boolean) => {\n      props?.afterOpenChange?.(open)\n      if (open) return\n      root.unmount()\n    },\n  }\n  const DrawerContent = observer(() => {\n    return <Fragment>{isFn(renderer) ? renderer(env.form) : renderer}</Fragment>\n  })\n  const renderDrawer = (open = true) => {\n    const { form } = env\n    if (!form) return null\n    return (\n      <Drawer {...drawer} open={open}>\n        <FormProvider form={form}>\n          <DrawerContent />\n        </FormProvider>\n      </Drawer>\n    )\n  }\n\n  document.body.appendChild(env.host)\n  const formDrawer = {\n    forOpen: (middleware: IMiddleware<IFormProps>) => {\n      if (isFn(middleware)) {\n        env.openMiddlewares.push(middleware)\n      }\n      return formDrawer\n    },\n    open: (props: IFormProps) => {\n      if (env.promise) return env.promise\n      env.promise = new Promise(async (resolve, reject) => {\n        try {\n          props = await loading(drawer.loadingText, () =>\n            applyMiddleware(props, env.openMiddlewares)\n          )\n          env.form =\n            env.form ||\n            createForm({\n              ...props,\n              effects(form) {\n                onFormSubmitSuccess(() => {\n                  resolve(toJS(form.values))\n                  formDrawer.close()\n                })\n                props?.effects?.(form)\n              },\n            })\n        } catch (e) {\n          reject(e)\n        }\n        root.render(() => renderDrawer(false))\n        setTimeout(() => {\n          root.render(() => renderDrawer(true))\n        }, 16)\n      })\n      return env.promise\n    },\n    close: () => {\n      if (!env.host) return\n      root.render(() => renderDrawer(false))\n    },\n  }\n  return formDrawer\n}\n\nconst DrawerExtra: ReactFC = (props) => {\n  const ref = useRef<HTMLDivElement>(null)\n  const [extra, setExtra] = useState<HTMLDivElement>()\n  const extraRef = useRef<HTMLDivElement>()\n  const prefixCls = usePrefixCls('drawer')\n  useLayoutEffect(() => {\n    const content = ref.current\n      ?.closest(`.${prefixCls}-content`)\n      ?.querySelector(`.${prefixCls}-header`)\n    if (content) {\n      if (!extraRef.current) {\n        extraRef.current = content.querySelector(\n          `.${prefixCls}-extra`\n        ) as HTMLDivElement\n        if (!extraRef.current) {\n          extraRef.current = document.createElement('div')\n          extraRef.current.classList.add(`${prefixCls}-extra`)\n          content.appendChild(extraRef.current)\n        }\n      }\n      setExtra(extraRef.current)\n    }\n  })\n\n  extraRef.current = extra\n\n  return (\n    <div ref={ref} style={{ display: 'none' }}>\n      {extra && createPortal(props.children, extra)}\n    </div>\n  )\n}\n\nconst DrawerFooter: ReactFC = (props) => {\n  const ref = useRef<HTMLDivElement>(null)\n  const [footer, setFooter] = useState<HTMLDivElement>()\n  const footerRef = useRef<HTMLDivElement>()\n  const prefixCls = usePrefixCls('drawer')\n  useLayoutEffect(() => {\n    const content = ref.current?.closest(`.${prefixCls}-content`)\n    if (content) {\n      if (!footerRef.current) {\n        footerRef.current = content.querySelector(\n          `.${prefixCls}-footer`\n        ) as HTMLDivElement\n        if (!footerRef.current) {\n          footerRef.current = document.createElement('div')\n          footerRef.current.classList.add(`${prefixCls}-footer`)\n          content.appendChild(footerRef.current)\n        }\n      }\n      setFooter(footerRef.current)\n    }\n  })\n\n  footerRef.current = footer\n\n  return (\n    <div ref={ref} style={{ display: 'none' }}>\n      {footer && createPortal(props.children, footer)}\n    </div>\n  )\n}\n\nFormDrawer.Extra = DrawerExtra\n\nFormDrawer.Footer = DrawerFooter\n\nFormDrawer.Portal = createPortalProvider('form-drawer')\n\nexport default FormDrawer\n"]}