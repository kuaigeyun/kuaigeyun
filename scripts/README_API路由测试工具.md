# API路由测试工具使用说明

## 📋 概述

`test-all-api-routes.py` 是一个用于测试所有已注册的FastAPI路由的工具。它可以：

- ✅ 自动发现所有已注册的API路由
- ✅ 测试每个路由是否可访问（不返回404）
- ✅ 按应用分组统计测试结果
- ✅ 生成详细的测试报告（JSON格式）
- ✅ 支持并发测试，提高测试效率

## 🚀 使用方法

### 基本用法

```bash
# 在项目根目录运行
python test-all-api-routes.py
```

### 高级用法

```bash
# 指定基础URL和租户ID
python test-all-api-routes.py --base-url http://localhost:8100 --tenant-id 1

# 使用认证Token
python test-all-api-routes.py --token "your-auth-token"

# 调整并发数（默认10）
python test-all-api-routes.py --max-concurrent 20

# 指定输出文件
python test-all-api-routes.py --output my-test-results.json

# 只测试指定应用的路由
python test-all-api-routes.py --filter-app kuaizhizao
```

### 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--base-url` | 基础URL | `http://test` |
| `--token` | 认证Token（可选） | `None` |
| `--tenant-id` | 租户ID | `1` |
| `--max-concurrent` | 最大并发数 | `10` |
| `--output` | 输出文件路径 | `api-routes-test-results.json` |
| `--filter-app` | 只测试指定应用 | `None`（测试所有） |

## 📊 输出说明

### 控制台输出

工具会在控制台输出：

1. **路由统计**：按应用分组显示路由数量
2. **测试进度**：实时显示测试状态
3. **测试结果**：
   - ✅ 可访问的路由数量
   - ❌ 404 Not Found的路由数量
   - ⚠️ 错误的路由数量
   - ⏭️ 跳过的路由数量
4. **详细列表**：显示404和错误的路由详情

### JSON报告

测试结果会保存到JSON文件中，包含：

- 测试时间
- 统计摘要
- 按应用分组的统计
- 每个路由的详细测试结果

## 🔍 测试逻辑

1. **路由发现**：从FastAPI应用实例中获取所有已注册的路由
2. **路径参数替换**：自动将路径参数（如`{id}`, `{uuid}`）替换为测试值
3. **HTTP请求**：对每个路由发送HTTP请求（优先使用GET方法）
4. **结果判断**：
   - 返回404 → 路由不存在或未注册
   - 返回其他状态码 → 路由存在（可能需要认证或参数）
   - 发生异常 → 记录错误信息

## ⚠️ 注意事项

1. **测试环境**：工具使用测试客户端，不会实际连接到数据库
2. **认证问题**：如果路由需要认证，需要提供有效的Token
3. **路径参数**：工具会自动替换路径参数，但可能不适用于所有场景
4. **并发控制**：默认并发数为10，可根据服务器性能调整

## 📝 示例输出

```
================================================================================
开始测试所有API路由
================================================================================
测试时间: 2026-01-19 10:30:00
基础URL: http://test
租户ID: 1

📋 正在获取所有已注册的路由...
✅ 发现 245 个路由

📊 路由统计（按应用分组）:
  - core: 45 个路由
  - infra: 38 个路由
  - kuaizhizao: 120 个路由
  - master-data: 42 个路由

🧪 开始测试路由...

================================================================================
测试结果统计
================================================================================
总路由数: 245
✅ 可访问: 238 (97.1%)
❌ 404 Not Found: 5 (2.0%)
⚠️  错误: 2 (0.8%)
⏭️  跳过: 0 (0.0%)

📊 按应用分组统计:
  kuaizhizao:
    总路由: 120
    ✅ 可访问: 118 (98.3%)
    ❌ 404: 2 (1.7%)
    ⚠️  错误: 0 (0.0%)
    ⏭️  跳过: 0 (0.0%)
```

## 🛠️ 故障排查

### 问题：所有路由都返回404

**可能原因**：
- 应用路由未正确注册
- 路径前缀配置错误

**解决方法**：
- 检查后端日志，确认路由注册情况
- 验证`ApplicationRegistryService`是否正常工作

### 问题：大量路由返回401/403

**可能原因**：
- 路由需要认证但未提供Token
- Token已过期或无效

**解决方法**：
- 提供有效的认证Token
- 检查认证中间件配置

### 问题：测试速度很慢

**可能原因**：
- 并发数设置过低
- 服务器响应慢

**解决方法**：
- 增加`--max-concurrent`参数值
- 检查服务器性能

## 📚 相关文档

- [FastAPI路由文档](https://fastapi.tiangolo.com/tutorial/routing/)
- [项目测试指南](../docs/5.testing/测试指南.md)

---

**创建时间**: 2026-01-19  
**作者**: Auto (AI Assistant)
