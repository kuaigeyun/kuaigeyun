# 测试指南

本文档说明如何运行前后端自动化测试。

## 后端测试

### 运行所有测试

```bash
cd riveredge-backend
uv run pytest
```

### 运行特定测试文件

```bash
# 运行销售订单服务测试
uv run pytest tests/unit/services/test_sales_order_service.py

# 运行销售订单API测试
uv run pytest tests/integration/api/test_sales_orders_api.py
```

### 运行特定测试用例

```bash
# 运行特定测试函数
uv run pytest tests/unit/services/test_sales_order_service.py::test_create_sales_order
```

### 查看测试覆盖率

```bash
uv run pytest --cov=src/apps/kuaizhizao/services --cov-report=html
```

### 测试文件结构

```
riveredge-backend/tests/
├── unit/                    # 单元测试
│   └── services/           # 服务层测试
│       └── test_sales_order_service.py
├── integration/            # 集成测试
│   └── api/                # API端点测试
│       └── test_sales_orders_api.py
└── e2e/                    # 端到端测试
    ├── conftest.py         # 测试配置和fixtures
    └── test_*.py           # E2E测试用例
```

## 前端测试

### 运行所有测试

```bash
cd riveredge-frontend
npm run test
```

### 运行测试（监听模式）

```bash
npm run test
# 或使用UI界面
npm run test:ui
```

### 运行测试（单次执行）

```bash
npm run test:run
```

### 查看测试覆盖率

```bash
npm run test:coverage
```

### 测试文件结构

```
riveredge-frontend/tests/
├── setup.ts                # 测试环境配置
├── services/               # 服务层测试
│   └── sales.test.ts
└── pages/                  # 页面组件测试
    └── sales-orders.test.tsx
```

## 测试编写规范

### 后端测试

1. **单元测试**：测试服务层的业务逻辑
   - 测试函数命名：`test_功能描述`
   - 使用 `@pytest.mark.asyncio` 标记异步测试
   - 使用 fixtures 提供测试数据

2. **集成测试**：测试API端点
   - 使用 `test_client` fixture 发送HTTP请求
   - 使用 `auth_headers` fixture 提供认证信息
   - 验证HTTP状态码和响应数据

### 前端测试

1. **服务层测试**：测试API调用
   - Mock API模块
   - 验证函数调用和参数
   - 验证返回值

2. **组件测试**：测试React组件
   - 使用 `@testing-library/react` 渲染组件
   - 使用 `screen` 查询DOM元素
   - 验证组件渲染和交互

## 测试数据

测试使用独立的测试数据库和测试租户，不会影响生产数据。

- 测试租户：`domain="test"`
- 测试用户：`username="test_user"`
- 测试密码：`test_password_123`

## 常见问题

### 后端测试失败

1. **数据库连接失败**：检查 `.env` 文件中的数据库配置
2. **导入错误**：确保 `PYTHONPATH` 包含 `src` 目录
3. **异步测试问题**：确保使用 `@pytest.mark.asyncio` 标记

### 前端测试失败

1. **模块导入错误**：检查路径别名配置
2. **Mock失败**：确保正确mock了所有依赖
3. **DOM查询失败**：使用 `waitFor` 等待异步渲染

## 持续集成

测试可以在CI/CD流程中自动运行：

```yaml
# 示例：GitHub Actions
- name: 运行后端测试
  run: |
    cd riveredge-backend
    uv run pytest

- name: 运行前端测试
  run: |
    cd riveredge-frontend
    npm run test:run
```

