# 测试指南

本文档说明如何运行前后端自动化测试。

## 后端测试

### 运行所有测试

```bash
cd riveredge-backend
uv run pytest
```

### 运行特定测试文件

```bash
# 运行销售订单服务测试
uv run pytest tests/unit/services/test_sales_order_service.py

# 运行销售订单API测试
uv run pytest tests/integration/api/test_sales_orders_api.py
```

### 运行特定测试用例

```bash
# 运行特定测试函数
uv run pytest tests/unit/services/test_sales_order_service.py::test_create_sales_order
```

### 查看测试覆盖率

```bash
uv run pytest --cov=src/apps/kuaizhizao/services --cov-report=html
```

### 测试文件结构

```
riveredge-backend/tests/
├── unit/                    # 单元测试
│   └── services/           # 服务层测试
│       └── test_sales_order_service.py
├── integration/            # 集成测试
│   └── api/                # API端点测试
│       └── test_sales_orders_api.py
└── e2e/                    # 端到端测试
    ├── conftest.py         # 测试配置和fixtures
    └── test_*.py           # E2E测试用例
```

## 前端测试

### 运行所有测试

```bash
cd riveredge-frontend
npm run test
```

### 运行测试（监听模式）

```bash
npm run test
# 或使用UI界面
npm run test:ui
```

### 运行测试（单次执行）

```bash
npm run test:run
```

### 查看测试覆盖率

```bash
npm run test:coverage
```

### 测试文件结构

```
riveredge-frontend/tests/
├── setup.ts                # 测试环境配置
├── services/               # 服务层测试
│   └── sales.test.ts
└── pages/                  # 页面组件测试
    └── sales-orders.test.tsx
```

## E2E测试（端到端测试）

### 后端E2E测试

E2E测试覆盖完整的业务流程，从API调用到数据持久化。

#### 运行E2E测试

```bash
# 运行所有E2E测试
uv run pytest tests/e2e/ -v

# 运行销售订单E2E测试
uv run pytest tests/e2e/test_sales_order_complete_workflow.py -v

# 运行特定标记的测试
uv run pytest -m e2e -v
uv run pytest -m sales_order -v
```

#### E2E测试覆盖的流程

**销售订单完整流程** (`test_sales_order_complete_workflow.py`):
- ✅ 创建带明细项的销售订单
- ✅ 获取订单列表和筛选
- ✅ 更新订单信息
- ✅ 提交和审核订单
- ✅ 完整工作流（创建→更新→提交→审核→确认）

### 前端E2E测试

前端E2E测试模拟完整的用户交互流程。

#### 运行前端E2E测试

```bash
cd riveredge-frontend
npm run test tests/e2e/
```

#### 前端E2E测试覆盖的流程

**销售订单工作流** (`tests/e2e/sales-order-workflow.test.ts`):
- ✅ 创建订单流程（获取客户/物料列表→创建订单）
- ✅ 列表和筛选流程
- ✅ 详情和更新流程

## 测试编写规范

### 后端测试

1. **单元测试**：测试服务层的业务逻辑
   - 测试函数命名：`test_功能描述`
   - 使用 `@pytest.mark.asyncio` 标记异步测试
   - 使用 `@pytest.mark.unit` 标记单元测试
   - 使用 fixtures 提供测试数据

2. **集成测试**：测试API端点
   - 使用 `@pytest.mark.integration` 标记集成测试
   - 使用 `test_client` fixture 发送HTTP请求
   - 使用 `auth_headers` fixture 提供认证信息
   - 验证HTTP状态码和响应数据

3. **E2E测试**：测试完整业务流程
   - 使用 `@pytest.mark.e2e` 标记E2E测试
   - 测试完整的业务流程，包括多个步骤
   - 验证数据在整个流程中的正确流转

### 前端测试

1. **服务层测试**：测试API调用
   - Mock API模块
   - 验证函数调用和参数
   - 验证返回值

2. **组件测试**：测试React组件
   - 使用 `@testing-library/react` 渲染组件
   - 使用 `screen` 查询DOM元素
   - 验证组件渲染和交互

3. **E2E测试**：测试完整用户流程
   - 模拟完整的用户操作流程
   - 验证前后端交互
   - 验证数据流转

## 测试数据

测试使用独立的测试数据库和测试租户，不会影响生产数据。

### 后端测试数据

- 测试租户：`domain="test"`
- 测试用户：`username="test_user"`
- 测试密码：`test_password_123`
- 测试客户：`code="TEST-CUSTOMER-001"`
- 测试物料：`code="TEST-MAT-001"`

### 测试Fixtures

后端测试提供了以下fixtures（在 `tests/e2e/conftest.py` 中定义）：

- `db_setup`: 数据库连接设置
- `test_client`: HTTP测试客户端
- `test_tenant`: 测试租户
- `test_user`: 测试用户
- `test_customer`: 测试客户
- `test_material`: 测试物料
- `auth_headers`: 认证头（JWT token）

## 常见问题

### 后端测试失败

1. **数据库连接失败**：检查 `.env` 文件中的数据库配置
2. **导入错误**：确保 `PYTHONPATH` 包含 `src` 目录
3. **异步测试问题**：确保使用 `@pytest.mark.asyncio` 标记

### 前端测试失败

1. **模块导入错误**：检查路径别名配置
2. **Mock失败**：确保正确mock了所有依赖
3. **DOM查询失败**：使用 `waitFor` 等待异步渲染

## 持续集成

测试可以在CI/CD流程中自动运行：

```yaml
# 示例：GitHub Actions
- name: 运行后端测试
  run: |
    cd riveredge-backend
    uv run pytest

- name: 运行前端测试
  run: |
    cd riveredge-frontend
    npm run test:run
```

