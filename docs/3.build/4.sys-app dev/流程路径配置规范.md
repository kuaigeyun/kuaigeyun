# 流程路径配置规范

> 销售、计划、采购流程重组优化 - Phase 0 产出  
> 定义流程开关、默认路径、适用场景及 API 约定

## 1. 概述

本规范定义需求计算后的流程路径配置，使系统能适配不同企业规模：小企业采用极简路径（需求→需求计算→直接生成工单/采购单），中型企业可开启采购申请、生产计划等中间环节。

## 2. 流程开关定义

### 2.1 存储位置

沿用 `BusinessConfigService`，在 `parameters` 下新增分类：

- `parameters.procurement`：采购流程配置
- `parameters.planning`：计划流程配置

### 2.2 采购流程开关

| Key | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `require_purchase_requisition` | bool | `false` | 是否经采购申请。`true`：需求计算下推采购申请→审批→转采购单；`false`：需求计算直接下推采购单 |

**适用场景：**
- `false`（默认）：小企业、紧急采购多、采购流程简单
- `true`：需要审批控制、比价选型、跨部门协作的中型企业

### 2.3 生产计划流程开关

| Key | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `require_production_plan` | bool | `false` | 是否经生产计划。`true`：需求计算必须先转生产计划，再由生产计划转工单；`false`：需求计算可直接转工单 |

**适用场景：**
- `false`（默认）：小批量、订单驱动、工单直接下达
- `true`：需要计划排程、合并生产、产能平衡的中型企业

### 2.4 菜单可见性

- 开关关闭时，「生产计划」「采购申请」菜单不隐藏，可折叠到「计划管理」「采购管理」子菜单
- 用户仍可手动进入这些页面（如直接创建生产计划、补货等）

## 3. 默认路径

**极简路径（两开关均为 false）：**

```
需求 → 需求计算 → 一键生成（工单 + 采购单）
```

**全流程路径（两开关均为 true）：**

```
需求 → 需求计算 → 转生产计划 → 转工单（或进排程）
                  ↓
              转采购申请 → 审批 → 转采购单
```

## 4. API 读写约定

### 4.1 读取配置

通过现有 `GET /api/v1/infra/business-config` 返回的 `config.parameters` 获取：

```json
{
  "parameters": {
    "procurement": {
      "require_purchase_requisition": false
    },
    "planning": {
      "require_production_plan": false
    }
  }
}
```

### 4.2 写入配置

通过现有参数更新 API 设置（若已有通用参数更新接口），或新增：

- `PUT /api/v1/infra/business-config/parameters/procurement` 
- `PUT /api/v1/infra/business-config/parameters/planning`

传入 `{ "require_purchase_requisition": true }` 等。

### 4.3 默认值

首次获取时，若 `parameters.procurement` 或 `parameters.planning` 不存在，应返回上述默认值。

## 5. 一键生成粒度

### 5.1 选项

需求计算详情页「一键生成」提供下拉选项：

| 选项 | 行为 |
|------|------|
| 全部 | 同时生成工单（自制/委外）和采购单/采购申请（采购件） |
| 仅工单 | 只生成工单，不生成采购相关单据 |
| 仅采购 | 只生成采购单/采购申请，不生成工单 |

### 5.2 交互

- 默认选中「全部」
- 用户可提前选择后点击生成，或点击主按钮后弹窗选择

## 6. 流程路径选择指南

| 企业规模 | 采购开关 | 生产计划开关 | 说明 |
|----------|----------|--------------|------|
| 小企业（<50人） | 关闭 | 关闭 | 极简路径，快速下单 |
| 中型企业（50-200人） | 开启 | 关闭 | 采购需审批，生产直接下工单 |
| 中大型企业（200+人） | 开启 | 开启 | 全流程，计划排程后再下工单 |

## 7. 变更生效时机

- 流程开关支持运行时修改
- 修改后**立即生效**于下一次下推/一键生成操作
- 不追溯已生成的单据
