# 工艺路线和标准作业流程（SOP）优化设计规范

> 本文档基于《用户使用场景推演-MTS-MTO.md》和《BOM-工艺路线-标准作业流程设计规范.md》，专门针对工艺路线和标准作业流程（SOP）需要单独优化的部分进行详细设计。

**提取日期**：2026-01-16  
**来源文档**：用户使用场景推演-MTS-MTO.md、BOM-工艺路线-标准作业流程设计规范.md  
**设计阶段**：强化设计阶段

> **相关文档**：
> - [BOM-工艺路线-标准作业流程设计规范.md](./BOM-工艺路线-标准作业流程设计规范.md) - 基础设计规范
> - [工单与报工管理详细规范.md](./工单与报工管理详细规范.md) - 工单和报工管理的完整详细规范

---

## 目录

1. [BOM管理详细设计](#1-bom管理详细设计)
2. [工艺路线版本管理](#2-工艺路线版本管理)
3. [SOP参数收集详细设计](#3-sop参数收集详细设计)
4. [子工艺路线详细设计](#4-子工艺路线详细设计)
5. [工序类型和跳转规则详细设计](#5-工序类型和跳转规则详细设计)
6. [工艺路线绑定机制详细设计](#6-工艺路线绑定机制详细设计)
7. [报工界面动态渲染](#7-报工界面动态渲染)
8. [工艺路线模板管理](#8-工艺路线模板管理)

---

## 1. BOM管理详细设计

### 1.1 应用场景

- **批量导入BOM**：使用universheet在线表格批量导入BOM数据，支持使用任意部门编码
- **BOM数据验证**：自动验证BOM数据完整性，检测循环依赖
- **BOM层级结构**：自动生成BOM层级结构，支持多层级BOM展开
- **BOM与工艺路线关联**：BOM中的物料自动关联工艺路线，用于工单创建
- **BOM版本管理**：支持BOM版本控制，记录BOM变更历史

### 1.2 批量导入BOM（核心功能）

#### 1.2.1 使用universheet批量导入

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "BOM管理"
2. 点击"批量导入"按钮
3. 系统自动打开universheet在线表格（系统自动创建模板）
4. 在universheet中填写BOM数据（实时保存）：
   - **BOM模板列**：
     - 父件编码（支持任意部门编码：SALE-A001、DES-A001、主编码MAT-FIN-0001）
     - 子件编码（支持任意部门编码：PROD-A001、主编码MAT-SEMI-0001）
     - 子件数量（必填，数字）
     - 子件单位（可选，如：个、kg、m等）
     - 损耗率（可选，百分比，如：5%）
     - 是否必选（可选，是/否，默认：是）
     - 备注（可选）
5. **BOM示例数据**：
   ```
   父件编码        子件编码        子件数量  子件单位  损耗率  是否必选  备注
   SALE-A001      PROD-A001      2        个        0%      是        
   SALE-A001      PROD-A002      1        个        0%      是        
   SALE-A001      WH-A001        4        个        0%      是        
   PROD-A001      PUR-A001       100      g         5%      是        塑料颗粒A
   PROD-A002      PUR-A002       50       g         5%      是        塑料颗粒B
   ```
6. 点击"导入"按钮，系统自动：
   - 识别部门编码，自动映射到主编码
   - 验证BOM数据完整性
   - 生成BOM层级结构
   - 创建BOM数据

**系统行为**：
- ✅ **自动识别部门编码**：
  - 输入任意部门编码（SALE-A001、DES-A001、PUR-A001等）
  - 系统自动映射到主编码（MAT-FIN-0001、MAT-SEMI-0001等）
  - 如果编码不存在，系统提示：编码不存在，请先创建物料
- ✅ **实时保存**：
  - 在universheet中编辑时，系统自动实时保存
  - 无需手动保存，避免数据丢失
- ✅ **数据验证**：
  - 验证父件编码是否存在
  - 验证子件编码是否存在
  - 验证子件数量是否大于0
  - 检测循环依赖（如：A包含B，B包含A）
  - 检测重复子件（同一父件下，子件编码不能重复）

#### 1.2.2 BOM层级结构生成

**系统自动处理**：
1. **解析BOM数据**：
   - 识别父件和子件的层级关系
   - 构建BOM树形结构
2. **生成BOM层级**：
   ```
   产品A（1个，主编码：MAT-FIN-0001）
   ├── 注塑件A（2个，主编码：MAT-SEMI-0001）
   │   └── 塑料颗粒A（100g，主编码：MAT-RAW-0001）
   ├── 注塑件B（1个，主编码：MAT-SEMI-0002）
   │   └── 塑料颗粒B（50g，主编码：MAT-RAW-0002）
   └── 螺丝（4个，主编码：MAT-RAW-0003）
   ```
3. **计算BOM用量**：
   - 自动计算多层级BOM的用量（考虑损耗率）
   - 例如：生产1个产品A，需要2个注塑件A，每个注塑件A需要100g塑料颗粒A（考虑5%损耗率）

### 1.3 BOM数据验证

#### 1.3.1 循环依赖检测

**检测逻辑**：
- 系统自动检测BOM中的循环依赖
- 例如：A包含B，B包含C，C包含A（循环依赖）
- 系统提示：检测到循环依赖，请检查BOM配置

**处理方式**：
- 阻止导入包含循环依赖的BOM
- 提示用户修复循环依赖后再导入

#### 1.3.2 数据完整性验证

**验证内容**：
- 父件编码必须存在
- 子件编码必须存在
- 子件数量必须大于0
- 同一父件下，子件编码不能重复
- 损耗率必须在0-100%之间

**验证时机**：
- 导入时实时验证
- 保存前完整验证
- 验证失败时，显示详细错误信息

### 1.4 BOM与工艺路线关联

#### 1.4.1 自动关联工艺路线

**关联逻辑**：
1. **创建工单时**：
   - 选择产品：产品A
   - 系统自动加载产品A的BOM
   - 系统自动匹配工艺路线（按优先级：物料主数据 → 物料绑定 → 物料分组绑定）
   - 系统自动创建工单工序（基于工艺路线）
2. **BOM展开**：
   - 系统自动展开多层级BOM
   - 每个层级的物料自动关联对应的工艺路线
   - 生成完整的生产计划

#### 1.4.2 BOM用量计算

**计算逻辑**：
- 考虑多层级BOM的用量计算
- 考虑损耗率的影响
- 自动计算实际用料数量

**计算示例**：
```
产品A（1个）
├── 注塑件A（2个，损耗率：5%）
│   └── 塑料颗粒A（100g，损耗率：3%）
│       → 实际需要：100g × (1 + 3%) = 103g
│       → 2个注塑件A需要：103g × 2 × (1 + 5%) = 216.3g
└── 螺丝（4个）
    → 实际需要：4个
```

### 1.5 BOM版本管理（核心功能，新增）

#### 1.5.1 创建BOM新版本

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "BOM管理"
2. 编辑BOM：产品A的BOM（当前版本：v1.0）
3. 修改BOM配置：
   - 增加子件：增加包装材料（1个）
   - 修改子件数量：注塑件A从2个改为3个
4. 点击"保存为新版本"按钮
5. 填写版本信息：
   - 版本号：v1.1（系统自动建议）
   - 版本说明：优化BOM结构，增加包装材料
   - 生效日期：2026-01-20（可选）
6. 选择版本应用策略：
   - **策略1：仅新工单使用新版本**（推荐）
   - **策略2：所有工单使用新版本**（谨慎使用）
7. 提交保存

#### 1.5.2 BOM版本对比

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "BOM管理"
2. 选择BOM：产品A的BOM
3. 进入"版本历史"页面
4. 选择两个版本进行对比（如：v1.0 vs v1.1）
5. 系统显示差异：
   - 新增子件：包装材料（1个）
   - 修改子件：注塑件A（从2个改为3个）

### 1.6 系统行为

- ✅ **批量导入BOM**：
  - 支持universheet在线表格批量导入BOM数据
  - 支持使用任意部门编码，自动映射到主编码
  - 实时保存，避免数据丢失
- ✅ **BOM数据验证**：
  - 自动验证BOM数据完整性
  - 检测循环依赖
  - 检测重复子件
- ✅ **BOM层级结构**：
  - 自动生成BOM层级结构
  - 支持多层级BOM展开
  - 支持BOM树形结构可视化
- ✅ **BOM与工艺路线关联**：
  - 创建工单时，自动关联工艺路线
  - 自动展开BOM，生成生产计划
- ✅ **BOM版本管理**：
  - 支持BOM版本创建、对比、回退
  - 记录BOM变更历史
  - 支持版本应用策略选择
- ✅ **BOM用量计算**：
  - 自动计算多层级BOM的用量
  - 考虑损耗率的影响
  - 自动计算实际用料数量
- 🤖 **AI智能建议**：
  - 分析BOM结构合理性，建议优化
  - 检测循环依赖，提示修复
  - 建议BOM层级优化

### 1.7 验收标准

- ✅ BOM批量导入成功（支持universheet在线表格，实时保存）
- ✅ 部门编码自动映射正常（输入任意部门编码，自动映射到主编码）
- ✅ BOM数据验证正常（检测循环依赖、重复子件等）
- ✅ BOM层级结构生成正常（多层级BOM展开正常）
- ✅ BOM与工艺路线关联正常（创建工单时自动关联）
- ✅ BOM版本管理正常（版本创建、对比、回退）
- ✅ BOM用量计算正常（考虑损耗率，计算准确）
- ✅ AI建议正常显示（悬浮提示，不打断操作流程）

---

## 2. 工艺路线版本管理

### 2.1 应用场景

- **工艺路线需要版本管理**：支持变更追溯，记录每次工艺路线的修改历史
- **不同版本工艺路线可以同时使用**：不同产品可以使用不同版本的工艺路线
- **支持工艺路线版本对比和回退**：可以对比不同版本的差异，支持回退到历史版本
- **支持工艺路线版本对在制工单的影响分析**：分析版本变更对正在执行的工单的影响

### 2.2 用户操作流程

#### 2.2.1 创建工艺路线新版本

1. 进入"主数据管理" → "工艺管理" → "工艺路线管理"
2. 编辑工艺路线：产品A工艺路线（当前版本：v1.0）
3. 修改工序顺序或参数：
   - 调整工序顺序：将"检验工序"移到"组装工序"之前
   - 修改标准工时：注塑工序标准工时从10分钟改为8分钟
4. 点击"保存为新版本"按钮
5. 填写版本信息：
   - 版本号：v1.1（系统自动建议，可修改）
   - 版本说明：优化工序顺序，提高检验效率
   - 生效日期：2026-01-20（可选，默认为当前日期）
6. 选择版本应用策略：
   - **策略1：仅新工单使用新版本**（推荐，默认）
     - 已创建的工单继续使用旧版本（v1.0）
     - 新创建的工单使用新版本（v1.1）
   - **策略2：所有工单使用新版本**（谨慎使用）
     - 系统提示：是否更新所有在制工单的工艺路线？
     - 选择：是/否
     - 如果选择"是"，系统自动更新所有在制工单的工艺路线
7. 提交保存

#### 2.2.2 版本对比和回退

1. 进入"主数据管理" → "工艺管理" → "工艺路线管理"
2. 选择工艺路线：产品A工艺路线
3. 进入"版本历史"页面
4. 查看版本列表：
   - v1.1（当前版本，2026-01-20创建）
   - v1.0（历史版本，2026-01-10创建）
5. 选择两个版本进行对比：
   - 选择v1.0和v1.1
   - 点击"对比"按钮
   - 系统显示差异：
     - 工序顺序变化：检验工序从第3位移到第2位
     - 标准工时变化：注塑工序从10分钟改为8分钟
6. 如果需要回退：
   - 选择历史版本：v1.0
   - 点击"回退到此版本"按钮
   - 系统提示：确认回退到v1.0？
   - 选择：是/否
   - 如果选择"是"，系统创建新版本（v1.2），内容与v1.0相同

#### 2.2.3 版本对在制工单的影响分析

1. 创建工艺路线新版本时，系统自动分析：
   - 统计使用该工艺路线的在制工单数量
   - 分析版本变更对在制工单的影响：
     - 如果工序顺序变化，提示：X个工单的工序顺序将受影响
     - 如果标准工时变化，提示：X个工单的标准工时将受影响
   - 显示影响分析报告：
     ```
     影响分析报告：
     - 在制工单数量：10个
     - 受影响工单：5个（工序顺序变化）
     - 建议操作：仅新工单使用新版本
     ```
2. 用户根据影响分析报告决定版本应用策略

### 2.3 系统行为

- ✅ **版本管理**：
  - 每次修改工艺路线时，自动创建新版本
  - 版本号自动递增（v1.0 → v1.1 → v1.2）
  - 支持自定义版本号
  - 记录版本创建时间、创建人、版本说明
- ✅ **版本对比**：
  - 支持两个版本之间的详细对比
  - 对比内容包括：工序顺序、标准工时、SOP关联、跳转规则等
  - 可视化显示差异（高亮显示变化部分）
- ✅ **版本回退**：
  - 支持回退到任意历史版本
  - 回退时创建新版本，保留历史记录
  - 支持版本应用策略选择
- ✅ **影响分析**：
  - 自动分析版本变更对在制工单的影响
  - 提供影响分析报告
  - 支持影响分析预览（在保存前）

### 2.4 验收标准

- ✅ 工艺路线版本创建成功（自动版本号递增）
- ✅ 版本对比功能正常（可视化显示差异）
- ✅ 版本回退功能正常（创建新版本，保留历史）
- ✅ 影响分析功能正常（准确分析对在制工单的影响）
- ✅ 版本应用策略正常（仅新工单使用新版本 / 所有工单使用新版本）

---

## 3. SOP参数收集详细设计

### 3.1 Formily表单设计器集成

#### 3.1.1 技术实现

- **使用Formily表单设计器**：基于@formily/core和@formily/react
- **表单配置存储**：SOP的`form_config`字段（JSON格式）
- **表单配置结构**：
  ```json
  {
    "schema": {
      "type": "object",
      "properties": {
        "torque": {
          "type": "number",
          "title": "扭矩",
          "x-component": "NumberPicker",
          "x-component-props": {
            "unit": "N·m"
          },
          "x-validator": [
            {
              "type": "range",
              "min": 20,
              "max": 30
            }
          ],
          "default": 25,
          "required": true
        },
        "appearance_check": {
          "type": "string",
          "title": "外观检查",
          "x-component": "Select",
          "enum": [
            { "label": "是", "value": "yes" },
            { "label": "否", "value": "no" }
          ],
          "required": true
        },
        "remark": {
          "type": "string",
          "title": "备注",
          "x-component": "Input.TextArea",
          "required": false
        }
      }
    }
  }
  ```

#### 3.1.2 参数类型支持

- **数字类型**：
  - 支持单位显示（如：N·m、℃、kg）
  - 支持范围验证（最小值、最大值）
  - 支持默认值
  - 支持小数位数设置
- **文本类型**：
  - 单行文本（Input）
  - 多行文本（TextArea）
  - 支持最大长度验证
  - 支持正则表达式验证
- **选择类型**：
  - 单选（Select）
  - 多选（Select，multiple）
  - 支持选项动态加载（从数据字典）
- **日期类型**：
  - 日期选择（DatePicker）
  - 时间选择（TimePicker）
  - 日期时间选择（DatePicker，showTime）
- **布尔类型**：
  - 开关（Switch）
  - 是/否选择（Radio.Group）

#### 3.1.3 参数验证规则

- **必填验证**：`required: true`
- **范围验证**：数字类型的`min`和`max`
- **格式验证**：文本类型的正则表达式
- **长度验证**：文本类型的`minLength`和`maxLength`
- **自定义验证**：支持自定义验证函数

### 3.2 报工时参数收集流程

#### 3.2.1 报工界面动态渲染

1. **工单报工界面**：
   - 选择工序：组装工序
   - 系统检测：该工序关联了SOP《组装作业标准》
   - 系统加载：SOP的`form_config`配置
   - 系统渲染：根据`form_config`动态生成参数收集表单
2. **参数收集表单显示**：
   - 扭矩：数字输入框（单位：N·m，范围：20-30，默认值：25）
   - 外观检查：下拉选择（选项：是/否，必填）
   - 备注：多行文本输入框（可选）
3. **参数验证**：
   - 用户输入扭矩：35
   - 系统提示：扭矩超出范围（20-30），请重新输入
   - 用户修改扭矩：25
   - 系统验证通过
4. **参数提交**：
   - 用户填写完所有必填参数
   - 点击"提交报工"按钮
   - 系统保存报工数据和参数数据

#### 3.2.2 参数数据存储

- **报工记录表**：`work_order_operations`（工单工序表）
- **参数数据表**：`sop_execution_parameters`（SOP执行参数表）
- **数据关联**：
  - `sop_execution_parameters.operation_id` → `work_order_operations.id`
  - `sop_execution_parameters.sop_id` → `sop.id`
- **参数数据格式**：
  ```json
  {
    "torque": 25,
    "appearance_check": "yes",
    "remark": "外观检查正常"
  }
  ```

### 3.3 系统行为

- ✅ **SOP参数收集配置**：
  - 使用Formily表单设计器配置参数收集表单
  - 支持多种参数类型（数字、文本、选择、日期、布尔）
  - 支持参数验证规则（必填、范围、格式、长度）
  - 配置保存到SOP的`form_config`字段
- ✅ **报工时参数收集**：
  - 根据SOP的`form_config`动态渲染参数收集表单
  - 自动验证参数是否符合配置的验证规则
  - 必填参数校验正常
  - 参数数据保存到`sop_execution_parameters`表
- ✅ **参数数据查询**：
  - 支持查询历史报工参数数据
  - 支持参数数据统计分析
  - 支持参数数据导出

### 3.4 验收标准

- ✅ Formily表单设计器集成成功（可以配置参数收集表单）
- ✅ 参数类型支持完整（数字、文本、选择、日期、布尔）
- ✅ 参数验证规则生效（必填、范围、格式、长度）
- ✅ 报工时参数收集表单动态渲染正常
- ✅ 参数数据保存成功（保存到数据库）
- ✅ 参数数据查询正常（可以查询历史数据）

---

## 4. 子工艺路线详细设计

### 4.1 应用场景

- **复杂工序需要细化**：某些工序（如组装工序）需要多个子步骤完成
- **支持嵌套工艺路线**：子工艺路线可以有自己的子工艺路线（多层嵌套）
- **独立管理**：子工艺路线可以独立管理，支持复用
- **报工流程控制**：先完成子工艺路线的所有工序，才能完成主工序

### 4.2 用户操作流程

#### 4.2.1 创建子工艺路线

1. **创建主工艺路线**：
   - 进入"主数据管理" → "工艺管理" → "工艺路线管理"
   - 创建工艺路线：产品A工艺路线
   - 添加工序：
     - 工序1：注塑工序
     - 工序2：组装工序（需要设置子工艺路线）
     - 工序3：包装工序

2. **为工序设置子工艺路线**：
   - 编辑工序：组装工序
   - 点击"设置子工艺路线"按钮
   - 创建子工艺路线：组装子工艺路线
   - 添加子工序：
     - 子工序1：预组装（按数量报工，标准工时：5分钟/件）
     - 子工序2：主组装（按数量报工，标准工时：10分钟/件）
     - 子工序3：紧固（按状态报工，标准工时：2分钟）
   - 设置子工序跳转规则：
     - 子工序1：不允许跳转
     - 子工序2：不允许跳转（必须完成子工序1）
     - 子工序3：不允许跳转（必须完成子工序2）
   - 保存子工艺路线

3. **为子工序关联SOP**（可选）：
   - 编辑子工序：主组装
   - 关联SOP：主组装作业标准
   - 保存

#### 4.2.2 嵌套子工艺路线

1. **创建嵌套子工艺路线**：
   - 编辑子工序：主组装
   - 点击"设置子工艺路线"按钮
   - 创建嵌套子工艺路线：主组装子工艺路线
   - 添加嵌套子工序：
     - 嵌套子工序1：部件A组装（按数量报工）
     - 嵌套子工序2：部件B组装（按数量报工）
     - 嵌套子工序3：部件连接（按状态报工）
   - 保存嵌套子工艺路线

2. **嵌套层级限制**：
   - 系统建议：最多支持3层嵌套（主工艺路线 → 子工艺路线 → 嵌套子工艺路线）
   - 超过3层时，系统提示：嵌套层级过深，建议简化工艺路线

### 4.3 报工流程

#### 4.3.1 子工艺路线报工流程

1. **工单创建**：
   - 创建工单：产品A工单
   - 系统自动应用工艺路线：产品A工艺路线
   - 系统显示工序结构：
     ```
     工序1：注塑工序
     工序2：组装工序
       └── 子工序1：预组装
       └── 子工序2：主组装
       └── 子工序3：紧固
     工序3：包装工序
     ```

2. **报工顺序**：
   - **第一步**：完成工序1（注塑）
   - **第二步**：开始工序2（组装）
     - 必须先完成子工序1（预组装）
     - 然后完成子工序2（主组装）
     - 然后完成子工序3（紧固）
     - 所有子工序完成后，才能完成主工序2（组装）
   - **第三步**：完成工序3（包装）

3. **报工界面**：
   - 选择工序：组装工序
   - 系统显示：子工艺路线进度
     - 子工序1：预组装（已完成）
     - 子工序2：主组装（进行中）
     - 子工序3：紧固（未开始）
   - 系统提示：必须先完成所有子工序，才能完成主工序

### 4.4 系统行为

- ✅ **子工艺路线创建**：
  - 支持为某个工序设置子工艺路线
  - 子工艺路线可以独立管理，支持复用
  - 支持嵌套子工艺路线（最多3层）
- ✅ **报工流程控制**：
  - 先完成子工艺路线的所有工序，才能完成主工序
  - 系统自动校验子工序完成状态
  - 支持子工序并行执行（如果允许跳转）
- ✅ **子工艺路线复用**：
  - 支持将子工艺路线保存为模板
  - 支持在其他工序中复用子工艺路线模板
  - 支持子工艺路线版本管理

### 4.5 验收标准

- ✅ 子工艺路线创建成功（可以为工序设置子工艺路线）
- ✅ 嵌套子工艺路线支持正常（最多3层嵌套）
- ✅ 报工流程控制正常（先完成子工序，再完成主工序）
- ✅ 子工艺路线独立管理正常（可以独立编辑、删除）
- ✅ 子工艺路线复用正常（可以保存为模板，在其他工序中复用）

---

## 5. 工序类型和跳转规则详细设计

### 4.1 工序类型详细设计

#### 4.1.1 按数量报工

**适用场景**：
- 注塑工序
- 组装工序
- 包装工序
- 其他需要统计完成数量的生产工序

**报工要求**：
- 需要输入完成数量（必填）
- 需要输入合格数量（必填）
- 系统自动计算不合格数量（完成数量 - 合格数量）
- 支持批量报工（一次报工多个数量）

**报工界面**：
```
工序：注塑工序（按数量报工）
─────────────────────────────
完成数量：[100] 个
合格数量：[95] 个
不合格数量：[5] 个（自动计算）
─────────────────────────────
[提交报工]
```

#### 4.1.2 按状态报工

**适用场景**：
- 检验工序
- 测试工序
- 审批工序
- 其他只有完成/未完成状态的非生产性工序

**报工要求**：
- 只需要选择完成/未完成状态（必填）
- 无数量概念
- 支持添加备注说明

**报工界面**：
```
工序：检验工序（按状态报工）
─────────────────────────────
完成状态：○ 完成  ○ 未完成
备注：[________________]
─────────────────────────────
[提交报工]
```

### 4.2 工序跳转规则详细设计

#### 4.2.1 不允许跳转（默认）

**规则说明**：
- 必须完成上道工序才能开始下道工序
- 工单执行时，系统自动校验工序跳转规则
- 不允许跳转的工序，必须等待上道工序完成才能报工

**适用场景**：
- 注塑工序 → 组装工序 → 包装工序（顺序执行）
- 必须按顺序完成的工序链

**系统行为**：
- 工序1未完成时，无法报工工序2
- 系统提示：必须先完成工序1，才能开始工序2
- 工序1完成后，工序2自动解锁，可以报工

#### 4.2.2 允许跳转

**规则说明**：
- 可以并行进行，不依赖上道工序完成
- 允许跳转的工序，可以随时报工（不依赖上道工序）
- 支持多个工序并行执行

**适用场景**：
- 组装工序 + 检验工序（可并行执行）
- 测试工序（可随时执行，不依赖生产工序）
- 审批工序（可随时执行，不依赖生产工序）

**系统行为**：
- 允许跳转的工序，可以随时报工（不依赖上道工序）
- 系统不阻止并行报工
- 支持多个工序同时进行

**报工界面示例**：
```
工序：检验工序（允许跳转）
─────────────────────────────
完成状态：○ 完成  ○ 未完成
备注：[________________]
─────────────────────────────
提示：此工序允许跳转，可随时报工
[提交报工]
```

### 4.3 系统行为

- ✅ **工序类型识别**：
  - 系统根据工序类型自动显示对应的报工界面
  - 按数量报工：显示数量输入框
  - 按状态报工：显示状态选择框
- ✅ **跳转规则校验**：
  - 不允许跳转的工序，系统自动校验上道工序完成状态
  - 允许跳转的工序，系统不校验上道工序状态
  - 报工时实时提示跳转规则状态
- ✅ **并行执行支持**：
  - 支持多个允许跳转的工序并行执行
  - 系统自动跟踪并行工序的执行状态

### 4.4 验收标准

- ✅ 按数量报工界面正常（显示数量输入框，自动计算不合格数量）
- ✅ 按状态报工界面正常（显示状态选择框）
- ✅ 不允许跳转规则生效（必须完成上道工序才能开始下道工序）
- ✅ 允许跳转规则生效（可以并行进行）
- ✅ 系统自动校验跳转规则，阻止不符合规则的报工
- ✅ 并行执行支持正常（多个允许跳转的工序可以同时进行）

---

## 6. 工艺路线绑定机制详细设计

### 5.1 应用场景

- **批量管理**：同一物料分组的物料使用相同工艺路线，减少重复配置
- **精确控制**：特定物料可以使用专用工艺路线，覆盖分组工艺路线
- **自动匹配**：创建工单时，系统自动按优先级匹配工艺路线
- **灵活配置**：支持物料绑定和物料分组绑定两种方式

### 5.2 绑定方式

#### 5.2.1 物料分组绑定（推荐，批量管理）

**用户操作**：
1. 进入"主数据管理" → "工艺管理" → "工艺路线管理"
2. 编辑工艺路线：注塑件通用工艺路线
3. 进入"绑定物料"页面
4. 选择绑定类型：物料分组
5. 选择物料分组：注塑件分组（包含产品A、产品B、产品C）
6. 保存绑定关系

**系统自动应用**：
- 注塑件分组下的所有物料（产品A、产品B、产品C）自动关联该工艺路线
- 创建工单时，如果物料没有单独绑定工艺路线，则自动使用分组绑定的工艺路线

#### 5.2.2 物料绑定（精确控制，优先级高于物料分组）

**用户操作**：
1. 进入"主数据管理" → "工艺管理" → "工艺路线管理"
2. 编辑工艺路线：产品A专用工艺路线
3. 进入"绑定物料"页面
4. 选择绑定类型：物料
5. 选择物料：产品A
6. 保存绑定关系

**系统自动应用**：
- 产品A优先使用"产品A专用工艺路线"（即使产品A属于注塑件分组，也优先使用物料绑定的工艺路线）
- 创建工单时，如果物料有单独绑定的工艺路线，优先使用物料绑定的工艺路线

#### 5.2.3 在物料主数据中直接关联（传统方式，兼容保留）

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "物料主数据"
2. 编辑产品：产品A
3. 选择默认工艺路线：产品A工艺路线
4. 保存

**优先级**：物料主数据中的工艺路线关联优先级最高（高于物料绑定和物料分组绑定）

### 5.3 优先级规则

**优先级从高到低**：
1. **物料主数据中的工艺路线关联**（最高优先级）
2. **物料绑定工艺路线**（第二优先级）
3. **物料分组绑定工艺路线**（第三优先级）
4. **默认工艺路线**（最低优先级，如果物料没有绑定任何工艺路线）

**自动匹配逻辑**：
- 创建工单选择物料后，系统按优先级自动匹配工艺路线
- 如果物料主数据中有工艺路线，优先使用
- 如果物料主数据中没有，检查物料是否单独绑定了工艺路线
- 如果物料没有单独绑定，检查物料所属分组是否绑定了工艺路线
- 如果都没有，使用默认工艺路线（如果配置了）

### 5.4 系统行为

- ✅ **工艺路线绑定**：
  - 支持工艺路线绑定到物料分组（批量管理）
  - 支持工艺路线绑定到单个物料（精确控制）
  - 支持在物料主数据中直接关联工艺路线（传统方式）
- ✅ **自动继承机制**：
  - 如果物料没有单独绑定工艺路线，但所属分组绑定了工艺路线，则自动使用分组绑定的工艺路线
  - 支持物料分组变更时，自动更新物料工艺路线关联
- ✅ **创建工单时自动匹配**：
  - 新建工单选择物料后，系统自动按优先级匹配工艺路线
  - 匹配逻辑：物料主数据 → 物料绑定 → 物料分组绑定 → 默认工艺路线
- ✅ **批量更新支持**：
  - 支持批量更新物料分组的工艺路线绑定
  - 支持批量更新物料的工艺路线绑定
  - 支持批量更新时，提示是否更新已创建工单的工艺路线

### 5.5 验收标准

- ✅ 工艺路线可以绑定到物料分组（批量管理）
- ✅ 工艺路线可以绑定到单个物料（精确控制）
- ✅ 物料主数据中可以关联工艺路线（传统方式）
- ✅ 优先级规则正常（物料主数据 > 物料绑定 > 物料分组绑定 > 默认工艺路线）
- ✅ 自动继承机制正常（物料自动继承分组工艺路线）
- ✅ 创建工单时，自动匹配工艺路线成功（按优先级匹配）
- ✅ 批量更新功能正常（批量更新绑定关系）

---

## 7. 报工界面动态渲染

### 6.1 应用场景

- **根据工序类型动态渲染**：按数量报工和按状态报工显示不同的报工界面
- **根据SOP配置动态渲染**：如果工序关联了SOP，根据SOP的`form_config`动态生成参数收集表单
- **实时验证**：报工时实时验证参数是否符合配置的验证规则
- **智能提示**：根据工序状态和跳转规则，智能提示用户操作

### 6.2 报工界面渲染逻辑

#### 6.2.1 按数量报工界面

**渲染条件**：工序类型为"按数量报工"

**界面元素**：
- 完成数量输入框（必填，数字类型）
- 合格数量输入框（必填，数字类型）
- 不合格数量显示（自动计算：完成数量 - 合格数量，只读）
- 提交报工按钮

**验证规则**：
- 完成数量必须大于0
- 合格数量必须大于等于0
- 合格数量不能大于完成数量
- 系统自动计算不合格数量

**界面示例**：
```
┌─────────────────────────────────────┐
│ 工序：注塑工序（按数量报工）          │
├─────────────────────────────────────┤
│ 完成数量：[100] 个                   │
│ 合格数量：[95] 个                    │
│ 不合格数量：[5] 个（自动计算）       │
├─────────────────────────────────────┤
│ [提交报工]                           │
└─────────────────────────────────────┘
```

#### 6.2.2 按状态报工界面

**渲染条件**：工序类型为"按状态报工"

**界面元素**：
- 完成状态选择（必填，单选：完成/未完成）
- 备注输入框（可选，多行文本）
- 提交报工按钮

**验证规则**：
- 完成状态必须选择（必填）

**界面示例**：
```
┌─────────────────────────────────────┐
│ 工序：检验工序（按状态报工）          │
├─────────────────────────────────────┤
│ 完成状态：○ 完成  ○ 未完成           │
│ 备注：[________________]             │
│       [________________]             │
├─────────────────────────────────────┤
│ [提交报工]                           │
└─────────────────────────────────────┘
```

#### 6.2.3 带SOP参数的报工界面

**渲染条件**：工序关联了SOP，且SOP配置了`form_config`

**界面元素**：
- 基础报工信息（根据工序类型显示：数量或状态）
- SOP参数收集表单（根据SOP的`form_config`动态生成）
- 提交报工按钮

**渲染流程**：
1. 系统检测工序是否关联了SOP
2. 如果关联了SOP，加载SOP的`form_config`配置
3. 使用Formily表单引擎，根据`form_config`动态生成参数收集表单
4. 将参数收集表单嵌入到报工界面中
5. 报工时，同时验证基础报工信息和SOP参数

**界面示例**（按数量报工 + SOP参数）：
```
┌─────────────────────────────────────┐
│ 工序：组装工序（按数量报工）          │
├─────────────────────────────────────┤
│ 完成数量：[100] 个                   │
│ 合格数量：[95] 个                    │
│ 不合格数量：[5] 个（自动计算）       │
├─────────────────────────────────────┤
│ SOP参数收集：                        │
│ ┌─────────────────────────────────┐ │
│ │ 扭矩：[25] N·m (范围：20-30)    │ │
│ │ 外观检查：[是 ▼]                │ │
│ │ 备注：[________________]        │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ [提交报工]                           │
└─────────────────────────────────────┘
```

### 6.3 跳转规则提示

#### 6.3.1 不允许跳转的提示

**显示条件**：工序不允许跳转，且上道工序未完成

**提示内容**：
- 显示上道工序状态（未完成）
- 提示：必须先完成上道工序，才能开始此工序
- 报工按钮禁用（灰色，不可点击）

**界面示例**：
```
┌─────────────────────────────────────┐
│ 工序：组装工序（按数量报工）          │
├─────────────────────────────────────┤
│ ⚠️ 提示：必须先完成工序1（注塑），    │
│    才能开始此工序                    │
│                                     │
│ 上道工序状态：                       │
│ - 工序1：注塑工序（进行中）          │
├─────────────────────────────────────┤
│ [提交报工]（禁用）                   │
└─────────────────────────────────────┘
```

#### 6.3.2 允许跳转的提示

**显示条件**：工序允许跳转

**提示内容**：
- 提示：此工序允许跳转，可随时报工
- 报工按钮启用（可点击）

**界面示例**：
```
┌─────────────────────────────────────┐
│ 工序：检验工序（按状态报工）          │
├─────────────────────────────────────┤
│ ℹ️ 提示：此工序允许跳转，可随时报工   │
│                                     │
│ 完成状态：○ 完成  ○ 未完成           │
│ 备注：[________________]             │
├─────────────────────────────────────┤
│ [提交报工]                           │
└─────────────────────────────────────┘
```

### 6.4 子工艺路线报工界面

#### 6.4.1 子工艺路线进度显示

**显示条件**：工序设置了子工艺路线

**界面元素**：
- 主工序信息
- 子工艺路线进度（树形结构显示）
- 子工序报工按钮（每个子工序独立的报工按钮）

**界面示例**：
```
┌─────────────────────────────────────┐
│ 工序：组装工序（按数量报工）          │
├─────────────────────────────────────┤
│ 子工艺路线进度：                     │
│ ┌─────────────────────────────────┐ │
│ │ ✓ 子工序1：预组装（已完成）      │ │
│ │ ▶ 子工序2：主组装（进行中）      │ │
│ │ ○ 子工序3：紧固（未开始）        │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 提示：必须先完成所有子工序，          │
│      才能完成主工序                  │
├─────────────────────────────────────┤
│ [报工子工序2]  [完成主工序]（禁用）  │
└─────────────────────────────────────┘
```

#### 6.4.2 子工序报工流程

1. **选择子工序报工**：
   - 点击"报工子工序2"按钮
   - 系统显示子工序2的报工界面（根据子工序类型和SOP配置）
   - 填写报工信息并提交
2. **完成所有子工序后**：
   - 所有子工序完成后，"完成主工序"按钮自动启用
   - 点击"完成主工序"按钮，完成主工序报工

### 6.5 系统行为

- ✅ **动态渲染**：
  - 根据工序类型自动渲染对应的报工界面
  - 根据SOP配置动态生成参数收集表单
  - 根据跳转规则显示/隐藏报工按钮
- ✅ **实时验证**：
  - 报工时实时验证参数是否符合配置的验证规则
  - 必填参数校验正常
  - 范围、格式等验证规则生效
- ✅ **智能提示**：
  - 根据工序状态和跳转规则，智能提示用户操作
  - 显示上道工序完成状态
  - 提示跳转规则限制
- ✅ **子工艺路线支持**：
  - 支持子工艺路线进度显示
  - 支持子工序独立报工
  - 支持主工序完成校验（所有子工序完成后才能完成主工序）

### 6.6 验收标准

- ✅ 按数量报工界面正常（显示数量输入框，自动计算不合格数量）
- ✅ 按状态报工界面正常（显示状态选择框）
- ✅ 带SOP参数的报工界面正常（动态生成参数收集表单）
- ✅ 跳转规则提示正常（不允许跳转时禁用报工按钮，允许跳转时提示可随时报工）
- ✅ 子工艺路线报工界面正常（显示子工艺路线进度，支持子工序独立报工）
- ✅ 参数验证正常（实时验证参数是否符合配置的验证规则）
- ✅ 智能提示正常（根据工序状态和跳转规则，智能提示用户操作）

---

## 8. 工艺路线模板管理

### 7.1 应用场景

- **快速创建**：基于模板快速创建工艺路线，减少重复配置
- **标准化管理**：将常用工艺路线保存为模板，实现标准化管理
- **模板复用**：支持模板在不同物料或物料分组中复用
- **模板版本管理**：支持模板版本管理，记录模板变更历史

### 7.2 模板创建和管理

#### 7.2.1 创建工艺路线模板

**用户操作**：
1. 进入"主数据管理" → "工艺管理" → "工艺路线管理"
2. 编辑工艺路线：注塑件通用工艺路线
3. 点击"保存为模板"按钮
4. 填写模板信息：
   - 模板名称：注塑件通用工艺路线模板
   - 模板分类：注塑类（可选，用于模板分类管理）
   - 模板描述：适用于所有注塑件产品的通用工艺路线
5. 选择模板适用范围：
   - 适用范围：所有物料分组 / 特定物料分组 / 所有物料
6. 提交保存

**系统行为**：
- 自动创建工艺路线模板
- 保存模板的完整配置（工序顺序、标准工时、SOP关联、跳转规则等）
- 支持模板分类管理
- 记录模板创建时间、创建人

#### 7.2.2 基于模板创建工艺路线

**用户操作**：
1. 进入"主数据管理" → "工艺管理" → "工艺路线管理"
2. 点击"新建"按钮
3. 选择"从模板创建"
4. 选择模板：注塑件通用工艺路线模板
5. 系统自动填充：
   - 工序顺序（从模板复制）
   - 标准工时（从模板复制）
   - SOP关联（从模板复制）
   - 跳转规则（从模板复制）
6. 修改工艺路线信息：
   - 工艺路线名称：产品A工艺路线（可修改）
   - 绑定物料或物料分组（可修改）
7. 根据需要调整工序配置（可选择性修改）
8. 提交保存

**系统行为**：
- 自动从模板复制所有配置
- 支持选择性修改模板配置
- 创建新工艺路线，不影响模板

### 7.3 模板分类管理

#### 7.3.1 模板分类

**分类方式**：
- 按工序类型分类：注塑类、组装类、包装类等
- 按产品类型分类：成品类、半成品类、原材料类等
- 按行业分类：制造业通用、电子行业、机械行业等

**用户操作**：
1. 进入"主数据管理" → "工艺管理" → "工艺路线模板管理"
2. 查看模板分类列表
3. 选择分类：注塑类
4. 查看该分类下的所有模板

#### 7.3.2 模板搜索和筛选

**搜索方式**：
- 按模板名称搜索
- 按模板分类筛选
- 按适用范围筛选
- 按创建时间筛选

### 7.4 模板版本管理

#### 7.4.1 模板版本创建

**用户操作**：
1. 编辑模板：注塑件通用工艺路线模板
2. 修改模板配置（如：增加检验工序）
3. 点击"保存为新版本"按钮
4. 填写版本信息：
   - 版本号：v1.1（系统自动建议）
   - 版本说明：增加检验工序，提高产品质量
5. 提交保存

**系统行为**：
- 自动创建模板新版本
- 保留历史版本
- 记录版本变更历史

#### 7.4.2 模板版本对比

**用户操作**：
1. 进入"主数据管理" → "工艺管理" → "工艺路线模板管理"
2. 选择模板：注塑件通用工艺路线模板
3. 进入"版本历史"页面
4. 选择两个版本进行对比（如：v1.0 vs v1.1）
5. 系统显示版本差异

### 7.5 系统行为

- ✅ **模板创建**：
  - 支持将工艺路线保存为模板
  - 支持模板分类管理
  - 支持模板描述和适用范围设置
- ✅ **基于模板创建**：
  - 支持从模板快速创建工艺路线
  - 自动复制模板的所有配置
  - 支持选择性修改模板配置
- ✅ **模板管理**：
  - 支持模板搜索和筛选
  - 支持模板分类管理
  - 支持模板版本管理
- ✅ **模板复用**：
  - 支持模板在不同物料或物料分组中复用
  - 支持模板版本管理，记录模板变更历史
- 🤖 **AI智能建议**：
  - 基于历史数据，建议适合的工艺路线模板
  - 分析模板使用情况，建议优化模板配置

### 7.6 验收标准

- ✅ 工艺路线模板创建成功（可以保存为模板）
- ✅ 基于模板创建工艺路线成功（从模板快速创建）
- ✅ 模板分类管理正常（支持模板分类和搜索）
- ✅ 模板版本管理正常（支持模板版本创建和对比）
- ✅ 模板复用正常（可以在不同物料或物料分组中复用）
- ✅ AI建议正常显示（建议适合的工艺路线模板）

---

## 9. 核心功能总结

### 9.1 BOM管理核心功能

1. **批量导入**：支持universheet在线表格批量导入，实时保存
2. **编码映射**：支持使用任意部门编码，自动映射到主编码
3. **数据验证**：自动验证BOM数据完整性，检测循环依赖
4. **层级结构**：自动生成BOM层级结构，支持多层级展开
5. **版本管理**：支持BOM版本创建、对比、回退
6. **用量计算**：自动计算多层级BOM用量，考虑损耗率

### 9.2 工艺路线核心功能

1. **版本管理**：支持工艺路线版本创建、对比、回退，记录变更历史
2. **变更管理**：支持工艺路线变更申请、审批、执行，评估对在制工单的影响
3. **绑定机制**：支持物料分组绑定和物料绑定，优先级管理，自动匹配
4. **子工艺路线**：支持嵌套工艺路线，独立管理，报工流程控制
5. **模板管理**：支持工艺路线模板创建、复用、版本管理

### 9.3 SOP核心功能

1. **参数收集配置**：使用Formily表单设计器配置参数收集表单
2. **多参数类型支持**：数字、文本、选择、日期、布尔等参数类型
3. **参数验证规则**：必填、范围、格式、长度等验证规则
4. **动态渲染**：根据SOP配置动态生成参数收集表单

### 9.4 工序核心功能

1. **工序类型管理**：按数量报工 vs 按状态报工
2. **跳转规则控制**：不允许跳转 vs 允许跳转
3. **报工界面动态渲染**：根据工序类型和SOP配置动态渲染报工界面

### 9.5 优先级规则

1. **工艺路线绑定优先级**：物料主数据 > 物料绑定 > 物料分组绑定 > 默认工艺路线
2. **版本应用策略**：仅新工单使用新版本 / 所有工单使用新版本

---

## 10. 设计要点

### 10.1 用户体验优化

- ⚡ **操作步骤减少**：批量导入工序，基于模板快速创建工艺路线
- ⚡ **时间缩短**：简易路线<5分钟，带SOP路线<10分钟
- ⚡ **学习成本降低**：拖拽操作，模板复用，直观易懂
- ⚡ **智能建议**：AI辅助，不打断操作流程

### 10.2 灵活性设计

- ⚡ **工序类型灵活**：支持按数量报工和按状态报工，适应不同工序特点
- ⚡ **跳转控制精确**：支持工序跳转规则，灵活控制工序执行顺序
- ⚡ **绑定机制灵活**：支持物料分组绑定和物料绑定，优先级管理
- ⚡ **模板复用**：支持工艺路线模板，快速创建

### 10.3 可扩展性设计

- ⚡ **子工艺路线支持**：支持嵌套工艺路线（最多3层）
- ⚡ **版本管理**：支持工艺路线版本管理，记录变更历史
- ⚡ **变更管理**：支持工艺路线变更申请、审批、执行
- ⚡ **SOP参数扩展**：支持多种参数类型，可扩展

---

## 11. 后续强化设计方向

### 11.1 BOM管理强化

1. **BOM替代料管理**：支持替代料配置和自动替换
2. **BOM成本计算**：基于BOM自动计算产品成本
3. **BOM可视化**：BOM树形结构可视化展示
4. **BOM优化建议**：基于历史数据，AI建议BOM优化

### 11.2 工艺路线强化

1. **工艺路线优化建议**：基于历史数据，AI建议工艺路线优化
2. **工艺路线对比分析**：不同工艺路线对比分析
3. **工艺路线执行监控**：工艺路线执行情况监控和分析
4. **工艺路线知识库**：工艺路线知识库管理，支持搜索和推荐

### 11.3 SOP强化

1. **SOP版本管理**：支持SOP版本控制
2. **SOP审批流程**：SOP创建、修改审批流程
3. **SOP执行监控**：SOP执行情况监控和分析
4. **SOP知识库**：SOP知识库管理，支持搜索和推荐

### 11.4 工序强化

1. **工序优化建议**：基于历史数据，AI建议工序优化
2. **工序执行监控**：工序执行情况监控和分析
3. **工序知识库**：工序知识库管理，支持搜索和推荐

---

**文档结束**

**最后更新**：2026-01-16