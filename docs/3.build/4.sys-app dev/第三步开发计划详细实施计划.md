# 第三步开发计划详细实施计划

**创建日期：** 2025-01-15  
**基于文档：** 第三步开发计划MTS-MTO.MD  
**完成情况分析：** 第三步开发计划完成情况分析.md

---

## 📋 实施计划概述

### 总体目标
基于第二步已完成的MTS/MTO完整业务流程，完善系统基础功能，优化用户体验，实现全场景用户使用流程。

### 完成度现状
- **已实现功能：** 约 15%
- **部分实现功能：** 约 10%
- **未实现功能：** 约 75%

### 实施原则
1. **优先级驱动**：先实现高优先级、影响用户体验的核心功能
2. **依赖关系分析**：先实现基础功能，再实现依赖功能
3. **渐进式开发**：每个功能模块独立实现，逐步完善
4. **代码规范**：遵循项目编码规范和命名规范
5. **测试驱动**：关键功能需要测试用例

---

## 🎯 实施优先级分类

### P0 - 关键核心功能（必须实现）
这些功能是系统的基础，影响核心业务流程：
1. 快速初始化向导
2. 工单管理高级功能（返工单、拆分、冻结、优先级管理、合并）
3. 异常处理机制（缺料、延期、质量异常）
4. 工作台快捷操作完善

### P1 - 重要功能（应该实现）
这些功能能显著提升用户体验和系统完整性：
1. 基础数据配置优化（批量导入、期初数据导入）
2. 生产执行高级功能（委外、报废、不良品处理、报工修正）
3. 仓储管理高级功能（盘点、分析、预警、装箱绑定）
4. 报表分析功能（包含自研报表设计器，基于@dnd-kit + @ant-design/charts）

### P2 - 增强功能（可以延后）
这些功能是系统的增强特性，可以后续实现：
1. 工位机触屏模式
2. 设备模具管理
3. 成本核算管理
4. AI智能建议功能
5. 多角色场景和上线向导

---

## 📅 详细实施计划

### 第一阶段：系统基础功能（优先级：P0）

#### 阶段1.1：系统初始化与快速配置（2周）

**目标：** 实现系统注册、登录、快速初始化向导，支持行业模板和智能默认值

##### 任务1.1.1：优化组织注册功能（1天）

**当前状态：** 基础版本已实现，需要优化为"极简注册表单，手机号即账号"

**实施步骤：**
1. **后端优化**
   - 修改 `OrganizationRegisterRequest` Schema，将手机号作为必填字段
   - 优化 `register_organization` 方法，支持手机号即账号
   - 添加手机号验证逻辑
   - 位置：`riveredge-backend/src/infra/schemas/auth.py`
   - 位置：`riveredge-backend/src/infra/services/auth_service.py`

2. **前端优化**
   - 优化组织注册表单，简化字段（仅保留：组织名称、手机号、密码）
   - 手机号自动作为用户名
   - 位置：`riveredge-frontend/src/pages/login/index.tsx`

**验收标准：**
- ✅ 注册表单仅3个字段：组织名称、手机号、密码
- ✅ 手机号自动作为登录账号
- ✅ 注册流程 < 1分钟完成

**技术要点：**
- 手机号格式验证：`^1[3-9]\d{9}$`
- 用户名自动设置为手机号
- 保留邮箱字段为可选（用于找回密码）

---

##### 任务1.1.2：实现快速初始化向导（5天）

**当前状态：** 未实现

**功能描述：** 3-5步完成基础配置的向导流程

**实施步骤：**

1. **后端API实现（2天）**
   - 创建初始化向导服务：`riveredge-backend/src/infra/services/init_wizard_service.py`
   - 实现向导步骤配置API
   - 实现初始化数据保存API
   - API端点：
     - `POST /api/infra/tenants/{id}/init` - 快速初始化
     - `GET /api/infra/init/steps` - 获取初始化步骤
     - `POST /api/infra/init/steps/{step_id}/complete` - 完成步骤

2. **数据模型设计（0.5天）**
   - 创建初始化配置模型（如果需要持久化）
   - 或使用临时存储（Redis/内存）

3. **前端实现（2.5天）**
   - 创建初始化向导组件：`riveredge-frontend/src/components/init-wizard/index.tsx`
   - 实现步骤式向导UI（使用Steps组件）
   - 实现步骤内容表单
   - 步骤内容：
     - 步骤1：组织信息完善（组织代码、行业、规模）
     - 步骤2：默认设置（时区、货币、语言）
     - 步骤3：管理员信息（姓名、邮箱）
     - 步骤4：选择行业模板（可选）
     - 步骤5：完成确认

**验收标准：**
- ✅ 向导流程3-5步完成
- ✅ 每一步都有清晰的说明和验证
- ✅ 支持上一步/下一步导航
- ✅ 完成后自动跳转到工作台

**技术要点：**
- 使用 Ant Design Steps 组件
- 每个步骤独立表单验证
- 支持保存进度（刷新后继续）
- 向导数据存储在 sessionStorage

---

##### 任务1.1.3：实现行业模板功能（3天）

**当前状态：** 未实现

**功能描述：** 制造业通用模板，一键应用

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建行业模板模型：`riveredge-backend/src/infra/models/industry_template.py`
   - 模板包含：编码规则、系统参数、默认角色、默认菜单配置等

2. **后端实现（1.5天）**
   - 创建模板服务：`riveredge-backend/src/infra/services/template_service.py`
   - 实现模板列表查询
   - 实现模板应用逻辑（复制配置到租户）
   - API端点：
     - `GET /api/infra/templates` - 获取行业模板列表
     - `GET /api/infra/templates/{id}` - 获取模板详情
     - `POST /api/infra/templates/{id}/apply` - 应用行业模板

3. **前端实现（1天）**
   - 创建模板选择页面：`riveredge-frontend/src/pages/init/template-select/index.tsx`
   - 实现模板卡片展示
   - 实现模板预览功能
   - 实现一键应用功能

**验收标准：**
- ✅ 至少提供1个制造业通用模板
- ✅ 模板应用后，组织的基础配置自动完成
- ✅ 应用时间 < 30秒

**技术要点：**
- 模板数据使用JSON格式存储
- 模板应用使用事务，确保一致性
- 支持模板预览（不影响现有数据）

---

##### 任务1.1.4：完善智能默认值配置（2天）

**当前状态：** 部分实现，需要完善

**功能描述：** 编码规则、系统参数等智能默认值

**实施步骤：**

1. **编码规则默认值（1天）**
   - 检查编码规则服务
   - 为新组织自动创建常用编码规则（工单、物料、客户等）
   - 位置：`riveredge-backend/src/core/services/code_rule_service.py`

2. **系统参数默认值（1天）**
   - 检查系统参数服务
   - 为新组织自动创建系统参数默认值
   - 位置：`riveredge-backend/src/core/services/system_parameter_service.py`

**验收标准：**
- ✅ 新组织创建后，所有编码规则都有默认值
- ✅ 新组织创建后，所有系统参数都有默认值
- ✅ 默认值符合中国制造业通用实践

---

##### 任务1.1.5：实现AI智能建议功能（暂缓，P2优先级）

**当前状态：** 未实现

**建议：** 此功能较为复杂，建议在基础功能完成后实现

---

##### 任务1.1.6：实现内置帮助系统（2天）

**当前状态：** 未实现

**功能描述：** 操作提示、帮助文档、操作视频

**实施步骤：**

1. **帮助文档管理（1天）**
   - 创建帮助文档模型（或使用文件系统）
   - 实现帮助文档查询API
   - API端点：
     - `GET /api/core/help/topics` - 获取帮助主题列表
     - `GET /api/core/help/topics/{id}` - 获取帮助主题详情
     - `GET /api/core/help/search` - 搜索帮助文档

2. **前端实现（1天）**
   - 创建帮助中心组件：`riveredge-frontend/src/components/help-center/index.tsx`
   - 实现帮助文档展示
   - 实现搜索功能
   - 集成到页面（悬浮按钮或侧边栏）

**验收标准：**
- ✅ 帮助文档可以按主题分类浏览
- ✅ 支持关键词搜索
- ✅ 帮助文档内容完整（至少覆盖核心功能）

**技术要点：**
- 帮助文档使用 Markdown 格式
- 文档存储在 `docs/help/` 目录
- 支持多语言（中文优先）

---

#### 阶段1.2：基础数据配置优化（2周）

**目标：** 优化基础数据配置流程，支持批量导入、快速创建、智能默认值

##### 任务1.2.1：实现组织架构批量导入（2天）

**当前状态：** 批量导入框架已实现，需要完善组织架构批量导入

**实施步骤：**

1. **后端实现（1天）**
   - 创建组织架构批量导入服务方法
   - 实现数据验证和错误处理
   - API端点：`POST /api/core/organizations/batch-import`
   - 位置：`riveredge-backend/src/core/services/organization_service.py`

2. **前端实现（1天）**
   - 在组织架构列表页面添加批量导入按钮
   - 使用 UniSheet 在线表格组件
   - 实现数据验证和错误提示
   - 位置：`riveredge-frontend/src/pages/system/organizations/list/index.tsx`

**验收标准：**
- ✅ 支持 Excel 文件导入
- ✅ 支持 UniSheet 在线表格编辑
- ✅ 导入数据验证完整
- ✅ 错误提示清晰

---

##### 任务1.2.2：实现物料编码映射工具（2天）

**当前状态：** 未实现

**功能描述：** 解决编码不统一问题，支持外部编码映射到内部编码

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建物料编码映射模型：`riveredge-backend/src/core/models/material_code_mapping.py`
   - 字段：内部编码、外部编码、外部系统、物料ID等

2. **后端实现（1天）**
   - 创建映射服务：`riveredge-backend/src/core/services/material_code_mapping_service.py`
   - 实现映射规则管理
   - 实现编码转换逻辑
   - API端点：`POST /api/core/materials/mapping`

3. **前端实现（0.5天）**
   - 创建映射工具页面
   - 实现映射规则配置界面

**验收标准：**
- ✅ 支持一对多映射（一个内部编码对应多个外部编码）
- ✅ 支持批量导入映射规则
- ✅ 编码转换准确

---

##### 任务1.2.3：实现期初数据导入功能（3天）

**当前状态：** 未实现

**功能描述：** 上线倒计时、动态数据导入

**实施步骤：**

1. **后端实现（1.5天）**
   - 创建期初数据导入服务：`riveredge-backend/src/core/services/initial_data_service.py`
   - 实现数据导入状态跟踪
   - 实现数据快照功能
   - API端点：
     - `POST /api/core/initial-data/import` - 期初数据导入
     - `GET /api/core/initial-data/status` - 期初数据导入状态
     - `POST /api/core/initial-data/snapshot` - 创建数据快照

2. **前端实现（1.5天）**
   - 创建期初数据导入向导页面
   - 实现上线倒计时功能
   - 实现分步骤数据导入（物料、BOM、库存等）
   - 实现导入进度显示

**验收标准：**
- ✅ 支持分步骤导入（物料→BOM→库存→其他）
- ✅ 导入进度实时显示
- ✅ 支持数据快照和恢复
- ✅ 上线倒计时功能正常

---

### 第二阶段：业务流程优化（优先级：P0/P1）

#### 阶段2.1：工单管理高级功能（2周，P0优先级）

**目标：** 实现工单管理高级功能，包括返工单、工单拆分、工序修改、工单冻结、优先级管理、工单合并

##### 任务2.1.1：实现返工单管理（3天）

**当前状态：** archive中有旧代码，但在kuaizhizao中未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建返工单模型：`riveredge-backend/src/apps/kuaizhizao/models/rework_order.py`
   - 字段：返工单号、原工单ID、返工原因、返工类型、返工工序等
   - 关联原工单

2. **后端实现（1.5天）**
   - 创建返工单服务：`riveredge-backend/src/apps/kuaizhizao/services/rework_order_service.py`
   - 实现返工单创建、查询、更新、删除功能
   - 实现从原工单创建返工单的逻辑
   - API端点：
     - `POST /api/apps/kuaizhizao/work-orders/{id}/rework` - 从工单创建返工单
     - `GET /api/apps/kuaizhizao/rework-orders` - 查询返工单列表
     - `GET /api/apps/kuaizhizao/rework-orders/{id}` - 查询返工单详情
     - `PUT /api/apps/kuaizhizao/rework-orders/{id}` - 更新返工单
     - `DELETE /api/apps/kuaizhizao/rework-orders/{id}` - 删除返工单

3. **Schema定义（0.5天）**
   - 创建返工单Schema：`riveredge-backend/src/apps/kuaizhizao/schemas/rework_order.py`
   - 定义返工单创建、更新、响应Schema

4. **前端实现（0.5天）**
   - 创建返工单列表页面：`riveredge-frontend/src/apps/kuaizhizao/pages/rework-orders/list/index.tsx`
   - 创建返工单表单页面：`riveredge-frontend/src/apps/kuaizhizao/pages/rework-orders/form/index.tsx`
   - 在工单详情页添加"创建返工单"按钮

**验收标准：**
- ✅ 可以从原工单创建返工单
- ✅ 返工单自动关联原工单
- ✅ 返工单流程完整（创建→执行→完成）
- ✅ 返工单列表和详情查询正常

**技术要点：**
- 返工单编码自动生成：`返工-{原工单号}-{序号}`
- 返工单状态：draft/released/in_progress/completed/cancelled
- 关联原工单，支持查看原工单信息

---

##### 任务2.1.2：实现工单拆分功能（2天）

**当前状态：** 未实现

**功能描述：** 按数量拆分、按工序拆分

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 在工单模型中添加拆分相关字段（可选，或使用关联表）
   - 考虑拆分历史记录

2. **后端实现（1天）**
   - 在工单服务中添加拆分方法：`split_work_order`
   - 实现按数量拆分逻辑
   - 实现按工序拆分逻辑
   - 数据验证：只能拆分未报工部分
   - API端点：`POST /api/apps/kuaizhizao/work-orders/{id}/split`

3. **前端实现（0.5天）**
   - 在工单详情页添加"拆分"按钮
   - 创建拆分对话框，支持选择拆分方式（按数量/按工序）
   - 实现拆分规则配置界面

**验收标准：**
- ✅ 支持按数量拆分（将大工单拆分成多个小工单）
- ✅ 支持按工序拆分（将大工单的工序拆分到不同工单）
- ✅ 只能拆分未报工部分（已报工部分不能拆分）
- ✅ 拆分工单号自动生成：`{原工单号}-{序号}`

**技术要点：**
- 拆分前检查工单状态和报工情况
- 拆分工单自动复制原工单的基础信息
- 支持批量拆分

---

##### 任务2.1.3：实现执行中工单工序修改（2天）

**当前状态：** 未实现

**功能描述：** 工序增删改、工艺路线调整

**实施步骤：**

1. **数据模型检查（0.5天）**
   - 检查工单工序模型（WorkOrderOperation）是否存在
   - 如果没有，需要创建工序模型

2. **后端实现（1天）**
   - 在工单服务中添加工序修改方法：`update_work_order_operations`
   - 实现工序增删改逻辑
   - 数据验证：已报工工序不允许修改
   - API端点：`PUT /api/apps/kuaizhizao/work-orders/{id}/operations`

3. **前端实现（0.5天）**
   - 在工单详情页添加工序列表展示
   - 实现拖拽式工序调整（使用react-beautiful-dnd或dnd-kit）
   - 实现工序增删改表单

**验收标准：**
- ✅ 已报工工序不允许修改（灰色显示，不可编辑）
- ✅ 未报工工序允许修改（可编辑）
- ✅ 支持增加未报工工序
- ✅ 支持删除未报工工序
- ✅ 支持拖拽调整工序顺序
- ✅ 自动重新计算计划结束时间

**技术要点：**
- 工序修改前检查报工状态
- 工序顺序调整后自动重新计算时间
- 支持批量操作

---

##### 任务2.1.4：实现工单冻结功能（1.5天）

**当前状态：** 未实现

**功能描述：** 冻结/解冻、冻结原因记录

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 在工单模型中添加冻结相关字段：
     - `is_frozen: BooleanField` - 是否冻结
     - `freeze_reason: TextField` - 冻结原因
     - `frozen_at: DatetimeField` - 冻结时间
     - `frozen_by: IntField` - 冻结人ID
   - 或使用单独的冻结记录表

2. **后端实现（0.5天）**
   - 在工单服务中添加冻结/解冻方法：
     - `freeze_work_order` - 冻结工单
     - `unfreeze_work_order` - 解冻工单
   - API端点：
     - `POST /api/apps/kuaizhizao/work-orders/{id}/freeze` - 冻结工单
     - `POST /api/apps/kuaizhizao/work-orders/{id}/unfreeze` - 解冻工单

3. **前端实现（0.5天）**
   - 在工单列表和详情页添加冻结/解冻按钮
   - 实现冻结原因输入对话框
   - 冻结状态的工单在列表中特殊标识

4. **业务逻辑（0.5天）**
   - 冻结工单不允许报工（在报工服务中检查）
   - 冻结工单不更新进度

**验收标准：**
- ✅ 支持单个工单冻结
- ✅ 支持批量工单冻结
- ✅ 冻结原因记录完整
- ✅ 冻结工单不能报工（自动阻止）
- ✅ 冻结工单状态显示正常
- ✅ 支持工单解冻（恢复原状态）

**技术要点：**
- 冻结状态存储为布尔字段或状态值
- 冻结原因必填
- 解冻时保留冻结历史记录

---

##### 任务2.1.5：完善工单优先级管理（1天）

**当前状态：** 字段已实现，管理功能未实现

**功能描述：** 优先级设置、排产优化

**实施步骤：**

1. **后端实现（0.5天）**
   - 在工单服务中添加优先级设置方法：`set_work_order_priority`
   - 实现批量优先级调整
   - API端点：`PUT /api/apps/kuaizhizao/work-orders/{id}/priority`

2. **前端实现（0.5天）**
   - 在工单列表添加优先级列（带颜色标识）
   - 在工单详情页添加优先级选择器
   - 实现批量优先级调整功能

**验收标准：**
- ✅ 优先级字段正常（low/normal/high/urgent）
- ✅ 支持单个工单优先级设置
- ✅ 支持批量工单优先级调整
- ✅ 优先级在列表中清晰显示（颜色区分）

**技术要点：**
- 优先级值：low/normal/high/urgent
- 优先级颜色映射：low=灰色，normal=蓝色，high=橙色，urgent=红色
- 排产时按优先级排序

---

##### 任务2.1.6：实现工单合并功能（2天）

**当前状态：** 未实现

**功能描述：** 多工单合并、合并规则验证

**实施步骤：**

1. **后端实现（1.5天）**
   - 在工单服务中添加合并方法：`merge_work_orders`
   - 实现合并规则验证：
     - 只能合并相同产品的工单
     - 只能合并相同状态的工单（draft/released）
     - 不能合并已报工的工单
   - 实现合并逻辑：
     - 创建新工单（合并后的工单）
     - 数量累加
     - 关联原工单
     - 原工单状态更新为cancelled
   - API端点：`POST /api/apps/kuaizhizao/work-orders/merge`

2. **前端实现（0.5天）**
   - 在工单列表添加"合并"操作（多选工单后显示）
   - 实现合并确认对话框
   - 显示合并预览（合并后的工单信息）

**验收标准：**
- ✅ 支持多工单合并（至少2个工单）
- ✅ 合并规则验证完整（产品相同、状态相同、未报工）
- ✅ 合并后工单数量正确（数量累加）
- ✅ 原工单状态正确更新（cancelled）
- ✅ 合并记录可追溯

**技术要点：**
- 合并前充分验证规则
- 合并使用事务，确保一致性
- 合并后工单关联原工单（用于追溯）

---

#### 阶段2.2：生产执行高级功能（2周，P1优先级）

**目标：** 实现生产执行高级功能，包括工序委外、报废处理、不良品处理、报工数据修正、工站上下料物料绑定

##### 任务2.2.1：实现工序委外管理（3天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建工序委外模型：`riveredge-backend/src/apps/kuaizhizao/models/outsource_order.py`
   - 字段：委外单号、工单ID、工序ID、供应商ID、委外数量、委外费用等

2. **后端实现（1.5天）**
   - 创建委外服务：`riveredge-backend/src/apps/kuaizhizao/services/outsource_service.py`
   - 实现委外单创建、查询、更新
   - 实现委外入库关联
   - API端点：`POST /api/apps/kuaizhizao/work-orders/{id}/outsource`

3. **前端实现（1天）**
   - 创建委外管理页面
   - 实现委外单表单
   - 实现供应商选择

**验收标准：**
- ✅ 委外单创建正常
- ✅ 委外流程完整（创建→执行→入库）
- ✅ 供应商协同正常

---

##### 任务2.2.2：实现工序报废处理（2天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 在报工记录模型中添加报废字段，或创建报废记录表

2. **后端实现（1天）**
   - 在报工服务中添加报废处理方法：`record_scrap`
   - 实现报废记录、成本计算、库存扣减
   - API端点：`POST /api/apps/kuaizhizao/reporting/{id}/scrap`

3. **前端实现（0.5天）**
   - 在报工页面添加报废记录功能
   - 实现报废原因输入

**验收标准：**
- ✅ 报废记录正常
- ✅ 成本计算准确
- ✅ 库存自动扣减

---

##### 任务2.2.3：实现工序不良品处理（2天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建不良品记录模型

2. **后端实现（1天）**
   - 在报工服务中添加不良品处理方法：`record_defect`
   - 实现不良品隔离、返工处理、报废处理
   - API端点：`POST /api/apps/kuaizhizao/reporting/{id}/defect`

3. **前端实现（0.5天）**
   - 在报工页面添加不良品记录功能
   - 实现不良品类型和处理方式选择

**验收标准：**
- ✅ 不良品记录正常
- ✅ 不良品隔离正常
- ✅ 返工/报废处理正常

---

##### 任务2.2.4：实现报工数据修正（2天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（1天）**
   - 在报工服务中添加数据修正方法：`correct_reporting_data`
   - 实现数据修改、追溯管理、权限控制
   - API端点：`PUT /api/apps/kuaizhizao/reporting/{id}/correct`

2. **前端实现（1天）**
   - 创建报工数据修正页面
   - 实现数据修改表单
   - 显示修正历史记录

**验收标准：**
- ✅ 报工数据修改正常
- ✅ 修正记录可追溯
- ✅ 权限控制正常（只有管理员可以修正）

---

##### 任务2.2.5：实现报工统计分析（2天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（1天）**
   - 创建报工统计服务方法：`get_reporting_statistics`
   - 实现效率分析、工时统计、异常分析
   - API端点：`GET /api/apps/kuaizhizao/reporting/statistics`

2. **前端实现（1天）**
   - 创建报工统计页面
   - 实现图表展示（使用ECharts或Ant Design Charts）
   - 实现数据导出

**验收标准：**
- ✅ 效率分析正常
- ✅ 工时统计准确
- ✅ 异常分析正常
- ✅ 图表展示清晰

---

##### 任务2.2.6：实现工站上下料物料绑定（3天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建物料绑定记录模型：`riveredge-backend/src/apps/kuaizhizao/models/material_binding.py`
   - 字段：报工记录ID、物料ID、绑定类型（上料/下料）、绑定时间等

2. **后端实现（1.5天）**
   - 创建物料绑定服务：`material_binding_service.py`
   - 实现上料绑定、下料绑定、扫码绑定、手动选择
   - 实现库存自动更新
   - API端点：
     - `POST /api/apps/kuaizhizao/reporting/{id}/material-binding/feeding` - 绑定上料
     - `POST /api/apps/kuaizhizao/reporting/{id}/material-binding/discharging` - 绑定下料
     - `GET /api/apps/kuaizhizao/reporting/{id}/material-binding` - 查询上下料绑定记录

3. **前端实现（1天）**
   - 创建物料绑定界面（上料绑定、下料绑定、记录查看）
   - 实现扫码绑定功能
   - 实现手动选择物料功能
   - 触屏优化（大按钮、简化操作）

**验收标准：**
- ✅ 上料绑定功能正常
- ✅ 下料绑定功能正常
- ✅ 扫码绑定正常
- ✅ 手动选择正常
- ✅ 记录管理正常
- ✅ 库存自动更新正常
- ✅ 触屏优化正常

---

#### 阶段2.3：仓储管理高级功能（2周，P1优先级）

**目标：** 实现仓储管理高级功能，包括库存盘点、库存分析、库存预警、装箱打包绑定、客户来料登记

##### 任务2.3.1：实现库存盘点流程（3天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建盘点单模型：`riveredge-backend/src/apps/kuaizhizao/models/stocktaking.py`
   - 创建盘点明细模型：`stocktaking_item.py`
   - 字段：盘点单号、仓库ID、盘点日期、状态、盘点明细等

2. **后端实现（1.5天）**
   - 创建盘点服务：`stocktaking_service.py`
   - 实现盘点单创建、执行、差异处理
   - 实现盘点结果生成
   - API端点：
     - `POST /api/apps/kuaizhizao/inventory/stocktaking` - 创建盘点单
     - `POST /api/apps/kuaizhizao/inventory/stocktaking/{id}/execute` - 执行盘点
     - `POST /api/apps/kuaizhizao/inventory/stocktaking/{id}/adjust` - 处理差异

3. **前端实现（1天）**
   - 创建盘点单管理页面
   - 实现盘点执行界面（扫码盘点）
   - 实现差异处理界面

**验收标准：**
- ✅ 盘点单创建正常
- ✅ 盘点执行正常（扫码盘点）
- ✅ 差异处理正常
- ✅ 盘点结果准确

---

##### 任务2.3.2：实现库存分析功能（2天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（1天）**
   - 创建库存分析服务方法：`get_inventory_analysis`
   - 实现库存周转率计算
   - 实现ABC分析
   - 实现呆滞料分析
   - API端点：`GET /api/apps/kuaizhizao/inventory/analysis`

2. **前端实现（1天）**
   - 创建库存分析页面
   - 实现图表展示（周转率、ABC分析、呆滞料）
   - 实现数据导出

**验收标准：**
- ✅ 库存周转率计算准确
- ✅ ABC分析正常
- ✅ 呆滞料分析正常
- ✅ 图表展示清晰

---

##### 任务2.3.3：实现库存预警功能（2天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建库存预警规则模型
   - 创建预警记录模型

2. **后端实现（1天）**
   - 创建预警服务：`inventory_alert_service.py`
   - 实现低库存预警、高库存预警、过期预警
   - 实现预警规则配置
   - API端点：`GET /api/apps/kuaizhizao/inventory/alerts`

3. **前端实现（0.5天）**
   - 创建预警列表页面
   - 实现预警规则配置界面
   - 实现处理记录

**验收标准：**
- ✅ 低库存预警正常
- ✅ 高库存预警正常
- ✅ 过期预警正常
- ✅ 预警规则配置正常

---

##### 任务2.3.4：实现装箱打包绑定功能（3天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建装箱绑定记录模型：`packing_binding.py`
   - 字段：成品入库单ID、产品序列号、包装物料ID、装箱数量等

2. **后端实现（1.5天）**
   - 创建装箱绑定服务：`packing_binding_service.py`
   - 实现装箱绑定、产品序列号绑定、包装物料绑定
   - 实现扫码绑定、手动绑定
   - API端点：
     - `POST /api/apps/kuaizhizao/finished-goods-receipts/{id}/packing-binding` - 绑定装箱
     - `GET /api/apps/kuaizhizao/finished-goods-receipts/{id}/packing-binding` - 查询装箱绑定记录

3. **前端实现（1天）**
   - 创建装箱绑定界面
   - 实现扫码绑定功能
   - 实现记录查看
   - 触屏优化

**验收标准：**
- ✅ 装箱绑定正常
- ✅ 产品序列号绑定正常
- ✅ 包装物料绑定正常
- ✅ 扫码绑定正常
- ✅ 记录管理正常

---

##### 任务2.3.5：实现客户来料登记功能（3天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建客户来料登记模型：`customer_material_registration.py`
   - 创建条码映射规则模型：`barcode_mapping_rule.py`

2. **后端实现（1.5天）**
   - 创建客户来料登记服务：`customer_material_registration_service.py`
   - 实现一维码/二维码扫码识别
   - 实现条码解析、条码映射
   - 实现映射规则配置
   - API端点：
     - `POST /api/apps/kuaizhizao/inventory/customer-material-registration` - 客户来料登记
     - `POST /api/apps/kuaizhizao/inventory/customer-material-registration/parse-barcode` - 解析客户来料条码
     - `POST /api/apps/kuaizhizao/inventory/customer-material-registration/mapping-rules` - 创建条码映射规则
     - `GET /api/apps/kuaizhizao/inventory/customer-material-registration` - 查询客户来料登记记录

3. **前端实现（1天）**
   - 创建客户来料登记界面
   - 实现扫码登记功能
   - 实现条码映射配置界面
   - 实现登记记录查询

**验收标准：**
- ✅ 一维码/二维码扫码识别正常
- ✅ 条码解析正常
- ✅ 条码映射正常
- ✅ 映射规则配置正常
- ✅ 登记记录管理正常

---

#### 阶段2.4：单据执行效率优化（1周，P1优先级）

**目标：** 实现单据执行效率优化，包括单据节点耗时统计、单据执行效率分析

##### 任务2.4.1：实现单据节点耗时统计（2天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建单据节点记录模型（或使用审计日志）
   - 记录节点开始/结束时间

2. **后端实现（1天）**
   - 在单据服务中添加节点时间记录
   - 实现耗时计算逻辑
   - API端点：`GET /api/apps/kuaizhizao/documents/{id}/timing`

3. **前端实现（0.5天）**
   - 创建单据耗时统计界面
   - 实现节点耗时展示

**验收标准：**
- ✅ 节点时间记录准确
- ✅ 耗时计算准确
- ✅ 耗时展示清晰

---

##### 任务2.4.2：实现单据执行效率分析（2天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（1天）**
   - 创建效率分析服务方法：`get_document_efficiency`
   - 实现平均耗时计算
   - 实现瓶颈分析
   - 实现优化建议
   - API端点：`GET /api/apps/kuaizhizao/documents/efficiency`

2. **前端实现（1天）**
   - 创建效率分析界面
   - 实现图表展示
   - 实现优化建议展示

**验收标准：**
- ✅ 平均耗时计算准确
- ✅ 瓶颈分析正常
- ✅ 优化建议实用

---

##### 任务2.4.3：实现工作时间段配置（1天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 在仓库模型中添加工作时间段字段，或创建单独的工作时间段配置表

2. **后端实现（0.25天）**
   - 实现工作时间段配置保存
   - API端点：`POST /api/core/warehouses/{id}/working-hours`

3. **前端实现（0.25天）**
   - 创建工作时间段配置界面
   - 实现时间段设置、规则配置

**验收标准：**
- ✅ 工作时间段设置正常
- ✅ 非工作时间排除正常

---

### 第三阶段：异常处理与用户体验（优先级：P0/P1/P2）

#### 阶段3.1：异常处理机制（2周，P0优先级）

**目标：** 实现异常处理机制，包括缺料异常、交期延期异常、质量异常处理

##### 任务3.1.1：实现缺料异常处理（3天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建缺料异常记录模型：`material_shortage_exception.py`
   - 字段：工单ID、物料ID、缺料数量、预警级别、处理状态等

2. **后端实现（1.5天）**
   - 创建异常服务：`exception_service.py`
   - 实现缺料预警（基于工单缺料检测）
   - 实现替代物料推荐
   - 实现紧急采购建议
   - API端点：
     - `GET /api/apps/kuaizhizao/exceptions/material-shortage` - 缺料异常列表
     - `POST /api/apps/kuaizhizao/exceptions/material-shortage/{id}/handle` - 处理缺料异常

3. **前端实现（1天）**
   - 创建缺料异常处理界面
   - 实现预警列表展示
   - 实现替代物料推荐展示
   - 实现紧急采购操作

**验收标准：**
- ✅ 缺料预警正常
- ✅ 替代物料推荐准确
- ✅ 紧急采购建议实用

---

##### 任务3.1.2：实现交期延期异常处理（2天）

**当前状态：** work_order_service中有check_delayed_work_orders方法，但异常处理机制未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建延期异常记录模型：`delivery_delay_exception.py`

2. **后端实现（1天）**
   - 集成现有的延期检测方法
   - 实现延期预警
   - 实现计划调整建议
   - API端点：
     - `GET /api/apps/kuaizhizao/exceptions/delivery-delay` - 交期延期异常列表
     - `POST /api/apps/kuaizhizao/exceptions/delivery-delay/{id}/handle` - 处理延期异常

3. **前端实现（0.5天）**
   - 创建延期异常处理界面
   - 实现延期预警展示
   - 实现计划调整操作

**验收标准：**
- ✅ 延期预警正常
- ✅ 计划调整建议实用

---

##### 任务3.1.3：实现质量异常处理（2天）

**当前状态：** 未实现

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建质量异常记录模型：`quality_exception.py`

2. **后端实现（1天）**
   - 实现质量问题追溯
   - 实现纠正预防措施记录
   - 实现质量改进跟踪
   - API端点：
     - `GET /api/apps/kuaizhizao/exceptions/quality` - 质量异常列表
     - `POST /api/apps/kuaizhizao/exceptions/quality/{id}/handle` - 处理质量异常

3. **前端实现（0.5天）**
   - 创建质量异常处理界面
   - 实现问题追溯展示
   - 实现纠正预防措施记录

**验收标准：**
- ✅ 问题追溯正常
- ✅ 纠正预防措施记录完整
- ✅ 质量改进跟踪正常

---

##### 任务3.1.4：实现异常处理工作流（1天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（0.5天）**
   - 实现异常创建、处理、关闭流程
   - 实现异常统计分析
   - API端点：`GET /api/apps/kuaizhizao/exceptions/statistics`

2. **前端实现（0.5天）**
   - 实现异常工作流界面
   - 实现异常统计分析展示

**验收标准：**
- ✅ 异常工作流正常（创建→处理→关闭）
- ✅ 异常统计分析正常

---

#### 阶段3.2：报表分析功能（3-4周，P1优先级）

**目标：** 实现报表分析功能，包括库存报表、生产报表、质量报表，以及自研报表设计器（基于@dnd-kit + @ant-design/charts）

**技术方案：** 采用自研方案，基于项目已有的@dnd-kit拖拽库和@ant-design/charts图表库，开发轻量级报表设计器，后端使用openpyxl（Excel生成，MIT许可证）和WeasyPrint（PDF生成，BSD许可证）

##### 任务3.2.1：实现库存报表（2天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（1天）**
   - 创建库存报表服务：`report_service.py`
   - 实现库存状况分析
   - 实现库存周转率报表
   - 实现ABC分析报表
   - 实现呆滞料分析报表
   - API端点：`GET /api/apps/kuaizhizao/reports/inventory`

2. **前端实现（1天）**
   - 创建库存报表页面
   - 实现图表展示
   - 实现数据筛选
   - 实现数据导出

**验收标准：**
- ✅ 库存状况分析正常
- ✅ 库存周转率报表准确
- ✅ ABC分析报表正常
- ✅ 呆滞料分析报表正常

---

##### 任务3.2.2：实现生产报表（2天）

**当前状态：** 有报表页面框架，需要完善

**实施步骤：**

1. **后端实现（1天）**
   - 实现生产效率分析
   - 实现工单完成情况报表
   - 实现报工统计分析报表
   - 实现设备利用率报表
   - API端点：`GET /api/apps/kuaizhizao/reports/production`

2. **前端实现（1天）**
   - 完善生产报表页面
   - 实现图表展示
   - 实现数据筛选
   - 实现数据导出

**验收标准：**
- ✅ 生产效率分析正常
- ✅ 工单完成情况报表准确
- ✅ 报工统计分析报表正常
- ✅ 设备利用率报表正常

---

##### 任务3.2.3：实现质量报表（2天）

**当前状态：** 未实现

**实施步骤：**

1. **后端实现（1天）**
   - 实现质量分析报告
   - 实现不良品统计报表
   - 实现检验合格率报表
   - 实现质量趋势分析报表
   - API端点：`GET /api/apps/kuaizhizao/reports/quality`

2. **前端实现（1天）**
   - 创建质量报表页面
   - 实现图表展示
   - 实现数据筛选
   - 实现数据导出

**验收标准：**
- ✅ 质量分析报告正常
- ✅ 不良品统计报表准确
- ✅ 检验合格率报表正常
- ✅ 质量趋势分析报表正常

---

##### 任务3.2.4：实现自研报表设计器（2-3周）

**当前状态：** 未实现

**功能描述：** 基于@dnd-kit + @ant-design/charts开发拖拽式报表设计器，支持自定义报表模板创建

**实施步骤：**

1. **数据模型和基础架构（3-4天）**
   - 创建报表模板模型：`riveredge-backend/src/core/models/report_template.py`
     - 字段：名称、编码、类型、配置（JSONB字段存储JSON Schema）、状态、分类、权限等
     - 关联：租户ID、创建人ID等
   - 创建报表Schema定义：`riveredge-backend/src/core/schemas/report.py`
     - 定义报表配置JSON Schema结构
     - 定义报表组件类型（表格、图表、文本、图片、分组等）
     - 定义数据源配置结构
   - 创建报表服务基础框架：`riveredge-backend/src/core/services/report_service.py`
     - 实现报表模板CRUD基础方法
     - 实现报表配置验证方法

2. **报表设计器前端开发（4-5天）**
   - 创建报表设计器组件：`riveredge-frontend/src/components/report-designer/index.tsx`
     - 使用@dnd-kit实现拖拽布局（参考kanban-board组件实现）
     - 使用Ant Design实现UI组件
     - 实现画布区域、组件库区域、属性配置面板、预览区域
   - 实现组件库：`riveredge-frontend/src/components/report-designer/components/`
     - 表格组件（基于Ant Design Table）
     - 图表组件（基于@ant-design/charts，支持柱状图、折线图、饼图等）
     - 文本组件（标题、段落、标签等）
     - 图片组件（支持图片上传和显示）
     - 分组组件（支持报表分区布局）
   - 实现属性配置面板：`riveredge-frontend/src/components/report-designer/property-panel.tsx`
     - 组件属性编辑（数据源、样式、格式等）
     - 数据源绑定配置（API接口选择、SQL查询配置等）
     - 样式配置（颜色、字体、对齐方式等）
   - 实现预览功能：`riveredge-frontend/src/components/report-designer/preview.tsx`
     - 实时预览报表效果（所见即所得）
     - 支持预览数据刷新

3. **报表生成引擎后端开发（4-5天）**
   - 安装依赖：
     ```bash
     pip install openpyxl weasyprint
     ```
   - 实现Excel生成引擎：`riveredge-backend/src/core/services/report_engines/excel_engine.py`
     - 使用openpyxl生成Excel文件（MIT许可证）
     - 支持表格、图表、样式等
     - 支持中文字体
   - 实现PDF生成引擎：`riveredge-backend/src/core/services/report_engines/pdf_engine.py`
     - 使用WeasyPrint生成PDF文件（BSD许可证）
     - 支持HTML转PDF、中文字体等
     - 处理中文字体问题（配置中文字体路径）
   - 实现报表渲染服务：`riveredge-backend/src/core/services/report_service.py`
     - 解析报表配置JSON
     - 查询数据源（API调用、数据库查询等）
     - 渲染报表组件（表格渲染、图表渲染等）
     - 生成输出文件（Excel、PDF）

4. **报表模板管理（2-3天）**
   - 创建报表模板管理API：`riveredge-backend/src/core/api/reports/`
     - CRUD操作（创建、查询、更新、删除）
     - 模板导入/导出
     - 模板权限控制（系统模板、部门模板、个人模板）
     - API端点：
       - `GET /api/core/reports/templates` - 报表模板列表
       - `GET /api/core/reports/templates/{id}` - 报表模板详情
       - `POST /api/core/reports/templates` - 创建报表模板
       - `PUT /api/core/reports/templates/{id}` - 更新报表模板
       - `DELETE /api/core/reports/templates/{id}` - 删除报表模板
       - `POST /api/core/reports/templates/{id}/export` - 导出报表模板
       - `POST /api/core/reports/templates/import` - 导入报表模板
   - 创建报表模板管理前端页面：`riveredge-frontend/src/pages/system/report-templates/`
     - 模板列表页面（使用UniTable组件）
     - 模板编辑页面（使用报表设计器组件）
     - 模板预览页面
     - 模板导入/导出功能

5. **系统自带报表模板创建（2-3天）**
   - 使用报表设计器创建库存报表模板
   - 使用报表设计器创建生产报表模板
   - 使用报表设计器创建质量报表模板
   - 集成到现有报表页面（替换原有的硬编码报表）

6. **测试和优化（2天）**
   - 功能测试（设计器功能、生成引擎、模板管理）
   - 性能优化（大报表生成优化、异步处理）
   - 用户体验优化（拖拽流畅度、预览性能等）

**验收标准：**
- ✅ 拖拽式设计器可用（基于@dnd-kit，拖拽流畅）
- ✅ 组件库完整（表格、图表、文本、图片、分组等）
- ✅ 实时预览正常（所见即所得）
- ✅ 数据源绑定正常（API、数据库查询、现有报表数据）
- ✅ Excel导出正常（支持复杂格式、图表、中文字体）
- ✅ PDF导出正常（支持中文字体、样式完整）
- ✅ 报表模板管理正常（增删改查、导入导出）
- ✅ 报表权限控制正常（系统/部门/个人模板）
- ✅ 系统自带报表模板正常（库存、生产、质量报表）

**技术要点：**
- 使用@dnd-kit实现拖拽（已在项目中使用，参考kanban-board组件）
- 使用@ant-design/charts实现图表（已有，2.1.0版本）
- 使用openpyxl生成Excel（MIT许可证，完全商业友好）
- 使用WeasyPrint生成PDF（BSD许可证，完全商业友好）
- 报表配置使用JSON Schema格式，便于扩展和验证
- 后端PDF生成需要处理中文字体问题（WeasyPrint支持，需配置字体路径）
- 大报表生成使用异步处理（通过Inngest工作流）

---

##### 任务3.2.5：实现报表导出功能（已包含在任务3.2.4中）

**说明：** 报表导出功能已整合到自研报表设计器中，作为报表生成引擎的一部分实现。具体包括：

- Excel导出（使用openpyxl，支持复杂格式、图表、中文字体）
- PDF导出（使用WeasyPrint，支持中文字体、HTML转PDF）

**API端点：**
- `POST /api/core/reports/templates/{id}/generate` - 生成报表（支持格式参数：excel/pdf）
- `GET /api/core/reports/templates/{id}/export` - 导出报表文件

**前端集成：**
- 在报表列表和报表详情页面添加导出按钮
- 支持导出格式选择（Excel/PDF）
- 支持导出参数配置（时间范围、筛选条件等）

---

#### 阶段3.3：工位机触屏模式（1周，P2优先级）

**目标：** 实现工位机触屏模式，支持现场报工、SOP查看、图纸查看、加工程序查看

**说明：** 此功能为增强功能，优先级较低，可以延后实现。如需实现，参考以下步骤：

1. **模式识别和界面适配（1天）**
   - 检测设备类型（触屏设备）
   - 切换触屏模式
   - API端点：
     - `GET /api/apps/kuaizhizao/workstation/mode` - 获取工位机模式
     - `POST /api/apps/kuaizhizao/workstation/mode` - 切换工位机模式

2. **现场报工触屏优化（1天）**
   - 大按钮设计
   - 简化操作流程
   - 扫码报工优化

3. **SOP查看功能（1天）**
   - SOP展示
   - 步骤导航
   - API端点：`GET /api/apps/kuaizhizao/work-orders/{id}/sop`

4. **图纸查看功能（1天）**
   - 图纸展示
   - 缩放功能
   - API端点：`GET /api/apps/kuaizhizao/work-orders/{id}/drawings`

5. **加工程序查看功能（1天）**
   - 程序展示
   - 参数显示
   - 下载功能
   - API端点：`GET /api/apps/kuaizhizao/work-orders/{id}/programs`

---

#### 阶段3.4：工作台快捷操作完善（1周，P0优先级）

**当前状态：** 基础框架已实现，需要完善

**目标：** 完善工作台快捷操作，包括待办事项、统计卡片、快捷操作

##### 任务3.4.1：完善待办事项功能（2天）

**实施步骤：**

1. **后端实现（1天）**
   - 实现待办事项数据源（待处理工单、待审核单据、异常提醒）
   - API端点：`GET /api/apps/kuaizhizao/dashboard/todos`

2. **前端实现（1天）**
   - 完善待办事项列表
   - 实现快速处理功能
   - API端点：`POST /api/apps/kuaizhizao/dashboard/todos/{id}/handle`

**验收标准：**
- ✅ 待办事项数据准确
- ✅ 快速处理功能正常

---

##### 任务3.4.2：完善统计卡片功能（2天）

**实施步骤：**

1. **后端实现（1天）**
   - 实现统计数据计算（生产统计、库存统计、质量统计）
   - API端点：`GET /api/apps/kuaizhizao/dashboard/statistics`

2. **前端实现（1天）**
   - 完善统计卡片展示
   - 实现数据可视化
   - 实现图表展示

**验收标准：**
- ✅ 统计数据准确
- ✅ 图表展示清晰

---

##### 任务3.4.3：完善工作台首页（1天）

**实施步骤：**

1. **后端实现（0.5天）**
   - 整合工作台数据
   - API端点：`GET /api/apps/kuaizhizao/dashboard`

2. **前端实现（0.5天）**
   - 完善Dashboard布局
   - 优化卡片展示

**验收标准：**
- ✅ Dashboard布局合理
- ✅ 卡片展示清晰

---

#### 阶段3.5：设备模具管理（2周，P2优先级）

**目标：** 实现设备模具管理功能，包括设备基础信息管理、维护保养计划管理、故障维修管理、模具管理

**说明：** 此功能为扩展功能，优先级较低，可以延后实现。

##### 任务3.5.1：实现设备基础信息管理（2天）

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建设备模型：`riveredge-backend/src/core/models/equipment.py`
   - 字段：设备编码、设备名称、设备类型、技术参数、供应商信息、序列号、工作中心ID等

2. **后端实现（1天）**
   - 创建设备服务：`equipment_service.py`
   - 实现设备CRUD操作
   - API端点：
     - `POST /api/core/equipment` - 创建设备
     - `GET /api/core/equipment` - 查询设备列表
     - `GET /api/core/equipment/{id}` - 查询设备详情

3. **前端实现（0.5天）**
   - 创建设备管理页面
   - 实现设备列表、创建、编辑、查询功能

**验收标准：**
- ✅ 设备信息管理正常
- ✅ 序列号管理正常
- ✅ 关联工作中心正常

---

##### 任务3.5.2：实现设备维护保养计划管理（2天）

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建维护保养计划模型：`maintenance_plan.py`

2. **后端实现（1天）**
   - 实现维护保养计划创建、自动生成、提醒预警、执行记录
   - API端点：
     - `POST /api/core/equipment/{id}/maintenance-plan` - 创建维护保养计划
     - `POST /api/core/equipment/{id}/maintenance/execute` - 执行维护保养

3. **前端实现（0.5天）**
   - 创建维护保养计划管理界面

**验收标准：**
- ✅ 维护保养计划管理正常
- ✅ 自动生成正常
- ✅ 提醒预警正常

---

##### 任务3.5.3：实现设备故障维修管理（2天）

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建设备故障记录模型：`equipment_fault.py`
   - 创建维修记录模型：`equipment_repair.py`

2. **后端实现（1天）**
   - 实现故障记录、维修流程、维修记录、故障分析
   - API端点：
     - `POST /api/core/equipment/{id}/fault` - 记录设备故障
     - `POST /api/core/equipment/{id}/repair` - 记录设备维修

3. **前端实现（0.5天）**
   - 创建设备故障维修界面

**验收标准：**
- ✅ 故障记录正常
- ✅ 维修流程正常
- ✅ 故障分析正常

---

##### 任务3.5.4：实现模具管理（1天）

**实施步骤：**

1. **数据模型设计（0.25天）**
   - 创建模具模型：`mold.py`

2. **后端实现（0.5天）**
   - 实现模具信息、模具使用、模具维护、模具追溯
   - API端点：
     - `POST /api/core/molds` - 创建模具
     - `GET /api/core/molds` - 查询模具列表

3. **前端实现（0.25天）**
   - 创建模具管理界面

**验收标准：**
- ✅ 模具管理正常
- ✅ 模具追溯正常

---

##### 任务3.5.5：实现设备使用记录追溯（1天）

**实施步骤：**

1. **后端实现（0.5天）**
   - 实现设备使用历史、维护历史、故障历史查询
   - API端点：`GET /api/core/equipment/{id}/trace`

2. **前端实现（0.5天）**
   - 创建设备追溯界面
   - 展示使用历史、维护历史、故障历史

**验收标准：**
- ✅ 设备追溯正常
- ✅ 历史记录完整

---

#### 阶段3.6：成本核算管理（2周，P2优先级）

**目标：** 实现成本核算管理功能，包括生产成本核算、委外成本核算、成本分析、成本优化建议

**说明：** 此功能为财务分析功能，优先级较低，可以延后实现。

##### 任务3.6.1：实现成本核算规则配置（2天）

**实施步骤：**

1. **数据模型设计（0.5天）**
   - 创建成本核算规则模型：`cost_rule.py`

2. **后端实现（1天）**
   - 实现材料成本、人工成本、制造费用核算规则配置
   - API端点：
     - `POST /api/apps/kuaizhizao/cost/rules` - 创建成本核算规则
     - `GET /api/apps/kuaizhizao/cost/rules` - 查询成本核算规则列表

3. **前端实现（0.5天）**
   - 创建成本核算规则配置界面

**验收标准：**
- ✅ 成本核算规则配置正常

---

##### 任务3.6.2：实现生产成本核算（2天）

**实施步骤：**

1. **后端实现（1.5天）**
   - 实现材料成本、人工成本、制造费用、总成本、单位成本核算
   - API端点：
     - `POST /api/apps/kuaizhizao/cost/work-order/{id}/calculate` - 核算工单成本
     - `POST /api/apps/kuaizhizao/cost/product/{id}/calculate` - 核算产品成本

2. **前端实现（0.5天）**
   - 创建生产成本核算界面

**验收标准：**
- ✅ 生产成本核算正常
- ✅ 成本计算准确

---

##### 任务3.6.3：实现标准成本和实际成本对比（1天）

**实施步骤：**

1. **后端实现（0.5天）**
   - 实现成本差异计算、差异原因分析
   - API端点：`GET /api/apps/kuaizhizao/cost/product/{id}/compare`

2. **前端实现（0.5天）**
   - 创建成本对比界面

**验收标准：**
- ✅ 成本对比正常
- ✅ 差异分析准确

---

##### 任务3.6.4：实现成本分析（1天）

**实施步骤：**

1. **后端实现（0.5天）**
   - 实现成本构成分析、成本趋势分析、成本优化建议
   - API端点：
     - `GET /api/apps/kuaizhizao/cost/product/{id}/analysis` - 成本分析
     - `GET /api/apps/kuaizhizao/cost/product/{id}/optimization` - 成本优化建议

2. **前端实现（0.5天）**
   - 创建成本分析界面

**验收标准：**
- ✅ 成本分析正常
- ✅ 优化建议实用

---

#### 阶段3.7：AI智能建议功能（1周，P2优先级）

**目标：** 实现AI智能建议功能，为各业务场景提供智能建议和优化方案

**说明：** 此功能较为复杂，建议在基础功能完成后实现。可以先实现简单的规则引擎，后续再升级为AI引擎。

**实施步骤：**

1. **设计建议引擎架构（1天）**
   - 设计统一建议引擎接口
   - 设计建议生成规则
   - 设计建议展示机制

2. **实现各业务场景建议（4天）**
   - 系统初始化建议
   - 基础数据配置建议
   - MRP/LRP运算建议
   - 工单下达建议
   - 生产领料建议
   - 报工建议
   - 生产看板建议
   - 报表分析建议
   - 异常处理建议

3. **前端实现（1天）**
   - 实现AI建议展示界面（侧边栏、悬浮窗、弹窗等形式）
   - API端点：`GET /api/core/ai/suggestions/{scene}`

**验收标准：**
- ✅ AI建议引擎正常
- ✅ 各业务场景建议正常
- ✅ 建议展示不打断用户操作流程

---

### 第四阶段：多角色场景与交付（2周，P2优先级）

#### 阶段4.1：多角色使用场景实现（1周）

**目标：** 实现各角色的完整使用场景，包括销售、采购、仓库、技术、计划、班组、生产、质量、设备、财务、管理者等角色

**说明：** 此阶段主要是场景梳理和文档整理，大部分功能已经在前面阶段实现。

**实施步骤：**

1. **场景梳理（2天）**
   - 梳理各角色的使用场景
   - 梳理各角色的功能需求
   - 整理场景文档

2. **角色工作台定制（3天）**
   - 为各角色定制工作台
   - 实现角色权限控制
   - API端点：
     - `GET /api/core/roles/{id}/scenarios` - 获取角色使用场景
     - `GET /api/core/roles/{id}/dashboard` - 获取角色工作台
     - `GET /api/core/roles/{id}/permissions` - 获取角色权限

**验收标准：**
- ✅ 各角色使用场景完整
- ✅ 角色工作台正常
- ✅ 角色权限控制正常

---

#### 阶段4.2：自助式上线向导（1周）

**目标：** 实现自助式上线向导，为各角色提供上线准备和日常使用指导

**说明：** 上线向导主要是文档和引导，可以与帮助系统整合。

**实施步骤：**

1. **角色上线准备向导（2天）**
   - 为各角色创建上线准备清单
   - 实现数据准备、权限配置、操作培训向导
   - API端点：`GET /api/core/onboarding/roles/{id}/guide`

2. **角色使用场景向导（2天）**
   - 为各角色创建使用场景引导
   - 实现操作流程、常见问题、最佳实践展示
   - API端点：`GET /api/core/onboarding/roles/{id}/scenarios`

3. **快速入门教程（1天）**
   - 创建新手引导功能
   - 实现功能演示

**验收标准：**
- ✅ 角色上线向导可用
- ✅ 角色使用场景向导可用
- ✅ 快速入门教程可用

---

## 📝 实施总结

### 开发时间估算

**总开发时间：** 约22-23周（根据优先级可调整）

**按优先级分配：**
- **P0优先级（关键核心功能）：** 约8周
  - 阶段1.1：系统初始化与快速配置（2周）
  - 阶段2.1：工单管理高级功能（2周）
  - 阶段3.1：异常处理机制（2周）
  - 阶段3.4：工作台快捷操作完善（1周）
  - 其他优化（1周）

- **P1优先级（重要功能）：** 约9-10周
  - 阶段1.2：基础数据配置优化（2周）
  - 阶段2.2：生产执行高级功能（2周）
  - 阶段2.3：仓储管理高级功能（2周）
  - 阶段2.4：单据执行效率优化（1周）
  - 阶段3.2：报表分析功能（3-4周，包含自研报表设计器）

- **P2优先级（增强功能）：** 约5周
  - 阶段3.3：工位机触屏模式（1周，可选）
  - 阶段3.5：设备模具管理（2周，可选）
  - 阶段3.6：成本核算管理（2周，可选）
  - 阶段3.7：AI智能建议功能（1周，可选）
  - 阶段4.1：多角色使用场景（1周）
  - 阶段4.2：自助式上线向导（1周）

### 实施建议

1. **分阶段实施**
   - 优先完成P0优先级功能，确保核心功能可用
   - 然后实施P1优先级功能，提升系统完整性
   - 最后实施P2优先级功能，作为增强特性

2. **迭代开发**
   - 每个阶段完成后进行测试和验收
   - 及时收集用户反馈
   - 根据反馈调整开发计划

3. **风险控制**
   - 复杂功能提前进行技术验证
   - 关键功能预留充足时间
   - 建立代码审查机制

4. **质量保证**
   - 遵循项目编码规范
   - 关键功能编写测试用例
   - 代码审查和测试覆盖

### 关键里程碑

1. **里程碑1：P0核心功能完成（第8周末）**
   - 系统初始化功能完成
   - 工单管理高级功能完成
   - 异常处理机制完成
   - 工作台功能完善

2. **里程碑2：P1重要功能完成（第17-18周末）**
   - 基础数据配置优化完成
   - 生产执行高级功能完成
   - 仓储管理高级功能完成
   - 报表分析功能完成（包含自研报表设计器）

3. **里程碑3：全部功能完成（第22-23周末）**
   - 所有功能开发完成
   - 多角色场景完成
   - 上线向导完成

---

**文档创建日期：** 2025-01-15  
**最后更新日期：** 2025-01-15  
**文档版本：** 1.0
  