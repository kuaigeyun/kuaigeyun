# 详细开发计划 - 第四阶段：系统配置与基础数据优化

> **文档说明：**  
> 本文档详细列出第四阶段的每个功能点，支持功能点完成一个测试一个标记一个。  
> 每个功能点包含：任务描述、测试用例、验收标准、完成状态。  
> 
> **创建时间：** 2025-12-27  
> **文档版本：** v1.1  
> **最后更新：** 2026-01-16（新增物料来源控制功能）

---

## ⚠️ 开发前必读：前后端统一模板规范

> **🚨 重要提示：** 在开始开发前，请务必阅读并遵循《10-前后端统一模板规范.md》中的规范要求，确保代码符合技术栈原生设定。
> **⚠️ 违反规范将导致代码审查不通过，需要返工重写！**

### 📋 前端开发规范（必须遵守）

**所有列表页面必须使用：**
- ✅ `ListPageTemplate` 布局组件（禁止使用其他布局）
- ✅ `UniTable` 表格组件（禁止直接使用ProTable）
- ✅ `ProForm` 表单组件（禁止直接使用Form）
- ✅ `ProDescriptions` 详情组件（禁止直接使用Descriptions）
- ✅ `Modal` 用于新建/编辑，`Drawer` 用于详情查看

**标准页面结构（必须遵循）：**
```typescript
<ListPageTemplate>
  <UniTable
    columns={columns}
    request={handleRequest}
    showAdvancedSearch={true}
    showCreateButton={true}
    onCreate={handleCreate}
    showEditButton={true}
    onEdit={handleEdit}
    showDeleteButton={true}
    onDelete={handleDelete}
    onDetail={handleDetail}
  />
</ListPageTemplate>
<Modal> {/* 新建/编辑 */} </Modal>
<Drawer> {/* 详情 */} </Drawer>
```

**禁止事项：**
- ❌ 禁止直接使用 `ProTable`（必须使用 `UniTable`）
- ❌ 禁止直接使用 `Form`（必须使用 `ProForm`）
- ❌ 禁止直接使用 `Descriptions`（必须使用 `ProDescriptions`）
- ❌ 禁止在列表页面中混用其他布局组件

### 📋 后端开发规范（必须遵守）

**所有API路由必须使用：**
- ✅ `APIRouter` 组织路由（禁止使用其他路由方式）
- ✅ `Depends(get_current_user, get_current_tenant)` 依赖注入（必须使用）
- ✅ 统一异常处理（`ValidationError`, `NotFoundError`，禁止直接使用HTTPException）
- ✅ `response_model` 定义响应模型（必须使用）
- ✅ 服务层封装业务逻辑（禁止在API层写业务逻辑）

**标准API结构（必须遵循）：**
```python
router = APIRouter(prefix="/xxx", tags=["XXX"])

@router.post("", response_model=ModelResponse, summary="创建")
async def create_xxx(
    data: ModelCreate,
    current_user: Annotated[User, Depends(get_current_user)],
    tenant_id: Annotated[int, Depends(get_current_tenant)]
):
    try:
        return await Service.create_xxx(tenant_id, data, current_user.id)
    except ValidationError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

**禁止事项：**
- ❌ 禁止在API层写业务逻辑（必须在服务层实现）
- ❌ 禁止直接使用 `HTTPException`（必须使用统一异常类）
- ❌ 禁止不使用依赖注入（必须使用 `get_current_user` 和 `get_current_tenant`）
- ❌ 禁止不使用 `response_model`（必须定义响应模型）

**📖 详细规范请参考：** `10-前后端统一模板规范.md`

---

---

## 📋 目录

1. [步骤4.1：系统初始化向导](#步骤31系统初始化向导)
2. [步骤4.2：业务配置功能](#步骤32业务配置功能)
3. [步骤4.3：基础数据配置优化](#步骤33基础数据配置优化)

---

## 步骤4.1：系统初始化向导

**目标：** 实现快速初始化向导，引导新用户完成基础配置

**时间估算：** 1-2周

**前置条件：**
- ✅ 系统注册功能已实现

---

### 功能点4.1.1：初始化向导页面设计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
设计初始化向导页面，支持多步骤配置。

**测试用例：**
- 测试向导步骤切换
- 测试表单验证

**验收标准：**
- ✅ 向导页面可以正常渲染
- ✅ 可以切换步骤
- ✅ 表单验证正常

**完成标记：**
- [ ] 页面代码已编写
- [ ] 单元测试已编写并通过
- [ ] 页面测试已通过

---

### 功能点4.1.2：行业模板功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现行业模板功能，支持一键应用模板配置。

**测试用例：**
- 测试模板列表查询
- 测试模板应用

**验收标准：**
- ✅ 可以查询行业模板列表
- ✅ 可以选择并应用模板
- ✅ 模板配置正确应用

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.1.3：智能默认值配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现智能默认值配置，所有配置项都有合理的默认值。

**测试用例：**
- 测试默认值加载
- 测试默认值应用

**验收标准：**
- ✅ 所有配置项都有默认值
- ✅ 默认值合理且符合中国用户习惯
- ✅ 用户可以修改默认值

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.1.4：编码规则配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现编码规则配置功能。

**测试用例：**
- 测试编码规则配置
- 测试编码规则验证

**验收标准：**
- ✅ 可以配置各种单据的编码规则
- ✅ 编码规则格式验证正常
- ✅ 编码规则可以保存

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.1.5：AI智能建议功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现AI智能建议功能，通过Inngest AI工作流提供配置建议。

**测试用例：**
- 测试AI建议生成
- 测试AI建议展示

**验收标准：**
- ✅ AI建议可以正常生成
- ✅ AI建议在侧边栏显示，不打断操作流程
- ✅ AI建议内容准确有用

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.1.6：内置帮助系统

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现内置帮助系统，包括操作提示、帮助文档、操作视频。

**测试用例：**
- 测试帮助系统打开
- 测试帮助内容显示

**验收标准：**
- ✅ 帮助系统可以正常打开
- ✅ 操作提示、帮助文档、操作视频可以正常显示
- ✅ 帮助内容准确有用

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 步骤4.2：业务配置功能

**目标：** 实现业务配置功能，支持极简模式和全流程模式切换

**时间估算：** 2周

**前置条件：**
- ✅ 步骤4.1已完成

---

### 功能点4.2.1：运行模式切换功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现运行模式切换功能（极简模式/全流程模式）。

**测试用例：**
- 测试运行模式切换
- 测试菜单和权限更新

**验收标准：**
- ✅ 可以一键切换运行模式
- ✅ 切换模式时自动应用对应配置
- ✅ 菜单和权限自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.2.2：流程模块开关配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现流程模块开关配置，支持独立开启/关闭每个模块。

**测试用例：**
- 测试模块开关切换
- 测试核心模块保护

**验收标准：**
- ✅ 可以独立开启/关闭流程模块
- ✅ 核心模块不可关闭
- ✅ 关闭的模块自动隐藏菜单

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.2.3：流程参数配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现流程参数配置功能。

**测试用例：**
- 测试参数配置保存
- 测试参数配置应用

**验收标准：**
- ✅ 可以配置流程参数
- ✅ 参数配置可以保存
- ✅ 参数配置实时生效

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.2.4：PRO版功能标识

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现PRO版功能标识，明确标识PRO版功能。

**测试用例：**
- 测试PRO版功能标识显示
- 测试升级提示

**验收标准：**
- ✅ PRO版功能明确标识
- ✅ 点击PRO版功能显示升级提示
- ✅ PRO版功能默认关闭

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.2.5：配置模板管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现配置模板管理，支持保存、导入、导出配置模板。

**测试用例：**
- 测试保存配置模板
- 测试导入配置模板
- 测试导出配置模板

**验收标准：**
- ✅ 可以保存配置模板
- ✅ 可以导入配置模板
- ✅ 可以导出配置模板
- ✅ 模板应用正常

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 步骤4.3：基础数据配置优化

**目标：** 优化基础数据配置，支持批量导入和智能配置，**物料来源控制功能**（核心功能新增）

**时间估算：** 2-3周（新增物料来源控制功能）

**前置条件：**
- ✅ 步骤4.1和4.2已完成
- ✅ 物料主数据基础功能已实现

---

### 功能点4.3.1：组织架构批量导入优化

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
优化组织架构配置，支持UniSheet在线表格批量导入。

**测试用例：**
- 测试批量导入组织架构
- 测试数据验证

**验收标准：**
- ✅ 可以使用UniSheet批量导入组织架构
- ✅ 导入数据自动验证
- ✅ 导入成功后自动刷新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.3.2：物料编码映射工具

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现物料编码映射工具，解决编码不统一问题。

**测试用例：**
- 测试重复物料检测
- 测试编码映射创建
- 测试编码搜索

**验收标准：**
- ✅ 可以检测重复物料（高/中/低置信度）
- ✅ 可以建立编码映射关系
- ✅ 支持使用任意部门编码搜索物料

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.3.3：多单位管理功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现多单位管理功能，支持主单位和辅助单位。

**测试用例：**
- 测试单位配置
- 测试单位换算

**验收标准：**
- ✅ 可以配置物料的多单位
- ✅ 单位换算准确
- ✅ 不同环节可以使用不同单位

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.3.4：批号和序列号管理功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现批号和序列号管理功能。

**测试用例：**
- 测试批号生成
- 测试序列号生成
- 测试批号追溯
- 测试序列号追溯

**验收标准：**
- ✅ 可以配置批号规则
- ✅ 可以配置序列号规则
- ✅ 批号和序列号自动生成
- ✅ 支持批号和序列号追溯

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.3.8：物料来源控制功能（核心功能，新增）

**状态：** ⬜ 未开始

**任务描述：**
实现物料来源控制功能，支持物料来源类型配置、相关配置、验证规则、变更控制、智能建议等。

**技术实现：**
- **后端**：
  - 在Material模型中添加物料来源类型字段（source_type）
  - 实现物料来源类型配置（自制件、采购件、虚拟件、委外件、配置件）
  - 实现物料来源相关配置（BOM、工艺路线、供应商、委外供应商、委外工序等）
  - 实现物料来源验证规则（自制件必须有BOM和工艺路线，采购件建议配置默认供应商等）
  - 实现物料来源变更控制（变更需要审批，系统自动处理变更影响）
  - 实现物料来源智能建议（基于物料类型和历史数据建议物料来源类型）
- **前端**：
  - 在物料主数据配置页面添加物料来源类型配置界面
  - 根据物料来源类型动态显示相关配置项
  - 显示物料来源验证结果（通过/警告/错误）
  - 实现物料来源变更审批流程界面

**测试用例：**

1. **测试物料来源类型配置**
   - 测试配置自制件（需要BOM和工艺路线）
   - 测试配置采购件（建议配置默认供应商和采购价格）
   - 测试配置虚拟件（需要完整的BOM结构）
   - 测试配置委外件（需要委外供应商和委外工序）
   - 测试配置配置件（需要变体属性和BOM变体）

2. **测试物料来源相关配置**
   - 测试自制件配置BOM和工艺路线
   - 测试采购件配置默认供应商和采购价格
   - 测试委外件配置委外供应商和委外工序
   - 测试配置件配置变体属性和BOM变体

3. **测试物料来源验证规则**
   - 测试自制件缺少BOM或工艺路线时的错误提示
   - 测试采购件缺少默认供应商时的警告提示
   - 测试虚拟件缺少BOM时的错误提示
   - 测试委外件缺少委外供应商或委外工序时的错误提示
   - 测试配置件缺少变体属性或BOM变体时的错误提示

4. **测试物料来源变更控制**
   - 测试物料来源类型变更申请
   - 测试变更前验证（检查在制工单、未完成采购订单等）
   - 测试变更审批流程
   - 测试变更后自动处理变更影响（删除或标记相关配置）

5. **测试物料来源智能建议**
   - 测试基于物料类型的建议（成品建议自制件，原材料建议采购件）
   - 测试基于BOM结构的建议（有BOM的物料建议设为自制件）
   - 测试基于历史数据的建议（长期外购的半成品建议改为采购件）
   - 测试配置完整性检测（检测是否缺少关键配置）

**验收标准：**
- ✅ **物料来源类型配置正常**（自制件、采购件、虚拟件、委外件、配置件）
- ✅ **物料来源相关配置正常**（BOM、工艺路线、供应商、委外供应商、委外工序等）
- ✅ **物料来源验证规则正常**
  - 自制件必须有BOM和工艺路线（验证失败时提示错误）
  - 采购件建议配置默认供应商（缺少时提示警告）
  - 虚拟件必须有完整的BOM结构（验证失败时提示错误）
  - 委外件必须有委外供应商和委外工序（验证失败时提示错误）
  - 配置件必须有变体属性和BOM变体（验证失败时提示错误）
- ✅ **物料来源变更控制正常**
  - 物料来源类型变更需要审批
  - 变更前自动验证（检查在制工单、未完成采购订单等）
  - 变更后自动处理变更影响（删除或标记相关配置）
- ✅ **物料来源智能建议正常**
  - 基于物料类型建议物料来源类型
  - 基于BOM结构检测物料来源合理性
  - 基于历史数据建议物料来源优化
  - 检测物料来源配置完整性

**完成标记：**
- [ ] 物料来源类型字段已添加到Material模型
- [ ] 物料来源类型配置界面已实现
- [ ] 物料来源相关配置界面已实现
- [ ] 物料来源验证规则已实现
- [ ] 物料来源变更控制已实现
- [ ] 物料来源智能建议已实现
- [ ] 后端服务代码已编写
- [ ] 后端API已实现
- [ ] 前端页面已实现
- [ ] 数据库迁移脚本已创建
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

**相关文件：**
- 后端模型：`apps/master_data/models/material.py`
- 后端服务：`apps/master_data/services/material_service.py`
- 后端API：`apps/master_data/api/material.py`
- 前端页面：`apps/master-data/pages/material/index.tsx`
- 前端组件：`apps/master-data/components/MaterialForm.tsx`
- 前端服务：`apps/master-data/services/material.ts`

---

### 功能点4.3.5：工序和工艺路线配置优化

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
优化工序和工艺路线配置，支持工序类型、跳转规则、物料分组绑定、子工艺路线、版本管理、变更管理。

**测试用例：**
- 测试工序类型配置
- 测试跳转规则配置
- 测试物料分组绑定
- 测试子工艺路线配置
- 测试版本管理
- 测试变更管理

**验收标准：**
- ✅ 可以配置工序类型
- ✅ 可以配置跳转规则
- ✅ 可以配置物料分组绑定
- ✅ 可以配置子工艺路线
- ✅ 支持工艺路线版本管理
- ✅ 支持工艺路线变更管理

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.3.6：工作时间段配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工作时间段配置功能，用于单据执行效率优化。

**测试用例：**
- 测试工作时间段配置
- 测试工作时间计算

**验收标准：**
- ✅ 可以配置工作时间段
- ✅ 工作时间计算准确（排除非工作时间）
- ✅ 工作时间段配置可以应用到耗时统计

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点4.3.7：期初数据导入（上线倒计时功能）

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现期初数据导入功能，支持上线倒计时功能。

**测试用例：**
- 测试上线倒计时功能
- 测试期初数据导入
- 测试数据验证

**验收标准：**
- ✅ 可以启动上线倒计时
- ✅ 可以导入期初库存
- ✅ 可以导入在制品
- ✅ 可以导入应收应付
- ✅ 数据验证正常

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 功能点进度跟踪

### 步骤4.1总体进度

- [ ] 功能点4.1.1：初始化向导页面设计
- [ ] 功能点4.1.2：行业模板功能
- [ ] 功能点4.1.3：智能默认值配置
- [ ] 功能点4.1.4：编码规则配置
- [ ] 功能点4.1.5：AI智能建议功能
- [ ] 功能点4.1.6：内置帮助系统

**完成度：** 0/6 (0%)

### 步骤4.2总体进度

- [ ] 功能点4.2.1：运行模式切换功能
- [ ] 功能点4.2.2：流程模块开关配置
- [ ] 功能点4.2.3：流程参数配置
- [ ] 功能点4.2.4：PRO版功能标识
- [ ] 功能点4.2.5：配置模板管理

**完成度：** 0/5 (0%)

### 步骤4.3总体进度

- [ ] 功能点4.3.1：组织架构批量导入优化
- [ ] 功能点4.3.2：物料编码映射工具
- [ ] 功能点4.3.3：多单位管理功能
- [ ] 功能点4.3.4：批号和序列号管理功能
- [ ] 功能点4.3.5：工序和工艺路线配置优化
- [ ] 功能点4.3.6：工作时间段配置
- [ ] 功能点4.3.7：期初数据导入（上线倒计时功能）
- [ ] 功能点4.3.8：物料来源控制功能（核心功能，新增）

**完成度：** 0/8 (0%)

### 第四阶段总体进度

**总功能点数：** 19个（原18个 + 新增1个：物料来源控制功能）  
**已完成：** 0个  
**进行中：** 0个  
**未开始：** 18个  
**完成度：** 0/18 (0%)

---

**文档创建时间：** 2025-12-27  
**文档作者：** Auto (AI Assistant)  
**文档版本：** v1.0  
**最后更新：** 2025-12-27
