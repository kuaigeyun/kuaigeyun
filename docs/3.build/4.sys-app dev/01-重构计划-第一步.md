# 重构计划 - 第一步：备份与清理旧代码

> **文档说明：**  
> 本文档详细列出需要备份和清理的旧代码，确保重构安全进行。  
> 所有操作遵循"先备份，再清理"的原则。  
> 
> **创建时间：** 2025-12-27  
> **文档版本：** v1.0  
> **最后更新：** 2025-12-27

---

## ⚠️ 开发前必读：前后端统一模板规范

> **重要提示：** 在开始重构和开发前，请务必阅读并遵循《10-前后端统一模板规范.md》中的规范要求，确保新代码符合技术栈原生设定。

### 📋 前端开发规范（必须遵守）

**所有列表页面必须使用：**
- ✅ `ListPageTemplate` 布局组件
- ✅ `UniTable` 表格组件（禁止直接使用ProTable）
- ✅ `ProForm` 表单组件（禁止直接使用Form）
- ✅ `ProDescriptions` 详情组件（禁止直接使用Descriptions）
- ✅ `Modal` 用于新建/编辑，`Drawer` 用于详情查看

### 📋 后端开发规范（必须遵守）

**所有API路由必须使用：**
- ✅ `APIRouter` 组织路由
- ✅ `Depends(get_current_user, get_current_tenant)` 依赖注入
- ✅ 统一异常处理（`ValidationError`, `NotFoundError`）
- ✅ `response_model` 定义响应模型
- ✅ 服务层封装业务逻辑（禁止在API层写业务逻辑）

**详细规范请参考：** `10-前后端统一模板规范.md`

---

---

## 📋 目录

1. [备份计划](#1-备份计划)
2. [清理计划](#2-清理计划)
3. [执行步骤](#3-执行步骤)
4. [验证清单](#4-验证清单)

---

## 1. 备份计划

### 1.1 创建备份分支

**操作：**
```bash
# 创建备份分支
git checkout -b backup/refactor-$(date +%Y%m%d)
git add .
git commit -m "备份：重构前的完整代码状态"
git push origin backup/refactor-$(date +%Y%m%d)
git checkout main
```

**验收标准：**
- ✅ 备份分支创建成功
- ✅ 所有代码已提交到备份分支
- ✅ 可以随时回滚到备份分支

### 1.2 备份需要重构的文件

#### 1.2.1 前端文件备份

**需要备份的前端文件：**

1. **MRP运算页面**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/mrp-computation/index.tsx`
   - 备份到：`archive/refactor/kuaizhizao/pages/plan-management/mrp-computation/index.tsx`
   - 备份原因：需要合并为统一需求计算页面

2. **LRP运算页面**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/lrp-computation/index.tsx`
   - 备份到：`archive/refactor/kuaizhizao/pages/plan-management/lrp-computation/index.tsx`
   - 备份原因：需要合并为统一需求计算页面

3. **销售预测页面**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-forecasts/index.tsx`
   - 备份到：`archive/refactor/kuaizhizao/pages/sales-management/sales-forecasts/index.tsx`
   - 备份原因：需要统一为需求管理页面

4. **销售订单页面**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-orders/index.tsx`
   - 备份到：`archive/refactor/kuaizhizao/pages/sales-management/sales-orders/index.tsx`
   - 备份原因：需要统一为需求管理页面

5. **MRP服务文件**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/services/mrp.ts`
   - 备份到：`archive/refactor/kuaizhizao/services/mrp.ts`
   - 备份原因：需要合并为统一需求计算服务

6. **销售预测服务文件**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/services/sales-forecast.ts`
   - 备份到：`archive/refactor/kuaizhizao/services/sales-forecast.ts`
   - 备份原因：需要统一为需求管理服务

7. **销售服务文件（部分）**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/services/sales.ts`
   - 备份到：`archive/refactor/kuaizhizao/services/sales.ts`
   - 备份原因：销售订单相关接口需要统一

8. **路由配置文件**
   - 源文件：`riveredge-frontend/src/apps/kuaizhizao/index.tsx`
   - 备份到：`archive/refactor/kuaizhizao/index.tsx`
   - 备份原因：需要移除MRP/LRP和销售预测/销售订单路由

**备份脚本：**
```bash
#!/bin/bash
# 创建备份目录
mkdir -p archive/refactor/kuaizhizao/pages/plan-management/mrp-computation
mkdir -p archive/refactor/kuaizhizao/pages/plan-management/lrp-computation
mkdir -p archive/refactor/kuaizhizao/pages/sales-management/sales-forecasts
mkdir -p archive/refactor/kuaizhizao/pages/sales-management/sales-orders
mkdir -p archive/refactor/kuaizhizao/services

# 备份文件
cp riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/mrp-computation/index.tsx \
   archive/refactor/kuaizhizao/pages/plan-management/mrp-computation/index.tsx

cp riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/lrp-computation/index.tsx \
   archive/refactor/kuaizhizao/pages/plan-management/lrp-computation/index.tsx

cp riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-forecasts/index.tsx \
   archive/refactor/kuaizhizao/pages/sales-management/sales-forecasts/index.tsx

cp riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-orders/index.tsx \
   archive/refactor/kuaizhizao/pages/sales-management/sales-orders/index.tsx

cp riveredge-frontend/src/apps/kuaizhizao/services/mrp.ts \
   archive/refactor/kuaizhizao/services/mrp.ts

cp riveredge-frontend/src/apps/kuaizhizao/services/sales-forecast.ts \
   archive/refactor/kuaizhizao/services/sales-forecast.ts

cp riveredge-frontend/src/apps/kuaizhizao/services/sales.ts \
   archive/refactor/kuaizhizao/services/sales.ts

cp riveredge-frontend/src/apps/kuaizhizao/index.tsx \
   archive/refactor/kuaizhizao/index.tsx

echo "前端文件备份完成"
```

#### 1.2.2 后端文件备份

**需要备份的后端文件：**

1. **MRP/LRP运算Schema**
   - 源文件：`riveredge-backend/src/apps/kuaizhizao/schemas/planning.py`
   - 备份到：`archive/refactor/kuaizhizao/schemas/planning.py`
   - 备份原因：MRP/LRP相关Schema需要合并为统一需求计算Schema

2. **MRP/LRP运算服务**
   - 源文件：`riveredge-backend/src/apps/kuaizhizao/services/planning_service.py`
   - 备份到：`archive/refactor/kuaizhizao/services/planning_service.py`
   - 备份原因：MRP/LRP运算逻辑需要合并为统一需求计算服务

3. **MRP/LRP API路由**
   - 源文件：`riveredge-backend/src/apps/kuaizhizao/api/production.py`
   - 备份到：`archive/refactor/kuaizhizao/api/production.py`
   - 备份原因：MRP/LRP API接口需要合并为统一需求计算接口

4. **销售服务（MRP/LRP调用部分）**
   - 源文件：`riveredge-backend/src/apps/kuaizhizao/services/sales_service.py`
   - 备份到：`archive/refactor/kuaizhizao/services/sales_service.py`
   - 备份原因：销售服务中调用MRP/LRP的部分需要更新

5. **Schema导出文件**
   - 源文件：`riveredge-backend/src/apps/kuaizhizao/schemas/__init__.py`
   - 备份到：`archive/refactor/kuaizhizao/schemas/__init__.py`
   - 备份原因：MRP/LRP相关Schema导出需要更新

**备份脚本：**
```bash
#!/bin/bash
# 创建备份目录
mkdir -p archive/refactor/kuaizhizao/schemas
mkdir -p archive/refactor/kuaizhizao/services
mkdir -p archive/refactor/kuaizhizao/api

# 备份文件
cp riveredge-backend/src/apps/kuaizhizao/schemas/planning.py \
   archive/refactor/kuaizhizao/schemas/planning.py

cp riveredge-backend/src/apps/kuaizhizao/services/planning_service.py \
   archive/refactor/kuaizhizao/services/planning_service.py

cp riveredge-backend/src/apps/kuaizhizao/api/production.py \
   archive/refactor/kuaizhizao/api/production.py

cp riveredge-backend/src/apps/kuaizhizao/services/sales_service.py \
   archive/refactor/kuaizhizao/services/sales_service.py

cp riveredge-backend/src/apps/kuaizhizao/schemas/__init__.py \
   archive/refactor/kuaizhizao/schemas/__init__.py

echo "后端文件备份完成"
```

#### 1.2.3 数据库备份

**需要备份的数据库表：**

1. **MRP运算结果表**
   - 表名：`apps_kuaizhizao_mrp_results`（如果存在）
   - 备份方式：导出SQL或使用数据库备份工具
   - 备份原因：需要迁移到统一需求计算结果表

2. **LRP运算结果表**
   - 表名：`apps_kuaizhizao_lrp_results`（如果存在）
   - 备份方式：导出SQL或使用数据库备份工具
   - 备份原因：需要迁移到统一需求计算结果表

3. **销售预测表**
   - 表名：`apps_kuaizhizao_sales_forecasts`（如果存在）
   - 备份方式：导出SQL或使用数据库备份工具
   - 备份原因：需要迁移到统一需求表

4. **销售订单表**
   - 表名：`apps_kuaizhizao_sales_orders`（如果存在）
   - 备份方式：导出SQL或使用数据库备份工具
   - 备份原因：需要迁移到统一需求表

**备份脚本：**
```bash
#!/bin/bash
# 数据库备份（需要根据实际数据库配置调整）
# PostgreSQL示例
pg_dump -h localhost -U postgres -d riveredge \
  -t apps_kuaizhizao_mrp_results \
  -t apps_kuaizhizao_lrp_results \
  -t apps_kuaizhizao_sales_forecasts \
  -t apps_kuaizhizao_sales_orders \
  > archive/refactor/database_backup_$(date +%Y%m%d).sql

echo "数据库备份完成"
```

### 1.3 备份清单文件

**创建备份清单：**
```bash
# 创建备份清单文件
cat > archive/refactor/backup_manifest.txt << EOF
重构备份清单
备份时间: $(date +"%Y-%m-%d %H:%M:%S")
备份分支: backup/refactor-$(date +%Y%m%d)

前端文件:
- mrp-computation/index.tsx
- lrp-computation/index.tsx
- sales-forecasts/index.tsx
- sales-orders/index.tsx
- services/mrp.ts
- services/sales-forecast.ts
- services/sales.ts
- index.tsx (路由配置)

后端文件:
- schemas/planning.py
- services/planning_service.py
- api/production.py
- services/sales_service.py
- schemas/__init__.py

数据库表:
- apps_kuaizhizao_mrp_results
- apps_kuaizhizao_lrp_results
- apps_kuaizhizao_sales_forecasts
- apps_kuaizhizao_sales_orders
EOF
```

---

## 2. 清理计划

### 2.1 前端清理

#### 2.1.1 删除独立页面

**删除文件：**
1. `riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/mrp-computation/index.tsx`
2. `riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/lrp-computation/index.tsx`
3. `riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-forecasts/index.tsx`
4. `riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-orders/index.tsx`

**删除目录（如果为空）：**
- `riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/mrp-computation/`
- `riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/lrp-computation/`
- `riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-forecasts/`
- `riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-orders/`

#### 2.1.2 更新路由配置

**文件：** `riveredge-frontend/src/apps/kuaizhizao/index.tsx`

**需要移除的导入：**
```typescript
// 删除这些导入
import MRPComputationPage from './pages/plan-management/mrp-computation';
import LRPComputationPage from './pages/plan-management/lrp-computation';
import SalesForecastsPage from './pages/sales-management/sales-forecasts';
import SalesOrdersPage from './pages/sales-management/sales-orders';
```

**需要移除的路由：**
```typescript
// 删除这些路由
<Route path="plan-management/mrp-computation" element={<MRPComputationPage />} />
<Route path="plan-management/lrp-computation" element={<LRPComputationPage />} />
<Route path="sales-management/sales-forecasts" element={<SalesForecastsPage />} />
<Route path="sales-management/sales-orders" element={<SalesOrdersPage />} />
```

#### 2.1.3 更新服务文件

**文件：** `riveredge-frontend/src/apps/kuaizhizao/services/mrp.ts`

**操作：**
- 保留文件，但标记为待重构
- 添加注释说明：`// TODO: 合并为统一需求计算服务`
- 或者直接删除，在新需求计算服务中重新实现

**文件：** `riveredge-frontend/src/apps/kuaizhizao/services/sales-forecast.ts`

**操作：**
- 保留文件，但标记为待重构
- 添加注释说明：`// TODO: 合并为统一需求管理服务`
- 或者直接删除，在新需求管理服务中重新实现

**文件：** `riveredge-frontend/src/apps/kuaizhizao/services/sales.ts`

**操作：**
- 保留文件，但移除销售订单相关接口
- 销售订单接口迁移到统一需求管理服务
- 保留销售出库相关接口

**文件：** `riveredge-frontend/src/apps/kuaizhizao/services/production.ts`

**操作：**
- 移除MRP/LRP相关API调用
- 添加注释说明：`// TODO: 使用统一需求计算API`

### 2.2 后端清理

#### 2.2.1 更新Schema文件

**文件：** `riveredge-backend/src/apps/kuaizhizao/schemas/planning.py`

**操作：**
- 保留MRPComputationRequest、MRPComputationResult、LRPComputationRequest、LRPComputationResult类
- 添加注释标记为待重构：`# TODO: 合并为统一需求计算Schema`
- 或者直接删除，在新需求计算Schema中重新定义

#### 2.2.2 更新服务文件

**文件：** `riveredge-backend/src/apps/kuaizhizao/services/planning_service.py`

**操作：**
- 保留`run_mrp_computation`和`run_lrp_computation`方法
- 添加注释标记为待重构：`# TODO: 合并为统一需求计算方法`
- 或者直接删除，在新需求计算服务中重新实现

#### 2.2.3 更新API路由

**文件：** `riveredge-backend/src/apps/kuaizhizao/api/production.py`

**操作：**
- 移除MRP/LRP相关路由：
  - `@router.post("/mrp-computation", ...)`
  - `@router.post("/lrp-computation", ...)`
- 添加注释说明：`# TODO: 使用统一需求计算路由`

#### 2.2.4 更新服务调用

**文件：** `riveredge-backend/src/apps/kuaizhizao/services/sales_service.py`

**操作：**
- 移除或更新调用MRP/LRP运算的代码
- 添加注释说明：`# TODO: 使用统一需求计算服务`

#### 2.2.5 更新Schema导出

**文件：** `riveredge-backend/src/apps/kuaizhizao/schemas/__init__.py`

**操作：**
- 移除或注释MRP/LRP相关Schema导出：
  - `'MRPComputationRequest'`
  - `'MRPComputationResult'`
  - `'LRPComputationRequest'`
  - `'LRPComputationResult'`
- 添加注释说明：`# TODO: 使用统一需求计算Schema`

---

## 3. 执行步骤

### 步骤1：创建备份分支

```bash
# 1. 确保当前代码已提交
git status
git add .
git commit -m "准备重构：当前代码状态"

# 2. 创建备份分支
git checkout -b backup/refactor-$(date +%Y%m%d)
git push origin backup/refactor-$(date +%Y%m%d)

# 3. 切换回主分支
git checkout main
```

**验收标准：**
- ✅ 备份分支创建成功
- ✅ 代码已推送到远程仓库

### 步骤2：执行文件备份

```bash
# 1. 创建备份目录
mkdir -p archive/refactor/kuaizhizao/{pages/plan-management/{mrp-computation,lrp-computation},pages/sales-management/{sales-forecasts,sales-orders},services,api,schemas}

# 2. 执行前端文件备份（使用上面的备份脚本）
# 3. 执行后端文件备份（使用上面的备份脚本）
# 4. 创建备份清单
```

**验收标准：**
- ✅ 所有文件已备份到archive目录
- ✅ 备份清单文件已创建

### 步骤3：执行数据库备份

```bash
# 根据实际数据库类型执行备份
# PostgreSQL示例
pg_dump -h localhost -U postgres -d riveredge \
  -t apps_kuaizhizao_mrp_results \
  -t apps_kuaizhizao_lrp_results \
  -t apps_kuaizhizao_sales_forecasts \
  -t apps_kuaizhizao_sales_orders \
  > archive/refactor/database_backup_$(date +%Y%m%d).sql
```

**验收标准：**
- ✅ 数据库备份文件已创建
- ✅ 可以成功恢复数据库

### 步骤4：执行前端清理

```bash
# 1. 删除独立页面文件
rm -rf riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/mrp-computation
rm -rf riveredge-frontend/src/apps/kuaizhizao/pages/plan-management/lrp-computation
rm -rf riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-forecasts
rm -rf riveredge-frontend/src/apps/kuaizhizao/pages/sales-management/sales-orders

# 2. 更新路由配置文件（手动编辑）
# 3. 更新服务文件（手动编辑或标记为待重构）
```

**验收标准：**
- ✅ 独立页面文件已删除
- ✅ 路由配置已更新
- ✅ 服务文件已更新或标记

### 步骤5：执行后端清理

```bash
# 1. 更新Schema文件（手动编辑，标记为待重构或删除）
# 2. 更新服务文件（手动编辑，标记为待重构或删除）
# 3. 更新API路由（手动编辑，移除MRP/LRP路由）
# 4. 更新服务调用（手动编辑，更新调用方式）
# 5. 更新Schema导出（手动编辑，移除MRP/LRP导出）
```

**验收标准：**
- ✅ Schema文件已更新
- ✅ 服务文件已更新
- ✅ API路由已更新
- ✅ 服务调用已更新
- ✅ Schema导出已更新

### 步骤6：验证清理结果

```bash
# 1. 检查前端编译是否通过
cd riveredge-frontend
npm run build

# 2. 检查后端启动是否正常
cd riveredge-backend
python -m pytest tests/  # 如果有测试

# 3. 检查是否有未使用的导入
# 使用工具检查（如eslint、ruff等）
```

**验收标准：**
- ✅ 前端编译通过
- ✅ 后端启动正常
- ✅ 没有编译错误
- ✅ 没有未使用的导入

---

## 4. 验证清单

### 4.1 备份验证

- [ ] 备份分支已创建并推送到远程
- [ ] 前端文件已备份到archive目录
- [ ] 后端文件已备份到archive目录
- [ ] 数据库备份文件已创建
- [ ] 备份清单文件已创建

### 4.2 清理验证

- [ ] 独立页面文件已删除
- [ ] 路由配置已更新（移除MRP/LRP和销售预测/销售订单路由）
- [ ] 服务文件已更新或标记为待重构
- [ ] Schema文件已更新或标记为待重构
- [ ] API路由已更新（移除MRP/LRP路由）
- [ ] 服务调用已更新
- [ ] Schema导出已更新

### 4.3 功能验证

- [ ] 前端编译通过
- [ ] 后端启动正常
- [ ] 没有编译错误
- [ ] 没有运行时错误
- [ ] 现有功能（工单、报工等）仍然正常工作

### 4.4 回滚验证（可选）

- [ ] 可以从备份分支恢复代码
- [ ] 可以从备份文件恢复文件
- [ ] 可以从数据库备份恢复数据

---

## 5. 注意事项

1. **备份优先**：所有操作前必须先完成备份
2. **逐步执行**：不要一次性删除所有文件，逐步执行并验证
3. **保留注释**：删除代码前，先添加注释说明原因
4. **测试验证**：每步操作后都要进行测试验证
5. **文档记录**：记录所有操作和遇到的问题

---

**文档创建时间：** 2025-12-27  
**文档作者：** Auto (AI Assistant)  
**文档版本：** v1.0  
**最后更新：** 2025-12-27
