# 详细开发计划 - 第三阶段：需求驱动流程完善

> **文档说明：**  
> 本文档详细列出第三阶段的每个功能点，支持功能点完成一个测试一个标记一个。  
> 每个功能点包含：任务描述、测试用例、验收标准、完成状态。  
> 
> **创建时间：** 2025-12-27  
> **文档版本：** v1.1  
> **最后更新：** 2026-01-16（新增物料来源控制功能）

---

## ⚠️ 开发前必读：前后端统一模板规范

> **🚨 重要提示：** 在开始开发前，请务必阅读并遵循《10-前后端统一模板规范.md》中的规范要求，确保代码符合技术栈原生设定。
> **⚠️ 违反规范将导致代码审查不通过，需要返工重写！**

### 📋 前端开发规范（必须遵守）

**所有列表页面必须使用：**
- ✅ `ListPageTemplate` 布局组件（禁止使用其他布局）
- ✅ `UniTable` 表格组件（禁止直接使用ProTable）
- ✅ `ProForm` 表单组件（禁止直接使用Form）
- ✅ `ProDescriptions` 详情组件（禁止直接使用Descriptions）
- ✅ `Modal` 用于新建/编辑，`Drawer` 用于详情查看

**标准页面结构（必须遵循）：**
```typescript
<ListPageTemplate>
  <UniTable
    columns={columns}
    request={handleRequest}
    showAdvancedSearch={true}
    showCreateButton={true}
    onCreate={handleCreate}
    showEditButton={true}
    onEdit={handleEdit}
    showDeleteButton={true}
    onDelete={handleDelete}
    onDetail={handleDetail}
  />
</ListPageTemplate>
<Modal> {/* 新建/编辑 */} </Modal>
<Drawer> {/* 详情 */} </Drawer>
```

**禁止事项：**
- ❌ 禁止直接使用 `ProTable`（必须使用 `UniTable`）
- ❌ 禁止直接使用 `Form`（必须使用 `ProForm`）
- ❌ 禁止直接使用 `Descriptions`（必须使用 `ProDescriptions`）
- ❌ 禁止在列表页面中混用其他布局组件

### 📋 后端开发规范（必须遵守）

**所有API路由必须使用：**
- ✅ `APIRouter` 组织路由（禁止使用其他路由方式）
- ✅ `Depends(get_current_user, get_current_tenant)` 依赖注入（必须使用）
- ✅ 统一异常处理（`ValidationError`, `NotFoundError`，禁止直接使用HTTPException）
- ✅ `response_model` 定义响应模型（必须使用）
- ✅ 服务层封装业务逻辑（禁止在API层写业务逻辑）

**标准API结构（必须遵循）：**
```python
router = APIRouter(prefix="/xxx", tags=["XXX"])

@router.post("", response_model=ModelResponse, summary="创建")
async def create_xxx(
    data: ModelCreate,
    current_user: Annotated[User, Depends(get_current_user)],
    tenant_id: Annotated[int, Depends(get_current_tenant)]
):
    try:
        return await Service.create_xxx(tenant_id, data, current_user.id)
    except ValidationError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

**禁止事项：**
- ❌ 禁止在API层写业务逻辑（必须在服务层实现）
- ❌ 禁止直接使用 `HTTPException`（必须使用统一异常类）
- ❌ 禁止不使用依赖注入（必须使用 `get_current_user` 和 `get_current_tenant`）
- ❌ 禁止不使用 `response_model`（必须定义响应模型）

**📖 详细规范请参考：** `10-前后端统一模板规范.md`

---

---

## 📋 目录

1. [步骤3.1：采购管理流程](#步骤21采购管理流程)
2. [步骤3.2：销售出库流程（流程末端）](#步骤22销售出库流程流程末端)
3. [步骤3.3：质量管理流程](#步骤23质量管理流程)
4. [步骤3.4：财务管理流程](#步骤24财务管理流程)

---

## 步骤3.1：采购管理流程

**目标：** 完善采购管理流程，实现从需求计算到采购入库的完整流程，**基于物料来源的采购订单生成**（核心功能增强）

**时间估算：** 2-3周（新增物料来源控制应用）

**前置条件：**
- ✅ 第一阶段已完成（需求管理和需求计算）
- ✅ 供应商管理已在master-data中实现
- ✅ 物料主数据配置已完成（物料来源类型已配置）

---

### 功能点3.1.1：采购订单数据模型设计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
设计采购订单数据模型，支持从需求计算结果生成采购单。

**测试用例：**
- 测试采购订单模型创建
- 测试采购订单明细创建

**验收标准：**
- ✅ 采购订单模型可以存储完整信息
- ✅ 可以关联需求计算和需求
- ✅ 数据库迁移脚本可以成功执行

**完成标记：**
- [ ] 模型代码已编写
- [ ] 数据库迁移脚本已创建
- [ ] 单元测试已编写并通过

---

### 功能点3.1.2：采购订单服务实现

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现采购订单服务，包括创建、查询、更新、审核等功能。

**测试用例：**
- 测试创建采购订单
- 测试查询采购订单列表
- 测试审核采购订单

**验收标准：**
- ✅ 可以创建采购订单
- ✅ 可以查询采购订单列表（支持筛选）
- ✅ 可以审核采购订单
- ✅ 采购订单编码自动生成

**完成标记：**
- [ ] 服务代码已编写
- [ ] 单元测试已编写并通过
- [ ] 代码审查已通过

---

### 功能点3.1.3：从需求计算一键生成采购单（增强：物料来源控制）

**状态：** ⬜ 未开始

**任务描述：**
实现从需求计算结果一键生成采购单功能，**根据物料来源类型只对采购件生成采购订单**（核心功能增强）。

**技术实现：**
- **后端**：
  - 在`PurchaseOrderService`中实现物料来源识别逻辑
  - 只对采购件生成采购订单（自动过滤自制件、虚拟件、委外件、配置件）
  - 虚拟件不生成采购订单（自动跳过，展开到下层物料后再判断）
  - 自动填充默认供应商和采购价格（从物料主数据获取）
- **前端**：
  - 在一键生成按钮中显示物料来源统计信息
  - 显示将要生成的采购订单数量和物料列表（只显示采购件）
  - 显示物料来源验证结果（如有错误，禁用生成按钮）

**测试用例：**

1. **测试采购件生成采购订单**
   - 创建包含采购件的需求计算
   - 验证只对采购件生成采购订单
   - 验证采购订单自动填充默认供应商和采购价格

2. **测试虚拟件处理**
   - 创建包含虚拟件的需求计算
   - 验证虚拟件不生成采购订单（自动跳过）
   - 验证虚拟件展开到下层物料后再判断是否为采购件

3. **测试自制件处理**
   - 创建包含自制件的需求计算
   - 验证自制件不生成采购订单（生成生产工单）

4. **测试委外件处理**
   - 创建包含委外件的需求计算
   - 验证委外件不生成采购订单（生成委外工单）

5. **测试按供应商分组**
   - 创建包含多个供应商的采购件需求计算
   - 验证按供应商分组生成多个采购订单

6. **测试物料来源验证**
   - 测试采购件缺少默认供应商时的警告提示
   - 测试物料来源验证失败时的处理

**验收标准：**
- ✅ **只对采购件生成采购订单**（自动过滤自制件、虚拟件、委外件、配置件）
- ✅ **虚拟件不生成采购订单**（自动跳过，展开到下层物料）
- ✅ **采购订单自动填充默认供应商和采购价格**（从物料主数据获取）
- ✅ 可以从需求计算结果一键生成采购单
- ✅ 自动按供应商分组生成多个采购单
- ✅ 自动建立关联关系
- ✅ **物料来源验证失败时不允许生成**（显示错误提示）

**完成标记：**
- [ ] 物料来源识别逻辑已实现
- [ ] 采购件过滤逻辑已实现
- [ ] 虚拟件跳过逻辑已实现
- [ ] 默认供应商和价格填充逻辑已实现
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

**相关文件：**
- 后端服务：`apps/kuaizhizao/services/purchase_service.py`
- 后端API：`apps/kuaizhizao/api/purchase.py`
- 前端页面：`apps/kuaizhizao/pages/purchase-orders/index.tsx`
- 前端服务：`apps/kuaizhizao/services/purchase.ts`

---

### 功能点3.1.4：采购入库流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现采购入库流程，支持批号和序列号管理。

**测试用例：**
- 测试创建采购入库单
- 测试库存自动更新
- 测试批号和序列号管理

**验收标准：**
- ✅ 可以创建采购入库单
- ✅ 入库后库存自动更新
- ✅ 支持批号和序列号管理
- ✅ 采购订单状态自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.1.5：采购订单API和前端页面

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现采购订单API和前端页面。

**测试用例：**
- 测试采购订单API
- 测试采购订单前端页面

**验收标准：**
- ✅ 采购订单API功能完整
- ✅ 采购订单前端页面功能完整
- ✅ 可以完成采购订单的完整流程

**完成标记：**
- [ ] API代码已编写
- [ ] 前端页面代码已编写
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.1.6：采购审批流程（可选）

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现采购审批流程，支持多级审批、审批路由配置等。

**技术实现：**
- 后端：创建审批流程模型（ApprovalFlow），支持采购订单审批
- 后端：实现审批服务（ApprovalService），处理审批逻辑
- 前端：使用ProForm实现审批表单
- 前端：使用Ant Design的Steps组件展示审批流程

**测试用例：**
1. 测试采购订单提交后进入审批流程
2. 测试审批人员审批采购订单
3. 测试审批通过/拒绝流程
4. 测试审批流程状态查询

**验收标准：**
- ✅ 采购订单提交后可以进入审批流程（可选）
- ✅ 审批人员可以审批采购订单
- ✅ 审批通过/拒绝后采购订单状态自动更新
- ✅ 审批流程状态可以查询
- ✅ 审批流程支持多级审批

**完成标记：**
- [ ] 审批流程模型已设计
- [ ] 审批服务已实现
- [ ] 审批API已实现
- [ ] 审批前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤3.2：销售出库流程（流程末端）

**目标：** 实现销售出库流程，关联到流程源头的销售预测或销售订单

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成
- ✅ 成品入库功能已实现

---

### 功能点3.2.1：销售出库数据模型设计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
设计销售出库数据模型，支持批号和序列号选择，关联到需求。

**测试用例：**
- 测试销售出库模型创建
- 测试关联需求验证

**验收标准：**
- ✅ 销售出库模型可以关联需求
- ✅ 支持批号和序列号管理
- ✅ 数据库迁移脚本可以成功执行

**完成标记：**
- [ ] 模型代码已编写
- [ ] 数据库迁移脚本已创建
- [ ] 单元测试已编写并通过

---

### 功能点3.2.2：销售出库服务实现

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现销售出库服务，支持批号和序列号选择，自动关联需求。

**测试用例：**
- 测试创建销售出库单
- 测试库存自动扣减
- 测试批号和序列号选择
- 测试关联关系建立

**验收标准：**
- ✅ 可以创建销售出库单
- ✅ 出库后库存自动扣减
- ✅ 支持批号和序列号选择
- ✅ 自动关联到需求（MTS关联销售预测，MTO关联销售订单）

**完成标记：**
- [ ] 服务代码已编写
- [ ] 单元测试已编写并通过
- [ ] 代码审查已通过

---

### 功能点3.2.3：销售退货流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现销售退货流程。

**测试用例：**
- 测试创建销售退货单
- 测试库存自动增加

**验收标准：**
- ✅ 可以创建销售退货单
- ✅ 退货后库存自动增加
- ✅ 销售出库单状态自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.2.4：采购退货流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现采购退货流程。

**测试用例：**
- 测试创建采购退货单
- 测试库存自动扣减

**验收标准：**
- ✅ 可以创建采购退货单
- ✅ 退货后库存自动扣减
- ✅ 采购入库单状态自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.2.5：库存预警和自动补货建议

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存预警和自动补货建议功能。

**测试用例：**
- 测试库存预警检查
- 测试补货建议生成

**验收标准：**
- ✅ 可以检查库存预警
- ✅ 可以生成补货建议
- ✅ 预警信息准确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.2.6：销售出库API和前端页面

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现销售出库API和前端页面。

**测试用例：**
- 测试销售出库API
- 测试销售出库前端页面
- 测试批号和序列号选择

**验收标准：**
- ✅ 销售出库API功能完整
- ✅ 销售出库前端页面功能完整
- ✅ 支持批号和序列号选择
- ✅ 可以关联到需求

**完成标记：**
- [ ] API代码已编写
- [ ] 前端页面代码已编写
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 步骤3.3：质量管理流程

**目标：** 实现完整的质量管理流程，包括质检标准管理、来料/过程/成品检验、不合格品处理

**时间估算：** 2-3周

**前置条件：**
- ✅ 第一阶段已完成
- ✅ 物料主数据已配置

---

### 功能点3.3.1：质检标准管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现质检标准管理功能。

**测试用例：**
- 测试创建质检标准
- 测试查询质检标准

**验收标准：**
- ✅ 可以创建质检标准
- ✅ 可以查询质检标准
- ✅ 质检标准可以关联物料

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点3.3.2：来料检验流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现来料检验流程。

**测试用例：**
- 测试创建来料检验单
- 测试检验结果处理
- 测试库存更新

**验收标准：**
- ✅ 可以创建来料检验单
- ✅ 检验结果可以记录
- ✅ 根据检验结果自动更新库存

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.3.3：过程检验流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现过程检验流程。

**测试用例：**
- 测试创建过程检验单
- 测试检验结果处理

**验收标准：**
- ✅ 可以创建过程检验单
- ✅ 可以关联工单和工序
- ✅ 检验结果可以记录

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.3.4：成品检验流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现成品检验流程。

**测试用例：**
- 测试创建成品检验单
- 测试检验结果处理

**验收标准：**
- ✅ 可以创建成品检验单
- ✅ 可以关联成品入库单
- ✅ 检验结果可以记录

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.3.5：不合格品处理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现不合格品处理流程。

**测试用例：**
- 测试创建不合格品记录
- 测试不合格品处理（返工、报废、退货）

**验收标准：**
- ✅ 可以创建不合格品记录
- ✅ 可以处理不合格品（返工、报废、退货）
- ✅ 处理结果正确记录

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.3.6：质检报表分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现质检报表分析功能。

**测试用例：**
- 测试质量统计查询
- 测试报表数据准确性

**验收标准：**
- ✅ 可以查询质量统计
- ✅ 报表数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 步骤3.4：财务管理流程

**目标：** 实现财务管理流程，包括应付管理和应收管理

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成
- ✅ 采购和销售流程已实现

---

### 功能点3.4.1：应付管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现应付管理功能，关联采购订单和采购入库单。

**测试用例：**
- 测试创建应付账款
- 测试应付账款支付

**验收标准：**
- ✅ 可以从采购订单创建应付账款
- ✅ 可以记录应付账款支付
- ✅ 应付账款状态自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.4.2：应收管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现应收管理功能，关联销售订单和销售出库单。

**测试用例：**
- 测试创建应收账款
- 测试应收账款收款

**验收标准：**
- ✅ 可以从销售订单或销售出库单创建应收账款
- ✅ 可以记录应收账款收款
- ✅ 应收账款状态自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点3.4.3：财务与业务单据关联

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现财务与业务单据的自动关联。

**测试用例：**
- 测试采购入库自动创建应付账款
- 测试销售出库自动创建应收账款

**验收标准：**
- ✅ 采购入库后自动创建应付账款
- ✅ 销售出库后自动创建应收账款
- ✅ 财务单据与业务单据自动关联

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 功能点进度跟踪

### 步骤3.1总体进度

- [ ] 功能点3.1.1：采购订单数据模型设计
- [ ] 功能点3.1.2：采购订单服务实现
- [ ] 功能点3.1.3：从需求计算一键生成采购单（增强：物料来源控制）
- [ ] 功能点3.1.4：采购入库流程
- [ ] 功能点3.1.5：采购订单API和前端页面
- [ ] 功能点3.1.6：采购审批流程（可选）

**完成度：** 0/6 (0%)

### 步骤3.2总体进度

- [ ] 功能点3.2.1：销售出库数据模型设计
- [ ] 功能点3.2.2：销售出库服务实现
- [ ] 功能点3.2.3：销售退货流程
- [ ] 功能点3.2.4：采购退货流程
- [ ] 功能点3.2.5：库存预警和自动补货建议
- [ ] 功能点3.2.6：销售出库API和前端页面
- [ ] 功能点3.2.7：批号和序列号选择功能
- [ ] 功能点3.2.8：销售出库与需求关联功能
- [ ] 功能点3.2.9：销售出库单上拉功能

**完成度：** 0/9 (0%)

### 步骤3.3总体进度

- [ ] 功能点3.3.1：质检标准管理
- [ ] 功能点3.3.2：来料检验流程
- [ ] 功能点3.3.3：过程检验流程
- [ ] 功能点3.3.4：成品检验流程
- [ ] 功能点3.3.5：不合格品处理流程
- [ ] 功能点3.3.6：质检报表分析

**完成度：** 0/6 (0%)

### 步骤3.4总体进度

- [ ] 功能点3.4.1：应付管理
- [ ] 功能点3.4.2：应收管理
- [ ] 功能点3.4.3：财务与业务单据关联

**完成度：** 0/3 (0%)

### 第三阶段总体进度

**总功能点数：** 23个（原20个 + 新增3个）  
**已完成：** 0个  
**进行中：** 0个  
**未开始：** 20个  
**完成度：** 0/20 (0%)

---

**文档创建时间：** 2025-12-27  
**文档作者：** Auto (AI Assistant)  
**文档版本：** v1.0  
**最后更新：** 2025-12-27
