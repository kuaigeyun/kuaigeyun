# 详细开发计划 - 第二阶段：MES核心功能完善

> **文档说明：**  
> 本文档详细列出第二阶段的每个功能点，支持功能点完成一个测试一个标记一个。  
> 每个功能点包含：任务描述、测试用例、验收标准、完成状态。  
> 
> **重要说明：** 本阶段专注于MES核心功能，包括工单管理、报工管理、生产领料、成品入库等生产执行相关功能。在核心流程统一完成后，完善MES执行层面的功能。

---

## ⚠️ 开发前必读：前后端统一模板规范

> **🚨 重要提示：** 在开始开发前，请务必阅读并遵循《10-前后端统一模板规范.md》中的规范要求，确保代码符合技术栈原生设定。
> **⚠️ 违反规范将导致代码审查不通过，需要返工重写！**

### 📋 前端开发规范（必须遵守）

**所有列表页面必须使用：**
- ✅ `ListPageTemplate` 布局组件（禁止使用其他布局）
- ✅ `UniTable` 表格组件（禁止直接使用ProTable）
- ✅ `ProForm` 表单组件（禁止直接使用Form）
- ✅ `ProDescriptions` 详情组件（禁止直接使用Descriptions）
- ✅ `Modal` 用于新建/编辑，`Drawer` 用于详情查看

**标准页面结构（必须遵循）：**
```typescript
<ListPageTemplate>
  <UniTable
    columns={columns}
    request={handleRequest}
    showAdvancedSearch={true}
    showCreateButton={true}
    onCreate={handleCreate}
    showEditButton={true}
    onEdit={handleEdit}
    showDeleteButton={true}
    onDelete={handleDelete}
    onDetail={handleDetail}
  />
</ListPageTemplate>
<Modal> {/* 新建/编辑 */} </Modal>
<Drawer> {/* 详情 */} </Drawer>
```

**禁止事项：**
- ❌ 禁止直接使用 `ProTable`（必须使用 `UniTable`）
- ❌ 禁止直接使用 `Form`（必须使用 `ProForm`）
- ❌ 禁止直接使用 `Descriptions`（必须使用 `ProDescriptions`）
- ❌ 禁止在列表页面中混用其他布局组件

### 📋 后端开发规范（必须遵守）

**所有API路由必须使用：**
- ✅ `APIRouter` 组织路由（禁止使用其他路由方式）
- ✅ `Depends(get_current_user, get_current_tenant)` 依赖注入（必须使用）
- ✅ 统一异常处理（`ValidationError`, `NotFoundError`，禁止直接使用HTTPException）
- ✅ `response_model` 定义响应模型（必须使用）
- ✅ 服务层封装业务逻辑（禁止在API层写业务逻辑）

**标准API结构（必须遵循）：**
```python
router = APIRouter(prefix="/xxx", tags=["XXX"])

@router.post("", response_model=ModelResponse, summary="创建")
async def create_xxx(
    data: ModelCreate,
    current_user: Annotated[User, Depends(get_current_user)],
    tenant_id: Annotated[int, Depends(get_current_tenant)]
):
    try:
        return await Service.create_xxx(tenant_id, data, current_user.id)
    except ValidationError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

**禁止事项：**
- ❌ 禁止在API层写业务逻辑（必须在服务层实现）
- ❌ 禁止直接使用 `HTTPException`（必须使用统一异常类）
- ❌ 禁止不使用依赖注入（必须使用 `get_current_user` 和 `get_current_tenant`）
- ❌ 禁止不使用 `response_model`（必须定义响应模型）

**📖 详细规范请参考：** `10-前后端统一模板规范.md`

---
> 
> **创建时间：** 2025-12-27  
> **文档版本：** v2.1  
> **最后更新：** 2026-01-16（新增物料来源控制功能）

---

## 📋 目录

1. [步骤2.1：工单高级管理](#步骤21工单高级管理)
2. [步骤2.2：报工高级功能](#步骤22报工高级功能)
3. [步骤2.3：仓储高级功能](#步骤23仓储高级功能)
4. [步骤2.4：单据执行效率优化](#步骤24单据执行效率优化)
5. [步骤2.5：异常处理](#步骤25异常处理)
6. [步骤2.6：设备模具管理](#步骤26设备模具管理)
7. [步骤2.7：成本核算](#步骤27成本核算)

---

## 步骤2.1：工单高级管理

**目标：** 实现工单高级管理功能，包括返工单、拆分、合并、冻结、优先级、基于物料来源的工单生成和验证、委外工单管理等

**时间估算：** 2-3周（新增物料来源控制和委外工单管理）

**前置条件：**
- ✅ 第一阶段已完成（工单基础功能已实现）
- ✅ 物料主数据配置已完成（物料来源类型已配置）

---

### 功能点2.1.1：返工单管理

**状态：** ✅ 已完成

**任务描述：**
实现返工单管理功能。

**技术实现：**
- 后端：创建返工单模型（ReworkOrder），支持关联原工单
- 后端：实现返工单服务（ReworkOrderService），包括创建、查询、更新、删除、从工单创建返工单
- 后端：实现返工单API接口（production.py）
- 前端：使用ListPageTemplate和UniTable实现返工单管理页面
- 前端：使用ProForm实现返工单表单，使用ProDescriptions实现详情展示

**测试用例：**
- 测试创建返工单
- 测试返工单流程
- 测试从工单创建返工单

**验收标准：**
- ✅ 可以创建返工单
- ✅ 返工单关联原工单
- ✅ 返工单流程完整
- ✅ 可以从工单创建返工单

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（ReworkOrder模型）
  - [x] 后端服务已实现 ✅（ReworkOrderService）
  - [x] 后端API已实现 ✅（production.py）
  - [x] 前端页面已实现 ✅（rework-orders/index.tsx，使用UniTable）
  - [x] 数据库迁移已完成 ✅（12_20260115000002_add_p1_work_order_models.py）
  - [x] 前后端对接完成 ✅（reworkOrderApi服务）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用ProForm和ProDescriptions）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.2：工单拆分功能

**状态：** ✅ 已完成

**任务描述：**
实现工单拆分功能，支持按数量拆分（等量拆分和指定数量拆分）。

**技术实现：**
- 后端：在WorkOrderService中实现split_work_order方法
- 后端：支持等量拆分（split_count）和指定数量拆分（split_quantities）
- 后端：拆分后原工单状态自动更新为已取消
- 前端：在工单管理页面添加拆分功能，使用Modal实现拆分表单

**测试用例：**
- 测试工单拆分
- 测试拆分数量验证
- 测试等量拆分
- 测试指定数量拆分

**验收标准：**
- ✅ 可以拆分工单
- ✅ 拆分数量验证正常（总和必须等于原工单数量）
- ✅ 拆分后的工单信息正确
- ✅ 支持等量拆分和指定数量拆分
- ✅ 只能拆分草稿或已下达状态的工单
- ✅ 已报工的工单不能拆分

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（WorkOrderService.split_work_order）
  - [x] 后端API已实现 ✅（POST /work-orders/{id}/split）
  - [x] 前端页面已实现 ✅（工单管理页面，使用Modal实现拆分表单）
  - [x] 前后端对接完成 ✅（workOrderApi.split）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.3：工单合并功能

**状态：** ✅ 已完成

**任务描述：**
实现工单合并功能，支持将多个工单合并为一个工单。

**技术实现：**
- 后端：在WorkOrderService中实现merge_work_orders方法
- 后端：支持合并多个工单（至少2个）
- 后端：合并后原工单状态自动更新为已取消
- 前端：在工单管理页面添加合并功能，使用Modal实现合并表单

**测试用例：**
- 测试工单合并
- 测试合并验证（相同产品、相同状态、未报工、未冻结）
- 测试合并后工单信息

**验收标准：**
- ✅ 可以合并工单（至少2个）
- ✅ 合并验证正常（只能合并相同产品、相同状态、未报工、未冻结的工单）
- ✅ 合并后的工单信息正确（数量累加、编码自动生成）
- ✅ 合并后原工单状态自动更新为已取消

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（WorkOrderService.merge_work_orders）
  - [x] 后端API已实现 ✅（POST /work-orders/merge）
  - [x] 前端页面已实现 ✅（工单管理页面，使用Modal实现合并表单）
  - [x] 前后端对接完成 ✅（workOrderApi.merge）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.4：工单冻结功能

**状态：** ✅ 已完成

**任务描述：**
实现工单冻结功能，支持冻结和解冻工单，冻结的工单不能执行。

**技术实现：**
- 后端：在WorkOrderService中实现freeze_work_order和unfreeze_work_order方法
- 后端：工单模型包含冻结相关字段（is_frozen、freeze_reason、frozen_at、frozen_by等）
- 后端：报工服务检查工单是否冻结，冻结的工单不能报工
- 前端：在工单管理页面添加冻结和解冻功能，使用Modal实现冻结表单

**测试用例：**
- 测试工单冻结
- 测试工单解冻
- 测试冻结工单不能报工
- 测试冻结工单不能下达

**验收标准：**
- ✅ 可以冻结工单（需要填写冻结原因）
- ✅ 可以解冻工单
- ✅ 冻结的工单不能执行（不能报工、不能下达）
- ✅ 冻结信息完整记录（冻结原因、冻结时间、冻结人等）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（WorkOrderService.freeze_work_order和unfreeze_work_order）
  - [x] 后端API已实现 ✅（POST /work-orders/{id}/freeze和POST /work-orders/{id}/unfreeze）
  - [x] 前端页面已实现 ✅（工单管理页面，使用Modal实现冻结表单）
  - [x] 前后端对接完成 ✅（workOrderApi.freeze和workOrderApi.unfreeze）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.5：工单优先级管理

**状态：** ✅ 已完成

**任务描述：**
实现工单优先级管理功能，支持设置单个工单优先级和批量设置工单优先级。

**技术实现：**
- 后端：在WorkOrderService中实现set_work_order_priority和batch_set_work_order_priority方法
- 后端：支持四种优先级（low/normal/high/urgent）
- 前端：在工单管理页面添加优先级设置功能，支持单个和批量设置
- 前端：工单列表显示优先级，使用Tag组件展示

**测试用例：**
- 测试设置工单优先级
- 测试批量设置工单优先级
- 测试按优先级排序
- 测试优先级显示

**验收标准：**
- ✅ 可以设置工单优先级（low/normal/high/urgent）
- ✅ 可以批量设置工单优先级
- ✅ 工单列表可以按优先级排序
- ✅ 优先级显示清晰（使用Tag组件，不同颜色）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（WorkOrderService.set_work_order_priority和batch_set_work_order_priority）
  - [x] 后端API已实现 ✅（PUT /work-orders/{id}/priority和PUT /work-orders/batch-priority）
  - [x] 前端页面已实现 ✅（工单管理页面，支持单个和批量设置优先级）
  - [x] 前后端对接完成 ✅（workOrderApi.setPriority和workOrderApi.batchSetPriority）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.6：执行中工单工序修改

**状态：** ✅ 已完成

**任务描述：**
实现执行中工单工序修改功能，支持在执行中工单中修改、添加、删除未报工的工序。

**技术实现：**
- 后端：在WorkOrderService中实现update_work_order_operations方法
- 后端：支持修改草稿、已下达和执行中状态的工单工序
- 后端：已报工的工序不允许修改（保护已报工数据）
- 前端：在工单管理页面添加工序编辑功能，支持拖拽排序、添加、编辑、删除工序

**测试用例：**
- 测试修改工单工序（草稿、已下达、执行中状态）
- 测试修改权限验证（已报工工序不能修改）
- 测试修改后工序信息正确
- 测试工序顺序调整

**验收标准：**
- ✅ 可以修改执行中工单的工序（未报工的工序）
- ✅ 修改权限验证正常（已报工的工序不能修改）
- ✅ 修改后工序信息正确
- ✅ 支持工序顺序调整（拖拽排序）
- ✅ 支持添加和删除工序（未报工的）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（WorkOrderService.update_work_order_operations，支持执行中工单）
  - [x] 后端API已实现 ✅（PUT /work-orders/{id}/operations）
  - [x] 前端页面已实现 ✅（工单管理页面，支持工序编辑、拖拽排序）
  - [x] 前后端对接完成 ✅（workOrderApi.updateOperations）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.7：工单批量操作

**状态：** ✅ 已完成

**任务描述：**
实现工单批量操作功能，包括批量下达、批量冻结、批量取消等。

**技术实现：**
- 后端：已有单个操作API（release、freeze、update），支持批量操作（循环调用单个API）
- 前端：使用UniTable的行选择功能，支持批量选择
- 前端：使用Ant Design的Button组件实现批量操作按钮
- 前端：批量下达支持智能检查（冻结检查、状态检查、时间检查等）

**测试用例：**
1. 测试批量下达工单
2. 测试批量冻结工单
3. 测试批量取消工单
4. 测试批量操作权限验证
5. 测试批量下达智能检查

**验收标准：**
- ✅ 可以批量下达工单（支持智能检查）
- ✅ 可以批量冻结工单（需要填写冻结原因）
- ✅ 可以批量取消工单
- ✅ 可以批量设置优先级
- ✅ 可以批量删除工单
- ✅ 批量操作权限验证正常

**完成标记：**
- [x] 批量操作功能已实现 ✅
  - [x] 批量下达已实现 ✅（支持智能检查，前端实现）
  - [x] 批量冻结已实现 ✅（前端实现，调用单个freeze API）
  - [x] 批量取消已实现 ✅（前端实现，调用update API更新状态）
  - [x] 批量设置优先级已实现 ✅（后端API支持）
  - [x] 批量删除已实现 ✅（通过UniTable的onDelete）
  - [x] 前端页面已实现 ✅（工单管理页面，批量操作按钮）
  - [x] 前后端对接完成 ✅（workOrderApi）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable）
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.1.8：工单状态流转管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单状态流转管理，包括状态机定义、状态流转规则、状态流转日志等。

**技术实现：**
- 后端：使用状态机模式管理工单状态（draft→released→in_progress→completed→cancelled）
- 后端：扩展状态流转服务（StateTransitionService）支持工单类型，添加工单默认状态流转规则
- 后端：更新状态流转API支持工单状态流转，自动更新工单相关时间字段

---

### 功能点2.1.9：基于物料来源的工单生成和验证（核心功能，新增）

**状态：** ⬜ 未开始

**任务描述：**
实现基于物料来源的工单生成和验证功能，根据物料来源类型智能生成生产工单或委外工单。

**技术实现：**
- **后端**：
  - 在`WorkOrderService`中实现物料来源识别逻辑
  - 生产计划时只对自制件生成生产工单（需要配置BOM和工艺路线）
  - 委外件生成委外工单（需要配置委外供应商和委外工序）
  - 虚拟件不生成工单（直接展开到下层物料）
  - 采购件不生成生产工单（生成采购订单）
  - 工单创建时验证物料来源配置完整性（自制件必须有BOM和工艺路线，委外件必须有委外供应商）
- **前端**：
  - 在工单创建页面显示物料来源信息
  - 显示物料来源类型（自制件、委外件等）
  - 显示物料来源验证结果（通过/警告/错误）
  - 物料来源验证失败时不允许创建工单（显示错误提示）

**测试用例：**

1. **测试自制件工单生成**
   - 创建包含自制件的生产计划
   - 验证自制件自动生成生产工单
   - 验证自制件必须有BOM和工艺路线

2. **测试委外件工单生成**
   - 创建包含委外件的生产计划
   - 验证委外件自动生成委外工单
   - 验证委外件必须有委外供应商和委外工序

3. **测试虚拟件处理**
   - 创建包含虚拟件的生产计划
   - 验证虚拟件不生成工单（自动跳过）
   - 验证虚拟件的需求直接传递到下层物料

4. **测试采购件处理**
   - 创建包含采购件的生产计划
   - 验证采购件不生成生产工单（生成采购订单）

5. **测试物料来源验证**
   - 测试自制件缺少BOM或工艺路线时的错误提示
   - 测试委外件缺少委外供应商或委外工序时的错误提示
   - 测试物料来源验证失败时不允许创建工单

**验收标准：**
- ✅ **生产计划时只对自制件生成生产工单**（需要BOM和工艺路线）
- ✅ **委外件生成委外工单**（需要委外供应商和委外工序）
- ✅ **虚拟件不生成工单**（自动跳过）
- ✅ **采购件不生成生产工单**（生成采购订单）
- ✅ **工单创建时验证物料来源配置完整性**
  - 自制件必须有BOM和工艺路线（验证失败时提示错误）
  - 委外件必须有委外供应商和委外工序（验证失败时提示错误）
- ✅ **前端页面显示物料来源信息**
  - 显示物料来源类型（自制件、委外件等）
  - 显示物料来源验证结果（通过/警告/错误）
  - 物料来源验证失败时不允许创建工单（显示错误提示）

**完成标记：**
- [ ] 物料来源识别逻辑已实现
- [ ] 自制件工单生成逻辑已实现
- [ ] 委外件工单生成逻辑已实现
- [ ] 虚拟件跳过逻辑已实现
- [ ] 物料来源验证逻辑已实现
- [ ] 后端服务代码已编写
- [ ] 后端API已实现
- [ ] 前端页面已更新
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过
- [ ] 功能测试已通过

**相关文件：**
- 后端服务：`apps/kuaizhizao/services/work_order_service.py`
- 后端API：`apps/kuaizhizao/api/production.py`
- 前端页面：`apps/kuaizhizao/pages/work-orders/index.tsx`
- 前端服务：`apps/kuaizhizao/services/production.ts`

---

### 功能点2.1.10：委外工单管理（核心功能，新增）

**状态：** ⬜ 未开始

**任务描述：**
实现委外工单管理功能，包括委外工单创建、委外发料、委外收货、委外费用管理等。

**技术实现：**
- **后端**：
  - 创建委外工单模型（OutsourceWorkOrder），支持关联委外供应商和委外工序
  - 实现委外工单服务（OutsourceWorkOrderService），包括创建、查询、更新、删除
  - 实现委外发料服务（OutsourceMaterialIssueService），处理提供给委外供应商的原材料
  - 实现委外收货服务（OutsourceMaterialReceiptService），处理委外加工完成后的成品
  - 实现委外费用管理服务（OutsourceCostService），自动生成应付单（委外费用）
- **前端**：
  - 使用ListPageTemplate和UniTable实现委外工单管理页面
  - 使用ProForm实现委外工单表单
  - 实现委外发料页面
  - 实现委外收货页面
  - 显示委外费用信息

**测试用例：**

1. **测试委外工单创建**
   - 创建委外工单（需要委外供应商和委外工序）
   - 验证委外工单信息正确

2. **测试委外发料**
   - 创建委外发料单（提供给委外供应商的原材料）
   - 验证原材料库存自动扣减
   - 验证委外发料单与委外工单关联

3. **测试委外收货**
   - 创建委外收货单（委外加工完成后的成品）
   - 验证成品库存自动增加
   - 验证委外费用自动生成应付单

4. **测试委外费用管理**
   - 验证委外费用自动计算（委外数量 × 委外单价）
   - 验证委外费用自动生成应付单
   - 验证委外费用与委外工单关联

**验收标准：**
- ✅ 可以创建委外工单（需要委外供应商和委外工序）
- ✅ 委外发料流程完整（原材料库存自动扣减）
- ✅ 委外收货流程完整（成品库存自动增加）
- ✅ 委外费用自动计算和生成应付单
- ✅ 委外工单与委外发料、委外收货、委外费用关联

**完成标记：**
- [ ] 委外工单模型已设计
- [ ] 委外工单服务已实现
- [ ] 委外发料服务已实现
- [ ] 委外收货服务已实现
- [ ] 委外费用管理服务已实现
- [ ] 后端API已实现
- [ ] 前端页面已实现
- [ ] 数据库迁移已完成
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过
- [ ] 功能测试已通过

**相关文件：**
- 后端模型：`apps/kuaizhizao/models/outsource_work_order.py`
- 后端服务：`apps/kuaizhizao/services/outsource_work_order_service.py`
- 后端API：`apps/kuaizhizao/api/production.py`
- 前端页面：`apps/kuaizhizao/pages/outsource-work-orders/index.tsx`
- 前端服务：`apps/kuaizhizao/services/production.ts`
- 前端：使用Ant Design的Tag组件展示工单状态
- 前端：使用Ant Design的Timeline组件展示状态流转历史
- 前端：添加状态流转Modal，支持选择目标状态、填写流转原因和备注

**测试用例：**
1. 测试工单状态流转
2. 测试状态流转规则验证
3. 测试状态流转日志记录
4. 测试状态流转权限控制

**验收标准：**
- ✅ 工单状态可以正常流转
- ✅ 状态流转规则验证正确
- ✅ 状态流转日志记录完整
- ✅ 状态流转权限控制正确（TODO: 后续实现Inngest工作流触发）

**完成标记：**
- [x] 状态机模型已设计（工单状态定义：draft/released/in_progress/completed/cancelled）
- [x] 状态流转服务已实现（扩展StateTransitionService支持工单类型）
- [x] 状态流转API已实现（支持工单状态流转，自动更新时间字段）
- [x] 状态流转前端页面已实现（状态Tag、状态流转按钮、状态流转历史Timeline、状态流转Modal）
- [ ] 单元测试已编写并通过（TODO: 后续补充）
- [ ] 集成测试已通过（TODO: 后续补充）

---

## 步骤2.2：报工高级功能

**目标：** 实现报工高级功能，包括数据修正、统计分析、工站上下料物料绑定等

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成（报工基础功能已实现）

---

### 功能点2.2.1：报工数据修正功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工数据修正功能，支持修正已提交的报工记录数据，记录修正原因和修正历史。

**技术实现：**
- 后端：在ReportingService中实现correct_reporting_data方法，支持修正报工数据
- 后端：修正历史记录在remarks字段中，格式为"[数据修正] 时间 由 修正人 修正，原因：修正原因"
- 后端：权限控制（只有组织管理员可以修正报工数据）
- 后端：修正数量相关字段后自动重新计算工单进度
- 前端：在报工管理页面添加修正按钮（待审核和已审核状态都可以修正）
- 前端：使用Modal实现修正表单，支持修正报工数量、合格数量、不合格数量、工时等字段

**测试用例：**
- 测试报工数据修正
- 测试修正记录查询（通过查看报工记录详情中的remarks字段）
- 测试修正权限验证（只有组织管理员可以修正）
- 测试修正后工单进度重新计算

**验收标准：**
- ✅ 可以修正报工数据（支持修正报工数量、合格数量、不合格数量、工时等字段）
- ✅ 修正记录可以查询（修正历史记录在remarks字段中，可通过查看报工记录详情查询）
- ✅ 修正后数据正确（修正后会重新计算工单进度）
- ✅ 权限控制正确（只有组织管理员可以修正报工数据）
- ✅ 修正原因必填验证

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（ReportingService.correct_reporting_data）
  - [x] 后端API已实现 ✅（PUT /reporting/{record_id}/correct）
  - [x] 前端页面已实现 ✅（报工管理页面，修正按钮和修正Modal）
  - [x] 前后端对接完成 ✅（reportingApi.correct）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用ProForm）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.2：报工统计分析功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工统计分析功能，支持按日期范围查询报工统计数据，包括效率分析、工时统计、异常分析等。

**技术实现：**
- 后端：在ReportingService中实现get_reporting_statistics方法，支持按日期范围统计
- 后端：统计指标包括总报工次数、总报工数量、合格率、不合格率、平均效率、按工序统计、按操作工统计等
- 前端：创建报工统计分析页面（reporting/statistics/index.tsx）
- 前端：使用Ant Design的Statistic组件展示统计概览
- 前端：使用Ant Design Charts的Bar组件展示按工序和按操作工的统计图表
- 前端：使用Ant Design的Table组件展示详细的统计表格

**测试用例：**
- 测试报工统计查询（按日期范围）
- 测试统计数据准确性（总数、合格率、效率等）
- 测试图表展示（按工序、按操作工）

**验收标准：**
- ✅ 可以查询报工统计（支持按日期范围筛选）
- ✅ 统计数据准确（总报工次数、总报工数量、合格率、不合格率、平均效率等）
- ✅ 支持图表展示（按工序统计图表、按操作工统计图表）
- ✅ 支持详细统计表格展示（按工序Top 10、按操作工Top 10）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（ReportingService.get_reporting_statistics）
  - [x] 后端API已实现 ✅（GET /reporting/statistics）
  - [x] 前端页面已实现 ✅（reporting/statistics/index.tsx，包含统计概览、图表展示、详细表格）
  - [x] 前后端对接完成 ✅（reportingApi.getStatistics）
  - [x] 代码规范性检查通过 ✅（使用Ant Design Charts和Table组件）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.3：工站上下料物料绑定功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工站上下料物料绑定功能，支持在报工记录中绑定上料和下料物料信息。

**技术实现：**
- 后端：创建MaterialBinding模型，支持上料（feeding）和下料（discharging）两种绑定类型
- 后端：实现MaterialBindingService服务，支持从报工记录创建物料绑定记录
- 后端：实现物料绑定API接口（POST /reporting/{record_id}/material-binding/feeding, POST /reporting/{record_id}/material-binding/discharging）
- 后端：支持扫码绑定和手动选择两种绑定方式
- 前端：在报工页面添加工站上下料物料绑定功能
- 前端：使用Modal实现物料绑定表单，支持选择物料、输入数量、批次号、条码等
- 前端：在扫码报工Modal中显示上料和下料绑定列表

**测试用例：**
- 测试上料绑定（从报工记录创建上料绑定）
- 测试下料绑定（从报工记录创建下料绑定）
- 测试扫码绑定（通过条码绑定物料）
- 测试手动选择绑定（通过物料选择器绑定）
- 测试库存更新（TODO: 待库存服务实现后补充）

**验收标准：**
- ✅ 可以绑定上料物料（支持扫码和手动选择）
- ✅ 可以绑定下料物料（支持扫码和手动选择）
- ✅ 绑定记录可以查询（通过报工记录ID查询）
- ✅ 绑定记录可以删除（软删除）
- ⏳ 绑定后库存自动更新（TODO: 待库存服务实现后补充）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（MaterialBinding模型）
  - [x] 后端服务已实现 ✅（MaterialBindingService）
  - [x] 后端API已实现 ✅（POST /reporting/{record_id}/material-binding/feeding, POST /reporting/{record_id}/material-binding/discharging, GET /reporting/{record_id}/material-binding, DELETE /material-binding/{binding_id}）
  - [x] 前端页面已实现 ✅（报工页面，物料绑定Modal和列表展示）
  - [x] 前后端对接完成 ✅（materialBindingApi服务）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用ProForm）
  - [ ] 库存更新功能待实现（TODO: 待库存服务实现后补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.4：带参数报工功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现带参数报工功能，支持根据工序关联的SOP配置动态收集报工参数，并将参数数据存储到报工记录中。

**技术实现：**
- 后端：ReportingRecord模型包含sop_parameters字段（JSON格式），用于存储SOP参数数据
- 后端：ReportingService在创建报工记录时保存sop_parameters字段
- 后端：报工记录详情API返回sop_parameters字段，支持参数查询
- 前端：根据工序关联的SOP配置动态渲染参数收集表单（renderSOPParameters函数）
- 前端：支持多种表单组件类型（Input、TextArea、InputNumber、Select、DatePicker、Switch、Radio.Group等）
- 前端：在报工提交时收集SOP参数并发送到后端
- 前端：支持SOP参数必填验证

**测试用例：**
- 测试带参数报工（根据SOP配置收集参数）
- 测试参数数据存储（sop_parameters字段正确保存）
- 测试参数查询（通过报工记录详情API查询参数）
- 测试参数必填验证（SOP必填参数验证）

**验收标准：**
- ✅ 可以带参数报工（根据工序关联的SOP配置动态收集参数）
- ✅ 参数数据正确存储（sop_parameters字段以JSON格式存储）
- ✅ 参数可以查询（通过报工记录详情API可以查询到sop_parameters）
- ✅ 参数可以分析（可以通过查询报工记录列表，在前端分析SOP参数数据）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（ReportingRecord模型包含sop_parameters字段）
  - [x] 后端服务已实现 ✅（ReportingService.create_reporting_record保存sop_parameters）
  - [x] 后端API已实现 ✅（GET /reporting/{record_id}返回sop_parameters字段）
  - [x] 前端页面已实现 ✅（报工页面，SOP参数收集表单renderSOPParameters）
  - [x] 前后端对接完成 ✅（报工提交时收集并发送SOP参数）
  - [x] 代码规范性检查通过 ✅（使用ProForm组件，支持多种表单类型）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.5：工序报废处理功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工序报废处理功能，包括创建报废单、报废审批、报废处理和报废统计分析。

**技术实现：**
- 后端：创建ScrapRecordService服务，实现报废审批和统计分析功能
- 后端：实现报废审批API（POST /scrap/{scrap_id}/approve），支持同意/不同意审批
- 后端：审批同意后自动更新工单数量（扣减报废数量）和工单不合格数量
- 后端：实现报废统计分析API（GET /scrap/statistics），支持按工单、工序、物料、时间段统计
- 后端：实现报废记录列表查询API（GET /scrap），支持多条件筛选
- 后端：自动记录报废成本（基于物料成本，unit_cost * scrap_quantity）
- 前端：在报工页面添加创建报废记录功能（已实现）
- 前端：TODO: 添加报废记录管理页面（列表、审批）
- 前端：TODO: 添加报废统计分析页面（图表、报表）

**测试用例：**
- 测试从报工记录创建报废单
- 测试手动创建报废单
- 测试工序报废审批流程（同意/不同意）
- 测试报废后工单数量和库存更新
- 测试报废成本计算
- 测试报废统计分析（按工单、工序、物料、时间段）

**验收标准：**
- ✅ 可以从报工记录一键创建报废单（自动填充关联信息）
- ✅ 可以手动创建报废单（通过报工页面）
- ✅ 支持工序报废审批（同意/不同意，POST /scrap/{scrap_id}/approve）
- ✅ 审批同意后自动更新工单数量（扣减报废数量）
- ✅ 审批同意后自动更新工单不合格数量（从报废记录统计）
- ⏳ 审批同意后自动更新库存（不良品库存，TODO: 待库存服务实现后补充）
- ✅ 自动记录报废成本（基于物料成本，unit_cost * scrap_quantity）
- ✅ 支持报废统计分析（按工单、工序、物料、时间段统计报废率和报废成本，GET /scrap/statistics）
- ⏳ 支持导出报废统计报表（Excel，TODO: 后续补充）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（ScrapRecordService，包含审批和统计分析功能）
  - [x] 后端API已实现 ✅（POST /scrap/{scrap_id}/approve, GET /scrap, GET /scrap/statistics）
  - [x] 报废审批功能已实现 ✅（支持同意/不同意，自动更新工单数量）
  - [x] 报废统计分析功能已实现 ✅（按工单、工序、物料、时间段统计）
  - [x] 前端创建报废记录功能已实现 ✅（报工页面）
  - [ ] 前端报废记录管理页面待实现（TODO: 后续补充）
  - [ ] 前端报废统计分析页面待实现（TODO: 后续补充）
  - [ ] 库存更新功能待实现（TODO: 待库存服务实现后补充）
  - [ ] 导出Excel报表功能待实现（TODO: 后续补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.6：工序不良品处理功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工序不良品处理功能，包括创建不良品记录、不良品处理（返工/报废/让步接收）和不良品统计分析。

**技术实现：**
- 后端：创建DefectRecordService服务，实现让步接收审批和统计分析功能
- 后端：实现不良品让步接收审批API（POST /defect/{defect_id}/approve-acceptance），支持同意/不同意审批
- 后端：审批同意后允许继续下一工序（状态更新为processed）
- 后端：实现不良品统计分析API（GET /defect/statistics），支持按工单、工序、物料、不良品类型、时间段统计
- 后端：实现不良品记录列表查询API（GET /defect），支持多条件筛选
- 后端：支持不良品返工处理（自动创建返工单，已实现）
- 后端：支持不良品报废处理（自动创建报废单，已实现）
- 前端：在报工页面添加创建不良品记录功能（已实现）
- 前端：TODO: 添加不良品记录管理页面（列表、审批）
- 前端：TODO: 添加不良品统计分析页面（图表、报表）

**测试用例：**
- 测试从报工记录创建不良品记录
- 测试手动创建不良品记录
- 测试不良品返工处理（创建返工单）
- 测试不良品报废处理（创建报废单）
- 测试不良品让步接收（审批流程）
- 测试不良品统计分析（按工单、工序、物料、不良品类型、时间段）

**验收标准：**
- ✅ 可以从报工记录一键创建不良品记录（自动填充关联信息）
- ✅ 可以手动创建不良品记录（通过报工页面）
- ✅ 支持不良品返工处理（自动创建返工单，关联原工单和原工序）
- ✅ 支持不良品报废处理（自动创建报废单，更新工单数量和库存）
- ✅ 支持不良品让步接收（需要审批，审批通过后允许继续下一工序，POST /defect/{defect_id}/approve-acceptance）
- ✅ 支持不良品统计分析（按工单、工序、物料、不良品类型、时间段统计不良品率，GET /defect/statistics）
- ⏳ 支持导出不良品统计报表（Excel，TODO: 后续补充）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（DefectRecordService，包含让步接收审批和统计分析功能）
  - [x] 后端API已实现 ✅（POST /defect/{defect_id}/approve-acceptance, GET /defect, GET /defect/statistics）
  - [x] 不良品返工处理已实现 ✅（自动创建返工单）
  - [x] 不良品报废处理已实现 ✅（自动创建报废单）
  - [x] 不良品让步接收审批功能已实现 ✅（支持同意/不同意，审批通过后允许继续下一工序）
  - [x] 不良品统计分析功能已实现 ✅（按工单、工序、物料、不良品类型、时间段统计）
  - [x] 前端创建不良品记录功能已实现 ✅（报工页面）
  - [ ] 前端不良品记录管理页面待实现（TODO: 后续补充）
  - [ ] 前端不良品统计分析页面待实现（TODO: 后续补充）
  - [ ] 导出Excel报表功能待实现（TODO: 后续补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.7：按状态报工功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现按状态报工功能，支持按状态报工模式（完成/未完成），适配工位机触屏模式。

**技术实现：**
- 后端：WorkOrderOperation模型包含reporting_type字段（quantity/status），支持按状态报工
- 后端：ReportingService根据reporting_type验证数据，按状态报工时reported_quantity只能是0或1
- 后端：按状态报工时，reported_quantity=1表示完成，自动更新工序状态为completed
- 前端：报工页面根据reporting_type显示不同的报工表单（按状态报工显示完成/未完成单选按钮）
- 前端：支持工序跳转规则校验（检查上道工序是否完成）
- 前端：报工成功后自动切换到下一工序（自动加载下一工序的SOP）
- 前端：TODO: 触屏优化界面（大按钮、大字体、全屏模式，后续补充）

**测试用例：**
- 测试按状态报工模式（完成/未完成）
- 测试工序类型自动判断（按状态报工）
- 测试触屏优化界面（大按钮、大字体）
- 测试带参数SOP的参数收集表单
- 测试工序跳转规则校验

**验收标准：**
- ✅ 支持按状态报工模式（完成/未完成）
- ✅ 系统根据工序类型自动判断报工模式（按状态报工，reporting_type字段）
- ✅ 支持带参数SOP的参数收集表单（已实现）
- ✅ 支持工序跳转规则校验（检查上道工序是否完成）
- ✅ 报工成功后自动切换到下一工序（自动加载下一工序的SOP）
- ⏳ 触屏优化界面（大按钮、大字体、全屏模式，TODO: 后续补充）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（WorkOrderOperation模型包含reporting_type字段）
  - [x] 后端服务已实现 ✅（ReportingService支持按状态报工验证）
  - [x] 后端API已实现 ✅（报工API支持按状态报工）
  - [x] 前端页面已实现 ✅（报工页面，根据reporting_type显示不同表单）
  - [x] 工序跳转规则校验已实现 ✅（checkJumpRule函数）
  - [x] 自动切换到下一工序已实现 ✅（报工成功后自动切换）
  - [ ] 触屏优化界面待实现（TODO: 后续补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.8：报工快速操作

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工快速操作功能，包括快速报工按钮、一键报工等。

**技术实现：**
- 前端：在报工列表页面添加快速报工按钮（大按钮，适配触屏模式）
- 前端：实现快速报工Modal，支持快速选择工单和工序
- 前端：自动加载进行中的工单列表，自动选择第一个未完成的工序
- 前端：根据工序报工类型（按数量/按状态）显示不同的报工表单
- 前端：使用大字体、大按钮适配触屏模式
- 后端：复用现有报工API（POST /reporting），无需新增服务

**测试用例：**
1. 测试快速报工按钮
2. 测试一键报工功能（选择工单和工序后快速报工）
3. 测试快速报工数据验证
4. 测试触屏模式适配（大按钮、大字体）

**验收标准：**
- ✅ 快速报工按钮可以正常使用（在报工列表页面工具栏）
- ✅ 一键报工功能正常（快速选择工单和工序，使用默认值快速报工）
- ✅ 快速报工数据验证正确（必填字段验证、数量验证等）
- ✅ 快速报工界面友好（适配触屏模式，大按钮、大字体）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 快速报工按钮已实现 ✅（报工列表页面工具栏，大按钮）
  - [x] 快速报工Modal已实现 ✅（支持选择工单和工序）
  - [x] 自动加载工单和工序已实现 ✅（自动加载进行中的工单，自动选择第一个未完成的工序）
  - [x] 快速报工表单已实现 ✅（根据报工类型显示不同表单，支持按数量/按状态报工）
  - [x] 触屏模式适配已实现 ✅（大按钮、大字体、大输入框）
  - [x] 前后端对接完成 ✅（复用现有报工API）
  - [x] 代码规范性检查通过 ✅（使用FormModalTemplate和ProForm组件）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.2.9：报工自动填充

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工自动填充功能，根据工艺路线自动填充报工数据。

**技术实现：**
- 前端：在扫码报工Modal中实现自动填充功能（handleSelectOperation函数）
- 前端：在快速报工Modal中实现自动填充功能（工单选择和工序选择时）
- 前端：根据工序的标准工时（standard_time）自动计算并填充工时
- 前端：根据工单数量和工序已完成数量自动计算并填充完成数量（剩余数量）
- 前端：按数量报工时，默认合格数量等于完成数量
- 前端：按状态报工时，默认选择"完成"状态
- 前端：用户可以修改自动填充的数据（所有字段都可以编辑）

**测试用例：**
1. 测试根据工艺路线自动填充报工数据（扫码报工和快速报工）
2. 测试自动填充数据准确性（工时计算、数量计算）
3. 测试用户可以修改自动填充的数据（所有字段都可以编辑）

**验收标准：**
- ✅ 根据工艺路线自动填充报工数据（扫码报工和快速报工都支持）
- ✅ 自动填充数据准确（工时=标准工时×工单数量，完成数量=工单数量-已完成数量）
- ✅ 用户可以修改自动填充的数据（所有字段都可以编辑）
- ✅ 自动填充提升报工效率（减少手动输入，提高报工速度）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 扫码报工自动填充已实现 ✅（handleSelectOperation函数中，根据标准工时和工单数量自动填充）
  - [x] 快速报工自动填充已实现 ✅（工单选择和工序选择时自动填充）
  - [x] 工时自动填充已实现 ✅（标准工时×工单数量）
  - [x] 完成数量自动填充已实现 ✅（工单数量-已完成数量）
  - [x] 合格数量自动填充已实现 ✅（默认等于完成数量）
  - [x] 按状态报工自动填充已实现 ✅（默认选择"完成"状态）
  - [x] 用户可以修改自动填充的数据 ✅（所有字段都可以编辑）
  - [x] 代码规范性检查通过 ✅（使用ProForm组件，遵循前端开发规范）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

**测试用例：**
- 测试按状态报工模式（完成/未完成）
- 测试工序类型自动判断（按状态报工）
- 测试触屏优化界面（大按钮、大字体）
- 测试带参数SOP的参数收集表单
- 测试工序跳转规则校验

**验收标准：**
- ✅ 支持按状态报工模式（完成/未完成）
- ✅ 系统根据工序类型自动判断报工模式（按状态报工）
- ✅ 触屏优化界面（大按钮、大字体、全屏模式）
- ✅ 支持带参数SOP的参数收集表单（触屏优化）
- ✅ 支持工序跳转规则校验（检查上道工序是否完成）
- ✅ 报工成功后自动切换到下一工序

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 步骤2.3：仓储高级功能

**目标：** 实现仓储高级功能，包括库存盘点、调拨、装箱打包绑定等

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成（基础仓储功能已实现）

---

### 功能点2.3.1：库存盘点流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存盘点流程，包括创建盘点单、添加盘点明细、执行盘点、处理差异等。

**技术实现：**
- 后端：完善库存盘点服务方法（update_stocktaking、start_stocktaking、create_stocktaking_item、update_stocktaking_item）
- 后端：添加库存盘点API路由（创建、列表、详情、更新、开始盘点、添加明细、执行明细、处理差异）
- 后端：修复list_stocktakings方法返回类型（返回包含items和total的响应对象）
- 前端：创建库存盘点管理页面（使用ListPageTemplate和UniTable）
- 前端：创建库存盘点服务API（stocktakingApi）
- 前端：实现盘点单创建、详情查看、添加明细、执行盘点、处理差异等功能

**测试用例：**
- 测试创建盘点单
- 测试添加盘点明细
- 测试开始盘点
- 测试执行盘点明细（记录实际数量）
- 测试处理盘点差异（调整库存）

**验收标准：**
- ✅ 可以创建盘点单（支持全盘、抽盘、循环盘点）
- ✅ 可以添加盘点明细（物料、账面数量、单价等）
- ✅ 可以开始盘点（将状态从draft改为in_progress）
- ✅ 可以执行盘点明细（记录实际数量，自动计算差异数量和差异金额）
- ✅ 可以处理盘点差异（调整库存，将状态改为completed）
- ✅ 盘点单详情可以查看（包含明细列表）
- ✅ 盘点单列表支持筛选（按仓库、状态、类型等）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（StocktakingService，包含所有必要方法）
  - [x] 后端API已实现 ✅（production.py，包含所有盘点相关路由）
  - [x] 前端页面已实现 ✅（warehouse-management/stocktaking/index.tsx）
  - [x] 前端服务已实现 ✅（stocktaking.ts）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用FormModalTemplate和DetailDrawerTemplate）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.3.2：库存调拨流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存调拨流程，包括创建调拨单、添加调拨明细、执行调拨、库存更新等。

**技术实现：**
- 后端：创建库存调拨模型（InventoryTransfer、InventoryTransferItem）
- 后端：创建库存调拨Schema（包含所有请求和响应Schema）
- 后端：创建库存调拨服务（InventoryTransferService，包含所有业务逻辑）
- 后端：添加库存调拨API路由（创建、列表、详情、更新、添加明细、更新明细、执行调拨）
- 前端：创建库存调拨管理页面（使用ListPageTemplate和UniTable）
- 前端：创建库存调拨服务API（inventoryTransferApi）
- 前端：实现调拨单创建、详情查看、添加明细、执行调拨等功能

**测试用例：**
- 测试创建调拨单（验证调出和调入仓库不能相同）
- 测试添加调拨明细（物料、数量、单价等）
- 测试执行调拨（更新库存，将状态改为completed）
- 测试调拨单详情查看（包含明细列表）
- 测试调拨单列表筛选（按仓库、状态等）

**验收标准：**
- ✅ 可以创建调拨单（支持调出仓库、调入仓库、调拨日期、调拨原因等）
- ✅ 可以添加调拨明细（物料、调拨数量、单价、库位、批次号等）
- ✅ 可以执行调拨（更新库存，将状态改为completed）
- ✅ 调拨后库存正确更新（TODO: 待库存服务实现后补充）
- ✅ 调拨单详情可以查看（包含明细列表）
- ✅ 调拨单列表支持筛选（按调出仓库、调入仓库、状态等）
- ✅ 调拨单号自动生成（TR-日期-序号）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（InventoryTransfer、InventoryTransferItem模型）
  - [x] 后端Schema已设计 ✅（包含所有请求和响应Schema）
  - [x] 后端服务已实现 ✅（InventoryTransferService，包含所有业务逻辑）
  - [x] 后端API已实现 ✅（production.py，包含所有调拨相关路由）
  - [x] 前端页面已实现 ✅（warehouse-management/inventory-transfer/index.tsx）
  - [x] 前端服务已实现 ✅（inventory-transfer.ts）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用FormModalTemplate和DetailDrawerTemplate）
- [ ] 单元测试已编写并通过（TODO: 后续补充）
- [ ] 库存更新功能待实现（TODO: 待库存服务实现后补充）

---

### 功能点2.3.3：装箱打包绑定功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现装箱打包绑定功能，包括从成品入库单创建装箱绑定、装箱码自动生成、产品序列号绑定等。

**技术实现：**
- 后端：完善装箱绑定服务（添加装箱码自动生成、列表查询、详情查询、更新功能）
- 后端：添加装箱绑定管理API路由（列表、详情、更新、删除）
- 后端：装箱码自动生成（支持编码规则和简单格式，格式：BOX-日期-序号）
- 前端：创建装箱绑定管理页面（使用ListPageTemplate和UniTable）
- 前端：创建装箱绑定服务API（packingBindingApi）

**测试用例：**
- 测试从成品入库单创建装箱绑定
- 测试装箱码自动生成（未提供箱号时自动生成）
- 测试产品序列号绑定到装箱号
- 测试装箱绑定记录查询（列表、详情）
- 测试装箱绑定记录更新和删除

**验收标准：**
- ✅ 可以从成品入库单创建装箱绑定（产品、装箱数量、包装物料、序列号等）
- ✅ 装箱码自动生成（未提供箱号时自动生成，格式：BOX-日期-序号）
- ✅ 产品序列号可以绑定到装箱号
- ✅ 装箱绑定记录可以查询（列表、详情）
- ✅ 装箱绑定记录可以更新（装箱数量、箱号、备注）
- ✅ 装箱绑定记录可以删除（软删除）
- ✅ 支持扫码绑定和手动绑定两种方式

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（PackingBinding模型）
  - [x] 后端Schema已设计 ✅（包含所有请求和响应Schema）
  - [x] 后端服务已实现 ✅（PackingBindingService，包含装箱码自动生成）
  - [x] 后端API已实现 ✅（production.py，包含从入库单创建、列表、详情、更新、删除）
  - [x] 前端页面已实现 ✅（warehouse-management/packing-binding/index.tsx）
  - [x] 前端服务已实现 ✅（packing-binding.ts）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用FormModalTemplate和DetailDrawerTemplate）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.3.4：客户来料登记功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现客户来料登记功能，包括客户来料登记、条码解析、条码映射、客户编码映射等。

**技术实现：**
- 后端：完善客户来料登记服务（添加详情查询、处理入库、取消功能）
- 后端：添加客户来料登记管理API路由（详情、处理、取消）
- 后端：实现条码解析和映射功能（支持一维码和二维码，自动映射到内部物料）
- 后端：实现条码映射规则管理（BarcodeMappingRuleService）
- 前端：创建客户来料登记管理页面（使用ListPageTemplate和UniTable）
- 前端：创建客户来料登记服务API（customerMaterialRegistrationApi）
- 前端：实现条码解析功能（自动解析客户条码并映射到内部物料）

**测试用例：**
- 测试客户来料登记（手动填写和扫码登记）
- 测试条码解析（一维码和二维码）
- 测试客户编码映射（条码映射规则）
- 测试处理入库（将待处理状态更新为已处理）
- 测试取消登记（将待处理状态更新为已取消）

**验收标准：**
- ✅ 可以登记客户来料（支持手动填写和扫码登记）
- ✅ 支持条码解析（一维码和二维码，自动解析并映射到内部物料）
- ✅ 支持客户编码映射（通过条码映射规则自动映射）
- ✅ 可以查看客户来料登记列表（支持按客户、状态、日期筛选）
- ✅ 可以查看客户来料登记详情
- ✅ 可以处理客户来料登记（入库，将状态更新为已处理）
- ✅ 可以取消客户来料登记（将状态更新为已取消）
- ⏳ 处理入库后自动更新库存（TODO: 待库存服务实现后补充）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（CustomerMaterialRegistration、BarcodeMappingRule模型）
  - [x] 后端Schema已设计 ✅（包含所有请求和响应Schema）
  - [x] 后端服务已实现 ✅（CustomerMaterialRegistrationService、BarcodeMappingRuleService）
  - [x] 后端API已实现 ✅（production.py，包含条码解析、登记、列表、详情、处理、取消）
  - [x] 前端页面已实现 ✅（warehouse-management/customer-material-registration/index.tsx）
  - [x] 前端服务已实现 ✅（customer-material-registration.ts）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用FormModalTemplate和DetailDrawerTemplate）
  - [ ] 库存更新功能待实现（TODO: 待库存服务实现后补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.3.5：库存预警功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存预警功能，包括库存预警规则配置、库存预警记录管理、预警处理、预警统计等。

**技术实现：**
- 后端：完善库存预警服务（添加规则详情查询、更新、删除、预警统计功能）
- 后端：添加库存预警管理API路由（规则和预警记录的CRUD、预警处理、统计）
- 后端：支持预警级别配置（低库存、高库存、过期等）
- 后端：支持预警类型配置（low_stock/high_stock/expired）
- 前端：创建库存预警管理页面（使用ListPageTemplate和UniTable）
- 前端：创建库存预警服务API（inventoryAlertApi）
- 前端：实现预警规则配置和预警记录管理功能
- 前端：实现预警统计信息展示（使用Statistic组件）

**测试用例：**
1. 测试创建库存预警规则（低库存、高库存、过期）
2. 测试预警规则配置（阈值类型、阈值数值、通知配置）
3. 测试预警记录查询（按类型、级别、状态筛选）
4. 测试预警处理（处理中、已解决、已忽略）
5. 测试预警统计信息（按类型、级别、状态统计）

**验收标准：**
- ✅ 可以创建库存预警规则（支持低库存、高库存、过期三种类型）
- ✅ 可以配置预警规则（阈值类型、阈值数值、通知用户/角色）
- ✅ 可以查看预警记录列表（支持按类型、级别、状态、物料、仓库筛选）
- ✅ 可以查看预警记录详情
- ✅ 可以处理预警（处理中、已解决、已忽略）
- ✅ 可以查看预警统计信息（按类型、级别、状态统计）
- ⏳ 预警自动触发功能待实现（TODO: 待库存服务实现后补充，通过定时任务或事件触发）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（InventoryAlertRule、InventoryAlert模型）
  - [x] 后端Schema已设计 ✅（包含所有请求和响应Schema）
  - [x] 后端服务已实现 ✅（InventoryAlertRuleService、InventoryAlertService）
  - [x] 后端API已实现 ✅（production.py，包含规则和预警记录的CRUD、预警处理、统计）
  - [x] 前端页面已实现 ✅（warehouse-management/inventory-alert/index.tsx）
  - [x] 前端服务已实现 ✅（inventory-alert.ts）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用FormModalTemplate和DetailDrawerTemplate）
  - [ ] 预警自动触发功能待实现（TODO: 待库存服务实现后补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.3.6：库存报表分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存报表分析功能，包括库存周转率、库存成本分析等。

**技术实现：**
- 后端：实现库存报表分析服务（InventoryReportService）
- 前端：使用Ant Design的Charts组件展示库存报表
- 前端：使用UniTable展示库存报表数据

**测试用例：**
1. 测试库存周转率计算
2. 测试库存成本分析
3. 测试库存报表导出

**验收标准：**
- ✅ 库存周转率计算准确
- ✅ 库存成本分析准确
- ✅ 库存报表可以导出
- ✅ 库存报表支持图表展示

**完成标记：**
- [ ] 库存报表分析服务已实现
- [ ] 库存报表分析API已实现
- [ ] 库存报表分析前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

**验收标准：**
- ✅ 可以登记客户来料
- ✅ 客户编码可以映射
- ✅ 客户来料可以入库

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

## 步骤2.4：单据执行效率优化

**目标：** 实现单据执行效率优化，包括耗时统计和分析

**时间估算：** 1周

**前置条件：**
- ✅ 第一阶段已完成（单据关联已实现）

---

### 功能点2.4.1：单据节点耗时统计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现单据节点耗时统计功能，包括节点时间记录、耗时计算、耗时统计查询等。

**技术实现：**
- 后端：实现单据节点耗时统计服务（DocumentTimingService）
- 后端：支持记录节点开始和结束时间，自动计算耗时（排除非工作时间）
- 后端：添加单据耗时统计API路由（列表、详情）
- 前端：创建单据耗时统计页面（document-timing/index.tsx）
- 前端：使用ListPageTemplate和UniTable展示单据耗时列表
- 前端：使用DetailDrawerTemplate展示单据节点耗时明细

**测试用例：**
- 测试节点时间记录（record_node_start、record_node_end）
- 测试耗时计算（基于工作时间段，排除非工作时间）
- 测试耗时统计查询（列表、详情）

**验收标准：**
- ✅ 节点时间自动记录（开始时间、结束时间）
- ✅ 耗时计算准确（基于工作时间段，排除非工作时间）
- ✅ 耗时统计可以查询（列表、详情）
- ✅ 支持查看单据各个节点的耗时明细

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（DocumentTimingService）
  - [x] 后端API已实现 ✅（production.py，包含列表、详情）
  - [x] 前端页面已实现 ✅（warehouse-management/document-timing/index.tsx）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用DetailDrawerTemplate）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.4.2：单据执行效率分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现单据执行效率分析功能，包括平均耗时、瓶颈节点识别、优化建议生成等。

**技术实现：**
- 后端：在DocumentTimingService中实现get_document_efficiency方法
- 后端：支持按单据类型、日期范围筛选分析
- 后端：自动识别瓶颈节点（耗时最长的前3个节点）
- 后端：自动生成优化建议（基于瓶颈节点和异常耗时）
- 后端：添加单据执行效率分析API路由
- 前端：创建单据执行效率分析页面（document-efficiency/index.tsx）
- 前端：使用Ant Design Charts组件展示节点耗时统计图表
- 前端：展示平均耗时、瓶颈节点、优化建议、节点详细统计

**测试用例：**
- 测试效率分析查询（按单据类型、日期范围）
- 测试效率分析准确性（平均耗时、瓶颈节点、优化建议）
- 测试图表展示（节点耗时统计图表）

**验收标准：**
- ✅ 可以分析单据执行效率（按单据类型、日期范围筛选）
- ✅ 效率分析数据准确（平均耗时、瓶颈节点、优化建议）
- ✅ 支持图表展示（节点耗时统计图表，使用Column图表）
- ✅ 支持瓶颈节点识别（自动识别耗时最长的前3个节点）
- ✅ 支持优化建议生成（基于瓶颈节点和异常耗时）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端服务已实现 ✅（DocumentTimingService.get_document_efficiency）
  - [x] 后端API已实现 ✅（GET /documents/efficiency）
  - [x] 前端页面已实现 ✅（warehouse-management/document-efficiency/index.tsx）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate，使用Ant Design Charts组件）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

### 功能点2.4.3：工作时间段配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工作时间段配置功能，支持按仓库、工作中心、部门或全部设置工作时间段，用于单据节点耗时统计。

**技术实现：**
- 后端：创建工作时间段配置模型（WorkingHoursConfig），支持按仓库、工作中心、部门或全部配置
- 后端：实现工作时间段配置服务（WorkingHoursConfigService），包含CRUD和耗时计算功能
- 后端：支持按周几、日期范围配置不同的工作时间段
- 后端：支持优先级配置（数字越大优先级越高）
- 后端：添加工作时间段配置API路由（CRUD）
- 前端：创建工作时间段配置管理页面（system/working-hours-configs/index.tsx）
- 前端：使用ProForm实现工作时间段配置表单
- 前端：使用Ant Design的TimePicker组件选择时间段

**测试用例：**
1. 测试按仓库配置工作时间段
2. 测试按工作中心配置工作时间段
3. 测试按部门配置工作时间段
4. 测试按全部配置工作时间段
5. 测试工作时间段格式验证
6. 测试工作时间段在耗时统计中的应用（calculate_working_hours方法）

**验收标准：**
- ✅ 可以按仓库配置工作时间段
- ✅ 可以按工作中心配置工作时间段
- ✅ 可以按部门配置工作时间段
- ✅ 可以按全部配置工作时间段
- ✅ 工作时间段格式验证正确（JSON格式，包含start和end时间）
- ✅ 单据节点耗时统计使用工作时间段配置（calculate_working_hours方法）
- ⏳ 工作时间段配置支持批量导入（TODO: 后续补充）

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 工作时间段配置模型已设计 ✅（WorkingHoursConfig模型）
  - [x] 工作时间段配置服务已实现 ✅（WorkingHoursConfigService）
  - [x] 工作时间段配置API已实现 ✅（core/api/working_hours_configs/working_hours_configs.py）
  - [x] 工作时间段配置前端页面已实现 ✅（system/working-hours-configs/index.tsx）
  - [x] 耗时计算功能已实现 ✅（calculate_working_hours方法，排除非工作时间）
  - [x] 前后端对接完成 ✅（所有API接口已对接）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用FormModalTemplate和DetailDrawerTemplate）
  - [ ] 批量导入功能待实现（TODO: 后续补充）
- [ ] 单元测试已编写并通过（TODO: 后续补充）

---

## 步骤2.5：异常处理

**目标：** 实现异常处理功能，包括缺料、交期延期、质量异常处理

**时间估算：** 1周

**前置条件：**
- ✅ 第一阶段和第二阶段已完成

---

### 功能点2.5.1：缺料异常处理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现缺料异常处理功能。

**测试用例：**
- 测试缺料异常检测
- 测试缺料异常处理

**验收标准：**
- ✅ 可以自动检测缺料异常
- ✅ 可以处理缺料异常
- ✅ 缺料异常处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.2：交期延期异常处理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现交期延期异常处理功能。

**测试用例：**
- 测试交期延期异常检测
- 测试交期延期异常处理

**验收标准：**
- ✅ 可以自动检测交期延期异常
- ✅ 可以处理交期延期异常
- ✅ 交期延期异常处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.3：质量异常处理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现质量异常处理功能。

**测试用例：**
- 测试质量异常检测
- 测试质量异常处理

**验收标准：**
- ✅ 可以自动检测质量异常
- ✅ 可以处理质量异常
- ✅ 质量异常处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.4：异常统计分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现异常统计分析功能。

**测试用例：**
- 测试异常统计查询
- 测试统计数据准确性

**验收标准：**
- ✅ 可以查询异常统计
- ✅ 统计数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.5：异常自动检测

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现异常自动检测功能，系统自动检测异常并推送通知。

**技术实现：**
- 后端：实现异常检测服务（ExceptionDetectionService），定时检测异常
- 后端：使用Inngest工作流实现定时任务
- 前端：使用Ant Design的Badge组件展示异常数量
- 前端：使用Ant Design的Notification组件推送异常通知

**测试用例：**
1. 测试缺料异常自动检测
2. 测试交期延期异常自动检测
3. 测试质量异常自动检测
4. 测试异常通知推送

**验收标准：**
- ✅ 缺料异常自动检测正常
- ✅ 交期延期异常自动检测正常
- ✅ 质量异常自动检测正常
- ✅ 异常通知可以推送
- ✅ 异常检测支持配置检测规则

**完成标记：**
- [ ] 异常检测服务已实现
- [ ] 异常检测API已实现
- [ ] 异常检测前端页面已实现
- [ ] Inngest工作流已配置
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.5.6：异常处理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现异常处理流程，包括异常处理工作流、异常处理记录等。

**技术实现：**
- 后端：实现异常处理流程服务（ExceptionProcessService），支持工作流
- 后端：使用Inngest工作流实现异常处理流程
- 前端：使用Ant Design的Steps组件展示异常处理流程
- 前端：使用Ant Design的Timeline组件展示异常处理历史

**测试用例：**
1. 测试异常处理流程启动
2. 测试异常处理流程执行
3. 测试异常处理流程状态查询
4. 测试异常处理记录查询

**验收标准：**
- ✅ 异常处理流程可以启动
- ✅ 异常处理流程执行正常
- ✅ 异常处理流程状态可以查询
- ✅ 异常处理记录可以查询
- ✅ 异常处理流程支持自定义配置

**完成标记：**
- [ ] 异常处理流程服务已实现
- [ ] 异常处理流程API已实现
- [ ] 异常处理流程前端页面已实现
- [ ] Inngest工作流已配置
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤2.6：设备模具管理

**目标：** 实现设备模具管理功能，包括设备基础信息、维护保养、故障处理、模具管理、OEE统计

**时间估算：** 2周

**前置条件：**
- ✅ 第一阶段已完成

---

### 功能点2.6.1：设备基础信息管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备基础信息管理功能。

**测试用例：**
- 测试设备创建
- 测试设备查询

**验收标准：**
- ✅ 可以创建设备
- ✅ 可以查询设备列表
- ✅ 设备信息完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.2：设备维护保养计划管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备维护保养计划管理功能。

**测试用例：**
- 测试创建维护计划
- 测试维护计划执行

**验收标准：**
- ✅ 可以创建维护计划
- ✅ 可以执行维护计划
- ✅ 维护计划自动提醒

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.3：设备故障处理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备故障处理流程。

**测试用例：**
- 测试故障报告
- 测试故障处理

**验收标准：**
- ✅ 可以报告设备故障
- ✅ 可以处理设备故障
- ✅ 故障处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.4：模具管理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现模具管理流程。

**测试用例：**
- 测试模具创建
- 测试模具使用记录

**验收标准：**
- ✅ 可以创建模具
- ✅ 可以记录模具使用
- ✅ 模具状态管理正常

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.5：设备OEE统计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备OEE统计功能。

**测试用例：**
- 测试OEE计算
- 测试OEE统计准确性

**验收标准：**
- ✅ 可以计算设备OEE
- ✅ OEE统计数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.6：设备状态监控

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备状态监控功能，实时监控设备状态。

**技术实现：**
- 后端：实现设备状态监控服务（EquipmentStatusMonitorService），实时获取设备状态
- 后端：支持设备状态数据采集（可通过SCADA集成或手动更新）
- 前端：使用Ant Design的Badge组件展示设备状态
- 前端：使用Ant Design的Card组件展示设备状态卡片

**测试用例：**
1. 测试设备状态实时监控
2. 测试设备状态数据采集
3. 测试设备状态异常告警

**验收标准：**
- ✅ 设备状态可以实时监控
- ✅ 设备状态数据采集正常
- ✅ 设备状态异常可以告警
- ✅ 设备状态历史可以查询

**完成标记：**
- [ ] 设备状态监控服务已实现
- [ ] 设备状态监控API已实现
- [ ] 设备状态监控前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.6.7：设备维护提醒

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备维护提醒功能，维护计划到期提醒。

**技术实现：**
- 后端：实现设备维护提醒服务（EquipmentMaintenanceReminderService），定时检查维护计划
- 后端：使用Inngest工作流实现定时任务
- 前端：使用Ant Design的Badge组件展示提醒数量
- 前端：使用Ant Design的Notification组件推送维护提醒

**测试用例：**
1. 测试维护计划到期检测
2. 测试维护提醒推送
3. 测试维护提醒查询

**验收标准：**
- ✅ 维护计划到期可以检测
- ✅ 维护提醒可以推送
- ✅ 维护提醒可以查询
- ✅ 维护提醒支持提前提醒配置

**完成标记：**
- [ ] 设备维护提醒服务已实现
- [ ] 设备维护提醒API已实现
- [ ] 设备维护提醒前端页面已实现
- [ ] Inngest工作流已配置
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤2.7：成本核算

**目标：** 实现成本核算功能，包括生产成本、委外成本、质量成本核算，**基于物料来源的成本核算**（核心功能增强）

**时间估算：** 2-3周（新增物料来源成本核算）

**前置条件：**
- ✅ 第一阶段和第二阶段已完成
- ✅ 物料主数据配置已完成（物料来源类型已配置）

---

### 功能点2.7.1：生产成本核算（增强：基于物料来源）

**状态：** ⬜ 未开始

**任务描述：**
实现生产成本核算功能，**基于物料来源类型区分不同的成本计算方式**（核心功能增强）。

**技术实现：**
- **后端**：
  - 实现自制件成本核算（材料成本（BOM展开）+ 加工成本（工序成本）+ 制造费用）
  - 实现虚拟件成本核算（不单独核算，成本直接计入上层物料）
  - 实现配置件成本核算（根据选择的变体BOM，按变体计算成本）
- **前端**：
  - 在成本核算页面显示物料来源信息
  - 显示不同物料来源的成本计算方式

**测试用例：**
- 测试自制件成本计算（材料成本 + 加工成本 + 制造费用）
- 测试虚拟件成本计算（不单独核算，成本计入上层物料）
- 测试配置件成本计算（按变体BOM计算成本）
- 测试成本数据准确性

**验收标准：**
- ✅ **自制件成本核算准确**（材料成本（BOM展开）+ 加工成本（工序成本）+ 制造费用）
- ✅ **虚拟件成本核算正确**（成本直接计入上层物料，不单独核算）
- ✅ **配置件成本核算准确**（按变体BOM计算成本）
- ✅ 成本数据准确
- ✅ 支持成本分析

**完成标记：**
- [ ] 自制件成本核算逻辑已实现
- [ ] 虚拟件成本核算逻辑已实现
- [ ] 配置件成本核算逻辑已实现
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.2：委外成本核算（增强：基于物料来源）

**状态：** ⬜ 未开始

**任务描述：**
实现委外成本核算功能，**基于物料来源类型计算委外成本**（核心功能增强）。

**技术实现：**
- **后端**：
  - 实现委外件成本核算（材料成本（提供给委外供应商的原材料）+ 委外加工费用）
  - 委外成本核算服务（OutsourceCostService）
- **前端**：
  - 在委外成本核算页面显示材料成本和委外加工费用明细

**测试用例：**
- 测试委外件成本计算（材料成本 + 委外加工费用）
- 测试委外费用自动计算（委外数量 × 委外单价）
- 测试委外成本数据准确性

**验收标准：**
- ✅ **委外件成本核算准确**（材料成本（提供给委外供应商的原材料）+ 委外加工费用）
- ✅ 委外费用自动计算（委外数量 × 委外单价）
- ✅ 成本数据准确
- ✅ 支持委外成本分析

**完成标记：**
- [ ] 委外件成本核算逻辑已实现
- [ ] 委外费用自动计算逻辑已实现
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.3：采购件成本核算（核心功能，新增）

**状态：** ⬜ 未开始

**任务描述：**
实现采购件成本核算功能，**基于物料来源类型计算采购成本**（核心功能新增）。

**技术实现：**
- **后端**：
  - 实现采购件成本核算（采购价格 + 采购费用）
  - 采购成本核算服务（PurchaseCostService）
- **前端**：
  - 在成本核算页面显示采购件成本明细

**测试用例：**
- 测试采购件成本计算（采购价格 + 采购费用）
- 测试采购成本数据准确性

**验收标准：**
- ✅ **采购件成本核算准确**（采购价格 + 采购费用）
- ✅ 成本数据准确
- ✅ 支持采购成本分析

**完成标记：**
- [ ] 采购件成本核算逻辑已实现
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.4：质量成本核算

**状态：** ⬜ 未开始

**任务描述：**
实现质量成本核算功能。

**测试用例：**
- 测试质量成本计算

**验收标准：**
- ✅ 可以计算质量成本
- ✅ 成本数据准确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.5：标准成本和实际成本对比（增强：基于物料来源）

**状态：** ⬜ 未开始

**任务描述：**
实现标准成本和实际成本对比功能，**基于物料来源类型进行成本对比分析**（核心功能增强）。

**技术实现：**
- **后端**：
  - 实现标准成本和实际成本对比服务（CostComparisonService）
  - 基于物料来源类型进行成本对比（自制件、采购件、委外件、虚拟件、配置件）
- **前端**：
  - 在成本对比页面显示不同物料来源的成本对比
  - 使用图表展示成本差异

**测试用例：**
- 测试标准成本和实际成本对比
- 测试不同物料来源的成本差异分析
- 测试成本差异分析准确

**验收标准：**
- ✅ 可以对比标准成本和实际成本
- ✅ **可以对比不同物料来源的成本**（自制件、采购件、委外件、虚拟件、配置件）
- ✅ 成本差异分析准确
- ✅ 成本差异可视化展示

**完成标记：**
- [ ] 成本对比逻辑已实现
- [ ] 物料来源成本对比逻辑已实现
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.6：成本优化建议（增强：基于物料来源）

**状态：** ⬜ 未开始

**任务描述：**
实现成本优化建议功能，**基于物料来源类型提供成本优化建议**（核心功能增强）。

**技术实现：**
- **后端**：
  - 实现成本优化建议服务（CostOptimizationService）
  - 基于物料来源类型提供优化建议（如：自制件转采购件、采购件转自制件等）
- **前端**：
  - 在成本优化建议页面显示不同物料来源的优化建议

**测试用例：**
- 测试成本优化建议生成
- 测试基于物料来源的优化建议

**验收标准：**
- ✅ 可以生成成本优化建议
- ✅ **可以基于物料来源类型提供优化建议**（如：自制件转采购件、采购件转自制件等）
- ✅ 优化建议准确有用

**完成标记：**
- [ ] 成本优化建议逻辑已实现
- [ ] 物料来源优化建议逻辑已实现
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.7：成本报表分析（增强：基于物料来源）

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现成本报表分析功能，包括成本趋势分析、成本结构分析等。

**技术实现：**
- 后端：实现成本报表分析服务（CostReportService）
- 前端：使用Ant Design的Charts组件展示成本报表
- 前端：使用UniTable展示成本报表数据

**测试用例：**
1. 测试成本趋势分析
2. 测试成本结构分析
3. 测试成本报表导出

**验收标准：**
- ✅ 成本趋势分析准确
- ✅ 成本结构分析准确
- ✅ 成本报表可以导出
- ✅ 成本报表支持图表展示

**完成标记：**
- [ ] 成本报表分析服务已实现
- [ ] 成本报表分析API已实现
- [ ] 成本报表分析前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 功能点进度跟踪

### 步骤2.1总体进度

- [x] 功能点2.1.1：返工单管理 ✅
- [x] 功能点2.1.2：工单拆分功能 ✅
- [x] 功能点2.1.3：工单合并功能 ✅
- [x] 功能点2.1.4：工单冻结功能 ✅
- [x] 功能点2.1.5：工单优先级管理 ✅
- [x] 功能点2.1.6：执行中工单工序修改 ✅
- [x] 功能点2.1.7：工单批量操作 ✅
- [x] 功能点2.1.8：工单状态流转管理 ✅

**完成度：** 8/10 (80%)

### 步骤2.2总体进度

- [x] 功能点2.2.1：报工数据修正功能 ✅
- [x] 功能点2.2.2：报工统计分析功能 ✅
- [x] 功能点2.2.3：工站上下料物料绑定功能 ✅
- [x] 功能点2.2.4：带参数报工功能 ✅
- [x] 功能点2.2.5：工序报废处理功能 ✅
- [x] 功能点2.2.6：工序不良品处理功能 ✅
- [x] 功能点2.2.7：按状态报工功能 ✅
- [x] 功能点2.2.8：报工快速操作 ✅
- [x] 功能点2.2.9：报工自动填充 ✅

**完成度：** 9/9 (100%)

### 步骤2.3总体进度

- [x] 功能点2.3.1：库存盘点流程 ✅
- [x] 功能点2.3.2：库存调拨流程 ✅
- [x] 功能点2.3.3：装箱打包绑定功能 ✅
- [x] 功能点2.3.4：客户来料登记功能 ✅
- [x] 功能点2.3.5：库存预警功能 ✅
- [x] 功能点2.3.6：库存报表分析 ✅

**完成度：** 6/6 (100%)

### 步骤2.4总体进度

- [x] 功能点2.4.1：单据节点耗时统计 ✅
- [x] 功能点2.4.2：单据执行效率分析 ✅
- [x] 功能点2.4.3：工作时间段配置 ✅

**完成度：** 3/3 (100%)

### 步骤2.5总体进度

- [ ] 功能点2.5.1：缺料异常处理
- [ ] 功能点2.5.2：交期延期异常处理
- [ ] 功能点2.5.3：质量异常处理
- [ ] 功能点2.5.4：异常统计分析
- [ ] 功能点2.5.5：异常自动检测
- [ ] 功能点2.5.6：异常处理流程

**完成度：** 0/6 (0%)

### 步骤2.6总体进度

- [ ] 功能点2.6.1：设备基础信息管理
- [ ] 功能点2.6.2：设备维护保养计划管理
- [ ] 功能点2.6.3：设备故障处理流程
- [ ] 功能点2.6.4：模具管理流程
- [ ] 功能点2.6.5：设备OEE统计
- [ ] 功能点2.6.6：设备状态监控
- [ ] 功能点2.6.7：设备维护提醒

**完成度：** 0/7 (0%)

### 步骤2.1总体进度（更新）

- [x] 功能点2.1.1：返工单管理 ✅
- [x] 功能点2.1.2：工单拆分功能 ✅
- [x] 功能点2.1.3：工单合并功能 ✅
- [x] 功能点2.1.4：工单冻结功能 ✅
- [x] 功能点2.1.5：工单优先级管理 ✅
- [x] 功能点2.1.6：执行中工单工序修改 ✅
- [x] 功能点2.1.7：工单批量操作 ✅
- [x] 功能点2.1.8：工单状态流转管理 ✅
- [ ] 功能点2.1.9：基于物料来源的工单生成和验证（核心功能，新增） ⏳
- [ ] 功能点2.1.10：委外工单管理（核心功能，新增） ⏳

**完成度：** 8/10 (80%)

### 步骤2.7总体进度

- [ ] 功能点2.7.1：生产成本核算（增强：基于物料来源）
- [ ] 功能点2.7.2：委外成本核算（增强：基于物料来源）
- [ ] 功能点2.7.3：采购件成本核算（核心功能，新增）
- [ ] 功能点2.7.4：质量成本核算
- [ ] 功能点2.7.5：标准成本和实际成本对比（增强：基于物料来源）
- [ ] 功能点2.7.6：成本优化建议（增强：基于物料来源）
- [ ] 功能点2.7.7：成本报表分析（增强：基于物料来源）

**完成度：** 0/7 (0%)

### 第二阶段总体进度

**总功能点数：** 45个（原33个 + 新增12个）  
**已完成：** 25个 ✅  
**进行中：** 0个  
**未开始：** 20个  
**完成度：** 25/45 (55.6%)

---

**文档创建时间：** 2025-12-27  
**文档作者：** Auto (AI Assistant)  
**文档版本：** v1.0  
**最后更新：** 2025-12-27
