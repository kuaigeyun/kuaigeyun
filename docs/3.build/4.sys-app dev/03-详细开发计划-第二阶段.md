# 详细开发计划 - 第二阶段：MES核心功能完善

> **文档说明：**  
> 本文档详细列出第二阶段的每个功能点，支持功能点完成一个测试一个标记一个。  
> 每个功能点包含：任务描述、测试用例、验收标准、完成状态。  
> 
> **重要说明：** 本阶段专注于MES核心功能，包括工单管理、报工管理、生产领料、成品入库等生产执行相关功能。在核心流程统一完成后，完善MES执行层面的功能。

---

## ⚠️ 开发前必读：前后端统一模板规范

> **🚨 重要提示：** 在开始开发前，请务必阅读并遵循《10-前后端统一模板规范.md》中的规范要求，确保代码符合技术栈原生设定。
> **⚠️ 违反规范将导致代码审查不通过，需要返工重写！**

### 📋 前端开发规范（必须遵守）

**所有列表页面必须使用：**
- ✅ `ListPageTemplate` 布局组件（禁止使用其他布局）
- ✅ `UniTable` 表格组件（禁止直接使用ProTable）
- ✅ `ProForm` 表单组件（禁止直接使用Form）
- ✅ `ProDescriptions` 详情组件（禁止直接使用Descriptions）
- ✅ `Modal` 用于新建/编辑，`Drawer` 用于详情查看

**标准页面结构（必须遵循）：**
```typescript
<ListPageTemplate>
  <UniTable
    columns={columns}
    request={handleRequest}
    showAdvancedSearch={true}
    showCreateButton={true}
    onCreate={handleCreate}
    showEditButton={true}
    onEdit={handleEdit}
    showDeleteButton={true}
    onDelete={handleDelete}
    onDetail={handleDetail}
  />
</ListPageTemplate>
<Modal> {/* 新建/编辑 */} </Modal>
<Drawer> {/* 详情 */} </Drawer>
```

**禁止事项：**
- ❌ 禁止直接使用 `ProTable`（必须使用 `UniTable`）
- ❌ 禁止直接使用 `Form`（必须使用 `ProForm`）
- ❌ 禁止直接使用 `Descriptions`（必须使用 `ProDescriptions`）
- ❌ 禁止在列表页面中混用其他布局组件

### 📋 后端开发规范（必须遵守）

**所有API路由必须使用：**
- ✅ `APIRouter` 组织路由（禁止使用其他路由方式）
- ✅ `Depends(get_current_user, get_current_tenant)` 依赖注入（必须使用）
- ✅ 统一异常处理（`ValidationError`, `NotFoundError`，禁止直接使用HTTPException）
- ✅ `response_model` 定义响应模型（必须使用）
- ✅ 服务层封装业务逻辑（禁止在API层写业务逻辑）

**标准API结构（必须遵循）：**
```python
router = APIRouter(prefix="/xxx", tags=["XXX"])

@router.post("", response_model=ModelResponse, summary="创建")
async def create_xxx(
    data: ModelCreate,
    current_user: Annotated[User, Depends(get_current_user)],
    tenant_id: Annotated[int, Depends(get_current_tenant)]
):
    try:
        return await Service.create_xxx(tenant_id, data, current_user.id)
    except ValidationError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

**禁止事项：**
- ❌ 禁止在API层写业务逻辑（必须在服务层实现）
- ❌ 禁止直接使用 `HTTPException`（必须使用统一异常类）
- ❌ 禁止不使用依赖注入（必须使用 `get_current_user` 和 `get_current_tenant`）
- ❌ 禁止不使用 `response_model`（必须定义响应模型）

**📖 详细规范请参考：** `10-前后端统一模板规范.md`

---
> 
> **创建时间：** 2025-12-27  
> **文档版本：** v2.0  
> **最后更新：** 2025-12-27

---

## 📋 目录

1. [步骤2.1：工单高级管理](#步骤21工单高级管理)
2. [步骤2.2：报工高级功能](#步骤22报工高级功能)
3. [步骤2.3：仓储高级功能](#步骤23仓储高级功能)
4. [步骤2.4：单据执行效率优化](#步骤24单据执行效率优化)
5. [步骤2.5：异常处理](#步骤25异常处理)
6. [步骤2.6：设备模具管理](#步骤26设备模具管理)
7. [步骤2.7：成本核算](#步骤27成本核算)

---

## 步骤2.1：工单高级管理

**目标：** 实现工单高级管理功能，包括返工单、拆分、合并、冻结、优先级等

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成（工单基础功能已实现）

---

### 功能点2.1.1：返工单管理

**状态：** ✅ 已完成

**任务描述：**
实现返工单管理功能。

**技术实现：**
- 后端：创建返工单模型（ReworkOrder），支持关联原工单
- 后端：实现返工单服务（ReworkOrderService），包括创建、查询、更新、删除、从工单创建返工单
- 后端：实现返工单API接口（production.py）
- 前端：使用ListPageTemplate和UniTable实现返工单管理页面
- 前端：使用ProForm实现返工单表单，使用ProDescriptions实现详情展示

**测试用例：**
- 测试创建返工单
- 测试返工单流程
- 测试从工单创建返工单

**验收标准：**
- ✅ 可以创建返工单
- ✅ 返工单关联原工单
- ✅ 返工单流程完整
- ✅ 可以从工单创建返工单

**完成标记：**
- [x] 功能已实现 ✅
  - [x] 后端模型已设计 ✅（ReworkOrder模型）
  - [x] 后端服务已实现 ✅（ReworkOrderService）
  - [x] 后端API已实现 ✅（production.py）
  - [x] 前端页面已实现 ✅（rework-orders/index.tsx，使用UniTable）
  - [x] 数据库迁移已完成 ✅（12_20260115000002_add_p1_work_order_models.py）
  - [x] 前后端对接完成 ✅（reworkOrderApi服务）
  - [x] 代码规范性检查通过 ✅（使用ListPageTemplate和UniTable，使用ProForm和ProDescriptions）
- [ ] 单元测试已编写并通过

---

### 功能点2.1.2：工单拆分功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单拆分功能。

**测试用例：**
- 测试工单拆分
- 测试拆分数量验证

**验收标准：**
- ✅ 可以拆分工单
- ✅ 拆分数量验证正常
- ✅ 拆分后的工单信息正确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.1.3：工单合并功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单合并功能。

**测试用例：**
- 测试工单合并
- 测试合并验证

**验收标准：**
- ✅ 可以合并工单
- ✅ 合并验证正常
- ✅ 合并后的工单信息正确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.1.4：工单冻结功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单冻结功能。

**测试用例：**
- 测试工单冻结
- 测试工单解冻

**验收标准：**
- ✅ 可以冻结工单
- ✅ 可以解冻工单
- ✅ 冻结的工单不能执行

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.1.5：工单优先级管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单优先级管理功能。

**测试用例：**
- 测试设置工单优先级
- 测试按优先级排序

**验收标准：**
- ✅ 可以设置工单优先级
- ✅ 工单列表可以按优先级排序
- ✅ 优先级显示清晰

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.1.6：执行中工单工序修改

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现执行中工单工序修改功能。

**测试用例：**
- 测试修改工单工序
- 测试修改权限验证

**验收标准：**
- ✅ 可以修改执行中工单的工序
- ✅ 修改权限验证正常
- ✅ 修改后工序信息正确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.1.7：工单批量操作

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单批量操作功能，包括批量下达、批量冻结、批量取消等。

**技术实现：**
- 后端：实现批量操作服务（BatchOperationService），支持事务处理
- 前端：使用UniTable的行选择功能，支持批量选择
- 前端：使用Ant Design的Button组件实现批量操作按钮

**测试用例：**
1. 测试批量下达工单
2. 测试批量冻结工单
3. 测试批量取消工单
4. 测试批量操作权限验证

**验收标准：**
- ✅ 可以批量下达工单
- ✅ 可以批量冻结工单
- ✅ 可以批量取消工单
- ✅ 批量操作权限验证正常
- ✅ 批量操作支持事务处理（全部成功或全部失败）

**完成标记：**
- [ ] 批量操作服务已实现
- [ ] 批量操作API已实现
- [ ] 批量操作前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.1.8：工单状态流转管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工单状态流转管理，包括状态机定义、状态流转规则、状态流转日志等。

**技术实现：**
- 后端：使用状态机模式管理工单状态（draft→released→in_progress→completed→closed）
- 后端：实现状态流转服务（StateTransitionService），支持Inngest工作流
- 前端：使用Ant Design的Tag组件展示状态
- 前端：使用Ant Design的Timeline组件展示状态流转历史

**测试用例：**
1. 测试工单状态流转
2. 测试状态流转规则验证
3. 测试状态流转日志记录
4. 测试状态流转权限控制

**验收标准：**
- ✅ 工单状态可以正常流转
- ✅ 状态流转规则验证正确
- ✅ 状态流转日志记录完整
- ✅ 状态流转权限控制正确
- ✅ 状态流转支持Inngest工作流触发

**完成标记：**
- [ ] 状态机模型已设计
- [ ] 状态流转服务已实现
- [ ] 状态流转API已实现
- [ ] 状态流转前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤2.2：报工高级功能

**目标：** 实现报工高级功能，包括数据修正、统计分析、工站上下料物料绑定等

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成（报工基础功能已实现）

---

### 功能点2.2.1：报工数据修正功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工数据修正功能。

**测试用例：**
- 测试报工数据修正
- 测试修正记录查询

**验收标准：**
- ✅ 可以修正报工数据
- ✅ 修正记录可以查询
- ✅ 修正后数据正确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.2.2：报工统计分析功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工统计分析功能。

**测试用例：**
- 测试报工统计查询
- 测试统计数据准确性

**验收标准：**
- ✅ 可以查询报工统计
- ✅ 统计数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.2.3：工站上下料物料绑定功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工站上下料物料绑定功能。

**测试用例：**
- 测试上料绑定
- 测试下料绑定
- 测试库存更新

**验收标准：**
- ✅ 可以绑定上料物料
- ✅ 可以绑定下料物料
- ✅ 绑定后库存自动更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.2.4：带参数报工功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现带参数报工功能。

**测试用例：**
- 测试带参数报工
- 测试参数数据存储

**验收标准：**
- ✅ 可以带参数报工
- ✅ 参数数据正确存储
- ✅ 参数可以查询和分析

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.2.5：工序报废处理功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工序报废处理功能，包括创建报废单、报废审批、报废处理和报废统计分析。

**测试用例：**
- 测试从报工记录创建报废单
- 测试手动创建报废单
- 测试工序报废审批流程
- 测试报废后工单数量和库存更新
- 测试报废成本计算
- 测试报废统计分析（按工单、工序、物料、时间段）

**验收标准：**
- ✅ 可以从报工记录一键创建报废单（自动填充关联信息）
- ✅ 可以手动创建报废单
- ✅ 支持工序报废审批（同意/不同意）
- ✅ 审批同意后自动更新工单数量（扣减报废数量）
- ✅ 审批同意后自动更新库存（不良品库存）
- ✅ 自动记录报废成本（基于物料成本）
- ✅ 支持报废统计分析（按工单、工序、物料、时间段统计报废率和报废成本）
- ✅ 支持导出报废统计报表（Excel）

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点2.2.6：工序不良品处理功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工序不良品处理功能，包括创建不良品记录、不良品处理（返工/报废/让步接收）和不良品统计分析。

**测试用例：**
- 测试从报工记录创建不良品记录
- 测试手动创建不良品记录
- 测试不良品返工处理（创建返工单）
- 测试不良品报废处理（创建报废单）
- 测试不良品让步接收（审批流程）
- 测试不良品统计分析（按工单、工序、物料、不良品类型、时间段）

**验收标准：**
- ✅ 可以从报工记录一键创建不良品记录（自动填充关联信息）
- ✅ 可以手动创建不良品记录
- ✅ 支持不良品返工处理（自动创建返工单，关联原工单和原工序）
- ✅ 支持不良品报废处理（自动创建报废单，更新工单数量和库存）
- ✅ 支持不良品让步接收（需要审批，审批通过后允许继续下一工序）
- ✅ 支持不良品统计分析（按工单、工序、物料、不良品类型、时间段统计不良品率）
- ✅ 支持导出不良品统计报表（Excel）

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

### 功能点2.2.7：按状态报工功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现按状态报工功能，支持按状态报工模式（完成/未完成），适配工位机触屏模式。

---

### 功能点2.2.8：报工快速操作

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工快速操作功能，包括快速报工按钮、一键报工等。

**技术实现：**
- 后端：实现快速报工服务（QuickReportService），支持一键报工
- 前端：使用Ant Design的Button组件实现快速报工按钮
- 前端：使用Ant Design的Modal组件实现快速报工表单

**测试用例：**
1. 测试快速报工按钮
2. 测试一键报工功能
3. 测试快速报工数据验证

**验收标准：**
- ✅ 快速报工按钮可以正常使用
- ✅ 一键报工功能正常
- ✅ 快速报工数据验证正确
- ✅ 快速报工界面友好（适配触屏模式）

**完成标记：**
- [ ] 快速报工服务已实现
- [ ] 快速报工API已实现
- [ ] 快速报工前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.2.9：报工自动填充

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现报工自动填充功能，根据工艺路线自动填充报工数据。

**技术实现：**
- 后端：实现自动填充服务（AutoFillService），根据工艺路线获取默认值
- 前端：使用ProForm的自动填充功能
- 前端：使用Ant Design的Form.Item的shouldUpdate实现联动

**测试用例：**
1. 测试根据工艺路线自动填充报工数据
2. 测试自动填充数据准确性
3. 测试用户可以修改自动填充的数据

**验收标准：**
- ✅ 根据工艺路线自动填充报工数据
- ✅ 自动填充数据准确
- ✅ 用户可以修改自动填充的数据
- ✅ 自动填充提升报工效率

**完成标记：**
- [ ] 自动填充服务已实现
- [ ] 自动填充API已实现
- [ ] 自动填充前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

**测试用例：**
- 测试按状态报工模式（完成/未完成）
- 测试工序类型自动判断（按状态报工）
- 测试触屏优化界面（大按钮、大字体）
- 测试带参数SOP的参数收集表单
- 测试工序跳转规则校验

**验收标准：**
- ✅ 支持按状态报工模式（完成/未完成）
- ✅ 系统根据工序类型自动判断报工模式（按状态报工）
- ✅ 触屏优化界面（大按钮、大字体、全屏模式）
- ✅ 支持带参数SOP的参数收集表单（触屏优化）
- ✅ 支持工序跳转规则校验（检查上道工序是否完成）
- ✅ 报工成功后自动切换到下一工序

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过
- [ ] 功能测试已通过

---

## 步骤2.3：仓储高级功能

**目标：** 实现仓储高级功能，包括库存盘点、调拨、装箱打包绑定等

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段已完成（基础仓储功能已实现）

---

### 功能点2.3.1：库存盘点流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存盘点流程。

**测试用例：**
- 测试创建盘点单
- 测试盘点结果处理

**验收标准：**
- ✅ 可以创建盘点单
- ✅ 可以记录盘点结果
- ✅ 盘点差异可以处理

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.3.2：库存调拨流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存调拨流程。

**测试用例：**
- 测试创建调拨单
- 测试执行调拨
- 测试库存更新

**验收标准：**
- ✅ 可以创建调拨单
- ✅ 可以执行调拨
- ✅ 调拨后库存正确更新

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.3.3：装箱打包绑定功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现装箱打包绑定功能。

**测试用例：**
- 测试装箱绑定
- 测试装箱码生成

**验收标准：**
- ✅ 可以绑定装箱
- ✅ 装箱码自动生成
- ✅ 产品序列号可以绑定到装箱号

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.3.4：客户来料登记功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现客户来料登记功能。

**测试用例：**
- 测试客户来料登记
- 测试客户编码映射

---

### 功能点2.3.5：库存预警功能

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存预警功能，包括库存不足预警、库存积压预警等。

**技术实现：**
- 后端：实现库存预警服务（InventoryAlertService），实时监控库存
- 后端：支持预警级别配置（低库存、缺料、积压等）
- 前端：使用Ant Design的Badge组件展示预警数量
- 前端：使用Ant Design的Table组件展示预警列表

**测试用例：**
1. 测试库存不足预警
2. 测试库存积压预警
3. 测试预警级别计算
4. 测试预警通知推送

**验收标准：**
- ✅ 库存不足预警正常
- ✅ 库存积压预警正常
- ✅ 预警级别计算准确
- ✅ 预警通知可以推送
- ✅ 预警信息可以查询

**完成标记：**
- [ ] 库存预警服务已实现
- [ ] 库存预警API已实现
- [ ] 库存预警前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.3.6：库存报表分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现库存报表分析功能，包括库存周转率、库存成本分析等。

**技术实现：**
- 后端：实现库存报表分析服务（InventoryReportService）
- 前端：使用Ant Design的Charts组件展示库存报表
- 前端：使用UniTable展示库存报表数据

**测试用例：**
1. 测试库存周转率计算
2. 测试库存成本分析
3. 测试库存报表导出

**验收标准：**
- ✅ 库存周转率计算准确
- ✅ 库存成本分析准确
- ✅ 库存报表可以导出
- ✅ 库存报表支持图表展示

**完成标记：**
- [ ] 库存报表分析服务已实现
- [ ] 库存报表分析API已实现
- [ ] 库存报表分析前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

**验收标准：**
- ✅ 可以登记客户来料
- ✅ 客户编码可以映射
- ✅ 客户来料可以入库

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

## 步骤2.4：单据执行效率优化

**目标：** 实现单据执行效率优化，包括耗时统计和分析

**时间估算：** 1周

**前置条件：**
- ✅ 第一阶段已完成（单据关联已实现）

---

### 功能点2.4.1：单据节点耗时统计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现单据节点耗时统计功能。

**测试用例：**
- 测试节点时间记录
- 测试耗时计算
- 测试耗时统计查询

**验收标准：**
- ✅ 节点时间自动记录
- ✅ 耗时计算准确（基于工作时间段）
- ✅ 耗时统计可以查询

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.4.2：单据执行效率分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现单据执行效率分析功能。

**测试用例：**
- 测试效率分析查询
- 测试效率分析准确性

**验收标准：**
- ✅ 可以分析单据执行效率
- ✅ 效率分析数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.4.3：工作时间段配置

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现工作时间段配置功能，支持按人员或部门设置工作时间段，用于单据节点耗时统计。

**技术实现：**
- 后端：创建工作时间段配置模型（WorkTimeConfig），支持按人员或部门配置
- 后端：实现工作时间段配置服务（WorkTimeConfigService）
- 前端：使用ProForm实现工作时间段配置表单
- 前端：使用Ant Design的TimePicker组件选择时间段

**测试用例：**
1. 测试按人员配置工作时间段
2. 测试按部门配置工作时间段
3. 测试工作时间段格式验证
4. 测试工作时间段在耗时统计中的应用

**验收标准：**
- ✅ 可以按人员配置工作时间段
- ✅ 可以按部门配置工作时间段
- ✅ 工作时间段格式验证正确
- ✅ 单据节点耗时统计使用工作时间段配置
- ✅ 工作时间段配置支持批量导入

**完成标记：**
- [ ] 工作时间段配置模型已设计
- [ ] 工作时间段配置服务已实现
- [ ] 工作时间段配置API已实现
- [ ] 工作时间段配置前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤2.5：异常处理

**目标：** 实现异常处理功能，包括缺料、交期延期、质量异常处理

**时间估算：** 1周

**前置条件：**
- ✅ 第一阶段和第二阶段已完成

---

### 功能点2.5.1：缺料异常处理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现缺料异常处理功能。

**测试用例：**
- 测试缺料异常检测
- 测试缺料异常处理

**验收标准：**
- ✅ 可以自动检测缺料异常
- ✅ 可以处理缺料异常
- ✅ 缺料异常处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.2：交期延期异常处理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现交期延期异常处理功能。

**测试用例：**
- 测试交期延期异常检测
- 测试交期延期异常处理

**验收标准：**
- ✅ 可以自动检测交期延期异常
- ✅ 可以处理交期延期异常
- ✅ 交期延期异常处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.3：质量异常处理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现质量异常处理功能。

**测试用例：**
- 测试质量异常检测
- 测试质量异常处理

**验收标准：**
- ✅ 可以自动检测质量异常
- ✅ 可以处理质量异常
- ✅ 质量异常处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.4：异常统计分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现异常统计分析功能。

**测试用例：**
- 测试异常统计查询
- 测试统计数据准确性

**验收标准：**
- ✅ 可以查询异常统计
- ✅ 统计数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.5.5：异常自动检测

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现异常自动检测功能，系统自动检测异常并推送通知。

**技术实现：**
- 后端：实现异常检测服务（ExceptionDetectionService），定时检测异常
- 后端：使用Inngest工作流实现定时任务
- 前端：使用Ant Design的Badge组件展示异常数量
- 前端：使用Ant Design的Notification组件推送异常通知

**测试用例：**
1. 测试缺料异常自动检测
2. 测试交期延期异常自动检测
3. 测试质量异常自动检测
4. 测试异常通知推送

**验收标准：**
- ✅ 缺料异常自动检测正常
- ✅ 交期延期异常自动检测正常
- ✅ 质量异常自动检测正常
- ✅ 异常通知可以推送
- ✅ 异常检测支持配置检测规则

**完成标记：**
- [ ] 异常检测服务已实现
- [ ] 异常检测API已实现
- [ ] 异常检测前端页面已实现
- [ ] Inngest工作流已配置
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.5.6：异常处理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现异常处理流程，包括异常处理工作流、异常处理记录等。

**技术实现：**
- 后端：实现异常处理流程服务（ExceptionProcessService），支持工作流
- 后端：使用Inngest工作流实现异常处理流程
- 前端：使用Ant Design的Steps组件展示异常处理流程
- 前端：使用Ant Design的Timeline组件展示异常处理历史

**测试用例：**
1. 测试异常处理流程启动
2. 测试异常处理流程执行
3. 测试异常处理流程状态查询
4. 测试异常处理记录查询

**验收标准：**
- ✅ 异常处理流程可以启动
- ✅ 异常处理流程执行正常
- ✅ 异常处理流程状态可以查询
- ✅ 异常处理记录可以查询
- ✅ 异常处理流程支持自定义配置

**完成标记：**
- [ ] 异常处理流程服务已实现
- [ ] 异常处理流程API已实现
- [ ] 异常处理流程前端页面已实现
- [ ] Inngest工作流已配置
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤2.6：设备模具管理

**目标：** 实现设备模具管理功能，包括设备基础信息、维护保养、故障处理、模具管理、OEE统计

**时间估算：** 2周

**前置条件：**
- ✅ 第一阶段已完成

---

### 功能点2.6.1：设备基础信息管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备基础信息管理功能。

**测试用例：**
- 测试设备创建
- 测试设备查询

**验收标准：**
- ✅ 可以创建设备
- ✅ 可以查询设备列表
- ✅ 设备信息完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.2：设备维护保养计划管理

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备维护保养计划管理功能。

**测试用例：**
- 测试创建维护计划
- 测试维护计划执行

**验收标准：**
- ✅ 可以创建维护计划
- ✅ 可以执行维护计划
- ✅ 维护计划自动提醒

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.3：设备故障处理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备故障处理流程。

**测试用例：**
- 测试故障报告
- 测试故障处理

**验收标准：**
- ✅ 可以报告设备故障
- ✅ 可以处理设备故障
- ✅ 故障处理流程完整

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.4：模具管理流程

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现模具管理流程。

**测试用例：**
- 测试模具创建
- 测试模具使用记录

**验收标准：**
- ✅ 可以创建模具
- ✅ 可以记录模具使用
- ✅ 模具状态管理正常

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.5：设备OEE统计

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备OEE统计功能。

**测试用例：**
- 测试OEE计算
- 测试OEE统计准确性

**验收标准：**
- ✅ 可以计算设备OEE
- ✅ OEE统计数据准确
- ✅ 支持图表展示

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.6.6：设备状态监控

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备状态监控功能，实时监控设备状态。

**技术实现：**
- 后端：实现设备状态监控服务（EquipmentStatusMonitorService），实时获取设备状态
- 后端：支持设备状态数据采集（可通过SCADA集成或手动更新）
- 前端：使用Ant Design的Badge组件展示设备状态
- 前端：使用Ant Design的Card组件展示设备状态卡片

**测试用例：**
1. 测试设备状态实时监控
2. 测试设备状态数据采集
3. 测试设备状态异常告警

**验收标准：**
- ✅ 设备状态可以实时监控
- ✅ 设备状态数据采集正常
- ✅ 设备状态异常可以告警
- ✅ 设备状态历史可以查询

**完成标记：**
- [ ] 设备状态监控服务已实现
- [ ] 设备状态监控API已实现
- [ ] 设备状态监控前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

### 功能点2.6.7：设备维护提醒

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现设备维护提醒功能，维护计划到期提醒。

**技术实现：**
- 后端：实现设备维护提醒服务（EquipmentMaintenanceReminderService），定时检查维护计划
- 后端：使用Inngest工作流实现定时任务
- 前端：使用Ant Design的Badge组件展示提醒数量
- 前端：使用Ant Design的Notification组件推送维护提醒

**测试用例：**
1. 测试维护计划到期检测
2. 测试维护提醒推送
3. 测试维护提醒查询

**验收标准：**
- ✅ 维护计划到期可以检测
- ✅ 维护提醒可以推送
- ✅ 维护提醒可以查询
- ✅ 维护提醒支持提前提醒配置

**完成标记：**
- [ ] 设备维护提醒服务已实现
- [ ] 设备维护提醒API已实现
- [ ] 设备维护提醒前端页面已实现
- [ ] Inngest工作流已配置
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 步骤2.7：成本核算

**目标：** 实现成本核算功能，包括生产成本、委外成本、质量成本核算

**时间估算：** 1-2周

**前置条件：**
- ✅ 第一阶段和第二阶段已完成

---

### 功能点2.7.1：生产成本核算

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现生产成本核算功能。

**测试用例：**
- 测试生产成本计算
- 测试成本数据准确性

**验收标准：**
- ✅ 可以计算生产成本
- ✅ 成本数据准确
- ✅ 支持成本分析

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.2：委外成本核算

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现委外成本核算功能。

**测试用例：**
- 测试委外成本计算

**验收标准：**
- ✅ 可以计算委外成本
- ✅ 成本数据准确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.3：质量成本核算

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现质量成本核算功能。

**测试用例：**
- 测试质量成本计算

**验收标准：**
- ✅ 可以计算质量成本
- ✅ 成本数据准确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.4：标准成本和实际成本对比

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现标准成本和实际成本对比功能。

**测试用例：**
- 测试成本对比
- 测试成本差异分析

**验收标准：**
- ✅ 可以对比标准成本和实际成本
- ✅ 成本差异分析准确

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.5：成本优化建议

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现成本优化建议功能。

**测试用例：**
- 测试成本优化建议生成

**验收标准：**
- ✅ 可以生成成本优化建议
- ✅ 优化建议准确有用

**完成标记：**
- [ ] 功能已实现
- [ ] 单元测试已编写并通过

---

### 功能点2.7.6：成本报表分析

**状态：** ⬜ 未开始 | 🟡 进行中 | ✅ 已完成 | ❌ 已取消

**任务描述：**
实现成本报表分析功能，包括成本趋势分析、成本结构分析等。

**技术实现：**
- 后端：实现成本报表分析服务（CostReportService）
- 前端：使用Ant Design的Charts组件展示成本报表
- 前端：使用UniTable展示成本报表数据

**测试用例：**
1. 测试成本趋势分析
2. 测试成本结构分析
3. 测试成本报表导出

**验收标准：**
- ✅ 成本趋势分析准确
- ✅ 成本结构分析准确
- ✅ 成本报表可以导出
- ✅ 成本报表支持图表展示

**完成标记：**
- [ ] 成本报表分析服务已实现
- [ ] 成本报表分析API已实现
- [ ] 成本报表分析前端页面已实现
- [ ] 单元测试已编写并通过
- [ ] 集成测试已通过

---

## 功能点进度跟踪

### 步骤2.1总体进度

- [x] 功能点2.1.1：返工单管理 ✅
- [ ] 功能点2.1.2：工单拆分功能
- [ ] 功能点2.1.3：工单合并功能
- [ ] 功能点2.1.4：工单冻结功能
- [ ] 功能点2.1.5：工单优先级管理
- [ ] 功能点2.1.6：执行中工单工序修改
- [ ] 功能点2.1.7：工单批量操作
- [ ] 功能点2.1.8：工单状态流转管理

**完成度：** 1/8 (12.5%)

### 步骤2.2总体进度

- [ ] 功能点2.2.1：报工数据修正功能
- [ ] 功能点2.2.2：报工统计分析功能
- [ ] 功能点2.2.3：工站上下料物料绑定功能
- [ ] 功能点2.2.4：带参数报工功能
- [ ] 功能点2.2.5：工序报废处理功能
- [ ] 功能点2.2.6：工序不良品处理功能
- [ ] 功能点2.2.7：按状态报工功能
- [ ] 功能点2.2.8：报工快速操作
- [ ] 功能点2.2.9：报工自动填充

**完成度：** 0/9 (0%)

### 步骤2.3总体进度

- [ ] 功能点2.3.1：库存盘点流程
- [ ] 功能点2.3.2：库存调拨流程
- [ ] 功能点2.3.3：装箱打包绑定功能
- [ ] 功能点2.3.4：客户来料登记功能
- [ ] 功能点2.3.5：库存预警功能
- [ ] 功能点2.3.6：库存报表分析

**完成度：** 0/6 (0%)

### 步骤2.4总体进度

- [ ] 功能点2.4.1：单据节点耗时统计
- [ ] 功能点2.4.2：单据执行效率分析
- [ ] 功能点2.4.3：工作时间段配置

**完成度：** 0/3 (0%)

### 步骤2.5总体进度

- [ ] 功能点2.5.1：缺料异常处理
- [ ] 功能点2.5.2：交期延期异常处理
- [ ] 功能点2.5.3：质量异常处理
- [ ] 功能点2.5.4：异常统计分析
- [ ] 功能点2.5.5：异常自动检测
- [ ] 功能点2.5.6：异常处理流程

**完成度：** 0/6 (0%)

### 步骤2.6总体进度

- [ ] 功能点2.6.1：设备基础信息管理
- [ ] 功能点2.6.2：设备维护保养计划管理
- [ ] 功能点2.6.3：设备故障处理流程
- [ ] 功能点2.6.4：模具管理流程
- [ ] 功能点2.6.5：设备OEE统计
- [ ] 功能点2.6.6：设备状态监控
- [ ] 功能点2.6.7：设备维护提醒

**完成度：** 0/7 (0%)

### 步骤2.7总体进度

- [ ] 功能点2.7.1：生产成本核算
- [ ] 功能点2.7.2：委外成本核算
- [ ] 功能点2.7.3：质量成本核算
- [ ] 功能点2.7.4：标准成本和实际成本对比
- [ ] 功能点2.7.5：成本优化建议
- [ ] 功能点2.7.6：成本报表分析

**完成度：** 0/6 (0%)

### 第二阶段总体进度

**总功能点数：** 45个（原33个 + 新增12个）  
**已完成：** 1个 ✅  
**进行中：** 0个  
**未开始：** 44个  
**完成度：** 1/45 (2.2%)

---

**文档创建时间：** 2025-12-27  
**文档作者：** Auto (AI Assistant)  
**文档版本：** v1.0  
**最后更新：** 2025-12-27
