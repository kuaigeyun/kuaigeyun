# 渐进式开发计划 - 宏观版

> **文档说明：**  
> 本文档基于《用户使用全场景推演》优化后的流程，制定宏观渐进式开发计划。  
> 重点关注统一主线、需求驱动、统一运算等核心设计理念的实现。  
> 
> **创建时间：** 2025-12-27  
> **文档版本：** v1.1  
> **最后更新：** 2026-01-16（更新物料来源控制功能）

---

## 📋 目录

1. [项目现状分析](#1-项目现状分析)
2. [需要清理的旧功能](#2-需要清理的旧功能)
3. [宏观开发计划](#3-宏观开发计划)
   - [第一阶段：核心流程统一与重构](#第一阶段核心流程统一与重构)
   - [第二阶段：MES核心功能完善](#第二阶段mes核心功能完善)
   - [第三阶段：需求驱动流程完善](#第三阶段需求驱动流程完善)
   - [第四阶段：系统配置与基础数据优化](#第四阶段系统配置与基础数据优化)
   - [第五阶段：高级功能与体验优化（MES扩展功能）](#第五阶段高级功能与体验优化mes扩展功能)
   - [第六阶段：扩展功能与集成](#第六阶段扩展功能与集成)
   - [第七阶段：持续优化与PRO版功能](#第七阶段持续优化与pro版功能)

---

## 1. 项目现状分析

### 1.1 当前应用结构

**已存在的应用：**
- ✅ `master-data` - 主数据管理应用（已存在，功能完整）
- ✅ `kuaizhizao` - 快智造应用（已存在，部分功能已实现）

**已归档的应用（archive目录）：**
- ❌ 22个旧应用已归档，包括：
  - `kuaimes` - 快格MES（已备份，新计划用kuaizhizao替代）
  - `kuaimrp` - 快格MRP（已备份，新计划用kuaizhizao替代）
  - `kuaiwms` - 快格WMS（已备份，新计划用kuaizhizao替代）
  - `kuaicrm` - 快格CRM（已备份）
  - 其他18个应用（已归档）

### 1.2 当前功能实现状态

**已完成（第一步MVP）：**
- ✅ 工单管理
- ✅ 报工管理
- ✅ 生产领料
- ✅ 成品入库
- ✅ 生产看板

**已实现但需要重构：**
- ⚠️ MRP运算页面（`mrp-computation`）- 需要合并为统一需求计算
- ⚠️ LRP运算页面（`lrp-computation`）- 需要合并为统一需求计算
- ⚠️ 销售预测管理（`sales-forecasts`）- 需要统一为需求管理
- ⚠️ 销售订单管理（`sales-orders`）- 需要统一为需求管理

**已计划但未实现：**
- ⏳ 需求管理（统一需求管理）
- ⏳ 需求计算（统一运算）
- ⏳ 采购管理
- ⏳ 质量管理
- ⏳ 财务管理
- ⏳ 系统初始化向导
- ⏳ 业务配置功能

### 1.3 架构现状

**前端架构：**
- ✅ 系统级路由和应用级路由已分离
- ✅ 应用动态加载机制已实现
- ⚠️ 部分页面仍使用旧的分离式设计（MRP/LRP分离）

**后端架构：**
- ✅ 应用注册服务已实现
- ✅ 动态路由注册机制已实现
- ⚠️ MRP和LRP运算逻辑仍分离（需要统一）

---

## 2. 需要清理的旧功能

### 2.1 需要合并的功能

#### 2.1.1 MRP和LRP运算合并为统一需求计算

**当前状态：**
- ❌ `mrp-computation` 页面（独立页面）
- ❌ `lrp-computation` 页面（独立页面）
- ❌ `runMRPComputation` API（独立接口）
- ❌ `runLRPComputation` API（独立接口）

**目标状态：**
- ✅ `demand-computation` 页面（统一页面）
- ✅ `runDemandComputation` API（统一接口，支持参数配置）
- ✅ 通过需求类型自动识别MTS/MTO模式
- ✅ 通过参数配置实现不同业务场景

**清理步骤：**
1. 创建统一的需求计算页面（`demand-computation`）
2. 合并MRP和LRP运算逻辑为统一的需求计算服务
3. 迁移现有MRP/LRP数据到统一的需求计算结果表
4. 删除独立的MRP和LRP页面
5. 删除独立的MRP和LRP API接口
6. 更新路由配置，移除MRP/LRP路由

#### 2.1.2 销售预测和销售订单统一为需求管理

**当前状态：**
- ❌ `sales-forecasts` 页面（独立页面）
- ❌ `sales-orders` 页面（独立页面）
- ❌ `demand-management` 页面（已存在但功能不完整）

**目标状态：**
- ✅ `demand-management` 页面（统一需求管理）
- ✅ 支持销售预测和销售订单两种需求类型
- ✅ 通过需求类型自动识别业务模式

**清理步骤：**
1. 完善 `demand-management` 页面，支持两种需求类型
2. 迁移销售预测数据到统一的需求表
3. 迁移销售订单数据到统一的需求表
4. 删除独立的销售预测和销售订单页面（或保留为需求管理的子视图）
5. 更新路由配置

### 2.2 需要移除的页面

**已确认需要移除：**
- ✅ BOM管理页面（已从kuaizhizao移除，应在master-data中管理）
- ✅ 业务配置页面（已从kuaizhizao移除，应在系统级配置）

**需要评估是否移除：**
- ⚠️ `production-plans` 页面（生产计划）- 评估是否与需求计算合并
- ⚠️ `scheduling` 页面（排程）- 评估是否与需求计算合并

### 2.3 需要清理的代码

**后端清理：**
- ❌ 独立的MRP运算服务（`mrp_service.py`）- 合并到需求计算服务
- ❌ 独立的LRP运算服务（`lrp_service.py`）- 合并到需求计算服务
- ❌ MRP和LRP相关的独立模型（合并为统一的需求计算模型）

**前端清理：**
- ❌ `mrp-computation` 页面组件
- ❌ `lrp-computation` 页面组件
- ❌ `services/mrp.ts` 中的MRP/LRP分离接口（合并为统一接口）

---

## 3. 宏观开发计划

> **重要调整说明：**  
> 根据开发优先级调整，优先完成核心流程统一与重构，建立系统基础架构，然后再完善MES执行功能。  
> 这样可以先建立完整的业务流程框架，再完善执行层面的功能。

### 第一阶段：核心流程统一与重构

**目标：** 统一业务流程主线，实现需求驱动的核心流程

**时间估算：** 4-6周

**说明：** 本阶段实现全流程功能，包括需求管理、需求计算、单据关联等。这是整个系统的基础架构，必须在MES功能完善之前完成。

#### 步骤1.1：需求管理统一（流程源头，2周）

**说明：** 销售预测和销售订单是整个业务流程的源头，必须首先完成。本步骤实现需求管理的完整功能，包括销售预测和销售订单的创建、编辑、审核、批量导入等。

**任务：**
1. 完善需求管理页面，支持销售预测和销售订单两种需求类型
2. 实现销售预测完整功能：
   - 创建销售预测（支持universheet批量导入）
   - 编辑销售预测
   - 审核销售预测
   - 销售预测列表查询和筛选
   - 销售预测详情查看
3. 实现销售订单完整功能：
   - 创建销售订单（支持universheet批量导入）
   - 编辑销售订单
   - 审核销售订单
   - 销售订单列表查询和筛选
   - 销售订单详情查看
4. 统一需求数据模型，支持需求类型字段
5. 实现需求类型自动识别（销售预测→MTS，销售订单→MTO）
6. 实现需求下推到物料需求运算功能（一键下推）
7. 实现需求关联展示（显示下游关联单据：需求计算、工单、销售出库单等）
8. 实现需求耗时统计（记录需求创建时间，计算从创建到提交的耗时）
9. 迁移现有销售预测和销售订单数据到统一需求表
10. 更新需求管理API，支持统一的需求管理接口

**交付物：**
- ✅ 统一的需求管理页面（支持销售预测和销售订单）
- ✅ 销售预测完整功能（创建、编辑、审核、批量导入、列表查询、详情查看）
- ✅ 销售订单完整功能（创建、编辑、审核、批量导入、列表查询、详情查看）
- ✅ 统一的需求数据模型
- ✅ 统一的需求管理API
- ✅ 需求下推功能（一键下推到物料需求运算）
- ✅ 需求关联展示功能
- ✅ 需求耗时统计功能

**验收标准：**
- ✅ 可以创建销售预测和销售订单两种需求（支持universheet批量导入）
- ✅ 可以编辑和审核销售预测和销售订单
- ✅ 系统自动识别需求类型（销售预测→MTS，销售订单→MTO）
- ✅ 可以从需求下推到物料需求运算（一键下推）
- ✅ 需求详情页面显示下游关联单据（需求计算、工单、销售出库单等）
- ✅ 需求耗时统计准确（基于操作人员的工作时间段，排除非工作时间）
- ✅ 历史数据迁移成功

#### 步骤1.2：需求计算统一（2-3周）

**任务：**
1. 创建统一的需求计算页面（`demand-computation`）
2. 合并MRP和LRP运算逻辑为统一的需求计算服务
3. 实现灵活的参数配置功能
4. 实现需求类型自动识别和业务模式区分
5. **实现物料来源控制应用**（核心功能，新增）：
   - 实现需求计算时根据物料来源类型自动生成生产工单或采购订单
   - 实现BOM展开时虚拟件自动跳过逻辑
   - 实现委外件自动生成委外工单逻辑
   - 实现配置件按变体展开BOM逻辑
   - 实现物料来源验证（自制件必须有BOM和工艺路线，采购件建议配置默认供应商等）
6. 实现一键生成工单和采购单功能（根据物料来源类型智能生成）
7. 迁移现有MRP/LRP数据到统一的需求计算结果表
8. 删除独立的MRP和LRP页面和API

**交付物：**
- ✅ 统一的需求计算页面
- ✅ 统一的需求计算服务（包含物料来源控制逻辑）
- ✅ 灵活的参数配置功能
- ✅ **物料来源控制应用**（需求计算时的物料来源处理、BOM展开时的虚拟件跳过、委外件和配置件处理）
- ✅ 一键生成工单和采购单功能（根据物料来源类型智能生成）

**验收标准：**
- ✅ 可以从销售预测或销售订单下推进行需求计算
- ✅ 系统自动识别业务模式（MTS/MTO）
- ✅ **需求计算时根据物料来源类型自动生成生产工单或采购订单**
- ✅ **BOM展开时虚拟件自动跳过，直接展开下层物料**
- ✅ **委外件自动生成委外工单，并计算委外物料需求**
- ✅ **配置件按销售订单配置自动展开BOM变体**
- ✅ 参数配置灵活，支持不同业务场景
- ✅ 可以一键生成工单和采购单（根据物料来源类型）
- ✅ 历史数据迁移成功
- ✅ 旧的MRP/LRP页面已删除

#### 步骤1.3：单据关联与追溯（1周）

**任务：**
1. 实现单据关联关系建立（需求→需求计算→工单→采购单）
2. 实现单据上下游信息展示
3. 实现单据下推和上拉功能
4. 实现单据关联追溯查询

**交付物：**
- ✅ 单据关联关系模型
- ✅ 单据关联展示组件
- ✅ 单据下推和上拉功能
- ✅ 单据关联追溯查询功能

**验收标准：**
- ✅ 单据关联关系自动建立
- ✅ 单据详情页面显示上下游关联单据
- ✅ 支持从上游单据下推到下游单据
- ✅ 支持从下游单据上拉到上游单据
- ✅ 支持单据关联追溯查询

---

### 第二阶段：MES核心功能完善

**目标：** 完善MES制造执行系统核心功能，实现完整的生产执行流程

**时间估算：** 6-8周

**说明：** 本阶段专注于MES核心功能，包括工单管理、报工管理、生产领料、成品入库等生产执行相关功能。在核心流程统一完成后，完善MES执行层面的功能。

#### 步骤2.1：工单高级管理（1-2周）

**任务：**
1. **实现基于物料来源的工单生成和验证**（核心功能，新增）：
   - 生产计划时只对自制件生成生产工单（需要配置BOM和工艺路线）
   - 委外件生成委外工单（需要配置委外供应商和委外工序）
   - 虚拟件不生成工单（直接展开到下层物料）
   - 采购件不生成生产工单（生成采购订单）
   - 工单创建时验证物料来源配置完整性（自制件必须有BOM和工艺路线，委外件必须有委外供应商）
2. 实现返工单管理
3. 实现工单拆分功能
4. 实现工单合并功能
5. 实现工单冻结功能
6. 实现工单优先级管理
7. 实现执行中工单工序修改
8. **实现委外工单管理**（核心功能，新增）：
   - 实现委外工单创建和管理
   - 实现委外发料流程（提供给委外供应商的原材料）
   - 实现委外收货流程（委外加工完成后的成品）
   - 实现委外费用管理和应付单生成

**交付物：**
- ✅ **基于物料来源的工单生成和验证功能**（自制件、委外件、虚拟件、采购件的工单生成逻辑和验证）
- ✅ 返工单管理页面
- ✅ 工单拆分功能
- ✅ 工单合并功能
- ✅ 工单冻结功能
- ✅ 工单优先级管理
- ✅ 执行中工单工序修改功能
- ✅ **委外工单管理页面**（委外工单、委外发料、委外收货、委外费用管理）

**验收标准：**
- ✅ **生产计划时只对自制件生成生产工单**（需要BOM和工艺路线）
- ✅ **委外件生成委外工单**（需要委外供应商和委外工序）
- ✅ **虚拟件不生成工单**（自动跳过）
- ✅ **采购件不生成生产工单**（生成采购订单）
- ✅ **工单创建时验证物料来源配置完整性**
- ✅ 返工单管理流程完整
- ✅ 工单拆分功能正常
- ✅ 工单合并功能正常
- ✅ 工单冻结功能正常
- ✅ 工单优先级管理正常
- ✅ 执行中工单工序修改功能正常
- ✅ **委外工单管理流程完整**（委外发料、委外收货、委外费用管理）

#### 步骤2.2：报工高级功能（1-2周）

**任务：**
1. 实现报工数据修正功能
2. 实现报工统计分析功能
3. 实现工站上下料物料绑定功能
4. 实现带参数报工功能
5. 实现工序报废处理功能
6. 实现工序不良品处理功能
7. 实现按状态报工功能

**交付物：**
- ✅ 报工数据修正功能
- ✅ 报工统计分析页面
- ✅ 工站上下料物料绑定功能
- ✅ 带参数报工功能
- ✅ 工序报废处理功能
- ✅ 工序不良品处理功能
- ✅ 按状态报工功能

**验收标准：**
- ✅ 报工数据修正功能正常
- ✅ 报工统计分析准确
- ✅ 工站上下料物料绑定功能正常
- ✅ 带参数报工功能正常
- ✅ 工序报废处理流程完整
- ✅ 工序不良品处理流程完整
- ✅ 按状态报工功能正常

#### 步骤2.3：仓储高级功能（1-2周）

**任务：**
1. 实现库存盘点流程
2. 实现库存调拨流程
3. 实现装箱打包绑定功能
4. 实现客户来料登记功能

**交付物：**
- ✅ 库存盘点页面
- ✅ 库存调拨页面
- ✅ 装箱打包绑定功能
- ✅ 客户来料登记页面

**验收标准：**
- ✅ 库存盘点流程完整
- ✅ 库存调拨流程完整
- ✅ 装箱打包绑定功能正常
- ✅ 客户来料登记功能正常

#### 步骤2.4：单据执行效率优化（1周）

**任务：**
1. 实现单据节点耗时统计
2. 实现单据执行效率分析
3. 实现工作时间段配置

**交付物：**
- ✅ 单据节点耗时统计功能
- ✅ 单据执行效率分析页面
- ✅ 工作时间段配置功能

**验收标准：**
- ✅ 单据节点耗时统计准确
- ✅ 单据执行效率分析准确
- ✅ 工作时间段配置正常

#### 步骤2.5：异常处理（1周）

**任务：**
1. 实现缺料异常处理
2. 实现交期延期异常处理
3. 实现质量异常处理
4. 实现异常统计分析

**交付物：**
- ✅ 缺料异常处理页面
- ✅ 交期延期异常处理页面
- ✅ 质量异常处理页面
- ✅ 异常统计分析页面

**验收标准：**
- ✅ 缺料异常处理流程完整
- ✅ 交期延期异常处理流程完整
- ✅ 质量异常处理流程完整
- ✅ 异常统计分析准确

#### 步骤2.6：设备模具管理（2周）

**任务：**
1. 实现设备基础信息管理
2. 实现设备维护保养计划管理
3. 实现设备故障处理流程
4. 实现模具管理流程
5. 实现设备OEE统计

**交付物：**
- ✅ 设备基础信息管理页面
- ✅ 设备维护保养计划管理页面
- ✅ 设备故障处理页面
- ✅ 模具管理页面
- ✅ 设备OEE统计页面

**验收标准：**
- ✅ 设备基础信息管理功能完整
- ✅ 设备维护保养计划管理流程完整
- ✅ 设备故障处理流程完整
- ✅ 模具管理流程完整
- ✅ 设备OEE统计准确

#### 步骤2.7：成本核算（1-2周）

**任务：**
1. 实现生产成本核算（材料成本、人工成本、制造费用）
2. 实现委外成本核算
3. **实现基于物料来源的成本核算**（核心功能，新增）：
   - 实现自制件成本核算（材料成本（BOM展开）+ 加工成本（工序成本）+ 制造费用）
   - 实现采购件成本核算（采购价格 + 采购费用）
   - 实现虚拟件成本核算（不单独核算，成本直接计入上层物料）
   - 实现委外件成本核算（材料成本（提供给委外供应商的原材料）+ 委外加工费用）
   - 实现配置件成本核算（根据选择的变体BOM，按变体计算成本）
4. 实现质量成本核算
5. 实现标准成本和实际成本对比
6. 实现成本优化建议

**交付物：**
- ✅ 生产成本核算页面
- ✅ 委外成本核算页面
- ✅ **基于物料来源的成本核算功能**（自制件、采购件、虚拟件、委外件、配置件成本核算）
- ✅ 质量成本核算页面
- ✅ 成本对比分析页面
- ✅ 成本优化建议功能

**验收标准：**
- ✅ 生产成本核算准确
- ✅ 委外成本核算准确
- ✅ **自制件成本核算准确**（材料成本 + 加工成本 + 制造费用）
- ✅ **采购件成本核算准确**（采购价格 + 采购费用）
- ✅ **虚拟件成本核算正确**（成本直接计入上层物料，不单独核算）
- ✅ **委外件成本核算准确**（材料成本 + 委外加工费用）
- ✅ **配置件成本核算准确**（按变体BOM计算成本）
- ✅ 质量成本核算准确
- ✅ 标准成本和实际成本对比准确
- ✅ 成本优化建议功能正常

---

### 第三阶段：需求驱动流程完善

**目标：** 完善需求驱动的完整业务流程（从需求计算到销售出库的完整闭环）

**时间估算：** 6-8周

**说明：** 本阶段完善从需求计算到销售出库的完整业务流程。销售预测和销售订单作为流程源头已在第一阶段完成，本阶段主要实现流程中下游环节。

#### 步骤3.1：采购管理流程（2周）

**任务：**
1. 完善采购订单管理
2. **实现基于物料来源的采购订单生成**（核心功能，新增）：
   - 需求计算时只对采购件生成采购订单
   - 虚拟件不生成采购订单（展开到下层物料后再判断）
   - 自动填充默认供应商和采购价格（从物料主数据获取）
3. 实现采购入库流程
4. 实现采购审批流程（可选）
5. 实现供应商管理（在master-data中）

**交付物：**
- ✅ 采购订单管理页面
- ✅ **基于物料来源的采购订单生成功能**（采购件自动生成采购订单，虚拟件跳过）
- ✅ 采购入库页面
- ✅ 采购审批流程（可选）
- ✅ 供应商管理（master-data）

**验收标准：**
- ✅ 可以从需求计算结果一键生成采购单（只对采购件生成）
- ✅ **虚拟件不生成采购订单**（自动跳过，展开到下层物料）
- ✅ **采购订单自动填充默认供应商和采购价格**（从物料主数据获取）
- ✅ 采购入库流程完整
- ✅ 采购单与需求计算关联

#### 步骤3.2：销售出库流程（流程末端，1-2周）

**说明：** 销售出库是业务流程的末端，需要关联到流程源头的销售预测（MTS模式）或销售订单（MTO模式）。

**任务：**
1. 完善销售出库管理
2. 实现批号和序列号选择功能
3. 实现销售出库与需求关联（MTS模式关联销售预测，MTO模式关联销售订单）
4. 实现销售出库单上拉功能（从销售出库单上拉到销售预测或销售订单）
5. 实现销售退货流程
6. 实现采购退货流程
7. 实现库存预警和自动补货建议

**交付物：**
- ✅ 销售出库管理页面
- ✅ 批号和序列号选择功能
- ✅ 销售出库与需求关联功能（MTS关联销售预测，MTO关联销售订单）
- ✅ 销售出库单上拉功能
- ✅ 销售退货页面
- ✅ 采购退货页面
- ✅ 库存预警和自动补货建议功能

**验收标准：**
- ✅ 销售出库流程完整
- ✅ 支持批号和序列号选择
- ✅ 销售出库与需求自动关联（MTS模式关联销售预测，MTO模式关联销售订单）
- ✅ 可以从销售出库单上拉到销售预测或销售订单
- ✅ 销售退货流程完整
- ✅ 采购退货流程完整
- ✅ 库存预警和自动补货建议功能正常

#### 步骤3.3：质量管理流程（2-3周）

**任务：**
1. 实现质检标准管理
2. 实现来料检验流程
3. 实现过程检验流程
4. 实现成品检验流程
5. 实现不合格品处理流程
6. 实现质检报表分析

**交付物：**
- ✅ 质检标准管理页面
- ✅ 来料检验页面
- ✅ 过程检验页面
- ✅ 成品检验页面
- ✅ 不合格品处理页面
- ✅ 质检报表分析页面

**验收标准：**
- ✅ 质检标准管理功能完整
- ✅ 来料检验流程完整
- ✅ 过程检验流程完整
- ✅ 成品检验流程完整
- ✅ 不合格品处理流程完整
- ✅ 质检报表分析准确

#### 步骤3.4：财务管理流程（1-2周）

**任务：**
1. 实现应付管理
2. 实现应收管理
3. 实现财务与业务单据关联

**交付物：**
- ✅ 应付管理页面
- ✅ 应收管理页面
- ✅ 财务与业务单据关联功能

**验收标准：**
- ✅ 应付管理流程完整
- ✅ 应收管理流程完整
- ✅ 财务与业务单据自动关联

---

### 第四阶段：系统配置与基础数据优化

**目标：** 优化系统配置和基础数据管理，支持极简模式和全流程模式

**时间估算：** 4-6周

**说明：** 本阶段可以与第三阶段并行进行，或作为后续阶段。主要实现系统初始化向导、业务配置功能、基础数据配置优化等。

#### 步骤4.1：系统初始化向导（1-2周）

**任务：**
1. 实现快速初始化向导
2. 实现行业模板功能
3. 实现智能默认值配置
4. 实现编码规则配置
5. 实现AI智能建议功能（通过Inngest AI工作流）
6. 实现内置帮助系统（操作提示、帮助文档、操作视频）

**交付物：**
- ✅ 快速初始化向导页面
- ✅ 行业模板功能
- ✅ 智能默认值配置
- ✅ 编码规则配置
- ✅ AI智能建议功能
- ✅ 内置帮助系统

**验收标准：**
- ✅ 新用户注册后自动进入初始化向导
- ✅ 可以选择行业模板一键应用
- ✅ 所有配置项都有智能默认值
- ✅ 编码规则配置成功
- ✅ AI智能建议功能正常（侧边栏提示，不打断操作流程）
- ✅ 内置帮助系统功能完整（操作提示、帮助文档、操作视频）

#### 步骤4.2：业务配置功能（2周）

**任务：**
1. 实现运行模式切换（极简模式/全流程模式）
2. 实现流程模块开关配置
3. 实现流程参数配置
4. 实现PRO版功能标识
5. 实现配置模板管理

**交付物：**
- ✅ 业务配置页面
- ✅ 运行模式切换功能
- ✅ 流程模块开关配置
- ✅ 流程参数配置
- ✅ PRO版功能标识
- ✅ 配置模板管理

**验收标准：**
- ✅ 可以一键切换运行模式
- ✅ 可以独立开启/关闭流程模块
- ✅ 可以配置流程参数
- ✅ PRO版功能明确标识
- ✅ 可以保存和导入配置模板

#### 步骤4.3：基础数据配置优化（1-2周）

**任务：**
1. 优化组织架构配置（批量导入）
2. 优化物料主数据配置（物料编码映射、多单位管理、批号管理、序列号管理、**物料来源控制**）
3. 实现物料编码映射工具（解决编码不统一问题）
4. **实现物料来源控制功能**（核心功能，新增）：
   - 实现物料来源类型配置（自制件、采购件、虚拟件、委外件、配置件）
   - 实现物料来源相关配置（BOM、工艺路线、供应商、委外供应商等）
   - 实现物料来源验证规则（自制件必须有BOM和工艺路线，采购件建议配置默认供应商等）
   - 实现物料来源变更控制（变更需要审批，系统自动处理变更影响）
   - 实现物料来源智能建议（基于物料类型和历史数据建议物料来源类型）
5. 优化工序和工艺路线配置（工序类型、跳转规则、物料分组绑定、子工艺路线、版本管理、变更管理）
6. 优化仓库配置（工作时间段配置）
7. 优化供应链主数据配置
8. 实现期初数据导入（上线倒计时功能）

**交付物：**
- ✅ 优化的组织架构配置页面
- ✅ 优化的物料主数据配置页面（包含物料来源控制）
- ✅ 物料编码映射工具
- ✅ **物料来源控制功能**（物料来源类型配置、相关配置、验证规则、变更控制、智能建议）
- ✅ 优化的工序和工艺路线配置页面（包含工序类型、跳转规则、物料分组绑定、子工艺路线、版本管理、变更管理）
- ✅ 优化的仓库配置页面（包含工作时间段配置）
- ✅ 优化的供应链主数据配置页面
- ✅ 期初数据导入页面（上线倒计时功能）

**验收标准：**
- ✅ 支持批量导入组织架构
- ✅ 支持物料编码映射
- ✅ 物料编码映射工具功能完整
- ✅ 支持多单位管理
- ✅ 支持批号和序列号管理
- ✅ **支持物料来源控制**（物料来源类型配置、相关配置、验证规则、变更控制、智能建议）
- ✅ 支持工序类型和跳转规则配置
- ✅ 支持物料分组绑定
- ✅ 支持子工艺路线配置
- ✅ 支持工艺路线版本管理
- ✅ 支持工艺路线变更管理
- ✅ 支持工作时间段配置
- ✅ 期初数据导入功能完整（上线倒计时）

---

### 第五阶段：高级功能与体验优化（MES扩展功能）

**目标：** 实现MES扩展功能和用户体验优化

**时间估算：** 4-6周

**说明：** 本阶段实现MES扩展功能，包括二维码体系、工位机触屏模式、工作台快捷操作、报表分析等。这些功能可以提升MES系统的易用性和扩展性。

**注意：** 物料来源控制的基础功能已在第四阶段的基础数据配置优化中实现，其应用已在第一阶段的需求计算和第三阶段的采购管理流程中实现。

#### 步骤5.1：二维码体系（2周）

**任务：**
1. 实现物料码（MAT）全流程应用
2. 实现工单码（WO）全流程应用
3. 实现工序码（OP）全流程应用
4. 实现设备码（EQ）全流程应用
5. 实现人员码（EMP）全流程应用
6. 实现装箱码（BOX）全流程应用
7. 实现追溯码（TRACE）全流程应用

**交付物：**
- ✅ 二维码生成和解析功能
- ✅ 二维码全流程应用
- ✅ 二维码追溯功能

**验收标准：**
- ✅ 所有业务对象支持二维码
- ✅ 二维码全流程应用正常
- ✅ 二维码追溯功能正常

#### 步骤5.2：工位机触屏模式（1-2周）

**任务：**
1. 实现工位机触屏模式切换
2. 实现现场报工（工位机触屏模式）
3. 实现SOP查看（工位机触屏模式）
4. 实现图纸查看（工位机触屏模式）
5. 实现加工程序查看（工位机触屏模式）

**交付物：**
- ✅ 工位机触屏模式页面
- ✅ 现场报工（触屏模式）
- ✅ SOP查看（触屏模式）
- ✅ 图纸查看（触屏模式）
- ✅ 加工程序查看（触屏模式）

**验收标准：**
- ✅ 工位机触屏模式切换正常
- ✅ 触屏模式界面适配良好
- ✅ 触屏模式功能完整

#### 步骤5.3：工作台快捷操作（1周）

**任务：**
1. 实现工作台首页
2. 实现快捷操作功能
3. 实现待办事项展示
4. 实现数据看板

**交付物：**
- ✅ 工作台首页
- ✅ 快捷操作功能
- ✅ 待办事项展示
- ✅ 数据看板

**验收标准：**
- ✅ 工作台首页功能完整
- ✅ 快捷操作功能正常
- ✅ 待办事项展示准确
- ✅ 数据看板数据准确

#### 步骤5.4：报表分析（1-2周）

**任务：**
1. 实现库存报表
2. 实现生产报表
3. 实现质量报表
4. 实现报工统计分析
5. 实现自定义报表设计器（自研方案，基于@dnd-kit + @ant-design/charts）

**交付物：**
- ✅ 库存报表页面
- ✅ 生产报表页面
- ✅ 质量报表页面
- ✅ 报工统计分析页面
- ✅ 自定义报表设计器

**验收标准：**
- ✅ 库存报表数据准确
- ✅ 生产报表数据准确
- ✅ 质量报表数据准确
- ✅ 报工统计分析准确
- ✅ 自定义报表设计器功能完整

---

### 第六阶段：扩展功能与集成

**目标：** 实现扩展功能和系统集成

**时间估算：** 8-12周

**说明：** 本阶段实现通用需求功能、多角色场景、降低上线失败风险最佳实践、AI智能建议等扩展功能。

#### 步骤6.1：通用需求功能（1-2周）

**任务：**
1. 实现数据导入导出（UniSheet在线表格）
2. 实现高级搜索（拼音搜索、快速筛选、筛选条件保存）
3. 实现打印功能
4. 实现移动端和工位机触屏支持
5. 实现实时数据推送（WebSocket）
6. 实现权限管理（RBAC）
7. 实现审批流程

**交付物：**
- ✅ 数据导入导出功能（UniSheet）
- ✅ 高级搜索功能
- ✅ 打印功能
- ✅ 移动端和工位机触屏支持
- ✅ 实时数据推送功能（WebSocket）
- ✅ 权限管理功能（RBAC）
- ✅ 审批流程功能

**验收标准：**
- ✅ 数据导入导出功能正常（UniSheet在线表格）
- ✅ 高级搜索功能正常（拼音搜索、快速筛选）
- ✅ 打印功能正常
- ✅ 移动端和工位机触屏支持正常
- ✅ 实时数据推送正常（WebSocket）
- ✅ 权限管理功能正常（RBAC）
- ✅ 审批流程功能正常

#### 步骤6.2：多角色场景与自助式上线向导（2周）

**任务：**
1. 实现多角色场景推演（13个角色：销售、采购、仓库、技术研发、生产计划、班组长、生产人员、质量组、设备组、财务、管理者、系统实施人员）
2. 实现自助式上线向导（各角色上线准备向导）
3. 实现各角色完整使用场景

**交付物：**
- ✅ 多角色场景推演功能
- ✅ 自助式上线向导（13个角色）
- ✅ 各角色完整使用场景

**验收标准：**
- ✅ 13个角色的场景推演功能完整
- ✅ 自助式上线向导功能完整
- ✅ 各角色完整使用场景可用

#### 步骤6.3：降低上线失败风险最佳实践（1-2周）

**任务：**
1. 实现数据质量保障机制（数据验证机制、数据清洗建议）
2. 实现操作引导和帮助系统（内置帮助系统、操作确认和错误提示）
3. 实现上线进度跟踪和检查清单
4. 实现系统性能优化机制
5. 实现持续优化建议（使用情况分析、优化建议推送）

**交付物：**
- ✅ 数据验证机制
- ✅ 数据清洗建议功能
- ✅ 内置帮助系统
- ✅ 操作确认和错误提示功能
- ✅ 上线进度跟踪功能
- ✅ 上线检查清单功能
- ✅ 性能优化机制
- ✅ 使用情况分析功能
- ✅ 优化建议推送功能

**验收标准：**
- ✅ 数据验证机制正常
- ✅ 数据清洗建议功能正常
- ✅ 内置帮助系统功能完整
- ✅ 操作确认和错误提示功能正常
- ✅ 上线进度跟踪功能正常
- ✅ 上线检查清单功能完整
- ✅ 性能优化机制正常
- ✅ 使用情况分析准确
- ✅ 优化建议推送功能正常

#### 步骤6.4：AI智能建议功能（1周）

**任务：**
1. 实现AI智能建议功能（通过Inngest AI工作流）
2. 实现基于行业最佳实践的建议
3. 实现配置优化建议
4. 实现业务流程优化建议

**交付物：**
- ✅ AI智能建议功能
- ✅ 行业最佳实践建议
- ✅ 配置优化建议
- ✅ 业务流程优化建议

**验收标准：**
- ✅ AI智能建议功能正常
- ✅ 行业最佳实践建议准确
- ✅ 配置优化建议准确
- ✅ 业务流程优化建议准确

---

### 第七阶段：持续优化与PRO版功能

**目标：** 持续优化和PRO版功能开发

**时间估算：** 持续进行

**说明：** 本阶段进行持续的性能优化、用户体验优化，以及高级排产、委外管理、企业上下游协同等高级功能，PRO版功能作为远期规划。

#### 步骤7.1：性能优化（持续）

**任务：**
1. 优化数据库查询性能
2. 优化前端页面加载性能
3. 优化API响应时间
4. 优化大数据量处理性能

**交付物：**
- ✅ 性能优化报告
- ✅ 性能优化代码

**验收标准：**
- ✅ 数据库查询性能提升
- ✅ 前端页面加载速度提升
- ✅ API响应时间缩短
- ✅ 大数据量处理性能提升

#### 步骤7.2：用户体验优化（持续）

**任务：**
1. 优化操作流程，减少操作步骤
2. 优化界面设计，提升用户体验
3. 优化错误提示和帮助系统
4. 优化移动端和工位机触屏模式体验

**交付物：**
- ✅ 用户体验优化报告
- ✅ 用户体验优化代码

**验收标准：**
- ✅ 操作步骤减少
- ✅ 界面设计优化
- ✅ 错误提示和帮助系统完善
- ✅ 移动端和工位机触屏模式体验提升

#### 步骤7.3：高级排产与委外管理（1-2周）

**任务：**
1. 实现高级排产（智能排产算法、多约束优化）
2. 实现工序委外管理（委外协同、委外结算）

**交付物：**
- ✅ 高级排产功能
- ✅ 工序委外管理页面

**验收标准：**
- ✅ 高级排产功能正常（智能排产算法、多约束优化）
- ✅ 工序委外管理流程完整（委外协同、委外结算）

#### 步骤7.4：企业上下游协同（1-2周）

**任务：**
1. 实现供应商协同（供应商协同平台）
2. 实现客户协同（客户协同平台）

**交付物：**
- ✅ 供应商协同平台
- ✅ 客户协同平台

**验收标准：**
- ✅ 供应商协同平台功能完整
- ✅ 客户协同平台功能完整

#### 步骤7.5：PRO版功能（远期）

**任务：**
1. 采购询价（多供应商询价、比价分析）
2. 采购合同（合同管理、合同执行跟踪）
3. 质量统计分析（质量趋势分析、质量成本分析）
4. 仓储优化建议（库存优化、仓储布局优化）
5. 财务分析（财务报表、财务预测、财务分析）
6. 多级审批（复杂审批流程、审批路由）
7. 自定义审批流程（可视化流程设计器）
8. 自定义字段（业务字段扩展）
9. 自定义报表扩展（报表设计器扩展）
10. 自定义工作流（工作流设计器）
11. 第三方系统集成（ERP、PLM、SCADA集成）

**交付物：**
- ✅ PRO版功能列表
- ✅ PRO版功能开发计划

**验收标准：**
- ✅ PRO版功能明确标识
- ✅ PRO版功能开发计划清晰

---

## 4. 开发优先级说明

### 4.1 最高优先级（核心流程统一，优先完成）

**第一阶段：核心流程统一与重构**
- 工单高级管理（返工、拆分、合并、冻结、优先级、工序修改）
- 报工高级功能（数据修正、统计分析、上下料绑定、带参数报工、工序报废、工序不良品、按状态报工）
- 仓储高级功能（盘点、调拨、装箱打包、客户来料登记）
- 单据执行效率优化（耗时统计、效率分析、工作时间段配置）
- 异常处理（缺料、交期延期、质量异常）
- 设备模具管理（设备信息、维护保养、故障处理、模具管理、OEE统计）
- 成本核算（生产成本、委外成本、质量成本、成本对比、优化建议）

### 4.2 高优先级（MES核心功能，核心流程完成后）

**第二阶段：MES核心功能完善**
- 工单高级管理（返工、拆分、合并、冻结、优先级、工序修改）
- 报工高级功能（数据修正、统计分析、上下料绑定、带参数报工、工序报废、工序不良品、按状态报工）
- 仓储高级功能（盘点、调拨、装箱打包、客户来料登记）
- 单据执行效率优化（耗时统计、效率分析、工作时间段配置）
- 异常处理（缺料、交期延期、质量异常）
- 设备模具管理（设备信息、维护保养、故障处理、模具管理、OEE统计）
- 成本核算（生产成本、委外成本、质量成本、成本对比、优化建议）

**第三阶段：需求驱动流程完善**
- 采购管理流程
- 销售出库流程
- 质量管理流程（基础版）
- 财务管理流程（基础版）

### 4.3 中优先级（重要功能）

**第三阶段：系统配置与基础数据优化**
- 系统初始化向导
- 业务配置功能
- 基础数据配置优化

**第四阶段：高级功能与体验优化（MES扩展功能）**
- 二维码体系
- 工位机触屏模式
- 工作台快捷操作
- 报表分析

### 4.4 低优先级（扩展功能）

**第五阶段：扩展功能与集成**
- 通用需求功能（数据导入导出、高级搜索、打印、移动端支持、实时推送、权限管理、审批流程）
- 多角色场景与自助式上线向导
- 降低上线失败风险最佳实践
- AI智能建议功能

**第六阶段：持续优化与PRO版功能**
- 性能优化
- 用户体验优化
- 高级排产与委外管理
- 企业上下游协同
- PRO版功能（远期）

---

## 5. 关键里程碑

### 里程碑1：核心流程统一完成（第一阶段结束）

**时间：** 第一阶段完成后

**交付物：**
- ✅ 统一的需求管理
- ✅ 统一的需求计算
- ✅ 单据关联与追溯

**验收标准：**
- ✅ 可以从销售预测或销售订单下推进行需求计算
- ✅ 系统自动识别业务模式（MTS/MTO）
- ✅ 可以一键生成工单和采购单
- ✅ 单据关联关系自动建立

### 里程碑2：MES核心功能完成（第二阶段结束）

**时间：** 第二阶段完成后

**交付物：**
- ✅ 工单高级管理功能完整
- ✅ 报工高级功能完整
- ✅ 仓储高级功能完整
- ✅ 单据执行效率优化功能完整
- ✅ 异常处理功能完整
- ✅ 设备模具管理功能完整
- ✅ 成本核算功能完整

**验收标准：**
- ✅ MES核心功能全部可用
- ✅ 生产执行流程完整
- ✅ 异常处理流程完整
- ✅ 设备模具管理功能完整
- ✅ 成本核算功能完整

### 里程碑3：完整业务流程实现（第三阶段结束）

**时间：** 第二阶段完成后

**交付物：**
- ✅ 完整的采购管理流程
- ✅ 完整的销售出库流程
- ✅ 完整的质量管理流程（基础版）
- ✅ 完整的财务管理流程（基础版）

**验收标准：**
- ✅ 从需求到出库的完整流程可用
- ✅ 所有核心业务流程完整
- ✅ 单据关联关系完整

### 里程碑4：系统配置完善（第四阶段结束）

**时间：** 第四阶段完成后

**交付物：**
- ✅ 系统初始化向导
- ✅ 业务配置功能
- ✅ 基础数据配置优化

**验收标准：**
- ✅ 新用户可以通过向导快速初始化
- ✅ 可以切换运行模式（极简/全流程）
- ✅ 可以按需开启/关闭功能模块

### 里程碑5：MES扩展功能实现（第五阶段结束）

**时间：** 第五阶段完成后

**交付物：**
- ✅ 二维码体系
- ✅ 工位机触屏模式
- ✅ 工作台快捷操作
- ✅ 报表分析

**验收标准：**
- ✅ 二维码体系全流程应用正常
- ✅ 工位机触屏模式功能完整
- ✅ 工作台快捷操作功能完整
- ✅ 报表分析功能完整

### 里程碑6：扩展功能实现（第六阶段结束）

**时间：** 第六阶段完成后

**交付物：**
- ✅ 通用需求功能
- ✅ 多角色场景与自助式上线向导
- ✅ 降低上线失败风险最佳实践
- ✅ AI智能建议功能

**验收标准：**
- ✅ 通用需求功能完整
- ✅ 多角色场景推演完整
- ✅ 自助式上线向导功能完整
- ✅ 降低上线失败风险机制完整
- ✅ AI智能建议功能正常

**时间：** 第五阶段完成后

**交付物：**
- ✅ 二维码体系
- ✅ 工位机触屏模式
- ✅ 工作台快捷操作
- ✅ 报表分析
- ✅ 通用需求功能
- ✅ 多角色场景与自助式上线向导
- ✅ 降低上线失败风险最佳实践
- ✅ AI智能建议功能

**验收标准：**
- ✅ 所有扩展功能可用
- ✅ 多角色场景推演完整
- ✅ 自助式上线向导功能完整
- ✅ 降低上线失败风险机制完整
- ✅ AI智能建议功能正常

---

## 6. 风险与应对

### 6.1 技术风险

**风险：** MRP和LRP运算逻辑合并可能影响现有功能

**应对：**
- 充分测试合并后的需求计算逻辑
- 保留旧数据迁移方案
- 提供数据回滚机制

### 6.2 数据迁移风险

**风险：** 历史数据迁移可能丢失或出错

**应对：**
- 制定详细的数据迁移方案
- 充分测试数据迁移脚本
- 提供数据迁移回滚机制
- 迁移前备份所有数据

### 6.3 用户体验风险

**风险：** 功能合并可能影响用户习惯

**应对：**
- 提供用户引导和帮助文档
- 保留旧功能入口一段时间（过渡期）
- 收集用户反馈，持续优化

---

## 7. 总结

本文档制定了基于优化后流程的宏观渐进式开发计划，分为七个阶段：

**开发策略调整：** 优先完成核心流程统一与重构，建立系统基础架构，然后再完善MES执行功能。

1. **第一阶段：核心流程统一与重构** - 统一业务流程主线，实现需求驱动，建立系统基础架构
   - **物料来源控制应用**：需求计算时根据物料来源类型自动生成生产工单或采购订单
2. **第二阶段：MES核心功能完善** - 完善MES制造执行系统核心功能，实现完整的生产执行流程
   - **物料来源控制应用**：工单生成和验证、委外工单管理、基于物料来源的成本核算
3. **第三阶段：需求驱动流程完善** - 完善完整业务流程
   - **物料来源控制应用**：基于物料来源的采购订单生成（只对采购件生成采购订单）
4. **第四阶段：系统配置与基础数据优化** - 支持极简模式和全流程模式
   - **物料来源控制基础功能**：物料来源类型配置、相关配置、验证规则、变更控制、智能建议
5. **第五阶段：高级功能与体验优化（MES扩展功能）** - 实现高级功能和体验优化
6. **第六阶段：扩展功能与集成** - 实现扩展功能和系统集成
7. **第七阶段：持续优化与PRO版功能** - 持续优化和PRO版功能开发

**物料来源控制功能说明：**
- **基础配置**（第四阶段）：物料来源类型配置（自制件、采购件、虚拟件、委外件、配置件）及相关配置
- **需求计算应用**（第一阶段）：根据物料来源类型自动生成生产工单或采购订单，虚拟件自动跳过
- **生产计划应用**（第二阶段）：工单生成验证、委外工单管理
- **采购计划应用**（第三阶段）：只对采购件生成采购订单
- **成本核算应用**（第二阶段）：基于物料来源的成本核算（自制件、采购件、虚拟件、委外件、配置件）

每个阶段都有明确的目标、任务、交付物和验收标准，确保开发工作有序推进。

**开发顺序说明：**
- ✅ **优先完成核心流程统一**：需求管理、需求计算、单据关联等基础架构
- ✅ **核心流程完成后完善MES**：工单管理、报工管理、生产领料、成品入库等生产执行核心功能
- ✅ **并行或后续完成**：系统配置、基础数据优化、扩展功能等

---

**文档创建时间：** 2025-12-27  
**文档作者：** Auto (AI Assistant)  
**文档版本：** v1.1  
**最后更新：** 2026-01-16（更新物料来源控制功能）
