# 物料编码管理设计规范

> 本文档从《用户使用场景推演-MTS-MTO.md》和《BOM-工艺路线-标准作业流程设计规范.md》中提取了关于物料编码管理的核心设计内容，用于强化设计参考。

**提取日期**：2026-01-08  
**来源文档**：用户使用场景推演-MTS-MTO.md、BOM-工艺路线-标准作业流程设计规范.md  
**设计阶段**：强化设计阶段

---

## 目录

1. [物料编码体系概述](#1-物料编码体系概述)
2. [编码规则配置管理](#2-编码规则配置管理)
3. [主编码体系](#3-主编码体系)
4. [部门编码体系](#4-部门编码体系)
5. [编码映射机制](#5-编码映射机制)
6. [物料变体管理](#6-物料变体管理)
7. [智能识别重复物料](#7-智能识别重复物料)
8. [物料映射工具](#8-物料映射工具)
9. [多编码搜索](#9-多编码搜索)
10. [新建物料界面设计](#10-新建物料界面设计)
11. [使用场景](#11-使用场景)
12. [验收标准](#12-验收标准)
13. [设计要点](#13-设计要点)
14. [后续强化设计方向](#14-后续强化设计方向)

---

## 1. 物料编码体系概述

### 1.1 编码体系设计目标

- **解决编码不统一问题**：各部门可继续使用原有编码，系统自动映射
- **不中断业务**：先导入后整理，业务可正常使用
- **渐进式整理**：逐步建立映射关系，不强制一次性统一
- **智能识别**：AI辅助识别重复物料，减少人工工作量
- **灵活使用**：各部门可继续使用原有编码，系统自动映射到主编码

### 1.2 编码体系架构

```
物料编码体系
├── 主编码（系统内部唯一标识）
│   └── MAT-{类型}-{序号}
│       ├── MAT-FIN-0001（成品）
│       ├── MAT-SEMI-0001（半成品）
│       └── MAT-RAW-0001（原材料）
└── 部门编码（业务使用，作为别名）
    ├── 销售编码：SALE-A001
    ├── 设计编码：DES-A001
    ├── 供应商编码：SUP-A001
    ├── 采购编码：PUR-A001
    ├── 仓库编码：WH-A001
    └── 生产编码：PROD-A001
```

### 1.3 编码映射关系

- **一对多关系**：一个主编码可以对应多个部门编码
- **自动映射**：输入任意部门编码，系统自动映射到主编码
- **双向查询**：支持通过主编码查询部门编码，也支持通过部门编码查询主编码

---

## 2. 编码规则配置管理

### 2.1 编码规则配置概述

编码规则配置是系统级功能，允许组织管理员通过可视化界面自定义物料编码的生成规则和验证规则，而不是硬编码在系统中。这样可以满足不同组织的编码习惯和业务需求。

**核心原则**：
- **规则可配置**：所有编码规则通过系统配置界面管理，不使用硬编码
- **规则引擎驱动**：编码生成和验证由规则引擎执行
- **规则版本管理**：支持规则的版本管理和历史追溯
- **规则生效控制**：支持规则的启用/禁用和生效时间控制

### 2.2 主编码规则配置

#### 2.2.1 规则配置项

**编码格式模板**：
- 支持自定义编码格式模板，使用占位符定义格式
- 占位符类型：
  - `{PREFIX}`：前缀（固定字符串）
  - `{TYPE}`：物料类型代码
  - `{SEQUENCE}`：序号
  - `{DATE}`：日期（年月日）
  - `{YEAR}`：年份（4位）
  - `{MONTH}`：月份（2位）
  - `{DAY}`：日期（2位）
  - `{ORG}`：组织代码
  - `{DEPT}`：部门代码

**物料类型分类配置**：
- 支持自定义物料类型及其代码
- 配置项：类型名称、类型代码、类型描述、序号是否独立计数
- 示例配置：
  ```json
  {
    "material_types": [
      {
        "name": "成品",
        "code": "FIN",
        "description": "Finished Goods",
        "independent_sequence": true
      },
      {
        "name": "半成品",
        "code": "SEMI",
        "description": "Semi-finished Goods",
        "independent_sequence": true
      }
    ]
  }
  ```

**序号规则配置**：
- 序号位数：支持1-10位数字
- 起始值：支持自定义起始值（默认1）
- 步长：支持自定义步长（默认1）
- 填充方式：左填充或右填充，填充字符（默认0）
- 是否按类型独立计数：支持按类型分别计数或全局统一计数

**默认规则示例**：
```json
{
  "main_code_rule": {
    "template": "{PREFIX}-{TYPE}-{SEQUENCE}",
    "prefix": "MAT",
    "sequence": {
      "length": 4,
      "start_value": 1,
      "step": 1,
      "padding": {
        "direction": "left",
        "char": "0"
      },
      "independent_by_type": true
    },
    "material_types": [
      { "code": "FIN", "name": "成品" },
      { "code": "SEMI", "name": "半成品" },
      { "code": "RAW", "name": "原材料" }
    ]
  }
}
```

#### 2.2.2 规则配置界面

**主编码规则配置页面**：
- 路径：系统设置 → 编码规则管理 → 主编码规则
- 功能：
  1. **格式模板编辑器**：可视化编辑编码格式模板
  2. **物料类型管理**：添加、编辑、删除物料类型
  3. **序号规则配置**：配置序号生成规则
  4. **规则预览**：实时预览编码生成效果
  5. **规则测试**：测试规则生成的编码是否符合要求
  6. **规则启用/禁用**：控制规则是否生效
  7. **规则历史**：查看规则变更历史

**规则验证**：
- 格式模板验证：确保占位符正确使用
- 物料类型验证：确保类型代码唯一
- 序号规则验证：确保规则配置合理
- 编码唯一性验证：确保生成的编码不会重复

### 2.3 部门编码规则配置

#### 2.3.1 部门编码类型配置

**编码类型管理**：
- 支持自定义部门编码类型
- 配置项：类型代码、类型名称、使用部门、格式模板、验证规则
- 示例配置：
  ```json
  {
    "alias_code_types": [
      {
        "code": "SALE",
        "name": "销售编码",
        "departments": ["销售部"],
        "template": "{PREFIX}-{DEPT}-{SEQUENCE}",
        "prefix": "SALE",
        "validation": {
          "pattern": "^SALE-[A-Z]{1,3}-[0-9]{3,}$",
          "required": false
        }
      }
    ]
  }
  ```

**格式模板配置**：
- 每个部门编码类型可以配置独立的格式模板
- 支持使用与主编码相同的占位符
- 支持自定义验证规则（正则表达式）

#### 2.3.2 部门编码规则配置界面

**部门编码规则配置页面**：
- 路径：系统设置 → 编码规则管理 → 部门编码规则
- 功能：
  1. **编码类型列表**：显示所有部门编码类型
  2. **添加编码类型**：创建新的部门编码类型
  3. **编辑编码类型**：修改编码类型的配置
  4. **删除编码类型**：删除不需要的编码类型
  5. **格式模板配置**：为每个类型配置格式模板
  6. **验证规则配置**：配置编码验证规则
  7. **规则启用/禁用**：控制规则是否生效

### 2.4 编码规则引擎

#### 2.4.1 规则引擎架构

**规则引擎组件**：
- **规则解析器**：解析编码格式模板和占位符
- **规则执行器**：根据规则生成编码
- **规则验证器**：验证生成的编码是否符合规则
- **规则缓存**：缓存常用规则，提高性能

**规则执行流程**：
1. 获取当前生效的编码规则配置
2. 解析格式模板，识别占位符
3. 根据占位符类型获取对应值
4. 组装生成完整编码
5. 验证编码格式和唯一性
6. 返回生成的编码

#### 2.4.2 规则引擎特性

**高性能**：
- 规则缓存机制，减少数据库查询
- 批量生成编码时优化性能
- 支持异步生成编码

**灵活性**：
- 支持复杂的格式模板
- 支持自定义验证规则
- 支持规则动态切换

**可扩展性**：
- 支持自定义占位符
- 支持自定义验证逻辑
- 支持插件化扩展

### 2.5 规则版本管理

#### 2.5.1 规则版本控制

**版本记录**：
- 每次规则变更自动创建新版本
- 记录版本号、变更时间、变更人、变更内容
- 支持版本对比和回滚

**版本管理功能**：
- 查看规则历史版本
- 对比不同版本的差异
- 回滚到指定版本
- 导出规则配置

#### 2.5.2 规则生效控制

**生效时间控制**：
- 支持设置规则的生效时间
- 支持规则的启用/禁用
- 支持规则的分批生效

**规则影响评估**：
- 变更规则前评估影响范围
- 提示可能受影响的数据
- 提供变更预览功能

### 2.6 规则配置权限

**权限管理**：
- **查看权限**：普通用户可查看规则配置
- **编辑权限**：组织管理员可编辑规则配置
- **审核权限**：超级管理员可审核规则变更
- **历史查看权限**：管理员可查看规则历史

**操作日志**：
- 记录所有规则配置操作
- 记录操作人、操作时间、操作内容
- 支持操作日志查询和导出

### 2.7 数据库设计

#### 2.7.1 编码规则配置表

**主编码规则配置表（material_code_rule_main）**：
```sql
CREATE TABLE material_code_rule_main (
    id SERIAL PRIMARY KEY,
    org_id INTEGER NOT NULL,                    -- 组织ID
    rule_name VARCHAR(100) NOT NULL,            -- 规则名称
    template VARCHAR(200) NOT NULL,             -- 格式模板
    prefix VARCHAR(50),                         -- 前缀
    sequence_config JSONB,                      -- 序号配置（JSON格式）
    is_active BOOLEAN DEFAULT true,             -- 是否启用
    version INTEGER DEFAULT 1,                  -- 版本号
    created_at TIMESTAMP DEFAULT NOW(),         -- 创建时间
    updated_at TIMESTAMP DEFAULT NOW(),         -- 更新时间
    created_by INTEGER,                         -- 创建人
    updated_by INTEGER                          -- 更新人
);
```

**物料类型配置表（material_type_config）**：
```sql
CREATE TABLE material_type_config (
    id SERIAL PRIMARY KEY,
    rule_id INTEGER NOT NULL,                   -- 关联规则ID
    type_code VARCHAR(20) NOT NULL,             -- 类型代码
    type_name VARCHAR(100) NOT NULL,            -- 类型名称
    description VARCHAR(255),                   -- 类型描述
    independent_sequence BOOLEAN DEFAULT true,  -- 是否独立计数
    current_sequence INTEGER DEFAULT 0,         -- 当前序号
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(rule_id, type_code)
);
```

**部门编码规则配置表（material_code_rule_alias）**：
```sql
CREATE TABLE material_code_rule_alias (
    id SERIAL PRIMARY KEY,
    org_id INTEGER NOT NULL,                    -- 组织ID
    code_type VARCHAR(50) NOT NULL,             -- 编码类型代码
    code_type_name VARCHAR(100) NOT NULL,       -- 编码类型名称
    template VARCHAR(200) NOT NULL,             -- 格式模板
    prefix VARCHAR(50),                         -- 前缀
    validation_pattern VARCHAR(500),            -- 验证规则（正则表达式）
    departments JSONB,                          -- 关联部门（JSON数组）
    is_active BOOLEAN DEFAULT true,             -- 是否启用
    version INTEGER DEFAULT 1,                  -- 版本号
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by INTEGER,
    updated_by INTEGER,
    UNIQUE(org_id, code_type)
);
```

**编码规则版本历史表（material_code_rule_history）**：
```sql
CREATE TABLE material_code_rule_history (
    id SERIAL PRIMARY KEY,
    rule_type VARCHAR(20) NOT NULL,             -- 规则类型（main/alias）
    rule_id INTEGER NOT NULL,                   -- 规则ID
    version INTEGER NOT NULL,                   -- 版本号
    rule_config JSONB NOT NULL,                 -- 规则配置（完整JSON）
    change_description TEXT,                    -- 变更说明
    changed_by INTEGER,                         -- 变更人
    changed_at TIMESTAMP DEFAULT NOW(),         -- 变更时间
    UNIQUE(rule_type, rule_id, version)
);
```

#### 2.7.2 序号计数器表

**序号计数器表（material_sequence_counter）**：
```sql
CREATE TABLE material_sequence_counter (
    id SERIAL PRIMARY KEY,
    org_id INTEGER NOT NULL,                    -- 组织ID
    rule_id INTEGER NOT NULL,                   -- 规则ID
    type_code VARCHAR(20),                      -- 物料类型代码（如果独立计数）
    current_value INTEGER DEFAULT 0,            -- 当前序号值
    updated_at TIMESTAMP DEFAULT NOW(),         -- 更新时间
    UNIQUE(org_id, rule_id, type_code)
);
```

#### 2.7.3 索引设计

**性能优化索引**：
```sql
-- 主编码规则查询索引
CREATE INDEX idx_main_rule_org_active ON material_code_rule_main(org_id, is_active);

-- 部门编码规则查询索引
CREATE INDEX idx_alias_rule_org_active ON material_code_rule_alias(org_id, is_active);

-- 物料类型配置索引
CREATE INDEX idx_material_type_rule ON material_type_config(rule_id);

-- 序号计数器索引
CREATE INDEX idx_sequence_counter_org_rule ON material_sequence_counter(org_id, rule_id, type_code);

-- 规则历史查询索引
CREATE INDEX idx_rule_history_type_rule ON material_code_rule_history(rule_type, rule_id);
```

---

## 3. 主编码体系

### 3.1 主编码生成规则

**编码规则来源**：主编码生成规则通过[编码规则配置管理](#2-编码规则配置管理)进行配置，系统不再使用硬编码规则。

**默认配置示例**（可根据实际需求修改）：
- **编码格式**：`{PREFIX}-{TYPE}-{SEQUENCE}`
- **默认前缀**：`MAT`
- **物料类型**：通过系统配置，默认包括：
  - `FIN`：成品（Finished Goods）
  - `SEMI`：半成品（Semi-finished Goods）
  - `RAW`：原材料（Raw Materials）
  - `PACK`：包装材料（Packaging Materials）
  - `AUX`：辅助材料（Auxiliary Materials）
- **序号规则**：通过系统配置，默认：
  - 4位数字，从0001开始递增
  - 按物料类型分别计数
  - 系统自动生成，不可手动修改

**编码生成流程**：
1. 系统读取当前生效的主编码规则配置
2. 根据物料类型获取对应的类型代码
3. 获取该类型的下一个序号
4. 根据格式模板组装生成编码
5. 验证编码唯一性
6. 保存编码并更新序号

**示例**（基于默认配置）：
- `MAT-FIN-0001`：成品001
- `MAT-SEMI-0001`：半成品001
- `MAT-RAW-0001`：原材料001

### 3.2 主编码特性

- **系统内部唯一标识**：作为系统内部唯一标识，用于数据库主键、关联关系等
- **规则驱动生成**：根据配置的规则自动生成，无需手动输入
- **不可修改**：主编码一旦生成，不可修改，确保数据一致性
- **全局唯一**：同一组织内，主编码全局唯一
- **规则可配置**：编码规则通过系统配置界面管理，可根据业务需求调整

### 3.3 主编码使用场景

- **数据库存储**：作为物料表的主键或唯一标识
- **系统内部关联**：BOM、工单、库存等业务单据关联物料时使用主编码
- **API接口**：系统内部API使用主编码作为物料标识
- **数据导入导出**：批量导入导出时，使用主编码确保数据一致性

---

## 4. 部门编码体系

### 4.1 部门编码类型

**编码类型来源**：部门编码类型通过[编码规则配置管理](#2-编码规则配置管理)进行配置，系统不再使用硬编码类型。

**默认配置示例**（可根据实际需求修改）：

**销售编码（SALE）**：
- 格式：`{PREFIX}-{部门标识}-{序号}`（默认：`SALE-{DEPT}-{SEQUENCE}`）
- 示例：`SALE-A001`、`SALE-B001`
- 用途：销售部门使用的物料编码

**设计编码（DES）**：
- 格式：`{PREFIX}-{部门标识}-{序号}`（默认：`DES-{DEPT}-{SEQUENCE}`）
- 示例：`DES-A001`、`DES-B001`
- 用途：设计部门使用的物料编码

**供应商编码（SUP）**：
- 格式：`{PREFIX}-{部门标识}-{序号}`（默认：`SUP-{DEPT}-{SEQUENCE}`）
- 示例：`SUP-A001`、`SUP-B001`
- 用途：供应商提供的物料编码

**采购编码（PUR）**：
- 格式：`{PREFIX}-{部门标识}-{序号}`（默认：`PUR-{DEPT}-{SEQUENCE}`）
- 示例：`PUR-A001`、`PUR-B001`
- 用途：采购部门使用的物料编码

**仓库编码（WH）**：
- 格式：`{PREFIX}-{部门标识}-{序号}`（默认：`WH-{DEPT}-{SEQUENCE}`）
- 示例：`WH-A001`、`WH-B001`
- 用途：仓库部门使用的物料编码

**生产编码（PROD）**：
- 格式：`{PREFIX}-{部门标识}-{序号}`（默认：`PROD-{DEPT}-{SEQUENCE}`）
- 示例：`PROD-A001`、`PROD-B001`
- 用途：生产部门使用的物料编码

### 4.2 部门编码特性

- **业务使用**：各部门可继续使用原有编码，作为业务标识
- **作为别名保留**：部门编码作为主编码的别名，保留在系统中
- **可重复使用**：不同物料可以使用相同的部门编码（但需要映射到不同的主编码）
- **规则可配置**：部门编码类型和格式规则通过系统配置界面管理，支持自定义添加和修改

### 4.3 部门编码使用场景

- **业务操作**：各部门在业务操作中使用部门编码
- **数据导入**：批量导入数据时，支持使用部门编码
- **搜索查询**：支持通过部门编码搜索物料
- **报表展示**：报表中可显示部门编码，便于业务人员理解

---

## 5. 编码映射机制

### 5.1 编码映射类型

编码映射机制支持三种类型的编码映射：

**1. 公司内部部门编码映射**：
- 公司内部各部门使用的编码（销售编码、设计编码、采购编码、仓库编码、生产编码等）
- 用于公司内部各部门之间的业务协作
- 编码类型通过系统配置管理

**2. 客户物料编码映射**：
- 客户提供的物料编码
- 用于销售订单、发货单等与客户交互的业务场景
- 支持一个物料对应多个客户的编码（一个客户一个编码）
- 编码格式：`CUST-{客户代码}-{客户物料编码}`

**3. 供应商物料编码映射**：
- 供应商提供的物料编码
- 用于采购订单、入库单等与供应商交互的业务场景
- 支持一个物料对应多个供应商的编码（一个供应商一个编码）
- 编码格式：`SUP-{供应商代码}-{供应商物料编码}`

### 5.2 映射关系建立

**自动映射**：
- 创建物料时，如果输入了部门编码、客户编码或供应商编码，系统自动建立映射关系
- 批量导入时，系统自动识别各类编码并建立映射关系

**手动映射**：
- 通过物料映射工具，手动建立编码映射关系
- 支持批量建立映射关系
- 支持在物料编辑界面中管理编码映射

**映射规则**：
- 一个主编码可以对应多个部门编码
- 一个主编码可以对应多个客户编码（不同客户）
- 一个主编码可以对应多个供应商编码（不同供应商）
- 一个部门编码只能对应一个主编码
- 一个客户编码（同一客户）只能对应一个主编码
- 一个供应商编码（同一供应商）只能对应一个主编码
- 如果编码已存在，系统提示是否合并物料

### 5.2 映射关系存储

**存储结构**：
```json
{
  "material_id": 1,
  "main_code": "MAT-FIN-0001",
  "alias_codes": [
    {
      "code_type": "SALE",
      "code": "SALE-A001",
      "department": "销售部",
      "external_entity_id": null,
      "external_entity_type": null
    },
    {
      "code_type": "DES",
      "code": "DES-A001",
      "department": "设计部",
      "external_entity_id": null,
      "external_entity_type": null
    },
    {
      "code_type": "CUSTOMER",
      "code": "CUST-001-PART-12345",
      "department": null,
      "external_entity_id": 100,
      "external_entity_type": "customer"
    },
    {
      "code_type": "SUPPLIER",
      "code": "SUP-200-MAT-67890",
      "department": null,
      "external_entity_id": 200,
      "external_entity_type": "supplier"
    }
  ]
}
```

**数据库设计**：
- 主表：物料主表（material），存储主编码
- 别名表：物料编码别名表（material_code_alias），存储所有类型的编码和映射关系
  - `code_type`：编码类型（SALE/DES/PUR/WH/PROD/CUSTOMER/SUPPLIER/VARIANT等）
  - `external_entity_id`：外部实体ID（客户ID或供应商ID，如果是客户/供应商编码）
  - `external_entity_type`：外部实体类型（customer/supplier，如果是客户/供应商编码）

### 5.3 映射关系查询

**正向查询**（通过部门编码查询主编码）：
- 输入部门编码：`SALE-A001`
- 系统自动查询映射关系
- 返回主编码：`MAT-FIN-0001`

**反向查询**（通过主编码查询部门编码）：
- 输入主编码：`MAT-FIN-0001`
- 系统查询所有关联的部门编码
- 返回所有部门编码列表

**模糊查询**：
- 支持部门编码模糊匹配
- 支持客户编码模糊匹配
- 支持供应商编码模糊匹配
- 支持编码类型筛选
- 支持部门筛选
- 支持客户筛选
- 支持供应商筛选

### 5.4 客户物料编码管理

**客户编码特性**：
- 每个客户可以有自己的物料编码体系
- 同一物料在不同客户处可能有不同的编码
- 支持客户编码的批量导入和导出
- 支持客户编码的自动映射和手动映射

**客户编码使用场景**：
- 销售订单录入时，使用客户编码
- 发货单打印时，显示客户编码
- 客户对账时，使用客户编码
- 客户报表中，显示客户编码

**客户编码管理**：
- 在物料编辑界面的"编码映射"标签页中管理
- 支持添加、编辑、删除客户编码
- 支持批量导入客户编码映射关系
- 支持客户编码的验证和去重

### 5.5 供应商物料编码管理

**供应商编码特性**：
- 每个供应商可以有自己的物料编码体系
- 同一物料在不同供应商处可能有不同的编码
- 支持供应商编码的批量导入和导出
- 支持供应商编码的自动映射和手动映射

**供应商编码使用场景**：
- 采购订单录入时，使用供应商编码
- 入库单录入时，使用供应商编码
- 供应商对账时，使用供应商编码
- 供应商报表中，显示供应商编码

**供应商编码管理**：
- 在物料编辑界面的"编码映射"标签页中管理
- 支持添加、编辑、删除供应商编码
- 支持批量导入供应商编码映射关系
- 支持供应商编码的验证和去重

---

## 6. 物料变体管理

### 6.1 变体管理概述

物料变体管理是制造业管理系统中的重要功能，用于管理具有相同基础特性但存在属性差异的物料变体。通过变体管理，可以避免为每种变体创建独立的物料记录，提高数据管理效率和业务操作的灵活性。

**变体管理的核心价值**：
- **减少数据冗余**：避免为每个变体创建独立的物料记录
- **简化业务流程**：统一管理变体属性，简化BOM、工单、库存等业务操作
- **提高管理效率**：通过变体属性快速筛选和定位物料
- **支持灵活配置**：变体属性定义通过系统配置界面管理，支持自定义变体属性，满足不同行业的业务需求

**变体管理的核心原则**：
- **属性可配置**：所有变体属性定义通过系统配置界面管理，不使用硬编码
- **规则引擎驱动**：变体编码生成和属性验证由规则引擎执行
- **灵活扩展**：支持添加新的变体属性类型，无需修改代码
- **组织隔离**：每个组织可以定义自己的变体属性配置

### 6.2 变体管理在制造业中的应用场景

#### 6.2.1 典型变体属性

**颜色变体**：
- 应用场景：服装、塑料制品、涂料、电子产品外壳等
- 示例：同一款T恤，有红色、蓝色、黑色等不同颜色
- 变体属性：`{"颜色": "红色"}`, `{"颜色": "蓝色"}`, `{"颜色": "黑色"}`

**尺寸变体**：
- 应用场景：服装、鞋帽、包装材料、板材等
- 示例：同一款T恤，有S、M、L、XL等不同尺寸
- 变体属性：`{"尺寸": "S"}`, `{"尺寸": "M"}`, `{"尺寸": "L"}`

**规格变体**：
- 应用场景：电子元器件、机械零件、原材料等
- 示例：同一型号的电阻，有不同阻值规格
- 变体属性：`{"阻值": "10Ω"}`, `{"阻值": "100Ω"}`, `{"阻值": "1KΩ"}`

**材质变体**：
- 应用场景：包装材料、建筑材料、化工材料等
- 示例：同一款包装盒，有纸质、塑料等不同材质
- 变体属性：`{"材质": "纸质"}`, `{"材质": "塑料"}`

**组合变体**：
- 应用场景：多属性组合的产品
- 示例：T恤产品，颜色和尺寸组合形成多个变体
- 变体属性：
  - `{"颜色": "红色", "尺寸": "S"}`
  - `{"颜色": "红色", "尺寸": "M"}`
  - `{"颜色": "蓝色", "尺寸": "S"}`
  - `{"颜色": "蓝色", "尺寸": "M"}`

#### 6.2.2 制造业业务场景应用

**场景1：BOM管理中应用变体**
- **问题**：同一产品有多个颜色/尺寸变体，每个变体可能需要不同的BOM
- **解决方案**：
  - 主物料定义：T恤（基础物料）
  - 变体定义：红色-S、红色-M、蓝色-S、蓝色-M等
  - BOM管理：为主物料定义基础BOM，变体可以继承或覆盖特定子物料
  - 示例：
    ```
    主物料：T恤（MAT-FIN-0001）
    ├── 变体1：红色-S
    │   ├── 布料：红色布料-1米（默认BOM）
    │   └── 标签：红色标签（变体特定BOM）
    ├── 变体2：红色-M
    │   ├── 布料：红色布料-1.2米（尺寸影响用量）
    │   └── 标签：红色标签（变体特定BOM）
    └── 变体3：蓝色-S
        ├── 布料：蓝色布料-1米（颜色影响物料）
        └── 标签：蓝色标签（变体特定BOM）
    ```

**场景2：工单管理中应用变体**
- **问题**：生产订单需要指定具体颜色、尺寸等变体属性
- **解决方案**：
  - 工单关联主物料和变体属性
  - 系统根据主物料+BOM+变体属性自动计算所需子物料
  - 支持变体特定的工艺路线（如果不同颜色需要不同工艺）
  - 示例：
    ```
    工单：WO-20260108-001
    ├── 主物料：T恤（MAT-FIN-0001）
    ├── 变体属性：{"颜色": "红色", "尺寸": "M"}
    ├── 计划数量：100件
    └── 子物料需求（自动计算）：
        ├── 红色布料：120米（根据BOM和变体属性计算）
        ├── 红色标签：100个
        └── 其他通用物料...
    ```

**场景3：库存管理中应用变体**
- **问题**：需要按变体属性管理库存，如红色-S、红色-M分别管理
- **解决方案**：
  - 库存记录关联主物料和变体属性
  - 支持按变体属性查询库存
  - 支持变体属性的库存预警
  - 示例：
    ```
    主物料：T恤（MAT-FIN-0001）
    ├── 红色-S：库存100件，安全库存50件
    ├── 红色-M：库存80件，安全库存50件
    ├── 蓝色-S：库存60件，安全库存50件（预警）
    └── 蓝色-M：库存120件，安全库存50件
    ```

**场景4：销售订单中应用变体**
- **问题**：客户下单时需要指定具体的颜色、尺寸等
- **解决方案**：
  - 销售订单明细关联主物料和变体属性
  - 支持按变体属性查询可销售库存
  - 自动匹配变体属性的库存和工单
  - 示例：
    ```
    销售订单：SO-20260108-001
    ├── 客户：客户A
    └── 订单明细：
        ├── T恤，红色-S，数量50件
        ├── T恤，红色-M，数量30件
        └── T恤，蓝色-L，数量20件
    ```

**场景5：采购管理中应用变体**
- **问题**：采购原材料时可能需要根据变体属性选择不同供应商
- **解决方案**：
  - 采购订单关联主物料和变体属性
  - 支持按变体属性设置不同的采购策略
  - 支持变体属性的供应商管理
  - 示例：
    ```
    采购订单：PO-20260108-001
    ├── 红色布料（根据T恤红色变体生成）
    │   ├── 供应商：供应商A
    │   └── 数量：150米
    └── 蓝色布料（根据T恤蓝色变体生成）
        ├── 供应商：供应商B
        └── 数量：100米
    ```

### 6.3 变体属性配置管理

#### 6.3.1 变体属性配置概述

变体属性配置是系统级功能，允许组织管理员通过可视化界面自定义变体属性定义，而不是硬编码在系统中。这样可以满足不同行业和组织的业务需求。

**核心原则**：
- **属性可配置**：所有变体属性定义通过系统配置界面管理，不使用硬编码
- **规则引擎驱动**：变体属性验证和编码生成由规则引擎执行
- **版本管理**：支持属性定义的版本管理和历史追溯
- **生效控制**：支持属性定义的启用/禁用和生效时间控制

#### 6.3.2 变体属性结构

**属性定义格式**（JSON格式）：
```json
{
  "variant_attributes": {
    "颜色": "红色",
    "尺寸": "M",
    "材质": "棉质"
  }
}
```

**属性类型**（可配置）：
- **文本属性（text）**：颜色、材质、型号等，支持自由输入
- **数值属性（number）**：长度、宽度、高度、重量等，支持数值范围验证
- **枚举属性（enum）**：尺寸（S/M/L/XL）、等级（A/B/C）等，从预定义值列表选择
- **日期属性（date）**：生产日期、有效期等
- **布尔属性（boolean）**：是否启用、是否合格等
- **组合属性**：多属性组合形成完整变体

#### 6.3.3 变体属性定义配置

**变体属性定义配置项**：
- **属性名称**：属性的唯一标识（如：颜色、尺寸）
- **属性类型**：text、number、enum、date、boolean
- **显示名称**：属性的显示名称（如：产品颜色）
- **属性描述**：属性的详细说明
- **是否必填**：创建变体时是否必须提供该属性值
- **显示顺序**：属性在界面上的显示顺序
- **枚举值列表**：如果类型为enum，定义可选值列表
- **验证规则**：数值范围、文本格式、正则表达式等验证规则
- **默认值**：属性的默认值（可选）
- **依赖关系**：与其他属性的依赖关系（如颜色决定标签类型）

**默认属性定义示例**（可通过配置修改）：
```json
{
  "variant_attribute_definitions": [
    {
      "attribute_name": "颜色",
      "attribute_type": "enum",
      "display_name": "产品颜色",
      "description": "产品的颜色属性",
      "is_required": true,
      "display_order": 1,
      "enum_values": ["红色", "蓝色", "绿色", "黑色", "白色"],
      "validation_rules": null,
      "default_value": null,
      "dependencies": []
    },
    {
      "attribute_name": "尺寸",
      "attribute_type": "enum",
      "display_name": "产品尺寸",
      "description": "产品的尺寸属性",
      "is_required": true,
      "display_order": 2,
      "enum_values": ["S", "M", "L", "XL", "XXL"],
      "validation_rules": null,
      "default_value": null,
      "dependencies": []
    },
    {
      "attribute_name": "材质",
      "attribute_type": "text",
      "display_name": "产品材质",
      "description": "产品的材质属性",
      "is_required": false,
      "display_order": 3,
      "enum_values": null,
      "validation_rules": {
        "max_length": 50,
        "pattern": null
      },
      "default_value": null,
      "dependencies": []
    }
  ]
}
```

#### 6.3.4 变体属性配置界面

**变体属性配置页面**：
- 路径：系统设置 → 变体管理 → 变体属性配置
- 功能：
  1. **属性定义列表**：显示所有已定义的变体属性
  2. **添加属性定义**：创建新的变体属性定义
  3. **编辑属性定义**：修改属性定义的配置
  4. **删除属性定义**：删除不需要的属性定义（需检查是否被使用）
  5. **属性值管理**：为枚举类型属性管理可选值列表
  6. **属性依赖配置**：配置属性之间的依赖关系
  7. **属性启用/禁用**：控制属性是否可用
  8. **属性历史**：查看属性定义的变更历史

**属性定义编辑器**：
- 属性基本信息编辑（名称、类型、显示名称等）
- 枚举值列表管理（添加、编辑、删除、排序）
- 验证规则配置（数值范围、文本格式、正则表达式）
- 依赖关系配置（选择依赖的属性）
- 属性预览：实时预览属性在变体创建界面中的显示效果

#### 6.3.5 变体属性验证规则配置

**文本属性验证规则**：
- 最大长度、最小长度
- 正则表达式匹配
- 禁止字符列表

**数值属性验证规则**：
- 最小值、最大值
- 数值精度（小数位数）
- 单位换算规则

**枚举属性验证规则**：
- 枚举值列表（必填）
- 是否允许自定义值
- 枚举值排序规则

**组合验证规则**：
- 属性组合唯一性验证
- 属性依赖关系验证（如：选择颜色A时，尺寸只能选S或M）

#### 6.3.6 变体属性规则引擎

**属性验证引擎**：
- 解析属性定义配置
- 根据属性类型和验证规则验证属性值
- 支持自定义验证逻辑

**属性编码生成引擎**：
- 根据变体属性生成变体标识
- 支持自定义编码规则（如：颜色缩写、尺寸直接使用）
- 支持属性值到编码的映射规则

**属性依赖引擎**：
- 解析属性依赖关系
- 根据依赖关系动态显示/隐藏属性
- 根据依赖关系验证属性值组合

### 6.4 变体编码规则

#### 6.4.1 变体编码生成规则

**编码格式**：主编码 + 变体后缀

**格式示例**：
- 基础格式：`{主编码}-{变体标识}`
- 示例：`MAT-FIN-0001-RED-M`（红色-M码）
- 示例：`MAT-FIN-0001-BLUE-L`（蓝色-L码）

**变体标识生成规则**（可配置）：
- **单属性变体**：使用属性值缩写或映射
  - 颜色：红色 → RED（可配置映射规则）
  - 尺寸：M → M（直接使用）
- **多属性变体**：属性值缩写组合（可配置组合规则）
  - 红色-M → RED-M（可配置分隔符和顺序）
  - 蓝色-L → BLU-L
- **规则可配置**：通过编码规则配置管理定义变体后缀生成规则
- **属性值映射**：支持属性值到编码的映射规则配置（如：红色→RED，蓝色→BLU）

#### 6.4.2 变体编码规则配置

**变体编码规则配置项**：
- **编码格式模板**：定义变体编码的格式（如：`{主编码}-{属性1}-{属性2}`）
- **属性值映射规则**：配置属性值到编码的映射（如：颜色映射表）
- **属性顺序规则**：定义多属性变体的属性顺序
- **分隔符配置**：定义属性之间的分隔符（如：`-`、`_`）

**变体编码规则配置界面**：
- 路径：系统设置 → 编码规则管理 → 变体编码规则
- 功能：
  1. **格式模板编辑器**：可视化编辑变体编码格式模板
  2. **属性值映射管理**：为每个属性配置值到编码的映射规则
  3. **属性顺序配置**：配置多属性变体的属性顺序
  4. **规则预览**：实时预览变体编码生成效果
  5. **规则测试**：测试规则生成的编码是否符合要求
  6. **规则启用/禁用**：控制规则是否生效

#### 6.4.2 变体编码与主编码的关系

**一对多关系**：
- 一个主物料可以对应多个变体编码
- 每个变体编码通过变体属性区分

**编码存储**：
- 主物料存储主编码（MAT-FIN-0001）
- 变体记录存储变体编码（MAT-FIN-0001-RED-M）
- 变体编码作为部门编码的一种类型，存储在编码别名表中

**编码映射**：
- 变体编码映射到主物料的主编码
- 通过变体属性区分不同变体
- 支持通过变体编码查询主物料和变体属性

### 6.5 变体数据模型设计

#### 6.5.1 物料模型中的变体字段

**Material模型中的变体相关字段**：
```python
class Material(BaseModel):
    # 变体管理字段
    variant_managed: bool = False  # 是否启用变体管理
    variant_attributes: Optional[Dict[str, Any]] = None  # 变体属性（JSON格式）
```

**字段说明**：
- `variant_managed`：标识该物料是否启用变体管理
- `variant_attributes`：存储变体属性，JSON格式
  - 格式：`{"颜色": "红色", "尺寸": "M"}`
  - 当 `variant_managed=True` 时，此字段存储当前物料的变体属性值
  - 当 `variant_managed=False` 时，此字段为NULL
  - 属性名称和值必须符合变体属性定义配置

#### 6.5.2 变体关系设计

**主物料与变体的关系**：
- **主物料**：`variant_managed=True`，`variant_attributes=null`（定义变体属性模板）
- **变体物料**：`variant_managed=True`，`variant_attributes={"颜色": "红色", "尺寸": "M"}`

**关系识别**：
- 主物料和变体物料通过主编码关联（同一主物料的不同变体共享同一主编码的基础部分）
- 通过 `variant_attributes` 区分不同变体
- 变体编码作为部门编码存储在编码别名表中，类型为 `VARIANT`

#### 6.5.3 变体属性定义配置表（系统级配置）

**MaterialVariantAttributeDefinition模型**（系统级配置表）：
```sql
CREATE TABLE core_material_variant_attribute_definitions (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL,
    tenant_id INT NOT NULL,
    attribute_name VARCHAR(50) NOT NULL,
    attribute_type VARCHAR(20) NOT NULL,  -- enum/text/number/date/boolean
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_required BOOLEAN DEFAULT false,
    display_order INT DEFAULT 0,
    enum_values JSONB,  -- 枚举值列表（如果type=enum）
    validation_rules JSONB,  -- 验证规则（JSON格式）
    default_value VARCHAR(200),  -- 默认值
    dependencies JSONB,  -- 依赖关系（JSON格式）
    is_active BOOLEAN DEFAULT true,
    version INT DEFAULT 1,
    created_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL,
    created_by INT,
    updated_by INT,
    deleted_at TIMESTAMPTZ,
    UNIQUE(tenant_id, attribute_name)
);
```

**字段说明**：
- `attribute_name`：属性名称（唯一标识，如：颜色、尺寸）
- `attribute_type`：属性类型（enum/text/number/date/boolean）
- `display_name`：显示名称（如：产品颜色）
- `enum_values`：枚举值列表（JSON数组，如：["红色", "蓝色", "绿色"]）
- `validation_rules`：验证规则（JSON格式，如：{"max_length": 50, "min": 0, "max": 100}）
- `dependencies`：依赖关系（JSON格式，如：{"depends_on": "颜色", "rules": {...}}）

**变体属性定义版本历史表**：
```sql
CREATE TABLE core_material_variant_attribute_history (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL,
    tenant_id INT NOT NULL,
    attribute_definition_id INT NOT NULL,
    version INT NOT NULL,
    attribute_config JSONB NOT NULL,  -- 完整的属性配置（JSON格式）
    change_description TEXT,
    changed_by INT,
    changed_at TIMESTAMPTZ,
    deleted_at TIMESTAMPTZ,
    UNIQUE(attribute_definition_id, version)
);
```

#### 6.5.4 变体属性值映射表（可选，用于属性值标准化）

**MaterialVariantAttributeValueMapping模型**（可选，用于属性值标准化）：
```sql
CREATE TABLE core_material_variant_attribute_value_mappings (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL,
    tenant_id INT NOT NULL,
    attribute_definition_id INT NOT NULL,
    source_value VARCHAR(200) NOT NULL,  -- 原始值（用户输入）
    standard_value VARCHAR(200) NOT NULL,  -- 标准值（系统使用）
    display_value VARCHAR(200),  -- 显示值（界面显示）
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL,
    UNIQUE(tenant_id, attribute_definition_id, source_value)
);
```

**用途**：
- 支持属性值的标准化映射
- 例如：用户输入"红"、"红色"、"RED"都映射到标准值"红色"
- 支持属性值的别名管理

### 6.6 变体管理在业务流程中的应用

#### 6.6.1 BOM管理中的变体应用

**基础BOM（主物料级别）**：
- 定义主物料的基础BOM结构
- 适用于所有变体的通用子物料

**变体特定BOM**：
- 定义变体特定的子物料或用量差异
- 变体可以覆盖或补充基础BOM

**BOM展开逻辑**：
1. 从基础BOM获取所有子物料
2. 根据变体属性查找变体特定BOM
3. 合并基础BOM和变体特定BOM
4. 根据变体属性调整用量（如尺寸影响布料用量）

**示例**：
```
主物料BOM（T恤，MAT-FIN-0001）：
├── 布料：基础用量1米
├── 标签：通用标签
└── 纽扣：4颗

变体特定BOM（红色-M）：
├── 布料：用量1.2米（尺寸M比S多用0.2米）
└── 标签：红色标签（颜色变体特定）

合并后的BOM（红色-M）：
├── 布料：1.2米（变体覆盖）
├── 标签：红色标签（变体覆盖）
└── 纽扣：4颗（继承基础BOM）
```

#### 6.6.2 工单管理中的变体应用

**工单创建**：
- 工单关联主物料和变体属性
- 系统根据主物料+BOM+变体属性自动计算子物料需求

**物料需求计算**：
1. 根据主物料和变体属性展开BOM
2. 考虑变体特定的子物料和用量
3. 计算每种子物料的需求数量

**工单执行**：
- 生产计划中明确指定变体属性
- 投料时按变体属性领料
- 报工时记录变体属性

#### 6.6.3 库存管理中的变体应用

**库存记录**：
- 库存记录关联主物料和变体属性
- 支持按变体属性查询和统计库存

**库存操作**：
- 入库：指定变体属性
- 出库：选择变体属性
- 盘点：按变体属性盘点
- 调拨：支持变体属性的库存调拨

**库存查询**：
- 按主物料查询所有变体库存
- 按变体属性筛选库存
- 按变体编码查询库存

#### 6.6.4 销售订单中的变体应用

**订单录入**：
- 选择主物料
- 选择变体属性（颜色、尺寸等）
- 系统自动匹配变体编码和库存

**库存匹配**：
- 按主物料+变体属性匹配可用库存
- 如果库存不足，自动生成生产工单（MTO模式）

**订单履行**：
- 按变体属性拣货
- 按变体属性发货
- 按变体属性统计销售数据

#### 6.6.5 采购管理中的变体应用

**采购需求生成**：
- 根据销售订单和生产计划，按变体属性计算原材料需求
- 不同变体可能使用不同的原材料（如颜色影响布料类型）

**采购订单**：
- 按变体属性分组采购
- 不同变体属性的原材料可能来自不同供应商

**供应商管理**：
- 支持按变体属性设置供应商
- 支持按变体属性设置采购价格

### 6.7 变体编码与物料编码的集成

#### 6.7.1 变体编码作为部门编码的一种类型

**变体编码类型**：
- 编码类型：`VARIANT`
- 存储位置：`material_code_alias` 表
- 关联关系：通过 `material_id` 关联主物料

**编码格式**：
- 格式：`{主编码}-{变体标识}`
- 示例：`MAT-FIN-0001-RED-M`
- 生成规则：通过编码规则配置管理定义

#### 6.7.2 变体编码查询

**通过变体编码查询物料**：
1. 查询编码别名表，找到变体编码记录
2. 通过 `material_id` 关联主物料
3. 返回主物料信息和变体属性

**通过主编码查询变体**：
1. 查询主物料
2. 查询该物料的所有变体编码别名（`code_type='VARIANT'`）
3. 返回所有变体列表

#### 6.7.3 变体编码生成流程

**创建变体物料时的编码生成**：
1. 获取主物料的主编码（如：MAT-FIN-0001）
2. 根据变体属性生成变体标识（如：RED-M）
3. 组装变体编码（如：MAT-FIN-0001-RED-M）
4. 将变体编码作为部门编码（类型：VARIANT）存储到编码别名表
5. 关联到主物料

### 6.8 变体管理的业务规则

#### 6.8.1 变体属性验证规则（基于配置）

**必填属性验证**：
- 根据变体属性定义配置中的 `is_required` 字段验证
- 如果属性定义为必填，创建变体时必须提供该属性值

**枚举值验证**：
- 如果属性类型为枚举（`attribute_type=enum`），属性值必须在配置的 `enum_values` 列表中
- 如果属性类型为文本但配置了枚举值，也进行枚举值验证

**数值范围验证**：
- 如果属性类型为数值（`attribute_type=number`），根据 `validation_rules` 中的范围规则验证
- 支持最小值、最大值、精度等验证

**文本格式验证**：
- 如果属性类型为文本（`attribute_type=text`），根据 `validation_rules` 中的格式规则验证
- 支持最大长度、最小长度、正则表达式等验证

**组合唯一性验证**：
- 同一主物料下，变体属性组合必须唯一
- 例如：不能有两个"红色-M"的变体
- 验证时考虑所有必填属性的组合

**依赖关系验证**：
- 根据属性定义配置中的 `dependencies` 验证属性依赖关系
- 例如：选择颜色A时，尺寸只能选S或M

#### 6.8.2 变体物料创建规则

**主物料创建**：
- 创建主物料时，设置 `variant_managed=True`
- 可以不设置 `variant_attributes`（或设置为空）
- 系统根据变体属性定义配置验证是否启用了变体管理

**变体物料创建**：
- 必须关联到已存在的主物料
- 必须提供所有必填的变体属性（根据属性定义配置）
- 变体属性值必须通过验证（枚举值、数值范围、格式等）
- 系统根据变体编码规则配置自动生成变体编码
- 系统将变体编码作为部门编码（类型：VARIANT）关联到主物料

**变体删除规则**：
- 删除变体前检查是否有库存
- 删除变体前检查是否有未完成的工单
- 删除变体前检查是否有未完成的销售订单
- 删除变体前检查是否有未完成的采购订单

#### 6.8.3 变体属性定义变更规则

**属性定义变更影响评估**：
- 变更属性定义前，系统自动评估对现有变体的影响
- 如果属性类型从枚举改为文本，现有变体不受影响
- 如果属性类型从文本改为枚举，现有变体值需要验证是否在枚举值列表中
- 如果删除属性定义，需要检查是否有变体使用该属性

**属性定义版本管理**：
- 每次属性定义变更自动创建新版本
- 记录版本号、变更时间、变更人、变更内容
- 支持版本对比和回滚

**变体属性值变更规则**：
- 变更变体属性值视为创建新变体，旧变体保留（用于历史数据追溯）
- 或者需要检查是否有业务数据引用，决定是否可以变更
- 变更后的属性值必须符合当前的属性定义配置

### 6.9 变体管理的数据结构示例

#### 6.9.1 主物料定义示例

```json
{
  "id": 1,
  "main_code": "MAT-FIN-0001",
  "name": "T恤",
  "material_type": "FIN",
  "variant_managed": true,
  "variant_attributes": null,  // 主物料不存储具体属性值
  "specification": "纯棉T恤",
  "base_unit": "件"
}
```

#### 6.9.2 变体物料定义示例

```json
{
  "id": 2,
  "main_code": "MAT-FIN-0001",  // 与主物料共享主编码基础部分
  "name": "T恤-红色-M",
  "material_type": "FIN",
  "variant_managed": true,
  "variant_attributes": {
    "颜色": "红色",
    "尺寸": "M"
  },
  "specification": "纯棉T恤-红色-M码",
  "base_unit": "件"
}
```

#### 6.9.3 变体编码别名示例

```json
{
  "material_id": 2,
  "code_type": "VARIANT",
  "code": "MAT-FIN-0001-RED-M",
  "department": null,
  "description": "T恤变体编码：红色-M码"
}
```

### 6.10 变体管理的扩展应用

#### 6.10.1 变体组合管理

**多属性组合变体**：
- 支持多个变体属性组合（如：颜色+尺寸+材质）
- 自动生成所有可能的变体组合
- 支持部分变体组合的启用/禁用

**变体矩阵视图**：
- 以矩阵形式展示变体组合
- 行列分别代表不同的属性维度
- 支持快速查看和管理变体

#### 6.10.2 变体属性继承

**变体属性继承**：
- 子物料可以继承主物料的变体属性
- 支持属性值的继承和覆盖

**多级变体管理**：
- 支持主物料→半成品→成品的多级变体管理
- 每级变体可以有独立的变体属性

#### 6.10.3 变体统计分析

**变体销售统计**：
- 按变体属性统计销售数据
- 分析不同变体的销售趋势

**变体库存分析**：
- 按变体属性分析库存结构
- 识别滞销变体和热门变体

**变体成本分析**：
- 按变体属性分析成本差异
- 识别成本较高的变体组合

---

## 7. 智能识别重复物料

### 7.1 识别策略

**高置信度识别**（自动合并提示）：
- **匹配条件**：名称+规格+单位完全一致
- **处理方式**：系统自动识别为重复物料，提示管理员确认合并
- **示例**：
  - 物料A：名称="塑料颗粒A"，规格="100g"，单位="kg"
  - 物料B：名称="塑料颗粒A"，规格="100g"，单位="kg"
  - 结果：高置信度匹配，提示合并

**中置信度识别**（提示管理员确认）：
- **匹配条件**：名称相似+规格相同
- **处理方式**：系统提示管理员确认是否为同一物料
- **示例**：
  - 物料A：名称="塑料颗粒A"，规格="100g"
  - 物料B：名称="塑料颗粒 A"，规格="100g"
  - 结果：中置信度匹配，提示确认

**低置信度识别**（仅提示不自动合并）：
- **匹配条件**：名称相似但规格不同
- **处理方式**：系统仅提示可能重复，不自动合并
- **示例**：
  - 物料A：名称="塑料颗粒A"，规格="100g"
  - 物料B：名称="塑料颗粒A"，规格="200g"
  - 结果：低置信度匹配，仅提示

### 7.2 识别算法

**多维度匹配**：
- 物料名称匹配（精确匹配、模糊匹配、拼音匹配）
- 规格匹配（精确匹配、数值范围匹配）
- 单位匹配（精确匹配、单位换算匹配）
- 供应商匹配（可选）
- 物料类型匹配（可选）

**AI辅助识别**：
- 基于历史数据学习，提高识别准确率
- 基于物料属性相似度计算
- 基于业务规则智能判断

**匹配算法**：
- 精确匹配：完全一致
- 模糊匹配：相似度>90%
- 拼音匹配：拼音相同
- 数值匹配：数值范围匹配

### 7.3 识别结果处理

**自动合并**（高置信度）：
- 系统自动识别为重复物料
- 提示管理员确认合并
- 确认后自动合并物料数据

**手动确认**（中置信度）：
- 系统提示可能重复
- 管理员手动确认是否为同一物料
- 确认后手动合并

**仅提示**（低置信度）：
- 系统仅提示可能重复
- 不自动合并，不强制确认
- 管理员可自行决定是否合并

---

## 8. 物料映射工具

### 8.1 工具功能

**可视化合并重复物料**：
- 显示重复物料列表
- 可视化展示物料相似度
- 支持批量合并操作

**建立编码映射关系**：
- 手动建立主编码与部门编码的映射关系
- 支持批量建立映射关系
- 支持修改和删除映射关系

**保留所有部门编码作为别名**：
- 合并物料时，保留所有部门编码
- 建立完整的编码映射关系
- 确保业务不中断

**合并物料属性（取并集）**：
- 合并物料时，合并所有物料属性
- 属性取并集（保留所有非空属性）
- 冲突属性提示管理员选择

### 8.2 工具界面

**重复物料列表**：
- 显示重复物料信息
- 显示相似度评分
- 显示匹配原因

**映射关系管理**：
- 显示主编码和所有部门编码
- 支持添加、修改、删除映射关系
- 支持批量操作

**合并预览**：
- 显示合并后的物料信息
- 显示合并后的编码映射关系
- 显示属性合并结果

### 8.3 操作流程

1. **识别重复物料**：
   - 系统自动识别重复物料
   - 显示重复物料列表

2. **选择合并物料**：
   - 选择要合并的物料
   - 选择保留的主物料

3. **确认合并**：
   - 预览合并结果
   - 确认合并操作

4. **建立映射关系**：
   - 自动建立编码映射关系
   - 保留所有部门编码

---

## 9. 多编码搜索

### 9.1 搜索功能

**支持输入任意部门编码搜索**：
- 输入部门编码：`SALE-A001`
- 系统自动映射到主编码
- 返回物料信息

**支持物料名称拼音搜索**：
- 输入拼音：`slkl`
- 系统匹配物料名称拼音
- 返回匹配的物料列表

**支持模糊匹配搜索**：
- 输入关键词：`塑料`
- 系统模糊匹配物料名称、编码等
- 返回匹配的物料列表

### 9.2 搜索策略

**编码搜索优先级**：
1. 主编码精确匹配
2. 部门编码精确匹配
3. 编码模糊匹配

**名称搜索优先级**：
1. 名称精确匹配
2. 名称拼音匹配
3. 名称模糊匹配

**综合搜索**：
- 同时搜索编码和名称
- 返回综合匹配结果
- 按匹配度排序

### 9.3 搜索结果展示

**显示主编码和部门编码**：
- 搜索结果中同时显示主编码和所有部门编码
- 支持切换显示编码类型

**高亮匹配内容**：
- 高亮显示匹配的编码或名称
- 便于快速识别

**快速操作**：
- 支持快速查看物料详情
- 支持快速编辑物料
- 支持快速建立映射关系

---

## 10. 新建物料界面设计

### 10.1 多标签页设计概述

新建物料界面采用多标签页设计，将物料信息按照功能模块分组，提高用户体验和操作效率。界面包含以下标签页：

1. **基本信息**：物料的核心信息（名称、类型、规格、单位等）
2. **变体管理**：变体属性配置（如果启用变体管理）
3. **编码映射**：各类编码映射关系管理（部门编码、客户编码、供应商编码）
4. **默认值设置**：业务默认值配置（默认税率、默认供应商、默认仓库等）

### 10.2 标签页1：基本信息

**功能定位**：物料的核心信息录入和管理

**包含字段**：
- **物料名称**（必填）：物料的中文名称
- **物料类型**（必填）：通过下拉选择（成品/半成品/原材料/包装材料/辅助材料）
- **主编码**（自动生成）：根据编码规则自动生成，可手动修改
- **物料分组**（可选）：选择物料所属的分组
- **规格**（可选）：物料的规格描述
- **基础单位**（必填）：物料的基础计量单位
- **多单位管理**（可选）：配置物料的多个计量单位及换算关系
- **批号管理**（可选）：是否启用批号管理
- **变体管理开关**（可选）：是否启用变体管理（如果启用，会显示"变体管理"标签页）
- **品牌**（可选）：物料品牌
- **型号**（可选）：物料型号
- **描述**（可选）：物料详细描述
- **状态**（默认启用）：是否启用该物料

**界面特点**：
- 必填字段明确标识
- 主编码自动生成，支持预览
- 物料类型选择后，自动应用对应的编码规则
- 支持表单验证和实时提示

### 10.3 标签页2：变体管理

**功能定位**：配置物料的变体属性（仅在启用变体管理时显示）

**显示条件**：基本信息标签页中"变体管理"开关为"启用"时显示

**包含功能**：
- **变体属性选择**：根据系统配置的变体属性定义，显示属性选择界面
  - 枚举类型属性：下拉选择
  - 文本类型属性：文本输入
  - 数值类型属性：数字输入（带单位）
  - 日期类型属性：日期选择
  - 布尔类型属性：开关选择
- **属性值验证**：根据属性定义配置的验证规则，实时验证属性值
- **属性依赖处理**：根据属性依赖关系，动态显示/隐藏相关属性
- **变体编码预览**：实时预览根据变体属性生成的变体编码
- **变体列表**：如果已创建变体，显示所有变体列表（仅编辑模式）

**界面特点**：
- 属性选择界面根据配置动态生成
- 必填属性明确标识
- 属性值验证实时反馈
- 变体编码自动生成并预览

### 10.4 标签页3：编码映射

**功能定位**：管理物料的各种编码映射关系

**包含功能模块**：

#### 10.4.1 公司内部部门编码

**功能**：管理公司内部各部门的编码映射

**界面元素**：
- **编码类型选择**：选择部门编码类型（销售编码/设计编码/采购编码/仓库编码/生产编码等）
- **编码输入**：输入或选择部门编码
- **部门选择**：选择使用该编码的部门
- **编码列表**：显示已添加的所有部门编码
- **操作按钮**：添加、编辑、删除部门编码

**功能特点**：
- 支持添加多个部门编码
- 编码格式根据编码规则配置自动验证
- 支持从编码规则自动生成编码
- 支持编码唯一性验证

#### 10.4.2 客户物料编码

**功能**：管理客户提供的物料编码映射

**界面元素**：
- **客户选择**：选择客户（必填）
- **客户编码输入**：输入客户提供的物料编码（必填）
- **编码描述**（可选）：客户编码的说明
- **编码列表**：显示已添加的所有客户编码（按客户分组显示）
- **操作按钮**：添加、编辑、删除客户编码

**功能特点**：
- 支持一个物料对应多个客户的编码
- 同一客户只能有一个编码
- 支持客户编码的批量导入
- 支持客户编码的验证和去重

#### 10.4.3 供应商物料编码

**功能**：管理供应商提供的物料编码映射

**界面元素**：
- **供应商选择**：选择供应商（必填）
- **供应商编码输入**：输入供应商提供的物料编码（必填）
- **编码描述**（可选）：供应商编码的说明
- **编码列表**：显示已添加的所有供应商编码（按供应商分组显示）
- **操作按钮**：添加、编辑、删除供应商编码

**功能特点**：
- 支持一个物料对应多个供应商的编码
- 同一供应商只能有一个编码
- 支持供应商编码的批量导入
- 支持供应商编码的验证和去重

**界面布局**：
- 使用折叠面板（Collapse）或标签页（Tabs）分组显示三类编码
- 每个编码类型独立管理，互不干扰
- 支持编码的快速搜索和筛选

### 10.5 标签页4：默认值设置

**功能定位**：配置物料在业务操作中的默认值，提高业务操作效率

**包含配置项**：

#### 10.5.1 财务默认值

- **默认税率**（可选）：物料在销售和采购时的默认税率
  - 类型：百分比（如：13%、6%）
  - 用途：创建销售订单、采购订单时自动填充
- **默认科目**（可选）：物料对应的会计科目
  - 类型：科目选择
  - 用途：财务核算时使用

#### 10.5.2 采购默认值

- **默认供应商**（可选）：物料的主要供应商
  - 类型：供应商选择（可多选，支持优先级排序）
  - 用途：创建采购订单时自动填充供应商
- **默认采购价格**（可选）：物料的标准采购价格
  - 类型：数值（带货币单位）
  - 用途：创建采购订单时自动填充价格
- **默认采购单位**（可选）：采购时使用的计量单位
  - 类型：单位选择
  - 用途：创建采购订单时自动填充单位
- **默认采购周期**（可选）：物料的采购提前期（天数）
  - 类型：数值（天）
  - 用途：MRP计算时使用

#### 10.5.3 销售默认值

- **默认销售价格**（可选）：物料的标准销售价格
  - 类型：数值（带货币单位）
  - 用途：创建销售订单时自动填充价格
- **默认销售单位**（可选）：销售时使用的计量单位
  - 类型：单位选择
  - 用途：创建销售订单时自动填充单位
- **默认客户**（可选）：物料的主要客户
  - 类型：客户选择（可多选）
  - 用途：创建销售订单时快速选择客户

#### 10.5.4 库存默认值

- **默认仓库**（可选）：物料的主要存储仓库
  - 类型：仓库选择（可多选，支持优先级排序）
  - 用途：创建入库单、出库单时自动填充仓库
- **默认库位**（可选）：物料在仓库中的默认库位
  - 类型：库位选择
  - 用途：创建入库单时自动填充库位
- **安全库存**（可选）：物料的安全库存数量
  - 类型：数值（带单位）
  - 用途：库存预警和MRP计算
- **最大库存**（可选）：物料的最大库存数量
  - 类型：数值（带单位）
  - 用途：库存预警
- **最小库存**（可选）：物料的最小库存数量
  - 类型：数值（带单位）
  - 用途：库存预警

#### 10.5.5 生产默认值

- **默认工艺路线**（可选）：物料的生产工艺路线
  - 类型：工艺路线选择
  - 用途：创建工单时自动填充工艺路线
- **默认生产单位**（可选）：生产时使用的计量单位
  - 类型：单位选择
  - 用途：创建工单时自动填充单位

**界面特点**：
- 使用折叠面板分组显示各类默认值
- 支持默认值的批量设置
- 支持默认值的导入和导出
- 默认值在业务操作中自动填充，可手动修改

### 10.6 界面交互设计

**标签页切换**：
- 支持标签页之间的自由切换
- 切换时自动保存当前标签页的数据（不提交）
- 未保存的数据会有提示

**表单验证**：
- 每个标签页独立验证
- 提交时验证所有标签页的必填项
- 验证错误时自动跳转到对应标签页并高亮错误字段

**数据保存**：
- 支持"保存草稿"：保存所有标签页的数据，但不提交
- 支持"保存并提交"：保存并提交所有数据，创建物料
- 支持"取消"：取消创建，丢弃所有未保存的数据

**数据加载**：
- 新建模式：所有标签页为空，等待用户输入
- 编辑模式：加载物料的所有数据，填充到对应标签页
- 只读模式：所有标签页只读，不允许修改

**帮助提示**：
- 每个标签页提供帮助说明
- 字段提供悬停提示
- 编码规则提供预览功能

---

## 11. 使用场景

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "物料管理"
2. 点击"新建物料"按钮
3. **基本信息标签页**：
   - 输入物料名称：`T恤`
   - 选择物料类型：`成品`
   - 系统自动生成主编码：`MAT-FIN-0001`（可预览）
   - 选择物料分组：`服装类`
   - 输入规格：`纯棉T恤`
   - 选择基础单位：`件`
   - 启用变体管理：`是`（显示"变体管理"标签页）
   - 输入品牌：`快格`
   - 输入描述：`纯棉T恤，舒适透气`
4. **变体管理标签页**（因为启用了变体管理）：
   - 选择颜色：`红色`（从枚举值列表选择）
   - 选择尺寸：`M`（从枚举值列表选择）
   - 系统预览变体编码：`MAT-FIN-0001-RED-M`
5. **编码映射标签页**：
   - **部门编码**：
     - 添加销售编码：`SALE-A001`
     - 添加设计编码：`DES-A001`
   - **客户编码**：
     - 选择客户：`客户A`
     - 输入客户编码：`CUST-A-PART-12345`
   - **供应商编码**：
     - 选择供应商：`供应商B`
     - 输入供应商编码：`SUP-B-MAT-67890`
6. **默认值设置标签页**：
   - 设置默认税率：`13%`
   - 设置默认供应商：`供应商B`（优先级1）
   - 设置默认采购价格：`50元/件`
   - 设置默认仓库：`成品仓库`
   - 设置安全库存：`100件`
7. 点击"保存并提交"

**系统行为**：
- 验证所有标签页的必填项
- 生成主编码：`MAT-FIN-0001`
- 生成变体编码：`MAT-FIN-0001-RED-M`
- 建立编码映射关系：
  - 部门编码：`SALE-A001`、`DES-A001` → `MAT-FIN-0001`
  - 客户编码：`CUST-A-PART-12345` → `MAT-FIN-0001`（客户A）
  - 供应商编码：`SUP-B-MAT-67890` → `MAT-FIN-0001`（供应商B）
- 保存默认值配置
- 创建物料记录

**结果**：
- 物料创建成功
- 所有编码映射关系建立完成
- 默认值配置保存完成
- 后续业务操作中可以使用各类编码和默认值

### 11.2 场景2：配置主编码规则

**用户操作**：
1. 组织管理员登录系统
2. 进入"系统设置" → "编码规则管理" → "主编码规则"
3. 配置编码格式模板：`{PREFIX}-{TYPE}-{SEQUENCE}`
4. 设置前缀：`MAT`
5. 添加物料类型：
   - 类型代码：`FIN`，类型名称：`成品`
   - 类型代码：`SEMI`，类型名称：`半成品`
   - 类型代码：`RAW`，类型名称：`原材料`
6. 配置序号规则：
   - 序号位数：4位
   - 起始值：1
   - 填充方式：左填充0
   - 按类型独立计数：是
7. 点击"预览"查看编码生成效果
8. 点击"保存并启用"

**系统行为**：
- 验证规则配置的合法性
- 保存规则配置
- 创建规则版本记录
- 启用新规则
- 记录操作日志

**结果**：
- 主编码规则配置成功
- 后续创建物料时使用新规则生成编码
- 规则生效，可正常使用

### 11.3 场景3：添加自定义部门编码类型

**用户操作**：
1. 组织管理员进入"系统设置" → "编码规则管理" → "部门编码规则"
2. 点击"添加编码类型"
3. 填写编码类型信息：
   - 类型代码：`QC`
   - 类型名称：`质检编码`
   - 使用部门：`质检部`
   - 格式模板：`QC-{DEPT}-{SEQUENCE}`
   - 验证规则：`^QC-[A-Z]{1,3}-[0-9]{3,}$`
4. 点击"保存"

**系统行为**：
- 验证编码类型配置
- 保存编码类型配置
- 更新编码规则引擎
- 记录操作日志

**结果**：
- 新增部门编码类型成功
- 后续可以使用该类型作为物料别名编码
- 规则生效，支持该类型编码的生成和验证

### 11.4 场景4：批量导入物料数据

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "物料管理"
2. 打开物料导入universheet在线表格
3. 填写物料数据（使用部门编码）：
   - 物料名称：产品A
   - 销售编码：SALE-A001
   - 设计编码：DES-A001
   - 采购编码：PUR-A001
4. 点击"导入"按钮

**系统行为**：
- 自动识别部门编码
- 自动生成主编码：`MAT-FIN-0001`
- 自动建立编码映射关系
- 自动识别重复物料（如果有）

**结果**：
- 物料创建成功
- 主编码：`MAT-FIN-0001`
- 部门编码映射：`SALE-A001`、`DES-A001`、`PUR-A001` → `MAT-FIN-0001`

### 11.5 场景5：创建BOM使用部门编码

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "BOM管理"
2. 创建BOM，使用部门编码：
   ```
   产品A（1个，使用SALE-A001）
   ├── 注塑件A（2个，使用PROD-A001）
   └── 螺丝（4个，使用WH-A001）
   ```

**系统行为**：
- 自动识别部门编码
- 自动映射到主编码
- 自动验证BOM数据完整性

**结果**：
- BOM创建成功
- 所有部门编码自动映射到主编码
- BOM数据完整

### 11.6 场景6：搜索物料使用部门编码

**用户操作**：
1. 进入物料搜索页面
2. 输入部门编码：`SALE-A001`
3. 点击搜索

**系统行为**：
- 自动识别部门编码
- 自动映射到主编码
- 查询物料信息

**结果**：
- 返回物料信息
- 显示主编码和所有部门编码
- 支持快速操作

### 11.7 场景7：合并重复物料

### 11.8 场景8：配置变体属性定义

**用户操作**：
1. 组织管理员登录系统
2. 进入"系统设置" → "变体管理" → "变体属性配置"
3. 添加变体属性定义：
   - 属性名称：`颜色`
   - 属性类型：`枚举`
   - 显示名称：`产品颜色`
   - 是否必填：`是`
   - 枚举值列表：`红色`、`蓝色`、`绿色`、`黑色`、`白色`
   - 显示顺序：`1`
4. 添加另一个属性定义：
   - 属性名称：`尺寸`
   - 属性类型：`枚举`
   - 显示名称：`产品尺寸`
   - 是否必填：`是`
   - 枚举值列表：`S`、`M`、`L`、`XL`、`XXL`
   - 显示顺序：`2`
5. 配置变体编码规则：
   - 格式模板：`{主编码}-{颜色缩写}-{尺寸}`
   - 颜色映射：红色→RED，蓝色→BLU，绿色→GRN
6. 点击"保存并启用"

**系统行为**：
- 验证属性定义配置的合法性
- 保存属性定义配置
- 创建属性定义版本记录
- 启用新配置
- 记录操作日志

**结果**：
- 变体属性定义配置成功
- 后续创建变体物料时使用配置的属性定义
- 变体编码根据配置的规则生成

### 11.9 场景9：创建变体物料

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "物料管理"
2. 创建主物料（如：T恤），设置 `variant_managed=true`
3. 创建变体物料：
   - 选择主物料：T恤（MAT-FIN-0001）
   - 系统根据变体属性定义配置显示属性选择界面
   - 选择变体属性：
     - 颜色：红色（从配置的枚举值列表选择）
     - 尺寸：M（从配置的枚举值列表选择）
   - 填写其他信息（名称、规格等）
4. 点击"保存"

**系统行为**：
- 根据变体属性定义配置验证属性值
- 根据变体编码规则配置生成变体编码：`MAT-FIN-0001-RED-M`
- 将变体编码作为部门编码（类型：VARIANT）存储
- 关联到主物料
- 创建变体物料记录

**结果**：
- 变体物料创建成功
- 主物料：MAT-FIN-0001（T恤）
- 变体编码：MAT-FIN-0001-RED-M（T恤-红色-M）
- 变体属性：{"颜色": "红色", "尺寸": "M"}

### 11.10 场景10：创建包含变体的BOM

**用户操作**：
1. 进入"主数据管理" → "产品管理" → "BOM管理"
2. 为主物料创建BOM（基础BOM）：
   ```
   T恤（MAT-FIN-0001）
   ├── 布料：1米（基础用量）
   ├── 标签：1个（通用）
   └── 纽扣：4颗
   ```
3. 为变体创建特定BOM：
   ```
   T恤-红色-M（MAT-FIN-0001-RED-M）
   ├── 布料：1.2米（尺寸M用量）
   └── 标签：红色标签（颜色变体）
   ```

**系统行为**：
- 保存基础BOM和变体特定BOM
- BOM展开时自动合并基础BOM和变体特定BOM
- 根据变体属性计算最终子物料需求

**结果**：
- BOM创建成功
- 工单创建时自动根据变体属性展开正确的BOM
- 变体特定子物料和用量正确应用

### 11.11 场景11：创建包含变体的工单

**用户操作**：
1. 进入"生产管理" → "工单管理"
2. 创建工单：
   - 选择主物料：T恤（MAT-FIN-0001）
   - 选择变体属性：{"颜色": "红色", "尺寸": "M"}
   - 计划数量：100件
   - 其他工单信息...
3. 点击"保存"

**系统行为**：
- 自动识别变体：红色-M
- 根据主物料+BOM+变体属性展开BOM
- 计算子物料需求：
  - 红色布料：120米（1.2米/件 × 100件）
  - 红色标签：100个
  - 纽扣：400颗（4颗/件 × 100件）
- 生成物料需求计划

**结果**：
- 工单创建成功
- 子物料需求自动计算
- 变体属性正确传递到生产执行

### 11.12 场景12：变体库存管理

**用户操作**：
1. 进入"仓储管理" → "库存管理"
2. 查询T恤（MAT-FIN-0001）的库存
3. 按变体属性筛选：颜色=红色，尺寸=M

**系统行为**：
- 查询主物料的所有变体库存
- 根据变体属性筛选匹配的库存记录
- 显示变体编码和库存数量

**结果**：
- 显示：MAT-FIN-0001-RED-M，库存80件
- 支持按变体属性快速筛选
- 支持按变体编码精确查询

### 11.13 场景13：销售订单中使用变体

### 11.14 场景14：使用客户编码创建销售订单

**用户操作**：
1. 进入"销售管理" → "销售订单"
2. 创建销售订单
3. 添加订单明细：
   - 输入客户编码：`CUST-A-PART-12345`（客户A的物料编码）
   - 系统自动映射到主编码：`MAT-FIN-0001`
   - 系统自动填充默认销售价格：`80元/件`（从物料默认值获取）
   - 数量：`50件`
4. 点击"保存"

**系统行为**：
- 自动识别客户编码
- 自动映射到主编码
- 自动填充默认销售价格和单位
- 查询物料信息和库存

**结果**：
- 销售订单创建成功
- 使用客户编码快速录入订单
- 默认值自动填充，提高录入效率

### 11.15 场景15：使用供应商编码创建采购订单

**用户操作**：
1. 进入"采购管理" → "采购订单"
2. 创建采购订单
3. 选择供应商：`供应商B`
4. 添加订单明细：
   - 输入供应商编码：`SUP-B-MAT-67890`（供应商B的物料编码）
   - 系统自动映射到主编码：`MAT-FIN-0001`
   - 系统自动填充默认采购价格：`50元/件`（从物料默认值获取）
   - 数量：`100件`
5. 点击"保存"

**系统行为**：
- 自动识别供应商编码
- 自动映射到主编码
- 自动填充默认采购价格和单位
- 查询物料信息和供应商信息

**结果**：
- 采购订单创建成功
- 使用供应商编码快速录入订单
- 默认值自动填充，提高录入效率

**用户操作**：
1. 进入"销售管理" → "销售订单"
2. 创建销售订单
3. 添加订单明细：
   - 选择主物料：T恤（MAT-FIN-0001）
   - 选择变体属性：{"颜色": "红色", "尺寸": "M"}
   - 数量：50件
4. 点击"保存"

**系统行为**：
- 自动匹配变体编码：MAT-FIN-0001-RED-M
- 查询该变体的可用库存
- 如果库存不足，自动生成生产工单（MTO模式）

**结果**：
- 销售订单创建成功
- 变体属性正确记录
- 自动匹配库存或生成工单

**用户操作**：
1. 系统识别到重复物料
2. 进入物料映射工具
3. 选择要合并的物料
4. 确认合并

**系统行为**：
- 合并物料数据
- 建立编码映射关系
- 保留所有部门编码

**结果**：
- 物料合并成功
- 所有部门编码映射到同一主编码
- 业务不中断

---

## 12. 验收标准

### 12.1 新建物料界面设计

- ✅ **多标签页设计正常**：基本信息、变体管理、编码映射、默认值设置四个标签页正常显示和切换
- ✅ **基本信息标签页正常**：所有基本信息字段正常录入和验证，主编码自动生成正常
- ✅ **变体管理标签页正常**：变体属性选择界面正常，属性验证正常，变体编码预览正常
- ✅ **编码映射标签页正常**：部门编码、客户编码、供应商编码管理功能正常
- ✅ **默认值设置标签页正常**：所有默认值配置项正常保存和使用
- ✅ **表单验证正常**：各标签页独立验证，提交时全量验证正常
- ✅ **数据保存正常**：保存草稿、保存并提交功能正常
- ✅ **数据加载正常**：新建、编辑、只读模式数据加载正常

### 12.2 编码规则配置管理

- ✅ **规则配置界面正常**：编码规则配置界面功能完整，操作流畅
- ✅ **主编码规则配置正常**：支持配置主编码格式模板、物料类型、序号规则
- ✅ **部门编码规则配置正常**：支持添加、编辑、删除部门编码类型和格式规则
- ✅ **规则引擎正常**：规则引擎能够正确解析和执行配置的规则
- ✅ **规则验证正常**：规则配置时能够正确验证配置的合法性
- ✅ **规则版本管理正常**：支持规则版本记录、对比、回滚功能
- ✅ **规则生效控制正常**：支持规则的启用/禁用和生效时间控制
- ✅ **规则缓存正常**：规则缓存机制正常，性能优化有效
- ✅ **权限控制正常**：规则配置权限控制正确，操作日志记录完整

### 12.3 编码映射机制

- ✅ **主编码生成正常**：系统自动生成主编码，格式正确
- ✅ **部门编码保留正常**：部门编码作为别名保留，业务可正常使用
- ✅ **客户编码管理正常**：客户编码添加、编辑、删除功能正常，映射关系正确
- ✅ **供应商编码管理正常**：供应商编码添加、编辑、删除功能正常，映射关系正确
- ✅ **自动映射正常**：输入任意部门编码、客户编码、供应商编码，系统自动映射到主编码
- ✅ **映射关系存储正常**：所有类型的编码映射关系正确存储
- ✅ **映射关系查询正常**：支持正向和反向查询，支持按编码类型筛选

### 12.4 物料变体管理

- ✅ **变体属性配置管理正常**：变体属性定义配置界面功能完整，操作流畅
- ✅ **变体属性定义配置正常**：支持配置属性名称、类型、枚举值、验证规则等
- ✅ **变体属性规则引擎正常**：属性验证引擎和编码生成引擎能够正确执行
- ✅ **变体属性验证正常**：根据配置的验证规则正确验证属性值
- ✅ **变体编码规则配置正常**：支持配置变体编码格式模板和属性值映射规则
- ✅ **变体物料创建正常**：支持创建主物料和变体物料，变体属性正确存储和验证
- ✅ **变体编码生成正常**：根据配置的规则自动生成变体编码，格式正确
- ✅ **变体编码映射正常**：变体编码正确映射到主物料
- ✅ **BOM变体应用正常**：BOM支持变体特定子物料和用量差异
- ✅ **工单变体应用正常**：工单支持指定变体属性，自动计算变体特定物料需求
- ✅ **库存变体应用正常**：库存支持按变体属性管理，查询和统计正常
- ✅ **销售订单变体应用正常**：销售订单支持变体属性，自动匹配变体库存
- ✅ **变体属性版本管理正常**：支持属性定义版本记录、对比、回滚功能
- ✅ **变体组合管理正常**：支持多属性组合变体，组合唯一性验证正常

### 12.5 智能识别重复物料

- ✅ **高置信度识别正常**：名称+规格+单位完全一致，自动合并提示
- ✅ **中置信度识别正常**：名称相似+规格相同，提示管理员确认
- ✅ **低置信度识别正常**：名称相似但规格不同，仅提示不自动合并
- ✅ **多维度匹配正常**：支持名称、规格、单位等多维度匹配
- ✅ **AI辅助识别正常**：基于历史数据学习，提高识别准确率

### 12.6 物料映射工具

- ✅ **可视化合并正常**：重复物料列表显示正常
- ✅ **映射关系建立正常**：手动建立编码映射关系正常
- ✅ **部门编码保留正常**：合并物料时保留所有部门编码
- ✅ **属性合并正常**：合并物料属性（取并集）正常

### 12.7 多编码搜索

- ✅ **部门编码搜索正常**：支持输入任意部门编码搜索
- ✅ **拼音搜索正常**：支持物料名称拼音搜索
- ✅ **模糊匹配搜索正常**：支持模糊匹配搜索
- ✅ **搜索结果展示正常**：显示主编码和部门编码，高亮匹配内容

### 12.8 默认值设置功能

- ✅ **财务默认值正常**：默认税率、默认科目配置正常，业务中自动填充正常
- ✅ **采购默认值正常**：默认供应商、默认采购价格、默认采购单位、默认采购周期配置正常，采购订单中自动填充正常
- ✅ **销售默认值正常**：默认销售价格、默认销售单位、默认客户配置正常，销售订单中自动填充正常
- ✅ **库存默认值正常**：默认仓库、默认库位、安全库存、最大库存、最小库存配置正常，库存操作中自动填充正常
- ✅ **生产默认值正常**：默认工艺路线、默认生产单位配置正常，工单中自动填充正常
- ✅ **默认值优先级正常**：多个默认值时的优先级处理正常
- ✅ **默认值继承正常**：变体物料继承主物料默认值的功能正常（如果配置）

### 12.9 业务场景验证

- ✅ **新建物料场景正常**：多标签页界面正常，所有功能模块正常使用
- ✅ **规则配置场景正常**：支持配置主编码规则和部门编码规则
- ✅ **批量导入正常**：支持使用部门编码、客户编码、供应商编码批量导入物料，根据配置的规则生成主编码
- ✅ **BOM创建正常**：支持使用部门编码、客户编码、供应商编码创建BOM，自动映射到主编码；支持变体特定BOM
- ✅ **工单创建正常**：支持使用部门编码创建工单；支持变体属性的工单创建和物料需求计算
- ✅ **库存管理正常**：支持按变体属性管理库存，查询和统计正常；支持使用默认仓库和库位
- ✅ **销售订单正常**：支持使用部门编码、客户编码和变体属性创建销售订单，自动匹配库存；支持默认值自动填充
- ✅ **采购订单正常**：支持使用部门编码、供应商编码创建采购订单；支持默认值自动填充
- ✅ **搜索查询正常**：支持使用部门编码、客户编码、供应商编码和变体编码搜索物料
- ✅ **业务不中断**：编码规则变更不影响现有业务和数据
- ✅ **规则动态切换正常**：支持规则动态切换，不影响已生成的编码
- ✅ **默认值应用正常**：所有业务场景中默认值自动填充正常，可手动修改

---

## 13. 设计要点

### 13.1 用户体验优化

- ⚡ **解决编码不统一问题**：各部门可继续使用原有编码，系统自动映射
- ⚡ **不中断业务**：先导入后整理，业务可正常使用
- ⚡ **渐进式整理**：逐步建立映射关系，不强制一次性统一
- ⚡ **智能识别**：AI辅助识别重复物料，减少人工工作量
- ⚡ **灵活使用**：各部门可继续使用原有编码，系统自动映射到主编码
- ⚡ **规则可配置**：通过可视化界面配置编码规则，无需修改代码

### 13.2 技术实现要点

- ⚡ **编码规则引擎**：设计灵活的规则引擎，支持动态配置和执行
- ⚡ **编码映射表设计**：主编码和部门编码分离存储，建立映射关系
- ⚡ **自动映射算法**：高效的编码映射算法，支持快速查询
- ⚡ **智能识别算法**：多维度匹配算法，提高识别准确率
- ⚡ **搜索索引优化**：为编码和名称建立索引，提高搜索性能
- ⚡ **规则缓存机制**：缓存规则配置，提高编码生成性能
- ⚡ **规则版本管理**：支持规则版本控制和回滚机制

### 13.3 数据一致性保证

- ⚡ **主编码唯一性**：确保主编码全局唯一
- ⚡ **映射关系一致性**：确保编码映射关系一致
- ⚡ **数据完整性**：合并物料时保证数据完整性
- ⚡ **业务连续性**：编码映射和规则变更不影响现有业务
- ⚡ **规则一致性**：规则配置变更时确保编码生成的一致性

### 13.4 扩展性设计

- ⚡ **规则可配置化**：所有编码规则通过配置管理，不使用硬编码
- ⚡ **支持自定义编码类型**：支持添加新的部门编码类型，无需修改代码
- ⚡ **支持复杂格式模板**：支持多种占位符和复杂格式模板
- ⚡ **支持自定义验证规则**：支持正则表达式等多种验证方式
- ⚡ **支持规则插件化扩展**：支持自定义占位符和验证逻辑插件
- ⚡ **支持编码历史追溯**：支持查询编码变更历史和规则变更历史

---

### 13.5 变体管理设计要点

- ⚡ **属性可配置化**：所有变体属性定义通过系统配置界面管理，不使用硬编码
- ⚡ **灵活属性定义**：支持自定义变体属性类型、枚举值、验证规则等，满足不同行业的业务需求
- ⚡ **属性值验证**：基于配置的验证规则，支持枚举值验证、数值范围验证、格式验证、必填属性验证、组合唯一性验证
- ⚡ **变体编码规则可配置**：变体编码规则通过编码规则配置管理，支持自定义格式模板和属性值映射规则
- ⚡ **规则引擎驱动**：变体属性验证和编码生成由规则引擎执行，支持动态配置
- ⚡ **BOM变体支持**：BOM支持变体特定的子物料和用量差异
- ⚡ **业务全流程应用**：变体管理贯穿BOM、工单、库存、销售、采购等全业务流程
- ⚡ **变体属性继承**：支持变体属性的继承和覆盖机制
- ⚡ **变体统计分析**：支持按变体属性统计销售、库存、成本等数据
- ⚡ **属性版本管理**：支持属性定义的版本管理和历史追溯

---

### 13.6 新建物料界面设计要点

- ⚡ **多标签页分组**：按照功能模块分组，提高用户体验和操作效率
- ⚡ **渐进式录入**：支持分步录入，不强制一次性完成所有信息
- ⚡ **智能默认值**：默认值自动填充，减少重复录入，提高业务操作效率
- ⚡ **编码映射集中管理**：在一个界面中管理所有类型的编码映射，便于维护
- ⚡ **实时验证反馈**：表单验证实时反馈，及时提示错误
- ⚡ **数据草稿保存**：支持保存草稿，避免数据丢失
- ⚡ **编码自动生成**：主编码和变体编码自动生成，减少人工错误
- ⚡ **默认值继承**：变体物料可以继承主物料的默认值，减少配置工作量
- ⚡ **外部编码支持**：支持客户编码和供应商编码，满足业务协作需求
- ⚡ **灵活扩展**：默认值配置项可扩展，满足不同行业的业务需求

---

## 14. 后续强化设计方向

### 14.1 编码规则高级功能

1. **规则模板库**：提供常用编码规则模板，便于快速配置
2. **规则导入导出**：支持导入导出规则配置，便于规则迁移
3. **规则测试工具**：提供规则测试工具，支持批量测试编码生成
4. **规则影响分析**：规则变更前分析影响范围，提供变更建议
5. **规则审批流程**：支持规则变更审批流程，确保规则变更规范

### 14.2 编码历史管理

1. **编码变更历史**：记录编码变更历史（编码本身的变更）
2. **编码版本管理**：支持编码版本管理（如果支持编码修改）
3. **编码追溯**：支持查询编码的完整历史
4. **编码回滚**：支持编码变更回滚（如果支持编码修改）

### 14.3 编码统计分析

1. **编码使用统计**：统计各部门编码使用情况
2. **编码映射统计**：统计编码映射关系分布
3. **重复物料统计**：统计重复物料识别情况
4. **编码优化建议**：基于统计数据，提供编码优化建议
5. **规则使用统计**：统计规则使用情况，识别未使用的规则

### 14.4 编码导入导出

### 14.5 变体管理高级功能

1. **变体属性模板库**：提供常用变体属性模板（颜色、尺寸、规格等），便于快速配置
2. **变体属性导入导出**：支持导入导出变体属性定义配置，便于配置迁移
3. **变体组合生成器**：自动生成所有可能的变体组合，支持批量创建变体
4. **变体矩阵视图**：以矩阵形式展示和管理变体组合，支持快速启用/禁用变体
5. **变体属性继承**：支持多级变体属性继承，子物料可以继承主物料的变体属性
6. **变体数据分析**：提供变体销售分析、库存分析、成本分析等数据报表
7. **变体属性变更影响分析**：变更变体属性定义前，分析对现有变体和业务数据的影响
8. **变体属性值标准化**：支持属性值的标准化映射，统一不同输入格式
9. **变体库存预警**：按变体属性设置安全库存，支持变体级别的库存预警
10. **变体价格管理**：支持按变体属性设置不同的销售价格和采购价格
11. **变体供应商管理**：支持按变体属性设置不同的供应商和采购策略
12. **变体工艺路线管理**：支持变体特定的工艺路线（如不同颜色需要不同工艺）
13. **变体属性依赖可视化**：可视化展示属性之间的依赖关系
14. **变体属性值自动补全**：基于历史数据，智能推荐变体属性值

1. **编码映射导出**：支持导出编码映射关系（包括客户编码、供应商编码）
2. **编码映射导入**：支持导入编码映射关系（包括客户编码、供应商编码）
3. **编码批量操作**：支持批量建立、修改、删除编码映射关系
4. **编码模板管理**：支持编码映射模板管理
5. **规则配置批量导入**：支持批量导入规则配置
6. **默认值模板管理**：支持默认值配置模板，便于快速应用
7. **默认值批量设置**：支持批量设置物料的默认值
8. **默认值继承规则**：支持配置默认值继承规则（如变体继承主物料）
9. **客户编码批量导入**：支持从客户提供的Excel文件批量导入客户编码映射
10. **供应商编码批量导入**：支持从供应商提供的Excel文件批量导入供应商编码映射

---

**文档结束**
