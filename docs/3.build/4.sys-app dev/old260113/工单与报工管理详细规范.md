# 工单与报工管理详细规范

> **文档目标：** 专注于工单和报工管理的详细规范，剥离自《用户使用场景推演-MTS-MTO.md》，并进行强化和优化
> 
> **开发状态：**
> - ✅ **已完成（第一步MVP）**：工单管理、报工管理
> - ⏳ **已计划（第三步）**：工单高级管理、生产执行高级功能（工站上下料物料绑定）、工序修改、工单拆分、返工单、工单冻结、工单合并等

## 📋 文档概述

**核心原则：**
- 🚀 **极致简化**：减少操作步骤，减少输入字段，提高效率
- 🚀 **一键操作**：关键操作支持一键完成
- 🚀 **批量处理**：支持批量操作，提高效率
- 🚀 **智能默认**：智能默认值，减少用户输入
- 🚀 **多终端支持**：支持移动端和工位机触屏模式，适应不同使用场景

**针对中国式中小企业痛点优化：**
- ✅ 一人多岗，操作要简单（减少操作步骤）
- ✅ 数据录入量大（批量导入优先）
- ✅ 对系统不熟悉（向导引导+智能默认值+内置帮助）
- ✅ 重视效率（一键操作+批量操作）
- ✅ 快速上手（行业模板+快速初始化+操作提示）
- ✅ 多终端使用（移动端和工位机触屏模式，适应不同使用场景）

---

## 1. 工单管理核心功能

### 1.1 工单创建（优化：根据工艺路线自动生成工序）

> **开发状态：** ✅ **已完成（第一步MVP）**

#### 1.1.1 手动创建工单

**用户操作（优化后，极致简化）：**

1. 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
2. 点击"新建"按钮
3. 填写工单基本信息：
   - 选择产品：产品A
   - **系统自动匹配工艺路线**（核心功能，参考黑湖小工单）：
     - 系统自动检查产品A是否绑定了工艺路线
     - 如果产品A绑定了工艺路线，使用产品A绑定的工艺路线（物料优先级）
     - 如果产品A没有绑定工艺路线，检查产品A所属的物料分组是否绑定了工艺路线
     - 如果物料分组绑定了工艺路线，使用物料分组绑定的工艺路线（分组继承）
     - 如果都没有绑定，提示用户选择工艺路线
   - **系统自动填充**：
     - 默认工艺路线：产品A工艺路线（基于自动匹配结果）
     - 默认车间：组装车间（基于工艺路线首工序）
     - 默认工作中心：组装线1（基于工艺路线首工序）
   - 选择数量：90个
   - 选择计划开始时间：2026-01-05 08:00
   - 选择计划结束时间：2026-01-05 18:00（系统可自动计算，基于工艺路线标准工时）
   - **系统自动根据工艺路线生成工单工序单**（核心功能，参考黑湖小工单）：
     - 系统读取匹配到的工艺路线的工序序列
     - 自动为工单创建对应的工序单（WorkOrderOperation），每个工序单包含：
       - 工序1：注塑工序（注塑车间，注塑机1，标准工时10分钟/件）
         - 工序单号：自动生成（WO-20260105-001-OP001）
         - 工序顺序：1
         - 关联工序：注塑工序
         - 关联车间：注塑车间
         - 关联工作中心：注塑机1
         - 标准工时：10分钟/件
         - 准备时间：5分钟
         - 计划开始时间：自动计算（基于工单计划开始时间和前序工序）
         - 计划结束时间：自动计算
       - 工序2：组装工序（组装车间，组装线1，标准工时15分钟/件）
         - 工序单号：自动生成（WO-20260105-001-OP002）
         - 工序顺序：2
         - 关联工序：组装工序
         - 关联车间：组装车间
         - 关联工作中心：组装线1
         - 标准工时：15分钟/件
         - 准备时间：10分钟
         - 计划开始时间：自动计算（基于前序工序完成时间）
         - 计划结束时间：自动计算
       - 工序3：包装工序（包装车间，包装线1，标准工时5分钟/件）
         - 工序单号：自动生成（WO-20260105-001-OP003）
         - 工序顺序：3
         - 关联工序：包装工序
         - 关联车间：包装车间
         - 关联工作中心：包装线1
         - 标准工时：5分钟/件
         - 准备时间：3分钟
         - 计划开始时间：自动计算（基于前序工序完成时间）
         - 计划结束时间：自动计算
     - **如果是带SOP工艺路线，系统自动关联SOP**：
       - 工序1：注塑工序 → 关联SOP《注塑作业标准》
       - 工序2：组装工序 → 关联SOP《组装作业标准》
       - 工序3：包装工序 → 关联SOP《包装作业标准》
4. 提交工单

**系统行为（优化后）：**
- ✅ 自动生成工单号（工单-20260105-001）
- ✅ 创建工单数据
- ✅ **根据工艺路线自动生成工单工序单**（核心功能，新增，参考黑湖小工单）
  - **自动匹配工艺路线**：
    - 创建工单时，系统自动检查物料是否绑定了工艺路线
    - 优先级规则：物料绑定 > 物料分组绑定
    - 如果物料绑定了工艺路线，使用物料绑定的工艺路线
    - 如果物料没有绑定，但所属分组绑定了工艺路线，使用分组绑定的工艺路线
    - 如果都没有绑定，提示用户选择工艺路线
  - **自动创建工序单**（WorkOrderOperation）：
    - 系统读取匹配到的工艺路线的工序序列（operation_sequence）
    - 为工单自动创建对应的工序单，每个工序单包含：
      - 工序单号：自动生成（格式：{工单号}-OP{序号}）
      - 工序顺序：基于工艺路线的工序顺序
      - 关联工序：从工艺路线中获取
      - 关联车间：从工序中获取
      - 关联工作中心：从工序中获取
      - 标准工时：从工艺路线中获取（或从工序中获取）
      - 准备时间：从工艺路线中获取（或从工序中获取）
      - 计划开始时间：自动计算（基于工单计划开始时间和前序工序完成时间）
      - 计划结束时间：自动计算（基于计划开始时间、标准工时和工单数量）
      - 关联SOP：如果工艺路线中工序关联了SOP，自动关联到工序单
  - **自动填充工序顺序**（基于工艺路线）
  - **自动填充工序车间和工作中心**（基于工艺路线中的工序配置）
  - **自动填充标准工时和准备时间**（基于工艺路线或工序配置）
  - **如果是带SOP工艺路线，自动关联SOP**（核心功能，新增）
- ✅ **单据关联展示**（核心功能，新增）：
  - 在工单详情页面展示上游关联单据（销售预测、MRP运算）和下游关联单据（生产领料出库单、报工记录、成品入库单、销售出库单）
  - 支持点击跳转到关联单据详情
  - 支持查看完整关联链条（关联追溯）
- ✅ **单据下推功能**（核心功能，新增）：
  - 支持从工单下推到生产领料出库单（一键下推）
  - 支持从工单下推到报工记录（移动端/工位机）
  - 支持从工单下推到成品入库单（一键下推）
  - 自动传递工单信息到下游单据
- ✅ **单据上拉功能**（核心功能，新增）：
  - 支持从工单上拉到销售预测/销售订单（手动关联）
  - 支持从报工记录上拉到工单（手动关联或智能关联）
- ✅ 生成工单二维码（用于扫码报工）
- ✅ 批量导入工单（universheet在线表格，实时保存）
- ✅ 打印工单（包含工序信息）

**验收标准：**
- ✅ 工单创建成功（支持universheet在线表格批量导入，实时保存）
- ✅ 工单号自动生成成功（支持中文前缀）
- ✅ **工单工序单自动生成成功**（基于工艺路线，参考黑湖小工单）：
  - ✅ 系统自动匹配工艺路线成功（物料绑定 → 物料分组绑定）
  - ✅ 自动创建工序单（WorkOrderOperation）成功
  - ✅ 工序单包含完整信息（工序顺序、关联工序、车间、工作中心、标准工时、准备时间、计划时间）
  - ✅ 工序单号自动生成成功（格式：{工单号}-OP{序号}）
  - ✅ 计划时间自动计算成功（基于前序工序完成时间）
  - ✅ 带SOP工艺路线自动关联SOP成功
- ✅ 工单二维码生成成功（支持中文）
- ✅ 工单打印可用（包含工序信息）

**优化效果：**
- ⚡ **操作步骤减少**：无需手动创建工序，系统自动生成
- ⚡ **时间缩短**：从10分钟减少到<2分钟（自动生成工序）
- ⚡ **准确性提升**：基于工艺路线生成，确保工序顺序和参数正确

---

#### 1.1.2 批量导入工单

**用户操作：**

1. 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
2. 点击"批量导入"按钮
3. 打开工单导入universheet在线表格（系统自动创建模板）
4. 在universheet中填写工单数据（实时保存）：
   - 产品编码、产品名称
   - 数量
   - 工艺路线编码（可选，如果不填写，系统自动匹配）
   - 计划开始时间
   - 计划结束时间
   - 车间（可选）
   - 工作中心（可选）
5. 点击"导入"按钮，系统自动导入
6. 系统自动创建工单并生成工序（基于产品默认工艺路线）

**系统行为：**
- ✅ 自动创建工单（批量创建）
- ✅ 自动生成工序（基于产品默认工艺路线）
- ✅ 实时保存（universheet在线表格，实时保存）

**验收标准：**
- ✅ 批量导入工单成功
- ✅ 工单工序自动生成成功（基于产品默认工艺路线）
- ✅ 实时保存功能正常

---

#### 1.1.3 工单列表专门化改造

**核心功能（新增）：**

1. **表格行展开功能**：
   - 工单列表表格支持行展开（点击行左侧展开图标或双击行）
   - 展开后显示该工单的所有工序信息

2. **图形化工序显示**：
   - 展开行以图形化的方式显示所有工序
   - 工序按顺序横向排列，形成工序流程图
   - 每道工序显示为独立的工序卡片

3. **环状图显示工序进度**：
   - 每道工序以环状图（Progress Ring）显示进度
   - 环状图显示：
     - 已完成数量 / 计划数量（如：80/100）
     - 完成百分比（如：80%）
     - 合格数量 / 不合格数量（如：合格：75，不合格：5）
   - 环状图颜色：
     - 绿色：已完成且合格率达标（≥95%）
     - 黄色：进行中或合格率偏低（80%-95%）
     - 红色：异常或合格率过低（<80%）

4. **工序卡片信息**：
   - 工序名称：注塑工序
   - 工序状态：待开始/进行中/已完成/已暂停
   - 关联车间：注塑车间
   - 关联工作中心：注塑机1
   - 计划时间：2026-01-05 08:00 - 10:00
   - 实际时间：2026-01-05 08:05 - 10:15（如有）
   - 操作人员：张三（如有）

5. **工序卡片操作**：
   - 点击工序卡片可查看工序详情
   - 支持快速报工（移动端/工位机）
   - 支持查看SOP（如果关联了SOP）

6. **高级搜索**（使用高级搜索，支持拼音搜索）

**系统行为：**
- ✅ **表格行展开功能**：
  - 支持行展开/收起（点击展开图标或双击行）
  - 展开后显示该工单的所有工序信息
- ✅ **图形化工序显示**：
  - 展开行以图形化的方式显示所有工序
  - 工序按顺序横向排列，形成工序流程图
  - 每道工序显示为独立的工序卡片
  - 工序卡片包含完整信息（工序名称、状态、车间、工作中心、计划时间、实际时间、操作人员）
- ✅ **环状图显示工序进度**：
  - 每道工序以环状图（Progress Ring）显示进度
  - 环状图显示已完成数量/计划数量、完成百分比、合格数量/不合格数量
  - 环状图颜色根据完成状态和合格率自动变化（绿色/黄色/红色）
  - 支持点击工序卡片查看详情、快速报工、查看SOP
- ✅ 高级搜索（拼音搜索）

**验收标准：**
- ✅ 表格行展开功能正常（点击展开图标或双击行）
- ✅ 图形化工序显示正常（工序流程图、工序卡片）
- ✅ 环状图显示工序进度正常（完成数量、完成百分比、合格数量/不合格数量）
- ✅ 环状图颜色自动变化正常（根据完成状态和合格率）
- ✅ 工序卡片信息完整（工序名称、状态、车间、工作中心、计划时间、实际时间、操作人员）
- ✅ 工序卡片操作正常（查看详情、快速报工、查看SOP）
- ✅ 工单高级搜索可用（拼音搜索）

---

### 1.2 工单管理高级功能

#### 1.2.1 返工单管理（核心功能，新增）

**应用场景：**
- 生产过程中发现质量问题，需要返工
- 已完工的产品需要返工
- 客户退货需要返工

**用户操作：**

1. **创建返工单（方式1：从原工单创建）**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 选择原工单：工单-20260105-001（产品A，已完工）
   - 点击"创建返工单"按钮
   - **系统自动填充**：
     - 返工单号：返工-工单-20260105-001-001（自动生成）
     - 原工单号：工单-20260105-001（自动关联）
     - 产品：产品A（自动填充）
     - 返工数量：10个（用户输入，不能超过原工单数量）
     - 返工原因：质量问题（用户选择或输入）
     - 返工类型：全部返工/部分返工（用户选择）
   - **选择返工工序**：
     - 方式1：全部工序返工（从第一道工序开始）
     - 方式2：指定工序返工（选择需要返工的工序，如：只返工组装工序）
   - 提交返工单

2. **创建返工单（方式2：手动创建）**
   - 进入"快智造" → "生产执行" → "工单管理" → "返工单管理"
   - 点击"新建返工单"按钮
   - 填写返工单信息：
     - 关联原工单：工单-20260105-001（可选，支持搜索）
     - 产品：产品A
     - 返工数量：10个
     - 返工原因：质量问题
     - 返工类型：部分返工
     - 选择返工工序：组装工序、包装工序
   - 提交返工单

3. **返工单执行**
   - 返工单创建后，自动生成返工工序（基于选择的返工工序）
   - 返工单可以正常报工（与普通工单相同）
   - 返工完成后，自动更新原工单状态

**系统行为：**
- ✅ **返工单创建**（核心功能，新增）：
  - 支持从原工单创建返工单
  - 支持手动创建返工单
  - 自动生成返工单号（返工-{原工单号}-{序号}）
  - 自动关联原工单
  - 自动生成返工工序（基于选择的返工工序）
- ✅ **返工单管理**：
  - 返工单独立管理（有独立的返工单列表）
  - 返工单可以正常报工、下达、完工
  - 返工单完成后，自动更新原工单状态
- ✅ **返工追溯**：
  - 支持查询原工单的所有返工单
  - 支持查询返工单的原工单
  - 支持返工单的完整追溯

**验收标准：**
- ✅ 返工单创建成功（支持从原工单创建和手动创建）
- ✅ 返工单号自动生成成功
- ✅ 返工单关联原工单成功
- ✅ 返工工序自动生成成功
- ✅ 返工单可以正常报工
- ✅ 返工单完成后，原工单状态更新成功
- ✅ 返工追溯查询正常

---

#### 1.2.2 工单拆分（核心功能，新增）

**应用场景：**
- 大工单需要拆分成多个小工单，分配给不同车间或班组
- 紧急订单需要优先生产部分数量
- 产能限制，需要分批生产

**用户操作：**

1. **拆分工单**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 选择大工单：工单-20260105-001（产品A，数量：100个，状态：已下达）
   - 点击"拆分工单"按钮
   - **系统显示拆分界面**：
     - 原工单信息：工单-20260105-001，产品A，数量100个
     - 已报工数量：30个（已报工，不能拆分）
     - 可拆分数量：70个（未报工部分）
   - **设置拆分规则**：
     - 方式1：按数量拆分
       - 拆分数量1：30个（工单-20260105-001-1）
       - 拆分数量2：40个（工单-20260105-001-2）
       - 剩余数量：自动计算（原工单数量 - 已拆分数量）
     - 方式2：按工序拆分
       - 原工单保留：工序1（注塑工序）
       - 拆分工单1：工序2、工序3（组装工序、包装工序）
   - **设置拆分工单信息**：
     - 拆分工单1：
       - 工单号：工单-20260105-001-1（自动生成）
       - 数量：30个
       - 车间：注塑车间（可修改）
       - 工作中心：注塑机1（可修改）
       - 计划开始时间：2026-01-06 08:00（可修改）
     - 拆分工单2：
       - 工单号：工单-20260105-001-2（自动生成）
       - 数量：40个
       - 车间：注塑车间（可修改）
       - 工作中心：注塑机2（可修改）
       - 计划开始时间：2026-01-06 14:00（可修改）
   - 确认拆分
   - **系统自动处理**：
     - 创建拆分工单（工单-20260105-001-1、工单-20260105-001-2）
     - 原工单数量更新为：30个（已报工数量）
     - 原工单状态保持不变（已下达）
     - 拆分工单状态：已创建（需要下达）

2. **拆分工单管理**
   - 拆分工单可以独立管理（独立下达、报工、完工）
   - 拆分工单完成后，自动更新原工单进度
   - 支持查看原工单的所有拆分工单

**系统行为：**
- ✅ **工单拆分**（核心功能，新增）：
  - 支持按数量拆分（将大工单拆分成多个小工单）
  - 支持按工序拆分（将大工单的工序拆分到不同工单）
  - 只能拆分未报工部分（已报工部分不能拆分）
  - 自动生成拆分工单号（{原工单号}-{序号}）
  - 自动生成拆分工单工序（基于原工单工艺路线）
  - 原工单数量自动更新（保留已报工数量）
- ✅ **拆分工单管理**：
  - 拆分工单独立管理（可以独立下达、报工、完工）
  - 拆分工单完成后，自动更新原工单进度
  - 支持查看原工单的所有拆分工单
- ✅ **拆分追溯**：
  - 支持查询原工单的所有拆分工单
  - 支持查询拆分工单的原工单
  - 支持拆分工单的完整追溯

**验收标准：**
- ✅ 工单拆分成功（支持按数量拆分和按工序拆分）
- ✅ 只能拆分未报工部分（已报工部分不能拆分）
- ✅ 拆分工单号自动生成成功
- ✅ 拆分工单工序自动生成成功
- ✅ 原工单数量更新成功（保留已报工数量）
- ✅ 拆分工单可以独立管理
- ✅ 拆分追溯查询正常

---

#### 1.2.3 执行中工单工序修改（核心功能，新增）

**应用场景：**
- 已开工并在执行中的工单，发现工艺路线需要调整
- 未报工的工序需要修改（车间、工作中心、标准工时等）
- 需要增加或删除未报工的工序

**用户操作：**

1. **修改执行中工单的未报工工序**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 选择执行中工单：工单-20260105-001（产品A，状态：执行中）
   - 查看工单详情：
     - 工序1：注塑工序（已报工，30个）
     - 工序2：组装工序（未报工，计划数量70个）
     - 工序3：包装工序（未报工，计划数量70个）
   - 点击"编辑工序"按钮
   - **系统自动判断**：
     - 已报工工序：不允许修改（灰色显示，不可编辑）
     - 未报工工序：允许修改（可编辑）
   - **修改未报工工序**：
     - 工序2：组装工序
       - 修改车间：从"组装车间"改为"组装车间2"
       - 修改工作中心：从"组装线1"改为"组装线2"
       - 修改标准工时：从"15分钟/件"改为"12分钟/件"
     - 工序3：包装工序
       - 修改车间：从"包装车间"改为"包装车间2"
       - 修改工作中心：从"包装线1"改为"包装线2"
   - 保存修改
   - **系统自动处理**：
     - 更新未报工工序信息
     - 已报工工序保持不变
     - 自动重新计算计划结束时间（基于修改后的标准工时）

2. **增加未报工工序**
   - 编辑执行中工单：工单-20260105-001
   - 点击"添加工序"按钮
   - 选择工序：检验工序（未报工）
   - 插入位置：在工序2（组装工序）之后
   - 设置工序信息：
     - 车间：质量部
     - 工作中心：检验台1
     - 标准工时：5分钟/件
   - 保存
   - **系统自动处理**：
     - 在工序2之后插入检验工序
     - 自动更新工序顺序
     - 自动重新计算计划结束时间

3. **删除未报工工序**
   - 编辑执行中工单：工单-20260105-001
   - 选择未报工工序：工序3（包装工序）
   - 点击"删除工序"按钮
   - 确认删除
   - **系统自动处理**：
     - 删除未报工工序
     - 自动更新工序顺序
     - 自动重新计算计划结束时间

**系统行为：**
- ✅ **执行中工单工序修改**（核心功能，新增）：
  - 已报工工序：不允许修改（灰色显示，不可编辑）
  - 未报工工序：允许修改（可编辑）
  - 支持修改未报工工序的车间、工作中心、标准工时等
  - 支持增加未报工工序
  - 支持删除未报工工序
  - 自动重新计算计划结束时间（基于修改后的标准工时）
- ✅ **修改记录**：
  - 自动记录工序修改历史
  - 支持查看工序修改记录
- ✅ **修改校验**：
  - 自动校验修改的合理性（如：工序顺序、跳转规则等）
  - 修改后自动更新工单进度

**验收标准：**
- ✅ 已报工工序不允许修改（灰色显示，不可编辑）
- ✅ 未报工工序允许修改（可编辑）
- ✅ 未报工工序修改成功（车间、工作中心、标准工时等）
- ✅ 增加未报工工序成功
- ✅ 删除未报工工序成功
- ✅ 计划结束时间自动重新计算成功
- ✅ 工序修改记录正常

---

#### 1.2.4 工单冻结（核心功能，新增）

**应用场景：**
- 遇到质量问题，需要暂停生产
- 原材料质量问题，需要等待处理
- 设备故障，需要暂停生产
- 客户要求暂停生产

**用户操作：**

1. **冻结工单（方式1：单个冻结）**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 选择执行中工单：工单-20260105-001（产品A，状态：执行中）
   - 点击"冻结工单"按钮
   - **填写冻结信息**：
     - 冻结原因：质量问题（用户选择或输入）
     - 冻结类型：质量问题/原材料问题/设备故障/客户要求（用户选择）
     - 冻结说明：详细说明冻结原因（用户输入）
     - 预计解冻时间：2026-01-10 08:00（可选）
   - 确认冻结
   - **系统自动处理**：
     - 工单状态更新为：已冻结
     - 停止工单进度更新
     - 通知相关人员（生产管理员、车间工人）

2. **冻结工单（方式2：批量冻结）**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 勾选多个执行中工单（支持全选）
   - 点击"批量冻结"按钮
   - 填写冻结信息（同单个冻结）
   - 确认冻结
   - **系统自动处理**：
     - 批量更新工单状态为：已冻结
     - 停止所有工单进度更新
     - 通知相关人员

3. **解冻工单**
   - 进入"快智造" → "生产执行" → "工单管理" → "已冻结工单"
   - 选择已冻结工单：工单-20260105-001
   - 点击"解冻工单"按钮
   - **填写解冻信息**：
     - 解冻原因：问题已解决（用户输入）
     - 解冻说明：详细说明解冻原因（用户输入）
   - 确认解冻
   - **系统自动处理**：
     - 工单状态更新为：执行中（恢复原状态）
     - 恢复工单进度更新
     - 通知相关人员

4. **冻结工单管理**
   - 查看已冻结工单列表（独立的冻结工单列表）
   - 查看冻结原因和冻结时间
   - 查看预计解冻时间
   - 支持按冻结原因筛选

**系统行为：**
- ✅ **工单冻结**（核心功能，新增）：
  - 支持单个工单冻结
  - 支持批量工单冻结
  - 工单状态更新为：已冻结
  - 停止工单进度更新（冻结期间不更新进度）
  - 自动记录冻结原因和冻结时间
  - 支持设置预计解冻时间
  - 自动通知相关人员
- ✅ **工单解冻**：
  - 支持解冻工单
  - 工单状态恢复为：执行中（恢复原状态）
  - 恢复工单进度更新
  - 自动记录解冻原因和解冻时间
  - 自动通知相关人员
- ✅ **冻结工单管理**：
  - 独立的冻结工单列表
  - 支持按冻结原因筛选
  - 支持查看冻结历史记录
- ✅ **冻结校验**：
  - 已完工工单不能冻结
  - 已取消工单不能冻结
  - 冻结工单不能报工（自动阻止）

**验收标准：**
- ✅ 工单冻结成功（支持单个冻结和批量冻结）
- ✅ 工单状态更新为：已冻结
- ✅ 冻结期间停止工单进度更新
- ✅ 冻结工单不能报工（自动阻止）
- ✅ 工单解冻成功
- ✅ 解冻后工单状态恢复为：执行中
- ✅ 解冻后恢复工单进度更新
- ✅ 冻结工单管理正常（独立的冻结工单列表）
- ✅ 冻结历史记录正常

---

#### 1.2.5 工单优先级管理（核心功能，新增）

**应用场景：**
- 不同工单有不同的紧急程度和重要性
- 需要按优先级排序和筛选工单
- 优先级影响排产计划和资源分配
- 支持紧急插单和优先级调整

**用户操作：**

1. **设置工单优先级（方式1：创建工单时设置）**
   - 进入"快智造" → "生产执行" → "工单管理" → "新建工单"
   - 填写工单基本信息（产品、数量、工艺路线等）
   - **设置工单优先级**（核心功能，新增）：
     - 优先级：紧急/高/中/低（选择：高）
     - 优先级说明：客户A紧急订单（用户输入，可选）
     - 优先级依据：交期紧急/重要客户/高价值订单/其他（选择：交期紧急）
   - 保存工单

2. **设置工单优先级（方式2：批量设置）**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 勾选多个工单（支持全选）
   - 点击"批量设置优先级"按钮
   - 选择优先级：紧急/高/中/低
   - 填写优先级说明（可选）
   - 确认设置
   - **系统自动处理**：
     - 批量更新工单优先级
     - 自动重新计算排产计划（如果已排产）

3. **按优先级排序和筛选**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - **排序方式**（核心功能，新增）：
     - 按优先级排序：紧急 → 高 → 中 → 低
     - 按优先级+交期排序：优先级相同，按交期排序
     - 按优先级+创建时间排序：优先级相同，按创建时间排序
   - **筛选方式**（核心功能，新增）：
     - 筛选优先级：只显示紧急工单/高优先级工单等
     - 筛选优先级+状态：只显示紧急+已下达工单等
   - 查看优先级标识：
     - 紧急：红色标识
     - 高：橙色标识
     - 中：蓝色标识
     - 低：灰色标识

4. **紧急插单**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "工单管理" → "紧急插单"
   - 创建紧急工单：
     - 选择产品：产品A
     - 填写数量：50个
     - 填写交期：2026-01-20（紧急交期）
     - 优先级：自动设置为"紧急"
     - 插单原因：客户A紧急订单（用户输入）
   - 提交紧急插单申请
   - **系统自动处理**：
     - 自动检查现有排产计划
     - 自动分析插单影响（影响哪些工单、影响程度）
     - 自动生成插单方案（调整排产计划、增加产能等）
     - 显示AI建议的插单方案
   - 用户确认插单方案
   - **系统自动处理**：
     - 自动调整受影响工单的排产计划
     - 自动通知相关人员（受影响工单负责人）
     - 自动更新排产甘特图

**系统行为：**
- ✅ **工单优先级设置**：
  - 支持创建工单时设置优先级
  - 支持批量设置优先级
  - 支持优先级调整（可随时修改）
  - 自动记录优先级变更历史
- ✅ **优先级排序和筛选**：
  - 支持按优先级排序（紧急 → 高 → 中 → 低）
  - 支持按优先级+交期排序
  - 支持按优先级筛选
  - 支持优先级标识显示（颜色标识）
- ✅ **紧急插单**（核心功能，新增）：
  - 自动设置优先级为"紧急"
  - 自动分析插单影响（影响哪些工单、影响程度）
  - 自动生成插单方案（调整排产计划、增加产能等）
  - 自动调整受影响工单的排产计划
  - 自动通知相关人员
- ✅ **优先级对排产的影响**：
  - 排产时优先考虑高优先级工单
  - 优先级影响工作中心分配
  - 优先级影响物料分配
- 🤖 **AI智能建议**：
  - 基于交期和重要性，建议工单优先级
  - 分析插单影响，建议最佳插单方案
  - 识别优先级冲突，建议调整方案

**验收标准：**
- ✅ 工单优先级设置成功（支持创建时设置和批量设置）
- ✅ 优先级排序和筛选正常（按优先级排序、筛选）
- ✅ 优先级标识显示正常（颜色标识）
- ✅ 紧急插单正常（自动分析影响、生成方案、调整排产）
- ✅ 优先级对排产的影响正常（优先考虑高优先级工单）

---

#### 1.2.6 工单合并（核心功能，新增）

**应用场景：**
- 多个小工单可以合并成大工单，提高生产效率
- 相同产品的多个工单可以合并
- 合并工单可以减少换模次数，提高设备利用率

**用户操作：**

1. **合并工单（方式1：选择多个工单合并）**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
   - 勾选多个工单（支持多选）：
     - 工单1：工单-20260105-001（产品A，数量：50个，状态：已创建）
     - 工单2：工单-20260105-002（产品A，数量：30个，状态：已创建）
     - 工单3：工单-20260105-003（产品A，数量：20个，状态：已创建）
   - 点击"合并工单"按钮
   - **系统自动检查合并条件**（核心功能，新增）：
     - 检查产品是否相同：产品A（相同，可合并）
     - 检查工艺路线是否相同：产品A工艺路线（相同，可合并）
     - 检查工单状态：已创建（相同，可合并）
     - 检查是否已报工：未报工（可合并）
   - **设置合并工单信息**：
     - 合并工单号：工单-20260105-001（自动生成，使用第一个工单号）
     - 产品：产品A（自动填充）
     - 数量：100个（自动计算：50+30+20）
     - 工艺路线：产品A工艺路线（自动填充）
     - 计划开始时间：2026-01-05 08:00（自动填充，使用最早工单的开始时间）
     - 计划结束时间：2026-01-05 18:00（自动计算，基于合并数量和标准工时）
   - 确认合并
   - **系统自动处理**：
     - 创建合并工单：工单-20260105-001（数量：100个）
     - 原工单状态更新为：已合并
     - 原工单关联到合并工单（支持追溯）
     - 自动生成合并工单工序（基于工艺路线）

2. **合并工单（方式2：按条件自动合并）**
   - 进入"快智造" → "生产执行" → "工单管理" → "工单合并" → "自动合并"
   - **设置合并条件**（核心功能，新增）：
     - 产品相同：是（必选）
     - 工艺路线相同：是（必选）
     - 工单状态：已创建（必选）
     - 时间范围：2026-01-05 至 2026-01-10（可选）
     - 最大合并数量：200个（可选，超过此数量不合并）
   - 点击"自动合并"按钮
   - **系统自动处理**：
     - 自动查找符合条件的工单
     - 自动分组（相同产品、相同工艺路线）
     - 自动合并每组工单
     - 显示合并结果（合并了多少组、合并了多少工单）

3. **合并工单管理**
   - 进入"快智造" → "生产执行" → "工单管理" → "合并工单列表"
   - 查看合并工单列表
   - 查看合并工单详情：
     - 合并工单号：工单-20260105-001
     - 原工单列表：工单-20260105-001、工单-20260105-002、工单-20260105-003
     - 合并数量：100个
     - 合并时间：2026-01-05 10:00
   - 支持拆分合并工单（如果合并有误）

**系统行为：**
- ✅ **工单合并条件检查**（核心功能，新增）：
  - 自动检查产品是否相同
  - 自动检查工艺路线是否相同
  - 自动检查工单状态是否相同
  - 自动检查是否已报工（已报工工单不能合并）
- ✅ **工单合并**：
  - 支持手动选择工单合并
  - 支持按条件自动合并
  - 自动生成合并工单号（使用第一个工单号）
  - 自动计算合并数量
  - 自动更新原工单状态：已合并
  - 自动关联原工单（支持追溯）
- ✅ **合并工单管理**：
  - 独立的合并工单列表
  - 支持查看合并工单详情（原工单列表）
  - 支持拆分合并工单（如果合并有误）
- ✅ **合并工单追溯**：
  - 支持查询合并工单的原工单
  - 支持查询原工单的合并工单
- 🤖 **AI智能建议**：
  - 基于工单信息，建议可合并的工单
  - 分析合并收益（减少换模次数、提高设备利用率）
  - 识别合并风险（交期冲突、产能不足）

**验收标准：**
- ✅ 工单合并条件检查正常（产品、工艺路线、状态、报工状态）
- ✅ 工单合并成功（手动合并和自动合并）
- ✅ 合并工单管理正常（合并工单列表、详情、拆分）
- ✅ 合并工单追溯正常（查询原工单和合并工单）

---

### 1.3 工单下达（优化：批量下达+智能检查）

> **开发状态：** ✅ **已完成（第一步MVP）**

**用户操作（优化后，极致简化）：**

1. 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
2. **方式1：批量下达（推荐，中小企业常用）**
   - 勾选多个已排产的工单（支持全选）
   - 点击"批量下达"按钮
   - **系统自动检查并显示结果**：
     - 齐套料检查结果（缺料预警）
     - 交期风险评估（延期风险提示）
     - 工作中心能力检查（产能冲突提示）
   - 查看检查结果：
     - **全部通过**：点击"确认批量下达"，系统自动下达所有工单
     - **部分异常**：系统自动标记异常工单，用户可选择：
       - 忽略异常，强制下达所有工单
       - 排除异常工单，下达正常工单
   - **完成，<1分钟**

3. **方式2：单个下达（可选）**
   - 选择已排产的工单
   - 点击"下达"按钮
   - 系统自动检查并显示AI建议
   - 确认下达工单（可选择忽略AI建议强制下达）

**系统行为（优化后）：**
- ✅ **批量下达**：支持批量下达多个工单（核心优化）
- ✅ **智能检查**：批量下达前，自动检查所有工单的齐套料、交期、产能
- ✅ **智能标记**：自动标记异常工单，方便用户快速识别
- ✅ **冻结工单检查**（核心功能，新增）：
  - 自动检查工单是否已冻结
  - 已冻结工单不能下达（自动排除）
  - 下达时自动提示冻结工单
- ✅ 更新工单状态为"已下达"
- ✅ 触发工单状态流转工作流（Inngest）
- ✅ 通知相关人员（生产管理员、车间工人）
- 🤖 **AI智能建议**（通过Inngest AI工作流）：
  - **齐套料分析**：自动检查物料齐套情况，缺料时提示并建议解决方案
  - **交期风险评估**：基于历史数据和当前产能，预测交期风险，建议调整计划
  - **工作中心能力检查**：检测工作中心产能冲突，建议调整排产计划
  - **优化建议**：基于历史数据，建议最佳下达时机和排产顺序

**验收标准：**
- ✅ **批量下达正常**（核心功能）
- ✅ **冻结工单检查正常**（核心功能，新增）：
  - ✅ 自动检查工单是否已冻结
  - ✅ 已冻结工单不能下达（自动排除）
  - ✅ 下达时自动提示冻结工单
- ✅ 工单下达成功
- ✅ 工单状态更新成功
- ✅ 通知发送成功
- ✅ AI建议正常显示（下达前弹窗提示，可查看详细分析）
- ✅ 齐套料检查正常（缺料时明确提示）
- ✅ 交期风险评估正常（延期风险提前预警）

**优化效果：**
- ⚡ **操作步骤减少**：从6步减少到3步（勾选→批量下达→确认）
- ⚡ **时间缩短**：从10分钟（单个下达）减少到<1分钟（批量下达）
- ⚡ **效率提升**：一次操作完成多个工单下达，无需逐个操作

---

## 2. 报工管理核心功能

### 2.1 报工阶段（优化：快速报工+带参数报工+自动填充+工位机触屏模式）

> **开发状态：** ✅ **已完成（第一步MVP）**

**用户操作（优化后，极致简化，支持移动端和工位机触屏）：**

#### 2.1.1 车间工人操作（三种终端模式）

**方式A：工位机触屏模式（推荐，车间固定工位）**

1. 工位机开机，自动进入工位机触屏模式（全屏显示）
2. **触屏界面特点**：
   - 大按钮设计（按钮高度≥60px，适合手指点击）
   - 大字体显示（字体大小≥24px，清晰易读）
   - 全屏模式（无浏览器地址栏，沉浸式体验）
   - 触屏优化布局（元素间距≥20px，避免误触）
3. **扫码报工（最快，推荐）**：
   - 点击"扫码报工"大按钮（全屏显示）
   - 扫描工单二维码（自动识别工单信息）
   - 系统自动填充工单信息（大字体显示）
   - **SOP查看**：点击"SOP查看"大按钮，全屏显示SOP步骤
   - **图纸查看**：点击"图纸查看"大按钮，全屏显示图纸
   - **加工程序查看**：点击"加工程序查看"大按钮，全屏显示加工程序
4. **报工模式选择（核心功能，根据工序类型自动判断）**：
   - **模式1：按数量报工**（工序类型：按数量报工）
     - 系统自动判断：如果工序类型为"按数量报工"，自动使用按数量报工模式
     - **触屏优化输入界面**：
       - 完成数量：90个（大数字键盘输入，触屏优化）
       - 合格数量：88个（大数字键盘输入，触屏优化）
       - 工时：8小时（可选，大数字键盘输入）
       - 备注：文本输入"正常完成"（大文本输入框，触屏优化，可选）
     - **工站上下料物料绑定**（核心功能，新增）：
       - **上料绑定**：
         - 点击"上料绑定"大按钮（全屏显示）
         - **方式1：扫码绑定上料（推荐，最快）**：
           - 扫描物料二维码/一维码（自动识别物料信息）
           - 系统自动填充：物料编码、物料名称、批次号、序列号
           - 输入上料数量：100kg（大数字键盘输入，触屏优化）
           - 选择库位：A-01-001（可选，支持搜索）
           - 点击"确认上料"大按钮
           - **完成，<30秒**
         - **方式2：手动选择上料**：
           - 选择物料、批次号、序列号
           - 输入上料数量
           - 选择库位
           - 点击"确认上料"大按钮
       - **下料绑定**：
         - 点击"下料绑定"大按钮（全屏显示）
         - **方式1：扫码绑定下料（推荐，最快）**：
           - 扫描物料二维码/一维码（自动识别物料信息）
           - 系统自动填充：物料编码、物料名称、批次号、序列号
           - 输入下料数量：90个（大数字键盘输入，触屏优化）
           - 选择库位：B-01-001（可选，支持搜索）
           - 点击"确认下料"大按钮
           - **完成，<30秒**
         - **方式2：手动选择下料**：
           - 选择物料、批次号、序列号
           - 输入下料数量
           - 选择库位
           - 点击"确认下料"大按钮
       - **上料下料记录查看**：
         - 在报工界面显示已绑定的上料和下料记录
         - 支持删除上料/下料记录（如果未提交报工）
         - 支持修改上料/下料数量（如果未提交报工）
     - **如果是带参数SOP，自动显示参数收集表单**：
       - **SOP指定参数**（大表单输入，触屏优化）：
         - 扭矩：25N·m（大数字键盘输入，范围：20-30）
         - 外观检查：是大按钮/否大按钮（触屏选择，易于点击）
         - 其他参数...（根据SOP配置动态显示，触屏优化）
     - 点击"提交"大按钮（全屏底部固定，易于点击）
     - **提交后，系统自动**：
       - 保存报工数据（包含参数数据）
       - 保存上料下料绑定记录（关联到报工记录）
       - 自动更新上料物料库存（扣减上料物料库存）
       - 自动更新下料物料库存（增加下料物料库存）
       - 更新工单进度
       - **自动切换到下一工序**（如果还有未完成工序）
     - **完成，<30秒（无参数）或<1分钟（有参数）或<2分钟（有上料下料绑定）**
   - **模式2：按状态报工**（工序类型：按状态报工）
     - 系统自动判断：如果工序类型为"按状态报工"，自动使用按状态报工模式
     - **触屏优化输入界面**：
       - 完成状态：完成大按钮/未完成大按钮（触屏选择，易于点击）
       - 工时：8小时（可选，大数字键盘输入）
       - 备注：文本输入"检验通过"（大文本输入框，触屏优化，可选）
     - **如果是带参数SOP，自动显示参数收集表单**：
       - **SOP指定参数**（大表单输入，触屏优化）：
         - 检验结果：合格大按钮/不合格大按钮（触屏选择，易于点击）
         - 检验员：张三（大文本输入框，触屏优化）
         - 其他参数...（根据SOP配置动态显示，触屏优化）
     - 点击"提交"大按钮
     - **完成，<30秒（无参数）或<1分钟（有参数）**
5. **工序跳转规则校验**（核心功能，新增）：
   - 系统自动检查：当前工序是否允许报工（基于跳转规则）
   - **不允许跳转**：如果上道工序未完成，系统提示"请先完成上道工序"
   - **允许跳转**：可以随时报工，不依赖上道工序完成
   - 报工成功后，系统自动更新工序状态
6. **提交后，系统自动**：
   - 保存报工数据（包含参数数据）
   - 更新工单进度
   - **自动切换到下一工序**（如果还有未完成工序）
   - 显示"报工成功"大提示（触屏优化，3秒后自动关闭）

**方式B：移动端模式（推荐，移动工位）**

1. 打开移动端报工界面（首页快捷入口）
2. **方式1：扫码报工（最快，推荐）**
   - 扫描工单二维码（自动识别工单信息）
   - 系统自动填充：工单号、产品、当前工序、计划数量
   - **如果是带SOP工艺路线，自动显示SOP**
3. **报工模式选择（与工位机模式相同）**：
   - 按数量报工/按状态报工（根据工序类型自动判断）
   - 工站上下料物料绑定
   - 带参数报工（带参数SOP）
4. **工序跳转规则校验**（核心功能，新增）
5. **提交后，系统自动**：
   - 保存报工数据（包含参数数据）
   - 更新工单进度
   - **自动切换到下一工序**（如果还有未完成工序）

**方式C：PC端模式**

1. 进入"快智造" → "生产执行" → "报工管理" → "新建报工"
2. 手动输入工单号（支持拼音搜索）
3. 系统自动填充工单信息
4. 输入完成数量和合格数量
5. 提交报工

#### 2.1.2 生产管理员操作（PC端）

1. 进入"快智造" → "生产执行" → "报工管理" → "报工记录查询"
2. 查看报工记录（使用高级搜索，支持拼音搜索）
3. 查看工单进度（自动更新）

**系统行为（优化后）：**
- ✅ **扫码报工**：扫描二维码后，自动识别工单信息并填充（核心优化）
- ✅ **智能默认值**：自动填充工单号、产品、工序、计划数量（核心优化）
- ✅ **工序类型自动判断**（核心功能，新增）：
  - **按数量报工**：工序类型为"按数量报工"时，显示数量输入框（完成数量、合格数量）
  - **按状态报工**：工序类型为"按状态报工"时，显示状态选择框（完成/未完成）
  - 系统根据工序类型自动显示对应的报工界面
- ✅ **工序跳转规则校验**（核心功能，新增）：
  - 报工前自动检查：当前工序是否允许报工（基于跳转规则）
  - **不允许跳转**：如果上道工序未完成，系统阻止报工并提示"请先完成上道工序"
  - **允许跳转**：可以随时报工，不依赖上道工序完成
  - 报工成功后，系统自动更新工序状态
- ✅ **按数量报工模式**：工序类型为"按数量报工"时，只需输入完成数量和合格数量（核心功能，新增）
- ✅ **按状态报工模式**：工序类型为"按状态报工"时，只需选择完成状态（核心功能，新增）
- ✅ **带参数报工模式**：带参数SOP，自动显示参数收集表单（核心功能，新增）
  - 根据SOP的form_config自动生成参数表单
  - 支持数字、文本、选择、日期等参数类型
  - 支持参数验证（必填、范围、格式等）
  - 参数数据自动保存到报工记录
- ✅ **工站上下料物料绑定**（核心功能，新增）：
  - **上料绑定**：
    - 支持扫码绑定上料（扫描物料二维码/一维码，自动识别物料信息）
    - 支持手动选择上料（选择物料、批次号、序列号）
    - 自动识别物料信息（物料编码、物料名称、批次号、序列号）
    - 自动填充上料信息（基于扫码结果）
    - 记录上料绑定记录（关联到报工记录）
    - 自动更新上料物料库存（扣减上料物料库存）
  - **下料绑定**：
    - 支持扫码绑定下料（扫描物料二维码/一维码，自动识别物料信息）
    - 支持手动选择下料（选择物料、批次号、序列号）
    - 自动识别物料信息（物料编码、物料名称、批次号、序列号）
    - 自动填充下料信息（基于扫码结果）
    - 记录下料绑定记录（关联到报工记录）
    - 自动更新下料物料库存（增加下料物料库存）
  - **上料下料记录管理**：
    - 支持查看已绑定的上料和下料记录
    - 支持删除上料/下料记录（如果未提交报工）
    - 支持修改上料/下料数量（如果未提交报工）
    - 支持上料下料记录查询（高级搜索，拼音搜索）
    - 支持上料下料记录导出（Excel）
- ✅ **工位机触屏模式**（核心功能，新增）
  - **自动识别终端类型**：检测到工位机设备，自动切换到触屏模式
  - **触屏优化界面**：
    - 大按钮设计（按钮高度≥60px，适合手指点击）
    - 大字体显示（字体大小≥24px，清晰易读）
    - 全屏模式（无浏览器地址栏，沉浸式体验）
    - 触屏优化布局（元素间距≥20px，避免误触）
  - **SOP查看优化**：
    - 全屏显示SOP内容（触屏优化）
    - 支持触屏滑动查看SOP步骤
    - 支持触屏缩放查看SOP图片
    - 支持触屏翻页（左右滑动）
  - **图纸查看优化**：
    - 全屏显示图纸（触屏优化）
    - 支持触屏缩放（双指捏合）
    - 支持触屏拖拽（单指移动）
    - 支持触屏旋转（横屏/竖屏自动适配）
    - 支持图纸标注（触屏画笔功能）
  - **加工程序查看优化**：
    - 全屏显示加工程序（触屏优化）
    - 支持触屏滚动查看程序代码
    - 支持触屏搜索程序内容（大键盘输入）
    - 支持程序高亮显示（语法高亮）
    - 支持程序行号显示
  - **触屏输入优化**：
    - 大数字键盘（触屏优化，易于输入）
    - 大文本输入框（触屏优化，易于输入，备注输入）
    - 大选择按钮（触屏优化，易于选择）
- ✅ **文本输入优化**：大文本输入框输入备注，触屏优化，易于输入（核心优化）
- ✅ **自动计算**：工时可选，系统可基于历史数据自动计算
- ✅ **自动切换工序**：报工完成后，自动切换到下一工序（核心优化）
- ✅ 记录报工数据（包含参数数据）
- ✅ 自动更新工单进度
- ✅ 自动判断工单完工（所有工序完成）
- ✅ 触发报工数据处理工作流（Inngest）
- ✅ 触发工单进度更新工作流（Inngest）
- ✅ 高级搜索（拼音搜索）
- ✅ 批量导入报工记录（universheet在线表格，实时保存）
- 🤖 **AI智能建议**（通过Inngest AI工作流）：
  - **异常检测**：自动检测报工数据异常（不良率异常、工时异常、进度异常、参数异常）
  - **参数分析**：分析参数数据，检测异常参数值（如：温度超出范围）
  - **质量预警**：不良率超过阈值时，自动预警并建议质量改进措施
  - **效率分析**：基于历史数据，分析报工效率，建议优化措施
  - **交期预警**：进度滞后时，自动预警交期风险，建议加快进度措施

**验收标准：**
- ✅ **工位机触屏模式正常**（自动识别终端类型，切换到触屏模式）
- ✅ **触屏界面优化正常**（大按钮、大字体、全屏模式、触屏优化布局）
- ✅ **SOP查看优化正常**（全屏显示、触屏滑动、触屏缩放）
- ✅ **图纸查看优化正常**（全屏显示、触屏缩放、触屏拖拽、触屏旋转、图纸标注）
- ✅ **加工程序查看优化正常**（全屏显示、触屏滚动、触屏搜索、语法高亮）
- ✅ **触屏输入优化正常**（大数字键盘、大文本输入框、大选择按钮）
- ✅ **扫码报工正常**（扫描后自动填充，核心功能）
- ✅ **工序类型自动判断正常**（核心功能，新增）：
  - ✅ 按数量报工界面正常（显示数量输入框）
  - ✅ 按状态报工界面正常（显示状态选择框）
- ✅ **工序跳转规则校验正常**（核心功能，新增）：
  - ✅ 不允许跳转规则生效（必须完成上道工序才能报工）
  - ✅ 允许跳转规则生效（可以随时报工）
  - ✅ 系统自动阻止不符合规则的报工
- ✅ **按数量报工正常**（工序类型：按数量报工，<30秒完成）
- ✅ **按状态报工正常**（工序类型：按状态报工，<30秒完成）
- ✅ **带参数报工正常**（带参数SOP，自动显示参数表单，<1分钟完成）
- ✅ **工站上下料物料绑定正常**（核心功能，新增）：
  - ✅ 上料绑定正常（扫码绑定和手动选择）
  - ✅ 下料绑定正常（扫码绑定和手动选择）
  - ✅ 上料下料记录保存正常（关联到报工记录）
  - ✅ 上料物料库存更新正常（扣减库存）
  - ✅ 下料物料库存更新正常（增加库存）
  - ✅ 上料下料记录查询正常（高级搜索，拼音搜索）
  - ✅ 上料下料记录导出正常（Excel）
- ✅ **智能默认值正常**（自动填充工单信息）
- ✅ **参数收集正常**（根据SOP配置自动显示参数表单）
- ✅ **参数验证正常**（必填、范围、格式等验证）
- ✅ **文本输入优化正常**（大文本输入框，触屏优化）
- ✅ **自动切换工序正常**（报工完成后自动切换）
- ✅ 报工功能正常（移动端和工位机触屏优化）
- ✅ 工单进度自动更新正常
- ✅ 工单完工自动判断正常
- ✅ 报工记录高级搜索可用（拼音搜索）
- ✅ 报工记录批量导入可用（universheet在线表格导入，实时保存）
- ✅ AI建议正常显示（异常时弹窗预警，正常时侧边栏显示效率分析）

**优化效果：**
- ⚡ **操作步骤减少**：
  - 快速报工：从7步减少到3步（扫码→输入数量→提交）
  - 带参数报工：从10步减少到4步（扫码→填写参数→提交）
- ⚡ **时间缩短**：
  - 快速报工：从3分钟减少到<30秒
  - 带参数报工：从5分钟减少到<1分钟
- ⚡ **输入减少**：
  - 快速报工：从7个字段减少到2个字段（完成数量、合格数量）
  - 带参数报工：参数自动显示，无需手动配置
- ⚡ **多终端支持**：支持移动端和工位机触屏模式，适应不同使用场景
- ⚡ **触屏优化**：工位机触屏模式，大按钮、大字体、全屏模式，易于操作
- ⚡ **数据质量提升**：带参数报工，确保关键参数数据收集完整

---

### 2.2 报工数据修正（核心功能，新增）

**应用场景：**
- 报工数据录入错误，需要修正
- 报工数据需要审批后才能修正
- 支持报工数据修正记录的追溯和统计

**用户操作：**

1. **申请报工数据修正（方式1：报工人申请）**
   - 进入"快智造" → "生产执行" → "报工管理" → "报工记录查询"
   - 选择报工记录：报工-20260115-001
   - 点击"申请修正"按钮
   - **填写修正申请信息**：
     - 修正类型：数量修正/时间修正/参数修正/其他（选择：数量修正）
     - 原数据：完成数量90个，合格数量88个（自动填充）
     - 修正后数据：完成数量95个，合格数量93个（用户输入）
     - 修正原因：实际完成数量为95个，之前录入错误（大文本输入框，用户输入）
     - 修正说明：详细说明修正原因（大文本输入框，用户输入）
   - 提交修正申请
   - **系统自动处理**：
     - 自动创建报工数据修正申请单
     - 自动发送修正申请到审批流程（部门经理审批）
     - 自动更新报工记录状态：修正申请中

2. **审批报工数据修正申请**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "报工管理" → "报工修正审批"
   - 选择修正申请单：修正-20260115-001
   - 查看修正申请详情
   - **审批修正申请**：
     - 审批结果：同意/不同意（选择：同意）
     - 审批意见：同意修正（大文本输入框，可选）
   - 提交审批结果
   - **系统自动处理**：
     - 审批同意：自动更新报工记录（完成数量、合格数量）
     - 自动更新工单进度（基于修正后的数量）
     - 自动更新库存（如果已入库，需要调整库存）
     - 自动更新报工记录状态：已修正
     - 自动记录修正历史（原数据、修正后数据、修正时间、修正人）

3. **报工数据修正（方式2：管理员直接修正）**
   - 进入"快智造" → "生产执行" → "报工管理" → "报工记录查询"
   - 选择报工记录：报工-20260115-001
   - 点击"直接修正"按钮（需要管理员权限）
   - **填写修正信息**：
     - 修正类型：数量修正
     - 原数据：完成数量90个，合格数量88个（自动填充）
     - 修正后数据：完成数量95个，合格数量93个（用户输入）
     - 修正原因：实际完成数量为95个，之前录入错误（大文本输入框）
   - 确认修正
   - **系统自动处理**：
     - 自动更新报工记录（完成数量、合格数量）
     - 自动更新工单进度（基于修正后的数量）
     - 自动更新库存（如果已入库，需要调整库存）
     - 自动记录修正历史（原数据、修正后数据、修正时间、修正人）

4. **报工数据修正记录追溯**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "报工管理" → "报工修正记录"
   - 选择报工记录：报工-20260115-001
   - **查看修正历史**：
     - 修正记录1：2026-01-15 10:00，完成数量从90个修正为95个，修正人：张三，审批人：李四
     - 修正记录2：2026-01-15 14:00，合格数量从88个修正为93个，修正人：张三，审批人：李四
   - 支持查看修正详情（原数据、修正后数据、修正原因、审批意见）

**系统行为：**
- ✅ **报工数据修正申请**：
  - 支持报工人申请修正（需要审批）
  - 支持管理员直接修正（无需审批）
  - 自动创建修正申请单
  - 自动发送修正申请到审批流程
- ✅ **报工数据修正审批**（核心功能，新增）：
  - 支持修正申请审批（同意/不同意）
  - 审批同意后，自动更新报工记录
  - 自动更新工单进度和库存
- ✅ **报工数据修正**：
  - 支持数量修正、时间修正、参数修正
  - 自动更新报工记录、工单进度、库存
  - 自动记录修正历史
- ✅ **报工数据修正记录追溯**（核心功能，新增）：
  - 支持查看修正历史（原数据、修正后数据、修正时间、修正人）
  - 支持查看修正详情（修正原因、审批意见）
- 🤖 **AI智能建议**：
  - 基于历史数据，识别异常报工数据
  - 分析修正原因，建议预防措施
  - 识别频繁修正的报工记录，建议重点关注

**验收标准：**
- ✅ 报工数据修正申请成功（报工人申请和管理员直接修正）
- ✅ 报工数据修正审批正常（审批流程、审批结果处理）
- ✅ 报工数据修正正常（更新报工记录、工单进度、库存）
- ✅ 报工数据修正记录追溯正常（查看修正历史、修正详情）

---

### 2.3 报工统计分析（核心功能，新增）

**应用场景：**
- 需要统计和分析报工数据，了解生产效率
- 需要识别报工异常，提出改进措施
- 需要生成报工统计报表，支持决策

**用户操作：**

1. **报工效率统计**
   - 进入"快智造" → "生产执行" → "报工管理" → "报工统计"
   - 查看报工效率统计报表：
     - 按工单统计：工单-20260105-001，计划数量100个，完成数量95个，完成率95%
     - 按工序统计：注塑工序平均完成率98%，组装工序平均完成率95%
     - 按人员统计：张三平均完成率96%，李四平均完成率94%
     - 按时间段统计：1月份平均完成率95%，2月份平均完成率97%
   - 查看报工效率趋势图（按时间段）
   - 导出报工效率统计报表（Excel）

2. **报工工时统计**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "报工管理" → "报工统计" → "工时统计"
   - 查看报工工时统计报表：
     - 按工单统计：工单-20260105-001，计划工时10小时，实际工时9.5小时，效率105%
     - 按工序统计：注塑工序平均效率102%，组装工序平均效率98%
     - 按人员统计：张三平均效率100%，李四平均效率98%
     - 按时间段统计：1月份平均效率99%，2月份平均效率101%
   - 查看报工工时趋势图（按时间段）
   - 导出报工工时统计报表（Excel）

3. **报工质量统计**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "报工管理" → "报工统计" → "质量统计"
   - 查看报工质量统计报表：
     - 按工单统计：工单-20260105-001，完成数量95个，合格数量93个，合格率97.9%
     - 按工序统计：注塑工序平均合格率98%，组装工序平均合格率97%
     - 按人员统计：张三平均合格率98%，李四平均合格率96%
     - 按时间段统计：1月份平均合格率97%，2月份平均合格率98%
   - 查看报工质量趋势图（按时间段）
   - 导出报工质量统计报表（Excel）

4. **报工异常统计分析**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "报工管理" → "报工统计" → "异常统计"
   - 查看报工异常统计报表：
     - **异常类型统计**：
       - 不良率异常：10次（不良率超过阈值）
       - 工时异常：5次（实际工时超过计划工时20%）
       - 进度异常：3次（完成进度滞后）
       - 参数异常：2次（报工参数超出范围）
     - **异常原因分析**：
       - 设备故障：40%
       - 操作不当：30%
       - 物料问题：20%
       - 其他：10%
     - **异常趋势分析**：
       - 1月份异常次数：15次
       - 2月份异常次数：10次
       - 异常次数呈下降趋势
   - 导出报工异常统计报表（Excel）

5. **报工绩效分析**（核心功能，新增）
   - 进入"快智造" → "生产执行" → "报工管理" → "报工统计" → "绩效分析"
   - 查看报工绩效分析报表：
     - **人员绩效排名**：
       - 第1名：张三，完成率96%，合格率98%，效率100%
       - 第2名：李四，完成率94%，合格率96%，效率98%
       - 第3名：王五，完成率92%，合格率95%，效率96%
     - **工序绩效排名**：
       - 第1名：注塑工序，完成率98%，合格率98%，效率102%
       - 第2名：组装工序，完成率95%，合格率97%，效率98%
       - 第3名：包装工序，完成率93%，合格率96%，效率97%
     - **工单绩效排名**：
       - 第1名：工单-20260105-001，完成率95%，合格率97.9%，效率105%
       - 第2名：工单-20260106-001，完成率94%，合格率97%，效率103%
   - 导出报工绩效分析报表（Excel）

**系统行为：**
- ✅ **报工效率统计**：
  - 自动统计报工完成率（按工单、工序、人员、时间段）
  - 自动生成报工效率趋势图
  - 支持导出报工效率统计报表（Excel）
- ✅ **报工工时统计**（核心功能，新增）：
  - 自动统计报工工时（计划工时、实际工时、效率）
  - 自动生成报工工时趋势图
  - 支持导出报工工时统计报表（Excel）
- ✅ **报工质量统计**（核心功能，新增）：
  - 自动统计报工合格率（按工单、工序、人员、时间段）
  - 自动生成报工质量趋势图
  - 支持导出报工质量统计报表（Excel）
- ✅ **报工异常统计分析**（核心功能，新增）：
  - 自动识别报工异常（不良率异常、工时异常、进度异常、参数异常）
  - 自动分析异常原因（设备故障、操作不当、物料问题等）
  - 自动生成异常趋势分析
  - 支持导出报工异常统计报表（Excel）
- ✅ **报工绩效分析**（核心功能，新增）：
  - 自动统计人员绩效排名（完成率、合格率、效率）
  - 自动统计工序绩效排名
  - 自动统计工单绩效排名
  - 支持导出报工绩效分析报表（Excel）
- 🤖 **AI智能建议**：
  - 基于历史数据，预测报工效率趋势
  - 分析报工异常原因，建议改进措施
  - 识别报工绩效瓶颈，建议优化方案

**验收标准：**
- ✅ 报工效率统计正常（按工单、工序、人员、时间段统计）
- ✅ 报工工时统计正常（计划工时、实际工时、效率）
- ✅ 报工质量统计正常（合格率统计）
- ✅ 报工异常统计分析正常（异常类型、异常原因、异常趋势）
- ✅ 报工绩效分析正常（人员绩效、工序绩效、工单绩效）

**开发状态：** ✅ 已完成

---

## 3. 工艺路线与工序配置（与工单和报工紧密相关）

### 3.1 工序类型和跳转规则

> **详细内容请参考《用户使用场景推演-MTS-MTO.md》第2.4.1章节**

**核心功能：**
- ✅ **按数量报工**：需要输入完成数量、合格数量（如：注塑、组装、包装）
- ✅ **按状态报工**：只有完成/未完成状态，无数量概念（如：检验、测试、审批）
- ✅ **工序跳转规则**：
  - **不允许跳转**：必须等待上道工序完成才能报工
  - **允许跳转**：可以随时报工（不依赖上道工序）
- ✅ 报工时根据工序类型自动显示对应的报工界面
- ✅ 工单执行时，系统自动校验工序跳转规则

**与工单和报工的关联：**
- 工单创建时，自动根据工艺路线生成工序单
- 报工时，系统根据工序类型自动判断报工模式（按数量报工/按状态报工）
- 报工时，系统自动校验工序跳转规则，阻止不符合规则的报工

---

### 3.2 工艺路线绑定物料或物料分组

> **详细内容请参考《用户使用场景推演-MTS-MTO.md》第2.4.2章节**

**核心功能：**
- ✅ **工艺路线绑定物料分组或物料**（核心功能，新增，参考黑湖小工单）：
  - 工艺路线可以绑定到物料分组或单个物料
  - 物料分组绑定：适用于同一分组的所有物料（如：所有注塑件使用同一工艺路线）
  - 物料绑定：适用于单个物料（如：特殊产品使用专用工艺路线）
- ✅ **优先级规则**（核心功能，参考黑湖小工单）：
  - 物料绑定 > 物料分组绑定
  - 如果物料有单独绑定的工艺路线，优先使用物料绑定的工艺路线
  - 如果物料没有单独绑定，但所属分组绑定了工艺路线，使用分组绑定的工艺路线
- ✅ **创建工单时自动匹配**：新建工单选择物料后，系统自动按优先级匹配工艺路线（物料绑定 → 物料分组绑定）

**与工单和报工的关联：**
- 工单创建时，系统自动匹配工艺路线（物料绑定 → 物料分组绑定）
- 自动匹配成功后，自动生成工单工序单
- 报工时，使用工单工序单中的工序信息

---

### 3.3 SOP参数收集配置

> **详细内容请参考《用户使用场景推演-MTS-MTO.md》第2.4节**

**核心功能：**
- ✅ **SOP参数收集配置**：SOP设计时可指定报工时需要收集的参数（核心功能，新增）
  - 支持数字、文本、选择、日期等参数类型
  - 支持参数验证（必填、范围、格式等）
  - 参数数据自动保存到报工记录
- ✅ 报工时，如果工序关联了带参数的SOP，自动显示参数收集表单

**与工单和报工的关联：**
- 工单创建时，如果工艺路线中的工序关联了SOP，自动关联到工单工序单
- 报工时，如果工单工序单关联了带参数的SOP，自动显示参数收集表单
- 参数数据自动保存到报工记录

---

## 4. 工单与报工数据关联

### 4.1 单据关联展示

**核心功能：**
- ✅ **单据上下游信息展示**：在工单和报工记录详情页面展示上下游关联单据信息
- ✅ **单据关联追溯**：支持查看完整的单据关联链条

**工单关联关系：**
- **上游单据**：销售预测、MRP运算、销售订单
- **下游单据**：生产领料出库单、报工记录、成品入库单、销售出库单

**报工记录关联关系：**
- **上游单据**：工单
- **下游单据**：成品入库单

### 4.2 单据下推功能

**核心功能：**
- ✅ **从工单下推到生产领料出库单**（一键下推）
- ✅ **从工单下推到报工记录**（移动端/工位机，扫码报工功能）
- ✅ **从工单下推到成品入库单**（一键下推）
- ✅ 自动传递工单信息到下游单据

### 4.3 单据上拉功能

**核心功能：**
- ✅ **从工单上拉到销售预测/销售订单**（手动关联）
- ✅ **从报工记录上拉到工单**（手动关联或智能关联）
- ✅ AI辅助智能上拉关联（自动推荐匹配的工单）

---

## 5. 总结与优化建议

### 5.1 核心价值

1. **工单管理**：
   - ✅ 根据工艺路线自动生成工序单，减少手动操作
   - ✅ 支持返工单、工单拆分、工序修改、工单冻结等高级功能
   - ✅ 支持工单优先级管理和紧急插单
   - ✅ 支持工单合并，提高生产效率

2. **报工管理**：
   - ✅ 扫码报工，自动填充信息，减少输入
   - ✅ 根据工序类型自动判断报工模式（按数量报工/按状态报工）
   - ✅ 支持工站上下料物料绑定
   - ✅ 支持带参数报工，确保关键参数数据收集完整
   - ✅ 支持工位机触屏模式，适应车间固定工位场景
   - ✅ 支持报工数据修正和统计分析

3. **工艺路线与工序**：
   - ✅ 工序类型支持（按数量报工/按状态报工）
   - ✅ 工序跳转规则校验
   - ✅ 工艺路线绑定物料或物料分组，自动匹配
   - ✅ SOP参数收集配置

### 5.2 优化效果

- ⚡ **操作步骤减少**：
  - 工单创建：从10分钟减少到<2分钟（自动生成工序）
  - 快速报工：从7步减少到3步（扫码→输入数量→提交）
  - 带参数报工：从10步减少到4步（扫码→填写参数→提交）
- ⚡ **时间缩短**：
  - 工单创建：从10分钟减少到<2分钟
  - 快速报工：从3分钟减少到<30秒
  - 带参数报工：从5分钟减少到<1分钟
- ⚡ **输入减少**：
  - 快速报工：从7个字段减少到2个字段（完成数量、合格数量）
  - 带参数报工：参数自动显示，无需手动配置
- ⚡ **多终端支持**：支持移动端和工位机触屏模式，适应不同使用场景
- ⚡ **数据质量提升**：带参数报工，确保关键参数数据收集完整

### 5.3 下一步优化方向

1. **工单管理**：
   - ⏳ 工单批量操作优化（批量下达、批量修改等）
   - ⏳ 工单排产可视化（甘特图）
   - ⏳ 工单成本核算

2. **报工管理**：
   - ⏳ 报工数据实时分析（实时看板）
   - ⏳ 报工异常自动预警
   - ⏳ 报工绩效自动评价

3. **工艺路线**：
   - ⏳ 工艺路线版本管理
   - ⏳ 工艺路线变更管理
   - ⏳ 工艺路线优化建议（AI）

---

**文档版本：** v1.0  
**最后更新：** 2026-01-26  
**维护人：** Luigi Lu

