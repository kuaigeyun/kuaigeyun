# 统一业务流程主线设计说明

## 📋 设计理念

### 核心原则

**弱化强制割裂，统一业务流程主线**

系统采用一条统一的业务流程主线，通过需求来源和关联关系自然区分MTS/MTO模式，而非强制割裂为两套独立的业务流程。

### 设计要点

1. **统一需求管理**
   - 销售预测（MTS模式需求）和销售订单（MTO模式需求）都作为"需求"统一管理
   - 通过需求类型区分，而非分别处理
   - 系统自动识别需求类型，无需用户手动选择MTS/MTO模式

2. **统一物料需求运算**
   - 将MRP和LRP合并为统一的"物料需求运算"
   - 系统根据需求类型自动识别业务模式（销售预测→MTS，销售订单→MTO）
   - 通过参数配置实现不同业务场景的需求，而非强制分离运算逻辑

3. **统一工单处理**
   - 工单创建流程统一，通过关联的需求类型自然区分MTS/MTO模式
   - 移除`production_mode`字段，不再需要手动标记MTS/MTO模式
   - 系统根据关联关系自动识别业务模式（关联销售预测→MTS，关联销售订单→MTO）

4. **统一业务流程**
   - 后续业务流程（生产领料、报工、成品入库、销售出库）统一处理
   - 通过关联关系自然区分MTS/MTO模式
   - MTO模式仅在库存管理上有特殊处理（订单专属库存）

## 🔄 业务流程对比

### 原设计（强制割裂）

```
MTS模式：
销售预测 → MRP运算 → 工单（标记MTS） → 生产执行 → 销售出库

MTO模式：
销售订单 → LRP运算 → 工单（标记MTO） → 生产执行 → 销售出库
```

**问题：**
- 两套独立的业务流程
- 需要维护两套运算逻辑（MRP和LRP）
- 工单需要手动标记MTS/MTO模式
- 用户需要选择不同的入口和流程

### 新设计（统一主线）

```
统一流程：
需求（销售预测/销售订单） → 物料需求运算 → 工单（自动识别模式） → 生产执行 → 销售出库
```

**优势：**
- 一条统一的业务流程主线
- 统一的运算逻辑，通过参数配置实现不同场景
- 系统自动识别业务模式，无需手动标记
- 用户使用统一的入口和流程

## 📊 业务模式区分机制

### 自动识别规则

1. **需求类型识别**
   - 销售预测 → MTS模式（按库存生产）
   - 销售订单 → MTO模式（按订单生产）

2. **关联关系追溯**
   - 工单关联销售预测 → MTS模式
   - 工单关联销售订单 → MTO模式
   - 系统根据关联关系自动识别，无需手动标记

3. **参数配置差异**
   - MTS模式：考虑安全库存、库存周转等参数
   - MTO模式：考虑订单交期、订单专属库存等参数
   - 系统根据需求类型自动推荐参数配置

### 特殊处理

**MTO模式特殊处理：**
- 订单专属库存管理（生产领料和成品入库时自动标记）
- 订单交期考虑（物料需求运算时考虑订单交期）
- 订单关联追溯（销售出库时关联销售订单）

**MTS模式特殊处理：**
- 安全库存考虑（物料需求运算时考虑安全库存）
- 库存周转考虑（物料需求运算时考虑库存周转）
- 销售预测关联（销售出库时关联销售预测）

## 🎯 实现要点

### 数据模型调整

1. **需求模型统一**
   - 销售预测和销售订单都作为"需求"统一管理
   - 通过`demand_type`字段区分（`sales_forecast`/`sales_order`）

2. **工单模型简化**
   - 移除`production_mode`字段
   - 通过关联关系（`sales_forecast_id`/`sales_order_id`）自然区分模式
   - 系统根据关联关系自动识别业务模式

3. **物料需求运算统一**
   - 统一的运算逻辑，支持多种需求来源
   - 通过参数配置实现不同业务场景
   - 系统根据需求类型自动推荐参数配置

### 业务流程调整

1. **需求管理统一**
   - 统一的入口和界面
   - 支持创建销售预测和销售订单
   - 系统自动识别需求类型

2. **物料需求运算统一**
   - 统一的入口和界面
   - 支持从销售预测或销售订单下推
   - 系统根据需求类型自动识别业务模式

3. **工单处理统一**
   - 统一的创建流程
   - 通过关联关系自然区分模式
   - 系统自动识别业务模式

4. **后续流程统一**
   - 生产领料、报工、成品入库、销售出库统一处理
   - 通过关联关系自然区分模式
   - MTO模式仅在库存管理上有特殊处理

## ✅ 优势总结

1. **简化用户操作**
   - 统一的入口和流程，减少学习成本
   - 系统自动识别模式，无需手动选择
   - 减少操作步骤，提高效率

2. **降低维护成本**
   - 统一的运算逻辑，减少代码重复
   - 统一的业务流程，减少维护工作量
   - 统一的测试用例，提高测试效率

3. **提高系统灵活性**
   - 通过参数配置实现不同业务场景
   - 支持混合模式（同一企业同时使用MTS和MTO）
   - 易于扩展新的需求类型

4. **保证功能完整性**
   - 所有MTS和MTO功能都能实现
   - 通过关联关系和参数配置实现差异化
   - 不影响现有功能的完整性

## 📝 实施建议

1. **数据迁移**
   - 将现有的`production_mode`字段数据迁移到关联关系
   - 建立需求与工单的关联关系
   - 验证数据完整性

2. **功能开发**
   - 统一需求管理功能
   - 统一物料需求运算功能
   - 统一工单处理功能
   - 实现自动识别机制

3. **测试验证**
   - 验证MTS模式功能完整性
   - 验证MTO模式功能完整性
   - 验证混合模式场景
   - 验证自动识别机制

4. **用户培训**
   - 更新用户手册
   - 更新操作指南
   - 培训用户使用统一流程

---

**最后更新：** 2026-01-13  
**设计者：** AI Assistant  
**审核状态：** 待审核
