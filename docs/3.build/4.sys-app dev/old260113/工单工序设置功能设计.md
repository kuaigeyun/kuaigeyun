# 工单工序设置功能设计

> 本文档描述在创建工单时，允许设置工单的加工工序的功能设计。

**创建日期**：2026-01-08  
**设计阶段**：功能设计阶段

---

## 目录

1. [功能概述](#1-功能概述)
2. [功能需求](#2-功能需求)
3. [数据模型设计](#3-数据模型设计)
4. [API接口设计](#4-api接口设计)
5. [业务流程设计](#5-业务流程设计)
6. [前端交互设计](#6-前端交互设计)
7. [实现方案](#7-实现方案)
8. [验收标准](#8-验收标准)

---

## 1. 功能概述

### 1.1 功能目标

在创建工单时，允许用户灵活设置工单的加工工序，支持以下方式：

1. **自动获取**：从物料组/物料/BOM绑定的工艺路线中自动获取工序
2. **手工挑选**：用户手动选择工序并设置顺序
3. **混合模式**：在自动获取的基础上，允许用户调整、添加或删除工序

### 1.2 核心价值

- **灵活性**：支持不同场景下的工序设置需求
- **便捷性**：自动获取减少手工操作，提高效率
- **可控性**：允许手工调整，满足特殊需求
- **一致性**：基于工艺路线，保证工序设置的规范性

---

## 2. 功能需求

### 2.1 工序来源

#### 2.1.1 从物料组绑定的工艺路线获取

**优先级**：物料绑定 > 物料分组绑定 > BOM绑定

**匹配规则**：
1. 查找物料所属的物料分组
2. 查找物料分组绑定的工艺路线
3. 从工艺路线中提取工序序列

**使用场景**：
- 同一物料分组下的物料使用相同的工艺路线
- 批量创建工单时，自动应用分组工艺路线

#### 2.1.2 从物料绑定的工艺路线获取

**优先级**：最高（物料绑定 > 物料分组绑定）

**匹配规则**：
1. 查找物料直接绑定的工艺路线
2. 如果物料绑定了工艺路线，优先使用物料绑定的工艺路线
3. 从工艺路线中提取工序序列

**使用场景**：
- 特定物料有专用工艺路线
- 需要精确控制特定物料的加工工序

#### 2.1.3 从BOM绑定的工艺路线获取

**优先级**：最低（物料绑定 > 物料分组绑定 > BOM绑定）

**匹配规则**：
1. 查找物料关联的BOM
2. 查找BOM绑定的工艺路线
3. 从工艺路线中提取工序序列

**使用场景**：
- BOM级别的工艺路线配置
- 基于BOM结构的工序设置

#### 2.1.4 手工挑选工序

**功能**：
- 用户手动选择工序
- 设置工序顺序
- 设置工序参数（标准工时、准备时间、报工类型、跳转规则等）

**使用场景**：
- 临时工单，不需要标准工艺路线
- 特殊需求，需要自定义工序
- 在自动获取的基础上进行调整

### 2.2 工序设置方式

#### 2.2.1 自动模式（推荐）

**流程**：
1. 选择物料后，系统自动匹配工艺路线
2. 自动提取工序序列
3. 自动生成工单工序单
4. 用户可预览和调整

**优点**：
- 操作简单，减少手工操作
- 基于标准工艺路线，保证规范性
- 减少错误

#### 2.2.2 手工模式

**流程**：
1. 用户手动选择工序
2. 设置工序顺序
3. 设置工序参数
4. 创建工单

**优点**：
- 灵活性强，满足特殊需求
- 完全可控

#### 2.2.3 混合模式

**流程**：
1. 系统自动获取工序（基于工艺路线）
2. 用户可调整工序顺序
3. 用户可添加或删除工序
4. 用户可修改工序参数
5. 创建工单

**优点**：
- 兼顾自动化和灵活性
- 在标准基础上进行个性化调整

---

## 3. 数据模型设计

### 3.1 WorkOrderCreate Schema扩展

```python
class WorkOrderCreate(WorkOrderBase):
    """
    工单创建Schema（扩展）
    """
    # 原有字段...
    
    # 工序设置方式
    operation_source: Optional[str] = Field(
        None, 
        description="工序来源（auto/material/material_group/bom/manual）"
    )
    
    # 工艺路线ID（用于自动获取工序）
    process_route_id: Optional[int] = Field(
        None, 
        description="工艺路线ID（如果指定，则从该工艺路线获取工序）"
    )
    
    # 手工指定的工序列表
    operations: Optional[List[WorkOrderOperationCreate]] = Field(
        None,
        description="手工指定的工序列表（如果提供，则使用手工工序）"
    )
    
    # 是否允许调整自动获取的工序
    allow_operation_adjustment: bool = Field(
        True,
        description="是否允许调整自动获取的工序（默认：true）"
    )
```

### 3.2 WorkOrderOperationCreate Schema

```python
class WorkOrderOperationCreate(BaseModel):
    """
    工单工序创建Schema
    """
    operation_id: int = Field(..., description="工序ID")
    sequence: int = Field(..., description="工序顺序（从1开始）")
    workshop_id: Optional[int] = Field(None, description="车间ID")
    workshop_name: Optional[str] = Field(None, description="车间名称")
    work_center_id: Optional[int] = Field(None, description="工作中心ID")
    work_center_name: Optional[str] = Field(None, description="工作中心名称")
    standard_time: Optional[Decimal] = Field(None, description="标准工时（小时/件）")
    setup_time: Optional[Decimal] = Field(None, description="准备时间（小时）")
    reporting_type: str = Field("quantity", description="报工类型（quantity/status）")
    allow_jump: bool = Field(False, description="是否允许跳转")
    remarks: Optional[str] = Field(None, description="备注")
```

### 3.3 工序来源枚举

```python
class OperationSource(str, Enum):
    """工序来源枚举"""
    AUTO = "auto"  # 自动匹配（物料绑定 > 物料分组绑定 > BOM绑定）
    MATERIAL = "material"  # 从物料绑定的工艺路线获取
    MATERIAL_GROUP = "material_group"  # 从物料分组绑定的工艺路线获取
    BOM = "bom"  # 从BOM绑定的工艺路线获取
    MANUAL = "manual"  # 手工挑选
```

---

## 4. API接口设计

### 4.1 获取物料可用的工艺路线

**接口**：`GET /api/v1/apps/kuaizhizao/work-orders/available-process-routes`

**功能**：获取物料可用的工艺路线列表（包括物料绑定、物料分组绑定、BOM绑定）

**请求参数**：
```json
{
  "material_id": 1,
  "include_material_group": true,
  "include_bom": true
}
```

**响应**：
```json
{
  "material_route": {
    "id": 1,
    "code": "ROUTE-001",
    "name": "产品A专用工艺路线",
    "source": "material",
    "operations": [...]
  },
  "material_group_route": {
    "id": 2,
    "code": "ROUTE-002",
    "name": "注塑件通用工艺路线",
    "source": "material_group",
    "operations": [...]
  },
  "bom_route": {
    "id": 3,
    "code": "ROUTE-003",
    "name": "BOM工艺路线",
    "source": "bom",
    "operations": [...]
  },
  "recommended_route": {
    "id": 1,
    "code": "ROUTE-001",
    "name": "产品A专用工艺路线",
    "source": "material",
    "priority": 1
  }
}
```

### 4.2 从工艺路线获取工序列表

**接口**：`GET /api/v1/apps/kuaizhizao/work-orders/process-route-operations`

**功能**：从指定工艺路线获取工序列表

**请求参数**：
```json
{
  "process_route_id": 1,
  "material_id": 1,
  "quantity": 100
}
```

**响应**：
```json
{
  "process_route": {
    "id": 1,
    "code": "ROUTE-001",
    "name": "产品A专用工艺路线"
  },
  "operations": [
    {
      "operation_id": 1,
      "operation_code": "OP001",
      "operation_name": "注塑工序",
      "sequence": 1,
      "workshop_id": 1,
      "workshop_name": "注塑车间",
      "work_center_id": 1,
      "work_center_name": "注塑机1",
      "standard_time": 0.1,
      "setup_time": 0.5,
      "reporting_type": "quantity",
      "allow_jump": false
    },
    ...
  ],
  "estimated_total_time": 10.5
}
```

### 4.3 创建工单（支持工序设置）

**接口**：`POST /api/v1/apps/kuaizhizao/work-orders`

**功能**：创建工单，支持自动获取或手工指定工序

**请求参数**：
```json
{
  "name": "工单A",
  "product_id": 1,
  "quantity": 100,
  "operation_source": "auto",  // auto/material/material_group/bom/manual
  "process_route_id": 1,  // 可选，如果指定则使用该工艺路线
  "operations": [  // 可选，如果提供则使用手工工序
    {
      "operation_id": 1,
      "sequence": 1,
      "workshop_id": 1,
      "standard_time": 0.1,
      "setup_time": 0.5
    }
  ],
  "allow_operation_adjustment": true
}
```

**响应**：
```json
{
  "id": 1,
  "code": "WO-20260108-001",
  "name": "工单A",
  "operations": [
    {
      "id": 1,
      "operation_id": 1,
      "operation_code": "OP001",
      "operation_name": "注塑工序",
      "sequence": 1,
      "status": "pending"
    }
  ]
}
```

---

## 5. 业务流程设计

### 5.1 自动模式流程

```
1. 用户选择物料
   ↓
2. 系统自动匹配工艺路线（优先级：物料绑定 > 物料分组绑定 > BOM绑定）
   ↓
3. 系统提取工序序列
   ↓
4. 系统生成工单工序单（包含工序顺序、标准工时、准备时间等）
   ↓
5. 用户预览工序列表（可选调整）
   ↓
6. 用户确认创建工单
   ↓
7. 系统创建工单和工单工序单
```

### 5.2 手工模式流程

```
1. 用户选择物料
   ↓
2. 用户选择"手工挑选工序"
   ↓
3. 系统显示可用工序列表
   ↓
4. 用户选择工序并设置顺序
   ↓
5. 用户设置每个工序的参数（车间、工作中心、标准工时等）
   ↓
6. 用户确认创建工单
   ↓
7. 系统创建工单和工单工序单
```

### 5.3 混合模式流程

```
1. 用户选择物料
   ↓
2. 系统自动匹配工艺路线并提取工序
   ↓
3. 系统显示工序列表（可编辑）
   ↓
4. 用户调整工序：
   - 调整工序顺序（拖拽）
   - 添加工序（从工序库选择）
   - 删除工序
   - 修改工序参数
   ↓
5. 用户确认创建工单
   ↓
6. 系统创建工单和工单工序单
```

---

## 6. 前端交互设计

### 6.1 创建工单表单

**布局**：
```
┌─────────────────────────────────────┐
│ 工单基本信息                          │
│ - 工单名称                           │
│ - 产品选择                           │
│ - 数量                               │
│ ...                                  │
├─────────────────────────────────────┤
│ 工序设置                              │
│ ┌─────────────────────────────────┐ │
│ │ 工序来源：                      │ │
│ │ ○ 自动获取（推荐）              │ │
│ │ ○ 从物料工艺路线                │ │
│ │ ○ 从物料分组工艺路线            │ │
│ │ ○ 从BOM工艺路线                 │ │
│ │ ○ 手工挑选                      │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 工序列表（可编辑）               │ │
│ │ ┌─────────────────────────────┐ │ │
│ │ │ 序号 │ 工序 │ 车间 │ 操作   │ │ │
│ │ │  1  │ 注塑 │ 注塑 │ [编辑] │ │ │
│ │ │  2  │ 组装 │ 组装 │ [编辑] │ │ │
│ │ │  3  │ 包装 │ 包装 │ [编辑] │ │ │
│ │ └─────────────────────────────┘ │ │
│ │ [+ 添加工序] [调整顺序]          │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 6.2 工序选择器

**功能**：
- 显示可用工序列表
- 支持搜索和筛选
- 支持多选
- 显示工序详细信息（车间、工作中心、标准工时等）

### 6.3 工序编辑器

**功能**：
- 编辑工序顺序（拖拽排序）
- 编辑工序参数（车间、工作中心、标准工时、准备时间等）
- 设置报工类型和跳转规则
- 添加备注

---

## 7. 实现方案

### 7.1 后端实现

#### 7.1.1 扩展WorkOrderCreate Schema

```python
# riveredge-backend/src/apps/kuaizhizao/schemas/work_order.py

class WorkOrderOperationCreate(BaseModel):
    """工单工序创建Schema"""
    operation_id: int = Field(..., description="工序ID")
    sequence: int = Field(..., description="工序顺序")
    workshop_id: Optional[int] = Field(None, description="车间ID")
    workshop_name: Optional[str] = Field(None, description="车间名称")
    work_center_id: Optional[int] = Field(None, description="工作中心ID")
    work_center_name: Optional[str] = Field(None, description="工作中心名称")
    standard_time: Optional[Decimal] = Field(None, description="标准工时")
    setup_time: Optional[Decimal] = Field(None, description="准备时间")
    reporting_type: str = Field("quantity", description="报工类型")
    allow_jump: bool = Field(False, description="是否允许跳转")
    remarks: Optional[str] = Field(None, description="备注")


class WorkOrderCreate(WorkOrderBase):
    """工单创建Schema（扩展）"""
    # 原有字段...
    
    # 工序设置
    operation_source: Optional[str] = Field(
        None,
        description="工序来源（auto/material/material_group/bom/manual）"
    )
    process_route_id: Optional[int] = Field(
        None,
        description="工艺路线ID（如果指定，则从该工艺路线获取工序）"
    )
    operations: Optional[List[WorkOrderOperationCreate]] = Field(
        None,
        description="手工指定的工序列表"
    )
    allow_operation_adjustment: bool = Field(
        True,
        description="是否允许调整自动获取的工序"
    )
```

#### 7.1.2 扩展WorkOrderService

```python
# riveredge-backend/src/apps/kuaizhizao/services/work_order_service.py

class WorkOrderService(AppBaseService[WorkOrder]):
    
    async def get_available_process_routes(
        self,
        tenant_id: int,
        material_id: int
    ) -> Dict[str, Any]:
        """
        获取物料可用的工艺路线
        
        Returns:
            Dict包含物料绑定、物料分组绑定、BOM绑定的工艺路线
        """
        # 1. 查找物料绑定的工艺路线
        # 2. 查找物料分组绑定的工艺路线
        # 3. 查找BOM绑定的工艺路线
        # 4. 返回推荐工艺路线（优先级：物料 > 物料分组 > BOM）
        pass
    
    async def get_process_route_operations(
        self,
        tenant_id: int,
        process_route_id: int,
        material_id: int,
        quantity: Decimal
    ) -> List[Dict[str, Any]]:
        """
        从工艺路线获取工序列表
        
        Returns:
            工序列表（包含工序信息和计算后的计划时间）
        """
        pass
    
    async def create_work_order(
        self,
        tenant_id: int,
        work_order_data: WorkOrderCreate,
        created_by: int
    ) -> WorkOrderResponse:
        """
        创建工单（支持工序设置）
        
        逻辑：
        1. 如果提供了operations，使用手工工序
        2. 如果提供了process_route_id，从该工艺路线获取工序
        3. 如果operation_source为auto，自动匹配工艺路线
        4. 如果operation_source为material/material_group/bom，从对应来源获取
        5. 创建工单和工单工序单
        """
        # 原有逻辑...
        
        # 处理工序设置
        if work_order_data.operations:
            # 使用手工工序
            await self._create_work_order_operations_from_manual(
                tenant_id, work_order, work_order_data.operations, created_by
            )
        elif work_order_data.process_route_id:
            # 从指定工艺路线获取
            process_route = await ProcessRoute.get_or_none(
                id=work_order_data.process_route_id,
                tenant_id=tenant_id
            )
            if process_route:
                await self._generate_work_order_operations_from_route(
                    tenant_id, work_order, process_route, created_by
                )
        elif work_order_data.operation_source == "auto":
            # 自动匹配工艺路线
            process_route = await self._match_process_route_for_material(
                tenant_id, material.id
            )
            if process_route:
                await self._generate_work_order_operations_from_route(
                    tenant_id, work_order, process_route, created_by
                )
        elif work_order_data.operation_source in ["material", "material_group", "bom"]:
            # 从指定来源获取
            process_route = await self._get_process_route_from_source(
                tenant_id, material.id, work_order_data.operation_source
            )
            if process_route:
                await self._generate_work_order_operations_from_route(
                    tenant_id, work_order, process_route, created_by
                )
        
        return WorkOrderResponse.model_validate(work_order)
```

#### 7.1.3 添加API接口

```python
# riveredge-backend/src/apps/kuaizhizao/api/production.py

@router.get("/work-orders/available-process-routes", summary="获取物料可用的工艺路线")
async def get_available_process_routes(
    material_id: int = Query(..., description="物料ID"),
    current_user: User = Depends(get_current_user),
    tenant_id: int = Depends(get_current_tenant),
):
    """获取物料可用的工艺路线列表"""
    return await WorkOrderService().get_available_process_routes(
        tenant_id=tenant_id,
        material_id=material_id
    )


@router.get("/work-orders/process-route-operations", summary="从工艺路线获取工序列表")
async def get_process_route_operations(
    process_route_id: int = Query(..., description="工艺路线ID"),
    material_id: int = Query(..., description="物料ID"),
    quantity: Decimal = Query(..., description="数量"),
    current_user: User = Depends(get_current_user),
    tenant_id: int = Depends(get_current_tenant),
):
    """从工艺路线获取工序列表"""
    return await WorkOrderService().get_process_route_operations(
        tenant_id=tenant_id,
        process_route_id=process_route_id,
        material_id=material_id,
        quantity=quantity
    )
```

### 7.2 前端实现

#### 7.2.1 创建工单表单组件

```typescript
// riveredge-frontend/src/apps/kuaizhizao/pages/production-execution/work-orders/components/CreateWorkOrderForm.tsx

const CreateWorkOrderForm: React.FC = () => {
  const [operationSource, setOperationSource] = useState<'auto' | 'material' | 'material_group' | 'bom' | 'manual'>('auto');
  const [availableRoutes, setAvailableRoutes] = useState<any[]>([]);
  const [selectedRoute, setSelectedRoute] = useState<number | null>(null);
  const [operations, setOperations] = useState<WorkOrderOperation[]>([]);
  
  // 选择物料后，获取可用工艺路线
  const handleMaterialChange = async (materialId: number) => {
    const routes = await workOrderApi.getAvailableProcessRoutes(materialId);
    setAvailableRoutes(routes);
    
    // 自动选择推荐工艺路线
    if (routes.recommended_route) {
      setSelectedRoute(routes.recommended_route.id);
      await loadOperationsFromRoute(routes.recommended_route.id);
    }
  };
  
  // 从工艺路线加载工序
  const loadOperationsFromRoute = async (routeId: number) => {
    const ops = await workOrderApi.getProcessRouteOperations({
      process_route_id: routeId,
      material_id: materialId,
      quantity: quantity
    });
    setOperations(ops.operations);
  };
  
  // 手工选择工序
  const handleManualSelectOperations = () => {
    // 打开工序选择器
    // 用户选择工序后，设置operations
  };
  
  return (
    <Form>
      {/* 工单基本信息 */}
      <ProFormSelect
        name="product_id"
        label="产品"
        onChange={handleMaterialChange}
      />
      
      {/* 工序设置 */}
      <ProFormRadio.Group
        name="operation_source"
        label="工序来源"
        options={[
          { label: '自动获取（推荐）', value: 'auto' },
          { label: '从物料工艺路线', value: 'material' },
          { label: '从物料分组工艺路线', value: 'material_group' },
          { label: '从BOM工艺路线', value: 'bom' },
          { label: '手工挑选', value: 'manual' }
        ]}
        onChange={setOperationSource}
      />
      
      {/* 工序列表 */}
      <OperationListEditor
        operations={operations}
        onChange={setOperations}
        allowEdit={true}
      />
    </Form>
  );
};
```

---

## 8. 验收标准

### 8.1 功能验收

- ✅ **自动获取工序正常**：
  - ✅ 从物料绑定的工艺路线获取工序正常
  - ✅ 从物料分组绑定的工艺路线获取工序正常
  - ✅ 从BOM绑定的工艺路线获取工序正常
  - ✅ 优先级匹配正常（物料 > 物料分组 > BOM）

- ✅ **手工挑选工序正常**：
  - ✅ 工序选择器显示正常
  - ✅ 工序选择功能正常
  - ✅ 工序顺序设置正常
  - ✅ 工序参数设置正常

- ✅ **混合模式正常**：
  - ✅ 自动获取后允许调整
  - ✅ 工序顺序调整正常（拖拽）
  - ✅ 添加/删除工序正常
  - ✅ 修改工序参数正常

### 8.2 数据验收

- ✅ **工单创建成功**：工单数据保存正确
- ✅ **工单工序单创建成功**：工序数据保存正确
- ✅ **工序顺序正确**：工序顺序按设置保存
- ✅ **工序参数正确**：工序参数（标准工时、准备时间等）保存正确

### 8.3 用户体验验收

- ✅ **操作流程顺畅**：创建工单流程顺畅，无卡顿
- ✅ **界面友好**：工序设置界面清晰，易于操作
- ✅ **提示明确**：操作提示明确，错误提示友好
- ✅ **性能良好**：加载工艺路线和工序列表响应快速

---

## 9. 后续优化方向

### 9.1 工序模板

- 支持保存常用工序组合为模板
- 支持从模板快速创建工单

### 9.2 工序智能推荐

- 基于历史数据，AI推荐工序组合
- 基于物料类型，推荐常用工序

### 9.3 工序批量操作

- 支持批量设置工序参数
- 支持批量复制工序配置

---

**文档结束**
