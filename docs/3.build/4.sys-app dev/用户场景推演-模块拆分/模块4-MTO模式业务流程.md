# 模块4：MTO模式业务流程

## 📋 模块概述

**目标：** 完成MTO（按订单生产）模式的完整业务流程  
**优先级：** ⭐⭐⭐⭐（高）  
**开发阶段：** 第二阶段  
**预计时间：** 模式扩展

**说明：** MTO模式与MTS模式的主要区别在于订单关联和订单专属库存管理

---

## 场景4.1：需求管理阶段

### 基础流程

**目标：** 完成销售订单的基础创建（MTO模式）

**用户操作：**
1. 进入"快智造" → "计划管理" → "需求管理" → "销售订单(MTO)"
2. 创建销售订单（手动创建）：
   - 订单1：
     - 客户：客户A
     - 产品：产品A
     - 数量：100个
     - 交货日期：2026-01-20
   - 订单2：
     - 客户：客户B
     - 产品：产品B
     - 数量：50个
     - 交货日期：2026-01-25
3. 提交销售订单

**系统行为：**
- ✅ 保存销售订单数据
- ✅ 标记为MTO模式

**验收标准：**
- ✅ 销售订单创建成功
- ✅ 销售订单标记为MTO模式

---

### 体验改进流程

**目标：** 优化需求管理体验

**功能点：**
- ✅ 销售订单批量导入（Excel批量导入，支持模板下载）
- ✅ 销售订单历史数据查看（历史订单查看）
- ✅ 销售订单状态管理（订单状态流转）
- ✅ Excel数据验证（导入时数据校验和错误提示）

**验收标准：**
- ✅ Excel批量导入功能可用（支持模板下载）
- ✅ 历史数据查看功能可用
- ✅ 订单状态管理可用
- ✅ Excel数据验证和错误提示正常

---

## 场景4.2：LRP运算阶段

### 基础流程

**目标：** 完成LRP运算的核心功能（MTO模式）

**用户操作：**
1. 进入"快智造" → "计划管理" → "计划排程" → "LRP运算(MTO)"
2. 选择销售订单（订单1）
3. 点击"运行LRP运算"
4. 系统自动计算：
   - 根据销售订单和当前库存计算物料需求
   - 根据BOM展开计算原材料需求
   - 生成工单建议和采购建议（针对特定订单）
5. 查看LRP运算结果：
   - 物料需求清单（订单专属）
   - 工单建议（产品A需要生产100个，关联订单1）
   - 采购建议（针对订单1的采购需求）

**系统行为：**
- ✅ 执行LRP运算（同步计算，支持小数据量）
- ✅ 根据销售订单和库存计算物料需求
- ✅ 根据BOM展开计算原材料需求
- ✅ 生成工单建议和采购建议（订单专属）

**验收标准：**
- ✅ LRP运算成功（支持基础数据量：100+物料）
- ✅ 物料需求计算正确（订单专属）
- ✅ 工单建议生成正确（关联订单）
- ✅ 采购建议生成正确（订单专属）

---

### 体验改进流程

**目标：** 优化LRP运算体验和性能

**功能点：**
- ✅ LRP运算异步执行（使用Inngest工作流，支持大数据量：1000+物料）
- ✅ LRP运算进度显示（进度条、状态提示）
- ✅ LRP运算结果导出（Excel导出）
- ✅ LRP运算历史记录（历史运算记录查看）
- ✅ LRP运算参数配置（安全库存、采购周期等参数配置）
- ✅ LRP运算结果可视化（图表展示）

**验收标准：**
- ✅ LRP运算异步执行正常（支持大数据量）
- ✅ 进度显示功能可用
- ✅ Excel导出功能可用
- ✅ 历史记录查看功能可用
- ✅ 参数配置功能可用
- ✅ 结果可视化展示正常

---

## 场景4.3：工单创建阶段（关联订单）

### 基础流程

**目标：** 完成工单创建并关联销售订单（MTO模式关键）

**用户操作：**
1. 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
2. 根据LRP运算结果创建工单（手动创建）：
   - 点击"新建"按钮
   - 选择产品：产品A
   - 选择数量：100个
   - **关联销售订单：订单1**（MTO模式关键）
   - 选择车间：组装车间
   - 选择工作中心：组装线1
   - 选择计划开始时间：2026-01-10 08:00
   - 选择计划结束时间：2026-01-15 18:00
   - 提交工单
3. 系统自动标记为MTO模式工单
4. 查看工单详情（显示关联订单信息）

**系统行为：**
- ✅ 自动生成工单号（工单-20260110-001，支持中文前缀）
- ✅ 创建工单数据（关联销售订单）
- ✅ 标记为MTO模式
- ✅ 根据BOM自动生成工单工序

**验收标准：**
- ✅ 工单创建成功（关联销售订单）
- ✅ 工单标记为MTO模式
- ✅ 工单关联订单信息正确

---

### 体验改进流程

**目标：** 优化工单创建和管理体验

**功能点：**
- ✅ 工单二维码生成（用于扫码报工，支持中文二维码）
- ✅ 工单详情查看（使用Drawer，显示关联订单信息）
- ✅ 工单批量导入（Excel批量导入，支持模板下载）
- ✅ 工单高级搜索（拼音搜索、快速筛选、按订单搜索）
- ✅ 工单打印（打印模板、打印预览）
- ✅ Excel数据验证（导入时数据校验和错误提示）

**验收标准：**
- ✅ 工单二维码生成成功（支持中文）
- ✅ 工单详情Drawer展示正常（显示关联订单）
- ✅ Excel批量导入功能可用（支持模板下载）
- ✅ 工单高级搜索可用（拼音搜索、按订单搜索）
- ✅ 工单打印可用（打印预览正常）
- ✅ Excel数据验证和错误提示正常

---

## 场景4.4：高级排产阶段（可选）

### 基础流程

**目标：** 完成基础排产功能（包含MTO工单）

**用户操作：**
1. 进入"快智造" → "计划管理" → "高级排产" → "排产甘特图"
2. 查看所有待排产工单（包括MTO工单，列表展示）
3. 根据订单交货日期调整排产计划（列表编辑）：
   - 订单1交货日期：2026-01-20
   - 调整工单排产计划，确保在交货日期前完成
4. 保存排产计划

**系统行为：**
- ✅ 显示待排产工单列表（包含MTO工单）
- ✅ 保存排产计划

**验收标准：**
- ✅ 待排产工单列表展示正常（包含MTO工单）
- ✅ 排产计划保存成功

---

### 体验改进流程

**目标：** 优化高级排产体验

**功能点：**
- ✅ 排产甘特图可视化展示（可视化排程，包含MTO工单）
- ✅ 拖拽调整排产计划（拖拽操作）
- ✅ 检查订单交货日期（自动检查交货日期）
- ✅ 工作中心能力检查（自动检查冲突）
- ✅ 排产计划导出（Excel导出）
- ✅ 排产算法优化（根据交货日期自动排产建议）

**验收标准：**
- ✅ 排产甘特图展示正常（包含MTO工单，支持拖拽）
- ✅ 订单交货日期检查正常
- ✅ 工作中心能力检查正常
- ✅ Excel导出功能可用
- ✅ 自动排产建议可用（考虑交货日期）

---

## 场景4.5：工单下达阶段

### 基础流程

**目标：** 完成工单下达的核心功能（MTO工单）

**用户操作：**
1. 进入"快智造" → "生产执行" → "工单管理" → "工单列表"
2. 选择已排产的MTO工单
3. 点击"下达"按钮
4. 确认下达工单
5. 工单状态变为"已下达"

**系统行为：**
- ✅ 更新工单状态为"已下达"

**验收标准：**
- ✅ 工单下达成功
- ✅ 工单状态更新成功

---

### 体验改进流程

**目标：** 优化工单下达体验

**功能点：**
- ✅ 工单状态流转工作流（使用Inngest工作流）
- ✅ 通知相关人员（生产管理员、车间工人，消息通知）
- ✅ 工单批量下达（批量操作）

**验收标准：**
- ✅ 工单状态流转工作流正常
- ✅ 通知发送成功
- ✅ 批量下达功能可用

---

## 场景4.6：生产领料阶段（订单专属库存）

### 基础流程

**目标：** 完成生产领料并标记订单专属库存（MTO模式关键）

**用户操作：**
1. 进入"快智造" → "仓储管理" → "出库管理"
2. 创建生产领料出库单（手动创建）：
   - 点击"新建"按钮
   - 选择关联工单：工单-20260110-001（产品A，关联订单1）
   - 系统自动根据BOM生成领料需求：
     - 注塑件A：200个（从半成品仓库）
     - 注塑件B：100个（从半成品仓库）
     - 螺丝：400个（从原材料仓库）
   - 确认领料数量
   - 提交出库单
3. 系统自动标记为订单专属库存（MTO模式）

**系统行为：**
- ✅ 根据工单和BOM自动生成领料需求
- ✅ 创建出库单（关联订单）
- ✅ 标记为订单专属库存（MTO模式）
- ✅ 自动更新库存数量（预留订单专属库存）

**验收标准：**
- ✅ 生产领料出库单创建成功（关联订单）
- ✅ 订单专属库存标记成功
- ✅ 库存自动更新成功（预留订单专属库存）

---

### 体验改进流程

**目标：** 优化生产领料体验

**功能点：**
- ✅ 出库单打印（打印模板、打印预览）
- ✅ 库存可用量检查（领料前库存检查，区分订单专属库存）
- ✅ 订单专属库存查询（订单专属库存查询功能）

**验收标准：**
- ✅ 出库单打印可用（打印预览正常）
- ✅ 库存可用量检查正常（区分订单专属库存）
- ✅ 订单专属库存查询功能可用

---

## 场景4.7：报工阶段

### 基础流程

**目标：** 完成报工的核心功能（MTO工单）

**用户操作：**
1. **车间工人操作（PC端）：**
   - 进入报工界面
   - 输入工单号（手动输入）
   - 选择工序：组装工序
   - 输入完成数量：100个
   - 输入合格数量：98个（2个不良）
   - 输入工时：10小时
   - 输入备注："正常完成"
   - 提交报工
2. **生产管理员操作（PC端）：**
   - 查看报工记录
   - 查看工单进度（自动更新）

**系统行为：**
- ✅ 记录报工数据
- ✅ 自动更新工单进度
- ✅ 自动判断工单完工

**验收标准：**
- ✅ 报工功能正常
- ✅ 工单进度自动更新正常
- ✅ 工单完工自动判断正常

---

### 体验改进流程

**目标：** 优化报工体验和功能完善（同MTS模式）

**功能点：**
- ✅ 移动端报工界面（移动端优化）
- ✅ 扫码报工（支持二维码、条形码，支持中文二维码）
- ✅ 语音输入（备注支持语音输入）
- ✅ 报工记录高级搜索（拼音搜索、快速筛选、按订单搜索）
- ✅ 报工记录批量导入（Excel导入，支持模板下载）
- ✅ 离线功能（网络不稳定场景，离线报工，网络恢复后同步）

**验收标准：**
- ✅ 移动端报工界面优化可用
- ✅ 扫码报工正常（支持中文二维码）
- ✅ 语音输入功能可用
- ✅ 报工记录高级搜索可用（拼音搜索、按订单搜索）
- ✅ 报工记录批量导入可用（Excel导入）
- ✅ 离线功能可用（离线报工和同步正常）

---

## 场景4.8：成品入库阶段（订单专属库存）

### 基础流程

**目标：** 完成成品入库并标记订单专属库存（MTO模式关键）

**用户操作：**
1. 进入"快智造" → "仓储管理" → "入库管理"
2. 创建成品入库单（手动创建）：
   - 点击"新建"按钮
   - 选择关联工单：工单-20260110-001（产品A，关联订单1）
   - 系统自动填充：
     - 物料：产品A
     - 数量：98个（合格数量）
     - 仓库：成品仓库
     - **关联销售订单：订单1**（MTO模式关键）
   - 确认入库数量
   - 提交入库单
3. 系统自动标记为订单专属库存（MTO模式）

**系统行为：**
- ✅ 根据工单自动填充入库信息
- ✅ 创建入库单（关联销售订单）
- ✅ 标记为订单专属库存（MTO模式）
- ✅ 自动更新库存数量（订单专属库存）

**验收标准：**
- ✅ 成品入库单创建成功（关联订单）
- ✅ 订单专属库存标记成功
- ✅ 库存自动更新成功（订单专属库存）

---

### 体验改进流程

**目标：** 优化成品入库体验

**功能点：**
- ✅ 入库单打印（打印模板、打印预览）
- ✅ 订单专属库存查询（订单专属库存查询功能）

**验收标准：**
- ✅ 入库单打印可用（打印预览正常）
- ✅ 订单专属库存查询功能可用

---

## 场景4.9：销售出库阶段（关联订单）

### 基础流程

**目标：** 完成销售出库并关联订单（MTO模式关键）

**用户操作：**
1. 进入"快智造" → "仓储管理" → "出库管理"
2. 创建销售出库单（MTO模式，关联订单，手动创建）：
   - 点击"新建"按钮
   - 选择出库类型：销售出库
   - **选择关联销售订单：订单1**（MTO模式关键）
   - 系统自动填充：
     - 客户：客户A
     - 物料：产品A
     - 数量：98个（订单专属库存）
     - 仓库：成品仓库
   - 确认出库数量
   - 提交出库单
3. 系统自动更新库存（释放订单专属库存）

**系统行为：**
- ✅ 创建销售出库单（关联销售订单）
- ✅ 自动填充订单信息
- ✅ 自动更新库存数量（释放订单专属库存）
- ✅ 记录出库历史

**验收标准：**
- ✅ 销售出库单创建成功（关联订单）
- ✅ 订单信息自动填充正确
- ✅ 库存自动更新成功（释放订单专属库存）

---

### 体验改进流程

**目标：** 优化销售出库体验

**功能点：**
- ✅ 出库单打印（打印模板、打印预览）
- ✅ 订单专属库存检查（出库前检查订单专属库存可用量）
- ✅ 订单完成状态更新（出库后自动更新订单状态）

**验收标准：**
- ✅ 出库单打印可用（打印预览正常）
- ✅ 订单专属库存检查正常
- ✅ 订单完成状态更新正常

---

**文档创建时间：** 2025-12-27  
**文档作者：** Luigi Lu

