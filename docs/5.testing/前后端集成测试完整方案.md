# 前后端集成测试完整方案

## 📋 概述

本文档描述如何系统性测试前后端完整流程，确保从前端UI到后端API的整个链路都能正常工作。

## 🎯 测试目标

1. **验证前端服务函数**：前端API服务函数能正确调用后端
2. **验证数据格式**：前后端数据格式匹配
3. **验证业务流程**：完整业务流程能正常执行
4. **验证错误处理**：API错误能正确处理

## 🏗️ 测试架构

### 测试分层

```
┌─────────────────────────────────────────┐
│    浏览器E2E测试 (Playwright)            │
│  (真实浏览器，完整UI交互)                │
├─────────────────────────────────────────┤
│    前后端集成测试 (Vitest + Fetch)       │
│  (前端服务函数 + 后端API)                │
├─────────────────────────────────────────┤
│    后端E2E测试 (Pytest + httpx)         │
│  (后端API端到端)                         │
└─────────────────────────────────────────┘
```

## 📝 测试实现

### 1. 前后端集成测试（推荐）

**位置**: `riveredge-frontend/tests/e2e/sales-order-workflow-integration.test.ts`

**特点**:
- 直接调用后端API（不经过前端代理）
- 使用原生fetch，模拟前端服务函数调用
- 验证前后端数据格式匹配
- 执行速度快，适合CI/CD

**运行方式**:
```bash
# 确保后端服务运行
cd riveredge-backend
# 启动后端服务（端口8100或8200）

# 运行前端集成测试
cd riveredge-frontend
export VITE_BACKEND_URL=http://localhost:8100
npm run test:run tests/e2e/sales-order-workflow-integration.test.ts
```

### 2. 浏览器E2E测试（可选）

**工具**: Playwright

**特点**:
- 真实浏览器环境
- 完整UI交互测试
- 验证用户操作流程
- 执行速度较慢

**安装**:
```bash
cd riveredge-frontend
npm install -D @playwright/test
npx playwright install
```

## 🚀 快速开始

### 方法1: 前后端集成测试（推荐）

```bash
# 1. 启动后端服务
cd riveredge-backend
# 确保后端运行在 http://localhost:8100

# 2. 运行前端集成测试
cd riveredge-frontend
export VITE_BACKEND_URL=http://localhost:8100
npm run test:run tests/e2e/sales-order-workflow-integration.test.ts
```

### 方法2: 使用测试脚本

```bash
# 使用提供的测试脚本
cd riveredge-frontend
bash tests/e2e/run-integration-tests.sh
```

## 📊 测试覆盖

### 销售订单完整流程

1. ✅ **创建销售订单** - 验证前端服务函数调用后端API
2. ✅ **获取订单详情** - 验证数据格式匹配
3. ✅ **更新订单** - 验证更新逻辑
4. ✅ **提交订单** - 验证状态流转
5. ✅ **审核订单** - 验证审核流程
6. ✅ **确认订单** - 验证确认流程
7. ✅ **下推到销售出库** - 验证关联单据创建
8. ✅ **验证订单列表** - 验证列表查询和筛选

## 🔧 测试配置

### 环境变量

```bash
# 后端服务URL
export VITE_BACKEND_URL=http://localhost:8100

# 或使用API目标
export VITE_API_TARGET=http://localhost:8100
```

### 测试数据

测试会自动查找测试数据：
- 测试客户：code = 'TEST-CUSTOMER-001'
- 测试物料：code = 'TEST-MAT-001'

如果找不到，会使用列表中的第一条记录。

## 📈 测试结果

### 成功示例

```
================================================================================
开始测试销售订单完整流程（前后端集成）
================================================================================

[步骤1] 创建销售订单...
✅ 订单创建成功: SO202601060005 (ID: 72)

[步骤2] 获取订单详情...
✅ 订单详情获取成功

[步骤3] 更新订单...
✅ 订单更新成功

[步骤4] 提交订单...
✅ 订单提交成功，状态: 待审核

[步骤5] 审核订单...
✅ 订单审核成功，状态: 已审核

[步骤6] 确认订单...
✅ 订单确认成功，状态: 已确认

[步骤7] 下推到销售出库...
✅ 下推成功，出库单编码: SD202601060003

[步骤8] 验证订单列表...
✅ 订单在列表中，共 10 条记录

================================================================================
✅ 销售订单完整流程测试通过！
   订单编码: SO202601060005
   订单ID: 72
================================================================================
```

## 🔄 与后端E2E测试的配合

### 测试分工

| 测试类型 | 测试范围 | 验证点 |
|---------|---------|--------|
| 后端E2E | 后端API | API响应、业务逻辑、数据一致性 |
| 前后端集成 | 前端服务+后端API | 数据格式匹配、服务函数调用 |
| 浏览器E2E | 完整UI | 用户交互、UI渲染、端到端流程 |

### 测试执行顺序

1. **后端E2E测试** - 确保后端API正常
2. **前后端集成测试** - 确保前后端数据匹配
3. **浏览器E2E测试** - 确保完整用户体验

## 🐛 故障排查

### 常见问题

1. **后端服务不可用**
   ```
   错误: 无法连接到后端服务
   解决: 确保后端服务运行在指定端口
   ```

2. **认证失败**
   ```
   错误: 401 Unauthorized
   解决: 检查测试token配置
   ```

3. **测试数据不存在**
   ```
   错误: 未找到测试客户/物料
   解决: 运行后端MOCK数据脚本
   ```

## 📚 相关文档

- [全流程自动化测试方案](./全流程自动化测试方案.md)
- [后端E2E测试](../../riveredge-backend/tests/e2e/README_全流程测试.md)
- [前端集成测试使用指南](../../riveredge-frontend/tests/e2e/README_前后端集成测试.md)

