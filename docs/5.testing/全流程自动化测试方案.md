# 全流程自动化测试方案

## 📋 概述

本文档描述如何系统性、自动化地测试全流程，包括前后端，以确保全流程单据可以跑通。

## 🎯 测试目标

1. **验证完整业务流程**：从创建单据到完成所有后续操作的完整流程
2. **确保数据一致性**：验证每个步骤的数据正确性和状态流转
3. **前后端集成验证**：确保前后端API调用和数据交互正常
4. **自动化执行**：支持CI/CD集成，自动运行测试

## 🏗️ 测试架构

### 测试分层

```
┌─────────────────────────────────────────┐
│          E2E 端到端测试                  │
│  (完整业务流程，前后端集成)              │
├─────────────────────────────────────────┤
│          Integration 集成测试            │
│  (API端到端，服务间交互)                 │
├─────────────────────────────────────────┤
│          Unit 单元测试                   │
│  (单个服务/函数测试)                     │
└─────────────────────────────────────────┘
```

### 测试类型

1. **单元测试** (`tests/unit/`)
   - 测试单个服务方法
   - 测试数据模型验证
   - 快速执行，高覆盖率

2. **集成测试** (`tests/integration/`)
   - 测试API端点
   - 测试服务间交互
   - 使用测试数据库

3. **端到端测试** (`tests/e2e/`)
   - 测试完整业务流程
   - 前后端集成验证
   - 使用真实数据库（测试环境）

## 📝 测试流程设计

### 销售订单完整流程示例

```
创建订单（草稿）
    ↓
提交订单（待审核）
    ↓
审核订单（已审核）
    ↓
确认订单（已确认）
    ↓
下推到销售出库
    ↓
验证出库单创建
    ↓
验证订单状态更新
```

### 其他业务流程

1. **采购订单流程**
   - 创建 → 提交 → 审核 → 确认 → 下推到采购入库

2. **工单流程**
   - 创建 → 下达 → 报工 → 完工 → 入库

3. **MTO模式流程**
   - 销售订单 → LRP运算 → 工单生成 → 生产 → 入库 → 出库

4. **MTS模式流程**
   - 销售订单 → 库存检查 → 出库

## 🛠️ 实现方案

### 1. 后端E2E测试

#### 测试文件结构

```
tests/e2e/
├── conftest.py                    # 测试配置和fixtures
├── test_complete_sales_order_workflow.py  # 销售订单完整流程
├── test_complete_purchase_workflow.py     # 采购订单完整流程
├── test_complete_work_order_workflow.py   # 工单完整流程
└── run_all_tests.py              # 运行所有测试
```

#### 测试配置 (`conftest.py`)

- **数据库设置**：每个测试使用独立的测试数据库或事务
- **测试数据**：自动创建测试租户、用户、客户、物料等
- **认证**：自动生成JWT token
- **清理**：测试结束后自动清理测试数据

#### 测试示例

```python
@pytest.mark.e2e
@pytest.mark.sales_order
class TestCompleteSalesOrderWorkflow:
    async def test_complete_sales_order_to_delivery_workflow(
        self,
        test_client: AsyncClient,
        auth_headers: dict,
        test_customer,
        test_material,
        test_user
    ):
        # 步骤1: 创建订单
        # 步骤2: 提交订单
        # 步骤3: 审核订单
        # 步骤4: 下推到出库
        # 步骤5: 验证结果
```

### 2. 前端E2E测试

#### 测试文件结构

```
tests/e2e/
├── sales-order-workflow.test.ts   # 销售订单流程
├── purchase-order-workflow.test.ts # 采购订单流程
└── work-order-workflow.test.ts    # 工单流程
```

#### 测试工具

- **Vitest**：单元测试和API测试
- **Playwright**（可选）：浏览器E2E测试

### 3. 测试数据管理

#### 测试数据创建

```python
@pytest.fixture
async def test_customer(db_setup, test_tenant):
    """创建测试客户"""
    customer = await Customer.create(
        tenant_id=test_tenant.id,
        code="TEST-CUSTOMER-001",
        name="测试客户",
        ...
    )
    yield customer
    # 清理
    await customer.delete()
```

#### 测试数据清理

- **自动清理**：使用pytest fixtures自动清理
- **事务回滚**：使用数据库事务，测试结束后自动回滚
- **软删除**：使用软删除，避免数据冲突

### 4. 测试运行脚本

#### 运行单个测试

```bash
# 后端
cd riveredge-backend
uv run pytest tests/e2e/test_complete_sales_order_workflow.py -v

# 前端
cd riveredge-frontend
npm run test tests/e2e/sales-order-workflow.test.ts
```

#### 运行所有E2E测试

```bash
# 后端
cd riveredge-backend
uv run pytest tests/e2e/ -v --tb=short

# 或使用运行脚本
python tests/e2e/run_all_tests.py
```

#### 生成测试报告

```bash
# 生成HTML报告
uv run pytest tests/e2e/ --html=test_report.html --self-contained-html

# 生成JUnit XML报告（用于CI/CD）
uv run pytest tests/e2e/ --junit-xml=test_results.xml
```

## 🔄 CI/CD集成

### GitHub Actions示例

```yaml
name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          cd riveredge-backend
          uv sync
      - name: Run E2E tests
        run: |
          cd riveredge-backend
          uv run pytest tests/e2e/ -v --junit-xml=test_results.xml
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: riveredge-backend/test_results.xml

  frontend-e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      - name: Install dependencies
        run: |
          cd riveredge-frontend
          npm install
      - name: Run E2E tests
        run: |
          cd riveredge-frontend
          npm run test:run
```

## 📊 测试报告

### 测试结果格式

- **控制台输出**：实时显示测试进度和结果
- **HTML报告**：详细的测试报告，包含失败原因
- **JUnit XML**：用于CI/CD集成

### 测试指标

- **测试覆盖率**：目标 > 80%
- **测试通过率**：目标 100%
- **测试执行时间**：单个流程 < 30秒

## 🚀 快速开始

### 1. 运行单个流程测试

```bash
# 销售订单完整流程
cd riveredge-backend
uv run pytest tests/e2e/test_complete_sales_order_workflow.py -v
```

### 2. 运行所有E2E测试

```bash
cd riveredge-backend
python tests/e2e/run_all_tests.py
```

### 3. 查看测试报告

```bash
# 生成HTML报告
uv run pytest tests/e2e/ --html=test_report.html --self-contained-html

# 在浏览器中打开
open test_report.html
```

## 📚 最佳实践

### 1. 测试独立性

- 每个测试应该独立运行
- 不依赖其他测试的执行顺序
- 使用fixtures创建和清理测试数据

### 2. 测试数据管理

- 使用唯一的测试数据标识（如UUID、时间戳）
- 测试结束后自动清理
- 避免硬编码测试数据

### 3. 错误处理

- 验证每个步骤的返回状态码
- 检查错误消息的准确性
- 记录详细的错误信息

### 4. 性能考虑

- 使用异步测试提高执行速度
- 合理使用数据库连接池
- 避免不必要的等待时间

## 🔍 故障排查

### 常见问题

1. **数据库连接失败**
   - 检查数据库配置
   - 确保测试数据库已创建

2. **认证失败**
   - 检查JWT token生成
   - 验证用户权限

3. **数据清理失败**
   - 检查外键约束
   - 确保软删除正确实现

### 调试技巧

```python
# 打印详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 使用pytest的--pdb选项进入调试器
pytest tests/e2e/test_*.py --pdb

# 使用-v选项查看详细输出
pytest tests/e2e/test_*.py -v
```

## 📖 参考文档

- [Pytest文档](https://docs.pytest.org/)
- [Vitest文档](https://vitest.dev/)
- [FastAPI测试文档](https://fastapi.tiangolo.com/tutorial/testing/)

