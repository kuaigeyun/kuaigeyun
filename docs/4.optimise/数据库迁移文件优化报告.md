# 数据库迁移文件优化报告

**生成时间**: 2025-12-31  
**优化范围**: `riveredge-backend/migrations/models/` 目录下的迁移文件

## 📋 执行摘要

本报告对 RiverEdge SaaS 项目的数据库迁移文件进行了全面检查，发现了序列命名不一致、索引命名不规范、外键约束缺失等问题，并提供了优化方案。

## 🔍 问题分析

### 1. 序列命名不一致问题 ⚠️ **高优先级**

**问题描述**：
迁移文件中存在大量序列命名与表名不匹配的情况，这是历史表名变更导致的遗留问题。

**具体问题**：

| 序列名称 | 表名 | 问题 |
|---------|------|------|
| `seed_master_data_bom_id_seq` | `apps_master_data_bom` | 序列使用 `seed_` 前缀，表名使用 `apps_` 前缀 |
| `root_apis_id_seq` | `core_apis` | 序列使用 `root_` 前缀，表名使用 `core_` 前缀 |
| `sys_code_rules_id_seq` | `core_code_rules` | 序列使用 `sys_` 前缀，表名使用 `core_` 前缀 |
| `soil_packages_id_seq` | `infra_packages` | 序列使用 `soil_` 前缀，表名使用 `infra_` 前缀 |
| `soil_platform_superadmin_id_seq` | `infra_superadmin` | 序列使用 `soil_` 前缀，表名使用 `infra_` 前缀 |

**影响**：
- 命名不一致导致代码可读性差
- 维护困难，容易混淆
- 不符合项目命名规范

**统计**：
- 受影响的序列：约 63 个
- 涉及的表：约 64 个

### 2. 索引命名不规范问题 ⚠️ **中优先级**

**问题描述**：
部分索引使用随机哈希后缀，命名不够清晰，难以理解索引用途。

**具体问题**：

```sql
-- ❌ 不规范的索引命名
CREATE INDEX IF NOT EXISTS "idx_apps_kuaizh_tenant__962143" ON "apps_kuaizhizao_work_orders" ("tenant_id");
CREATE INDEX IF NOT EXISTS "idx_apps_kuaizh_code_56c467" ON "apps_kuaizhizao_work_orders" ("code");
CREATE INDEX IF NOT EXISTS "idx_core_applic_code_a1b2c4" ON "core_applications" ("code");
```

**建议的命名规范**：

```sql
-- ✅ 规范的索引命名
CREATE INDEX IF NOT EXISTS "idx_apps_kuaizhizao_work_orders_tenant_id" ON "apps_kuaizhizao_work_orders" ("tenant_id");
CREATE INDEX IF NOT EXISTS "idx_apps_kuaizhizao_work_orders_code" ON "apps_kuaizhizao_work_orders" ("code");
CREATE INDEX IF NOT EXISTS "idx_core_applications_code" ON "core_applications" ("code");
```

**影响**：
- 索引用途不清晰
- 维护和调试困难
- 不符合命名规范

**统计**：
- 受影响的索引：约 50+ 个（主要在 `1_20251230192227_create_kuaizhizao_tables.py` 中）

### 3. 外键约束缺失问题 ⚠️ **高优先级**

**问题描述**：
迁移文件中大部分表之间有关联关系，但缺少外键约束定义，影响数据完整性和查询性能。

**具体问题**：

**已定义外键的表**：
- `apps_kuaizhizao_purchase_order_items.order_id` → `apps_kuaizhizao_purchase_orders.id` (ON DELETE CASCADE)

**缺少外键约束的表**（示例）：

| 表名 | 字段 | 应关联的表 | 应关联的字段 |
|------|------|-----------|-------------|
| `apps_master_data_bom` | `material_id` | `apps_master_data_materials` | `id` |
| `apps_master_data_bom` | `component_id` | `apps_master_data_materials` | `id` |
| `apps_master_data_materials` | `group_id` | `apps_master_data_material_groups` | `id` |
| `apps_master_data_production_lines` | `workshop_id` | `apps_master_data_workshops` | `id` |
| `apps_master_data_workstations` | `production_line_id` | `apps_master_data_production_lines` | `id` |
| `core_users` | `department_id` | `core_departments` | `id` |
| `core_users` | `position_id` | `core_positions` | `id` |
| `core_menus` | `parent_id` | `core_menus` | `id` |
| `core_role_permissions` | `role_id` | `core_roles` | `id` |
| `core_role_permissions` | `permission_id` | `core_permissions` | `id` |
| `core_user_roles` | `user_id` | `core_users` | `id` |
| `core_user_roles` | `role_id` | `core_roles` | `id` |

**影响**：
- 数据完整性无法保证（可能出现孤立记录）
- 查询性能可能受影响（无法利用外键索引）
- 级联删除/更新无法自动执行

**统计**：
- 缺少外键约束的关系：约 100+ 个

### 4. 索引优化问题 ⚠️ **中优先级**

**问题描述**：
部分常用查询字段可能缺少索引，或复合索引顺序不够优化。

**具体问题**：

**缺少索引的字段**（示例）：
- `apps_master_data_bom.approved_by` - 审批人查询
- `apps_master_data_bom.approved_at` - 审批时间查询
- `core_approval_instances.current_approver_id` - 当前审批人查询
- `core_operation_logs.operation_object_id` - 操作对象查询

**复合索引优化建议**：
- `(tenant_id, deleted_at, created_at)` - 用于软删除查询
- `(tenant_id, status, created_at)` - 用于状态+时间查询
- `(tenant_id, is_active, sort_order)` - 用于列表排序查询

**影响**：
- 查询性能可能受影响
- 大数据量时查询变慢

### 5. 归档文件管理问题 ⚠️ **低优先级**

**问题描述**：
`archive_backup_20251227_132407/` 目录下存在大量过期迁移文件（62个），占用空间且可能造成混淆。

**建议**：
- 将归档文件压缩备份
- 或移动到专门的归档目录
- 更新 `.gitignore` 排除归档文件

## 🎯 优化方案

### 方案1：序列命名统一化

**目标**：统一序列命名，使其与表名保持一致。

**步骤**：

1. **创建序列重命名迁移文件**：
   ```sql
   -- 重命名序列以匹配表名
   ALTER SEQUENCE IF EXISTS "seed_master_data_bom_id_seq" RENAME TO "apps_master_data_bom_id_seq";
   ALTER SEQUENCE IF EXISTS "root_apis_id_seq" RENAME TO "core_apis_id_seq";
   ALTER SEQUENCE IF EXISTS "sys_code_rules_id_seq" RENAME TO "core_code_rules_id_seq";
   ALTER SEQUENCE IF EXISTS "soil_packages_id_seq" RENAME TO "infra_packages_id_seq";
   -- ... 更多序列重命名
   ```

2. **更新表定义中的序列引用**：
   ```sql
   -- 更新表定义
   ALTER TABLE "apps_master_data_bom" 
     ALTER COLUMN "id" SET DEFAULT nextval('apps_master_data_bom_id_seq'::regclass);
   ```

3. **创建迁移文件**：
   - 文件名：`2_20251230_rename_sequences_to_match_tables.py`
   - 包含所有序列重命名操作

**优先级**：高  
**工作量**：中等（需要创建迁移脚本）

### 方案2：索引命名规范化

**目标**：统一索引命名规范，使用有意义的名称。

**命名规范**：
- 普通索引：`idx_{表名}_{字段名}`
- 唯一索引：`uk_{表名}_{字段名}` 或 `uk_{表名}_{字段1}_{字段2}`
- 复合索引：`idx_{表名}_{字段1}_{字段2}`

**步骤**：

1. **创建索引重命名迁移文件**：
   ```sql
   -- 重命名索引
   DROP INDEX IF EXISTS "idx_apps_kuaizh_tenant__962143";
   CREATE INDEX IF NOT EXISTS "idx_apps_kuaizhizao_work_orders_tenant_id" 
     ON "apps_kuaizhizao_work_orders" ("tenant_id");
   
   DROP INDEX IF EXISTS "idx_apps_kuaizh_code_56c467";
   CREATE INDEX IF NOT EXISTS "idx_apps_kuaizhizao_work_orders_code" 
     ON "apps_kuaizhizao_work_orders" ("code");
   -- ... 更多索引重命名
   ```

2. **创建迁移文件**：
   - 文件名：`3_20251230_rename_indexes_to_standard_naming.py`
   - 包含所有索引重命名操作

**优先级**：中  
**工作量**：中等（需要创建迁移脚本）

### 方案3：添加外键约束

**目标**：为所有关联关系添加外键约束，提升数据完整性。

**步骤**：

1. **分析模型关系**：
   - 检查 Tortoise ORM 模型定义中的 `ForeignKeyField`
   - 识别所有需要外键约束的关系

2. **创建外键约束迁移文件**：
   ```sql
   -- 添加外键约束
   ALTER TABLE "apps_master_data_bom"
     ADD CONSTRAINT "fk_apps_master_data_bom_material_id"
     FOREIGN KEY ("material_id") 
     REFERENCES "apps_master_data_materials" ("id") 
     ON DELETE RESTRICT 
     ON UPDATE CASCADE;
   
   ALTER TABLE "apps_master_data_bom"
     ADD CONSTRAINT "fk_apps_master_data_bom_component_id"
     FOREIGN KEY ("component_id") 
     REFERENCES "apps_master_data_materials" ("id") 
     ON DELETE RESTRICT 
     ON UPDATE CASCADE;
   
   -- ... 更多外键约束
   ```

3. **外键约束策略**：
   - **ON DELETE RESTRICT**：防止删除被引用的记录（默认）
   - **ON DELETE CASCADE**：级联删除（用于明细表）
   - **ON DELETE SET NULL**：设置为 NULL（用于可选关联）
   - **ON UPDATE CASCADE**：级联更新（用于主键更新）

4. **创建迁移文件**：
   - 文件名：`4_20251230_add_foreign_key_constraints.py`
   - 包含所有外键约束定义

**优先级**：高  
**工作量**：大（需要分析所有关系，创建大量约束）

### 方案4：索引优化

**目标**：添加缺失索引，优化复合索引顺序。

**步骤**：

1. **分析常用查询**：
   - 检查业务代码中的常用查询模式
   - 识别缺少索引的字段

2. **创建索引优化迁移文件**：
   ```sql
   -- 添加缺失索引
   CREATE INDEX IF NOT EXISTS "idx_apps_master_data_bom_approved_by" 
     ON "apps_master_data_bom" ("approved_by");
   
   CREATE INDEX IF NOT EXISTS "idx_apps_master_data_bom_approved_at" 
     ON "apps_master_data_bom" ("approved_at");
   
   -- 优化复合索引
   CREATE INDEX IF NOT EXISTS "idx_core_menus_tenant_active_sort" 
     ON "core_menus" ("tenant_id", "is_active", "sort_order");
   
   -- ... 更多索引优化
   ```

3. **创建迁移文件**：
   - 文件名：`5_20251230_optimize_indexes.py`
   - 包含所有索引优化操作

**优先级**：中  
**工作量**：中等（需要分析查询模式）

### 方案5：清理归档文件

**目标**：清理过期迁移文件，保持迁移目录整洁。

**步骤**：

1. **压缩归档文件**：
   ```bash
   cd riveredge-backend/migrations
   tar -czf archive_backup_20251227_132407.tar.gz archive_backup_20251227_132407/
   ```

2. **移动到归档目录**：
   ```bash
   mkdir -p ../archive/migrations
   mv archive_backup_20251227_132407.tar.gz ../archive/migrations/
   ```

3. **删除原始目录**：
   ```bash
   rm -rf archive_backup_20251227_132407/
   ```

4. **更新 `.gitignore`**：
   ```
   # 迁移归档文件
   migrations/archive_backup_*/
   ```

**优先级**：低  
**工作量**：小

## 📊 优化优先级排序

| 优先级 | 方案 | 影响 | 工作量 | 建议执行时间 |
|--------|------|------|--------|------------|
| 🔴 高 | 方案1：序列命名统一化 | 高 | 中等 | 立即执行 |
| 🔴 高 | 方案3：添加外键约束 | 高 | 大 | 立即执行 |
| 🟡 中 | 方案2：索引命名规范化 | 中 | 中等 | 近期执行 |
| 🟡 中 | 方案4：索引优化 | 中 | 中等 | 近期执行 |
| 🟢 低 | 方案5：清理归档文件 | 低 | 小 | 随时执行 |

## 🚀 实施建议

### 阶段1：立即执行（本周）

1. **序列命名统一化**
   - 创建迁移文件 `2_20251230_rename_sequences_to_match_tables.py`
   - 测试迁移脚本
   - 执行迁移

2. **添加关键外键约束**
   - 优先添加核心表的外键约束（用户、角色、权限等）
   - 创建迁移文件 `4_20251230_add_foreign_key_constraints.py`
   - 分批次执行，避免一次性添加过多约束

### 阶段2：近期执行（下周）

3. **索引命名规范化**
   - 创建迁移文件 `3_20251230_rename_indexes_to_standard_naming.py`
   - 执行迁移

4. **索引优化**
   - 分析常用查询模式
   - 创建迁移文件 `5_20251230_optimize_indexes.py`
   - 执行迁移

### 阶段3：随时执行

5. **清理归档文件**
   - 压缩归档文件
   - 移动到归档目录
   - 更新 `.gitignore`

## ⚠️ 注意事项

1. **备份数据库**：
   - 执行任何迁移前，必须备份数据库
   - 建议使用 `pg_dump` 创建完整备份

2. **测试环境验证**：
   - 所有迁移必须在测试环境验证
   - 确保迁移脚本可以回滚

3. **分批次执行**：
   - 外键约束添加应分批次执行
   - 避免一次性添加过多约束导致锁表时间过长

4. **监控性能**：
   - 执行迁移后监控数据库性能
   - 检查索引使用情况

5. **文档更新**：
   - 更新迁移文档
   - 记录所有变更

## 📝 迁移文件清单

### 已创建并执行的迁移文件

1. ✅ `2_20251231_rename_sequences_to_match_tables.py` - 序列重命名（已完成并执行）
   - 重命名 63 个序列以匹配表名
   - 更新所有表定义中的序列引用
   - 包含完整的升级和降级脚本
   - **执行状态**: ✅ 已在测试环境成功执行

2. ✅ `3_20250101_add_foreign_key_constraints.py` - 添加外键约束（已完成）
   - 为系统级 (core_*) 表添加外键约束
   - 为应用级主数据 (apps_master_data_*) 表添加外键约束
   - 使用幂等性检查，确保迁移可安全重复执行
   - 包含完整的升级和降级脚本
   - **执行状态**: ⏳ 待执行

3. ✅ `4_20250101_add_composite_indexes.py` - 添加复合索引（已完成）
   - 为系统级 (core_*) 表添加复合索引
   - 为应用级主数据 (apps_master_data_*) 表添加复合索引
   - 优化常用组合查询的性能
   - 使用幂等性检查，确保迁移可安全重复执行
   - 包含完整的升级和降级脚本
   - **执行状态**: ⏳ 待执行

### 现有迁移文件

1. `0_init_schema.py` - 初始数据库结构
2. `1_20251230192227_create_kuaizhizao_tables.py` - 快智造表创建

## 🔗 相关文档

- [Aerich 数据库迁移规范](../2.rules/8.Aerich数据库迁移规范.md)
- [统一命名规范](../2.rules/1.统一命名规范.md)
- [数据库设计文档](../1.stack/项目结构.md)

## ✅ 执行完成情况

### 已完成的任务

1. ✅ **序列命名统一化** (2025-12-31)
   - 创建迁移文件 `2_20251231_rename_sequences_to_match_tables.py`
   - 重命名 63 个序列以匹配表名
   - 已在测试环境成功执行
   - 使用幂等性检查，确保迁移可安全重复执行

2. ✅ **添加外键约束** (2025-01-01)
   - 创建迁移文件 `3_20250101_add_foreign_key_constraints.py`
   - 为系统级和应用级主数据表添加外键约束
   - 提升数据完整性
   - 使用幂等性检查，确保迁移可安全重复执行

3. ✅ **优化复合索引** (2025-01-01)
   - 创建迁移文件 `4_20250101_add_composite_indexes.py`
   - 为常用组合查询添加复合索引
   - 优化查询性能
   - 使用幂等性检查，确保迁移可安全重复执行

4. ✅ **清理归档文件** (2025-01-01)
   - 删除过期备份目录 `archive_backup_20251227_132407/`
   - 删除过期备份目录 `models_backup_20251230_190506/`
   - 保持迁移目录整洁

### 已完成的任务（更新）

1. ✅ **执行外键约束迁移** - 已在测试环境成功执行 `3_20250101_000000_add_foreign_key_constraints.py`
2. ✅ **执行复合索引迁移** - 已在测试环境成功执行 `4_20250101_000000_add_composite_indexes.py`
3. ✅ **添加主键约束** - 已在测试环境成功执行 `2_20250101_235959_add_primary_keys.py`
4. ✅ **清理孤立记录** - 已在测试环境成功执行 `2_20250101_235960_cleanup_orphaned_records.py`

### 待执行的任务

1. ⏳ **添加 kuaizhizao 表的外键约束** - 创建迁移文件 `5_20250101_000000_add_kuaizhizao_foreign_keys.py`
2. ⏳ **重命名 kuaizhizao 表的索引** - 创建迁移文件 `6_20250101_000000_rename_kuaizhizao_indexes.py`（可选，低优先级）
3. ⏳ **添加 kuaizhizao 表的复合索引** - 创建迁移文件 `7_20250101_000000_add_kuaizhizao_composite_indexes.py`（可选，低优先级）
4. ⏳ **生产环境部署** - 在测试环境验证通过后，部署到生产环境

## 📅 更新记录

- **2025-12-31**: 创建初始优化报告
- **2025-12-31**: 完成序列命名统一化迁移文件 `2_20251231_rename_sequences_to_match_tables.py`
- **2025-12-31**: 序列命名统一化迁移在测试环境成功执行
- **2025-01-01**: 完成外键约束迁移文件 `3_20250101_add_foreign_key_constraints.py`
- **2025-01-01**: 完成复合索引优化迁移文件 `4_20250101_add_composite_indexes.py`
- **2025-01-01**: 清理归档的过期迁移文件

---

**报告生成者**: Auto (AI Assistant)  
**审核状态**: 待审核  
**执行状态**: 核心优化已完成（序列命名统一化、主键约束、数据清理、外键约束、复合索引均已执行），kuaizhizao 表的外键约束待添加

**详细检查清单**: 请参考 [数据库迁移优化检查清单](./数据库迁移优化检查清单.md)

