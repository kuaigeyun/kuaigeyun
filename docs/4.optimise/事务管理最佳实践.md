# äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ

**æœ€åæ›´æ–°ï¼š** 2025-01-01

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†RiverEdge SaaSæ¡†æ¶ä¸­äº‹åŠ¡ç®¡ç†çš„æœ€ä½³å®è·µï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚

## ğŸ¯ äº‹åŠ¡ç®¡ç†åŸåˆ™

### 1. äº‹åŠ¡è¾¹ç•ŒåŸåˆ™

**åŸåˆ™ï¼š** äº‹åŠ¡åº”è¯¥å°½å¯èƒ½å°ï¼ŒåªåŒ…å«å¿…è¦çš„æ•°æ®åº“æ“ä½œã€‚

**æœ€ä½³å®è·µï¼š**
- âœ… å•ä¸ªä¸šåŠ¡æ“ä½œåº”è¯¥åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆ
- âœ… é¿å…åœ¨äº‹åŠ¡ä¸­è¿›è¡Œé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼ˆå¦‚å¤–éƒ¨APIè°ƒç”¨ã€æ–‡ä»¶IOç­‰ï¼‰
- âœ… äº‹åŠ¡åº”è¯¥åªåŒ…å«æ•°æ®åº“æ“ä½œï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘è®¡ç®—

**ç¤ºä¾‹ï¼š**

```python
# âœ… æ­£ç¡®ï¼šäº‹åŠ¡åªåŒ…å«æ•°æ®åº“æ“ä½œ
async def create_work_order(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        # ç”Ÿæˆç¼–ç ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
        code = await self.generate_code(tenant_id, "WORK_ORDER_CODE")
        
        # åˆ›å»ºå·¥å•ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
        work_order = await WorkOrder.create(
            tenant_id=tenant_id,
            work_order_code=code,
            **order_data.model_dump()
        )
        
        return WorkOrderResponse.model_validate(work_order)

# âŒ é”™è¯¯ï¼šäº‹åŠ¡ä¸­åŒ…å«å¤–éƒ¨APIè°ƒç”¨
async def create_work_order_wrong(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        # å¤–éƒ¨APIè°ƒç”¨ä¸åº”è¯¥åœ¨äº‹åŠ¡ä¸­
        external_data = await external_api.get_data()  # âŒ ä¸åº”è¯¥åœ¨äº‹åŠ¡ä¸­
        
        work_order = await WorkOrder.create(...)
        return WorkOrderResponse.model_validate(work_order)
```

### 2. äº‹åŠ¡åµŒå¥—åŸåˆ™

**åŸåˆ™ï¼š** é¿å…äº‹åŠ¡åµŒå¥—ï¼Œå¦‚æœå¿…é¡»åµŒå¥—ï¼Œç¡®ä¿å¤–å±‚äº‹åŠ¡èƒ½å¤Ÿæ­£ç¡®å¤„ç†å†…å±‚äº‹åŠ¡çš„å›æ»šã€‚

**æœ€ä½³å®è·µï¼š**
- âœ… ä½¿ç”¨å•ä¸€äº‹åŠ¡å¤„ç†å•ä¸ªä¸šåŠ¡æ“ä½œ
- âœ… å¦‚æœéœ€è¦åœ¨å¤šä¸ªæœåŠ¡æ–¹æ³•ä¸­å…±äº«äº‹åŠ¡ï¼Œä½¿ç”¨äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- âŒ é¿å…åœ¨å·²ç»å¤„äºäº‹åŠ¡ä¸­çš„ä»£ç ä¸­å†æ¬¡å¼€å¯äº‹åŠ¡

**ç¤ºä¾‹ï¼š**

```python
# âœ… æ­£ç¡®ï¼šå•ä¸€äº‹åŠ¡
async def create_work_order(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        work_order = await WorkOrder.create(...)
        return WorkOrderResponse.model_validate(work_order)

# âŒ é”™è¯¯ï¼šäº‹åŠ¡åµŒå¥—
async def create_work_order_wrong(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        work_order = await WorkOrder.create(...)
        
        # âŒ ä¸åº”è¯¥åœ¨äº‹åŠ¡ä¸­å†æ¬¡å¼€å¯äº‹åŠ¡
        async with in_transaction():
            await self.update_related_data(work_order.id)
        
        return WorkOrderResponse.model_validate(work_order)
```

### 3. å¼‚å¸¸å¤„ç†åŸåˆ™

**åŸåˆ™ï¼š** äº‹åŠ¡ä¸­çš„å¼‚å¸¸åº”è¯¥è¢«æ­£ç¡®å¤„ç†ï¼Œç¡®ä¿äº‹åŠ¡èƒ½å¤Ÿæ­£ç¡®å›æ»šã€‚

**æœ€ä½³å®è·µï¼š**
- âœ… åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨try-exceptæ•è·å¼‚å¸¸
- âœ… è®©å¼‚å¸¸è‡ªç„¶ä¼ æ’­ï¼ŒTortoise ORMä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡
- âœ… ä¸è¦åœ¨äº‹åŠ¡ä¸­æ•è·å¼‚å¸¸åç»§ç»­æ‰§è¡Œï¼Œé™¤éæ˜ç¡®çŸ¥é“å¦‚ä½•å¤„ç†

**ç¤ºä¾‹ï¼š**

```python
# âœ… æ­£ç¡®ï¼šè®©å¼‚å¸¸è‡ªç„¶ä¼ æ’­
async def create_work_order(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        # å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
        work_order = await WorkOrder.create(...)
        return WorkOrderResponse.model_validate(work_order)

# âœ… æ­£ç¡®ï¼šæ•è·å¼‚å¸¸å¹¶é‡æ–°æŠ›å‡º
async def create_work_order_with_validation(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        try:
            work_order = await WorkOrder.create(...)
            return WorkOrderResponse.model_validate(work_order)
        except ValidationError:
            # é‡æ–°æŠ›å‡ºï¼Œè®©äº‹åŠ¡å›æ»š
            raise

# âŒ é”™è¯¯ï¼šæ•è·å¼‚å¸¸åç»§ç»­æ‰§è¡Œ
async def create_work_order_wrong(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        try:
            work_order = await WorkOrder.create(...)
        except Exception as e:
            # âŒ æ•è·å¼‚å¸¸åç»§ç»­æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
            logger.error(f"Error: {e}")
        
        # âŒ å³ä½¿åˆ›å»ºå¤±è´¥ï¼Œè¿™é‡Œä¹Ÿä¼šæ‰§è¡Œ
        return work_order
```

## ğŸ”§ äº‹åŠ¡ä½¿ç”¨è§„èŒƒ

### 1. ä½¿ç”¨ `in_transaction()` ä¸Šä¸‹æ–‡ç®¡ç†å™¨

**è§„èŒƒï¼š** æ‰€æœ‰éœ€è¦äº‹åŠ¡çš„æ“ä½œéƒ½åº”è¯¥ä½¿ç”¨ `in_transaction()` ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚

**å¯¼å…¥ï¼š**
```python
from tortoise.transactions import in_transaction
```

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
async def create_record(self, tenant_id: int, data: CreateSchema, created_by: int):
    async with in_transaction():
        # æ•°æ®åº“æ“ä½œ
        record = await Model.create(...)
        return ResponseSchema.model_validate(record)
```

### 2. äº‹åŠ¡ä¸­çš„æ“ä½œé¡ºåº

**è§„èŒƒï¼š** äº‹åŠ¡ä¸­çš„æ“ä½œåº”è¯¥æŒ‰ç…§é€»è¾‘é¡ºåºæ‰§è¡Œï¼Œå…ˆéªŒè¯ï¼Œå†åˆ›å»º/æ›´æ–°ã€‚

**æœ€ä½³å®è·µï¼š**
1. éªŒè¯è¾“å…¥æ•°æ®
2. éªŒè¯ä¸šåŠ¡è§„åˆ™
3. æ‰§è¡Œæ•°æ®åº“æ“ä½œ
4. è¿”å›ç»“æœ

**ç¤ºä¾‹ï¼š**

```python
async def create_work_order(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        # 1. éªŒè¯è¾“å…¥æ•°æ®
        if order_data.quantity <= 0:
            raise ValidationError("æ•°é‡å¿…é¡»å¤§äº0")
        
        # 2. éªŒè¯ä¸šåŠ¡è§„åˆ™
        material = await Material.get_or_none(id=order_data.material_id)
        if not material:
            raise NotFoundError("ç‰©æ–™ä¸å­˜åœ¨")
        
        # 3. æ‰§è¡Œæ•°æ®åº“æ“ä½œ
        code = await self.generate_code(tenant_id, "WORK_ORDER_CODE")
        work_order = await WorkOrder.create(
            tenant_id=tenant_id,
            work_order_code=code,
            **order_data.model_dump()
        )
        
        # 4. è¿”å›ç»“æœ
        return WorkOrderResponse.model_validate(work_order)
```

### 3. äº‹åŠ¡ä¸­çš„æ‰¹é‡æ“ä½œ

**è§„èŒƒï¼š** æ‰¹é‡æ“ä½œåº”è¯¥åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œç¡®ä¿åŸå­æ€§ã€‚

**ç¤ºä¾‹ï¼š**

```python
async def create_work_order_with_items(self, tenant_id: int, order_data: WorkOrderCreate, created_by: int):
    async with in_transaction():
        # åˆ›å»ºå·¥å•
        work_order = await WorkOrder.create(...)
        
        # æ‰¹é‡åˆ›å»ºæ˜ç»†
        items = []
        for item_data in order_data.items:
            item = await WorkOrderItem.create(
                work_order_id=work_order.id,
                **item_data.model_dump()
            )
            items.append(item)
        
        return WorkOrderResponse.model_validate(work_order)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸è¦åœ¨äº‹åŠ¡ä¸­è¿›è¡Œé•¿æ—¶é—´æ“ä½œ

**é—®é¢˜ï¼š** äº‹åŠ¡ä¼šé”å®šæ•°æ®åº“èµ„æºï¼Œé•¿æ—¶é—´æ“ä½œä¼šå¯¼è‡´å…¶ä»–æ“ä½œç­‰å¾…ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- å°†é•¿æ—¶é—´æ“ä½œç§»åˆ°äº‹åŠ¡å¤–
- ä½¿ç”¨å¼‚æ­¥æ“ä½œå¤„ç†å¤–éƒ¨APIè°ƒç”¨
- ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†è€—æ—¶ä»»åŠ¡

### 2. ä¸è¦åœ¨äº‹åŠ¡ä¸­è°ƒç”¨å¤–éƒ¨æœåŠ¡

**é—®é¢˜ï¼š** å¤–éƒ¨æœåŠ¡å¯èƒ½å¤±è´¥æˆ–å“åº”æ…¢ï¼Œå¯¼è‡´äº‹åŠ¡é•¿æ—¶é—´å ç”¨èµ„æºã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨äº‹åŠ¡å‰è°ƒç”¨å¤–éƒ¨æœåŠ¡
- ä½¿ç”¨è¡¥å¿äº‹åŠ¡å¤„ç†å¤–éƒ¨æœåŠ¡å¤±è´¥
- ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†å¤–éƒ¨æœåŠ¡è°ƒç”¨

### 3. é¿å…æ­»é”

**é—®é¢˜ï¼š** å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®ç›¸åŒèµ„æºå¯èƒ½å¯¼è‡´æ­»é”ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- æŒ‰ç…§å›ºå®šé¡ºåºè®¿é—®èµ„æº
- ä½¿ç”¨è¶…æ—¶æœºåˆ¶
- ä½¿ç”¨ä¹è§‚é”æˆ–æ‚²è§‚é”

## ğŸ“ ç¤ºä¾‹ä»£ç 

### å®Œæ•´çš„æœåŠ¡æ–¹æ³•ç¤ºä¾‹

```python
from tortoise.transactions import in_transaction
from apps.base_service import AppBaseService
from infra.exceptions.exceptions import NotFoundError, ValidationError

class WorkOrderService(AppBaseService[WorkOrder]):
    """å·¥å•æœåŠ¡"""
    
    def __init__(self):
        super().__init__(WorkOrder)
    
    async def create_work_order(
        self,
        tenant_id: int,
        order_data: WorkOrderCreate,
        created_by: int
    ) -> WorkOrderResponse:
        """
        åˆ›å»ºå·¥å•
        
        Args:
            tenant_id: ç§Ÿæˆ·ID
            order_data: å·¥å•åˆ›å»ºæ•°æ®
            created_by: åˆ›å»ºäººID
            
        Returns:
            WorkOrderResponse: åˆ›å»ºçš„å·¥å•ä¿¡æ¯
            
        Raises:
            ValidationError: æ•°æ®éªŒè¯å¤±è´¥
            NotFoundError: ç›¸å…³èµ„æºä¸å­˜åœ¨
        """
        async with in_transaction():
            # 1. éªŒè¯è¾“å…¥æ•°æ®
            if order_data.quantity <= 0:
                raise ValidationError("æ•°é‡å¿…é¡»å¤§äº0")
            
            # 2. éªŒè¯ä¸šåŠ¡è§„åˆ™
            material = await Material.get_or_none(
                id=order_data.material_id,
                tenant_id=tenant_id
            )
            if not material:
                raise NotFoundError(f"ç‰©æ–™ä¸å­˜åœ¨: {order_data.material_id}")
            
            # 3. è·å–ç”¨æˆ·ä¿¡æ¯
            user_name = await self.get_user_name(created_by)
            
            # 4. ç”Ÿæˆç¼–ç 
            code = await self.generate_code(
                tenant_id,
                "WORK_ORDER_CODE",
                prefix=f"WO{datetime.now().strftime('%Y%m%d')}"
            )
            
            # 5. åˆ›å»ºå·¥å•
            work_order = await WorkOrder.create(
                tenant_id=tenant_id,
                work_order_code=code,
                created_by=created_by,
                created_by_name=user_name,
                **order_data.model_dump(exclude_unset=True)
            )
            
            # 6. è¿”å›ç»“æœ
            return WorkOrderResponse.model_validate(work_order)
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [AppBaseServiceä½¿ç”¨æŒ‡å—](./åº”ç”¨çº§APPä»£ç ä¼˜åŒ–å®æ–½æŠ¥å‘Š-æœ€ç»ˆç‰ˆ.md)
- [å¼‚å¸¸å¤„ç†è§„èŒƒ](../3.build/4.sys-app%20dev/æ–°åº”ç”¨åˆ›å»ºæµç¨‹.md)

---

**æœ€åæ›´æ–°ï¼š** 2025-01-01  
**ä½œè€…ï¼š** Auto (AI Assistant)

