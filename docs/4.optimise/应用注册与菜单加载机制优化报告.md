# åº”ç”¨æ³¨å†Œä¸èœå•åŠ è½½æœºåˆ¶ä¼˜åŒ–æŠ¥å‘Š

**ä¼˜åŒ–æ—¥æœŸ**: 2025-12-31  
**ä¼˜åŒ–èŒƒå›´**: åº”ç”¨çº§APPæ³¨å†Œæœºåˆ¶ã€èœå•åŠ è½½æœºåˆ¶ã€ç¡¬ç¼–ç é—®é¢˜ä¿®å¤

---

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦è§£å†³äº†åº”ç”¨æ³¨å†Œå’Œèœå•åŠ è½½æœºåˆ¶ä¸­çš„ç¡¬ç¼–ç é—®é¢˜ï¼Œç¡®ä¿ç³»ç»Ÿå®Œå…¨é€šè¿‡åº”ç”¨åŠ è½½æœåŠ¡åŠ¨æ€ç®¡ç†APPï¼Œä¸å†ä¾èµ–ç¡¬ç¼–ç çš„åº”ç”¨åˆ—è¡¨ã€‚

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. ä¿®å¤åº”ç”¨æ³¨å†ŒæœåŠ¡ä¸­çš„ç¡¬ç¼–ç é—®é¢˜

#### é—®é¢˜æè¿°
`application_registry_service.py` åœ¨æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤åº”ç”¨åˆ—è¡¨ä½œä¸ºå›é€€æ–¹æ¡ˆã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ
- **ç§»é™¤ç¡¬ç¼–ç åº”ç”¨åˆ—è¡¨**
- **å®ç°åŠ¨æ€åº”ç”¨å‘ç°æœºåˆ¶**ï¼šå½“æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨ä»æ–‡ä»¶ç³»ç»Ÿæ‰«æ `apps` ç›®å½•ï¼Œè¯»å–æ‰€æœ‰åº”ç”¨çš„ `manifest.json` æ–‡ä»¶
- **ä½¿ç”¨ ApplicationService._scan_plugin_manifests()** æ–¹æ³•è‡ªåŠ¨å‘ç°åº”ç”¨

#### ä¿®æ”¹æ–‡ä»¶
- `riveredge-backend/src/core/services/application/application_registry_service.py`

#### ä¿®æ”¹å†…å®¹
```python
# ä¼˜åŒ–å‰ï¼šç¡¬ç¼–ç é»˜è®¤åº”ç”¨åˆ—è¡¨
apps = [
    {
        "uuid": "master-data-uuid",
        "code": "master-data",
        "name": "ä¸»æ•°æ®ç®¡ç†",
        ...
    },
    {
        "uuid": "kuaizhizao-uuid",
        "code": "kuaizhizao",
        "name": "å¿«æ ¼è½»åˆ¶é€ ",
        ...
    }
]

# ä¼˜åŒ–åï¼šåŠ¨æ€æ‰«æåº”ç”¨ç›®å½•
from core.services.application.application_service import ApplicationService
discovered_plugins = ApplicationService._scan_plugin_manifests()

for manifest in discovered_plugins:
    app_code = manifest.get('code')
    if not app_code:
        continue
    
    apps.append({
        "uuid": f"{app_code}-fallback-uuid",
        "code": app_code,
        "name": manifest.get('name', app_code),
        "description": manifest.get('description', ''),
        "version": manifest.get('version', '1.0.0'),
        "route_path": manifest.get('route_path', f"/apps/{app_code}"),
        "entry_point": manifest.get('entry_point', f"apps.{app_code.replace('-', '_')}.api.router"),
        "menu_config": manifest.get('menu_config'),
        ...
    })
```

### 2. ä¿®å¤åº”ç”¨æœåŠ¡ä¸­çš„ç¡¬ç¼–ç ç³»ç»Ÿå†…ç½®åº”ç”¨åˆ—è¡¨

#### é—®é¢˜æè¿°
`application_service.py` ä¸­ç¡¬ç¼–ç äº†ç³»ç»Ÿå†…ç½®åº”ç”¨åˆ—è¡¨ `['master-data', 'kuaizhizao']`ï¼Œç”¨äºåˆ¤æ–­åº”ç”¨æ˜¯å¦åº”è¯¥è‡ªåŠ¨å®‰è£…ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ
- **ç§»é™¤ç¡¬ç¼–ç åº”ç”¨åˆ—è¡¨**
- **è‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿå†…ç½®åº”ç”¨**ï¼šæ‰€æœ‰åœ¨ `src/apps` ç›®å½•ä¸‹å­˜åœ¨ `manifest.json` çš„åº”ç”¨éƒ½è§†ä¸ºç³»ç»Ÿå†…ç½®åº”ç”¨ï¼Œè‡ªåŠ¨å®‰è£…

#### ä¿®æ”¹æ–‡ä»¶
- `riveredge-backend/src/core/services/application/application_service.py`

#### ä¿®æ”¹å†…å®¹
```python
# ä¼˜åŒ–å‰ï¼šç¡¬ç¼–ç ç³»ç»Ÿå†…ç½®åº”ç”¨åˆ—è¡¨
builtin_apps = ['master-data', 'kuaizhizao']  # ç³»ç»Ÿå†…ç½®åº”ç”¨åˆ—è¡¨
should_auto_install = code in builtin_apps

# ä¼˜åŒ–åï¼šè‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿå†…ç½®åº”ç”¨
# é€šè¿‡æ‰«æ apps ç›®å½•è‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿå†…ç½®åº”ç”¨ï¼Œä¸å†ç¡¬ç¼–ç 
# å¦‚æœåº”ç”¨åœ¨ src/apps ç›®å½•ä¸‹å­˜åœ¨ manifest.jsonï¼Œåˆ™è®¤ä¸ºæ˜¯ç³»ç»Ÿå†…ç½®åº”ç”¨
should_auto_install = True  # æ‰€æœ‰æ‰«æåˆ°çš„åº”ç”¨éƒ½è§†ä¸ºç³»ç»Ÿå†…ç½®åº”ç”¨ï¼Œè‡ªåŠ¨å®‰è£…
```

### 3. ä¿®å¤åŠ¨æ€é…ç½®æœåŠ¡ä¸­çš„ç¡¬ç¼–ç åº”ç”¨åˆ—è¡¨

#### é—®é¢˜æè¿°
`dynamic_config_service.py` ä¸­æœ‰ä¸¤å¤„ç¡¬ç¼–ç çš„å›é€€æ–¹æ¡ˆï¼Œä½¿ç”¨ `['master-data']` ä½œä¸ºé»˜è®¤åº”ç”¨åˆ—è¡¨ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ
- **ç§»é™¤ç¡¬ç¼–ç åº”ç”¨åˆ—è¡¨**
- **å®ç°åŠ¨æ€åº”ç”¨å‘ç°**ï¼šå½“æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨ä»æ–‡ä»¶ç³»ç»Ÿæ‰«æåº”ç”¨ç›®å½•

#### ä¿®æ”¹æ–‡ä»¶
- `riveredge-backend/src/infra/infrastructure/database/dynamic_config_service.py`

#### ä¿®æ”¹å†…å®¹
```python
# ä¼˜åŒ–å‰ï¼šç¡¬ç¼–ç å›é€€æ–¹æ¡ˆ
active_app_codes = ['master-data']
logger.info(f"ğŸ“‹ ä½¿ç”¨ä¸´æ—¶æ–¹æ¡ˆï¼Œæ´»è·ƒåº”ç”¨: {active_app_codes}")

# ä¼˜åŒ–åï¼šåŠ¨æ€æ‰«æåº”ç”¨ç›®å½•
active_app_codes = []
try:
    from core.services.application.application_service import ApplicationService
    discovered_plugins = ApplicationService._scan_plugin_manifests()
    active_app_codes = [plugin.get('code') for plugin in discovered_plugins if plugin.get('code')]
    logger.info(f"ğŸ“‹ ä»æ–‡ä»¶ç³»ç»Ÿæ‰«æåˆ° {len(active_app_codes)} ä¸ªåº”ç”¨: {active_app_codes}")
except Exception as scan_error:
    logger.error(f"âŒ ä»æ–‡ä»¶ç³»ç»Ÿæ‰«æåº”ç”¨å¤±è´¥: {scan_error}")
    active_app_codes = []
    logger.warning("âš ï¸ æ— æ³•å‘ç°ä»»ä½•åº”ç”¨ï¼Œç³»ç»Ÿå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ")
```

### 4. èœå•åŠ è½½æœºåˆ¶éªŒè¯

#### æ£€æŸ¥ç»“æœ
èœå•åŠ è½½æœºåˆ¶å·²ç»ç¬¦åˆè§„èŒƒï¼Œå®Œå…¨é€šè¿‡åº”ç”¨åŠ è½½æœåŠ¡ç®¡ç†ï¼š

1. **èœå•åŒæ­¥æœºåˆ¶**
   - ä½¿ç”¨ `MenuService.sync_menus_from_application_config()` æ–¹æ³•åŒæ­¥èœå•
   - åœ¨åº”ç”¨æ³¨å†Œã€æ›´æ–°ã€å®‰è£…æ—¶è‡ªåŠ¨åŒæ­¥èœå•é…ç½®

2. **èœå•è·å–æœºåˆ¶**
   - é€šè¿‡ `MenuService.get_menu_tree()` ä»æ•°æ®åº“è·å–èœå•
   - æ”¯æŒæŒ‰åº”ç”¨è¿‡æ»¤ã€æŒ‰çŠ¶æ€è¿‡æ»¤
   - æ”¯æŒç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½

3. **å¼€å‘ç¯å¢ƒè‡ªåŠ¨åŒæ­¥**
   - åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œè·å–èœå•æ ‘æ—¶è‡ªåŠ¨æ‰«æå¹¶åŒæ­¥æ’ä»¶èœå•
   - ç¡®ä¿èœå•é…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ

#### ç›¸å…³æ–‡ä»¶
- `riveredge-backend/src/core/services/system/menu_service.py`
- `riveredge-backend/src/core/api/menus/menus.py`
- `riveredge-backend/src/core/services/application/application_service.py`

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰
- âŒ ç¡¬ç¼–ç åº”ç”¨åˆ—è¡¨ï¼š3å¤„
- âŒ æ–°å¢åº”ç”¨éœ€è¦ä¿®æ”¹ä»£ç 
- âŒ å›é€€æ–¹æ¡ˆä¸çµæ´»
- âš ï¸ ç³»ç»Ÿå†…ç½®åº”ç”¨åˆ¤æ–­é€»è¾‘ä¸æ¸…æ™°

### ä¼˜åŒ–å
- âœ… å®Œå…¨åŠ¨æ€åº”ç”¨å‘ç°
- âœ… æ–°å¢åº”ç”¨æ— éœ€ä¿®æ”¹ä»£ç 
- âœ… å›é€€æ–¹æ¡ˆè‡ªåŠ¨æ‰«ææ–‡ä»¶ç³»ç»Ÿ
- âœ… ç³»ç»Ÿå†…ç½®åº”ç”¨è‡ªåŠ¨è¯†åˆ«

---

## ğŸ”§ åº”ç”¨å‘ç°æœºåˆ¶

### å·¥ä½œåŸç†

1. **åº”ç”¨æ‰«æ**
   - æ‰«æ `src/apps/` ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•
   - æŸ¥æ‰¾æ¯ä¸ªç›®å½•ä¸‹çš„ `manifest.json` æ–‡ä»¶
   - è¯»å–åº”ç”¨é…ç½®ä¿¡æ¯

2. **åº”ç”¨æ³¨å†Œ**
   - ä» `manifest.json` è¯»å–åº”ç”¨ä¿¡æ¯ï¼ˆcodeã€nameã€versionç­‰ï¼‰
   - è‡ªåŠ¨åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæˆ–æ›´æ–°åº”ç”¨è®°å½•
   - è‡ªåŠ¨åŒæ­¥èœå•é…ç½®

3. **åº”ç”¨åŠ è½½**
   - ä»æ•°æ®åº“æŸ¥è¯¢å·²å®‰è£…ä¸”å¯ç”¨çš„åº”ç”¨
   - åŠ¨æ€æ³¨å†Œåº”ç”¨æ¨¡å‹å’Œè·¯ç”±
   - å¦‚æœæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°æ–‡ä»¶ç³»ç»Ÿæ‰«æ

### åº”ç”¨å‘ç°æµç¨‹

```
å¯åŠ¨åº”ç”¨
  â†“
æŸ¥è¯¢æ•°æ®åº“è·å–å·²å®‰è£…åº”ç”¨
  â†“
[æˆåŠŸ] â†’ æ³¨å†Œåº”ç”¨æ¨¡å‹å’Œè·¯ç”±
  â†“
[å¤±è´¥] â†’ æ‰«æ apps ç›®å½•
  â†“
è¯»å– manifest.json
  â†“
æ„å»ºåº”ç”¨ä¿¡æ¯
  â†“
æ³¨å†Œåº”ç”¨æ¨¡å‹å’Œè·¯ç”±
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ·»åŠ æ–°åº”ç”¨

1. **åˆ›å»ºåº”ç”¨ç›®å½•**
   ```bash
   mkdir -p riveredge-backend/src/apps/my-app
   ```

2. **åˆ›å»º manifest.json**
   ```json
   {
     "name": "æˆ‘çš„åº”ç”¨",
     "code": "my-app",
     "version": "1.0.0",
     "description": "åº”ç”¨æè¿°",
     "icon": "app-icon",
     "route_path": "/apps/my-app",
     "entry_point": "apps.my_app.api.router",
     "menu_config": {
       "title": "æˆ‘çš„åº”ç”¨",
       "icon": "app-icon",
       "path": "/apps/my-app",
       "children": [...]
     }
   }
   ```

3. **åˆ›å»ºåº”ç”¨ä»£ç **
   - åˆ›å»º `api/router.py` å®šä¹‰è·¯ç”±
   - åˆ›å»º `models/` å®šä¹‰æ•°æ®æ¨¡å‹
   - åˆ›å»º `services/` å®šä¹‰ä¸šåŠ¡é€»è¾‘
   - åˆ›å»º `schemas/` å®šä¹‰æ•°æ®éªŒè¯

4. **è‡ªåŠ¨æ³¨å†Œ**
   - ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œåº”ç”¨
   - æˆ–è°ƒç”¨ `ApplicationService.scan_and_register_plugins()` æ‰‹åŠ¨æ‰«æ

### åº”ç”¨ç®¡ç†

- **å¯ç”¨/ç¦ç”¨åº”ç”¨**ï¼šé€šè¿‡æ•°æ®åº“ `core_applications` è¡¨çš„ `is_active` å­—æ®µ
- **å®‰è£…/å¸è½½åº”ç”¨**ï¼šé€šè¿‡æ•°æ®åº“ `core_applications` è¡¨çš„ `is_installed` å­—æ®µ
- **èœå•åŒæ­¥**ï¼šåº”ç”¨é…ç½®æ›´æ–°åè‡ªåŠ¨åŒæ­¥èœå•

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **manifest.json æ ¼å¼**
   - å¿…é¡»åŒ…å« `code` å­—æ®µ
   - `code` å­—æ®µå¿…é¡»å”¯ä¸€
   - å»ºè®®ä½¿ç”¨ `kebab-case` å‘½åï¼ˆå¦‚ `my-app`ï¼‰

2. **åº”ç”¨ä»£ç å‘½å**
   - åº”ç”¨ä»£ç ä¸­çš„è¿å­—ç¬¦ï¼ˆ`-`ï¼‰ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºä¸‹åˆ’çº¿ï¼ˆ`_`ï¼‰ç”¨äºPythonæ¨¡å—è·¯å¾„
   - ä¾‹å¦‚ï¼š`my-app` â†’ `apps.my_app.api.router`

3. **èœå•é…ç½®**
   - èœå•é…ç½®å­˜å‚¨åœ¨ `menu_config` å­—æ®µä¸­ï¼ˆJSONæ ¼å¼ï¼‰
   - æ”¯æŒæ ‘å½¢ç»“æ„èœå•
   - èœå•åŒæ­¥æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“ä¸­çš„èœå•è®°å½•

4. **å›é€€æœºåˆ¶**
   - å½“æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»æ–‡ä»¶ç³»ç»Ÿæ‰«æåº”ç”¨
   - å¦‚æœæ–‡ä»¶ç³»ç»Ÿæ‰«æä¹Ÿå¤±è´¥ï¼Œç³»ç»Ÿä¼šè®°å½•è­¦å‘Šä½†ä¸ä¼šå´©æºƒ
   - å»ºè®®ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼Œä»¥è·å¾—æœ€ä½³æ€§èƒ½

---

## ğŸ” éªŒè¯æ–¹æ³•

### 1. éªŒè¯åº”ç”¨å‘ç°

```python
from core.services.application.application_service import ApplicationService

# æ‰«æåº”ç”¨
plugins = ApplicationService._scan_plugin_manifests()
print(f"å‘ç° {len(plugins)} ä¸ªåº”ç”¨")
for plugin in plugins:
    print(f"  - {plugin.get('name')} ({plugin.get('code')})")
```

### 2. éªŒè¯åº”ç”¨æ³¨å†Œ

```python
from core.services.application.application_registry_service import ApplicationRegistryService

# è·å–å·²æ³¨å†Œçš„åº”ç”¨
registered_apps = ApplicationRegistryService.get_registered_app_codes()
print(f"å·²æ³¨å†Œ {len(registered_apps)} ä¸ªåº”ç”¨: {registered_apps}")
```

### 3. éªŒè¯èœå•åŠ è½½

```python
from core.services.system.menu_service import MenuService

# è·å–èœå•æ ‘
menu_tree = await MenuService.get_menu_tree(
    tenant_id=1,
    is_active=True
)
print(f"èœå•æ ‘åŒ…å« {len(menu_tree)} ä¸ªæ ¹èœå•")
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **åº”ç”¨ä¾èµ–ç®¡ç†**
   - åœ¨ `manifest.json` ä¸­æ·»åŠ  `dependencies` å­—æ®µ
   - å®ç°åº”ç”¨ä¾èµ–æ£€æŸ¥å’ŒåŠ è½½é¡ºåºç®¡ç†

2. **åº”ç”¨ç‰ˆæœ¬ç®¡ç†**
   - æ”¯æŒåº”ç”¨ç‰ˆæœ¬å‡çº§
   - è‡ªåŠ¨æ£€æµ‹åº”ç”¨ç‰ˆæœ¬å˜æ›´

3. **åº”ç”¨é…ç½®çƒ­æ›´æ–°**
   - æ”¯æŒåº”ç”¨é…ç½®åŠ¨æ€æ›´æ–°
   - æ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆ

4. **åº”ç”¨å¥åº·æ£€æŸ¥**
   - å®ç°åº”ç”¨å¥åº·æ£€æŸ¥æœºåˆ¶
   - è‡ªåŠ¨æ£€æµ‹åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ

5. **åº”ç”¨æ€§èƒ½ç›‘æ§**
   - ç›‘æ§åº”ç”¨åŠ è½½æ—¶é—´
   - ç›‘æ§åº”ç”¨è·¯ç”±æ€§èƒ½

---

## âœ… æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æˆåŠŸç§»é™¤äº†æ‰€æœ‰ç¡¬ç¼–ç çš„åº”ç”¨åˆ—è¡¨ï¼Œå®ç°äº†å®Œå…¨åŠ¨æ€çš„åº”ç”¨å‘ç°å’Œæ³¨å†Œæœºåˆ¶ã€‚ç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š

1. âœ… **è‡ªåŠ¨å‘ç°åº”ç”¨**ï¼šä»æ–‡ä»¶ç³»ç»Ÿæ‰«æåº”ç”¨ç›®å½•
2. âœ… **åŠ¨æ€æ³¨å†Œåº”ç”¨**ï¼šæ— éœ€ä¿®æ”¹ä»£ç å³å¯æ·»åŠ æ–°åº”ç”¨
3. âœ… **çµæ´»å›é€€æœºåˆ¶**ï¼šæ•°æ®åº“æŸ¥è¯¢å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ‰«æ
4. âœ… **èœå•è‡ªåŠ¨åŒæ­¥**ï¼šåº”ç”¨é…ç½®æ›´æ–°åè‡ªåŠ¨åŒæ­¥èœå•

æ‰€æœ‰åº”ç”¨ç®¡ç†åŠŸèƒ½ç°åœ¨å®Œå…¨é€šè¿‡ `ApplicationService` å’Œ `ApplicationRegistryService` ç»Ÿä¸€ç®¡ç†ï¼Œç¬¦åˆè§„èŒƒè¦æ±‚ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-31  
**ä¼˜åŒ–å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ

