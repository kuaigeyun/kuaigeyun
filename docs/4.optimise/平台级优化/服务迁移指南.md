# æœåŠ¡è¿ç§»æŒ‡å—

## ğŸ“‹ è¿ç§»ç›®æ ‡

å°†ç°æœ‰APIè·¯ç”±ä»ç›´æ¥å¯¼å…¥æœåŠ¡æ”¹ä¸ºä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæé«˜ä»£ç çš„å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ğŸ¯ è¿ç§»åŸåˆ™

1. **å‘åå…¼å®¹**ï¼šç¡®ä¿ç°æœ‰ä»£ç ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ
2. **æ¸è¿›å¼è¿ç§»**ï¼šé€æ­¥è¿ç§»ï¼Œä¸ä¸€æ¬¡æ€§ä¿®æ”¹æ‰€æœ‰ä»£ç 
3. **ä¿æŒåŠŸèƒ½ä¸å˜**ï¼šè¿ç§»ååŠŸèƒ½å¿…é¡»å®Œå…¨ä¸€è‡´

## ğŸ“ è¿ç§»æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æœåŠ¡æ˜¯å¦å·²æ³¨å†Œ

```python
from core.services.interfaces.service_registry import ServiceLocator

# æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²æ³¨å†Œ
if ServiceLocator.has_service("user_service"):
    print("æœåŠ¡å·²æ³¨å†Œï¼Œå¯ä»¥ä½¿ç”¨ä¾èµ–æ³¨å…¥")
else:
    print("æœåŠ¡æœªæ³¨å†Œï¼Œä½¿ç”¨ç›´æ¥å¯¼å…¥")
```

### æ­¥éª¤2ï¼šæ·»åŠ ä¾èµ–æ³¨å…¥å‚æ•°

**ä¿®æ”¹å‰ï¼š**
```python
@router.post("", response_model=UserResponse)
async def create_user(
    data: UserCreate,
    current_user: User = Depends(soil_get_current_user),
    tenant_id: int = Depends(get_current_tenant),
):
    user = await UserService.create_user(...)
```

**ä¿®æ”¹åï¼š**
```python
from core.api.deps.service_helpers import get_user_service_with_fallback

@router.post("", response_model=UserResponse)
async def create_user(
    data: UserCreate,
    current_user: User = Depends(soil_get_current_user),
    tenant_id: int = Depends(get_current_tenant),
    user_service: Any = Depends(get_user_service_with_fallback),  # âš ï¸ æ–°å¢
):
    user = await user_service.create_user(...)  # âš ï¸ ä¿®æ”¹è°ƒç”¨æ–¹å¼
```

### æ­¥éª¤3ï¼šæ›´æ–°æœåŠ¡è°ƒç”¨

**ä¿®æ”¹å‰ï¼š**
```python
user = await UserService.create_user(
    tenant_id=tenant_id,
    data=data,
    current_user_id=current_user.id
)
```

**ä¿®æ”¹åï¼š**
```python
# ç»Ÿä¸€è°ƒç”¨æ–¹å¼ï¼Œé€‚é…å™¨ä¼šè‡ªåŠ¨å¤„ç†
user = await user_service.create_user(
    tenant_id=tenant_id,
    data=data,
    current_user_id=current_user.id
)
```

## ğŸ” è¿ç§»æ£€æŸ¥æ¸…å•

### è¿ç§»å‰æ£€æŸ¥

- [ ] ç¡®è®¤æœåŠ¡å·²æ³¨å†Œåˆ° ServiceRegistry
- [ ] ç¡®è®¤æœåŠ¡æ¥å£å·²å®šä¹‰
- [ ] ç¡®è®¤æœåŠ¡å®ç°ç±»å·²åˆ›å»º
- [ ] ç¡®è®¤ä¾èµ–æ³¨å…¥å‡½æ•°å·²åˆ›å»º

### è¿ç§»åæ£€æŸ¥

- [ ] APIè·¯ç”±åŠŸèƒ½æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†æ­£å¸¸
- [ ] å‘åå…¼å®¹æ€§æ­£å¸¸ï¼ˆç›´æ¥å¯¼å…¥æ–¹å¼ä»ç„¶å¯ç”¨ï¼‰
- [ ] ä»£ç é€šè¿‡ lint æ£€æŸ¥

## ğŸ“Š è¿ç§»ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç”¨æˆ·åˆ›å»ºAPI

**æ–‡ä»¶ï¼š** `core/api/users/users.py`

**ä¿®æ”¹å†…å®¹ï¼š**
1. å¯¼å…¥ä¾èµ–æ³¨å…¥å‡½æ•°
2. æ·»åŠ ä¾èµ–æ³¨å…¥å‚æ•°
3. æ›´æ–°æœåŠ¡è°ƒç”¨

**å®Œæ•´ç¤ºä¾‹ï¼š**
```python
from core.api.deps.service_helpers import get_user_service_with_fallback

@router.post("", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
async def create_user(
    data: UserCreate,
    current_user: User = Depends(soil_get_current_user),
    tenant_id: int = Depends(get_current_tenant),
    user_service: Any = Depends(get_user_service_with_fallback),  # âš ï¸ æ–°å¢
):
    try:
        # âš ï¸ ä¿®æ”¹ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœåŠ¡
        user = await user_service.create_user(
            tenant_id=tenant_id,
            data=data,
            current_user_id=current_user.id
        )
        # ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
```

### ç¤ºä¾‹2ï¼šç”¨æˆ·åˆ—è¡¨API

**ä¿®æ”¹å‰ï¼š**
```python
@router.get("", response_model=UserListResponse)
async def get_user_list(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    # ... å…¶ä»–å‚æ•°
    tenant_id: int = Depends(get_current_tenant),
):
    result = await UserService.get_user_list(
        tenant_id=tenant_id,
        page=page,
        page_size=page_size,
        # ...
    )
```

**ä¿®æ”¹åï¼š**
```python
@router.get("", response_model=UserListResponse)
async def get_user_list(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    # ... å…¶ä»–å‚æ•°
    tenant_id: int = Depends(get_current_tenant),
    user_service: Any = Depends(get_user_service_with_fallback),  # âš ï¸ æ–°å¢
):
    result = await user_service.get_user_list(  # âš ï¸ ä¿®æ”¹
        tenant_id=tenant_id,
        page=page,
        page_size=page_size,
        # ...
    )
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æœåŠ¡æ–¹æ³•ç­¾åå¿…é¡»ä¸€è‡´

ç¡®ä¿æ¥å£å®šä¹‰çš„æ–¹æ³•ç­¾åä¸å®ç°ç±»ä¸€è‡´ï¼š

```python
# æ¥å£å®šä¹‰
async def create_user(
    self,
    tenant_id: int,
    data: Any,
    current_user_id: int
) -> Any:
    pass

# å®ç°ç±»
async def create_user(
    self,
    tenant_id: int,
    data: Any,
    current_user_id: int
) -> Any:
    return await UserService.create_user(...)
```

### 2. é”™è¯¯å¤„ç†ä¿æŒä¸€è‡´

è¿ç§»åé”™è¯¯å¤„ç†é€»è¾‘åº”è¯¥ä¿æŒä¸€è‡´ï¼š

```python
try:
    user = await user_service.create_user(...)
except ValidationError as e:
    raise HTTPException(...)
```

### 3. æµ‹è¯•è¿ç§»åçš„åŠŸèƒ½

è¿ç§»åå¿…é¡»æµ‹è¯•ï¼š
- æ­£å¸¸æµç¨‹
- é”™è¯¯å¤„ç†
- è¾¹ç•Œæƒ…å†µ

## ğŸ”„ å›é€€ç­–ç•¥

å¦‚æœè¿ç§»åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›é€€ï¼š

1. ç§»é™¤ä¾èµ–æ³¨å…¥å‚æ•°
2. æ¢å¤ç›´æ¥å¯¼å…¥
3. æ¢å¤ç›´æ¥è°ƒç”¨

**å›é€€ç¤ºä¾‹ï¼š**
```python
# å›é€€å‰ï¼ˆä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼‰
async def create_user(
    user_service: Any = Depends(get_user_service_with_fallback),
):
    user = await user_service.create_user(...)

# å›é€€åï¼ˆç›´æ¥å¯¼å…¥ï¼‰
from core.services.user.user_service import UserService

async def create_user(...):
    user = await UserService.create_user(...)
```

## ğŸ“ˆ è¿ç§»ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³è¿ç§»ï¼‰
- âœ… ç”¨æˆ·ç®¡ç†APIï¼ˆå·²å®Œæˆç¤ºä¾‹ï¼‰
- â³ è§’è‰²ç®¡ç†API
- â³ æƒé™ç®¡ç†API

### ä¸­ä¼˜å…ˆçº§ï¼ˆçŸ­æœŸè¿ç§»ï¼‰
- â³ éƒ¨é—¨ç®¡ç†API
- â³ èŒä½ç®¡ç†API
- â³ èœå•ç®¡ç†API

### ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè¿ç§»ï¼‰
- â³ å…¶ä»–ç³»ç»Ÿçº§API
- â³ åº”ç”¨çº§API

## ğŸ§ª è¿ç§»æµ‹è¯•

### å•å…ƒæµ‹è¯•

```python
async def test_create_user_with_dependency_injection():
    """æµ‹è¯•ä½¿ç”¨ä¾èµ–æ³¨å…¥åˆ›å»ºç”¨æˆ·"""
    from core.api.deps.service_helpers import get_user_service_with_fallback
    
    user_service = get_user_service_with_fallback()
    # æµ‹è¯•æœåŠ¡è°ƒç”¨
    # ...
```

### é›†æˆæµ‹è¯•

```python
async def test_user_api_with_dependency_injection(client):
    """æµ‹è¯•ç”¨æˆ·APIä½¿ç”¨ä¾èµ–æ³¨å…¥"""
    response = await client.post("/api/v1/core/users", json={...})
    assert response.status_code == 201
```

---

**æœ€åæ›´æ–°ï¼š** 2025-12-27
**ä½œè€…ï¼š** Luigi Lu

