# æœåŠ¡ç®¡ç†æœºåˆ¶åˆ†æä¸æ”¹è¿›å»ºè®®

## ğŸ“Š å½“å‰æœºåˆ¶åˆ†æ

### 1. å¹³å°çº§ (infra/) æœåŠ¡ç®¡ç†

**ç°çŠ¶ï¼š**
- æœåŠ¡ä½ç½®ï¼š`infra/services/`
- ç®¡ç†æ–¹å¼ï¼šç›´æ¥æœåŠ¡ç±»ï¼Œæ— ç»Ÿä¸€æ³¨å†Œæœºåˆ¶
- ä½¿ç”¨æ–¹å¼ï¼šé™æ€å¯¼å…¥ï¼Œç›´æ¥å®ä¾‹åŒ–

**é—®é¢˜ï¼š**
- âŒ æ²¡æœ‰ç»Ÿä¸€çš„æœåŠ¡ç®¡ç†æœºåˆ¶
- âŒ æœåŠ¡ä¹‹é—´å¯èƒ½å­˜åœ¨å¾ªç¯ä¾èµ–
- âŒ éš¾ä»¥è¿›è¡ŒæœåŠ¡æ›¿æ¢å’Œæµ‹è¯•
- âŒ æ²¡æœ‰æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ç¤ºä¾‹ï¼š**
```python
# å½“å‰æ–¹å¼ï¼šç›´æ¥å¯¼å…¥å’Œä½¿ç”¨
from infra.services.auth_service import AuthService
# ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•æˆ–å®ä¾‹åŒ–
```

### 2. ç³»ç»Ÿçº§ (core/) æœåŠ¡ç®¡ç†

**ç°çŠ¶ï¼š**
- æœåŠ¡ä½ç½®ï¼š`core/services/`
- ç®¡ç†æ–¹å¼ï¼š
  - âœ… æœ‰ `ServiceRegistry` å’Œ `ServiceInterface` æœºåˆ¶
  - âŒ ä½†ä½¿ç”¨ç‡æä½ï¼ˆåªæœ‰2ä¸ªæœåŠ¡ä½¿ç”¨ï¼‰
  - âŒ å¤§éƒ¨åˆ†æœåŠ¡ä»ç„¶æ˜¯ç›´æ¥é™æ€å¯¼å…¥

**å®é™…ä½¿ç”¨æƒ…å†µï¼š**
- âœ… ä½¿ç”¨ ServiceRegistryï¼š`user_activity_service`, `audit_log_service`ï¼ˆä»…2ä¸ªï¼‰
- âŒ ç›´æ¥é™æ€å¯¼å…¥ï¼š`UserService`, `RoleService`, `MessageService` ç­‰ï¼ˆ90%+ï¼‰

**é—®é¢˜ï¼š**
- âŒ æœåŠ¡æ³¨å†Œæœºåˆ¶è®¾è®¡å®Œå–„ä½†æœªå……åˆ†åˆ©ç”¨
- âŒ æœåŠ¡æ¥å£å®šä¹‰ä¸å®Œæ•´ï¼ˆåªæœ‰4ä¸ªæ¥å£ï¼‰
- âŒ æœåŠ¡ä¾èµ–æ³¨å…¥ä¸ç»Ÿä¸€
- âŒ éš¾ä»¥è¿›è¡ŒæœåŠ¡çº§åˆ«çš„æµ‹è¯•å’Œæ¨¡æ‹Ÿ

**ç¤ºä¾‹ï¼š**
```python
# å½“å‰æ–¹å¼1ï¼šç›´æ¥å¯¼å…¥ï¼ˆ90%+ï¼‰
from core.services.user.user_service import UserService
user = await UserService.create_user(...)

# å½“å‰æ–¹å¼2ï¼šé€šè¿‡æ³¨å†Œè¡¨ï¼ˆä»…2ä¸ªæœåŠ¡ï¼‰
from core.services.interfaces.service_registry import ServiceLocator
service = ServiceLocator.get_service("user_activity_service")
```

### 3. åº”ç”¨çº§ (apps/) åº”ç”¨ç®¡ç†

**ç°çŠ¶ï¼š**
- åº”ç”¨ä½ç½®ï¼š`apps/{app_code}/`
- ç®¡ç†æ–¹å¼ï¼š`ApplicationRegistryService` åŠ¨æ€åŠ è½½
- åŠŸèƒ½ï¼š
  - âœ… åŠ¨æ€å‘ç°å·²å®‰è£…åº”ç”¨
  - âœ… åŠ¨æ€æ³¨å†Œåº”ç”¨æ¨¡å‹ï¼ˆTortoise ORMï¼‰
  - âœ… åŠ¨æ€æ³¨å†Œåº”ç”¨è·¯ç”±ï¼ˆFastAPIï¼‰

**é—®é¢˜ï¼š**
- âš ï¸ åº”ç”¨è·¯ç”±æ³¨å†Œæ—¶æœºå¯èƒ½æœ‰é—®é¢˜ï¼ˆåœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œï¼Œä½†åº”ç”¨å¯èƒ½åç»­å®‰è£…ï¼‰
- âš ï¸ åº”ç”¨æœåŠ¡æ²¡æœ‰ç»Ÿä¸€çš„ç®¡ç†æœºåˆ¶
- âš ï¸ åº”ç”¨ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸æ˜ç¡®

## ğŸ” æ ¸å¿ƒé—®é¢˜æ€»ç»“

### 1. æœåŠ¡ç®¡ç†æ–¹å¼ä¸ç»Ÿä¸€

| å±‚çº§ | è®¾è®¡ | å®é™…ä½¿ç”¨ | ä¸€è‡´æ€§ |
|------|------|---------|--------|
| å¹³å°çº§ | æ— æœºåˆ¶ | ç›´æ¥å¯¼å…¥ | âŒ ä¸ä¸€è‡´ |
| ç³»ç»Ÿçº§ | æœ‰æœºåˆ¶ | å¾ˆå°‘ä½¿ç”¨ | âš ï¸ ä¸ä¸€è‡´ |
| åº”ç”¨çº§ | æœ‰æœºåˆ¶ | æ­£å¸¸ä½¿ç”¨ | âœ… ä¸€è‡´ |

### 2. ServiceRegistry ä½¿ç”¨ç‡ä½

**åŸå› åˆ†æï¼š**
- æœåŠ¡æ¥å£å®šä¹‰ä¸å®Œæ•´ï¼ˆåªæœ‰4ä¸ªæ¥å£ï¼‰
- è¿ç§»æˆæœ¬é«˜ï¼ˆéœ€è¦ä¿®æ”¹å¤§é‡ä»£ç ï¼‰
- ç¼ºä¹å¼ºåˆ¶æ€§çš„ä½¿ç”¨è§„èŒƒ
- å¼€å‘è€…ä¹ æƒ¯ç›´æ¥å¯¼å…¥

### 3. æœåŠ¡ä¾èµ–ç®¡ç†ä¸æ¸…æ™°

- æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸æ˜ç¡®
- æ²¡æœ‰ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆDI Containerï¼‰
- éš¾ä»¥è¿›è¡Œä¾èµ–æ›¿æ¢å’Œæµ‹è¯•

## ğŸ’¡ æ”¹è¿›å»ºè®®

### æ–¹æ¡ˆä¸€ï¼šæ¸è¿›å¼æ”¹è¿›ï¼ˆæ¨èï¼‰

#### 1.1 ç»Ÿä¸€æœåŠ¡æ³¨å†Œæœºåˆ¶

**ç›®æ ‡ï¼š** ä¸ºæ‰€æœ‰ä¸‰å±‚æœåŠ¡æä¾›ç»Ÿä¸€çš„ç®¡ç†æœºåˆ¶

**å®æ–½æ­¥éª¤ï¼š**

1. **æ‰©å±• ServiceRegistry æ”¯æŒå¹³å°çº§æœåŠ¡**
```python
# infra/services/registry.py
class InfraServiceRegistry:
    """å¹³å°çº§æœåŠ¡æ³¨å†Œè¡¨"""
    _services: Dict[str, Any] = {}
    
    @classmethod
    def register(cls, name: str, service: Any):
        cls._services[name] = service
    
    @classmethod
    def get(cls, name: str):
        return cls._services.get(name)
```

2. **å®Œå–„ç³»ç»Ÿçº§æœåŠ¡æ¥å£å®šä¹‰**
```python
# ä¸ºæ‰€æœ‰æ ¸å¿ƒæœåŠ¡å®šä¹‰æ¥å£
class UserServiceInterface(ServiceInterface):
    service_name = "user_service"
    # ... å®šä¹‰æ‰€æœ‰æ–¹æ³•
    
class RoleServiceInterface(ServiceInterface):
    service_name = "role_service"
    # ...
```

3. **é€æ­¥è¿ç§»ç°æœ‰æœåŠ¡**
   - ä¼˜å…ˆè¿ç§»é«˜é¢‘ä½¿ç”¨çš„æœåŠ¡
   - æ–°æœåŠ¡å¼ºåˆ¶ä½¿ç”¨æ³¨å†Œæœºåˆ¶
   - æ—§æœåŠ¡ä¿æŒå…¼å®¹ï¼Œé€æ­¥è¿ç§»

#### 1.2 å¼•å…¥ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰

**ä½¿ç”¨ FastAPI çš„ Depends æœºåˆ¶ï¼š**

```python
# core/services/interfaces/di.py
from fastapi import Depends
from .service_registry import ServiceLocator

def get_user_service() -> UserServiceInterface:
    """è·å–ç”¨æˆ·æœåŠ¡ï¼ˆä¾èµ–æ³¨å…¥ï¼‰"""
    return ServiceLocator.get_service("user_service")

# API è·¯ç”±ä¸­ä½¿ç”¨
@router.post("/users")
async def create_user(
    data: UserCreate,
    user_service: UserServiceInterface = Depends(get_user_service)
):
    return await user_service.create_user(...)
```

#### 1.3 åº”ç”¨çº§æœåŠ¡ç®¡ç†

**ä¸ºåº”ç”¨çº§æœåŠ¡æä¾›ç»Ÿä¸€ç®¡ç†ï¼š**

```python
# core/services/application/application_service_registry.py
class ApplicationServiceRegistry:
    """åº”ç”¨çº§æœåŠ¡æ³¨å†Œè¡¨"""
    _app_services: Dict[str, Dict[str, Any]] = {}
    
    @classmethod
    def register_app_service(cls, app_code: str, service_name: str, service: Any):
        if app_code not in cls._app_services:
            cls._app_services[app_code] = {}
        cls._app_services[app_code][service_name] = service
    
    @classmethod
    def get_app_service(cls, app_code: str, service_name: str):
        return cls._app_services.get(app_code, {}).get(service_name)
```

### æ–¹æ¡ˆäºŒï¼šå…¨é¢é‡æ„ï¼ˆæ¿€è¿›ï¼‰

#### 2.1 å¼•å…¥æœåŠ¡å®¹å™¨ï¼ˆService Containerï¼‰

**ä½¿ç”¨ç±»ä¼¼ Spring çš„ä¾èµ–æ³¨å…¥å®¹å™¨ï¼š**

```python
# core/services/container.py
class ServiceContainer:
    """æœåŠ¡å®¹å™¨ - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡"""
    
    def __init__(self):
        self._services: Dict[str, Any] = {}
        self._singletons: Dict[str, Any] = {}
    
    def register(self, name: str, factory: Callable, singleton: bool = True):
        """æ³¨å†ŒæœåŠ¡å·¥å‚"""
        self._services[name] = (factory, singleton)
    
    def get(self, name: str):
        """è·å–æœåŠ¡å®ä¾‹"""
        if name in self._singletons:
            return self._singletons[name]
        
        factory, singleton = self._services[name]
        instance = factory(self)  # ä¼ å…¥å®¹å™¨è‡ªèº«ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥
        
        if singleton:
            self._singletons[name] = instance
        
        return instance
```

#### 2.2 ç»Ÿä¸€æœåŠ¡æ¥å£è§„èŒƒ

**æ‰€æœ‰æœåŠ¡å¿…é¡»å®ç°æ¥å£ï¼š**

```python
# å¼ºåˆ¶æ‰€æœ‰æœåŠ¡å®ç°æ¥å£
@service_interface
class UserService(ServiceInterface):
    service_name = "user_service"
    
    @abstractmethod
    async def create_user(self, ...): ...
    
    @abstractmethod
    async def get_user(self, ...): ...
```

### æ–¹æ¡ˆä¸‰ï¼šä¿æŒç°çŠ¶ + ä¼˜åŒ–ï¼ˆä¿å®ˆï¼‰

#### 3.1 ä¿æŒå½“å‰æœºåˆ¶ï¼Œä½†ä¼˜åŒ–ä½¿ç”¨

**æ”¹è¿›ç‚¹ï¼š**

1. **å®Œå–„åº”ç”¨çº§åº”ç”¨åŠ è½½**
   - ç¡®ä¿åº”ç”¨è·¯ç”±æ­£ç¡®æ³¨å†Œ
   - æ”¯æŒåº”ç”¨çƒ­åŠ è½½
   - åº”ç”¨çŠ¶æ€ç®¡ç†

2. **ç³»ç»Ÿçº§æœåŠ¡ï¼šé€‰æ‹©æ€§ä½¿ç”¨æ³¨å†Œæœºåˆ¶**
   - è·¨å±‚è°ƒç”¨çš„æœåŠ¡ä½¿ç”¨æ³¨å†Œæœºåˆ¶ï¼ˆå¦‚ infra â†’ coreï¼‰
   - åŒå±‚æœåŠ¡ä¿æŒç›´æ¥å¯¼å…¥
   - æ–°æœåŠ¡ä¼˜å…ˆä½¿ç”¨æ³¨å†Œæœºåˆ¶

3. **å¹³å°çº§æœåŠ¡ï¼šä¿æŒç®€å•**
   - å¹³å°çº§æœåŠ¡ç›¸å¯¹ç‹¬ç«‹ï¼Œä¿æŒç›´æ¥å¯¼å…¥å³å¯
   - å¦‚éœ€è·¨å±‚è°ƒç”¨ï¼Œé€šè¿‡æ¥å£å±‚

## ğŸ“‹ æ¨èæ–¹æ¡ˆï¼šæ¸è¿›å¼æ”¹è¿›

### å®æ–½ä¼˜å…ˆçº§

#### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… **ä¿®å¤åº”ç”¨è·¯ç”±æ³¨å†Œé—®é¢˜**ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
2. âœ… **å®Œå–„åº”ç”¨çº§åº”ç”¨åŠ è½½æœºåˆ¶**
3. âœ… **ä¸ºè·¨å±‚æœåŠ¡è°ƒç”¨å»ºç«‹æ¥å£è§„èŒƒ**

#### ç¬¬äºŒé˜¶æ®µï¼ˆçŸ­æœŸï¼š1-2å‘¨ï¼‰
1. âœ… **æ‰©å±• ServiceRegistry æ”¯æŒå¹³å°çº§æœåŠ¡**
2. âœ… **ä¸ºé«˜é¢‘ä½¿ç”¨çš„ç³»ç»Ÿçº§æœåŠ¡å®šä¹‰æ¥å£**
3. âœ… **å¼•å…¥ FastAPI Depends ä¾èµ–æ³¨å…¥**

#### ç¬¬ä¸‰é˜¶æ®µï¼ˆä¸­æœŸï¼š1-2æœˆï¼‰
1. âœ… **é€æ­¥è¿ç§»ç°æœ‰æœåŠ¡åˆ°æ³¨å†Œæœºåˆ¶**
2. âœ… **å»ºç«‹æœåŠ¡ä¾èµ–å…³ç³»å›¾**
3. âœ… **å®Œå–„æœåŠ¡æµ‹è¯•æ¡†æ¶**

#### ç¬¬å››é˜¶æ®µï¼ˆé•¿æœŸï¼šæŒç»­ä¼˜åŒ–ï¼‰
1. âœ… **è€ƒè™‘å¼•å…¥æœåŠ¡å®¹å™¨ï¼ˆå¦‚éœ€è¦ï¼‰**
2. âœ… **å»ºç«‹æœåŠ¡ç›‘æ§å’Œå¥åº·æ£€æŸ¥**
3. âœ… **ä¼˜åŒ–æœåŠ¡æ€§èƒ½**

## ğŸ¯ å…·ä½“æ”¹è¿›æªæ–½

### 1. ç«‹å³æ”¹è¿›ï¼šåº”ç”¨çº§åº”ç”¨åŠ è½½

**é—®é¢˜ï¼š** åº”ç”¨è·¯ç”±åœ¨å¯åŠ¨æ—¶æ³¨å†Œï¼Œä½†åº”ç”¨å¯èƒ½åç»­å®‰è£…

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# åœ¨åº”ç”¨å®‰è£…/å¯ç”¨æ—¶é‡æ–°æ³¨å†Œè·¯ç”±
async def enable_application(uuid: str):
    # ... å¯ç”¨åº”ç”¨é€»è¾‘
    
    # é‡æ–°åŠ è½½åº”ç”¨è·¯ç”±
    await ApplicationRegistryService.reload_apps()
    
    # é‡æ–°æ³¨å†Œè·¯ç”±åˆ° FastAPI åº”ç”¨
    await register_app_routes(app)
```

### 2. çŸ­æœŸæ”¹è¿›ï¼šç»Ÿä¸€æœåŠ¡è·å–æ–¹å¼

**åˆ›å»ºç»Ÿä¸€çš„æœåŠ¡è·å–å‡½æ•°ï¼š**

```python
# core/services/service_factory.py
from typing import TypeVar, Type
from core.services.interfaces.service_registry import ServiceLocator

T = TypeVar('T')

def get_service(service_name: str, service_type: Type[T]) -> T:
    """
    ç»Ÿä¸€çš„æœåŠ¡è·å–å‡½æ•°
    
    ä¼˜å…ˆä»æ³¨å†Œè¡¨è·å–ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•ç›´æ¥å¯¼å…¥
    """
    try:
        return ServiceLocator.get_service(service_name)
    except ServiceNotFoundError:
        # å›é€€åˆ°ç›´æ¥å¯¼å…¥ï¼ˆå‘åå…¼å®¹ï¼‰
        return _import_service_directly(service_name)
```

### 3. ä¸­æœŸæ”¹è¿›ï¼šæœåŠ¡ä¾èµ–æ³¨å…¥

**ä½¿ç”¨ FastAPI Dependsï¼š**

```python
# core/api/deps/services.py
from fastapi import Depends
from core.services.interfaces.service_registry import ServiceLocator

def get_user_service():
    return ServiceLocator.get_service("user_service")

def get_role_service():
    return ServiceLocator.get_service("role_service")

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨
@router.post("/users")
async def create_user(
    data: UserCreate,
    user_service = Depends(get_user_service)
):
    return await user_service.create_user(...)
```

## ğŸ“Š æ”¹è¿›æ•ˆæœé¢„æœŸ

### æ”¹è¿›å‰
- âŒ æœåŠ¡ç®¡ç†æ–¹å¼ä¸ç»Ÿä¸€
- âŒ ServiceRegistry ä½¿ç”¨ç‡ < 5%
- âŒ éš¾ä»¥è¿›è¡ŒæœåŠ¡æ›¿æ¢å’Œæµ‹è¯•
- âŒ æœåŠ¡ä¾èµ–å…³ç³»ä¸æ¸…æ™°

### æ”¹è¿›å
- âœ… ä¸‰å±‚æœåŠ¡ç»Ÿä¸€ç®¡ç†
- âœ… ServiceRegistry ä½¿ç”¨ç‡ > 80%
- âœ… æ”¯æŒæœåŠ¡æ›¿æ¢å’Œæµ‹è¯•
- âœ… æœåŠ¡ä¾èµ–å…³ç³»æ¸…æ™°
- âœ… æ”¯æŒä¾èµ–æ³¨å…¥
- âœ… æ›´å¥½çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**ï¼šä¿æŒç°æœ‰ä»£ç å¯ä»¥æ­£å¸¸å·¥ä½œ
2. **æ¸è¿›å¼è¿ç§»**ï¼šä¸è¦ä¸€æ¬¡æ€§é‡æ„æ‰€æœ‰ä»£ç 
3. **æµ‹è¯•è¦†ç›–**ï¼šç¡®ä¿æ”¹è¿›åçš„ä»£ç æœ‰å……åˆ†çš„æµ‹è¯•
4. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°å¼€å‘æ–‡æ¡£å’Œè§„èŒƒ

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `core/services/interfaces/service_registry.py` - æœåŠ¡æ³¨å†Œè¡¨
- `core/services/interfaces/service_interface.py` - æœåŠ¡æ¥å£å®šä¹‰
- `core/services/application/application_registry_service.py` - åº”ç”¨æ³¨å†ŒæœåŠ¡
- `server/main.py` - åº”ç”¨å¯åŠ¨å’Œè·¯ç”±æ³¨å†Œ

---

**æœ€åæ›´æ–°ï¼š** 2025-12-27
**ä½œè€…ï¼š** Luigi Lu

