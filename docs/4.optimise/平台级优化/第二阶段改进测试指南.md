# ç¬¬äºŒé˜¶æ®µæ”¹è¿›æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯ä»¥ä¸‹åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š
1. âœ… å¹³å°çº§æœåŠ¡æ³¨å†Œè¡¨åŠŸèƒ½
2. âœ… ç³»ç»Ÿçº§æœåŠ¡æ¥å£å®šä¹‰å’Œå®ç°
3. âœ… æœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œåˆå§‹åŒ–
4. âœ… FastAPI ä¾èµ–æ³¨å…¥åŠŸèƒ½
5. âœ… å‘åå…¼å®¹æ€§

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šå¯åŠ¨æ—¶æ£€æŸ¥æ—¥å¿—ï¼ˆæœ€ç®€å•ï¼‰

#### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd riveredge-backend
python -m uvicorn server.main:app --reload --host 0.0.0.0 --port 8000
```

#### 2. æ£€æŸ¥å¯åŠ¨æ—¥å¿—

åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
âœ… æœåŠ¡æ¥å£å±‚å·²åˆå§‹åŒ–
âœ… æ³¨å†ŒæœåŠ¡ç±»å‹: user_activity_service
âœ… æ³¨å†ŒæœåŠ¡å®ä¾‹: user_activity_service (UserActivityServiceImpl)
âœ… æ³¨å†ŒæœåŠ¡ç±»å‹: audit_log_service
âœ… æ³¨å†ŒæœåŠ¡å®ä¾‹: audit_log_service (AuditLogServiceImpl)
âœ… æ³¨å†ŒæœåŠ¡ç±»å‹: application_service
âœ… æ³¨å†ŒæœåŠ¡å®ä¾‹: application_service (ApplicationServiceImpl)
âœ… æ³¨å†ŒæœåŠ¡ç±»å‹: user_service
âœ… æ³¨å†ŒæœåŠ¡å®ä¾‹: user_service (UserServiceImpl)
âœ… æ³¨å†ŒæœåŠ¡ç±»å‹: role_service
âœ… æ³¨å†ŒæœåŠ¡å®ä¾‹: role_service (RoleServiceImpl)
âœ… æ³¨å†ŒæœåŠ¡ç±»å‹: message_service
âœ… æ³¨å†ŒæœåŠ¡å®ä¾‹: message_service (MessageServiceImpl)
âœ… æœåŠ¡æ¥å£å±‚åˆå§‹åŒ–å®Œæˆ
```

### æ–¹æ³•äºŒï¼šAPI å¥åº·æ£€æŸ¥ç«¯ç‚¹

#### 1. åˆ›å»ºå¥åº·æ£€æŸ¥ç«¯ç‚¹

åœ¨ `server/main.py` ä¸­æ·»åŠ ï¼š

```python
from core.services.interfaces.service_registry import service_registry

@app.get("/health/services")
async def health_check_services():
    """æœåŠ¡å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    try:
        health_info = await service_registry.health_check_all()
        return {
            "status": "healthy",
            "services": health_info
        }
    except Exception as e:
        return {
            "status": "error",
            "error": str(e)
        }
```

#### 2. è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
curl http://localhost:8000/health/services
```

é¢„æœŸå“åº”ï¼š
```json
{
  "status": "healthy",
  "services": {
    "overall_healthy": true,
    "services": {
      "user_service": {
        "healthy": true,
        "info": {
          "status": "healthy",
          "service": "user_service",
          "version": "1.0.0"
        }
      },
      "role_service": {
        "healthy": true,
        "info": {
          "status": "healthy",
          "service": "role_service",
          "version": "1.0.0"
        }
      },
      ...
    }
  }
}
```

### æ–¹æ³•ä¸‰ï¼šPython äº¤äº’å¼æµ‹è¯•

#### 1. å¯åŠ¨ Python äº¤äº’å¼ç¯å¢ƒ

```bash
cd riveredge-backend
python
```

#### 2. æµ‹è¯•æœåŠ¡æ³¨å†Œ

```python
# å¯¼å…¥å¿…è¦çš„æ¨¡å—
import asyncio
from core.services.interfaces.service_registry import ServiceLocator
from core.services.interfaces.service_interface import UserServiceInterface

# æµ‹è¯•æœåŠ¡æ˜¯å¦å·²æ³¨å†Œ
async def test_services():
    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
    print("æ£€æŸ¥ user_service:", ServiceLocator.has_service("user_service"))
    print("æ£€æŸ¥ role_service:", ServiceLocator.has_service("role_service"))
    print("æ£€æŸ¥ message_service:", ServiceLocator.has_service("message_service"))
    
    # è·å–æœåŠ¡å®ä¾‹
    user_service = ServiceLocator.get_service("user_service")
    print("user_service ç±»å‹:", type(user_service))
    print("user_service åç§°:", user_service.service_name)
    print("user_service ç‰ˆæœ¬:", user_service.service_version)
    
    # æµ‹è¯•å¥åº·æ£€æŸ¥
    health = await user_service.health_check()
    print("user_service å¥åº·çŠ¶æ€:", health)
    
    # åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œçš„æœåŠ¡
    from core.services.interfaces.service_registry import service_registry
    services = service_registry.list_services()
    print("å·²æ³¨å†Œçš„æœåŠ¡:", services)

# è¿è¡Œæµ‹è¯•
asyncio.run(test_services())
```

é¢„æœŸè¾“å‡ºï¼š
```
æ£€æŸ¥ user_service: True
æ£€æŸ¥ role_service: True
æ£€æŸ¥ message_service: True
user_service ç±»å‹: <class 'core.services.interfaces.implementations.user_service_impl.UserServiceImpl'>
user_service åç§°: user_service
user_service ç‰ˆæœ¬: 1.0.0
user_service å¥åº·çŠ¶æ€: {'status': 'healthy', 'service': 'user_service', 'version': '1.0.0'}
å·²æ³¨å†Œçš„æœåŠ¡: ['user_activity_service', 'audit_log_service', 'application_service', 'user_service', 'role_service', 'message_service']
```

### æ–¹æ³•å››ï¼šæµ‹è¯•ä¾èµ–æ³¨å…¥åŠŸèƒ½

#### 1. åˆ›å»ºæµ‹è¯• API ç«¯ç‚¹

åœ¨ `core/api/users/users.py` ä¸­æ·»åŠ æµ‹è¯•ç«¯ç‚¹ï¼š

```python
from core.api.deps.services import get_user_service
from core.services.interfaces.service_interface import UserServiceInterface
from typing import Optional

@router.get("/test/dependency-injection")
async def test_dependency_injection(
    user_service: Optional[UserServiceInterface] = Depends(get_user_service)
):
    """
    æµ‹è¯•ä¾èµ–æ³¨å…¥åŠŸèƒ½
    
    éªŒè¯æœåŠ¡æ˜¯å¦å¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥è·å–ã€‚
    """
    if user_service is None:
        return {
            "status": "error",
            "message": "æœåŠ¡æœªæ³¨å†Œï¼Œä¾èµ–æ³¨å…¥å¤±è´¥"
        }
    
    return {
        "status": "success",
        "message": "ä¾èµ–æ³¨å…¥æˆåŠŸ",
        "service_name": user_service.service_name,
        "service_version": user_service.service_version,
        "service_type": type(user_service).__name__
    }
```

#### 2. è®¿é—®æµ‹è¯•ç«¯ç‚¹

```bash
curl http://localhost:8000/api/v1/core/users/test/dependency-injection
```

é¢„æœŸå“åº”ï¼š
```json
{
  "status": "success",
  "message": "ä¾èµ–æ³¨å…¥æˆåŠŸ",
  "service_name": "user_service",
  "service_version": "1.0.0",
  "service_type": "UserServiceImpl"
}
```

### æ–¹æ³•äº”ï¼šæµ‹è¯•å‘åå…¼å®¹æ€§

#### 1. æµ‹è¯•ç›´æ¥å¯¼å…¥ä»ç„¶å¯ç”¨

```python
# æµ‹è¯•ç›´æ¥å¯¼å…¥ï¼ˆæ—§æ–¹å¼ï¼‰
from core.services.user.user_service import UserService

# åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œ
users = await UserService.get_user_list(tenant_id=1, page=1, page_size=10)
print("ç›´æ¥å¯¼å…¥æ–¹å¼æ­£å¸¸å·¥ä½œ:", len(users.get('items', [])) >= 0)
```

#### 2. æµ‹è¯•æœåŠ¡æ³¨å†Œè¡¨æ–¹å¼

```python
# æµ‹è¯•æœåŠ¡æ³¨å†Œè¡¨æ–¹å¼ï¼ˆæ–°æ–¹å¼ï¼‰
from core.services.interfaces.service_registry import ServiceLocator

user_service = ServiceLocator.get_service("user_service")
users = await user_service.get_user_list(tenant_id=1, page=1, page_size=10)
print("æœåŠ¡æ³¨å†Œè¡¨æ–¹å¼æ­£å¸¸å·¥ä½œ:", len(users.get('items', [])) >= 0)
```

### æ–¹æ³•å…­ï¼šæµ‹è¯•å¹³å°çº§æœåŠ¡æ³¨å†Œè¡¨

#### 1. æµ‹è¯•å¹³å°çº§æœåŠ¡æ³¨å†Œ

```python
from infra.services.service_registry import InfraServiceLocator

# æ³¨å†Œä¸€ä¸ªæµ‹è¯•æœåŠ¡
class TestService:
    def test_method(self):
        return "test"

InfraServiceLocator.register_service("test_service", TestService())

# è·å–æœåŠ¡
test_service = InfraServiceLocator.get_service("test_service")
print("å¹³å°çº§æœåŠ¡æ³¨å†ŒæˆåŠŸ:", test_service.test_method() == "test")

# åˆ—å‡ºæ‰€æœ‰æœåŠ¡
from infra.services.service_registry import infra_service_registry
services = infra_service_registry.list_services()
print("å·²æ³¨å†Œçš„å¹³å°çº§æœåŠ¡:", services)
```

## ğŸ“ æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

- [ ] æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
- [ ] æœåŠ¡æ³¨å†Œè¡¨å¯ä»¥è·å–æœåŠ¡å®ä¾‹
- [ ] æœåŠ¡å¥åº·æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- [ ] ä¾èµ–æ³¨å…¥å‡½æ•°å¯ä»¥è·å–æœåŠ¡
- [ ] ç›´æ¥å¯¼å…¥æ–¹å¼ä»ç„¶å¯ç”¨ï¼ˆå‘åå…¼å®¹ï¼‰

### æœåŠ¡æ¥å£æµ‹è¯•

- [ ] UserServiceInterface æ­£å¸¸å·¥ä½œ
- [ ] RoleServiceInterface æ­£å¸¸å·¥ä½œ
- [ ] MessageServiceInterface æ­£å¸¸å·¥ä½œ
- [ ] ApplicationServiceInterface æ­£å¸¸å·¥ä½œ
- [ ] UserActivityServiceInterface æ­£å¸¸å·¥ä½œ
- [ ] AuditLogServiceInterface æ­£å¸¸å·¥ä½œ

### å¹³å°çº§æœåŠ¡æµ‹è¯•

- [ ] InfraServiceRegistry å¯ä»¥æ³¨å†ŒæœåŠ¡
- [ ] InfraServiceLocator å¯ä»¥è·å–æœåŠ¡
- [ ] å¹³å°çº§æœåŠ¡ä¸ç³»ç»Ÿçº§æœåŠ¡éš”ç¦»

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæœåŠ¡æœªæ³¨å†Œ

**ç—‡çŠ¶ï¼š** `ServiceNotFoundError: æœåŠ¡ xxx æœªæ‰¾åˆ°`

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤æœåŠ¡åˆå§‹åŒ–æˆåŠŸ
2. æ£€æŸ¥ `ServiceInitializer._service_implementations` æ˜¯å¦åŒ…å«è¯¥æœåŠ¡
3. æ£€æŸ¥æœåŠ¡å®ç°ç±»æ˜¯å¦æ­£ç¡®ç»§æ‰¿æ¥å£

### é—®é¢˜2ï¼šä¾èµ–æ³¨å…¥è¿”å› None

**ç—‡çŠ¶ï¼š** `user_service` ä¸º `None`

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²æ³¨å†Œï¼š`ServiceLocator.has_service("user_service")`
2. æ£€æŸ¥æœåŠ¡åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ
3. æ£€æŸ¥ä¾èµ–æ³¨å…¥å‡½æ•°æ˜¯å¦æ­£ç¡®å®ç°

### é—®é¢˜3ï¼šç±»å‹ä¸åŒ¹é…

**ç—‡çŠ¶ï¼š** `TypeError: æœåŠ¡å®ä¾‹ç±»å‹ä¸åŒ¹é…`

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥æœåŠ¡å®ç°ç±»æ˜¯å¦æ­£ç¡®å®ç°æ¥å£çš„æ‰€æœ‰æ–¹æ³•
2. æ£€æŸ¥æœåŠ¡æ¥å£å®šä¹‰æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥æœåŠ¡æ³¨å†Œæ—¶æ˜¯å¦æ­£ç¡®æ³¨å†Œäº†æœåŠ¡ç±»å‹

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å·²æ³¨å†Œçš„æœåŠ¡

```python
from core.services.interfaces.service_registry import service_registry

# åˆ—å‡ºæ‰€æœ‰æœåŠ¡
print("å·²æ³¨å†Œçš„æœåŠ¡:", service_registry.list_services())
print("å·²æ³¨å†Œçš„æœåŠ¡ç±»å‹:", service_registry.list_service_types())
```

### 2. æ£€æŸ¥æœåŠ¡å®ä¾‹

```python
from core.services.interfaces.service_registry import ServiceLocator

# è·å–æœåŠ¡å¹¶æ£€æŸ¥ç±»å‹
user_service = ServiceLocator.get_service("user_service")
print("æœåŠ¡ç±»å‹:", type(user_service))
print("æœåŠ¡åç§°:", user_service.service_name)
print("æ˜¯å¦å®ç°æ¥å£:", isinstance(user_service, UserServiceInterface))
```

### 3. æµ‹è¯•æœåŠ¡æ–¹æ³•

```python
# æµ‹è¯•æœåŠ¡æ–¹æ³•æ˜¯å¦æ­£å¸¸å·¥ä½œ
user_service = ServiceLocator.get_service("user_service")

# æµ‹è¯•å¥åº·æ£€æŸ¥
health = await user_service.health_check()
print("å¥åº·çŠ¶æ€:", health)

# æµ‹è¯•å®é™…æ–¹æ³•ï¼ˆéœ€è¦æœ‰æ•ˆçš„ tenant_idï¼‰
# users = await user_service.get_user_list(tenant_id=1, page=1, page_size=10)
```

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```
## ç¬¬äºŒé˜¶æ®µæ”¹è¿›æµ‹è¯•æŠ¥å‘Š

### æµ‹è¯•ç¯å¢ƒ
- Python ç‰ˆæœ¬: 3.11.x
- æµ‹è¯•æ—¶é—´: YYYY-MM-DD HH:MM:SS
- æµ‹è¯•äººå‘˜: [å§“å]

### æµ‹è¯•ç»“æœ

#### 1. æœåŠ¡æ³¨å†Œæµ‹è¯•
- [ ] æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ: âœ…/âŒ
- [ ] æœåŠ¡æ³¨å†Œè¡¨å¯ä»¥è·å–æœåŠ¡: âœ…/âŒ
- [ ] æœåŠ¡å¥åº·æ£€æŸ¥æ­£å¸¸: âœ…/âŒ

#### 2. ä¾èµ–æ³¨å…¥æµ‹è¯•
- [ ] ä¾èµ–æ³¨å…¥å‡½æ•°å¯ä»¥è·å–æœåŠ¡: âœ…/âŒ
- [ ] API è·¯ç”±å¯ä»¥ä½¿ç”¨ä¾èµ–æ³¨å…¥: âœ…/âŒ

#### 3. å‘åå…¼å®¹æ€§æµ‹è¯•
- [ ] ç›´æ¥å¯¼å…¥æ–¹å¼ä»ç„¶å¯ç”¨: âœ…/âŒ
- [ ] ç°æœ‰ API è·¯ç”±æ­£å¸¸å·¥ä½œ: âœ…/âŒ

#### 4. å¹³å°çº§æœåŠ¡æµ‹è¯•
- [ ] å¹³å°çº§æœåŠ¡æ³¨å†Œè¡¨æ­£å¸¸: âœ…/âŒ

### å‘ç°çš„é—®é¢˜
1. [é—®é¢˜æè¿°]
2. [é—®é¢˜æè¿°]

### å»ºè®®
1. [å»ºè®®å†…å®¹]
2. [å»ºè®®å†…å®¹]
```

---

**æœ€åæ›´æ–°ï¼š** 2025-12-27
**ä½œè€…ï¼š** Luigi Lu

