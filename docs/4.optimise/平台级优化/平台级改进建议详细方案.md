# å¹³å°çº§æ”¹è¿›å»ºè®®è¯¦ç»†æ–¹æ¡ˆ

## ğŸ”§ é—®é¢˜1ï¼šWeakValueDictionaryå¯¼è‡´æœåŠ¡å®ä¾‹è¢«åƒåœ¾å›æ”¶

### é—®é¢˜æè¿°

**ä½ç½®**ï¼š`infra/services/service_registry.py:24`

```python
_services: WeakValueDictionary[str, Any]  # âŒ é—®é¢˜
```

**å½±å“**ï¼š
- æœåŠ¡å®ä¾‹å¯èƒ½è¢«åƒåœ¾å›æ”¶
- ä¸coreå±‚ç›¸åŒçš„é—®é¢˜ï¼ˆå·²åœ¨coreå±‚ä¿®å¤ï¼‰

### ä¿®å¤æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`infra/services/service_registry.py`

```python
# ä¿®æ”¹å‰
from weakref import WeakValueDictionary

class InfraServiceRegistry:
    _services: WeakValueDictionary[str, Any]
    
    def __new__(cls) -> 'InfraServiceRegistry':
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._services = WeakValueDictionary()  # âŒ
        return cls._instance

# ä¿®æ”¹å
from typing import Dict  # âœ…

class InfraServiceRegistry:
    _services: Dict[str, Any]  # âœ…
    
    def __new__(cls) -> 'InfraServiceRegistry':
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._services = {}  # âœ…
        return cls._instance
```

## ğŸ”§ é—®é¢˜2ï¼šAPIè·¯ç”±ä¸­ç›´æ¥å®ä¾‹åŒ–æœåŠ¡

### é—®é¢˜æè¿°

**ä½ç½®**ï¼šæ‰€æœ‰APIè·¯ç”±æ–‡ä»¶ï¼ˆ29å¤„ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# âŒ é—®é¢˜ï¼šç›´æ¥å®ä¾‹åŒ–
service = AuthService()
result = await service.login(data, request)
```

**å½±å“**ï¼š
- æ— æ³•è¿›è¡Œä¾èµ–æ³¨å…¥
- éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•
- ä¸ç¬¦åˆæœ€ä½³å®è·µ

### ä¿®å¤æ–¹æ¡ˆ

#### æ­¥éª¤1ï¼šåˆ›å»ºæœåŠ¡æ¥å£å®šä¹‰

**æ–°å»ºæ–‡ä»¶**ï¼š`infra/services/interfaces/service_interface.py`

```python
"""
å¹³å°çº§æœåŠ¡æ¥å£å®šä¹‰

å®šä¹‰å¹³å°çº§æœåŠ¡çš„ç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥å’Œæµ‹è¯•æ›¿æ¢ã€‚

Author: Luigi Lu
Date: 2025-12-27
"""

from abc import ABC, abstractmethod
from typing import Any, Dict, Optional


class InfraServiceInterface(ABC):
    """å¹³å°çº§æœåŠ¡æ¥å£åŸºç±»"""
    
    @property
    @abstractmethod
    def service_name(self) -> str:
        """æœåŠ¡åç§°"""
        pass
    
    @property
    @abstractmethod
    def service_version(self) -> str:
        """æœåŠ¡ç‰ˆæœ¬"""
        pass
    
    @abstractmethod
    async def health_check(self) -> Dict[str, Any]:
        """æœåŠ¡å¥åº·æ£€æŸ¥"""
        pass


class AuthServiceInterface(InfraServiceInterface):
    """è®¤è¯æœåŠ¡æ¥å£"""
    
    service_name = "auth_service"
    service_version = "1.0.0"
    
    @abstractmethod
    async def login(self, data: Any, request: Any) -> Dict[str, Any]:
        """ç”¨æˆ·ç™»å½•"""
        pass
    
    @abstractmethod
    async def register(self, data: Any) -> Any:
        """ç”¨æˆ·æ³¨å†Œ"""
        pass
    
    @abstractmethod
    async def guest_login(self) -> Dict[str, Any]:
        """ä½“éªŒç™»å½•"""
        pass


class TenantServiceInterface(InfraServiceInterface):
    """ç»„ç»‡æœåŠ¡æ¥å£"""
    
    service_name = "tenant_service"
    service_version = "1.0.0"
    
    @abstractmethod
    async def list_tenants(
        self,
        page: int = 1,
        page_size: int = 10,
        **kwargs
    ) -> Dict[str, Any]:
        """è·å–ç»„ç»‡åˆ—è¡¨"""
        pass
    
    @abstractmethod
    async def get_tenant_by_id(self, tenant_id: int) -> Optional[Any]:
        """æ ¹æ®IDè·å–ç»„ç»‡"""
        pass
```

#### æ­¥éª¤2ï¼šåˆ›å»ºæœåŠ¡å®ç°é€‚é…å™¨

**æ–°å»ºæ–‡ä»¶**ï¼š`infra/services/interfaces/implementations/auth_service_impl.py`

```python
"""
è®¤è¯æœåŠ¡å®ç°

å°†AuthServiceé€‚é…ä¸ºAuthServiceInterfaceæ¥å£å®ç°ã€‚

Author: Luigi Lu
Date: 2025-12-27
"""

from typing import Any, Dict
from infra.services.interfaces.service_interface import AuthServiceInterface
from infra.services.auth_service import AuthService


class AuthServiceImpl(AuthServiceInterface):
    """è®¤è¯æœåŠ¡å®ç°ç±»"""
    
    def __init__(self):
        self._auth_service = AuthService()
    
    @property
    def service_name(self) -> str:
        return "auth_service"
    
    @property
    def service_version(self) -> str:
        return "1.0.0"
    
    async def health_check(self) -> Dict[str, Any]:
        """æœåŠ¡å¥åº·æ£€æŸ¥"""
        return {
            "status": "healthy",
            "service": "auth_service",
            "version": self.service_version
        }
    
    async def login(self, data: Any, request: Any) -> Dict[str, Any]:
        """ç”¨æˆ·ç™»å½•"""
        return await self._auth_service.login(data, request)
    
    async def register(self, data: Any) -> Any:
        """ç”¨æˆ·æ³¨å†Œ"""
        return await self._auth_service.register(data)
    
    async def guest_login(self) -> Dict[str, Any]:
        """ä½“éªŒç™»å½•"""
        return await self._auth_service.guest_login()
```

#### æ­¥éª¤3ï¼šåˆ›å»ºä¾èµ–æ³¨å…¥å‡½æ•°

**æ–°å»ºæ–‡ä»¶**ï¼š`infra/api/deps/services.py`

```python
"""
å¹³å°çº§æœåŠ¡ä¾èµ–æ³¨å…¥

æä¾› FastAPI Depends å‡½æ•°ï¼Œç”¨äºä¾èµ–æ³¨å…¥å¹³å°çº§æœåŠ¡ã€‚

Author: Luigi Lu
Date: 2025-12-27
"""

from typing import Optional
from fastapi import Depends
from infra.services.service_registry import InfraServiceLocator
from infra.services.interfaces.service_interface import (
    AuthServiceInterface,
    TenantServiceInterface,
)


def get_auth_service() -> Optional[AuthServiceInterface]:
    """
    è·å–è®¤è¯æœåŠ¡ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
    
    Returns:
        Optional[AuthServiceInterface]: è®¤è¯æœåŠ¡å®ä¾‹ï¼Œå¦‚æœæœªæ³¨å†Œåˆ™è¿”å› None
    """
    try:
        return InfraServiceLocator.get_service("auth_service")
    except Exception:
        # å‘åå…¼å®¹ï¼šå¦‚æœæœåŠ¡æœªæ³¨å†Œï¼Œè¿”å› None
        # è°ƒç”¨æ–¹å¯ä»¥å›é€€åˆ°ç›´æ¥å¯¼å…¥ AuthService
        return None


def get_tenant_service() -> Optional[TenantServiceInterface]:
    """
    è·å–ç»„ç»‡æœåŠ¡ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
    
    Returns:
        Optional[TenantServiceInterface]: ç»„ç»‡æœåŠ¡å®ä¾‹ï¼Œå¦‚æœæœªæ³¨å†Œåˆ™è¿”å› None
    """
    try:
        return InfraServiceLocator.get_service("tenant_service")
    except Exception:
        return None
```

#### æ­¥éª¤4ï¼šä¿®æ”¹APIè·¯ç”±ä½¿ç”¨ä¾èµ–æ³¨å…¥

**ä¿®æ”¹æ–‡ä»¶**ï¼š`infra/api/auth/auth.py`

```python
# ä¿®æ”¹å‰
@router.post("/login", response_model=LoginResponse)
async def login(
    data: LoginRequest,
    request: Request
):
    service = AuthService()  # âŒ ç›´æ¥å®ä¾‹åŒ–
    result = await service.login(data, request)
    return LoginResponse(**result)

# ä¿®æ”¹å
from infra.api.deps.services import get_auth_service
from infra.services.interfaces.service_interface import AuthServiceInterface
from infra.services.auth_service import AuthService

@router.post("/login", response_model=LoginResponse)
async def login(
    data: LoginRequest,
    request: Request,
    auth_service: Optional[AuthServiceInterface] = Depends(get_auth_service)  # âœ… ä¾èµ–æ³¨å…¥
):
    # âš ï¸ ç¬¬ä¸‰é˜¶æ®µæ”¹è¿›ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥çš„æœåŠ¡
    if auth_service:
        result = await auth_service.login(data, request)
    else:
        # å‘åå…¼å®¹ï¼šå›é€€åˆ°ç›´æ¥å¯¼å…¥
        service = AuthService()
        result = await service.login(data, request)
    
    return LoginResponse(**result)
```

## ğŸ”§ é—®é¢˜3ï¼šAPIå±‚ç›´æ¥æŸ¥è¯¢æ•°æ®åº“

### é—®é¢˜æè¿°

**ä½ç½®**ï¼š`infra/api/auth/auth.py:145-152`

```python
# âŒ é—®é¢˜ï¼šAPIå±‚ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
@router.get("/me", response_model=CurrentUserResponse)
async def get_current_user_info(
    current_user: User = Depends(get_current_user)
):
    from infra.models.tenant import Tenant
    
    # âŒ APIå±‚ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
    tenant_name = None
    if current_user.tenant_id:
        tenant = await Tenant.get_or_none(id=current_user.tenant_id)
        if tenant:
            tenant_name = tenant.name
```

**å½±å“**ï¼š
- è¿ååˆ†å±‚æ¶æ„åŸåˆ™
- ä¸šåŠ¡é€»è¾‘åˆ†æ•£
- éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤

### ä¿®å¤æ–¹æ¡ˆ

**æ­¥éª¤1ï¼šåœ¨æœåŠ¡å±‚æ·»åŠ æ–¹æ³•**

**ä¿®æ”¹æ–‡ä»¶**ï¼š`infra/services/user_service.py`

```python
async def get_user_with_tenant_info(self, user_id: int) -> Dict[str, Any]:
    """
    è·å–ç”¨æˆ·åŠå…¶ç»„ç»‡ä¿¡æ¯
    
    Args:
        user_id: ç”¨æˆ·ID
        
    Returns:
        Dict[str, Any]: ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«ç»„ç»‡åç§°ï¼‰
    """
    from infra.models.tenant import Tenant
    
    user = await User.get_or_none(id=user_id)
    if not user:
        return None
    
    tenant_name = None
    if user.tenant_id:
        tenant = await Tenant.get_or_none(id=user.tenant_id)
        if tenant:
            tenant_name = tenant.name
    
    return {
        "id": user.id,
        "uuid": str(user.uuid),
        "username": user.username,
        "email": user.email,
        "full_name": user.full_name,
        "tenant_id": user.tenant_id,
        "tenant_name": tenant_name,
        "is_active": user.is_active,
        "is_infra_admin": user.is_infra_admin,
        "is_tenant_admin": user.is_tenant_admin,
    }
```

**æ­¥éª¤2ï¼šä¿®æ”¹APIè·¯ç”±**

**ä¿®æ”¹æ–‡ä»¶**ï¼š`infra/api/auth/auth.py`

```python
# ä¿®æ”¹å
@router.get("/me", response_model=CurrentUserResponse)
async def get_current_user_info(
    current_user: User = Depends(get_current_user),
    user_service: Optional[UserServiceInterface] = Depends(get_user_service)  # âœ… ä¾èµ–æ³¨å…¥
):
    # âœ… ä½¿ç”¨æœåŠ¡å±‚æ–¹æ³•
    if user_service:
        user_info = await user_service.get_user_with_tenant_info(current_user.id)
    else:
        # å‘åå…¼å®¹
        from infra.services.user_service import UserService
        service = UserService()
        user_info = await service.get_user_with_tenant_info(current_user.id)
    
    return CurrentUserResponse(**user_info)
```

## ğŸ”§ é—®é¢˜4ï¼šé‡å¤çš„æ–‡æ¡£å­—ç¬¦ä¸²

### é—®é¢˜æè¿°

**ä½ç½®**ï¼š`infra/api/tenants/tenants.py:35-76`

```python
async def list_tenants_for_superadmin(...):
    """
    è·å–ç»„ç»‡åˆ—è¡¨ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
    ...
    """
    from loguru import logger
    logger.info(...)
    """
    è·å–ç»„ç»‡åˆ—è¡¨ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰  # âŒ é‡å¤çš„æ–‡æ¡£å­—ç¬¦ä¸²
    ...
    """
```

### ä¿®å¤æ–¹æ¡ˆ

**åˆ é™¤é‡å¤çš„æ–‡æ¡£å­—ç¬¦ä¸²**

```python
# ä¿®æ”¹å
async def list_tenants_for_superadmin(...):
    """
    è·å–ç»„ç»‡åˆ—è¡¨ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
    
    è·å–æ‰€æœ‰ç»„ç»‡çš„åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µã€ç­›é€‰å’Œæœç´¢ã€‚
    æ­¤æ¥å£éœ€è¦å¹³å°è¶…çº§ç®¡ç†å‘˜æƒé™ã€‚
    
    Args:
        ...
    Returns:
        TenantListResponse: ç»„ç»‡åˆ—è¡¨å“åº”æ•°æ®
    """
    from loguru import logger
    logger.info(...)
    # âœ… åˆ é™¤é‡å¤çš„æ–‡æ¡£å­—ç¬¦ä¸²
    service = TenantService()
    ...
```

## ğŸ“‹ æ”¹è¿›ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§1ï¼šå…³é”®é—®é¢˜ä¿®å¤ï¼ˆç«‹å³ï¼‰

1. âœ… ä¿®å¤WeakValueDictionaryé—®é¢˜
2. âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
3. âœ… ä¿®å¤ä»£ç è§„èŒƒé—®é¢˜ï¼ˆåˆ é™¤é‡å¤æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰

### ä¼˜å…ˆçº§2ï¼šæ¶æ„æ”¹è¿›ï¼ˆçŸ­æœŸï¼‰

1. â³ å¼•å…¥æœåŠ¡æ¥å£å®šä¹‰
2. â³ å®ç°ä¾èµ–æ³¨å…¥
3. â³ ä½¿ç”¨æœåŠ¡æ³¨å†Œè¡¨

### ä¼˜å…ˆçº§3ï¼šæœ€ä½³å®è·µï¼ˆä¸­æœŸï¼‰

1. â³ ç»Ÿä¸€æœåŠ¡æ–¹æ³•ç­¾å
2. â³ å®Œå–„å•å…ƒæµ‹è¯•
3. â³ å®Œå–„æ–‡æ¡£

---

**æœ€åæ›´æ–°ï¼š** 2025-12-27  
**ä½œè€…ï¼š** Luigi Lu

