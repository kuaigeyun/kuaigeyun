# 热重载优化说明

## 问题描述

开发过程中，稍微修改代码就会触发服务重启，影响开发效率。

## 优化方案

### 后端优化（Uvicorn）

已优化 `start-backend.sh` 脚本，添加以下配置：

1. **排除不必要的文件和目录**：
   - `__pycache__` 目录及其所有内容
   - Python 编译文件（`.pyc`, `.pyo`, `.pyd`）
   - 虚拟环境目录（`.venv`, `venv*`）
   - Git 目录
   - 缓存目录（`.mypy_cache`, `.pytest_cache`, `.ruff_cache`）
   - 日志文件（`*.log`）
   - 临时文件（`*.tmp`）
   - IDE 配置目录（`.vscode`, `.idea`）
   - 系统文件（`.DS_Store`, `Thumbs.db`）

2. **增加检测延迟**：
   - `--reload-delay 0.5`：将检测间隔从默认的 0.25 秒增加到 0.5 秒
   - 在 Windows 环境下更加稳定，减少频繁触发

### 前端优化（Vite）

前端配置已经比较优化：

1. **文件监听配置**：
   - Windows 环境下使用轮询模式（`usePolling: true`）
   - 轮询间隔：1 秒（1000ms）
   - 二进制文件检测间隔：2 秒（2000ms）

2. **HMR（Hot Module Replacement）**：
   - 启用 Fast Refresh
   - 只监听源码文件类型：`js, jsx, ts, tsx, json, css, less, scss, html`
   - 已排除后端目录、node_modules 等

## 使用建议

### 后端

如果仍然频繁重启，可以进一步调整：

1. **增加延迟时间**：
   ```bash
   --reload-delay 1.0  # 增加到 1 秒
   ```

2. **减少监听目录**：
   ```bash
   --reload-dir src/core  # 只监听特定目录
   --reload-dir src/infra
   ```

### 前端

如果 HMR 响应慢，可以：

1. **减少轮询间隔**（但会增加 CPU 占用）：
   ```typescript
   interval: 500,  // 从 1000ms 减少到 500ms
   ```

2. **禁用轮询**（如果文件系统事件正常工作）：
   ```typescript
   usePolling: false,
   ```

## 注意事项

1. **后端重启是正常的**：Python 是解释型语言，代码修改后需要重新加载模块，这会导致服务重启。优化只能减少不必要的重启，不能完全避免。

2. **前端使用 HMR**：React 组件修改应该使用 HMR（热模块替换），而不是完全重启。如果遇到完全重启的情况，可能是代码结构问题（如组件外部的副作用）。

3. **Windows 环境**：Windows 文件系统事件可能不如 Linux/Mac 稳定，因此使用了轮询模式。这会导致一定的性能开销，但能保证文件变化能被检测到。

## 验证优化效果

重启服务后，观察以下情况：

1. **后端**：
   - 修改 Python 代码时，只应该在真正的代码文件变化时重启
   - `__pycache__` 目录变化不应该触发重启
   - 日志文件写入不应该触发重启

2. **前端**：
   - 修改 React 组件时，应该使用 HMR（页面不刷新，只更新组件）
   - 修改样式文件时，应该即时更新
   - 修改配置文件时，可能需要手动刷新

---

**最后更新**：2026-01-16
**作者**：Luigi Lu
