# 系统级/应用级协同开发计划

## 📋 计划概述

**目标：** 建立系统级（core/infra）和应用级（apps）的协同开发机制，确保两个层级互相隔离、互相配合  
**时间范围：** 2025-12-27 至 2026-06-15（约5.5个月）  
**总体策略：** 系统级先行，应用级跟进，分阶段协同

---

## 1. 层级职责划分

### 1.1 系统级（core/infra）职责

**核心职责：**
- ✅ 提供基础功能和服务（用户、角色、权限、组织等）
- ✅ 提供平台级功能（租户、套餐、认证等）
- ✅ 提供应用管理机制（应用注册、路由管理、菜单管理等）
- ✅ 提供数据访问层（数据库连接、ORM、缓存等）
- ✅ 提供通用工具和服务（文件管理、消息、审批流程等）

**不负责：**
- ❌ 业务逻辑实现（由应用级负责）
- ❌ 业务数据模型（由应用级负责）
- ❌ 业务API路由（由应用级负责）

### 1.2 应用级（apps）职责

**核心职责：**
- ✅ 实现业务逻辑（快智造、主数据管理等）
- ✅ 定义业务数据模型（工单、物料、BOM等）
- ✅ 实现业务API路由（工单管理、报工管理等）
- ✅ 实现业务前端页面（工单列表、报工界面等）

**不负责：**
- ❌ 基础功能实现（由系统级提供）
- ❌ 平台级功能实现（由系统级提供）
- ❌ 应用管理机制实现（由系统级提供）

### 1.3 层级接口规范

**系统级 → 应用级：**
- 提供标准化的API接口（用户、角色、权限等）
- 提供应用注册和管理机制
- 提供数据访问和ORM支持
- 提供通用服务和工具

**应用级 → 系统级：**
- 通过标准接口调用系统级功能
- 通过应用注册机制注册应用
- 通过标准数据模型访问数据
- 通过标准服务接口使用服务

**应用级 → 应用级：**
- 通过API调用其他应用的功能（如快智造调用主数据管理API）
- 通过标准接口进行应用间通信

---

## 2. 系统级优化计划（调整后）

### 2.1 第一阶段：基础能力建设（3-4周）- 与快智造MVP并行

**目标：** 为快智造MVP提供必需的基础能力

**任务清单：**
- [ ] **完善文件头注释**（1-2天）
  - 所有Python文件添加Author和Date
  - 影响：100+个文件
  - **快智造依赖：** 无直接依赖，但提升代码质量

- [ ] **应用管理机制完善**（1周）
  - 完善应用注册和路由管理
  - 完善应用菜单配置机制
  - 完善应用依赖检查机制
  - **快智造依赖：** ✅ 必需 - 快智造需要注册应用

- [ ] **编码规则服务**（0.5周）
  - 实现编码规则管理服务
  - 提供编码生成API
  - **快智造依赖：** ✅ 必需 - 工单号生成需要

- [ ] **数据访问层优化**（1周）
  - 优化数据库连接池
  - 优化ORM查询性能
  - 实现查询缓存机制
  - **快智造依赖：** ✅ 必需 - 大数据量查询需要

- [ ] **文件管理服务完善**（0.5周）
  - 完善文件上传/下载API
  - 支持文件预览
  - **快智造依赖：** ⚠️ 可选 - 报工附件需要

**交付物：**
- ✅ 完善的应用管理机制
- ✅ 编码规则服务
- ✅ 优化的数据访问层
- ✅ 完善的文件管理服务

**完成时间：** 2026-01-24（与快智造MVP第1周并行）

### 2.2 第二阶段：服务接口层完善（3-4周）- 与快智造MVP并行

**目标：** 完善服务接口层，支持依赖注入

**任务清单：**
- [ ] **定义核心服务接口**（2周）
  - 定义部门管理服务接口（DepartmentServiceInterface）
  - 定义系统参数服务接口（SystemParameterServiceInterface）
  - 定义文件管理服务接口（FileServiceInterface）
  - 定义菜单管理服务接口（MenuServiceInterface）
  - 定义权限管理服务接口（PermissionServiceInterface）
  - 定义编码规则服务接口（CodeRuleServiceInterface）
  - **快智造依赖：** ⚠️ 可选 - 提升代码质量，但不阻塞MVP

- [ ] **创建服务适配器**（2周）
  - 创建所有服务适配器实现
  - 注册到服务注册表
  - **快智造依赖：** ⚠️ 可选 - 提升代码质量，但不阻塞MVP

- [ ] **创建依赖注入函数**（1周）
  - 创建所有服务的依赖注入函数
  - 提供fallback机制
  - **快智造依赖：** ⚠️ 可选 - 提升代码质量，但不阻塞MVP

**交付物：**
- ✅ 完整的服务接口定义
- ✅ 完整的服务适配器实现
- ✅ 完整的依赖注入函数

**完成时间：** 2026-02-21（与快智造MVP第2-5周并行）

### 2.3 第三阶段：API路由迁移（2-3周）- 快智造MVP后

**目标：** 迁移所有API路由到依赖注入模式

**任务清单：**
- [ ] **迁移核心API路由**（2-3周）
  - 迁移用户管理API（部分已完成）
  - 迁移部门管理API
  - 迁移系统参数API
  - 迁移文件管理API
  - 迁移菜单管理API
  - 迁移权限管理API
  - **快智造依赖：** ⚠️ 可选 - 提升代码质量，但不阻塞MVP

**交付物：**
- ✅ 所有API路由使用依赖注入

**完成时间：** 2026-03-14（快智造MVP完成后）

### 2.4 第四阶段：MES系统针对性能力建设（4-6周）- 快智造第一阶段扩展前

**目标：** 为快智造第一阶段扩展提供必需的能力

**任务清单：**
- [ ] **实时数据推送机制**（1-2周）
  - 实现WebSocket/SSE支持
  - 实现数据推送机制
  - 实现断线重连机制
  - **快智造依赖：** ✅ 必需 - 生产看板实时更新需要

- [ ] **大数据量查询优化**（1-2周）
  - 优化数据库索引
  - 实现游标分页
  - 实现查询缓存
  - **快智造依赖：** ✅ 必需 - MRP/LRP运算需要

- [ ] **流程引擎增强**（2-3周）
  - 增强审批流程引擎
  - 支持条件分支和并行流程
  - **快智造依赖：** ⚠️ 可选 - 工单审批需要（可选）

- [ ] **报表系统增强**（2-3周）
  - 实现报表设计器
  - 实现报表导出（Excel、PDF）
  - **快智造依赖：** ✅ 必需 - 生产报表需要

**交付物：**
- ✅ 实时数据推送机制
- ✅ 大数据量查询优化
- ✅ 流程引擎增强
- ✅ 报表系统增强

**完成时间：** 2026-04-25（快智造第一阶段扩展前）

---

## 3. 应用级开发计划（快智造）

### 3.1 MVP阶段（6周）- 2026-01-03 至 2026-02-14

**目标：** 快速上线，验证核心MES功能

**依赖系统级能力：**
- ✅ 应用管理机制（第1周完成）
- ✅ 编码规则服务（第1周完成）
- ✅ 数据访问层优化（第1周完成）
- ⚠️ 文件管理服务（可选，第1周完成）

**功能范围：**
- 工单管理（创建、下达、执行、完工）
- 报工管理（扫码报工、进度汇报）
- 仓储操作（生产领料、成品入库、库存查询）
- 生产看板（工单进度、状态监控）

**与系统级配合：**
- 使用系统级应用管理机制注册应用
- 使用系统级编码规则服务生成工单号
- 使用系统级数据访问层访问数据库
- 调用主数据管理API获取基础数据

### 3.2 第一阶段扩展（8-10周）- 2026-02-17 至 2026-04-25

**目标：** 支持MTS/MTO模式，完善计划管理

**依赖系统级能力：**
- ✅ 实时数据推送机制（第4阶段完成）
- ✅ 大数据量查询优化（第4阶段完成）
- ✅ 报表系统增强（第4阶段完成）
- ⚠️ 流程引擎增强（可选）

**功能范围：**
- 需求管理（销售预测、销售订单）
- 计划排程（MRP运算、LRP运算）
- 高级排产（排产甘特图）
- 采购管理（采购单、采购入库）
- 销售出库（MTO关联订单、MTS从库存发货）

**与系统级配合：**
- 使用系统级实时数据推送机制更新生产看板
- 使用系统级大数据量查询优化支持MRP/LRP运算
- 使用系统级报表系统生成生产报表
- 调用主数据管理API获取客户、供应商、工艺路线数据

### 3.3 第二阶段扩展（6-8周）- 2026-04-28 至 2026-06-15

**目标：** 完善质量管理，增加财务协同

**依赖系统级能力：**
- ✅ 所有系统级能力已完成

**功能范围：**
- 质量管理（来料检验、过程检验、成品检验）
- 财务协同（应付管理、应收管理）
- 高级报表（库存周转率、工单绩效分析、质量合格率统计）

**与系统级配合：**
- 使用系统级报表系统生成质量报表
- 使用系统级流程引擎（可选）支持检验审批

---

## 4. 应用级开发计划（主数据管理）

### 4.1 MVP支持优化（2周）- 2025-12-30 至 2026-01-10

**目标：** 优化API，满足快智造MVP需求

**与系统级配合：**
- 使用系统级数据访问层
- 使用系统级应用管理机制

**与快智造配合：**
- 提供批量查询接口（快智造需要）
- 提供简化查询接口（快智造需要）
- 优化BOM查询接口（快智造需要）
- 完善数据验证接口（快智造需要）

### 4.2 概念统一和文档完善（0.5周）- 2026-01-13 至 2026-01-17

**目标：** 统一概念，完善文档

**与快智造配合：**
- 明确工作中心概念（ProductionLine = 工作中心）
- 明确工厂层级关系
- 更新API文档

### 4.3 第一阶段扩展支持（1周）- 2026-02-17 至 2026-02-21

**目标：** 确保支持快智造第一阶段功能

**与快智造配合：**
- 优化工艺路线查询接口（MRP/LRP运算需要）
- 确认供应链数据API完整性（销售订单、采购单需要）

### 4.4 前端组件优化（1周）- 2026-02-24 至 2026-02-28

**目标：** 优化前端选择组件

**与快智造配合：**
- 创建统一的基础数据选择组件
- 支持缓存机制，减少API调用

---

## 5. 协同开发时间表

### 5.1 整体时间表

| 时间段 | 系统级任务 | 主数据管理任务 | 快智造任务 | 状态 |
|--------|-----------|--------------|-----------|------|
| 2025-12-30 ~ 2026-01-10 | 基础能力建设 | MVP支持优化 | 准备阶段 | ⏳ |
| 2026-01-13 ~ 2026-01-24 | 基础能力建设 | 概念统一 | 基础架构搭建 | ⏳ |
| 2026-01-27 ~ 2026-02-14 | 服务接口层完善 | - | MVP开发 | ⏳ |
| 2026-02-17 ~ 2026-02-28 | 服务接口层完善 | 第一阶段扩展支持、前端组件优化 | MVP测试 | ⏳ |
| 2026-03-03 ~ 2026-03-14 | API路由迁移 | - | MVP发布 | ⏳ |
| 2026-03-17 ~ 2026-04-25 | MES系统针对性能力建设 | - | 第一阶段扩展开发 | ⏳ |
| 2026-04-28 ~ 2026-06-15 | - | - | 第二阶段扩展开发 | ⏳ |

### 5.2 关键里程碑

**里程碑1（2026-01-24）：** 系统级基础能力建设完成
- ✅ 应用管理机制完善
- ✅ 编码规则服务完成
- ✅ 数据访问层优化完成
- **快智造影响：** 可以开始MVP开发

**里程碑2（2026-02-14）：** 快智造MVP完成
- ✅ 工单管理、报工管理、仓储管理、生产看板
- **系统级影响：** 可以开始API路由迁移

**里程碑3（2026-04-25）：** 系统级MES能力建设完成
- ✅ 实时数据推送机制完成
- ✅ 大数据量查询优化完成
- ✅ 报表系统增强完成
- **快智造影响：** 可以开始第一阶段扩展开发

**里程碑4（2026-06-15）：** 快智造完整功能发布
- ✅ 所有功能完成
- **系统级影响：** 系统级优化计划完成

---

## 6. 接口规范与标准

### 6.1 系统级 → 应用级接口

**应用管理接口：**
```python
# 应用注册
POST /api/v1/core/applications
Body: {
    "code": "kuaizhizao",
    "name": "快智造",
    "dependencies": ["master_data"]
}

# 应用路由注册
ApplicationRouteManager.register_app_routes(app_code, route_module_path)

# 应用菜单注册
通过 manifest.json 配置菜单
```

**编码规则接口：**
```python
# 生成编码
POST /api/v1/core/code-rules/generate
Body: {
    "rule_code": "work_order_no",
    "params": {}
}
Response: {
    "code": "WO20260101001"
}
```

**数据访问接口：**
```python
# 通过ORM访问数据库
from core.models.base import BaseModel
from tortoise import fields

class WorkOrder(BaseModel):
    # 使用系统级BaseModel
    pass
```

**文件管理接口：**
```python
# 文件上传
POST /api/v1/core/files/upload
# 文件下载
GET /api/v1/core/files/{file_uuid}/download
```

### 6.2 应用级 → 应用级接口

**主数据管理 → 快智造：**
```python
# 批量查询物料
POST /api/v1/apps/master-data/materials/batch
Body: {"uuids": ["uuid1", "uuid2"]}
Response: List[MaterialResponse]

# 简化查询车间
GET /api/v1/apps/master-data/factory/workshops/simple
Response: List[SimpleWorkshopResponse]

# BOM多层级展开
GET /api/v1/apps/master-data/materials/bom/expand/{material_uuid}
Response: BOMExpandResponse

# 数据验证
GET /api/v1/apps/master-data/validation/work-order-data-integrity
Query: material_uuid, workshop_uuid, production_line_uuid
Response: ValidationResponse
```

### 6.3 接口调用规范

**调用原则：**
1. **应用级必须通过API调用系统级功能**，不能直接访问系统级数据库
2. **应用级之间通过API调用**，不能直接访问其他应用的数据库
3. **所有API调用必须包含认证信息**（JWT Token）
4. **所有API调用必须包含租户信息**（tenant_id）

**错误处理：**
- 使用统一的错误响应格式
- 使用自定义异常类
- 提供详细的错误信息

---

## 7. 数据隔离与安全

### 7.1 数据隔离机制

**系统级数据：**
- 用户、角色、权限、组织等
- 通过 `tenant_id` 隔离
- 系统级服务负责数据隔离

**应用级数据：**
- 工单、报工、库存等（快智造）
- 物料、BOM、工厂等（主数据管理）
- 通过 `tenant_id` 隔离
- 应用级服务负责数据隔离

**隔离原则：**
- 系统级和应用级数据完全隔离
- 应用级不能直接访问系统级数据表
- 应用级必须通过API调用系统级功能

### 7.2 安全机制

**认证机制：**
- 统一使用JWT Token认证
- 系统级提供认证服务
- 应用级使用系统级认证服务

**授权机制：**
- 统一使用RBAC权限模型
- 系统级提供权限管理服务
- 应用级使用系统级权限服务

**数据安全：**
- 所有数据访问必须经过权限检查
- 所有API调用必须包含租户信息
- 所有敏感操作必须记录审计日志

---

## 8. 开发规范与标准

### 8.1 代码规范

**系统级代码规范：**
- 所有Python文件必须有文件头注释（Author、Date）
- 所有API路由必须使用依赖注入
- API层不能直接查询数据库
- 使用统一的错误处理机制

**应用级代码规范：**
- 遵循系统级代码规范
- 应用级代码独立管理
- 应用级代码不能直接访问系统级代码
- 应用级代码必须通过API调用系统级功能

### 8.2 测试规范

**系统级测试：**
- 单元测试覆盖所有服务
- 集成测试覆盖所有API
- 性能测试覆盖关键功能

**应用级测试：**
- 单元测试覆盖所有业务逻辑
- 集成测试覆盖所有API
- 端到端测试覆盖关键业务流程

### 8.3 文档规范

**系统级文档：**
- API文档（OpenAPI/Swagger）
- 服务接口文档
- 开发指南

**应用级文档：**
- 应用功能文档
- API文档（OpenAPI/Swagger）
- 用户手册

---

## 9. 风险与应对

### 9.1 技术风险

**风险1：系统级能力建设延迟影响应用级开发**
- **应对：** 系统级优先完成快智造MVP必需的能力
- **缓解措施：** 提供fallback机制，应用级可以先使用直接调用

**风险2：应用级需求变化影响系统级设计**
- **应对：** 系统级提供灵活的可扩展接口
- **缓解措施：** 系统级接口设计考虑未来扩展

**风险3：应用间接口变更影响其他应用**
- **应对：** 建立接口版本管理机制
- **缓解措施：** 保持向后兼容，逐步废弃旧接口

### 9.2 时间风险

**风险1：开发时间可能超出预期**
- **应对：** 分阶段实施，优先完成高优先级任务
- **缓解措施：** 预留缓冲时间（20%）

**风险2：系统级和应用级开发时间冲突**
- **应对：** 系统级优先完成应用级必需的能力
- **缓解措施：** 并行开发，但系统级优先

### 9.3 质量风险

**风险1：系统级和应用级代码质量不一致**
- **应对：** 统一代码规范和代码审查机制
- **缓解措施：** 使用代码质量工具（Ruff、MyPy）

**风险2：接口调用性能问题**
- **应对：** 优化API性能，使用缓存机制
- **缓解措施：** 性能测试和监控

---

## 10. 成功标准

### 10.1 系统级成功标准

- ✅ 所有快智造MVP必需的能力已完成
- ✅ 所有服务都有接口定义和适配器实现
- ✅ 所有API路由都使用依赖注入
- ✅ 实时数据推送机制可用
- ✅ 大数据量查询性能提升50%以上
- ✅ 报表系统支持可视化配置和多种导出格式

### 10.2 应用级成功标准

**主数据管理：**
- ✅ 所有快智造需要的API接口已完成
- ✅ API性能满足快智造需求
- ✅ 前端组件库可用

**快智造：**
- ✅ MVP功能完整可用
- ✅ 支持MTS/MTO模式
- ✅ 支持完整的质量管理流程
- ✅ 支持财务协同
- ✅ 支持高级报表分析

### 10.3 协同成功标准

- ✅ 系统级和应用级完全隔离
- ✅ 应用级通过API调用系统级功能
- ✅ 应用级之间通过API调用
- ✅ 所有接口调用性能满足要求
- ✅ 所有接口调用安全可靠

---

## 11. 总结

### 11.1 核心原则

1. **层级隔离：** 系统级和应用级完全隔离，通过API调用
2. **职责清晰：** 系统级提供基础能力，应用级实现业务逻辑
3. **协同开发：** 系统级先行，应用级跟进，分阶段协同
4. **标准规范：** 统一的接口规范、代码规范、测试规范

### 11.2 关键时间节点

- **2026-01-24：** 系统级基础能力建设完成（快智造MVP可以开始）
- **2026-02-14：** 快智造MVP完成
- **2026-04-25：** 系统级MES能力建设完成（快智造第一阶段扩展可以开始）
- **2026-06-15：** 快智造完整功能发布

### 11.3 预期成果

- ✅ 系统级代码质量显著提升
- ✅ 应用级开发效率显著提高
- ✅ 系统级和应用级完全隔离
- ✅ 快智造完整功能可用
- ✅ 主数据管理API完善

---

**文档创建时间：** 2025-12-27  
**文档作者：** Luigi Lu  
**预计完成时间：** 2026-06-15

