# 修复 WinError 10013 端口权限错误

## 问题描述

启动后端服务时出现错误：
```
ERROR: [WinError 10013] 以一种访问权限不允许的方式做了一个访问套接字的尝试。
```

## 问题原因（已确认）

**根本原因**：端口 9000 位于 Windows 系统保留的端口范围内（8989-9088），无法被应用程序绑定。

可以通过以下命令查看 Windows 保留的端口范围：
```bash
netsh interface ipv4 show excludedportrange protocol=tcp
```

WinError 10013 通常由以下原因引起：
1. **系统保留端口** - Windows 系统保留了某些端口范围（**这是本次问题的根本原因**）
2. **Windows 防火墙阻止** - 防火墙阻止 Python 绑定端口
3. **安全软件阻止** - 杀毒软件或安全软件阻止端口绑定
4. **权限不足** - 需要管理员权限（虽然诊断显示已有管理员权限）

## 解决方案

### 方案 1：配置 Windows 防火墙（推荐）

1. **打开 Windows 防火墙设置**
   - 按 `Win + R`，输入 `wf.msc`，回车
   - 或者：设置 → 更新和安全 → Windows 安全中心 → 防火墙和网络保护

2. **添加入站规则**
   - 点击"高级设置"
   - 选择"入站规则" → "新建规则"
   - 选择"端口" → 下一步
   - 选择"TCP"，输入端口号 `9000` → 下一步
   - 选择"允许连接" → 下一步
   - 勾选所有配置文件（域、专用、公用）→ 下一步
   - 输入名称：`RiverEdge Backend Port 9000` → 完成

3. **添加出站规则**（可选，通常不需要）
   - 重复上述步骤，选择"出站规则"

### 方案 2：检查安全软件

1. **临时禁用安全软件测试**
   - 临时禁用杀毒软件或安全软件
   - 尝试启动后端服务
   - 如果成功，说明是安全软件阻止，需要在安全软件中添加 Python 和 uvicorn 的例外

2. **添加安全软件例外**
   - 在安全软件中添加以下路径到例外列表：
     - Python 可执行文件路径（通常在 `venv311\Scripts\python.exe`）
     - 项目目录：`F:\dev\riveredge\riveredge-backend`

### 方案 3：以管理员身份运行

1. **关闭当前的 Git Bash 或终端**
2. **以管理员身份重新打开**
   - 右键点击 Git Bash 快捷方式
   - 选择"以管理员身份运行"
3. **重新运行启动脚本**

### 方案 4：使用其他端口（✅ 已采用此方案）

**已解决**：由于端口 9000 在 Windows 保留范围内，已将后端端口改为 9100。

1. **后端端口已修改**
   - `riveredge-backend/start-backend.sh`：端口已改为 9100

2. **前端代理配置已修改**
   - `riveredge-frontend/src/vite.config.ts`：代理目标已改为 `http://127.0.0.1:9100`
   - `riveredge-frontend/vite.config.ts`：代理目标已改为 `http://127.0.0.1:9100`
   - `riveredge-frontend/src/services/user.ts`：默认 API 地址已改为 `http://localhost:9100`

**可用端口列表**（测试结果）：
- ✅ 端口 8080
- ✅ 端口 9100（已采用）
- ✅ 端口 9101
- ✅ 端口 10000

### 方案 5：检查端口占用

虽然诊断显示端口未被占用，但可以再次确认：

```bash
# 检查端口占用
netstat -ano | findstr :9000

# 如果发现占用，结束进程（替换 PID 为实际进程ID）
taskkill /PID <进程ID> /F
```

## 验证修复

修复后，运行诊断脚本验证：

```bash
cd riveredge-backend
python scripts/check_port_9000.py
```

如果显示"端口可用"，说明问题已解决。

## 仍然无法解决？

如果以上方案都无法解决，可能需要：
1. 联系系统管理员检查企业安全策略
2. 检查是否有组策略限制
3. 考虑在虚拟机或 WSL 中运行后端服务

