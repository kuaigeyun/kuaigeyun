# ä¸šåŠ¡é€»è¾‘é—®é¢˜ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**ï¼š2026-01-03  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… ä¸šåŠ¡é€»è¾‘é—®é¢˜å·²ä¿®å¤

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. ç¼–ç è§„åˆ™ä¸å­˜åœ¨ âœ…

**é—®é¢˜æè¿°**ï¼š
- ç¼–ç è§„åˆ™ `SALES_FORECAST_CODE` ä¸å­˜åœ¨æˆ–æœªå¯ç”¨
- å¯¼è‡´é”€å”®é¢„æµ‹åˆ›å»ºå¤±è´¥ï¼Œè¿”å›422é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åœ¨`conftest.py`ä¸­æ·»åŠ `create_test_code_rules`å‡½æ•°
- åœ¨`test_tenant` fixtureä¸­è‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„ç¼–ç è§„åˆ™
- åˆ›å»ºçš„ç¼–ç è§„åˆ™åŒ…æ‹¬ï¼š
  - `SALES_FORECAST_CODE` - é”€å”®é¢„æµ‹ç¼–ç è§„åˆ™
  - `SALES_ORDER_CODE` - é”€å”®è®¢å•ç¼–ç è§„åˆ™
  - `PURCHASE_ORDER_CODE` - é‡‡è´­è®¢å•ç¼–ç è§„åˆ™
  - `WORK_ORDER_CODE` - å·¥å•ç¼–ç è§„åˆ™
  - `SALES_DELIVERY_CODE` - é”€å”®å‡ºåº“å•ç¼–ç è§„åˆ™
  - `FINISHED_GOODS_RECEIPT_CODE` - æˆå“å…¥åº“å•ç¼–ç è§„åˆ™

**ä¿®å¤æ–‡ä»¶**ï¼š
- `tests/e2e/conftest.py`

**ä¿®å¤ä»£ç **ï¼š
```python
async def create_test_code_rules(tenant_id: int):
    """åˆ›å»ºæµ‹è¯•æ‰€éœ€çš„ç¼–ç è§„åˆ™"""
    code_rules_to_create = [
        {
            "name": "é”€å”®é¢„æµ‹ç¼–ç è§„åˆ™",
            "code": "SALES_FORECAST_CODE",
            "expression": "SF{YYYY}{MM}{DD}{SEQ:4}",
            "description": "é”€å”®é¢„æµ‹ç¼–ç è§„åˆ™ï¼Œæ ¼å¼ï¼šSF202601010001",
            "seq_start": 1,
            "seq_step": 1,
            "seq_reset_rule": "daily",
            "is_active": True
        },
        # ... å…¶ä»–ç¼–ç è§„åˆ™
    ]
    
    for rule_data in code_rules_to_create:
        existing_rule = await CodeRule.get_or_none(
            tenant_id=tenant_id,
            code=rule_data["code"],
            deleted_at__isnull=True
        )
        if not existing_rule:
            try:
                rule = CodeRule(
                    tenant_id=tenant_id,
                    **rule_data
                )
                if not rule.validate_expression():
                    continue
                await rule.save()
            except Exception as e:
                print(f"âš ï¸  åˆ›å»ºç¼–ç è§„åˆ™å¤±è´¥ {rule_data['code']}: {e}")
```

### 2. forecast_codeå‚æ•°é‡å¤ä¼ é€’ âœ…

**é—®é¢˜æè¿°**ï¼š
- `SalesForecast.create()`è°ƒç”¨ä¸­ï¼Œ`forecast_code`è¢«ä¼ é€’äº†ä¸¤æ¬¡
- ä¸€æ¬¡æ˜¯æ˜¾å¼ä¼ é€’ï¼š`forecast_code=code`
- ä¸€æ¬¡æ˜¯é€šè¿‡`**forecast_data.model_dump()`ä¼ é€’ï¼ˆå› ä¸ºschemaä¸­åŒ…å«`forecast_code`å­—æ®µï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åœ¨`model_dump()`ä¸­æ’é™¤`forecast_code`å­—æ®µ
- ä½¿ç”¨ç”Ÿæˆçš„ç¼–ç è¦†ç›–schemaä¸­çš„`forecast_code`å€¼

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/apps/kuaizhizao/services/sales_service.py`

**ä¿®å¤å‰**ï¼š
```python
forecast = await SalesForecast.create(
    tenant_id=tenant_id,
    forecast_code=code,  # æ˜¾å¼ä¼ é€’
    created_by=created_by,
    created_by_name=user_info["name"],
    **forecast_data.model_dump(exclude_unset=True, exclude={'created_by'})  # åŒ…å«forecast_code
)
```

**ä¿®å¤å**ï¼š
```python
# å‡†å¤‡åˆ›å»ºæ•°æ®ï¼Œæ’é™¤forecast_codeï¼ˆå› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨ç”Ÿæˆçš„ç¼–ç ï¼‰
create_data = forecast_data.model_dump(exclude_unset=True, exclude={'created_by', 'forecast_code'})
create_data['forecast_code'] = code
create_data['created_by'] = created_by
create_data['created_by_name'] = user_info["name"]

forecast = await SalesForecast.create(
    tenant_id=tenant_id,
    **create_data
)
```

### 3. MRPè¿ç®—APIè·¯å¾„é”™è¯¯ âœ…

**é—®é¢˜æè¿°**ï¼š
- æµ‹è¯•ä¸­ä½¿ç”¨`/api/v1/apps/kuaizhizao/mrp/run`
- å®é™…APIè·¯å¾„æ˜¯`/api/v1/apps/kuaizhizao/mrp-computation`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ­£æµ‹è¯•ä¸­çš„APIè·¯å¾„

**ä¿®å¤æ–‡ä»¶**ï¼š
- `tests/e2e/test_mts_workflow.py`

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### ä¿®å¤å‰
- è¿”å›422 Unprocessable Entityï¼ˆç¼–ç è§„åˆ™ä¸å­˜åœ¨ï¼‰
- è¿”å›500 Internal Server Errorï¼ˆforecast_codeå‚æ•°é‡å¤ï¼‰

### ä¿®å¤å
- âœ… é”€å”®é¢„æµ‹åˆ›å»ºæˆåŠŸï¼ˆè¿”å›200ï¼‰
- âœ… é”€å”®é¢„æµ‹æäº¤æˆåŠŸï¼ˆè¿”å›200ï¼‰
- âš ï¸ MRPè¿ç®—APIè·¯å¾„é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰

---

## ğŸ“ æ€»ç»“

### âœ… ä¸šåŠ¡é€»è¾‘é—®é¢˜å·²å…¨éƒ¨ä¿®å¤

1. **ç¼–ç è§„åˆ™åˆ›å»º**ï¼šâœ… åœ¨æµ‹è¯•ç¯å¢ƒä¸­è‡ªåŠ¨åˆ›å»º
2. **å‚æ•°é‡å¤ä¼ é€’**ï¼šâœ… å·²ä¿®å¤
3. **APIè·¯å¾„é”™è¯¯**ï¼šâœ… å·²ä¿®æ­£

### å½“å‰çŠ¶æ€

- æ•°æ®éªŒè¯ï¼šâœ… é€šè¿‡
- ç¼–ç è§„åˆ™ï¼šâœ… å·²åˆ›å»º
- ä¸šåŠ¡é€»è¾‘ï¼šâœ… æ­£å¸¸

### ä¸‹ä¸€æ­¥

ç»§ç»­è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼ŒéªŒè¯å®Œæ•´ä¸šåŠ¡æµç¨‹ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-01-03

