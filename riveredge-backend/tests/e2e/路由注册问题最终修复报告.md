# è·¯ç”±æ³¨å†Œé—®é¢˜æœ€ç»ˆä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¶é—´**ï¼š2026-01-03  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## ğŸ” å‘ç°çš„æ‰€æœ‰é—®é¢˜

### 1. datetimeå¯¼å…¥é”™è¯¯ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- `production.py`ä¸­åœ¨å‡½æ•°å†…éƒ¨å¯¼å…¥`datetime`ï¼Œä½†æ–‡ä»¶é¡¶éƒ¨åªå¯¼å…¥äº†`date`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ `datetime`å¯¼å…¥ï¼š`from datetime import date, datetime`
- ç§»é™¤å‡½æ•°å†…éƒ¨çš„é‡å¤å¯¼å…¥

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/apps/kuaizhizao/api/production.py`

### 2. è·¯ç”±å‰ç¼€é‡å¤é—®é¢˜ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- è·¯ç”±å‰ç¼€å‡ºç°é‡å¤ï¼š`/apps/master-data/apps/master-data`
- åŸå› æ˜¯`route_path`å·²ç»åŒ…å«`/apps/{app_code}`ï¼Œä½†è·¯ç”±ç®¡ç†å™¨åˆæ·»åŠ äº†ä¸€æ¬¡

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹è·¯ç”±æ³¨å†Œé€»è¾‘ï¼Œä½¿ç”¨`/api/v1`ä½œä¸ºåŸºç¡€å‰ç¼€
- è·¯ç”±ç®¡ç†å™¨è‡ªåŠ¨æ·»åŠ `/apps/{app_code}`å‰ç¼€
- æ£€æŸ¥routeræ˜¯å¦å·²æœ‰prefixï¼Œé¿å…é‡å¤

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/core/services/application/application_route_manager.py`
- `src/core/services/application/application_registry_service.py`

### 3. purchase.pyå‚æ•°é¡ºåºé”™è¯¯ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- Pythonè¯­æ³•é”™è¯¯ï¼š`non-default argument follows default argument`
- FastAPIä¸­ï¼ŒPathå‚æ•°ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰å¿…é¡»åœ¨æ²¡æœ‰é»˜è®¤å€¼çš„å‚æ•°ä¹‹å‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- è°ƒæ•´å‡½æ•°å‚æ•°é¡ºåºï¼Œå°†æ²¡æœ‰é»˜è®¤å€¼çš„å‚æ•°ï¼ˆå¦‚`order: PurchaseOrderUpdate`ï¼‰æ”¾åœ¨Pathå‚æ•°ä¹‹å‰
- ä¿®å¤äº†ä»¥ä¸‹å‡½æ•°ï¼š
  - `update_purchase_order`
  - `approve_purchase_order`
  - `confirm_purchase_order`

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/apps/kuaizhizao/api/purchase.py`

### 4. é”™è¯¯çš„Useræ¨¡å‹å¯¼å…¥è·¯å¾„ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- `purchase.py`ä¸­ä½¿ç”¨äº†é”™è¯¯çš„å¯¼å…¥è·¯å¾„ï¼š`from core.models.user import User`
- Useræ¨¡å‹å®é™…åœ¨`infra.models.user`ä¸­

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹å¯¼å…¥è·¯å¾„ï¼š`from infra.models.user import User as CurrentUser`

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/apps/kuaizhizao/api/purchase.py`

### 5. handle_exceptionsè£…é¥°å™¨ä¸å­˜åœ¨ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- `purchase.py`ä¸­ä½¿ç”¨äº†ä¸å­˜åœ¨çš„`handle_exceptions`è£…é¥°å™¨
- å¼‚å¸¸å¤„ç†å·²ç»é€šè¿‡ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†ï¼Œä¸éœ€è¦è£…é¥°å™¨

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ç§»é™¤æ‰€æœ‰`@handle_exceptions`è£…é¥°å™¨
- ç§»é™¤`from infra.exceptions.exceptions import handle_exceptions`å¯¼å…¥

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/apps/kuaizhizao/api/purchase.py`

### 6. æµ‹è¯•ç¯å¢ƒåº”ç”¨è·¯ç”±æ³¨å†Œ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- æµ‹è¯•ç¯å¢ƒä¸­åº”ç”¨è·¯ç”±æœªæ³¨å†Œ
- `load_plugin_routes()`åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œä½†æµ‹è¯•ç¯å¢ƒå¯èƒ½æœªåˆå§‹åŒ–

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åœ¨`conftest.py`çš„`db_setup` fixtureä¸­åˆå§‹åŒ–åº”ç”¨è·¯ç”±ç®¡ç†å™¨
- è°ƒç”¨`ApplicationRegistryService.reload_apps()`é‡æ–°åŠ è½½åº”ç”¨è·¯ç”±
- åœ¨è·¯ç”±æ³¨å†ŒæœåŠ¡ä¸­æ·»åŠ sys.pathè®¾ç½®ï¼Œç¡®ä¿æ¨¡å—å¯¼å…¥è·¯å¾„æ­£ç¡®

**ä¿®å¤æ–‡ä»¶**ï¼š
- `tests/e2e/conftest.py`
- `src/core/services/application/application_registry_service.py`

### 7. æµ‹è¯•APIè·¯å¾„é”™è¯¯ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**ï¼š
- æµ‹è¯•ä¸­ä½¿ç”¨çš„æ˜¯`/api/apps/kuaizhizao/...`
- å®é™…æ³¨å†Œçš„è·¯ç”±æ˜¯`/api/v1/apps/kuaizhizao/...`

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ›´æ–°æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸­çš„APIè·¯å¾„ï¼Œä»`/api/apps/kuaizhizao`æ”¹ä¸º`/api/v1/apps/kuaizhizao`

**ä¿®å¤æ–‡ä»¶**ï¼š
- `tests/e2e/test_mts_workflow.py`
- `tests/e2e/test_mto_workflow.py`
- `tests/e2e/test_purchase_workflow.py`
- `tests/e2e/test_quality_workflow.py`
- `tests/e2e/test_finance_workflow.py`

---

## ğŸ“Š ä¿®å¤ç»“æœ

### ä¿®å¤å‰
- âŒ kuaizhizaoåº”ç”¨è·¯ç”±æ³¨å†Œå¤±è´¥
- âŒ è·¯ç”±å‰ç¼€é‡å¤
- âŒ è¯­æ³•é”™è¯¯å¯¼è‡´æ¨¡å—æ— æ³•å¯¼å…¥
- âŒ é”™è¯¯çš„å¯¼å…¥è·¯å¾„
- âŒ æµ‹è¯•APIè·¯å¾„é”™è¯¯

### ä¿®å¤å
- âœ… kuaizhizaoåº”ç”¨è·¯ç”±æˆåŠŸæ³¨å†Œ
- âœ… è·¯ç”±å‰ç¼€æ­£ç¡®ï¼š`/api/v1/apps/kuaizhizao`
- âœ… æ‰€æœ‰è¯­æ³•é”™è¯¯å·²ä¿®å¤
- âœ… æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²ä¿®å¤
- âœ… æµ‹è¯•APIè·¯å¾„å·²æ›´æ–°
- âœ… æˆåŠŸæ³¨å†Œ 2 ä¸ªåº”ç”¨è·¯ç”±: å¿«æ ¼è½»åˆ¶é€ (kuaizhizao), åŸºç¡€æ•°æ®ç®¡ç†(master-data)
- âœ… å½“å‰åº”ç”¨è·¯ç”±æ•°é‡ï¼ˆä»¥ /api/v1/apps/kuaizhizao å¼€å¤´ï¼‰: 143

---

## ğŸ”§ ä¿®å¤è¯¦æƒ…

### 1. æ¨¡å—å¯¼å…¥ä¿®å¤

```python
# ä¿®å¤å‰
from core.models.user import User as CurrentUser  # é”™è¯¯è·¯å¾„
from infra.exceptions.exceptions import handle_exceptions  # ä¸å­˜åœ¨

# ä¿®å¤å
from infra.models.user import User as CurrentUser  # æ­£ç¡®è·¯å¾„
from infra.exceptions.exceptions import ValidationError, NotFoundError  # åªå¯¼å…¥éœ€è¦çš„å¼‚å¸¸ç±»
```

### 2. è£…é¥°å™¨ç§»é™¤

```python
# ä¿®å¤å‰
@handle_exceptions
async def create_purchase_order(...):

# ä¿®å¤å
async def create_purchase_order(...):
# å¼‚å¸¸å¤„ç†ç”±ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†
```

### 3. è·¯ç”±æ³¨å†Œä¿®å¤

```python
# åœ¨ application_registry_service.py ä¸­
# ç¡®ä¿sys.pathå·²æ­£ç¡®è®¾ç½®
import sys
from pathlib import Path
src_path = Path(__file__).parent.parent.parent.parent / "src"
if str(src_path) not in sys.path:
    sys.path.insert(0, str(src_path))
```

### 4. æµ‹è¯•è·¯å¾„ä¿®å¤

```python
# ä¿®å¤å‰
response = await test_client.post(
    "/api/apps/kuaizhizao/sales-forecasts",
    ...
)

# ä¿®å¤å
response = await test_client.post(
    "/api/v1/apps/kuaizhizao/sales-forecasts",
    ...
)
```

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

1. âœ… `src/apps/kuaizhizao/api/production.py` - ä¿®å¤datetimeå¯¼å…¥
2. âœ… `src/apps/kuaizhizao/api/purchase.py` - ä¿®å¤å¯¼å…¥è·¯å¾„ã€å‚æ•°é¡ºåºã€ç§»é™¤è£…é¥°å™¨
3. âœ… `src/core/services/application/application_route_manager.py` - ä¿®å¤è·¯ç”±å‰ç¼€
4. âœ… `src/core/services/application/application_registry_service.py` - ä¿®å¤è·¯ç”±å‰ç¼€ã€æ·»åŠ sys.pathè®¾ç½®
5. âœ… `tests/e2e/conftest.py` - æ·»åŠ æµ‹è¯•ç¯å¢ƒè·¯ç”±æ³¨å†Œ
6. âœ… `tests/e2e/test_mts_workflow.py` - ä¿®å¤APIè·¯å¾„
7. âœ… `tests/e2e/test_mto_workflow.py` - ä¿®å¤APIè·¯å¾„
8. âœ… `tests/e2e/test_purchase_workflow.py` - ä¿®å¤APIè·¯å¾„
9. âœ… `tests/e2e/test_quality_workflow.py` - ä¿®å¤APIè·¯å¾„
10. âœ… `tests/e2e/test_finance_workflow.py` - ä¿®å¤APIè·¯å¾„

---

## ğŸš€ æµ‹è¯•ç»“æœ

### è·¯ç”±æ³¨å†ŒçŠ¶æ€
- âœ… kuaizhizaoåº”ç”¨è·¯ç”±æˆåŠŸæ³¨å†Œ
- âœ… è·¯ç”±å‰ç¼€ï¼š`/api/v1/apps/kuaizhizao`
- âœ… è·¯ç”±æ•°é‡ï¼š143ä¸ªè·¯ç”±
- âœ… master-dataåº”ç”¨è·¯ç”±ä¹ŸæˆåŠŸæ³¨å†Œ

### æµ‹è¯•çŠ¶æ€
- âš ï¸ æµ‹è¯•ä»åœ¨è¿è¡Œä¸­ï¼Œéœ€è¦è¿›ä¸€æ­¥éªŒè¯APIç«¯ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **APIè·¯å¾„è§„èŒƒ**
   - æ‰€æœ‰åº”ç”¨APIè·¯å¾„æ ¼å¼ï¼š`/api/v1/apps/{app_code}/...`
   - æµ‹è¯•ä¸­å¿…é¡»ä½¿ç”¨å®Œæ•´è·¯å¾„

2. **å¼‚å¸¸å¤„ç†**
   - ä¸å†ä½¿ç”¨`@handle_exceptions`è£…é¥°å™¨
   - å¼‚å¸¸ç”±ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†

3. **æ¨¡å—å¯¼å…¥**
   - Useræ¨¡å‹åœ¨`infra.models.user`ä¸­ï¼Œä¸åœ¨`core.models.user`ä¸­
   - ç¡®ä¿å¯¼å…¥è·¯å¾„æ­£ç¡®

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-01-03  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**è·¯ç”±æ³¨å†ŒçŠ¶æ€**ï¼šâœ… æˆåŠŸ

