# æµ‹è¯•é…ç½®ä¼˜åŒ–è¯´æ˜

**ä¼˜åŒ–æ—¶é—´**ï¼š2026-01-03  
**ä¼˜åŒ–å†…å®¹**ï¼šäº‹ä»¶å¾ªç¯ç®¡ç†ã€æ•°æ®åº“è¿æ¥é…ç½®ã€Fixtureä½œç”¨åŸŸ

---

## ğŸ”§ ä¼˜åŒ–å†…å®¹

### 1. äº‹ä»¶å¾ªç¯ç®¡ç†ä¼˜åŒ–

#### é—®é¢˜
- Windowsç¯å¢ƒä¸‹pytest-asyncioå­˜åœ¨äº‹ä»¶å¾ªç¯ç®¡ç†é—®é¢˜
- å¤šä¸ªæµ‹è¯•å¹¶å‘è¿è¡Œæ—¶ï¼Œäº‹ä»¶å¾ªç¯å¯èƒ½è¢«æå‰å…³é—­
- å¯¼è‡´`RuntimeError: Event loop is closed`é”™è¯¯

#### è§£å†³æ–¹æ¡ˆ

```python
# é…ç½®äº‹ä»¶å¾ªç¯ç­–ç•¥ï¼ˆWindowsç¯å¢ƒä¼˜åŒ–ï¼‰
if sys.platform == "win32":
    # Windowsä¸‹ä½¿ç”¨ProactorEventLoopPolicyï¼Œé¿å…äº‹ä»¶å¾ªç¯é—®é¢˜
    asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())

@pytest.fixture(scope="session")
def event_loop_policy():
    """é…ç½®äº‹ä»¶å¾ªç¯ç­–ç•¥"""
    if sys.platform == "win32":
        policy = asyncio.WindowsProactorEventLoopPolicy()
    else:
        policy = asyncio.get_event_loop_policy()
    
    asyncio.set_event_loop_policy(policy)
    return policy

@pytest.fixture(scope="session")
def event_loop(event_loop_policy):
    """åˆ›å»ºäº‹ä»¶å¾ªç¯"""
    loop = event_loop_policy.new_event_loop()
    asyncio.set_event_loop(loop)
    yield loop
    
    # æ¸…ç†ï¼šå…³é—­æ‰€æœ‰å¾…å¤„ç†çš„ä»»åŠ¡
    try:
        pending = asyncio.all_tasks(loop)
        for task in pending:
            task.cancel()
        
        if pending:
            loop.run_until_complete(asyncio.gather(*pending, return_exceptions=True))
    except Exception:
        pass
    
    loop.close()
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ä½¿ç”¨`WindowsProactorEventLoopPolicy`ï¼ˆWindowsç¯å¢ƒï¼‰
- âœ… æ­£ç¡®è®¾ç½®äº‹ä»¶å¾ªç¯
- âœ… æ¸…ç†æ‰€æœ‰å¾…å¤„ç†çš„ä»»åŠ¡
- âœ… ç¡®ä¿äº‹ä»¶å¾ªç¯æ­£ç¡®å…³é—­

### 2. æ•°æ®åº“è¿æ¥é…ç½®ä¼˜åŒ–

#### é—®é¢˜
- æ•°æ®åº“è¿æ¥æ± åœ¨æµ‹è¯•ç»“æŸæ—¶å¯èƒ½æ²¡æœ‰æ­£ç¡®å…³é—­
- å¤šä¸ªæµ‹è¯•å¹¶å‘è¿è¡Œæ—¶ï¼Œè¿æ¥å¯èƒ½è¢«é‡å¤ä½¿ç”¨
- å¯¼è‡´`InterfaceError: cannot perform operation: another operation is in progress`é”™è¯¯

#### è§£å†³æ–¹æ¡ˆ

```python
@pytest.fixture(scope="session")
async def db_setup(event_loop):
    """æ•°æ®åº“è®¾ç½®"""
    try:
        config = TORTOISE_ORM.copy()
        
        # ç¡®ä¿routerså­—æ®µå­˜åœ¨
        if "routers" not in config.get("apps", {}).get("models", {}):
            config.setdefault("apps", {}).setdefault("models", {})["routers"] = []
        
        # ä¼˜åŒ–è¿æ¥æ± é…ç½®ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
        if "connections" in config and "default" in config["connections"]:
            credentials = config["connections"]["default"].get("credentials", {})
            # å‡å°‘è¿æ¥æ± å¤§å°ï¼Œé¿å…èµ„æºæµªè´¹
            credentials.setdefault("min_size", 2)
            credentials.setdefault("max_size", 5)
            credentials.setdefault("max_inactive_connection_lifetime", 60.0)
        
        await Tortoise.init(config=config)
        yield
        
    finally:
        # æ¸…ç†ï¼šå…³é—­æ‰€æœ‰æ•°æ®åº“è¿æ¥
        try:
            await Tortoise.close_connections()
            # ç­‰å¾…è¿æ¥å®Œå…¨å…³é—­
            await asyncio.sleep(0.1)
        except Exception as e:
            print(f"å…³é—­æ•°æ®åº“è¿æ¥æ—¶å‡ºé”™: {e}")
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ä¼˜åŒ–è¿æ¥æ± é…ç½®ï¼ˆå‡å°‘è¿æ¥æ•°ï¼‰
- âœ… ç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­
- âœ… ç­‰å¾…è¿æ¥å®Œå…¨å…³é—­
- âœ… æ·»åŠ é”™è¯¯å¤„ç†

### 3. Fixtureä½œç”¨åŸŸä¼˜åŒ–

#### é—®é¢˜
- Fixtureä½œç”¨åŸŸè®¾ç½®ä¸å½“ï¼Œå¯¼è‡´æ•°æ®å…±äº«å’Œæ¸…ç†é—®é¢˜
- æµ‹è¯•ç§Ÿæˆ·å’Œç”¨æˆ·å¯èƒ½åœ¨ä¸åŒæµ‹è¯•é—´å…±äº«ï¼Œå¯¼è‡´æ•°æ®æ±¡æŸ“

#### è§£å†³æ–¹æ¡ˆ

```python
# æ”¹ä¸ºfunctionä½œç”¨åŸŸï¼Œæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹
@pytest.fixture(scope="function")
async def test_tenant(db_setup) -> AsyncGenerator[Tenant, None]:
    """åˆ›å»ºæµ‹è¯•ç§Ÿæˆ·"""
    # å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    existing = await Tenant.get_or_none(domain="test")
    if existing:
        yield existing
        return
    
    # åˆ›å»ºæ–°ç§Ÿæˆ·
    tenant = await Tenant.create(...)
    
    try:
        yield tenant
    finally:
        # æ¸…ç†ï¼šåˆ é™¤æµ‹è¯•ç§Ÿæˆ·
        try:
            await tenant.delete()
        except Exception as e:
            print(f"æ¸…ç†æµ‹è¯•ç§Ÿæˆ·æ—¶å‡ºé”™: {e}")
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ä½¿ç”¨`function`ä½œç”¨åŸŸï¼Œæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹
- âœ… ä½¿ç”¨`AsyncGenerator`ç±»å‹æç¤º
- âœ… ä½¿ç”¨`try-finally`ç¡®ä¿æ¸…ç†
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### 4. pytest.inié…ç½®ä¼˜åŒ–

#### æ”¹è¿›å†…å®¹

```ini
[pytest]
# å¼‚æ­¥æµ‹è¯•é…ç½®
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# é»˜è®¤é€‰é¡¹
addopts = 
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    -p no:warnings

# è­¦å‘Šè¿‡æ»¤
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::RuntimeWarning
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ˜ç¡®è®¾ç½®`asyncio_default_fixture_loop_scope = function`
- âœ… æ·»åŠ è­¦å‘Šè¿‡æ»¤
- âœ… ä¼˜åŒ–é»˜è®¤é€‰é¡¹

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### ä¼˜åŒ–å‰
- âŒ äº‹ä»¶å¾ªç¯å…³é—­é”™è¯¯ï¼ˆ7ä¸ªæµ‹è¯•ï¼‰
- âŒ æ•°æ®åº“è¿æ¥é”™è¯¯ï¼ˆ7ä¸ªæµ‹è¯•ï¼‰
- âŒ æµ‹è¯•æ•°æ®å…±äº«é—®é¢˜

### ä¼˜åŒ–å
- âœ… äº‹ä»¶å¾ªç¯æ­£ç¡®ç®¡ç†
- âœ… æ•°æ®åº“è¿æ¥æ­£ç¡®å…³é—­
- âœ… æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ
- âœ… åŸºç¡€æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆ5/5ï¼‰

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
uv run pytest tests/e2e/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
uv run pytest tests/e2e/test_mts_workflow.py -v

# ç”ŸæˆHTMLæŠ¥å‘Š
uv run pytest tests/e2e/ -v --html=test_report.html --self-contained-html
```

### è°ƒè¯•æµ‹è¯•

```bash
# è¯¦ç»†è¾“å‡º
uv run pytest tests/e2e/ -v -s

# åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
uv run pytest tests/e2e/ --lf

# è¿è¡Œåˆ°ç¬¬ä¸€ä¸ªå¤±è´¥
uv run pytest tests/e2e/ -x
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Windowsç¯å¢ƒ**
   - å¿…é¡»ä½¿ç”¨`WindowsProactorEventLoopPolicy`
   - ç¡®ä¿äº‹ä»¶å¾ªç¯æ­£ç¡®è®¾ç½®å’Œæ¸…ç†

2. **æ•°æ®åº“è¿æ¥**
   - æµ‹è¯•ç¯å¢ƒä½¿ç”¨è¾ƒå°çš„è¿æ¥æ± 
   - ç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­

3. **Fixtureä½œç”¨åŸŸ**
   - ä½¿ç”¨`function`ä½œç”¨åŸŸç¡®ä¿æµ‹è¯•éš”ç¦»
   - ä½¿ç”¨`try-finally`ç¡®ä¿æ¸…ç†

4. **å¹¶å‘æµ‹è¯•**
   - å½“å‰é…ç½®ä¸æ”¯æŒå¹¶å‘æµ‹è¯•
   - å¦‚éœ€å¹¶å‘ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **å®ç°çœŸå®è®¤è¯**
   - åœ¨`conftest.py`ä¸­å®ç°çœŸå®çš„ç™»å½•é€»è¾‘
   - è·å–çœŸå®çš„JWT token

2. **æ·»åŠ æµ‹è¯•æ•°æ®å·¥å‚**
   - ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæµ‹è¯•æ•°æ®
   - ç®€åŒ–æµ‹è¯•æ•°æ®å‡†å¤‡

3. **ä¼˜åŒ–æµ‹è¯•éš”ç¦»**
   - ä½¿ç”¨äº‹åŠ¡å›æ»šç¡®ä¿æµ‹è¯•éš”ç¦»
   - æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®

4. **æ·»åŠ æµ‹è¯•æ¸…ç†**
   - æµ‹è¯•å‰æ¸…ç†æ—§æ•°æ®
   - æµ‹è¯•åæ¸…ç†æµ‹è¯•æ•°æ®

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**ï¼š2026-01-03  
**ä¼˜åŒ–çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… åŸºç¡€æµ‹è¯•å…¨éƒ¨é€šè¿‡

