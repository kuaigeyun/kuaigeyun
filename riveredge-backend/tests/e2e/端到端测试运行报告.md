# ç«¯åˆ°ç«¯æµ‹è¯•è¿è¡ŒæŠ¥å‘Š

**è¿è¡Œæ—¶é—´**ï¼š2026-01-03  
**æµ‹è¯•æ¡†æ¶**ï¼špytest + httpx  
**æµ‹è¯•çŠ¶æ€**ï¼šâš ï¸ éƒ¨åˆ†é€šè¿‡ï¼Œå­˜åœ¨äº‹ä»¶å¾ªç¯å’Œæ•°æ®åº“è¿æ¥é—®é¢˜

---

## ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“

### æµ‹è¯•ç»Ÿè®¡

- **æ€»æµ‹è¯•æ•°**ï¼š13ä¸ª
- **é€šè¿‡**ï¼š4ä¸ª âœ…
- **å¤±è´¥**ï¼š2ä¸ª âŒ
- **é”™è¯¯**ï¼š7ä¸ª âš ï¸ï¼ˆç”±äºäº‹ä»¶å¾ªç¯å’Œæ•°æ®åº“è¿æ¥é—®é¢˜ï¼‰

### âœ… é€šè¿‡çš„æµ‹è¯•ï¼ˆ4ä¸ªï¼‰

1. **test_app_initialization** - åº”ç”¨åˆå§‹åŒ–æµ‹è¯•
   - çŠ¶æ€ï¼šâœ… PASSED
   - è¯´æ˜ï¼šFastAPIåº”ç”¨æ­£å¸¸åˆå§‹åŒ–

2. **test_api_routes** - APIè·¯ç”±æµ‹è¯•
   - çŠ¶æ€ï¼šâœ… PASSED
   - è¯´æ˜ï¼šAPIè·¯ç”±ç³»ç»Ÿæ­£å¸¸

3. **test_models_import** - æ¨¡å‹å¯¼å…¥æµ‹è¯•
   - çŠ¶æ€ï¼šâœ… PASSED
   - è¯´æ˜ï¼šæ‰€æœ‰å…³é”®æ¨¡å‹å¯¼å…¥æˆåŠŸ

4. **test_services_import** - æœåŠ¡å¯¼å…¥æµ‹è¯•
   - çŠ¶æ€ï¼šâœ… PASSED
   - è¯´æ˜ï¼šæ‰€æœ‰å…³é”®æœåŠ¡å¯¼å…¥æˆåŠŸ

### âŒ å¤±è´¥çš„æµ‹è¯•ï¼ˆ2ä¸ªï¼‰

1. **test_payable_workflow** - åº”ä»˜å•æµç¨‹æµ‹è¯•
   - çŠ¶æ€ï¼šâŒ FAILED
   - è¯´æ˜ï¼šä¸šåŠ¡æµç¨‹æµ‹è¯•å¤±è´¥ï¼ˆéœ€è¦æŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼‰

2. **test_database_connection** - æ•°æ®åº“è¿æ¥æµ‹è¯•
   - çŠ¶æ€ï¼šâŒ FAILED
   - è¯´æ˜ï¼šæ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½æ˜¯äº‹ä»¶å¾ªç¯é—®é¢˜ï¼‰

### âš ï¸ é”™è¯¯çš„æµ‹è¯•ï¼ˆ7ä¸ªï¼‰

ç”±äºäº‹ä»¶å¾ªç¯å’Œæ•°æ®åº“è¿æ¥é—®é¢˜ï¼Œä»¥ä¸‹æµ‹è¯•æ— æ³•æ­£å¸¸è¿è¡Œï¼š

1. **test_receivable_workflow** - åº”æ”¶å•æµç¨‹æµ‹è¯•
2. **test_mto_complete_workflow** - MTOæ¨¡å¼å®Œæ•´æµç¨‹æµ‹è¯•
3. **test_mts_complete_workflow** - MTSæ¨¡å¼å®Œæ•´æµç¨‹æµ‹è¯•
4. **test_purchase_complete_workflow** - é‡‡è´­æµç¨‹é—­ç¯æµ‹è¯•
5. **test_incoming_inspection_workflow** - æ¥æ–™æ£€éªŒæµç¨‹æµ‹è¯•
6. **test_process_inspection_workflow** - è¿‡ç¨‹æ£€éªŒæµç¨‹æµ‹è¯•
7. **test_finished_goods_inspection_workflow** - æˆå“æ£€éªŒæµç¨‹æµ‹è¯•

**é”™è¯¯åŸå› **ï¼š
- `RuntimeError: Event loop is closed` - äº‹ä»¶å¾ªç¯å…³é—­é—®é¢˜
- `asyncpg.exceptions._base.InterfaceError: cannot perform operation: another operation is in progress` - æ•°æ®åº“è¿æ¥é—®é¢˜

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. äº‹ä»¶å¾ªç¯é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- pytest-asyncioåœ¨Windowsç¯å¢ƒä¸‹å­˜åœ¨äº‹ä»¶å¾ªç¯ç®¡ç†é—®é¢˜
- å¤šä¸ªæµ‹è¯•å¹¶å‘è¿è¡Œæ—¶ï¼Œäº‹ä»¶å¾ªç¯å¯èƒ½è¢«æå‰å…³é—­

**å½±å“èŒƒå›´**ï¼š
- æ‰€æœ‰ä½¿ç”¨`test_tenant` fixtureçš„æµ‹è¯•
- æ‰€æœ‰éœ€è¦æ•°æ®åº“æ“ä½œçš„æµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¼˜åŒ–`conftest.py`ä¸­çš„äº‹ä»¶å¾ªç¯ç®¡ç†
2. ä½¿ç”¨`pytest-asyncio`çš„`event_loop_policy`é…ç½®
3. è°ƒæ•´fixtureçš„ä½œç”¨åŸŸå’Œä¾èµ–å…³ç³»

### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- æ•°æ®åº“è¿æ¥æ± åœ¨æµ‹è¯•ç»“æŸæ—¶å¯èƒ½æ²¡æœ‰æ­£ç¡®å…³é—­
- å¤šä¸ªæµ‹è¯•å¹¶å‘è¿è¡Œæ—¶ï¼Œè¿æ¥å¯èƒ½è¢«é‡å¤ä½¿ç”¨

**å½±å“èŒƒå›´**ï¼š
- æ‰€æœ‰éœ€è¦æ•°æ®åº“æ“ä½œçš„æµ‹è¯•

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± é…ç½®
2. ç¡®ä¿æ¯ä¸ªæµ‹è¯•åæ­£ç¡®å…³é—­è¿æ¥
3. ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“

### 3. ä¸šåŠ¡æµç¨‹æµ‹è¯•å¤±è´¥

**é—®é¢˜æè¿°**ï¼š
- `test_payable_workflow`æµ‹è¯•å¤±è´¥
- å¯èƒ½æ˜¯APIç«¯ç‚¹ä¸å­˜åœ¨æˆ–æ•°æ®ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥APIç«¯ç‚¹æ˜¯å¦æ­£ç¡®æ³¨å†Œ
2. æ£€æŸ¥æµ‹è¯•æ•°æ®æ˜¯å¦å®Œæ•´
3. å®ç°çœŸå®çš„è®¤è¯é€»è¾‘

---

## ğŸš€ æ”¹è¿›å»ºè®®

### 1. ä¼˜åŒ–æµ‹è¯•é…ç½®

```python
# conftest.py æ”¹è¿›
@pytest.fixture(scope="session")
def event_loop_policy():
    """é…ç½®äº‹ä»¶å¾ªç¯ç­–ç•¥"""
    policy = asyncio.get_event_loop_policy()
    if sys.platform == "win32":
        policy.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())
    return policy
```

### 2. ä¼˜åŒ–æ•°æ®åº“è¿æ¥

```python
# conftest.py æ”¹è¿›
@pytest.fixture(scope="session")
async def db_setup():
    """æ•°æ®åº“è®¾ç½®"""
    config = TORTOISE_ORM.copy()
    # ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“è¿æ¥æ± 
    config["connections"]["default"]["credentials"]["database"] = "riveredge_test"
    await Tortoise.init(config=config)
    yield
    await Tortoise.close_connections()
    # ç­‰å¾…è¿æ¥å®Œå…¨å…³é—­
    await asyncio.sleep(0.1)
```

### 3. å®ç°çœŸå®è®¤è¯

```python
# conftest.py æ”¹è¿›
@pytest.fixture
async def auth_headers(test_client: AsyncClient, test_user: User) -> dict:
    """è·å–è®¤è¯å¤´"""
    # å®ç°çœŸå®çš„ç™»å½•é€»è¾‘
    login_data = {
        "username": test_user.username,
        "password": "test_password"
    }
    response = await test_client.post("/api/auth/login", json=login_data)
    token = response.json()["access_token"]
    return {
        "Authorization": f"Bearer {token}",
        "X-Tenant-ID": str(test_user.tenant_id)
    }
```

---

## ğŸ“ æµ‹è¯•è¦†ç›–æƒ…å†µ

### å·²æµ‹è¯•çš„åŠŸèƒ½

1. âœ… åº”ç”¨åˆå§‹åŒ–
2. âœ… APIè·¯ç”±
3. âœ… æ¨¡å‹å¯¼å…¥
4. âœ… æœåŠ¡å¯¼å…¥

### å¾…æµ‹è¯•çš„åŠŸèƒ½ï¼ˆç”±äºäº‹ä»¶å¾ªç¯é—®é¢˜ï¼‰

1. âš ï¸ MTSæ¨¡å¼å®Œæ•´æµç¨‹
2. âš ï¸ MTOæ¨¡å¼å®Œæ•´æµç¨‹
3. âš ï¸ é‡‡è´­æµç¨‹é—­ç¯
4. âš ï¸ è´¨é‡ç®¡ç†æµç¨‹
5. âš ï¸ è´¢åŠ¡ååŒæµç¨‹

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ä¿®å¤äº‹ä»¶å¾ªç¯é—®é¢˜**
   - ä¼˜åŒ–`conftest.py`ä¸­çš„äº‹ä»¶å¾ªç¯ç®¡ç†
   - è°ƒæ•´fixtureçš„ä½œç”¨åŸŸ

2. **ä¿®å¤æ•°æ®åº“è¿æ¥é—®é¢˜**
   - ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± é…ç½®
   - ç¡®ä¿è¿æ¥æ­£ç¡®å…³é—­

3. **å®ç°çœŸå®è®¤è¯**
   - åœ¨`conftest.py`ä¸­å®ç°çœŸå®çš„ç™»å½•é€»è¾‘
   - è·å–çœŸå®çš„JWT token

4. **å®Œå–„æµ‹è¯•æ•°æ®**
   - ç¡®ä¿æ‰€æœ‰æµ‹è¯•æ‰€éœ€çš„åŸºç¡€æ•°æ®éƒ½å­˜åœ¨
   - åˆ›å»ºæµ‹è¯•æ•°æ®å·¥å‚

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆè¯¦ç»†çš„HTMLæŠ¥å‘Šï¼š

```bash
cd riveredge-backend
uv run pytest tests/e2e/ -v --html=test_report.html --self-contained-html
```

---

**ç»“è®º**ï¼šåŸºç¡€åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œä½†ä¸šåŠ¡æµç¨‹æµ‹è¯•ç”±äºäº‹ä»¶å¾ªç¯å’Œæ•°æ®åº“è¿æ¥é—®é¢˜æ— æ³•æ­£å¸¸è¿è¡Œã€‚éœ€è¦ä¼˜åŒ–æµ‹è¯•é…ç½®å’Œfixtureç®¡ç†ã€‚

