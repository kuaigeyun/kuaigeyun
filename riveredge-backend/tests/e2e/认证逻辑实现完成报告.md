# è®¤è¯é€»è¾‘å®ç°å®ŒæˆæŠ¥å‘Š

**å®ç°æ—¶é—´**ï¼š2026-01-03  
**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

## âœ… å®ç°å†…å®¹

### 1. çœŸå®JWT Tokenç”Ÿæˆ âœ…

**é—®é¢˜**ï¼š
- æµ‹è¯•ä¸­ä½¿ç”¨æ¨¡æ‹Ÿtoken `test_token_{user_id}`ï¼Œæ— æ³•é€šè¿‡JWTéªŒè¯
- è¿”å›401 Unauthorizedé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨`conftest.py`çš„`auth_headers` fixtureä¸­ä½¿ç”¨`create_token_for_user`å‡½æ•°ç”ŸæˆçœŸå®çš„JWT token
- ç¡®ä¿tokenåŒ…å«æ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆuser_id, username, tenant_idç­‰ï¼‰

**å®ç°ä»£ç **ï¼š
```python
@pytest.fixture(scope="function")
async def auth_headers(test_client: AsyncClient, test_user: User, test_tenant) -> dict:
    """
    è·å–è®¤è¯å¤´
    
    ä½¿ç”¨çœŸå®çš„JWT tokenï¼Œé€šè¿‡è°ƒç”¨ç™»å½•APIæˆ–ç›´æ¥ç”Ÿæˆtokenã€‚
    """
    from infra.domain.security.security import create_token_for_user
    
    # ç”ŸæˆçœŸå®çš„JWT token
    token = create_token_for_user(
        user_id=test_user.id,
        username=test_user.username,
        tenant_id=test_user.tenant_id,
        is_infra_admin=test_user.is_infra_admin if hasattr(test_user, 'is_infra_admin') else False,
        is_tenant_admin=test_user.is_tenant_admin if hasattr(test_user, 'is_tenant_admin') else False,
    )
    
    return {
        "Authorization": f"Bearer {token}",
        "X-Tenant-ID": str(test_user.tenant_id)
    }
```

### 2. æµ‹è¯•ç”¨æˆ·å¯†ç å“ˆå¸Œ âœ…

**é—®é¢˜**ï¼š
- æµ‹è¯•ç”¨æˆ·ä½¿ç”¨`password_hash="hashed_password"`ï¼Œä¸æ˜¯çœŸå®çš„å¯†ç å“ˆå¸Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨`User.hash_password()`æ–¹æ³•ç”ŸæˆçœŸå®çš„å¯†ç å“ˆå¸Œ
- ç¡®ä¿æµ‹è¯•ç”¨æˆ·å¯ä»¥ä½¿ç”¨çœŸå®å¯†ç è¿›è¡Œç™»å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰

**å®ç°ä»£ç **ï¼š
```python
@pytest.fixture(scope="function")
async def test_user(db_setup, test_tenant) -> AsyncGenerator[User, None]:
    """
    åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    
    ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹çš„æµ‹è¯•ç”¨æˆ·ï¼Œæµ‹è¯•ç»“æŸåæ¸…ç†ã€‚
    ä½¿ç”¨çœŸå®çš„å¯†ç å“ˆå¸Œï¼Œæ”¯æŒçœŸå®ç™»å½•ã€‚
    """
    # å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    existing = await User.get_or_none(username="test_user", tenant_id=test_tenant.id)
    if existing:
        # ç¡®ä¿å¯†ç å·²æ­£ç¡®è®¾ç½®
        test_password = "test_password_123"
        if not existing.verify_password(test_password):
            existing.password_hash = User.hash_password(test_password)
            await existing.save()
        yield existing
        return
    
    # åˆ›å»ºæ–°ç”¨æˆ·ï¼Œä½¿ç”¨çœŸå®çš„å¯†ç å“ˆå¸Œ
    test_password = "test_password_123"
    user = await User.create(
        tenant_id=test_tenant.id,
        username="test_user",
        email="test@example.com",
        password_hash=User.hash_password(test_password),
        full_name="æµ‹è¯•ç”¨æˆ·",
        is_active=True
    )
    
    try:
        yield user
    finally:
        # æ¸…ç†ï¼šåˆ é™¤æµ‹è¯•ç”¨æˆ·
        try:
            await user.delete()
        except Exception as e:
            print(f"æ¸…ç†æµ‹è¯•ç”¨æˆ·æ—¶å‡ºé”™: {e}")
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### è®¤è¯çŠ¶æ€å˜åŒ–

**ä¿®å¤å‰**ï¼š
- âŒ è¿”å›401 Unauthorized
- âŒ TokenéªŒè¯å¤±è´¥ï¼š`Not enough segments`
- âŒ é”™è¯¯ä¿¡æ¯ï¼š`âŒ å¹³å°è¶…çº§ç®¡ç†å‘˜ Token éªŒè¯å¤±è´¥ (JWTError): Not enough segments`

**ä¿®å¤å**ï¼š
- âœ… è¿”å›422 Unprocessable Entityï¼ˆæ•°æ®éªŒè¯é”™è¯¯ï¼Œä¸æ˜¯è®¤è¯é”™è¯¯ï¼‰
- âœ… TokenéªŒè¯æˆåŠŸ
- âœ… JWT tokenæ­£ç¡®ç”Ÿæˆå’Œè§£æ
- âœ… è®¤è¯é€»è¾‘æ­£å¸¸å·¥ä½œ

### æµ‹è¯•æ—¥å¿—

```
âœ… Token è§£ç æˆåŠŸï¼Œpayload keys: ['sub', 'username', 'tenant_id', 'is_infra_admin', 'is_tenant_admin', 'exp', 'iat']
âœ… è®¤è¯é€šè¿‡ï¼Œè¿”å›422ï¼ˆæ•°æ®éªŒè¯é”™è¯¯ï¼Œä¸æ˜¯è®¤è¯é”™è¯¯ï¼‰
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### JWT Tokenç”Ÿæˆ

ä½¿ç”¨`create_token_for_user`å‡½æ•°ç”ŸæˆJWT tokenï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
- `sub`: ç”¨æˆ·IDï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
- `username`: ç”¨æˆ·å
- `tenant_id`: ç»„ç»‡IDï¼ˆç”¨äºå¤šç»„ç»‡éš”ç¦»ï¼‰
- `is_infra_admin`: æ˜¯å¦ä¸ºå¹³å°ç®¡ç†å‘˜
- `is_tenant_admin`: æ˜¯å¦ä¸ºç»„ç»‡ç®¡ç†å‘˜
- `exp`: è¿‡æœŸæ—¶é—´
- `iat`: ç­¾å‘æ—¶é—´

### TokenéªŒè¯æµç¨‹

1. **æå–Token**ï¼šä»è¯·æ±‚å¤´`Authorization: Bearer <token>`ä¸­æå–
2. **éªŒè¯Token**ï¼šä½¿ç”¨`get_token_payload`å‡½æ•°éªŒè¯JWT token
3. **è·å–ç”¨æˆ·**ï¼šä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
4. **è®¾ç½®ç»„ç»‡ä¸Šä¸‹æ–‡**ï¼šè‡ªåŠ¨è®¾ç½®`tenant_id`åˆ°ä¸Šä¸‹æ–‡

---

## âš ï¸ å½“å‰é—®é¢˜

### æ•°æ®éªŒè¯é”™è¯¯ï¼ˆ422ï¼‰

**çŠ¶æ€**ï¼šè®¤è¯å·²é€šè¿‡ï¼Œä½†æµ‹è¯•è¿”å›422 Unprocessable Entity

**åŸå› **ï¼š
- æµ‹è¯•æ•°æ®æ ¼å¼å¯èƒ½ä¸ç¬¦åˆAPIçš„schemaè¦æ±‚
- éœ€è¦æ£€æŸ¥`SalesForecastCreate` schemaçš„å¿…å¡«å­—æ®µ

**ä¸‹ä¸€æ­¥**ï¼š
- æ£€æŸ¥æµ‹è¯•æ•°æ®æ ¼å¼
- ç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½å·²æä¾›
- éªŒè¯å­—æ®µç±»å‹å’Œæ ¼å¼æ˜¯å¦æ­£ç¡®

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

1. âœ… `tests/e2e/conftest.py`
   - ä¿®æ”¹`test_user` fixtureï¼šä½¿ç”¨çœŸå®çš„å¯†ç å“ˆå¸Œ
   - ä¿®æ”¹`auth_headers` fixtureï¼šç”ŸæˆçœŸå®çš„JWT token

---

## ğŸ¯ æ€»ç»“

### è®¤è¯é€»è¾‘ âœ… å·²å®Œå…¨å®ç°

- âœ… JWT tokenç”Ÿæˆæ­£å¸¸
- âœ… TokenéªŒè¯æ­£å¸¸
- âœ… ç”¨æˆ·è®¤è¯é€šè¿‡
- âœ… ç»„ç»‡ä¸Šä¸‹æ–‡è®¾ç½®æ­£å¸¸

### å½“å‰çŠ¶æ€

- âœ… **è®¤è¯é—®é¢˜**ï¼šå·²è§£å†³
- âš ï¸ **æ•°æ®éªŒè¯é—®é¢˜**ï¼šéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥æµ‹è¯•æ•°æ®æ ¼å¼

### æµ‹è¯•è¿›å±•

- **ä¿®å¤å‰**ï¼š8ä¸ªæµ‹è¯•å…¨éƒ¨å¤±è´¥ï¼ˆ401è®¤è¯é”™è¯¯ï¼‰
- **ä¿®å¤å**ï¼šè®¤è¯é€šè¿‡ï¼Œä½†éœ€è¦ä¿®å¤æ•°æ®éªŒè¯é—®é¢˜

---

**å®ç°å®Œæˆæ—¶é—´**ï¼š2026-01-03  
**è®¤è¯çŠ¶æ€**ï¼šâœ… å®Œå…¨æ­£å¸¸  
**ä¸‹ä¸€æ­¥**ï¼šä¿®å¤æ•°æ®éªŒè¯é—®é¢˜

