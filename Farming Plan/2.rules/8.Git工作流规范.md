# RiverEdge SaaS 多租户框架 - Git 工作流规范

## 📋 概述

本文档定义 **RiverEdge SaaS 多租户框架 (RiverEdge SaaS Multi-tenant Framework)** 的**统一 Git 工作流规范**，确保代码协作顺畅、版本管理清晰，提升开发效率和代码质量。

**创建日期**：2025-11-17

## 🎯 设计原则

1. **分支策略清晰**：主分支、开发分支、功能分支职责明确
2. **提交信息规范**：使用 Conventional Commits 格式
3. **Code Review 必须**：所有代码合并前必须经过审查
4. **版本管理规范**：使用语义化版本号
5. **冲突及时解决**：及时解决合并冲突，保持代码整洁
6. **绝对禁止 PowerShell**：全程严禁使用 PowerShell 进行任何 Git 操作 ⭐ **重要**

## 🌿 分支策略

### 分支类型

```
main (生产分支)
  ↑
develop (开发分支)
  ↑
feature/xxx (功能分支)
fix/xxx (修复分支)
hotfix/xxx (热修复分支)
release/xxx (发布分支)
```

### 分支说明

#### `main` - 生产分支

**职责**：
- 生产环境代码
- 只接受来自 `release/` 或 `hotfix/` 的合并
- 必须保持稳定，随时可以部署

**保护规则**：
- 禁止直接推送
- 必须通过 Pull Request 合并
- 必须经过 Code Review
- 必须通过 CI/CD 检查

#### `develop` - 开发分支

**职责**：
- 开发环境代码
- 集成所有功能分支
- 持续集成和测试

**保护规则**：
- 禁止直接推送（除非紧急修复）
- 建议通过 Pull Request 合并
- 必须通过 CI/CD 检查

#### `feature/xxx` - 功能分支

**职责**：
- 开发新功能
- 从 `develop` 创建
- 完成后合并回 `develop`

**命名规范**：
- `feature/user-management` - 用户管理功能
- `feature/plugin-system` - 插件系统
- `feature/multi-tenant` - 多租户功能

**生命周期**：
1. 从 `develop` 创建分支
2. 开发功能
3. 提交 Pull Request 到 `develop`
4. Code Review 通过后合并
5. 删除分支

#### `fix/xxx` - 修复分支

**职责**：
- 修复 Bug
- 从 `develop` 创建
- 完成后合并回 `develop`

**命名规范**：
- `fix/login-error` - 修复登录错误
- `fix/permission-bug` - 修复权限 Bug
- `fix/api-validation` - 修复 API 验证问题

**生命周期**：
1. 从 `develop` 创建分支
2. 修复 Bug
3. 提交 Pull Request 到 `develop`
4. Code Review 通过后合并
5. 删除分支

#### `hotfix/xxx` - 热修复分支

**职责**：
- 紧急修复生产环境 Bug
- 从 `main` 创建
- 完成后同时合并到 `main` 和 `develop`

**命名规范**：
- `hotfix/security-patch` - 安全补丁
- `hotfix/critical-bug` - 严重 Bug 修复

**生命周期**：
1. 从 `main` 创建分支
2. 修复 Bug
3. 提交 Pull Request 到 `main`
4. Code Review 通过后合并到 `main`
5. 合并到 `develop`
6. 删除分支

#### `release/xxx` - 发布分支

**职责**：
- 准备发布版本
- 从 `develop` 创建
- 完成后合并到 `main` 和 `develop`

**命名规范**：
- `release/v1.0.0` - 版本 1.0.0
- `release/v1.1.0` - 版本 1.1.0

**生命周期**：
1. 从 `develop` 创建分支
2. 版本号更新、文档完善
3. 测试和修复
4. 提交 Pull Request 到 `main`
5. Code Review 通过后合并到 `main`
6. 打 Tag（如 `v1.0.0`）
7. 合并到 `develop`
8. 删除分支

## 📝 提交规范

### Conventional Commits

**格式**：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**示例**：
```
feat(user): 添加用户管理功能

- 实现用户列表查询
- 实现用户创建和更新
- 添加用户删除功能

Closes #123
```

### 提交类型

| 类型 | 说明 | 示例 |
|------|------|------|
| `feat` | 新功能 | `feat(user): 添加用户管理功能` |
| `fix` | Bug 修复 | `fix(auth): 修复登录 Token 过期问题` |
| `docs` | 文档更新 | `docs(api): 更新 API 文档` |
| `style` | 代码格式（不影响功能） | `style: 格式化代码` |
| `refactor` | 代码重构 | `refactor(service): 重构用户服务` |
| `test` | 测试相关 | `test(user): 添加用户服务测试` |
| `chore` | 构建/工具相关 | `chore: 更新依赖版本` |
| `perf` | 性能优化 | `perf(query): 优化查询性能` |

### 提交范围（可选）

**说明**：`scope` 表示影响的范围，可选

**示例**：
- `feat(user)`: 用户相关功能
- `fix(auth)`: 认证相关修复
- `refactor(api)`: API 相关重构
- `docs(readme)`: README 文档更新

### 提交主题

**规则**：
- 使用中文或英文
- 首字母小写
- 结尾不加句号
- 简洁明了，不超过 50 个字符

**示例**：
- ✅ `feat(user): 添加用户管理功能`
- ✅ `fix(auth): 修复登录错误`
- ❌ `feat(user): 添加用户管理功能。` - 错误：结尾有句号
- ❌ `feat(user): Add user management feature` - 错误：过长

### 提交正文（可选）

**说明**：详细描述提交内容，可以多行

**示例**：
```
feat(user): 添加用户管理功能

- 实现用户列表查询（支持分页、排序、筛选）
- 实现用户创建和更新（包含数据验证）
- 添加用户删除功能（软删除）
- 添加用户状态管理（启用/禁用）

Closes #123
```

### 提交脚注（可选）

**说明**：关联 Issue 或 Breaking Changes

**示例**：
```
feat(api): 更新 API 响应格式

BREAKING CHANGE: API 响应格式从 {data} 改为 {code, message, data}
```

## 🔄 工作流程

### 开发新功能

**⚠️ 重要**：所有 Git 操作必须在 **Git Bash** 或 **VS Code Git 面板** 中完成，**绝对禁止使用 PowerShell**。

**推荐方式 1：使用 VS Code Git 面板**（最简单，推荐）⭐
1. 在 VS Code 中切换到 `develop` 分支（点击左下角分支名）
2. 创建功能分支（点击分支名 → "创建新分支"）
3. 开发功能
4. 在 VS Code Git 面板中暂存文件（点击 `+` 号）
5. 在提交框中输入提交信息（在编辑器中输入，完全避免编码问题）
6. 按 `Ctrl + Enter` 提交
7. 推送分支（点击 `...` → "Push"）
8. 在 GitHub/GitLab 上创建 Pull Request

**推荐方式 2：使用 Git Bash**（命令行方式）
```bash
# 在 Git Bash 中执行（不是 PowerShell！）

# 1. 切换到 develop 分支
git checkout develop
git pull origin develop

# 2. 创建功能分支
git checkout -b feature/user-management

# 3. 开发功能
# ... 编写代码 ...

# 4. 提交代码（使用 -F 参数从文件读取提交信息，避免编码问题）
echo "feat(user): 添加用户管理功能" > commit_msg.txt
git add .
git commit -F commit_msg.txt
rm commit_msg.txt

# 5. 推送分支
git push origin feature/user-management

# 6. 创建 Pull Request
# 在 GitHub/GitLab 上创建 PR，从 feature/user-management 到 develop

# 7. Code Review 通过后合并
# 合并后删除分支
```

### 修复 Bug

**⚠️ 重要**：所有 Git 操作必须在 **Git Bash** 或 **VS Code Git 面板** 中完成。

**推荐方式：使用 VS Code Git 面板**（最简单）
1. 在 VS Code 中切换到 `develop` 分支
2. 创建修复分支（如 `fix/login-error`）
3. 修复 Bug
4. 在 VS Code Git 面板中提交（提交信息在编辑器中输入）
5. 推送分支
6. 创建 Pull Request

**或使用 Git Bash**：
```bash
# 在 Git Bash 中执行（不是 PowerShell！）

# 1. 切换到 develop 分支
git checkout develop
git pull origin develop

# 2. 创建修复分支
git checkout -b fix/login-error

# 3. 修复 Bug
# ... 修复代码 ...

# 4. 提交代码（使用文件方式避免编码问题）
echo "fix(auth): 修复登录错误" > commit_msg.txt
git add .
git commit -F commit_msg.txt
rm commit_msg.txt

# 5. 推送分支
git push origin fix/login-error

# 6. 创建 Pull Request
# 在 GitHub/GitLab 上创建 PR，从 fix/login-error 到 develop

# 7. Code Review 通过后合并
# 合并后删除分支
```

### 紧急修复（热修复）

**⚠️ 重要**：所有 Git 操作必须在 **Git Bash** 或 **VS Code Git 面板** 中完成。

**推荐方式：使用 VS Code Git 面板**（最简单）
1. 在 VS Code 中切换到 `main` 分支
2. 创建热修复分支（如 `hotfix/security-patch`）
3. 修复 Bug
4. 在 VS Code Git 面板中提交并推送
5. 创建 Pull Request 到 `main`
6. Code Review 通过后合并到 `main`
7. 切换到 `develop` 分支并合并热修复
8. 删除分支

**或使用 Git Bash**：
```bash
# 在 Git Bash 中执行（不是 PowerShell！）

# 1. 切换到 main 分支
git checkout main
git pull origin main

# 2. 创建热修复分支
git checkout -b hotfix/security-patch

# 3. 修复 Bug
# ... 修复代码 ...

# 4. 提交代码（使用文件方式避免编码问题）
echo "fix(security): 修复安全漏洞" > commit_msg.txt
git add .
git commit -F commit_msg.txt
rm commit_msg.txt

# 5. 推送分支
git push origin hotfix/security-patch

# 6. 创建 Pull Request 到 main
# Code Review 通过后合并到 main

# 7. 合并到 develop
git checkout develop
git merge hotfix/security-patch
git push origin develop

# 8. 删除分支
git branch -d hotfix/security-patch
git push origin --delete hotfix/security-patch
```

## 👥 Code Review 流程

### Pull Request 创建

**时机**：
- 功能开发完成
- Bug 修复完成
- 准备发布版本

**要求**：
- 标题清晰（如：`feat(user): 添加用户管理功能`）
- 描述详细（说明改动内容、测试情况）
- 关联 Issue（如：`Closes #123`）
- 通过 CI/CD 检查

### Code Review 检查点

**必须检查**：
- [ ] 代码符合命名规范
- [ ] 代码符合注释规范
- [ ] 多租户隔离已实现（包含 `tenant_id`）
- [ ] 错误处理完善
- [ ] 测试覆盖充分
- [ ] 提交信息规范
- [ ] 无安全漏洞
- [ ] 性能影响评估

### Code Review 流程

1. **创建 Pull Request**
   - 填写标题和描述
   - 选择 Reviewer
   - 关联 Issue

2. **自动检查**
   - CI/CD 自动运行测试
   - 代码质量检查
   - 安全扫描

3. **人工审查**
   - Reviewer 审查代码
   - 提出修改建议
   - 讨论和沟通

4. **修改和完善**
   - 根据建议修改代码
   - 重新提交
   - 再次审查

5. **合并**
   - Reviewer 批准
   - 合并到目标分支
   - 删除源分支

## 🔀 冲突解决

### 预防冲突

**建议**：
- 及时同步 `develop` 分支
- 功能分支保持简短生命周期
- 避免多人同时修改同一文件

### 解决冲突

**步骤**：
```bash
# 1. 切换到功能分支
git checkout feature/user-management

# 2. 同步 develop 分支
git fetch origin develop

# 3. 合并 develop 到功能分支
git merge origin/develop

# 4. 解决冲突
# 编辑冲突文件，解决冲突标记

# 5. 提交解决结果
git add .
git commit -m "fix: 解决合并冲突"

# 6. 推送分支
git push origin feature/user-management
```

## 🏷️ 版本标签

### 语义化版本

**格式**：`v<major>.<minor>.<patch>`

**说明**：
- `major`: 主版本号（不兼容的 API 修改）
- `minor`: 次版本号（向下兼容的功能新增）
- `patch`: 修订号（向下兼容的问题修正）

**示例**：
- `v1.0.0` - 初始版本
- `v1.1.0` - 新增功能
- `v1.1.1` - Bug 修复

### 创建标签

```bash
# 创建标签
git tag -a v1.0.0 -m "Release version 1.0.0"

# 推送标签
git push origin v1.0.0
```

## ✅ 检查清单

提交代码前，请确保：

- [ ] **是否使用了 Git Bash 或 VS Code Git 面板？**（绝对禁止使用 PowerShell）
- [ ] 代码符合命名规范
- [ ] 代码符合注释规范
- [ ] 提交信息符合 Conventional Commits 格式
- [ ] 多租户隔离已实现
- [ ] 错误处理完善
- [ ] 测试通过
- [ ] 无安全漏洞
- [ ] 代码已格式化

## 📚 相关文档

- [2.字段命名规范.md](./2.字段命名规范.md) - 命名规范
- [4.注释规范.md](./4.注释规范.md) - 注释规范
- [AGENTS.md](./AGENTS.md) - AI 助手开发规范（包含 Git 提交规范）
- [4.框架开发计划.md](../1.plan/4.框架开发计划.md) - 开发计划（包含 Git 工作流说明）

---

**最后更新**：2025-11-17

