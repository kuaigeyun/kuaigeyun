# RiverEdge SaaS 多租户框架 - 第三方依赖管理规范

## 📋 概述

本文档定义 **RiverEdge SaaS 多租户框架 (RiverEdge SaaS Multi-tenant Framework)** 的**第三方依赖管理规范**，确保依赖选择合理、版本管理规范、安全可控，提升项目的可维护性和稳定性。

**创建日期**：2025-11-17

## 🎯 管理原则

1. **优先级原则**：严格按照库选择优先级选择依赖（参考 [AGENTS.md](./AGENTS.md) 中的库选择优先级规范）
2. **版本锁定**：生产环境必须使用锁定文件，确保依赖版本一致
3. **安全优先**：定期检查依赖安全漏洞，及时更新
4. **最小依赖**：只添加必要的依赖，避免过度依赖
5. **文档完善**：所有依赖变更必须记录在变更日志中

## 📦 依赖选择原则

### 库选择优先级

**必须严格按照以下优先级顺序选择依赖**（详细说明请参考 [AGENTS.md](./AGENTS.md)）：

1. **Ant Design Pro Components** - 优先使用 Ant Design Pro 官方组件
2. **React** - 使用 React 官方库或 React 生态成熟库
3. **FastAPI** - 使用 FastAPI 官方扩展或 FastAPI 生态成熟库
4. **Tortoise ORM** - 使用 Tortoise ORM 官方功能或扩展
5. **PostgreSQL** - 使用 PostgreSQL 原生功能或官方扩展
6. **其他成熟库** - 如果以上都无法满足，选择成熟稳定的第三方库
7. **自定义实现** - 最后才考虑自己实现

### 依赖评估标准

**添加新依赖前，必须评估以下标准**：

- [ ] **维护活跃度**：GitHub Stars > 1000，最近 6 个月有更新
- [ ] **文档完善度**：有完整的官方文档和示例
- [ ] **社区活跃度**：Issues 响应及时，社区讨论活跃
- [ ] **许可证兼容**：许可证与项目兼容（MIT、Apache 2.0 等）
- [ ] **类型支持**：支持 TypeScript（前端）或类型提示（后端）
- [ ] **安全性**：无已知安全漏洞（使用安全扫描工具检查）
- [ ] **兼容性**：与现有技术栈兼容，无冲突

### 禁止事项

- ❌ **禁止跳过优先级检查**：必须按照优先级顺序检查
- ❌ **禁止直接使用第三方库**：必须先检查官方库
- ❌ **禁止使用不成熟的库**：必须选择成熟稳定的库
- ❌ **禁止重复造轮子**：官方库或成熟库能满足需求时，禁止自己实现
- ❌ **禁止添加未评估的依赖**：所有依赖必须经过评估

## 🔧 后端依赖管理 (riveredge-core)

### 依赖文件

**主要依赖文件**：
- `requirements.txt` - 生产环境依赖（精确版本）
- `requirements-dev.txt` - 开发环境依赖（精确版本）
- `requirements.in` - 依赖声明文件（可选，用于 pip-tools）
- `pyproject.toml` - Poetry 配置文件（可选）

### requirements.txt 格式

**格式规范**：
```txt
# 核心框架
fastapi==0.115.0
uvicorn[standard]==0.30.0
pydantic==2.9.0
pydantic-settings==2.5.0

# ORM 和数据库
tortoise-orm==0.20.0
aerich==0.7.0
asyncpg==0.29.0

# 缓存
redis==5.0.0  # redis-py，使用 redis.asyncio 异步接口

# 认证和安全
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4

# HTTP 客户端
httpx==0.27.0

# 日志
loguru==0.7.0

# 测试
pytest==8.0.0
pytest-asyncio==0.23.0
```

**版本规范**：
- ✅ **生产环境**：使用精确版本（`==`），如 `fastapi==0.115.0`
- ✅ **开发环境**：可以使用兼容版本（`>=`），如 `pytest>=8.0.0`
- ❌ **禁止使用**：`*`、`latest`、无版本号

### 依赖安装

**使用 pip 安装**：
```bash
# 安装生产依赖
pip install -r requirements.txt

# 安装开发依赖
pip install -r requirements-dev.txt

# 使用虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows
pip install -r requirements.txt
```

**使用 Poetry（可选）**：
```bash
# 安装依赖
poetry install

# 添加新依赖
poetry add fastapi==0.115.0

# 添加开发依赖
poetry add --dev pytest==8.0.0

# 更新依赖
poetry update

# 导出 requirements.txt
poetry export -f requirements.txt --output requirements.txt --without-hashes
```

### 版本锁定

**锁定文件**：
- `requirements.txt` - 必须包含所有依赖的精确版本
- `poetry.lock` - Poetry 自动生成的锁定文件（如果使用 Poetry）

**锁定原则**：
- ✅ 生产环境必须使用锁定文件
- ✅ 所有依赖必须指定精确版本
- ✅ 锁定文件必须提交到版本控制
- ❌ 禁止在生产环境使用未锁定的依赖

### 依赖更新流程

**更新步骤**：
1. **检查更新**：使用 `pip list --outdated` 检查过时的依赖
2. **阅读变更日志**：查看依赖的变更日志（CHANGELOG）
3. **测试兼容性**：在开发环境测试新版本
4. **更新锁定文件**：更新 `requirements.txt` 中的版本号
5. **运行测试**：确保所有测试通过
6. **提交变更**：提交更新后的锁定文件

**更新命令**：
```bash
# 检查过时的依赖
pip list --outdated

# 更新单个依赖
pip install --upgrade fastapi==0.116.0

# 更新 requirements.txt
pip freeze > requirements.txt

# 或使用 pip-tools（推荐）
pip-compile requirements.in
```

## 📦 前端依赖管理 (riveredge-shell)

### 依赖文件

**主要依赖文件**：
- `package.json` - 依赖声明文件
- `package-lock.json` - npm 锁定文件（如果使用 npm）
- `pnpm-lock.yaml` - pnpm 锁定文件（推荐使用 pnpm）
- `yarn.lock` - yarn 锁定文件（如果使用 yarn）

### package.json 格式

**格式规范**：
```json
{
  "name": "riveredge-shell",
  "version": "1.0.0",
  "dependencies": {
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "@umijs/max": "^4.0.0",
    "antd": "^6.0.0",
    "@ant-design/pro-components": "^2.0.0",
    "@ant-design/icons": "^6.0.0",
    "@ant-design/charts": "^2.0.0",
    "@formily/core": "^2.3.0",
    "@formily/react": "^2.3.0",
    "@formily/antd-v5": "^2.3.0",
    "dayjs": "^1.11.0",
    "lodash-es": "^4.17.21"
  },
  "devDependencies": {
    "typescript": "^5.6.0",
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "eslint": "^9.0.0",
    "prettier": "^3.3.0"
  },
  "engines": {
    "node": ">=20.0.0",
    "npm": ">=10.0.0"
  }
}
```

**版本规范**：
- ✅ **主版本锁定**：核心依赖使用 `^`，如 `react: "^19.2.0"`（允许 19.x.x）
- ✅ **精确版本**：关键依赖使用精确版本，如 `antd: "6.0.0"`
- ✅ **开发依赖**：可以使用 `^` 或 `~`
- ❌ **禁止使用**：`*`、`latest`、无版本号

### 包管理器选择

**推荐使用 pnpm**（更快、更节省空间）：
```bash
# 安装 pnpm
npm install -g pnpm

# 安装依赖
pnpm install

# 添加新依赖
pnpm add antd@^6.0.0

# 添加开发依赖
pnpm add -D @types/react@^19.0.0

# 更新依赖
pnpm update

# 移除依赖
pnpm remove antd
```

**备选：npm**：
```bash
# 安装依赖
npm install

# 添加新依赖
npm install antd@^6.0.0

# 添加开发依赖
npm install -D @types/react@^19.0.0

# 更新依赖
npm update

# 移除依赖
npm uninstall antd
```

### 版本锁定

**锁定文件**：
- `package-lock.json` - npm 锁定文件
- `pnpm-lock.yaml` - pnpm 锁定文件（推荐）
- `yarn.lock` - yarn 锁定文件

**锁定原则**：
- ✅ 锁定文件必须提交到版本控制
- ✅ 生产环境必须使用锁定文件安装依赖
- ✅ 禁止手动修改锁定文件
- ❌ 禁止在生产环境使用 `npm install` 而不使用锁定文件

### 依赖更新流程

**更新步骤**：
1. **检查更新**：使用 `pnpm outdated` 或 `npm outdated` 检查过时的依赖
2. **阅读变更日志**：查看依赖的变更日志（GitHub Releases）
3. **测试兼容性**：在开发环境测试新版本
4. **更新 package.json**：更新版本号
5. **更新锁定文件**：运行 `pnpm install` 或 `npm install`
6. **运行测试**：确保所有测试通过
7. **提交变更**：提交更新后的 `package.json` 和锁定文件

**更新命令**：
```bash
# 检查过时的依赖
pnpm outdated
# 或
npm outdated

# 更新单个依赖
pnpm add antd@^6.1.0
# 或
npm install antd@^6.1.0

# 更新所有依赖（谨慎使用）
pnpm update
# 或
npm update
```

## ➕ 依赖添加流程

### 添加前检查清单

**添加新依赖前，必须完成以下检查**：

- [ ] **优先级检查**：按照库选择优先级检查是否有官方库可用
- [ ] **依赖评估**：评估依赖的维护活跃度、文档完善度、社区活跃度
- [ ] **许可证检查**：确认许可证与项目兼容
- [ ] **安全扫描**：使用安全扫描工具检查已知漏洞
- [ ] **兼容性测试**：确认与现有技术栈兼容
- [ ] **文档阅读**：阅读依赖的官方文档和最佳实践

### 添加步骤

**后端依赖添加**：
```bash
# 1. 安装依赖（开发环境）
pip install fastapi==0.115.0

# 2. 测试依赖是否正常工作
# 编写测试代码验证

# 3. 添加到 requirements.txt
echo "fastapi==0.115.0" >> requirements.txt

# 4. 提交变更
git add requirements.txt
git commit -m "feat(deps): 添加 fastapi 0.115.0 依赖"
```

**前端依赖添加**：
```bash
# 1. 安装依赖（开发环境）
pnpm add antd@^6.0.0

# 2. 测试依赖是否正常工作
# 编写测试代码验证

# 3. package.json 和锁定文件已自动更新

# 4. 提交变更
git add package.json pnpm-lock.yaml
git commit -m "feat(deps): 添加 antd 6.0.0 依赖"
```

### 提交信息规范

**遵循 Conventional Commits 规范**：
```bash
# 添加新依赖
feat(deps): 添加 fastapi 0.115.0 依赖

# 更新依赖版本
chore(deps): 更新 antd 从 6.0.0 到 6.1.0

# 移除依赖
chore(deps): 移除未使用的 lodash 依赖

# 修复依赖问题
fix(deps): 修复依赖版本冲突问题
```

## 🔄 依赖更新策略

### 更新频率

**更新策略**：
- **安全更新**：立即更新（发现安全漏洞时）
- **补丁更新**：每月检查一次（`x.x.1` → `x.x.2`）
- **小版本更新**：每季度检查一次（`x.1.0` → `x.2.0`）
- **大版本更新**：谨慎评估，需要充分测试（`1.x.x` → `2.x.x`）

### 更新优先级

**优先级排序**：
1. **安全漏洞修复**：最高优先级，立即更新
2. **核心框架更新**：FastAPI、React、Umi 等核心框架
3. **UI 组件库更新**：Ant Design、Pro Components
4. **工具库更新**：开发工具、测试框架
5. **其他依赖更新**：按需更新

### 大版本更新流程

**大版本更新（如 React 18 → 19）必须遵循以下流程**：

1. **评估影响范围**：
   - 阅读迁移指南（Migration Guide）
   - 评估对现有代码的影响
   - 评估对依赖库的影响

2. **创建功能分支**：
   ```bash
   git checkout -b chore/update-react-to-19
   ```

3. **逐步更新**：
   - 先更新核心依赖
   - 再更新相关依赖
   - 逐个解决兼容性问题

4. **充分测试**：
   - 运行所有单元测试
   - 运行集成测试
   - 手动测试关键功能

5. **代码审查**：
   - 提交 Pull Request
   - 进行代码审查
   - 确保所有测试通过

6. **合并到主分支**：
   - 合并到 develop 分支
   - 持续监控生产环境

## 🔒 依赖安全检查

### 安全扫描工具

**后端安全扫描**：
```bash
# 使用 safety 扫描 Python 依赖
pip install safety
safety check -r requirements.txt

# 使用 pip-audit（推荐）
pip install pip-audit
pip-audit -r requirements.txt
```

**前端安全扫描**：
```bash
# 使用 npm audit（npm）
npm audit

# 使用 pnpm audit（pnpm）
pnpm audit

# 使用 yarn audit（yarn）
yarn audit
```

### 安全检查流程

**定期安全检查**：
1. **每周检查**：运行安全扫描工具
2. **查看报告**：检查发现的漏洞
3. **评估风险**：评估漏洞的严重程度
4. **更新依赖**：及时更新有漏洞的依赖
5. **记录日志**：记录安全更新日志

**安全漏洞处理**：
- **高危漏洞**：立即更新，24 小时内修复
- **中危漏洞**：一周内更新
- **低危漏洞**：按正常更新流程处理

### CI/CD 集成

**在 CI/CD 中集成安全检查**：
```yaml
# .github/workflows/security.yml
name: Security Check

on:
  schedule:
    - cron: '0 0 * * 1'  # 每周一检查
  workflow_dispatch:

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 后端安全检查
      - name: Python Security Check
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt

      # 前端安全检查
      - name: Node Security Check
        run: |
          pnpm audit --audit-level=moderate
```

## 🗑️ 依赖移除流程

### 移除前检查

**移除依赖前，必须检查**：
- [ ] 确认依赖未被使用（搜索代码库）
- [ ] 确认无其他依赖依赖它（检查依赖树）
- [ ] 确认移除不会影响功能

### 移除步骤

**后端依赖移除**：
```bash
# 1. 从 requirements.txt 中移除
# 手动编辑 requirements.txt

# 2. 卸载依赖
pip uninstall unused-package

# 3. 测试项目是否正常
# 运行测试确保无影响

# 4. 提交变更
git add requirements.txt
git commit -m "chore(deps): 移除未使用的 unused-package 依赖"
```

**前端依赖移除**：
```bash
# 1. 移除依赖
pnpm remove unused-package
# 或
npm uninstall unused-package

# 2. package.json 和锁定文件已自动更新

# 3. 测试项目是否正常
# 运行测试确保无影响

# 4. 提交变更
git add package.json pnpm-lock.yaml
git commit -m "chore(deps): 移除未使用的 unused-package 依赖"
```

## 🔍 依赖冲突解决

### 冲突检测

**检测依赖冲突**：
```bash
# 后端：使用 pip check
pip check

# 前端：使用 pnpm why 或 npm ls
pnpm why conflicting-package
# 或
npm ls conflicting-package
```

### 冲突解决策略

**解决策略**：
1. **版本统一**：统一使用相同版本的依赖
2. **依赖升级**：升级冲突的依赖到兼容版本
3. **依赖替换**：使用替代依赖
4. **依赖隔离**：使用虚拟环境或容器隔离

**示例**：
```bash
# 如果发现版本冲突，尝试升级
pnpm update conflicting-package

# 或使用 resolutions（package.json）
{
  "resolutions": {
    "conflicting-package": "^2.0.0"
  }
}
```

## 📋 最佳实践

### 依赖管理最佳实践

1. **最小依赖原则**：
   - 只添加必要的依赖
   - 定期清理未使用的依赖
   - 避免重复功能的依赖

2. **版本锁定**：
   - 生产环境必须使用锁定文件
   - 所有依赖必须指定版本
   - 定期更新锁定文件

3. **安全优先**：
   - 定期检查安全漏洞
   - 及时更新有漏洞的依赖
   - 在 CI/CD 中集成安全检查

4. **文档完善**：
   - 记录依赖添加原因
   - 记录依赖更新日志
   - 维护依赖变更历史

5. **测试充分**：
   - 依赖更新后必须运行测试
   - 大版本更新需要充分测试
   - 生产环境部署前必须测试

### 依赖文件管理

**文件组织**：
```
riveredge-core/
├── requirements.txt          # 生产依赖（精确版本）
├── requirements-dev.txt      # 开发依赖（精确版本）
└── pyproject.toml            # Poetry 配置（可选）

riveredge-shell/
├── package.json              # 依赖声明
├── pnpm-lock.yaml           # 锁定文件（推荐）
└── .npmrc                    # npm 配置（可选）
```

**版本控制**：
- ✅ 锁定文件必须提交到版本控制
- ✅ 依赖文件必须提交到版本控制
- ❌ 禁止提交 `node_modules` 目录
- ❌ 禁止提交虚拟环境目录

## ✅ 检查清单

添加或更新依赖时，请确保：

- [ ] 按照库选择优先级检查了依赖
- [ ] 评估了依赖的维护活跃度、文档完善度、社区活跃度
- [ ] 检查了许可证兼容性
- [ ] 运行了安全扫描工具
- [ ] 测试了依赖的兼容性
- [ ] 更新了依赖文件（requirements.txt 或 package.json）
- [ ] 更新了锁定文件（package-lock.json 或 pnpm-lock.yaml）
- [ ] 运行了所有测试
- [ ] 提交了变更（遵循 Conventional Commits 规范）
- [ ] 记录了依赖变更日志

## 📚 相关文档

- [AGENTS.md](./AGENTS.md) - AI 助手开发规范（包含库选择优先级）
- [8.Git工作流规范.md](./8.Git工作流规范.md) - Git 工作流规范（包含提交规范）
- [1.最终技术选型.md](../1.plan/1.最终技术选型.md) - 技术选型（包含依赖示例）
- [2.架构设计文档.md](../1.plan/2.架构设计文档.md) - 架构设计文档

## 🔗 参考资源

- [pip 官方文档](https://pip.pypa.io/)
- [Poetry 官方文档](https://python-poetry.org/)
- [pnpm 官方文档](https://pnpm.io/)
- [npm 官方文档](https://docs.npmjs.com/)
- [pip-audit 文档](https://pypi.org/project/pip-audit/)
- [npm audit 文档](https://docs.npmjs.com/cli/v8/commands/npm-audit)
- [Semantic Versioning](https://semver.org/) - 语义化版本规范

---

**最后更新**：2025-11-17
