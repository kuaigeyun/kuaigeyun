# RiverEdge SaaS å¤šç§Ÿæˆ·æ¡†æ¶ - é”™è¯¯å¤„ç†è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰ **RiverEdge SaaS å¤šç§Ÿæˆ·æ¡†æ¶ (RiverEdge SaaS Multi-tenant Framework)** çš„**ç»Ÿä¸€é”™è¯¯å¤„ç†è§„èŒƒ**ï¼Œç¡®ä¿é”™è¯¯ä¿¡æ¯ä¸€è‡´ã€é”™è¯¯å¤„ç†ç»Ÿä¸€ï¼Œæå‡å¼€å‘æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-17

## ğŸ¯ è®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€æ ¼å¼**ï¼šæ‰€æœ‰é”™è¯¯ä½¿ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼
2. **æ¸…æ™°æ˜ç¡®**ï¼šé”™è¯¯ä¿¡æ¯æ¸…æ™°ï¼Œä¾¿äºå®šä½é—®é¢˜
3. **åˆ†å±‚å¤„ç†**ï¼šåç«¯å¼‚å¸¸å¤„ç†ã€å‰ç«¯é”™è¯¯æ‹¦æˆª
4. **ç”¨æˆ·å‹å¥½**ï¼šå‰ç«¯é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½
5. **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰é”™è¯¯è®°å½•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥
6. **ç»å¯¹ç¦æ­¢ PowerShell**ï¼šå…¨ç¨‹ä¸¥ç¦ä½¿ç”¨ PowerShell è¿›è¡Œä»»ä½•æ“ä½œ â­ **é‡è¦**

## ğŸ”§ åç«¯é”™è¯¯å¤„ç†

### è‡ªå®šä¹‰å¼‚å¸¸ç±»

**ä½ç½®**ï¼š`src/core/exceptions.py`

**å¼‚å¸¸ç±»å®šä¹‰**ï¼š
```python
"""
è‡ªå®šä¹‰å¼‚å¸¸ç±»
"""
from fastapi import HTTPException, status


class BaseAPIException(HTTPException):
    """åŸºç¡€ API å¼‚å¸¸ç±»"""
    
    def __init__(
        self,
        status_code: int,
        detail: str,
        code: int = None,
        headers: dict = None
    ):
        super().__init__(status_code=status_code, detail=detail, headers=headers)
        self.code = code or status_code


class ValidationError(BaseAPIException):
    """æ•°æ®éªŒè¯é”™è¯¯ï¼ˆ400ï¼‰"""
    
    def __init__(self, detail: str = "æ•°æ®éªŒè¯å¤±è´¥"):
        super().__init__(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=detail,
            code=400
        )


class UnauthorizedError(BaseAPIException):
    """æœªæˆæƒé”™è¯¯ï¼ˆ401ï¼‰"""
    
    def __init__(self, detail: str = "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•"):
        super().__init__(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=detail,
            code=401
        )


class PermissionDeniedError(BaseAPIException):
    """æƒé™ä¸è¶³é”™è¯¯ï¼ˆ403ï¼‰"""
    
    def __init__(self, detail: str = "æƒé™ä¸è¶³"):
        super().__init__(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=detail,
            code=403
        )


class NotFoundError(BaseAPIException):
    """èµ„æºä¸å­˜åœ¨é”™è¯¯ï¼ˆ404ï¼‰"""
    
    def __init__(self, detail: str = "èµ„æºä¸å­˜åœ¨"):
        super().__init__(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=detail,
            code=404
        )


class ConflictError(BaseAPIException):
    """èµ„æºå†²çªé”™è¯¯ï¼ˆ409ï¼‰"""
    
    def __init__(self, detail: str = "èµ„æºå†²çª"):
        super().__init__(
            status_code=status.HTTP_409_CONFLICT,
            detail=detail,
            code=409
        )


class InternalServerError(BaseAPIException):
    """æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼ˆ500ï¼‰"""
    
    def __init__(self, detail: str = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"):
        super().__init__(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=detail,
            code=500
        )
```

### å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶

**ä½ç½®**ï¼š`src/app/middleware.py`

**ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼š
```python
"""
å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶
"""
from fastapi import Request, status
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from starlette.exceptions import HTTPException as StarletteHTTPException
from core.exceptions import BaseAPIException
from utils.logger import logger
from datetime import datetime


async def exception_handler(request: Request, exc: Exception):
    """ç»Ÿä¸€å¼‚å¸¸å¤„ç†"""
    
    # è‡ªå®šä¹‰å¼‚å¸¸
    if isinstance(exc, BaseAPIException):
        logger.error(f"API Error: {exc.detail}", exc_info=exc)
        return JSONResponse(
            status_code=exc.status_code,
            content={
                "code": exc.code,
                "message": exc.detail,
                "timestamp": datetime.now().isoformat()
            }
        )
    
    # FastAPI éªŒè¯é”™è¯¯
    if isinstance(exc, RequestValidationError):
        errors = []
        for error in exc.errors():
            field = ".".join(str(loc) for loc in error["loc"])
            errors.append({
                "field": field,
                "message": error["msg"]
            })
        logger.warning(f"Validation Error: {errors}")
        return JSONResponse(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            content={
                "code": 422,
                "message": "æ•°æ®éªŒè¯å¤±è´¥",
                "detail": errors,
                "timestamp": datetime.now().isoformat()
            }
        )
    
    # HTTP å¼‚å¸¸
    if isinstance(exc, StarletteHTTPException):
        logger.error(f"HTTP Error: {exc.status_code} - {exc.detail}")
        return JSONResponse(
            status_code=exc.status_code,
            content={
                "code": exc.status_code,
                "message": exc.detail,
                "timestamp": datetime.now().isoformat()
            }
        )
    
    # æœªçŸ¥å¼‚å¸¸
    logger.exception(f"Unhandled Exception: {str(exc)}")
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "code": 500,
            "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
            "detail": "An unexpected error occurred" if request.app.debug else None,
            "timestamp": datetime.now().isoformat()
        }
    )
```

**æ³¨å†Œä¸­é—´ä»¶**ï¼š
```python
# src/app/main.py
from fastapi import FastAPI
from app.middleware import exception_handler

app = FastAPI()

# æ³¨å†Œå¼‚å¸¸å¤„ç†å™¨
app.add_exception_handler(Exception, exception_handler)
```

### ä½¿ç”¨ç¤ºä¾‹

**åœ¨ API ä¸­ä½¿ç”¨**ï¼š
```python
from fastapi import APIRouter, Depends
from core.exceptions import NotFoundError, ValidationError, PermissionDeniedError
from core.dependencies import get_current_user

router = APIRouter()

@router.get("/users/{user_id}")
async def get_user(
    user_id: int,
    current_user = Depends(get_current_user)
):
    """è·å–ç”¨æˆ·è¯¦æƒ…"""
    user = await UserService.get_by_id(user_id)
    
    # âœ… æ­£ç¡®ï¼šä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸
    if not user:
        raise NotFoundError("ç”¨æˆ·ä¸å­˜åœ¨")
    
    # âœ… æ­£ç¡®ï¼šæƒé™æ£€æŸ¥
    if user.tenant_id != current_user.tenant_id:
        raise PermissionDeniedError("æ— æƒè®¿é—®è¯¥ç”¨æˆ·")
    
    return ResponseModel(data=user)
```

**åœ¨ Service ä¸­ä½¿ç”¨**ï¼š
```python
from core.exceptions import NotFoundError, ConflictError

class UserService:
    @staticmethod
    async def get_by_id(user_id: int, tenant_id: int):
        """è·å–ç”¨æˆ·"""
        user = await User.filter(id=user_id, tenant_id=tenant_id).first()
        if not user:
            raise NotFoundError("ç”¨æˆ·ä¸å­˜åœ¨")
        return user
    
    @staticmethod
    async def create(data: UserCreate, tenant_id: int):
        """åˆ›å»ºç”¨æˆ·"""
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        existing = await User.filter(
            username=data.username,
            tenant_id=tenant_id
        ).first()
        if existing:
            raise ConflictError("ç”¨æˆ·åå·²å­˜åœ¨")
        
        user = await User.create(**data.dict(), tenant_id=tenant_id)
        return user
```

## ğŸ¨ å‰ç«¯é”™è¯¯å¤„ç†

### Umi Request é”™è¯¯æ‹¦æˆªå™¨

**ä½ç½®**ï¼š`src/utils/request.ts`

**é”™è¯¯æ‹¦æˆªå™¨é…ç½®**ï¼š
```typescript
/**
 * Umi Request é”™è¯¯æ‹¦æˆªå™¨
 */
import { message, Modal } from 'antd';
import { history } from '@umijs/max';
import type { RequestConfig } from '@umijs/max';

/**
 * é”™è¯¯å¤„ç†
 */
const errorHandler = (error: any) => {
  const { response } = error;

  if (response && response.status) {
    const { status, data } = response;
    
    switch (status) {
      case 400:
        // è¯·æ±‚å‚æ•°é”™è¯¯
        message.error(data?.message || 'è¯·æ±‚å‚æ•°é”™è¯¯');
        break;
      
      case 401:
        // æœªæˆæƒï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        message.error('æœªæˆæƒï¼Œè¯·å…ˆç™»å½•');
        // æ¸…é™¤ Token
        localStorage.removeItem('token');
        history.push('/login');
        break;
      
      case 403:
        // æƒé™ä¸è¶³
        message.error(data?.message || 'æƒé™ä¸è¶³');
        break;
      
      case 404:
        // èµ„æºä¸å­˜åœ¨
        message.error(data?.message || 'èµ„æºä¸å­˜åœ¨');
        break;
      
      case 409:
        // èµ„æºå†²çª
        message.error(data?.message || 'èµ„æºå†²çª');
        break;
      
      case 422:
        // æ•°æ®éªŒè¯å¤±è´¥
        const errors = data?.detail || [];
        if (Array.isArray(errors) && errors.length > 0) {
          const errorMsg = errors.map((e: any) => e.message).join(', ');
          message.error(`æ•°æ®éªŒè¯å¤±è´¥: ${errorMsg}`);
        } else {
          message.error(data?.message || 'æ•°æ®éªŒè¯å¤±è´¥');
        }
        break;
      
      case 500:
        // æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
        message.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        break;
      
      default:
        message.error(data?.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  } else {
    // ç½‘ç»œé”™è¯¯
    message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
  
  throw error;
};

/**
 * Request é…ç½®
 */
export const requestConfig: RequestConfig = {
  errorHandler,
  // å…¶ä»–é…ç½®...
};
```

### ç»„ä»¶ä¸­ä½¿ç”¨

**ä½¿ç”¨ try-catch**ï¼š
```typescript
import { message } from 'antd';
import { createUser } from '@/services/userService';

const handleCreate = async (data: UserCreate) => {
  try {
    const response = await createUser(data);
    if (response.code === 200) {
      message.success('åˆ›å»ºæˆåŠŸ');
      // åˆ·æ–°åˆ—è¡¨
      fetchUsers();
    }
  } catch (error: any) {
    // é”™è¯¯å·²åœ¨æ‹¦æˆªå™¨ä¸­å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–å¤„ç†
    console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
  }
};
```

**ä½¿ç”¨ ProTable è‡ªåŠ¨å¤„ç†**ï¼š
```typescript
import { ProTable } from '@ant-design/pro-components';
import { getUserList } from '@/services/userService';

export default function UserList() {
  return (
    <ProTable
      request={async (params) => {
        // ProTable ä¼šè‡ªåŠ¨å¤„ç†é”™è¯¯
        const response = await getUserList(params);
        return {
          data: response.data?.items || [],
          total: response.data?.total || 0,
          success: response.code === 200,
        };
      }}
      columns={[...]}
    />
  );
}
```

## ğŸ“Š é”™è¯¯ç å®šä¹‰

### HTTP çŠ¶æ€ç æ˜ å°„

| HTTP çŠ¶æ€ç  | ä¸šåŠ¡é”™è¯¯ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------------|-----------|------|----------|
| `200` | `200` | æˆåŠŸ | è¯·æ±‚æˆåŠŸ |
| `400` | `400` | è¯·æ±‚å‚æ•°é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ |
| `401` | `401` | æœªæˆæƒ | Token æ— æ•ˆæˆ–è¿‡æœŸ |
| `403` | `403` | æƒé™ä¸è¶³ | æ— æƒé™è®¿é—®èµ„æº |
| `404` | `404` | èµ„æºä¸å­˜åœ¨ | èµ„æºä¸å­˜åœ¨ |
| `409` | `409` | èµ„æºå†²çª | èµ„æºå·²å­˜åœ¨ï¼ˆå¦‚ç”¨æˆ·åé‡å¤ï¼‰ |
| `422` | `422` | æ•°æ®éªŒè¯å¤±è´¥ | Pydantic éªŒè¯å¤±è´¥ |
| `500` | `500` | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æœåŠ¡å™¨å¼‚å¸¸ |

### ä¸šåŠ¡é”™è¯¯ç ï¼ˆå¯é€‰ï¼‰

**è¯´æ˜**ï¼šå¯ä»¥åœ¨ `code` å­—æ®µä¸­ä½¿ç”¨ä¸šåŠ¡é”™è¯¯ç ï¼Œä½†å¿…é¡»é…åˆ HTTP çŠ¶æ€ç ä½¿ç”¨

**ç¤ºä¾‹**ï¼š
```json
{
  "code": 10001,  // ä¸šåŠ¡é”™è¯¯ç 
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "detail": "ç”¨æˆ· ID 123 ä¸å­˜åœ¨"
}
```

**é”™è¯¯ç èŒƒå›´**ï¼š
- `10001-10099`: é€šç”¨ä¸šåŠ¡é”™è¯¯ï¼ˆHTTP 400ï¼‰
- `10101-10199`: è®¤è¯ç›¸å…³é”™è¯¯ï¼ˆHTTP 401ï¼‰
- `10201-10299`: æƒé™ç›¸å…³é”™è¯¯ï¼ˆHTTP 403ï¼‰
- `10301-10399`: èµ„æºä¸å­˜åœ¨é”™è¯¯ï¼ˆHTTP 404ï¼‰
- `10401-10499`: èµ„æºå†²çªé”™è¯¯ï¼ˆHTTP 409ï¼‰

## ğŸ“ é”™è¯¯å“åº”æ ¼å¼

### æ ‡å‡†é”™è¯¯å“åº”

```json
{
  "code": 404,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "timestamp": "2025-11-17T10:00:00Z"
}
```

### éªŒè¯é”™è¯¯å“åº”

```json
{
  "code": 422,
  "message": "æ•°æ®éªŒè¯å¤±è´¥",
  "detail": [
    {
      "field": "email",
      "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
    },
    {
      "field": "password",
      "message": "å¯†ç é•¿åº¦è‡³å°‘ 8 ä½"
    }
  ],
  "timestamp": "2025-11-17T10:00:00Z"
}
```

## ğŸ” æ—¥å¿—è®°å½•

### åç«¯æ—¥å¿—

**ä½¿ç”¨ loguru**ï¼š
```python
from utils.logger import logger

try:
    user = await UserService.get_by_id(user_id)
except NotFoundError as e:
    logger.error(f"User not found: user_id={user_id}, error={e.detail}")
    raise
except Exception as e:
    logger.exception(f"Unexpected error: {str(e)}")
    raise InternalServerError("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯")
```

### å‰ç«¯æ—¥å¿—

**ä½¿ç”¨ console.error**ï¼š
```typescript
try {
  await createUser(data);
} catch (error) {
  console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
  // é”™è¯¯å·²åœ¨æ‹¦æˆªå™¨ä¸­å¤„ç†
}
```

## âœ… æ£€æŸ¥æ¸…å•

å®ç°é”™è¯¯å¤„ç†æ—¶ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] ä½¿ç”¨è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼ˆåç«¯ï¼‰
- [ ] æ³¨å†Œå¼‚å¸¸å¤„ç†ä¸­é—´ä»¶ï¼ˆåç«¯ï¼‰
- [ ] é…ç½®é”™è¯¯æ‹¦æˆªå™¨ï¼ˆå‰ç«¯ï¼‰
- [ ] é”™è¯¯ä¿¡æ¯æ¸…æ™°æ˜ç¡®
- [ ] é”™è¯¯æ—¥å¿—å·²è®°å½•
- [ ] ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºï¼ˆå‰ç«¯ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [6.APIè®¾è®¡è§„èŒƒ.md](./6.APIè®¾è®¡è§„èŒƒ.md) - API è®¾è®¡è§„èŒƒï¼ˆåŒ…å«é”™è¯¯å“åº”æ ¼å¼ï¼‰
- [2.å­—æ®µå‘½åè§„èŒƒ.md](./2.å­—æ®µå‘½åè§„èŒƒ.md) - å‘½åè§„èŒƒ
- [4.æ³¨é‡Šè§„èŒƒ.md](./4.æ³¨é‡Šè§„èŒƒ.md) - æ³¨é‡Šè§„èŒƒ
- [AGENTS.md](./AGENTS.md) - AI åŠ©æ‰‹å¼€å‘è§„èŒƒ

---

**æœ€åæ›´æ–°**ï¼š2025-11-17

