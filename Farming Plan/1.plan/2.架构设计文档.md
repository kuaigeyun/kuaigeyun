# RiverEdge SaaS 多租户框架 - 架构设计文档

## 📋 项目概述

**RiverEdge SaaS 多租户框架 (RiverEdge SaaS Multi-tenant Framework)** 是一套基于插件化架构的 SaaS 多租户管理框架，采用前后端分离设计，支持动态加载应用插件。

## 🌿 命名哲学

**RiverEdge SaaS 多租户框架**采用**自然/植物生态**的命名哲学，将系统架构比作一个完整的生态系统：

- **core** (根): 核心系统，提供基础支撑
- **shell** (壳): 框架外壳，承载应用
- **seeds** (种子): 应用插件，可生长的功能模块
- **land** (土地): 着陆页，展示和生长的土壤
- **leaf** (叶子): 移动端，轻量灵活的终端

所有命名都遵循统一的生态主题，形成完整的系统生态。详细说明请参考：[1.框架命名哲学.md](../2.rules/1.框架命名哲学.md)

## 🏗️ 架构设计

### 核心模块划分

```
riveredge/
├── riveredge-core/      # 后端核心系统（根）
├── riveredge-shell/     # 前端基础框架（壳）
├── riveredge-seeds/     # 应用插件集合（种子）
├── riveredge-land/      # 着陆页/官网（土地）
├── riveredge-leaf/      # 移动端应用（叶子）
└── Farming Plan/        # 开发计划和设计规范
```

### 1. riveredge-core (后端核心系统)

**职责：**
- 提供核心 API 服务
- 用户认证与授权
- 权限管理
- 系统配置管理
- 插件注册与管理
- 数据持久化

**技术栈：**
- **编程语言**: Python 3.13+
- **Web 框架**: FastAPI 0.115+
- **数据验证**: Pydantic v2.9+
- **数据库**: PostgreSQL 15+
- **ORM 框架**: Tortoise ORM 0.20+
- **数据库迁移**: Aerich 0.7+
- **缓存**: Redis 7.2+
- **认证**: JWT (python-jose)
- **API 文档**: FastAPI 自动生成 OpenAPI/Swagger
- **HTTP 客户端**: httpx
- **日志**: loguru
- **配置管理**: pydantic-settings
- **测试框架**: pytest + pytest-asyncio

详细技术选型请参考：[1.最终技术选型.md](./1.最终技术选型.md)

**核心功能模块：**
```
riveredge-core/
├── src/
│   ├── app/
│   │   ├── main.py          # FastAPI 应用入口
│   │   ├── config.py        # 应用配置
│   │   └── dependencies.py  # 依赖注入
│   ├── api/
│   │   ├── v1/
│   │   │   ├── auth.py      # 认证授权 API
│   │   │   ├── users.py     # 用户管理 API
│   │   │   ├── roles.py     # 角色权限 API
│   │   │   └── plugins.py   # 插件管理 API
│   │   └── deps.py          # API 依赖
│   ├── core/
│   │   ├── security.py      # 安全相关（JWT、密码加密）
│   │   ├── config.py        # 核心配置
│   │   └── database.py      # 数据库连接
│   ├── models/
│   │   ├── user.py          # 用户模型
│   │   ├── role.py          # 角色模型
│   │   └── plugin.py        # 插件模型
│   ├── schemas/
│   │   ├── user.py          # 用户 Schema (Pydantic)
│   │   ├── role.py          # 角色 Schema
│   │   └── plugin.py        # 插件 Schema
│   ├── services/
│   │   ├── auth_service.py  # 认证服务
│   │   ├── user_service.py  # 用户服务
│   │   └── plugin_service.py # 插件服务
│   └── utils/
│       └── plugin_loader.py # 插件加载器
├── migrations/              # Aerich 数据库迁移
├── tests/                   # 测试代码
└── requirements.txt         # Python 依赖
```

### 2. riveredge-shell (前端基础框架)

**职责：**
- 前端应用主框架
- 基础系统管理界面（用户、角色、权限等）
- 插件加载与路由管理
- 统一 UI 组件库
- 状态管理
- 主题配置

**技术栈：**
- **核心框架**: React 19.2+
- **应用框架**: Umi V4 (@umijs/max)
- **UI 组件库**: Ant Design v6 + Ant Design Pro Components 2.x
- **状态管理**: Umi Model (内置)
- **类型系统**: TypeScript 5.6+
- **HTTP 客户端**: Umi Request (内置)
- **路由**: React Router 6 (Umi 内置)
- **构建工具**: Vite (Umi 内置)
- **图表库**: @ant-design/charts (基于 AntV G2Plot)
- **表单自定义字段**: Formily (@formily/core + @formily/react + @formily/antd-v5)
- **打印模板设计**: react-to-print + jspdf + html2canvas
- **图标库**: @ant-design/icons
- **日期处理**: dayjs
- **工具函数**: lodash-es
- **国际化**: @umijs/plugin-locale (Umi 内置)
- **权限管理**: @umijs/plugin-access (Umi 内置)
- **数据流**: @umijs/plugin-model (Umi 内置)
- **代码规范**: ESLint + Prettier
- **CSS 方案**: CSS Modules (Umi 内置支持)

详细技术选型请参考：[1.最终技术选型.md](./1.最终技术选型.md)

**核心功能模块：**
```
riveredge-shell/
├── src/
│   ├── pages/              # 页面目录
│   │   ├── user/           # 用户管理页面
│   │   ├── role/           # 角色管理页面
│   │   └── system/         # 系统设置页面
│   ├── components/         # 公共组件
│   ├── services/           # API 服务
│   ├── models/             # Umi Model (数据流)
│   ├── utils/              # 工具函数
│   ├── locales/            # 国际化文件
│   ├── access.ts           # 权限定义
│   └── app.tsx             # 应用入口
├── public/                 # 静态资源
├── .umirc.ts               # Umi 配置
└── package.json
```

### 3. riveredge-seeds (应用插件集合)

**职责：**
- 独立的业务应用模块
- 包含前端和后端代码
- 以插件形式动态加载到 shell 和 core
- 每个 seed 是独立的可部署单元

### 4. riveredge-land (着陆页/官网)

**职责：**
- SaaS 软件介绍主页
- 客户简易官网首页
- 产品展示和营销页面
- 系统对外展示窗口

**命名含义：**
- **Land** = 土地/着陆
- 如同植物的生长土壤，是展示和生长的平台
- 是用户"着陆"的第一站，也是系统对外展示的窗口

**技术栈：**
- **框架**: React + Ant Design Landing
- **构建工具**: Vite
- **动画**: Ant Motion

### 5. riveredge-leaf (移动端应用)

**职责：**
- 移动端应用
- 生产现场数据录入
- 移动端工单查看
- 设备巡检应用
- 质量检验移动端

**命名含义：**
- **Leaf** = 叶子
- 如同植物的叶子，轻量、灵活、可移动
- 叶子是植物与外界交互的界面，移动端是系统与用户移动交互的界面

**技术栈：**
- **框架**: React + Ant Design Mobile
- **构建工具**: Vite
- **动画**: Ant Motion

**插件规范：**
```
riveredge-seeds/
├── seed-example/              # 示例插件
│   ├── frontend/              # 前端代码
│   │   ├── src/
│   │   │   ├── index.ts       # 前端插件入口
│   │   │   ├── routes.ts      # 前端路由定义
│   │   │   └── components/    # 前端组件
│   │   ├── package.json       # 前端依赖配置
│   │   ├── vite.config.ts     # 前端构建配置
│   │   └── tsconfig.json      # TypeScript 配置
│   ├── backend/               # 后端代码
│   │   ├── src/
│   │   │   ├── __init__.py
│   │   │   ├── plugin.py      # 后端插件入口
│   │   │   ├── api/
│   │   │   │   └── routes.py  # API 路由
│   │   │   ├── models/
│   │   │   │   └── example.py # 数据模型
│   │   │   ├── schemas/
│   │   │   │   └── example.py # Pydantic Schema
│   │   │   └── services/
│   │   │       └── example.py # 业务逻辑
│   │   └── requirements.txt   # Python 依赖
│   ├── shared/                # 前后端共享代码（可选）
│   │   └── types/             # 共享类型定义
│   ├── db/                    # 数据库迁移脚本（可选）
│   │   └── migration/
│   ├── manifest.json          # 插件清单（必需）
│   ├── package.json           # 插件根配置（可选）
│   └── README.md              # 插件文档
```

**插件清单 (manifest.json) 结构：**
```json
{
  "id": "seed-example",
  "name": "示例应用",
  "version": "1.0.0",
  "description": "插件描述",
  "frontend": {
    "enabled": true,
    "entry": "./frontend/dist/index.js",
    "routes": [
      {
        "path": "/example",
        "component": "ExamplePage"
      }
    ]
  },
  "backend": {
    "enabled": true,
    "basePath": "/api/example",
    "pluginClass": "ExamplePlugin",
    "routes": [
      {
        "path": "/list",
        "method": "GET",
        "handler": "list_examples",
        "permissions": ["example:read"]
      }
    ],
    "entities": [
      "ExampleModel"
    ],
    "migrations": [
      "001_initial.py"
    ]
  },
  "permissions": ["example:read", "example:write"],
  "dependencies": []
}
```

## 🔌 插件机制设计

### 插件架构概览

插件系统分为**前端插件**和**后端插件**两部分：

- **前端插件**: 在 `riveredge-shell` 中动态加载的 UI 组件和路由
- **后端插件**: 在 `riveredge-core` 中注册的 API 路由和业务逻辑

### 插件目录结构

每个插件（seed）包含前端和后端代码，统一放在 `riveredge-seeds` 目录下：

```
riveredge-seeds/
├── seed-example/              # 示例插件
│   ├── frontend/              # 前端代码
│   ├── backend/               # 后端代码
│   ├── shared/                # 前后端共享代码（可选）
│   ├── db/                    # 数据库迁移（可选）
│   ├── manifest.json          # 插件清单（必需）
│   └── README.md              # 插件文档
```

详细目录结构请参考：[插件目录结构说明.md](../4.branch/插件目录结构说明.md)

### 后端插件机制

#### 插件注册方式

**模块注册模式**（采用）
- 插件作为 Python 模块注册到核心系统
- 路由由 FastAPI 统一管理和路由
- 共享认证、权限、数据库等基础设施
- 使用 Python 动态导入 (`importlib`) 加载插件

#### 后端插件功能

- **API 路由注册**: 插件通过 FastAPI Router 注册自己的 RESTful API 路由
- **权限管理**: 插件定义所需的权限，由核心系统统一验证（JWT）
- **数据模型**: 插件使用 Tortoise ORM 定义自己的数据实体和数据库表
- **数据库迁移**: 插件使用 Aerich 管理数据库迁移脚本
- **业务逻辑**: 插件实现独立的业务逻辑和服务
- **Pydantic Schema**: 插件使用 Pydantic v2 定义数据验证模型

#### 后端插件实现

**插件基类**:
```python
from abc import ABC, abstractmethod
from fastapi import APIRouter

class BasePlugin(ABC):
    """插件基类"""
    
    @abstractmethod
    def get_router(self) -> APIRouter:
        """返回插件的 API 路由"""
        pass
    
    @abstractmethod
    def get_models(self) -> list:
        """返回插件的 Tortoise ORM 模型列表"""
        pass
```

**插件加载流程**:
1. 扫描 `riveredge-seeds` 目录下的所有插件
2. 读取每个插件的 `manifest.json`
3. 动态导入插件的 Python 模块
4. 实例化插件类并注册路由
5. 注册插件的数据库模型
6. 执行插件的数据库迁移

详细实现方案请参考：[插件开发规范.md](../4.branch/插件开发规范.md)

### 前端插件机制

#### 插件加载流程

1. **插件注册**
   - 后端注册插件信息（ID、路由、权限等）
   - 前端通过 Umi Request 从后端获取可用插件列表

2. **动态加载**
   - Shell 根据用户权限筛选可用插件
   - 使用 ES Modules 动态导入插件代码 (`import()`)
   - 通过 Umi 路由系统注册插件路由

3. **运行时集成**
   - 插件共享 Shell 的 Ant Design 组件库
   - 插件使用 Shell 的 Umi Model 状态管理
   - 插件通过 Shell 的 Umi Request 与后端通信
   - 插件可以使用 Formily 进行表单自定义字段
   - 插件可以使用 react-to-print 进行打印功能

#### 前端插件技术栈

- **模块加载**: ES Modules (动态 import)
- **构建工具**: Vite (与 Umi 集成)
- **路由系统**: Umi 路由（基于 React Router 6）
- **状态管理**: Umi Model
- **UI 组件**: Ant Design + Pro Components
- **插件规范**: 自定义 manifest.json

详细实现方案请参考：[插件开发规范.md](../4.branch/插件开发规范.md)

### 插件通信机制

- **前后端通信**: 前端插件通过 Shell 的 API 客户端调用后端插件 API
- **事件总线**: 插件间通信（前端）
- **共享状态**: 通过 Shell 的状态管理（前端）
- **统一权限**: 后端统一验证插件 API 的权限

### 功能热插拔机制 ⭐

#### 设计理念

功能热插拔是指在不修改核心代码的情况下，通过插件机制动态加载和卸载功能模块（如支付、短信、邮件等），实现功能的灵活扩展和替换。

**核心原则**：
- **核心代码零污染**：核心系统只定义接口，不包含任何具体实现
- **接口标准化**：通过抽象接口定义功能契约，插件实现具体功能
- **运行时热插拔**：支持在不重启服务的情况下启用/禁用功能
- **多实现支持**：同一功能可以有多个实现（如多种支付方式）

#### 架构设计

```
riveredge-core/
├── core/
│   ├── interfaces/          # 功能接口定义（核心）
│   │   ├── payment.py       # 支付接口
│   │   ├── sms.py          # 短信接口
│   │   ├── email.py        # 邮件接口
│   │   └── storage.py      # 存储接口
│   └── service_registry.py # 服务注册表（核心）
│
riveredge-seeds/
├── seed-payment-alipay/     # 支付宝支付插件
├── seed-payment-wechat/     # 微信支付插件
├── seed-sms-aliyun/         # 阿里云短信插件
├── seed-sms-tencent/        # 腾讯云短信插件
└── seed-email-smtp/         # SMTP 邮件插件
```

#### 实现流程

1. **接口定义**：核心系统定义功能接口（如 `IPaymentProvider`、`ISMSProvider`）
2. **服务注册表**：核心系统提供服务注册表，管理所有服务提供商
3. **插件实现**：插件实现接口，在 `on_load()` 钩子中注册到服务注册表
4. **核心调用**：核心系统通过服务注册表获取服务提供商并调用

#### 典型应用场景

- **支付功能**：支付宝、微信支付、银联等
- **短信服务**：阿里云、腾讯云、华为云等
- **邮件服务**：SMTP、SendGrid、阿里云邮件等
- **存储服务**：OSS、COS、S3 等
- **消息推送**：极光推送、个推、Firebase 等

详细实现方案请参考：[功能热插拔实现方案.md](../4.branch/功能热插拔实现方案.md)

## ✅ 架构可行性分析

### 优势

1. **模块化设计**: 清晰的职责划分，易于维护
2. **可扩展性**: 插件机制支持动态扩展功能
3. **独立开发**: 各模块可独立开发和部署
4. **技术栈统一**: 采用 Python + FastAPI（后端）和 React + Umi（前端）的统一技术栈

### 挑战与解决方案

1. **插件版本管理**
   - 解决方案: 使用语义化版本，提供版本兼容性检查

2. **插件依赖管理**
   - 解决方案: 在 manifest.json 中声明依赖，Shell 负责依赖解析

3. **性能优化**
   - 解决方案: 按需加载插件，代码分割，懒加载路由

4. **安全性**
   - 解决方案: 插件沙箱机制，权限验证，代码签名

5. **开发体验**
   - 解决方案: 提供插件开发脚手架，统一的开发规范

## 🛠️ 技术栈概览

### 后端 (riveredge-core)

**核心技术栈**:
- **编程语言**: Python 3.13+
- **Web 框架**: FastAPI 0.115+
- **ORM 框架**: Tortoise ORM 0.20+
- **数据库**: PostgreSQL 15+
- **缓存**: Redis 7.2+
- **认证**: JWT (python-jose)

### 前端 (riveredge-shell)

**核心技术栈**:
- **核心框架**: React 19.2+
- **应用框架**: Umi V4 (@umijs/max)
- **UI 组件库**: Ant Design v6 + Ant Design Pro Components 2.x
- **状态管理**: Umi Model
- **类型系统**: TypeScript 5.6+

### 插件系统

**技术选型**:
- **前端插件**: ES Modules (动态 import) + Vite
- **后端插件**: Python 动态导入 (`importlib`) + FastAPI Router

### 其他模块

**riveredge-land (着陆页/官网)**: React + Ant Design Landing + Vite + Ant Motion
**riveredge-leaf (移动端应用)**: React + Ant Design Mobile + Vite + Ant Motion

**详细技术选型、安装方式、依赖管理请参考**: [1.最终技术选型.md](./1.最终技术选型.md)

**详细开发计划请参考**: [4.框架开发计划.md](./4.框架开发计划.md)

## 📝 开发规范

详细开发规范请参考：
- [2.字段命名规范.md](../2.rules/2.字段命名规范.md) - ⭐ **统一命名规范（Python + TypeScript）**
- [4.注释规范.md](../2.rules/4.注释规范.md) - ⭐ **完善注释规范（Python + TypeScript）**
- [3.数据库命名规范.md](../2.rules/3.数据库命名规范.md) - ⭐ **数据库命名规范**
- [4.框架开发计划.md](./4.框架开发计划.md) - Git 工作流和提交规范

## 🎯 总结

该架构设计**完全可行**，具有以下特点：

1. ✅ **清晰的模块划分**: 职责明确，易于理解
   - core (根): 后端核心系统
   - shell (壳): 前端基础框架
   - seeds (种子): 应用插件集合
   - land (土地): 着陆页/官网
   - leaf (叶子): 移动端应用

2. ✅ **良好的扩展性**: 插件机制支持灵活扩展
   - 前后端插件统一管理
   - 动态加载，按需启用
   - 支持插件依赖管理

3. ✅ **技术栈现代化**: 采用最新稳定版本
   - 后端: Python 3.13 + FastAPI + Tortoise ORM + PostgreSQL
   - 前端: React 19.2 + Umi V4 + Ant Design v6 + Pro Components
   - 全部使用 Ant Design 系列组件，技术栈统一

4. ✅ **开发效率高**: 模块化开发，团队协作友好
   - Umi 约定式配置，减少样板代码
   - Pro Components 大幅提升开发效率
   - FastAPI 自动生成 API 文档
   - 完善的插件开发规范

5. ✅ **命名哲学统一**: 采用自然/植物生态命名
   - 所有模块命名遵循生态主题
   - 命名直观，易于理解和记忆

**建议**: 从 MVP (最小可行产品) 开始，先实现核心功能，再逐步完善插件系统。

**相关文档**:
- [1.最终技术选型.md](./1.最终技术选型.md) - 详细技术栈选型
- [1.框架命名哲学.md](../2.rules/1.框架命名哲学.md) - 命名规范和哲学说明
- [4.框架开发计划.md](./4.框架开发计划.md) - 详细开发计划
- [3.框架功能列表.md](./3.框架功能列表.md) - ⭐ **框架功能列表（核心代码 + 可热插拔功能）**
- [插件开发规范.md](../4.branch/插件开发规范.md) - 插件开发详细规范
- [插件目录结构说明.md](../4.branch/插件目录结构说明.md) - 插件目录结构说明
- [功能热插拔实现方案.md](../4.branch/功能热插拔实现方案.md) - ⭐ **功能热插拔实现方案（支付、短信等）**
- [表单自定义字段方案.md](../4.branch/表单自定义字段方案.md) - 表单自定义字段实现方案
- [打印模板设计方案.md](../4.branch/打印模板设计方案.md) - 打印模板设计实现方案

---

**最后更新**：2025-01-XX

