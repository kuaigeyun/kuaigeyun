# åå¥½è®¾ç½®æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šåå¥½è®¾ç½®ï¼ˆUser Preferencesï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š1 å‘¨  
**ä¾èµ–**ï¼šæ— ï¼ˆç‹¬ç«‹åŠŸèƒ½ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- ç”¨æˆ·åå¥½ç®¡ç†ï¼ˆä¸»é¢˜ã€è¯­è¨€ã€é€šçŸ¥è®¾ç½®ã€ç•Œé¢è®¾ç½®ï¼‰
- åå¥½è®¾ç½®ç¼“å­˜ï¼ˆRedisï¼‰
- åå¥½è®¾ç½®æŸ¥çœ‹å’Œç¼–è¾‘

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **ç”¨æˆ·åå¥½æ¨¡å‹**ï¼šç‹¬ç«‹çš„ç”¨æˆ·åå¥½è¡¨ï¼Œä¸€å¯¹ä¸€å…³è”ç”¨æˆ·
- âœ… **JSON é…ç½®**ï¼šä½¿ç”¨ JSON å­—æ®µå­˜å‚¨çµæ´»çš„åå¥½è®¾ç½®
- âœ… **Redis ç¼“å­˜**ï¼šåå¥½è®¾ç½®ç¼“å­˜åˆ° Redisï¼Œæå‡æ€§èƒ½

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### åå¥½è®¾ç½®å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **ä½¿ç”¨ç‹¬ç«‹ç”¨æˆ·åå¥½è¡¨ + Redis ç¼“å­˜ï¼ˆæ¨èï¼‰**

#### æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹ç”¨æˆ·åå¥½è¡¨ + Redis ç¼“å­˜ â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æ•°æ®åˆ†ç¦»ï¼Œç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œåå¥½è®¾ç½®åˆ†å¼€å­˜å‚¨
- âœ… çµæ´»çš„ JSON é…ç½®ï¼Œæ”¯æŒä»»æ„åå¥½è®¾ç½®
- âœ… Redis ç¼“å­˜æå‡æ€§èƒ½ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- âœ… å¤šç§Ÿæˆ·éš”ç¦»å¤©ç„¶æ”¯æŒï¼ˆtenant_id å­—æ®µï¼‰
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒï¼ˆå‘½åã€æ³¨é‡Šã€ä»£ç é£æ ¼ï¼‰

**åŠ£åŠ¿**ï¼š
- âš ï¸ éœ€è¦æ–°å»ºè¡¨å’Œç¼“å­˜é€»è¾‘

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… åå¥½è®¾ç½®å­—æ®µå¯èƒ½å˜åŒ–
- âœ… éœ€è¦é¢‘ç¹è¯»å–åå¥½è®¾ç½®
- âœ… éœ€è¦å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

**å®ç°å¤æ‚åº¦**ï¼šâ­ï¼ˆç®€å•ï¼Œ1 å‘¨å¯å®Œæˆï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ç”¨æˆ·åå¥½è¡¨ï¼ˆroot_user_preferencesï¼‰

```sql
CREATE TABLE root_user_preferences (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,                -- å…³è”ç”¨æˆ·IDï¼ˆå¤–é”®ï¼Œä¸€å¯¹ä¸€ï¼‰
    
    -- åå¥½è®¾ç½®ï¼ˆJSONæ ¼å¼ï¼‰
    preferences JSONB NOT NULL DEFAULT '{}', -- åå¥½è®¾ç½®ï¼ˆJSONæ ¼å¼ï¼‰
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_user_preferences_user_id UNIQUE (user_id),
    INDEX idx_root_user_preferences_tenant_id (tenant_id),
    INDEX idx_root_user_preferences_uuid (uuid),
    INDEX idx_root_user_preferences_user_id (user_id),
    INDEX idx_root_user_preferences_created_at (created_at)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… **æ··åˆIDæ–¹æ¡ˆ**ï¼š`id`ï¼ˆè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰+ `uuid`ï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼‰
- âœ… `user_id` å­—æ®µå…³è”ç”¨æˆ·è¡¨ï¼Œä¸€å¯¹ä¸€å…³ç³»
- âœ… `preferences` å­—æ®µä½¿ç”¨ JSONB å­˜å‚¨åå¥½è®¾ç½®
- âœ… `user_id` å”¯ä¸€çº¦æŸï¼Œç¡®ä¿ä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªåå¥½è®¾ç½®
- âœ… è½¯åˆ é™¤æ”¯æŒï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ï¼‰

**åå¥½è®¾ç½® JSON ç¤ºä¾‹**ï¼š
```json
{
  "theme": "light",
  "language": "zh-CN",
  "notifications": {
    "email": true,
    "sms": false,
    "internal": true,
    "push": true
  },
  "ui_settings": {
    "layout": "default",
    "font_size": "medium",
    "sidebar_collapsed": false
  }
}
```

---

## ğŸ”§ åç«¯å®ç°

### 1. åˆ›å»ºæ•°æ®åº“æ¨¡å‹

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/models/user_preference.py`

```python
"""
ç”¨æˆ·åå¥½æ¨¡å‹æ¨¡å—

å®šä¹‰ç”¨æˆ·åå¥½æ•°æ®æ¨¡å‹ï¼Œç”¨äºç”¨æˆ·åå¥½è®¾ç½®ç®¡ç†ã€‚
"""

from tortoise import fields
from typing import Dict, Any
from .base import BaseModel


class UserPreference(BaseModel):
    """
    ç”¨æˆ·åå¥½æ¨¡å‹
    
    ç”¨äºå­˜å‚¨ç”¨æˆ·çš„åå¥½è®¾ç½®ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€è¯­è¨€ã€é€šçŸ¥è®¾ç½®ç­‰ã€‚
    æ”¯æŒå¤šç»„ç»‡éš”ç¦»ï¼Œæ¯ä¸ªç»„ç»‡çš„ç”¨æˆ·åå¥½ç›¸äº’ç‹¬ç«‹ã€‚
    
    æ³¨æ„ï¼šç»§æ‰¿è‡ª BaseModelï¼Œè‡ªåŠ¨åŒ…å« uuidã€tenant_idã€created_atã€updated_at å­—æ®µã€‚
    """
    id = fields.IntField(pk=True, description="ç”¨æˆ·åå¥½IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    # uuid å­—æ®µç”± BaseModel æä¾›
    # tenant_id å­—æ®µç”± BaseModel æä¾›
    
    # å…³è”ç”¨æˆ·ï¼ˆä¸€å¯¹ä¸€ï¼‰
    user_id = fields.IntField(unique=True, description="å…³è”ç”¨æˆ·IDï¼ˆå¤–é”®ï¼Œä¸€å¯¹ä¸€ï¼‰")
    
    # åå¥½è®¾ç½®
    preferences = fields.JSONField(default={}, description="åå¥½è®¾ç½®ï¼ˆJSONæ ¼å¼ï¼‰")
    
    class Meta:
        """
        æ¨¡å‹å…ƒæ•°æ®
        """
        table = "root_user_preferences"
        indexes = [
            ("tenant_id",),
            ("uuid",),
            ("user_id",),
            ("created_at",),
        ]
        unique_together = [("user_id",)]
    
    def __str__(self):
        """å­—ç¬¦ä¸²è¡¨ç¤º"""
        return f"UserPreference(user_id={self.user_id})"
```

### 2. åˆ›å»º Schema

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/schemas/user_preference.py`

```python
"""
ç”¨æˆ·åå¥½ Schema æ¨¡å—

å®šä¹‰ç”¨æˆ·åå¥½ç›¸å…³çš„ Pydantic Schemaï¼Œç”¨äºæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–ã€‚
"""

from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, Dict, Any
from datetime import datetime
from uuid import UUID


class UserPreferenceBase(BaseModel):
    """ç”¨æˆ·åå¥½åŸºç¡€ Schema"""
    preferences: Dict[str, Any] = Field(default_factory=dict, description="åå¥½è®¾ç½®ï¼ˆJSONæ ¼å¼ï¼‰")


class UserPreferenceUpdate(BaseModel):
    """æ›´æ–°ç”¨æˆ·åå¥½ Schema"""
    preferences: Optional[Dict[str, Any]] = Field(None, description="åå¥½è®¾ç½®ï¼ˆJSONæ ¼å¼ï¼‰")


class UserPreferenceResponse(UserPreferenceBase):
    """ç”¨æˆ·åå¥½å“åº” Schema"""
    uuid: UUID = Field(..., description="ç”¨æˆ·åå¥½UUID")
    tenant_id: int = Field(..., description="ç»„ç»‡ID")
    user_id: int = Field(..., description="å…³è”ç”¨æˆ·ID")
    created_at: datetime = Field(..., description="åˆ›å»ºæ—¶é—´")
    updated_at: datetime = Field(..., description="æ›´æ–°æ—¶é—´")
    
    model_config = ConfigDict(from_attributes=True)
```

### 3. åˆ›å»º Service

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/services/user_preference_service.py`

```python
"""
ç”¨æˆ·åå¥½ç®¡ç†æœåŠ¡æ¨¡å—

æä¾›ç”¨æˆ·åå¥½çš„ CRUD æ“ä½œå’Œç¼“å­˜åŠŸèƒ½ã€‚
"""

from typing import Optional, Dict, Any
from uuid import UUID

from tortoise.exceptions import DoesNotExist

from tree_root.models.user_preference import UserPreference
from tree_root.schemas.user_preference import UserPreferenceUpdate, UserPreferenceResponse
from soil.infrastructure.cache.cache import Cache
from soil.exceptions.exceptions import NotFoundError


class UserPreferenceService:
    """
    ç”¨æˆ·åå¥½ç®¡ç†æœåŠ¡ç±»
    
    æä¾›ç”¨æˆ·åå¥½çš„ CRUD æ“ä½œå’Œç¼“å­˜åŠŸèƒ½ã€‚
    """
    
    @staticmethod
    def _get_cache_key(tenant_id: int, user_id: int) -> str:
        """ç”Ÿæˆç¼“å­˜é”®"""
        return f"user_preference:{tenant_id}:{user_id}"
    
    @staticmethod
    async def get_user_preference(
        tenant_id: int,
        user_id: int,
        use_cache: bool = True
    ) -> UserPreferenceResponse:
        """
        è·å–ç”¨æˆ·åå¥½
        
        Args:
            tenant_id: ç»„ç»‡ID
            user_id: ç”¨æˆ·ID
            use_cache: æ˜¯å¦ä½¿ç”¨ç¼“å­˜
            
        Returns:
            UserPreferenceResponse: ç”¨æˆ·åå¥½å¯¹è±¡
            
        Raises:
            NotFoundError: å½“ç”¨æˆ·åå¥½ä¸å­˜åœ¨æ—¶æŠ›å‡º
        """
        cache_key = UserPreferenceService._get_cache_key(tenant_id, user_id)
        
        # å°è¯•ä»ç¼“å­˜è·å–
        if use_cache:
            cached = await Cache.get(cache_key)
            if cached:
                return UserPreferenceResponse.model_validate(cached)
        
        # ä»æ•°æ®åº“è·å–
        try:
            user_preference = await UserPreference.get(
                tenant_id=tenant_id,
                user_id=user_id
            )
        except DoesNotExist:
            # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤åå¥½è®¾ç½®
            user_preference = await UserPreference.create(
                tenant_id=tenant_id,
                user_id=user_id,
                preferences={}
            )
        
        result = UserPreferenceResponse.model_validate(user_preference)
        
        # ç¼“å­˜ç»“æœ
        if use_cache:
            await Cache.set(cache_key, result.model_dump(), expire=3600)  # ç¼“å­˜1å°æ—¶
        
        return result
    
    @staticmethod
    async def update_user_preference(
        tenant_id: int,
        user_id: int,
        data: UserPreferenceUpdate
    ) -> UserPreferenceResponse:
        """
        æ›´æ–°ç”¨æˆ·åå¥½
        
        Args:
            tenant_id: ç»„ç»‡ID
            user_id: ç”¨æˆ·ID
            data: ç”¨æˆ·åå¥½æ›´æ–°æ•°æ®
            
        Returns:
            UserPreferenceResponse: æ›´æ–°åçš„ç”¨æˆ·åå¥½å¯¹è±¡
            
        Raises:
            NotFoundError: å½“ç”¨æˆ·åå¥½ä¸å­˜åœ¨æ—¶æŠ›å‡º
        """
        try:
            user_preference = await UserPreference.get(
                tenant_id=tenant_id,
                user_id=user_id
            )
        except DoesNotExist:
            # å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„åå¥½è®¾ç½®
            user_preference = await UserPreference.create(
                tenant_id=tenant_id,
                user_id=user_id,
                preferences=data.preferences or {}
            )
        else:
            # æ›´æ–°åå¥½è®¾ç½®ï¼ˆåˆå¹¶ï¼‰
            if data.preferences:
                current_preferences = user_preference.preferences or {}
                current_preferences.update(data.preferences)
                user_preference.preferences = current_preferences
                await user_preference.save()
        
        # æ¸…é™¤ç¼“å­˜
        cache_key = UserPreferenceService._get_cache_key(tenant_id, user_id)
        await Cache.delete(cache_key)
        
        return UserPreferenceResponse.model_validate(user_preference)
```

### 4. åˆ›å»º API

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/src/tree_root/api/user_preferences/user_preferences.py`

```python
"""
ç”¨æˆ·åå¥½ç®¡ç† API è·¯ç”±

æä¾›ç”¨æˆ·åå¥½çš„æŸ¥è¯¢å’Œæ›´æ–°åŠŸèƒ½ã€‚
"""

from fastapi import APIRouter, Depends, HTTPException, status

from tree_root.schemas.user_preference import UserPreferenceUpdate, UserPreferenceResponse
from tree_root.services.user_preference_service import UserPreferenceService
from tree_root.api.deps.deps import get_current_tenant
from soil.api.deps.deps import get_current_user
from soil.models.user import User
from soil.exceptions.exceptions import NotFoundError

router = APIRouter(prefix="/user-preferences", tags=["UserPreferences"])


@router.get("", response_model=UserPreferenceResponse)
async def get_user_preference(
    current_user: User = Depends(get_current_user),
    tenant_id: int = Depends(get_current_tenant),
):
    """
    è·å–å½“å‰ç”¨æˆ·åå¥½è®¾ç½®
    
    Returns:
        UserPreferenceResponse: ç”¨æˆ·åå¥½å¯¹è±¡
        
    Raises:
        HTTPException: å½“ç”¨æˆ·åå¥½ä¸å­˜åœ¨æ—¶æŠ›å‡º
    """
    try:
        return await UserPreferenceService.get_user_preference(
            tenant_id=tenant_id,
            user_id=current_user.id
        )
    except NotFoundError as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(e)
        )


@router.put("", response_model=UserPreferenceResponse)
async def update_user_preference(
    data: UserPreferenceUpdate,
    current_user: User = Depends(get_current_user),
    tenant_id: int = Depends(get_current_tenant),
):
    """
    æ›´æ–°å½“å‰ç”¨æˆ·åå¥½è®¾ç½®
    
    Args:
        data: ç”¨æˆ·åå¥½æ›´æ–°æ•°æ®
        
    Returns:
        UserPreferenceResponse: æ›´æ–°åçš„ç”¨æˆ·åå¥½å¯¹è±¡
        
    Raises:
        HTTPException: å½“ç”¨æˆ·åå¥½ä¸å­˜åœ¨æ—¶æŠ›å‡º
    """
    try:
        return await UserPreferenceService.update_user_preference(
            tenant_id=tenant_id,
            user_id=current_user.id,
            data=data
        )
    except NotFoundError as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(e)
        )
```

### 5. æ•°æ®åº“è¿ç§»

**æ–‡ä»¶ä½ç½®**ï¼š`riveredge-backend/migrations/models/XX_YYYYMMDDHHMMSS_create_user_preferences.py`

å‚è€ƒç¬¬å››é˜¶æ®µçš„è¿ç§»æ–‡ä»¶æ ¼å¼åˆ›å»ºã€‚

---

## ğŸŒ API è®¾è®¡

### ç”¨æˆ·åå¥½ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/v1/personal/user-preferences`

**æ¥å£åˆ—è¡¨**ï¼š
1. `GET /` - è·å–å½“å‰ç”¨æˆ·åå¥½è®¾ç½®
2. `PUT /` - æ›´æ–°å½“å‰ç”¨æˆ·åå¥½è®¾ç½®

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### åå¥½è®¾ç½®é¡µé¢

**é¡µé¢è·¯å¾„**ï¼š`pages/personal/preferences/index.tsx`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. åå¥½è®¾ç½®å±•ç¤ºï¼ˆä¸»é¢˜ã€è¯­è¨€ã€é€šçŸ¥è®¾ç½®ã€ç•Œé¢è®¾ç½®ï¼‰
2. åå¥½è®¾ç½®ç¼–è¾‘ï¼ˆè¡¨å•ç¼–è¾‘ï¼‰
3. å®æ—¶ä¿å­˜ï¼ˆç¼–è¾‘åè‡ªåŠ¨ä¿å­˜ï¼‰

**å¸ƒå±€è§„èŒƒ**ï¼š
- âœ… ä½¿ç”¨ `ProForm` ç»„ä»¶ç¼–è¾‘åå¥½è®¾ç½®
- âœ… ä½¿ç”¨ `ProFormSelect` é€‰æ‹©ä¸»é¢˜å’Œè¯­è¨€
- âœ… ä½¿ç”¨ `ProFormSwitch` å¼€å…³é€šçŸ¥è®¾ç½®
- âœ… ä½¿ç”¨ `ProFormGroup` åˆ†ç»„è®¾ç½®é¡¹

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. Redis ç¼“å­˜æ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- åå¥½è®¾ç½®è¯»å–é¢‘ç¹ï¼Œä½¿ç”¨ Redis ç¼“å­˜æå‡æ€§èƒ½
- æ›´æ–°åå¥½è®¾ç½®æ—¶ï¼Œéœ€è¦æ¸…é™¤ç¼“å­˜
- ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®ä¸º1å°æ—¶ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰

### 2. åå¥½è®¾ç½®åˆå¹¶æ³¨æ„äº‹é¡¹

**è¦ç‚¹**ï¼š
- æ›´æ–°åå¥½è®¾ç½®æ—¶ï¼Œåº”è¯¥åˆå¹¶è€Œä¸æ˜¯æ›¿æ¢
- åªæ›´æ–°æä¾›çš„å­—æ®µï¼Œä¿ç•™å…¶ä»–å­—æ®µä¸å˜
- ä½¿ç”¨å­—å…¸çš„ `update` æ–¹æ³•åˆå¹¶åå¥½è®¾ç½®

### 3. å¤šç§Ÿæˆ·æ”¯æŒ

**è¦ç‚¹**ï¼š
- ç”¨æˆ·åå¥½æŒ‰ç»„ç»‡éš”ç¦»ï¼ˆtenant_idï¼‰
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹å’Œç¼–è¾‘è‡ªå·±çš„åå¥½è®¾ç½®
- API è‡ªåŠ¨è¿‡æ»¤å½“å‰ç”¨æˆ·ï¼Œæ— éœ€æ‰‹åŠ¨è¿‡æ»¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md)
- [å»ºè®¾è¿›åº¦.md](./å»ºè®¾è¿›åº¦.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

