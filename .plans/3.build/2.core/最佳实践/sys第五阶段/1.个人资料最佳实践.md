# 个人资料最佳实践

## 📋 模块概述

**模块名称**：个人资料（User Profile）  
**优先级**：⭐⭐⭐（中优先级）  
**预计时间**：1 周  
**依赖**：用户管理（已有用户模型）

**功能范围**：
- 个人资料管理（头像、个人简介、联系方式）
- 头像上传（关联文件管理）
- 个人资料查看和编辑

**核心特点**：
- ✅ **扩展用户模型**：在现有用户模型基础上扩展个人资料字段
- ✅ **头像上传**：关联文件管理，支持头像上传
- ✅ **联系方式管理**：使用 JSON 字段存储灵活的联系方式

---

## 🔍 库选择评估

### 个人资料实现方案

**结论**：✅ **扩展现有用户模型（推荐）**

#### 方案一：扩展用户模型 ⭐⭐⭐⭐⭐（强烈推荐）

**优势**：
- ✅ 无需新建表，直接扩展现有用户模型
- ✅ 数据一致性好，用户信息和个人资料在同一张表
- ✅ 查询性能好，无需关联查询
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）

**劣势**：
- ⚠️ 需要数据库迁移（添加字段）

**适用场景**：
- ✅ 个人资料字段相对固定
- ✅ 需要与用户信息一起查询
- ✅ 需要多租户数据隔离

**实现复杂度**：⭐（简单，1 周可完成）

---

## 🗄️ 数据库设计

### 扩展用户表（soil_users）

**注意**：用户表在 `soil` 模块中，需要扩展该表。

```sql
-- 扩展 soil_users 表，添加个人资料字段
ALTER TABLE soil_users ADD COLUMN IF NOT EXISTS avatar VARCHAR(36);  -- 头像文件UUID，关联文件管理
ALTER TABLE soil_users ADD COLUMN IF NOT EXISTS bio TEXT;            -- 个人简介
ALTER TABLE soil_users ADD COLUMN IF NOT EXISTS contact_info JSONB;  -- 联系方式（JSON格式）
```

**设计要点**：
- ✅ `avatar` 字段存储文件UUID，关联文件管理模块
- ✅ `bio` 字段存储个人简介文本
- ✅ `contact_info` 字段使用 JSONB 存储联系方式（电话、邮箱、地址等）
- ✅ 不需要新建表，直接扩展现有用户表

**联系方式 JSON 示例**：
```json
{
  "phone": "13800138000",
  "email": "user@example.com",
  "address": "北京市朝阳区",
  "wechat": "wechat_id",
  "qq": "123456789"
}
```

---

## 🔧 后端实现

### 1. 扩展用户模型

**文件位置**：`riveredge-backend/src/soil/models/user.py`

**注意**：如果用户模型在 `soil` 模块中，需要在该模块中扩展。如果需要在 `tree_root` 模块中管理，可以创建扩展 Schema。

### 2. 创建 Schema

**文件位置**：`riveredge-backend/src/tree_root/schemas/user_profile.py`

```python
"""
个人资料 Schema 模块

定义个人资料相关的 Pydantic Schema，用于数据验证和序列化。
"""

from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, Dict, Any
from uuid import UUID


class UserProfileBase(BaseModel):
    """个人资料基础 Schema"""
    avatar: Optional[str] = Field(None, description="头像文件UUID")
    bio: Optional[str] = Field(None, description="个人简介")
    contact_info: Optional[Dict[str, Any]] = Field(None, description="联系方式（JSON格式）")


class UserProfileUpdate(UserProfileBase):
    """更新个人资料 Schema"""
    pass


class UserProfileResponse(UserProfileBase):
    """个人资料响应 Schema"""
    uuid: UUID = Field(..., description="用户UUID")
    username: str = Field(..., description="用户名")
    email: Optional[str] = Field(None, description="邮箱")
    
    model_config = ConfigDict(from_attributes=True)
```

### 3. 创建 Service

**文件位置**：`riveredge-backend/src/tree_root/services/user_profile_service.py`

```python
"""
个人资料管理服务模块

提供个人资料的查询和更新功能。
"""

from typing import Optional
from uuid import UUID

from soil.models.user import User
from tree_root.schemas.user_profile import UserProfileUpdate, UserProfileResponse
from soil.exceptions.exceptions import NotFoundError


class UserProfileService:
    """
    个人资料管理服务类
    
    提供个人资料的查询和更新功能。
    """
    
    @staticmethod
    async def get_user_profile(
        user_uuid: str
    ) -> UserProfileResponse:
        """
        获取个人资料
        
        Args:
            user_uuid: 用户UUID
            
        Returns:
            UserProfileResponse: 个人资料对象
            
        Raises:
            NotFoundError: 当用户不存在时抛出
        """
        user = await User.filter(uuid=user_uuid).first()
        
        if not user:
            raise NotFoundError("用户不存在")
        
        return UserProfileResponse.model_validate(user)
    
    @staticmethod
    async def update_user_profile(
        user_uuid: str,
        data: UserProfileUpdate
    ) -> UserProfileResponse:
        """
        更新个人资料
        
        Args:
            user_uuid: 用户UUID
            data: 个人资料更新数据
            
        Returns:
            UserProfileResponse: 更新后的个人资料对象
            
        Raises:
            NotFoundError: 当用户不存在时抛出
        """
        user = await User.filter(uuid=user_uuid).first()
        
        if not user:
            raise NotFoundError("用户不存在")
        
        update_data = data.model_dump(exclude_unset=True)
        for key, value in update_data.items():
            setattr(user, key, value)
        
        await user.save()
        return UserProfileResponse.model_validate(user)
```

### 4. 创建 API

**文件位置**：`riveredge-backend/src/tree_root/api/user_profile/user_profile.py`

```python
"""
个人资料管理 API 路由

提供个人资料的查询和更新功能。
"""

from fastapi import APIRouter, Depends, HTTPException, status

from tree_root.schemas.user_profile import UserProfileUpdate, UserProfileResponse
from tree_root.services.user_profile_service import UserProfileService
from soil.api.deps.deps import get_current_user
from soil.models.user import User
from soil.exceptions.exceptions import NotFoundError

router = APIRouter(prefix="/user-profile", tags=["UserProfile"])


@router.get("", response_model=UserProfileResponse)
async def get_user_profile(
    current_user: User = Depends(get_current_user),
):
    """
    获取当前用户个人资料
    
    Returns:
        UserProfileResponse: 个人资料对象
        
    Raises:
        HTTPException: 当用户不存在时抛出
    """
    try:
        return await UserProfileService.get_user_profile(str(current_user.uuid))
    except NotFoundError as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(e)
        )


@router.put("", response_model=UserProfileResponse)
async def update_user_profile(
    data: UserProfileUpdate,
    current_user: User = Depends(get_current_user),
):
    """
    更新当前用户个人资料
    
    Args:
        data: 个人资料更新数据
        
    Returns:
        UserProfileResponse: 更新后的个人资料对象
        
    Raises:
        HTTPException: 当用户不存在时抛出
    """
    try:
        return await UserProfileService.update_user_profile(
            str(current_user.uuid),
            data
        )
    except NotFoundError as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(e)
        )
```

### 5. 数据库迁移

**文件位置**：`riveredge-backend/migrations/models/XX_YYYYMMDDHHMMSS_add_user_profile_fields.py`

```python
"""
添加用户个人资料字段迁移

扩展用户表，添加个人资料字段。
"""

from tortoise import BaseDBAsyncClient


async def upgrade(db: BaseDBAsyncClient) -> str:
    return """
        -- 添加个人资料字段
        ALTER TABLE soil_users ADD COLUMN IF NOT EXISTS avatar VARCHAR(36);
        ALTER TABLE soil_users ADD COLUMN IF NOT EXISTS bio TEXT;
        ALTER TABLE soil_users ADD COLUMN IF NOT EXISTS contact_info JSONB;
    """


async def downgrade(db: BaseDBAsyncClient) -> str:
    return """
        -- 删除个人资料字段
        ALTER TABLE soil_users DROP COLUMN IF EXISTS contact_info;
        ALTER TABLE soil_users DROP COLUMN IF EXISTS bio;
        ALTER TABLE soil_users DROP COLUMN IF EXISTS avatar;
    """
```

---

## 🌐 API 设计

### 个人资料管理 API

**路由前缀**：`/api/v1/personal/user-profile`

**接口列表**：
1. `GET /` - 获取当前用户个人资料
2. `PUT /` - 更新当前用户个人资料

---

## 🎨 前端页面设计

### 个人资料页面

**页面路径**：`pages/personal/profile/index.tsx`

**核心功能**：
1. 个人资料展示（头像、用户名、邮箱、个人简介、联系方式）
2. 个人资料编辑（表单编辑、头像上传）
3. 头像上传（使用文件管理上传组件）

**布局规范**：
- ✅ 使用 `ProForm` 组件编辑个人资料
- ✅ 使用 `Upload` 组件上传头像
- ✅ 使用 `ProDescriptions` 组件展示个人资料
- ✅ 联系方式使用 JSON 编辑器（可选）

---

## ⚠️ 重要注意事项

### 1. 用户模型扩展注意事项

**要点**：
- 用户模型在 `soil` 模块中，扩展时需要在该模块中添加字段
- 如果需要在 `tree_root` 模块中管理，可以创建扩展 Schema 和 Service
- 数据库迁移需要添加到 `soil` 模块的迁移中，或创建新的迁移文件

### 2. 头像上传注意事项

**要点**：
- 头像文件通过文件管理模块上传
- `avatar` 字段存储文件UUID，不存储文件路径
- 前端需要调用文件管理API上传头像，然后更新 `avatar` 字段

### 3. 多租户支持

**要点**：
- 个人资料按组织隔离（通过用户表的 tenant_id）
- 用户只能查看和编辑自己的个人资料
- API 自动过滤当前用户，无需手动过滤

---

## 📚 相关文档

- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)

---

**最后更新**：2025-01-XX

