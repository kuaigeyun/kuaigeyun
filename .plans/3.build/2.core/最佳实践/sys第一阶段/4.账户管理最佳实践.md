# è´¦æˆ·ç®¡ç†æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šè´¦æˆ·ç®¡ç†ï¼ˆUser/Account Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­â­â­ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š1-2 å‘¨  
**ä¾èµ–**ï¼šè§’è‰²æƒé™ç®¡ç†ã€éƒ¨é—¨ç®¡ç†ã€èŒä½ç®¡ç†

**åŠŸèƒ½èŒƒå›´**ï¼š
- æ‰©å±•ç”¨æˆ·æ¨¡å‹ï¼ˆUserï¼‰
  - å…³è”éƒ¨é—¨ï¼ˆå¤–é”®ï¼‰
  - å…³è”èŒä½ï¼ˆå¤–é”®ï¼‰
  - å…³è”è§’è‰²ï¼ˆå¤šå¯¹å¤šï¼‰
- è´¦æˆ·ç®¡ç† APIï¼ˆCRUDã€æ‰¹é‡æ“ä½œï¼‰
- è´¦æˆ·å¯¼å…¥å¯¼å‡ºï¼ˆExcelï¼‰
- è´¦æˆ·è¯¦æƒ…é¡µé¢

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### Excel å¤„ç†åº“

#### æ–¹æ¡ˆä¸€ï¼šopenpyxl â­â­â­â­â­ï¼ˆæ¨èï¼‰

**ç®€ä»‹**ï¼šPython ä¸­æˆç†Ÿçš„ Excel å¤„ç†åº“ï¼Œæ”¯æŒè¯»å†™ `.xlsx` æ ¼å¼ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… æˆç†Ÿç¨³å®šï¼Œç¤¾åŒºæ´»è·ƒ
- âœ… æ”¯æŒè¯»å†™ Excel æ–‡ä»¶
- âœ… æ”¯æŒæ ·å¼ã€å…¬å¼ç­‰é«˜çº§åŠŸèƒ½
- âœ… æ–‡æ¡£å®Œå–„

**åŠ£åŠ¿**ï¼š
- âš ï¸ ä»…æ”¯æŒ `.xlsx` æ ¼å¼ï¼ˆä¸æ”¯æŒ `.xls`ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… Excel å¯¼å…¥å¯¼å‡º
- âœ… æ‰¹é‡æ•°æ®å¤„ç†

**å®ç°å¤æ‚åº¦**ï¼šâ­â­ï¼ˆç®€å•ï¼‰

**å®‰è£…**ï¼š
```bash
pip install openpyxl
```

**GitHub**ï¼šhttps://github.com/openpyxl/openpyxl  
**æ–‡æ¡£**ï¼šhttps://openpyxl.readthedocs.io/

---

#### æ–¹æ¡ˆäºŒï¼špandas âš ï¸ï¼ˆå¯é€‰ï¼‰

**ç®€ä»‹**ï¼šå¼ºå¤§çš„æ•°æ®åˆ†æåº“ï¼Œæ”¯æŒ Excel è¯»å†™ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒæ•°æ®åˆ†æ
- âœ… æ”¯æŒå¤šç§æ ¼å¼ï¼ˆExcelã€CSVã€JSON ç­‰ï¼‰

**åŠ£åŠ¿**ï¼š
- âš ï¸ ä¾èµ–è¾ƒé‡ï¼ˆå¦‚æœåªéœ€è¦ Excel è¯»å†™ï¼Œopenpyxl æ›´è½»é‡ï¼‰
- âš ï¸ å­¦ä¹ æˆæœ¬è¾ƒé«˜

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦æ•°æ®åˆ†æåŠŸèƒ½
- éœ€è¦å¤„ç†å¤§é‡æ•°æ®

**å®ç°å¤æ‚åº¦**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

---

### æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**æ¨è**ï¼šâœ… **ä½¿ç”¨ openpyxl**

**ç†ç”±**ï¼š
1. âœ… æˆç†Ÿç¨³å®šï¼Œä¸“é—¨ç”¨äº Excel å¤„ç†
2. âœ… è½»é‡çº§ï¼Œä¾èµ–å°‘
3. âœ… åŠŸèƒ½æ»¡è¶³éœ€æ±‚ï¼ˆå¯¼å…¥å¯¼å‡ºï¼‰
4. âœ… å­¦ä¹ æˆæœ¬ä½

**å¦‚æœæœªæ¥éœ€è¦æ•°æ®åˆ†æåŠŸèƒ½**ï¼Œå†è€ƒè™‘ä½¿ç”¨ pandasã€‚

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ç”¨æˆ·è¡¨æ‰©å±•ï¼ˆroot_usersï¼‰

**æ³¨æ„**ï¼šç”¨æˆ·è¡¨å·²å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

```sql
-- æ‰©å±•ç”¨æˆ·è¡¨ï¼Œæ·»åŠ éƒ¨é—¨å’ŒèŒä½å…³è”
ALTER TABLE root_users
ADD COLUMN department_id INTEGER,                    -- æ‰€å±éƒ¨é—¨IDï¼ˆå¤–é”®ï¼Œå…³è” root_departmentsï¼Œå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰
ADD COLUMN position_id INTEGER,                      -- æ‰€å±èŒä½IDï¼ˆå¤–é”®ï¼Œå…³è” root_positionsï¼Œå†…éƒ¨ä½¿ç”¨è‡ªå¢IDï¼‰
ADD COLUMN phone VARCHAR(20),                        -- æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰
ADD COLUMN avatar VARCHAR(255),                      -- å¤´åƒURLï¼ˆå¯é€‰ï¼‰
ADD COLUMN remark TEXT;                              -- å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_root_users_department_id ON root_users(department_id);
CREATE INDEX idx_root_users_position_id ON root_users(position_id);
CREATE INDEX idx_root_users_phone ON root_users(phone);

-- æ·»åŠ å¤–é”®
ALTER TABLE root_users
ADD CONSTRAINT fk_root_users_department 
FOREIGN KEY (department_id) REFERENCES root_departments(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_root_users_position 
FOREIGN KEY (position_id) REFERENCES root_positions(id) ON DELETE SET NULL;
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `department_id` å’Œ `position_id` å¯é€‰ï¼ˆç”¨æˆ·å¯ä»¥ä¸å…³è”éƒ¨é—¨æˆ–èŒä½ï¼‰
- âœ… `ON DELETE SET NULL`ï¼šåˆ é™¤éƒ¨é—¨æˆ–èŒä½æ—¶ï¼Œç”¨æˆ·çš„å…³è”å­—æ®µè®¾ä¸º `NULL`
- âœ… `phone` å­—æ®µç”¨äºæ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰
- âœ… `avatar` å­—æ®µç”¨äºå¤´åƒURLï¼ˆå¯é€‰ï¼‰
- âœ… `remark` å­—æ®µç”¨äºå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
- âš ï¸ **æ³¨æ„**ï¼šç”¨æˆ·å¯èƒ½è¢«å…³è”ä¸ºéƒ¨é—¨è´Ÿè´£äººï¼ˆé€šè¿‡ `root_departments.manager_id`ï¼‰ï¼Œè¿™æ˜¯å•å‘å…³è”ï¼Œåˆ é™¤ç”¨æˆ·æ—¶ï¼Œéƒ¨é—¨çš„ `manager_id` ä¼šè‡ªåŠ¨è®¾ä¸º `NULL`

### ç”¨æˆ·-è§’è‰²å…³è”è¡¨ï¼ˆroot_user_rolesï¼‰

**æ³¨æ„**ï¼šæ­¤è¡¨å·²åœ¨è§’è‰²æƒé™ç®¡ç†æ¨¡å—ä¸­è®¾è®¡ï¼Œè¿™é‡Œä»…ä½œè¯´æ˜ã€‚

```sql
CREATE TABLE root_user_roles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_root_user_roles_user_role UNIQUE (user_id, role_id),
    INDEX idx_root_user_roles_user_id (user_id),
    INDEX idx_root_user_roles_role_id (role_id),
    
    FOREIGN KEY (user_id) REFERENCES root_users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES root_roles(id) ON DELETE CASCADE
);
```

---

## ğŸ åç«¯æ¨¡å‹è®¾è®¡

### ç”¨æˆ·æ¨¡å‹æ‰©å±•ï¼ˆUserï¼‰

```python
# riveredge-backend/src/tree-root/models/user.py
from tortoise import fields
from soil.models.base import BaseModel

class User(BaseModel):
    """
    ç”¨æˆ·æ¨¡å‹ï¼ˆæ‰©å±•ï¼‰
    
    ç”¨äºç®¡ç† SaaS å¤šç»„ç»‡ç³»ç»Ÿä¸­çš„ç”¨æˆ·ä¿¡æ¯ã€‚
    æ”¯æŒå…³è”éƒ¨é—¨ã€èŒä½å’Œè§’è‰²ã€‚
    
    æ³¨æ„ï¼šç»§æ‰¿è‡ª BaseModelï¼Œè‡ªåŠ¨åŒ…å« uuidã€tenant_idã€created_atã€updated_at å­—æ®µã€‚
    """
    id = fields.IntField(pk=True, description="ç”¨æˆ·IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    # uuid å­—æ®µç”± BaseModel æä¾›ï¼Œæ— éœ€é‡å¤å®šä¹‰
    # tenant_id å­—æ®µç”± BaseModel æä¾›ï¼Œæ— éœ€é‡å¤å®šä¹‰
    
    # åŸºç¡€å­—æ®µï¼ˆå·²å­˜åœ¨ï¼‰
    username = fields.CharField(max_length=50, description="ç”¨æˆ·åï¼ˆç»„ç»‡å†…å”¯ä¸€ï¼‰")
    email = fields.CharField(max_length=255, null=True, description="ç”¨æˆ·é‚®ç®±ï¼ˆå¯é€‰ï¼‰")
    password_hash = fields.CharField(max_length=255, description="å¯†ç å“ˆå¸Œå€¼ï¼ˆä½¿ç”¨ bcrypt åŠ å¯†ï¼‰")
    full_name = fields.CharField(max_length=100, null=True, description="ç”¨æˆ·å…¨åï¼ˆå¯é€‰ï¼‰")
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦æ¿€æ´»")
    is_platform_admin = fields.BooleanField(default=False, description="æ˜¯å¦ä¸ºå¹³å°ç®¡ç†")
    is_tenant_admin = fields.BooleanField(default=False, description="æ˜¯å¦ä¸ºç»„ç»‡ç®¡ç†å‘˜")
    source = fields.CharField(max_length=50, null=True, description="ç”¨æˆ·æ¥æº")
    last_login = fields.DatetimeField(null=True, description="æœ€åç™»å½•æ—¶é—´")
    
    # æ‰©å±•å­—æ®µï¼ˆæ–°å¢ï¼‰
    department = fields.ForeignKeyField(
        "models.Department",
        related_name="users",
        null=True,
        description="æ‰€å±éƒ¨é—¨ï¼ˆå¤–é”®ï¼Œå…³è” Departmentï¼Œå¯é€‰ï¼‰"
    )
    position = fields.ForeignKeyField(
        "models.Position",
        related_name="users",
        null=True,
        description="æ‰€å±èŒä½ï¼ˆå¤–é”®ï¼Œå…³è” Positionï¼Œå¯é€‰ï¼‰"
    )
    phone = fields.CharField(max_length=20, null=True, description="æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰")
    avatar = fields.CharField(max_length=255, null=True, description="å¤´åƒURLï¼ˆå¯é€‰ï¼‰")
    remark = fields.TextField(null=True, description="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰")
    
    # å¤šå¯¹å¤šå…³ç³»ï¼šç”¨æˆ·-è§’è‰²
    roles = fields.ManyToManyField(
        "models.Role",
        related_name="users",
        through="root_user_roles",
        description="ç”¨æˆ·è§’è‰²ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰"
    )
    
    class Meta:
        table = "root_users"
        indexes = [
            ("tenant_id",),
            ("username",),
            ("tenant_id", "username"),
            ("department_id",),
            ("position_id",),
            ("phone",),
            ("is_platform_admin",),
        ]
        unique_together = [("tenant_id", "username")]
```

---

## ğŸ“¡ API è®¾è®¡

### è´¦æˆ·ç®¡ç† API

**è·¯ç”±å‰ç¼€**ï¼š`/api/v1/users`  
**Tags**ï¼š`Users`ï¼ˆè‹±æ–‡ï¼‰

#### 1.1 åˆ›å»ºè´¦æˆ·

```python
POST /api/v1/users

Request Body:
{
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "password": "password123",              // æ˜æ–‡å¯†ç ï¼ˆåç«¯åŠ å¯†ï¼‰
    "full_name": "å¼ ä¸‰",
    "phone": "13800138000",
    "department_uuid": "550e8400-e29b-41d4-a716-446655440000",  // å¯é€‰ï¼Œæ‰€å±éƒ¨é—¨UUID
    "position_uuid": "550e8400-e29b-41d4-a716-446655440001",    // å¯é€‰ï¼Œæ‰€å±èŒä½UUID
    "role_uuids": [                          // å¯é€‰ï¼Œè§’è‰²UUIDåˆ—è¡¨
        "550e8400-e29b-41d4-a716-446655440002"
    ],
    "is_active": true,
    "is_tenant_admin": false,
    "remark": "å¤‡æ³¨ä¿¡æ¯"
}

Response 201:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440003",
    "tenant_id": 1,
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "full_name": "å¼ ä¸‰",
    "phone": "13800138000",
    "department_id": 1,
    "department": {
        "id": 1,
        "uuid": "550e8400-e29b-41d4-a716-446655440000",
        "name": "æŠ€æœ¯éƒ¨"
    },
    "position_id": 1,
    "position": {
        "id": 1,
        "uuid": "550e8400-e29b-41d4-a716-446655440001",
        "name": "é«˜çº§å·¥ç¨‹å¸ˆ"
    },
    "roles": [
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440002",
            "name": "æ™®é€šç”¨æˆ·",
            "code": "user"
        }
    ],
    "is_active": true,
    "is_tenant_admin": false,
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è®¾ç½® `tenant_id`ï¼ˆä»å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–ï¼‰
- âœ… **è¯·æ±‚ä½“ä½¿ç”¨ `department_uuid`ã€`position_uuid`ã€`role_uuids`**ï¼ˆéœ€è¦åœ¨Serviceå±‚è½¬æ¢ä¸ºIDï¼‰
- âœ… éªŒè¯ `department_uuid`ã€`position_uuid`ã€`role_uuids` å±äºå½“å‰ç»„ç»‡
- âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†åå­˜å‚¨
- âœ… éœ€è¦ç»„ç»‡ç®¡ç†å‘˜æˆ–è¶…çº§ç”¨æˆ·æƒé™
- âœ… éªŒè¯ç”¨æˆ·ååœ¨ç»„ç»‡å†…å”¯ä¸€

#### 1.2 è·å–è´¦æˆ·åˆ—è¡¨

```python
GET /api/v1/users?page=1&page_size=20&keyword=å¼ ä¸‰&department_uuid=xxx&position_uuid=xxx&is_active=true

Response 200:
{
    "items": [
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440003",
            "username": "zhangsan",
            "email": "zhangsan@example.com",
            "full_name": "å¼ ä¸‰",
            "phone": "13800138000",
            "department": {
                "id": 1,
                "uuid": "550e8400-e29b-41d4-a716-446655440000",
                "name": "æŠ€æœ¯éƒ¨"
            },
            "position": {
                "id": 1,
                "uuid": "550e8400-e29b-41d4-a716-446655440001",
                "name": "é«˜çº§å·¥ç¨‹å¸ˆ"
            },
            "roles": [
                {
                    "id": 1,
                    "uuid": "550e8400-e29b-41d4-a716-446655440002",
                    "name": "æ™®é€šç”¨æˆ·",
                    "code": "user"
                }
            ],
            "is_active": true,
            "is_tenant_admin": false,
            "last_login": "2025-01-01T12:00:00"
        }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è¿‡æ»¤ç»„ç»‡ï¼ˆåªè¿”å›å½“å‰ç»„ç»‡çš„ç”¨æˆ·ï¼‰
- âœ… æ”¯æŒåˆ†é¡µï¼ˆ`page`, `page_size`ï¼‰
- âœ… æ”¯æŒå…³é”®è¯æœç´¢ï¼ˆ`keyword`ï¼šæœç´¢ç”¨æˆ·åã€é‚®ç®±ã€å…¨åã€æ‰‹æœºå·ï¼‰
- âœ… æ”¯æŒç­›é€‰ï¼ˆ`department_uuid`, `position_uuid`, `is_active`, `is_tenant_admin`ï¼‰
- âœ… é¢„åŠ è½½å…³è”æ•°æ®ï¼ˆéƒ¨é—¨ã€èŒä½ã€è§’è‰²ï¼‰

#### 1.3 è·å–è´¦æˆ·è¯¦æƒ…

```python
GET /api/v1/users/{user_uuid}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440003",
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "full_name": "å¼ ä¸‰",
    "phone": "13800138000",
    "avatar": "https://example.com/avatar.jpg",
    "department": {
        "id": 1,
        "uuid": "550e8400-e29b-41d4-a716-446655440000",
        "name": "æŠ€æœ¯éƒ¨"
    },
    "position": {
        "id": 1,
        "uuid": "550e8400-e29b-41d4-a716-446655440001",
        "name": "é«˜çº§å·¥ç¨‹å¸ˆ"
    },
    "roles": [
        {
            "id": 1,
            "uuid": "550e8400-e29b-41d4-a716-446655440002",
            "name": "æ™®é€šç”¨æˆ·",
            "code": "user"
        }
    ],
    "is_active": true,
    "is_tenant_admin": false,
    "remark": "å¤‡æ³¨ä¿¡æ¯",
    "last_login": "2025-01-01T12:00:00",
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-01-01T00:00:00"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{user_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{user_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… è¿”å›è´¦æˆ·å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…³è”çš„éƒ¨é—¨ã€èŒä½ã€è§’è‰²ï¼‰
- âœ… **ä¸è¿”å›å¯†ç å“ˆå¸Œå€¼**ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰

#### 1.4 æ›´æ–°è´¦æˆ·

```python
PUT /api/v1/users/{user_uuid}

Request Body:
{
    "email": "zhangsan_new@example.com",
    "full_name": "å¼ ä¸‰ï¼ˆæ›´æ–°ï¼‰",
    "phone": "13900139000",
    "department_uuid": "550e8400-e29b-41d4-a716-446655440001",  // å¯ä»¥ä¿®æ”¹
    "position_uuid": "550e8400-e29b-41d4-a716-446655440002",    // å¯ä»¥ä¿®æ”¹
    "role_uuids": [                                              // å¯ä»¥ä¿®æ”¹
        "550e8400-e29b-41d4-a716-446655440003"
    ],
    "is_active": true,
    "remark": "æ›´æ–°åçš„å¤‡æ³¨"
}

Response 200:
{
    "id": 1,
    "uuid": "550e8400-e29b-41d4-a716-446655440003",
    ...
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{user_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{user_id}`
- âœ… **è¯·æ±‚ä½“ä½¿ç”¨ `department_uuid`ã€`position_uuid`ã€`role_uuids`**ï¼ˆéœ€è¦åœ¨Serviceå±‚è½¬æ¢ä¸ºIDï¼‰
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… `username` ä¸å¯ä¿®æ”¹ï¼ˆç”¨äºç¨‹åºè¯†åˆ«ï¼‰
- âœ… `password` å•ç‹¬æ¥å£ä¿®æ”¹ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- âœ… æ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼ˆPydantic çš„ `exclude_unset=True`ï¼‰

#### 1.5 åˆ é™¤è´¦æˆ·

```python
DELETE /api/v1/users/{user_uuid}

Response 204: No Content
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{user_uuid}`ï¼‰ï¼Œè€Œä¸æ˜¯ `{user_id}`
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… å¹³å°ç®¡ç†å‘˜ä¸å¯åˆ é™¤ï¼ˆ`is_platform_admin=true`ï¼‰
- âœ… å½“å‰ç™»å½•ç”¨æˆ·ä¸å¯åˆ é™¤è‡ªå·±
- âœ… è½¯åˆ é™¤ï¼ˆè®¾ç½® `deleted_at`ï¼‰

#### 1.6 é‡ç½®å¯†ç 

```python
PUT /api/v1/users/{user_uuid}/password

Request Body:
{
    "password": "newpassword123"  // æ–°å¯†ç ï¼ˆæ˜æ–‡ï¼Œåç«¯åŠ å¯†ï¼‰
}

Response 200:
{
    "success": true,
    "message": "å¯†ç é‡ç½®æˆåŠŸ"
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… **ä½¿ç”¨ UUID ä½œä¸ºè·¯å¾„å‚æ•°**ï¼ˆ`{user_uuid}`ï¼‰
- âœ… è‡ªåŠ¨éªŒè¯ç»„ç»‡æƒé™
- âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†åå­˜å‚¨
- âœ… éœ€è¦ç»„ç»‡ç®¡ç†å‘˜æˆ–è¶…çº§ç”¨æˆ·æƒé™

#### 1.7 æ‰¹é‡å¯¼å…¥è´¦æˆ·

```python
POST /api/v1/users/import

Request Body (multipart/form-data):
{
    "file": <Excelæ–‡ä»¶>
}

Response 200:
{
    "success": true,
    "message": "å¯¼å…¥å®Œæˆ",
    "total": 100,
    "success_count": 95,
    "failure_count": 5,
    "errors": [
        {
            "row": 3,
            "error": "ç”¨æˆ·åå·²å­˜åœ¨"
        }
    ]
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `openpyxl` è§£æ Excel æ–‡ä»¶
- âœ… æ”¯æŒè¡¨å¤´æ˜ å°„ï¼ˆä¸­è‹±æ–‡ï¼‰
- âœ… æ”¯æŒæ•°æ®éªŒè¯ï¼ˆå¿…å¡«å­—æ®µã€æ ¼å¼éªŒè¯ç­‰ï¼‰
- âœ… æ‰¹é‡åˆ›å»ºè´¦æˆ·ï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰
- âœ… è¿”å›å¯¼å…¥ç»“æœï¼ˆæˆåŠŸæ•°ã€å¤±è´¥æ•°ã€é”™è¯¯åˆ—è¡¨ï¼‰

#### 1.8 å¯¼å‡ºè´¦æˆ·

```python
GET /api/v1/users/export?keyword=å¼ ä¸‰&department_uuid=xxx&format=xlsx

Response 200:
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="users_20250101.xlsx"

<Excelæ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®>
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `openpyxl` ç”Ÿæˆ Excel æ–‡ä»¶
- âœ… æ”¯æŒç­›é€‰æ¡ä»¶ï¼ˆä¸åˆ—è¡¨æ¥å£ä¸€è‡´ï¼‰
- âœ… åŒ…å«è¡¨å¤´å’Œæ•°æ®è¡Œ
- âœ… æ”¯æŒ `.xlsx` æ ¼å¼

#### 1.9 æ‰¹é‡æ“ä½œ

```python
POST /api/v1/users/batch

Request Body:
{
    "action": "activate",                    // æ“ä½œç±»å‹ï¼šactivateï¼ˆå¯ç”¨ï¼‰ã€deactivateï¼ˆç¦ç”¨ï¼‰ã€deleteï¼ˆåˆ é™¤ï¼‰
    "user_uuids": [                          // ç”¨æˆ·UUIDåˆ—è¡¨
        "550e8400-e29b-41d4-a716-446655440003",
        "550e8400-e29b-41d4-a716-446655440004"
    ]
}

Response 200:
{
    "success": true,
    "message": "æ‰¹é‡æ“ä½œå®Œæˆ",
    "success_count": 2,
    "failure_count": 0
}
```

**å®ç°è¦ç‚¹**ï¼š
- âœ… æ”¯æŒæ‰¹é‡å¯ç”¨ã€ç¦ç”¨ã€åˆ é™¤
- âœ… **è¯·æ±‚ä½“ä½¿ç”¨ `user_uuids`**ï¼ˆéœ€è¦åœ¨Serviceå±‚è½¬æ¢ä¸ºIDï¼‰
- âœ… éªŒè¯æ‰€æœ‰ç”¨æˆ·å±äºå½“å‰ç»„ç»‡
- âœ… è¿”å›æ“ä½œç»“æœï¼ˆæˆåŠŸæ•°ã€å¤±è´¥æ•°ï¼‰

---

## ğŸ”§ Service å±‚è®¾è®¡

### è´¦æˆ·æœåŠ¡ï¼ˆUserServiceï¼‰

```python
# riveredge-backend/src/tree-root/services/user_service.py
from typing import List, Optional, Dict, Any
from tortoise.exceptions import IntegrityError
from models.user import User
from models.department import Department
from models.position import Position
from models.role import Role
from schemas.user import UserCreate, UserUpdate
from core.exceptions import NotFoundError, ValidationError, PermissionDeniedError
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


class UserService:
    """
    è´¦æˆ·æœåŠ¡ç±»
    
    æä¾›è´¦æˆ·çš„ CRUD æ“ä½œã€å¯¼å…¥å¯¼å‡ºå’Œæ‰¹é‡æ“ä½œã€‚
    """
    
    @staticmethod
    async def create_user(
        tenant_id: int,
        data: UserCreate,
        current_user_id: int
    ) -> User:
        """
        åˆ›å»ºè´¦æˆ·
        
        Args:
            tenant_id: ç»„ç»‡ID
            data: è´¦æˆ·åˆ›å»ºæ•°æ®
            current_user_id: å½“å‰ç”¨æˆ·ID
            
        Returns:
            User: åˆ›å»ºçš„è´¦æˆ·å¯¹è±¡
            
        Raises:
            ValidationError: å½“ç”¨æˆ·åå·²å­˜åœ¨æˆ–å…³è”æ•°æ®æ— æ•ˆæ—¶æŠ›å‡º
            PermissionDeniedError: å½“ç”¨æˆ·æ— æƒé™æ—¶æŠ›å‡º
        """
        # éªŒè¯æƒé™
        # TODO: å®ç°æƒé™éªŒè¯é€»è¾‘
        
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        existing_user = await User.filter(
            tenant_id=tenant_id,
            username=data.username,
            deleted_at__isnull=True
        ).first()
        
        if existing_user:
            raise ValidationError(f"ç”¨æˆ·å {data.username} å·²å­˜åœ¨")
        
        # éªŒè¯éƒ¨é—¨ï¼ˆå¦‚æœæä¾›ï¼‰
        department_id = None
        if data.department_uuid:
            department = await Department.filter(
                uuid=data.department_uuid,
                tenant_id=tenant_id,
                deleted_at__isnull=True
            ).first()
            
            if not department:
                raise ValidationError("éƒ¨é—¨ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç»„ç»‡")
            
            department_id = department.id
        
        # éªŒè¯èŒä½ï¼ˆå¦‚æœæä¾›ï¼‰
        position_id = None
        if data.position_uuid:
            position = await Position.filter(
                uuid=data.position_uuid,
                tenant_id=tenant_id,
                deleted_at__isnull=True
            ).first()
            
            if not position:
                raise ValidationError("èŒä½ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç»„ç»‡")
            
            position_id = position.id
        
        # éªŒè¯è§’è‰²ï¼ˆå¦‚æœæä¾›ï¼‰
        role_ids = []
        if data.role_uuids:
            roles = await Role.filter(
                uuid__in=data.role_uuids,
                tenant_id=tenant_id,
                deleted_at__isnull=True
            ).all()
            
            if len(roles) != len(data.role_uuids):
                raise ValidationError("éƒ¨åˆ†è§’è‰²ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç»„ç»‡")
            
            role_ids = [role.id for role in roles]
        
        # åŠ å¯†å¯†ç 
        password_hash = pwd_context.hash(data.password)
        
        # åˆ›å»ºè´¦æˆ·
        user = await User.create(
            tenant_id=tenant_id,
            username=data.username,
            email=data.email,
            password_hash=password_hash,
            full_name=data.full_name,
            phone=data.phone,
            department_id=department_id,
            position_id=position_id,
            is_active=data.is_active if data.is_active is not None else True,
            is_tenant_admin=data.is_tenant_admin if data.is_tenant_admin is not None else False,
            remark=data.remark,
        )
        
        # åˆ†é…è§’è‰²
        if role_ids:
            roles = await Role.filter(id__in=role_ids).all()
            await user.roles.add(*roles)
        
        return user
    
    @staticmethod
    async def import_users_from_excel(
        tenant_id: int,
        file_path: str,
        current_user_id: int
    ) -> Dict[str, Any]:
        """
        ä» Excel æ–‡ä»¶å¯¼å…¥è´¦æˆ·
        
        Args:
            tenant_id: ç»„ç»‡ID
            file_path: Excel æ–‡ä»¶è·¯å¾„
            current_user_id: å½“å‰ç”¨æˆ·ID
            
        Returns:
            dict: å¯¼å…¥ç»“æœï¼ˆæˆåŠŸæ•°ã€å¤±è´¥æ•°ã€é”™è¯¯åˆ—è¡¨ï¼‰
        """
        from openpyxl import load_workbook
        
        # éªŒè¯æƒé™
        # TODO: å®ç°æƒé™éªŒè¯é€»è¾‘
        
        # è¯»å– Excel æ–‡ä»¶
        workbook = load_workbook(file_path)
        sheet = workbook.active
        
        # è§£æè¡¨å¤´ï¼ˆç¬¬ä¸€è¡Œï¼‰
        headers = [cell.value for cell in sheet[1]]
        
        # è¡¨å¤´å­—æ®µæ˜ å°„ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼‰
        header_map = {
            'ç”¨æˆ·å': 'username',
            '*ç”¨æˆ·å': 'username',
            'username': 'username',
            '*username': 'username',
            'é‚®ç®±': 'email',
            'email': 'email',
            'å¯†ç ': 'password',
            '*å¯†ç ': 'password',
            'password': 'password',
            '*password': 'password',
            'å§“å': 'full_name',
            'full_name': 'full_name',
            'æ‰‹æœºå·': 'phone',
            'phone': 'phone',
            'éƒ¨é—¨': 'department',
            'department': 'department',
            'èŒä½': 'position',
            'position': 'position',
            'è§’è‰²': 'roles',
            'roles': 'roles',
        }
        
        # æ‰¾åˆ°è¡¨å¤´ç´¢å¼•
        header_index_map = {}
        for idx, header in enumerate(headers):
            if header and str(header).strip():
                header_key = str(header).strip()
                if header_key in header_map:
                    header_index_map[header_map[header_key]] = idx
        
        # éªŒè¯å¿…å¡«å­—æ®µ
        required_fields = ['username', 'password']
        missing_fields = [f for f in required_fields if f not in header_index_map]
        if missing_fields:
            raise ValidationError(f"ç¼ºå°‘å¿…å¡«å­—æ®µï¼š{', '.join(missing_fields)}")
        
        # è§£ææ•°æ®è¡Œï¼ˆä»ç¬¬äºŒè¡Œå¼€å§‹ï¼Œè·³è¿‡è¡¨å¤´ï¼‰
        success_count = 0
        failure_count = 0
        errors = []
        
        for row_idx, row in enumerate(sheet.iter_rows(min_row=2, values_only=True), start=2):
            # è·³è¿‡ç©ºè¡Œ
            if not any(row):
                continue
            
            try:
                # è§£æè¡Œæ•°æ®
                user_data = {}
                for field, col_idx in header_index_map.items():
                    if col_idx < len(row):
                        value = row[col_idx]
                        if value is not None:
                            user_data[field] = str(value).strip()
                
                # éªŒè¯å¿…å¡«å­—æ®µ
                if not user_data.get('username') or not user_data.get('password'):
                    errors.append({
                        "row": row_idx,
                        "error": "ç”¨æˆ·åæˆ–å¯†ç ä¸ºç©º"
                    })
                    failure_count += 1
                    continue
                
                # å¤„ç†éƒ¨é—¨ï¼ˆé€šè¿‡åç§°æˆ–ä»£ç æŸ¥æ‰¾ï¼‰
                department_id = None
                if user_data.get('department'):
                    department = await Department.filter(
                        tenant_id=tenant_id,
                        deleted_at__isnull=True
                    ).filter(
                        Q(name=user_data['department']) | Q(code=user_data['department'])
                    ).first()
                    
                    if department:
                        department_id = department.id
                
                # å¤„ç†èŒä½ï¼ˆé€šè¿‡åç§°æˆ–ä»£ç æŸ¥æ‰¾ï¼‰
                position_id = None
                if user_data.get('position'):
                    position = await Position.filter(
                        tenant_id=tenant_id,
                        deleted_at__isnull=True
                    ).filter(
                        Q(name=user_data['position']) | Q(code=user_data['position'])
                    ).first()
                    
                    if position:
                        position_id = position.id
                
                # å¤„ç†è§’è‰²ï¼ˆé€šè¿‡åç§°æˆ–ä»£ç æŸ¥æ‰¾ï¼Œæ”¯æŒå¤šä¸ªï¼Œç”¨é€—å·åˆ†éš”ï¼‰
                role_ids = []
                if user_data.get('roles'):
                    role_names = [r.strip() for r in user_data['roles'].split(',')]
                    roles = await Role.filter(
                        tenant_id=tenant_id,
                        deleted_at__isnull=True
                    ).filter(
                        Q(name__in=role_names) | Q(code__in=role_names)
                    ).all()
                    
                    role_ids = [role.id for role in roles]
                
                # åˆ›å»ºè´¦æˆ·
                password_hash = pwd_context.hash(user_data['password'])
                
                user = await User.create(
                    tenant_id=tenant_id,
                    username=user_data['username'],
                    email=user_data.get('email'),
                    password_hash=password_hash,
                    full_name=user_data.get('full_name'),
                    phone=user_data.get('phone'),
                    department_id=department_id,
                    position_id=position_id,
                    is_active=True,
                )
                
                # åˆ†é…è§’è‰²
                if role_ids:
                    roles = await Role.filter(id__in=role_ids).all()
                    await user.roles.add(*roles)
                
                success_count += 1
                
            except Exception as e:
                errors.append({
                    "row": row_idx,
                    "error": str(e)
                })
                failure_count += 1
        
        return {
            "success": True,
            "message": "å¯¼å…¥å®Œæˆ",
            "total": success_count + failure_count,
            "success_count": success_count,
            "failure_count": failure_count,
            "errors": errors,
        }
    
    @staticmethod
    async def export_users_to_excel(
        tenant_id: int,
        filters: Dict[str, Any],
        current_user_id: int
    ) -> str:
        """
        å¯¼å‡ºè´¦æˆ·åˆ° Excel æ–‡ä»¶
        
        Args:
            tenant_id: ç»„ç»‡ID
            filters: ç­›é€‰æ¡ä»¶ï¼ˆä¸åˆ—è¡¨æ¥å£ä¸€è‡´ï¼‰
            current_user_id: å½“å‰ç”¨æˆ·ID
            
        Returns:
            str: Excel æ–‡ä»¶è·¯å¾„
        """
        from openpyxl import Workbook
        from datetime import datetime
        import os
        
        # éªŒè¯æƒé™
        # TODO: å®ç°æƒé™éªŒè¯é€»è¾‘
        
        # æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
        users = await UserService.get_user_list(
            tenant_id=tenant_id,
            page=1,
            page_size=10000,  # å¯¼å‡ºæ‰€æœ‰æ•°æ®
            **filters
        )
        
        # åˆ›å»ºå·¥ä½œç°¿
        workbook = Workbook()
        sheet = workbook.active
        sheet.title = "è´¦æˆ·åˆ—è¡¨"
        
        # å†™å…¥è¡¨å¤´
        headers = ['ç”¨æˆ·å', 'é‚®ç®±', 'å§“å', 'æ‰‹æœºå·', 'éƒ¨é—¨', 'èŒä½', 'è§’è‰²', 'çŠ¶æ€', 'ç»„ç»‡ç®¡ç†å‘˜', 'æœ€åç™»å½•']
        sheet.append(headers)
        
        # å†™å…¥æ•°æ®
        for user in users['items']:
            # é¢„åŠ è½½å…³è”æ•°æ®
            await user.fetch_related('department', 'position', 'roles')
            
            # æ ¼å¼åŒ–è§’è‰²ï¼ˆå¤šä¸ªè§’è‰²ç”¨é€—å·åˆ†éš”ï¼‰
            role_names = ', '.join([role.name for role in user.roles])
            
            row = [
                user.username,
                user.email or '',
                user.full_name or '',
                user.phone or '',
                user.department.name if user.department else '',
                user.position.name if user.position else '',
                role_names,
                'å¯ç”¨' if user.is_active else 'ç¦ç”¨',
                'æ˜¯' if user.is_tenant_admin else 'å¦',
                user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else '',
            ]
            sheet.append(row)
        
        # ä¿å­˜æ–‡ä»¶
        file_dir = os.path.join('temp', 'exports')
        os.makedirs(file_dir, exist_ok=True)
        
        filename = f"users_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        file_path = os.path.join(file_dir, filename)
        
        workbook.save(file_path)
        
        return file_path
```

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

### è´¦æˆ·ç®¡ç†é¡µé¢

**è·¯å¾„**ï¼š`/system/users`  
**ç»„ä»¶**ï¼š`UserManagementPage`

**åŠŸèƒ½**ï¼š
- âœ… è´¦æˆ·åˆ—è¡¨ï¼ˆä½¿ç”¨ `UniTable`ï¼‰
- âœ… åˆ›å»ºè´¦æˆ·ï¼ˆModal è¡¨å•ï¼‰
- âœ… ç¼–è¾‘è´¦æˆ·ï¼ˆModal è¡¨å•ï¼‰
- âœ… åˆ é™¤è´¦æˆ·ï¼ˆPopconfirm ç¡®è®¤ï¼‰
- âœ… æ‰¹é‡æ“ä½œï¼ˆå¯ç”¨ã€ç¦ç”¨ã€åˆ é™¤ï¼‰
- âœ… å¯¼å…¥è´¦æˆ·ï¼ˆä½¿ç”¨ `UniImport` ç»„ä»¶ï¼‰
- âœ… å¯¼å‡ºè´¦æˆ·
- âœ… é‡ç½®å¯†ç ï¼ˆModal è¡¨å•ï¼‰

**åˆ—å®šä¹‰**ï¼š
```typescript
const columns: ProColumns<User>[] = [
  {
    title: 'ç”¨æˆ·å',
    dataIndex: 'username',
    width: 120,
  },
  {
    title: 'å§“å',
    dataIndex: 'full_name',
    width: 120,
  },
  {
    title: 'é‚®ç®±',
    dataIndex: 'email',
    width: 180,
  },
  {
    title: 'æ‰‹æœºå·',
    dataIndex: 'phone',
    width: 120,
  },
  {
    title: 'éƒ¨é—¨',
    dataIndex: 'department_id',
    width: 120,
    hideInSearch: true,
    render: (_, record) => record.department?.name || '-',
  },
  {
    title: 'èŒä½',
    dataIndex: 'position_id',
    width: 120,
    hideInSearch: true,
    render: (_, record) => record.position?.name || '-',
  },
  {
    title: 'è§’è‰²',
    dataIndex: 'roles',
    width: 150,
    hideInSearch: true,
    render: (_, record) => (
      <Space>
        {record.roles?.map(role => (
          <Tag key={role.uuid}>{role.name}</Tag>
        ))}
      </Space>
    ),
  },
  {
    title: 'çŠ¶æ€',
    dataIndex: 'is_active',
    width: 100,
    valueType: 'switch',
    render: (_, record) => (
      <Tag color={record.is_active ? 'green' : 'default'}>
        {record.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}
      </Tag>
    ),
  },
  {
    title: 'ç»„ç»‡ç®¡ç†å‘˜',
    dataIndex: 'is_tenant_admin',
    width: 120,
    valueType: 'switch',
    render: (_, record) => (
      <Tag color={record.is_tenant_admin ? 'blue' : 'default'}>
        {record.is_tenant_admin ? 'æ˜¯' : 'å¦'}
      </Tag>
    ),
  },
  {
    title: 'æ“ä½œ',
    valueType: 'option',
    width: 250,
    render: (_, record) => [
      <Button key="edit" onClick={() => handleEdit(record)}>ç¼–è¾‘</Button>,
      <Button key="password" onClick={() => handleResetPassword(record)}>é‡ç½®å¯†ç </Button>,
      <Popconfirm
        key="delete"
        title="ç¡®å®šåˆ é™¤æ­¤è´¦æˆ·å—ï¼Ÿ"
        onConfirm={() => handleDelete(record.uuid)}
        disabled={record.is_platform_admin}
      >
        <Button danger disabled={record.is_platform_admin}>åˆ é™¤</Button>
      </Popconfirm>,
    ],
  },
];
```

**å¯¼å…¥é…ç½®**ï¼š
```typescript
// ä½¿ç”¨ UniTable çš„è‡ªåŠ¨å¯¼å…¥é…ç½®
<UniTable
  columns={columns}
  autoGenerateImportConfig={true}
  importFieldMap={{
    'ç”¨æˆ·å': 'username',
    'é‚®ç®±': 'email',
    'å¯†ç ': 'password',
    'å§“å': 'full_name',
    'æ‰‹æœºå·': 'phone',
    'éƒ¨é—¨': 'department',
    'èŒä½': 'position',
    'è§’è‰²': 'roles',
  }}
  importFieldRules={{
    username: { required: true },
    password: { required: true },
  }}
  onImport={handleImport}
/>
```

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

### æ•°æ®åº“è®¾è®¡
- [ ] æ‰©å±• `root_users` è¡¨ï¼ˆæ·»åŠ  `department_id`ã€`position_id`ã€`phone`ã€`avatar`ã€`remark`ï¼‰
- [ ] åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ç´¢å¼•
- [ ] åˆ›å»ºå¤–é”®çº¦æŸï¼ˆéƒ¨é—¨ã€èŒä½å…³è”ï¼‰

### åç«¯å®ç°
- [ ] æ‰©å±• `User` æ¨¡å‹ï¼ˆæ·»åŠ éƒ¨é—¨ã€èŒä½ã€è§’è‰²å…³è”ï¼‰
- [ ] åˆ›å»º `UserService` æœåŠ¡ç±»
- [ ] åˆ›å»ºè´¦æˆ·ç®¡ç† APIï¼ˆCRUDã€æ‰¹é‡æ“ä½œï¼‰
- [ ] å®ç°å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼ˆä½¿ç”¨ `openpyxl`ï¼‰
- [ ] å®ç°ç»„ç»‡éš”ç¦»ï¼ˆæ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨è¿‡æ»¤ `tenant_id`ï¼‰
- [ ] å®ç° UUID å’Œ ID è½¬æ¢é€»è¾‘

### å‰ç«¯å®ç°
- [ ] åˆ›å»ºè´¦æˆ·ç®¡ç†é¡µé¢
- [ ] åˆ›å»ºè´¦æˆ·è¡¨å•ç»„ä»¶ï¼ˆåˆ›å»º/ç¼–è¾‘ï¼‰
- [ ] åˆ›å»ºé‡ç½®å¯†ç ç»„ä»¶
- [ ] é›†æˆ `UniTable` ç»„ä»¶
- [ ] é›†æˆ `UniImport` ç»„ä»¶ï¼ˆå¯¼å…¥åŠŸèƒ½ï¼‰
- [ ] å®ç°æ‰¹é‡æ“ä½œåŠŸèƒ½
- [ ] å®ç°å¯¼å‡ºåŠŸèƒ½
- [ ] å®ç°æƒé™éªŒè¯ï¼ˆå‰ç«¯æ ¹æ®æƒé™æ˜¾ç¤º/éšè—åŠŸèƒ½ï¼‰

### æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•ï¼ˆService å±‚ï¼‰
- [ ] API æµ‹è¯•ï¼ˆé›†æˆæµ‹è¯•ï¼‰
- [ ] å¯¼å…¥å¯¼å‡ºåŠŸèƒ½æµ‹è¯•
- [ ] å‰ç«¯ç»„ä»¶æµ‹è¯•
- [ ] å¤šç»„ç»‡éš”ç¦»æµ‹è¯•

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. æ··åˆIDæ–¹æ¡ˆä½¿ç”¨è§„èŒƒ

**ç³»ç»Ÿä½¿ç”¨è‡ªå¢ID+UUIDæ··åˆæ–¹æ¡ˆ**ï¼š
- âœ… **`id`ï¼ˆè‡ªå¢IDï¼‰**ï¼šå†…éƒ¨ä½¿ç”¨ï¼Œç”¨äºæ•°æ®åº“å…³è”å’ŒæŸ¥è¯¢ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
- âœ… **`uuid`ï¼ˆUUIDï¼‰**ï¼šå¯¹å¤–æš´éœ²ï¼Œç”¨äºAPIè·¯å¾„å‚æ•°å’Œå“åº”ï¼ˆå®‰å…¨æ€§ä¼˜å…ˆï¼‰

**APIè®¾è®¡è§„èŒƒ**ï¼š
- âœ… è·¯å¾„å‚æ•°ä½¿ç”¨ `{user_uuid}`ï¼Œè€Œä¸æ˜¯ `{user_id}`
- âœ… è¯·æ±‚ä½“ä¸­çš„å…³è”å­—æ®µä½¿ç”¨ `department_uuid`ã€`position_uuid`ã€`role_uuids`ï¼ˆéœ€è¦åœ¨Serviceå±‚è½¬æ¢ä¸ºIDï¼‰
- âœ… å“åº”ä¸­åŒ…å« `uuid` å­—æ®µï¼ˆå¯¹å¤–æš´éœ²ï¼‰ï¼Œ`id` å­—æ®µä¿ç•™ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰

### 2. å¯†ç å®‰å…¨
- âœ… **å¯†ç ä¸è¿”å›**ï¼šAPI å“åº”ä¸­ä¸åŒ…å« `password_hash` å­—æ®µ
- âœ… **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨
- âœ… **å¯†ç é‡ç½®**ï¼šå•ç‹¬çš„æ¥å£ï¼Œéœ€è¦æƒé™éªŒè¯
- âœ… **å¯†ç å¼ºåº¦**ï¼šå»ºè®®å‰ç«¯éªŒè¯å¯†ç å¼ºåº¦ï¼ˆå¯é€‰ï¼‰

### 3. ç»„ç»‡éš”ç¦»
- âœ… æ‰€æœ‰æŸ¥è¯¢å¿…é¡»è‡ªåŠ¨è¿‡æ»¤ `tenant_id`
- âœ… æ‰€æœ‰åˆ›å»ºå¿…é¡»è‡ªåŠ¨è®¾ç½® `tenant_id`
- âœ… æ‰€æœ‰æ›´æ–°å¿…é¡»éªŒè¯ `tenant_id` æƒé™
- âœ… ç¦æ­¢è·¨ç»„ç»‡æ•°æ®è®¿é—®

### 4. åˆ é™¤ä¿æŠ¤
- âœ… å¹³å°ç®¡ç†å‘˜ä¸å¯åˆ é™¤ï¼ˆ`is_platform_admin=true`ï¼‰
- âœ… å½“å‰ç™»å½•ç”¨æˆ·ä¸å¯åˆ é™¤è‡ªå·±
- âœ… æ£€æŸ¥æ˜¯å¦è¢«å…³è”ä¸ºéƒ¨é—¨è´Ÿè´£äººï¼ˆ`root_departments.manager_id`ï¼‰ï¼Œå¦‚æœæœ‰ï¼Œè¿”å›é”™è¯¯æç¤º
- âœ… è½¯åˆ é™¤ï¼ˆè®¾ç½® `deleted_at`ï¼‰

### 5. å¯¼å…¥å¯¼å‡º
- âœ… ä½¿ç”¨ `openpyxl` å¤„ç† Excel æ–‡ä»¶
- âœ… æ”¯æŒè¡¨å¤´æ˜ å°„ï¼ˆä¸­è‹±æ–‡ï¼‰
- âœ… æ”¯æŒæ•°æ®éªŒè¯ï¼ˆå¿…å¡«å­—æ®µã€æ ¼å¼éªŒè¯ç­‰ï¼‰
- âœ… è¿”å›è¯¦ç»†çš„å¯¼å…¥ç»“æœï¼ˆæˆåŠŸæ•°ã€å¤±è´¥æ•°ã€é”™è¯¯åˆ—è¡¨ï¼‰
- âœ… å¯¼å‡ºæ”¯æŒç­›é€‰æ¡ä»¶ï¼ˆä¸åˆ—è¡¨æ¥å£ä¸€è‡´ï¼‰

### 6. æ€§èƒ½ä¼˜åŒ–
- âœ… ä½¿ç”¨ `prefetch_related` é¢„åŠ è½½å…³è”æ•°æ®ï¼ˆéƒ¨é—¨ã€èŒä½ã€è§’è‰²ï¼‰
- âœ… æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡
- âœ… å¯¼å…¥æ—¶æ‰¹é‡åˆ›å»ºï¼ˆé¿å…é€æ¡åˆ›å»ºï¼‰

### 7. ä»£ç è§„èŒƒ
- âœ… æ‰€æœ‰ä»£ç ä½¿ç”¨ä¸­æ–‡æ³¨é‡Š
- âœ… API Tags ä½¿ç”¨è‹±æ–‡ï¼ˆ`Users`ï¼‰
- âœ… API æè¿°ä½¿ç”¨ä¸­æ–‡ï¼ˆå‡½æ•°æ–‡æ¡£å­—ç¬¦ä¸²ï¼‰
- âœ… éµå¾ªå‘½åè§„èŒƒï¼ˆsnake_case/PascalCaseï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md](../ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½å®æ–½è·¯çº¿å›¾.md](../ç³»ç»Ÿçº§åŠŸèƒ½å®æ–½è·¯çº¿å›¾.md)
- [ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md](./ç³»ç»Ÿçº§åŠŸèƒ½æ–‡ä»¶ç»“æ„è§„åˆ’.md) - â­ æ–‡ä»¶ç»“æ„è§„åˆ’
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](./å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md) - â­ å‰ç«¯é¡µé¢å¼€å‘è§„èŒƒ
- [è§’è‰²æƒé™ç®¡ç†æœ€ä½³å®è·µ.md](./1.è§’è‰²æƒé™ç®¡ç†æœ€ä½³å®è·µ.md)
- [éƒ¨é—¨ç®¡ç†æœ€ä½³å®è·µ.md](./2.éƒ¨é—¨ç®¡ç†æœ€ä½³å®è·µ.md)
- [èŒä½ç®¡ç†æœ€ä½³å®è·µ.md](./3.èŒä½ç®¡ç†æœ€ä½³å®è·µ.md)
- [APIè®¾è®¡è§„èŒƒ.md](../../2.rules/6.APIè®¾è®¡è§„èŒƒ.md)
- [æ•°æ®åº“å‘½åè§„èŒƒ.md](../../2.rules/3.æ•°æ®åº“å‘½åè§„èŒƒ.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

