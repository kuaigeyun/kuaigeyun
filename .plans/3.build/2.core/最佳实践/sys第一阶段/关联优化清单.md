# 最佳实践关联优化清单

## 📋 概述

本文档记录了对所有最佳实践文档进行关联性检查后发现的优化点，以及已完成的优化工作。

---

## ✅ 已完成的优化

### 1. 相关文档引用完善

**问题**：各模块的相关文档引用不完整，缺少模块间的交叉引用。

**优化**：
- ✅ **角色权限管理**：添加了"其他模块依赖此模块"的说明
- ✅ **部门管理**：添加了账户管理的引用（因为部门负责人关联用户）
- ✅ **职位管理**：添加了账户管理的引用（因为职位关联用户）
- ✅ **账户管理**：已包含所有依赖模块的引用（无需优化）

### 2. 部门管理 manager_uuid 统一

**问题**：部门管理 API 设计中使用 `manager_uuid`，但 Service 层代码示例中使用 `data.manager_id`，不一致。

**优化**：
- ✅ 统一 API 设计：使用 `manager_uuid`（UUID）
- ✅ 统一 Service 层：将 `manager_uuid` 转换为 `manager_id`（ID）
- ✅ 在 API 设计说明中明确：请求体使用 `manager_uuid`，需要在Service层转换为ID

### 3. 删除保护逻辑完善

**问题**：删除保护逻辑需要明确说明所有关联检查。

**优化**：
- ✅ **部门删除**：检查子部门、检查用户（department_id）、检查部门负责人（manager_id）
- ✅ **职位删除**：检查用户（position_id）
- ✅ **角色删除**：检查用户（user_roles 关联表）
- ✅ **账户删除**：检查部门负责人（manager_id）、检查当前用户

### 4. 循环依赖说明

**问题**：部门管理和账户管理之间存在循环依赖（部门负责人关联用户，用户关联部门），需要明确说明。

**优化**：
- ✅ 在部门管理最佳实践中说明：`manager_id` 关联用户，但用户表扩展时不需要反向关联（单向关联即可）
- ✅ 在账户管理最佳实践中说明：用户可能被关联为部门负责人（通过 `manager_id`）

---

## 📊 模块关联关系图

```
角色权限管理（基础模块）
    ↓
    ├── 部门管理（依赖：角色权限管理）
    │   ├── 关联用户（manager_id，部门负责人）
    │   └── 关联用户（department_id，用户所属部门）
    │
    ├── 职位管理（依赖：部门管理）
    │   └── 关联用户（position_id，用户所属职位）
    │
    └── 账户管理（依赖：角色权限管理、部门管理、职位管理）
        ├── 关联部门（department_id）
        ├── 关联职位（position_id）
        └── 关联角色（user_roles 多对多）
```

---

## 🔗 外键关联汇总

### 1. 角色权限管理

| 关联表 | 外键字段 | 关联目标 | 删除策略 | 说明 |
|--------|----------|----------|----------|------|
| `root_role_permissions` | `role_id` | `root_roles(id)` | CASCADE | 角色-权限关联表 |
| `root_role_permissions` | `permission_id` | `root_permissions(id)` | CASCADE | 角色-权限关联表 |
| `root_user_roles` | `user_id` | `root_users(id)` | CASCADE | 用户-角色关联表 |
| `root_user_roles` | `role_id` | `root_roles(id)` | CASCADE | 用户-角色关联表 |

### 2. 部门管理

| 关联表 | 外键字段 | 关联目标 | 删除策略 | 说明 |
|--------|----------|----------|----------|------|
| `root_departments` | `parent_id` | `root_departments(id)` | SET NULL | 自关联，父部门 |
| `root_departments` | `manager_id` | `root_users(id)` | SET NULL | 部门负责人（可选） |

### 3. 职位管理

| 关联表 | 外键字段 | 关联目标 | 删除策略 | 说明 |
|--------|----------|----------|----------|------|
| `root_positions` | `department_id` | `root_departments(id)` | SET NULL | 所属部门（可选） |

### 4. 账户管理

| 关联表 | 外键字段 | 关联目标 | 删除策略 | 说明 |
|--------|----------|----------|----------|------|
| `root_users` | `department_id` | `root_departments(id)` | SET NULL | 所属部门（可选） |
| `root_users` | `position_id` | `root_positions(id)` | SET NULL | 所属职位（可选） |

---

## 📝 API 设计统一规范

### 1. 路径参数

**统一使用 UUID**：
- ✅ `{role_uuid}` - 角色UUID
- ✅ `{permission_uuid}` - 权限UUID
- ✅ `{department_uuid}` - 部门UUID
- ✅ `{position_uuid}` - 职位UUID
- ✅ `{user_uuid}` - 用户UUID

### 2. 请求体关联字段

**统一使用 UUID**：
- ✅ `parent_uuid` - 父部门UUID（部门管理）
- ✅ `manager_uuid` - 部门负责人UUID（部门管理）
- ✅ `department_uuid` - 部门UUID（职位管理、账户管理）
- ✅ `position_uuid` - 职位UUID（账户管理）
- ✅ `role_uuids` - 角色UUID列表（账户管理）
- ✅ `permission_uuids` - 权限UUID列表（角色权限管理）

### 3. Service 层转换

**统一转换逻辑**：
```python
# 示例：将 UUID 转换为 ID
if manager_uuid:
    manager = await User.get(uuid=manager_uuid, tenant_id=tenant_id)
    manager_id = manager.id  # 用于数据库关联
```

---

## ⚠️ 关键注意事项

### 1. 循环依赖处理

**部门管理和账户管理的循环依赖**：
- ✅ 部门 `manager_id` 关联用户（单向关联）
- ✅ 用户 `department_id` 关联部门（单向关联）
- ✅ 删除策略：`ON DELETE SET NULL`（避免级联删除问题）

### 2. 删除保护检查

**必须检查的关联**：
- ✅ **部门删除**：
  - 检查子部门（`parent_id`）
  - 检查用户（`department_id`）
  - 检查部门负责人（`manager_id`）
- ✅ **职位删除**：
  - 检查用户（`position_id`）
- ✅ **角色删除**：
  - 检查用户（`user_roles` 关联表）
- ✅ **账户删除**：
  - 检查部门负责人（`manager_id`）
  - 检查当前用户（不能删除自己）

### 3. 混合ID方案

**统一使用规范**：
- ✅ **`id`（自增ID）**：内部使用，用于数据库关联和查询（性能优先）
- ✅ **`uuid`（UUID）**：对外暴露，用于API路径参数和响应（安全性优先）
- ✅ **API 路径参数**：使用 `{xxx_uuid}`
- ✅ **请求体关联字段**：使用 `xxx_uuid` 或 `xxx_uuids`
- ✅ **Service 层转换**：将 UUID 转换为 ID 用于数据库关联

---

## 📚 相关文档

- [1.角色权限管理最佳实践.md](./1.角色权限管理最佳实践.md)
- [2.部门管理最佳实践.md](./2.部门管理最佳实践.md)
- [3.职位管理最佳实践.md](./3.职位管理最佳实践.md)
- [4.账户管理最佳实践.md](./4.账户管理最佳实践.md)
- [5.菜单管理最佳实践.md](./5.菜单管理最佳实践.md) ⏸️ 暂缓
- [第一阶段建设总结.md](./第一阶段建设总结.md)

---

**最后更新**：2025-01-XX

