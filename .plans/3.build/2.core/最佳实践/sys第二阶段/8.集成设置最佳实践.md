# é›†æˆè®¾ç½®æœ€ä½³å®è·µ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**æ¨¡å—åç§°**ï¼šé›†æˆè®¾ç½®ï¼ˆIntegration Settings Managementï¼‰  
**ä¼˜å…ˆçº§**ï¼šâ­â­â­â­ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰  
**é¢„è®¡æ—¶é—´**ï¼š2-3 å‘¨  
**ä¾èµ–**ï¼šå‚æ•°è®¾ç½®ï¼ˆé›†æˆé…ç½®æœ¬è´¨æ˜¯å‚æ•°ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- é›†æˆé…ç½®ç®¡ç†ï¼ˆCRUDï¼‰
- é›†æˆç±»å‹æ”¯æŒï¼ˆOAuthã€APIã€Webhookç­‰ï¼‰
- æµ‹è¯•è¿æ¥åŠŸèƒ½
- é›†æˆçŠ¶æ€ç®¡ç†

---

## ğŸ” åº“é€‰æ‹©è¯„ä¼°

### é›†æˆè®¾ç½®å®ç°æ–¹æ¡ˆ

**ç»“è®º**ï¼šâœ… **OAuth ä½¿ç”¨ authlibï¼ˆæ¨èï¼‰ï¼Œå…¶ä»–ä½¿ç”¨è‡ªå®šä¹‰å®ç°**

ç»è¿‡è°ƒç ”ï¼Œé›†æˆè®¾ç½®æ¶‰åŠå¤šç§é›†æˆç±»å‹ï¼š

#### OAuth é›†æˆï¼šauthlib â­â­â­â­â­ï¼ˆæ¨èï¼‰

**ç®€ä»‹**ï¼šauthlib æ˜¯ Python ç”Ÿæ€ä¸­æœ€æˆç†Ÿçš„ OAuth åº“ï¼Œæ”¯æŒ OAuth 1.0ã€OAuth 2.0 ç­‰ã€‚

**ä¼˜åŠ¿**ï¼š
- âœ… Python ç”Ÿæ€æœ€æˆç†Ÿçš„ OAuth åº“
- âœ… æ”¯æŒ OAuth 1.0ã€OAuth 2.0ã€OpenID Connect
- âœ… ä¸ FastAPI å®Œç¾é›†æˆ
- âœ… å®Œå–„çš„æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒ
- âœ… æ”¯æŒå¤šç§ OAuth æä¾›å•†ï¼ˆGoogleã€GitHubã€å¾®ä¿¡ç­‰ï¼‰

**åŠ£åŠ¿**ï¼š
- âš ï¸ éœ€è¦å­¦ä¹  OAuth åè®®ï¼ˆä½†æ–‡æ¡£å®Œå–„ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… éœ€è¦é›†æˆç¬¬ä¸‰æ–¹ OAuth æœåŠ¡ï¼ˆGoogleã€GitHubã€å¾®ä¿¡ç­‰ï¼‰
- âœ… éœ€è¦å®ç° OAuth æœåŠ¡å™¨
- âœ… éœ€è¦ OAuth å®¢æˆ·ç«¯åŠŸèƒ½

**å®ç°å¤æ‚åº¦**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼Œéœ€è¦äº†è§£ OAuth åè®®ï¼‰

**GitHub**ï¼šhttps://github.com/lepture/authlib  
**æ–‡æ¡£**ï¼šhttps://docs.authlib.org/

---

#### API/Webhook é›†æˆï¼šè‡ªå®šä¹‰å®ç° â­â­â­â­â­ï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… åŠŸèƒ½ç®€å•ï¼Œå®ç°æˆæœ¬ä½
- âœ… å·²æœ‰ httpxï¼ˆå¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼‰ï¼Œæ— éœ€é¢å¤–åº“
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒ
- âœ… å®Œå…¨æ§åˆ¶ï¼Œæ˜“äºå®šåˆ¶å’Œæ‰©å±•

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ç®€å•çš„ API è°ƒç”¨
- âœ… Webhook æ¥æ”¶å’Œå‘é€
- âœ… è‡ªå®šä¹‰é›†æˆéœ€æ±‚

**å®ç°å¤æ‚åº¦**ï¼šâ­â­ï¼ˆç®€å•ï¼Œå·²æœ‰ httpx æ”¯æŒï¼‰

---

#### æ•°æ®åº“é›†æˆï¼šè‡ªå®šä¹‰å®ç° â­â­â­â­â­ï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… åŠŸèƒ½ç®€å•ï¼Œå®ç°æˆæœ¬ä½
- âœ… å·²æœ‰ Tortoise ORMï¼Œæ”¯æŒå¤šç§æ•°æ®åº“
- âœ… å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒ
- âœ… å®Œå…¨æ§åˆ¶ï¼Œæ˜“äºå®šåˆ¶å’Œæ‰©å±•

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… è¿æ¥å¤–éƒ¨æ•°æ®åº“
- âœ… æ•°æ®åŒæ­¥éœ€æ±‚

**å®ç°å¤æ‚åº¦**ï¼šâ­â­ï¼ˆç®€å•ï¼Œå·²æœ‰ Tortoise ORM æ”¯æŒï¼‰

---

### æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**æ¨è**ï¼š
- âœ… **OAuth é›†æˆ**ï¼šä½¿ç”¨ **authlib** â­ **æ¨è**
- âœ… **API/Webhook é›†æˆ**ï¼šä½¿ç”¨ **è‡ªå®šä¹‰å®ç°**ï¼ˆå·²æœ‰ httpxï¼‰
- âœ… **æ•°æ®åº“é›†æˆ**ï¼šä½¿ç”¨ **è‡ªå®šä¹‰å®ç°**ï¼ˆå·²æœ‰ Tortoise ORMï¼‰

**ç†ç”±**ï¼š
1. âœ… **OAuth åè®®å¤æ‚**ï¼Œä½¿ç”¨æˆç†Ÿåº“ï¼ˆauthlibï¼‰é™ä½å®ç°æˆæœ¬
2. âœ… **API/Webhook åŠŸèƒ½ç®€å•**ï¼Œå·²æœ‰ httpxï¼Œæ— éœ€é¢å¤–åº“
3. âœ… **æ•°æ®åº“é›†æˆåŠŸèƒ½ç®€å•**ï¼Œå·²æœ‰ Tortoise ORMï¼Œæ— éœ€é¢å¤–åº“
4. âœ… **å¤šç§Ÿæˆ·æ˜¯æ ¸å¿ƒéœ€æ±‚**ï¼Œè‡ªå®šä¹‰å®ç°å¤©ç„¶æ”¯æŒ
5. âœ… **å®Œå…¨ç¬¦åˆæ¡†æ¶è§„èŒƒ**ï¼Œä»£ç é£æ ¼ç»Ÿä¸€

**æ‰€éœ€åº“**ï¼š
- **authlib** â­ **æ¨è**ï¼ˆOAuth é›†æˆï¼Œå¯é€‰ï¼Œä»…åœ¨éœ€è¦ OAuth æ—¶å®‰è£…ï¼‰
- **httpx**ï¼ˆå·²ä½¿ç”¨ï¼ŒAPI/Webhook é›†æˆï¼‰
- **Tortoise ORM**ï¼ˆå·²ä½¿ç”¨ï¼Œæ•°æ®åº“é›†æˆï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### é›†æˆé…ç½®è¡¨ï¼ˆroot_integration_configsï¼‰

```sql
CREATE TABLE root_integration_configs (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- ä¸šåŠ¡IDï¼ˆUUIDï¼Œå¯¹å¤–æš´éœ²ï¼Œå®‰å…¨ä¸”å”¯ä¸€ï¼‰
    tenant_id INTEGER NOT NULL,
    
    -- é›†æˆåŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL,              -- é›†æˆåç§°
    code VARCHAR(50) NOT NULL,                -- é›†æˆä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰
    type VARCHAR(20) NOT NULL,               -- é›†æˆç±»å‹ï¼šOAuthã€APIã€Webhookã€Databaseç­‰
    description TEXT,                         -- é›†æˆæè¿°
    
    -- é›†æˆé…ç½®ï¼ˆJSONï¼‰
    config JSONB NOT NULL DEFAULT '{}',      -- é…ç½®ä¿¡æ¯ï¼ˆJSON å­—æ®µï¼ŒåŒ…å«è¿æ¥ä¿¡æ¯ã€è®¤è¯ä¿¡æ¯ç­‰ï¼‰
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,          -- æ˜¯å¦å¯ç”¨
    is_connected BOOLEAN DEFAULT FALSE,     -- æ˜¯å¦å·²è¿æ¥
    last_connected_at TIMESTAMP,             -- æœ€åè¿æ¥æ—¶é—´
    last_error TEXT,                          -- æœ€åé”™è¯¯ä¿¡æ¯
    
    -- æ ‡å‡†å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- ç´¢å¼•
    CONSTRAINT uk_root_integration_configs_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_integration_configs_tenant_id (tenant_id),
    INDEX idx_root_integration_configs_uuid (uuid),
    INDEX idx_root_integration_configs_code (code),
    INDEX idx_root_integration_configs_type (type),
    INDEX idx_root_integration_configs_created_at (created_at)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- âœ… `type` æ”¯æŒå¤šç§é›†æˆç±»å‹ï¼ˆOAuthã€APIã€Webhookã€Databaseç­‰ï¼‰
- âœ… `config` JSONB å­—æ®µå­˜å‚¨é…ç½®ä¿¡æ¯ï¼ˆçµæ´»æ‰©å±•ï¼‰
- âœ… `is_connected` æ ‡è®°è¿æ¥çŠ¶æ€
- âœ… `last_connected_at` å’Œ `last_error` ç”¨äºçŠ¶æ€è¿½è¸ª

---

## ğŸ åç«¯æ¨¡å‹è®¾è®¡

### é›†æˆé…ç½®æ¨¡å‹ï¼ˆIntegrationConfigï¼‰

```python
# riveredge-backend/src/tree-root/models/integration_config.py
from tortoise.models import Model
from tortoise import fields
from tortoise.fields import JSONField
from typing import Dict, Any, Optional
from datetime import datetime
from .base import BaseModel


class IntegrationConfig(BaseModel):
    """
    é›†æˆé…ç½®æ¨¡å‹
    
    ç”¨äºç®¡ç†ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆé…ç½®ï¼Œæ”¯æŒå¤šç§é›†æˆç±»å‹ã€‚
    æ”¯æŒå¤šç»„ç»‡éš”ç¦»ï¼Œæ¯ä¸ªç»„ç»‡å¯ä»¥é…ç½®è‡ªå·±çš„é›†æˆã€‚
    
    æ³¨æ„ï¼šç»§æ‰¿è‡ª BaseModelï¼Œè‡ªåŠ¨åŒ…å« uuidã€tenant_idã€created_atã€updated_at å­—æ®µã€‚
    """
    id = fields.IntField(pk=True, description="é›†æˆé…ç½®IDï¼ˆä¸»é”®ï¼Œè‡ªå¢IDï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰")
    
    name = fields.CharField(max_length=100, description="é›†æˆåç§°")
    code = fields.CharField(max_length=50, description="é›†æˆä»£ç ï¼ˆå”¯ä¸€ï¼Œç”¨äºç¨‹åºè¯†åˆ«ï¼‰")
    type = fields.CharField(max_length=20, description="é›†æˆç±»å‹ï¼šOAuthã€APIã€Webhookã€Databaseç­‰")
    description = fields.TextField(null=True, description="é›†æˆæè¿°")
    
    config = JSONField(default={}, description="é…ç½®ä¿¡æ¯ï¼ˆJSONï¼‰")
    
    is_active = fields.BooleanField(default=True, description="æ˜¯å¦å¯ç”¨")
    is_connected = fields.BooleanField(default=False, description="æ˜¯å¦å·²è¿æ¥")
    last_connected_at = fields.DatetimeField(null=True, description="æœ€åè¿æ¥æ—¶é—´")
    last_error = fields.TextField(null=True, description="æœ€åé”™è¯¯ä¿¡æ¯")
    
    class Meta:
        table = "root_integration_configs"
        unique_together = [("tenant_id", "code")]
    
    def get_config(self) -> Dict[str, Any]:
        """è·å–é…ç½®ä¿¡æ¯"""
        return self.config or {}
    
    def set_config(self, config: Dict[str, Any]) -> None:
        """è®¾ç½®é…ç½®ä¿¡æ¯"""
        self.config = config
    
    def update_connection_status(self, is_connected: bool, error: Optional[str] = None) -> None:
        """æ›´æ–°è¿æ¥çŠ¶æ€"""
        self.is_connected = is_connected
        self.last_connected_at = datetime.now() if is_connected else self.last_connected_at
        self.last_error = error if error else None
```

---

## ğŸ”§ Service å±‚è®¾è®¡

### é›†æˆé…ç½®æœåŠ¡ï¼ˆIntegrationConfigServiceï¼‰

```python
# riveredge-backend/src/tree-root/services/integration_config_service.py
from typing import Optional, List, Dict, Any
from uuid import UUID
from tortoise.exceptions import IntegrityError
from fastapi import HTTPException, status
import httpx

from ..models.integration_config import IntegrationConfig
from ..schemas.integration_config import IntegrationConfigCreate, IntegrationConfigUpdate


class IntegrationConfigService:
    """é›†æˆé…ç½®æœåŠ¡"""
    
    @staticmethod
    async def create_integration(
        tenant_id: int,
        data: IntegrationConfigCreate
    ) -> IntegrationConfig:
        """åˆ›å»ºé›†æˆé…ç½®"""
        try:
            integration = await IntegrationConfig.create(
                tenant_id=tenant_id,
                **data.model_dump()
            )
            return integration
        except IntegrityError:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"é›†æˆä»£ç  {data.code} å·²å­˜åœ¨"
            )
    
    @staticmethod
    async def test_connection(
        tenant_id: int,
        uuid: UUID
    ) -> Dict[str, Any]:
        """
        æµ‹è¯•è¿æ¥
        
        Args:
            tenant_id: ç»„ç»‡ID
            uuid: é›†æˆé…ç½®UUID
            
        Returns:
            è¿æ¥æµ‹è¯•ç»“æœ
        """
        integration = await IntegrationConfig.get_or_none(
            tenant_id=tenant_id,
            uuid=uuid,
            deleted_at__isnull=True
        )
        if not integration:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="é›†æˆé…ç½®ä¸å­˜åœ¨"
            )
        
        try:
            # æ ¹æ®é›†æˆç±»å‹æµ‹è¯•è¿æ¥
            if integration.type == "API":
                result = await IntegrationConfigService._test_api_connection(integration)
            elif integration.type == "OAuth":
                result = await IntegrationConfigService._test_oauth_connection(integration)
            elif integration.type == "Webhook":
                result = await IntegrationConfigService._test_webhook_connection(integration)
            elif integration.type == "Database":
                result = await IntegrationConfigService._test_database_connection(integration)
            else:
                raise ValueError(f"ä¸æ”¯æŒçš„é›†æˆç±»å‹: {integration.type}")
            
            # æ›´æ–°è¿æ¥çŠ¶æ€
            integration.update_connection_status(True)
            await integration.save()
            
            return {
                "success": True,
                "message": "è¿æ¥æˆåŠŸ",
                "data": result
            }
        except Exception as e:
            # æ›´æ–°è¿æ¥çŠ¶æ€ï¼ˆå¤±è´¥ï¼‰
            integration.update_connection_status(False, str(e))
            await integration.save()
            
            return {
                "success": False,
                "message": f"è¿æ¥å¤±è´¥: {str(e)}",
                "error": str(e)
            }
    
    @staticmethod
    async def _test_api_connection(integration: IntegrationConfig) -> Dict[str, Any]:
        """æµ‹è¯• API è¿æ¥"""
        config = integration.get_config()
        url = config.get("url")
        method = config.get("method", "GET")
        headers = config.get("headers", {})
        
        async with httpx.AsyncClient() as client:
            response = await client.request(method, url, headers=headers, timeout=10.0)
            return {
                "status_code": response.status_code,
                "response": response.text[:200]  # é™åˆ¶å“åº”é•¿åº¦
            }
    
    @staticmethod
    async def _test_oauth_connection(integration: IntegrationConfig) -> Dict[str, Any]:
        """æµ‹è¯• OAuth è¿æ¥"""
        # å®ç° OAuth è¿æ¥æµ‹è¯•é€»è¾‘
        # ä¾‹å¦‚ï¼šè·å– access token
        return {"message": "OAuth è¿æ¥æµ‹è¯•æˆåŠŸ"}
    
    @staticmethod
    async def _test_webhook_connection(integration: IntegrationConfig) -> Dict[str, Any]:
        """æµ‹è¯• Webhook è¿æ¥"""
        # å®ç° Webhook è¿æ¥æµ‹è¯•é€»è¾‘
        # ä¾‹å¦‚ï¼šå‘é€æµ‹è¯•è¯·æ±‚
        return {"message": "Webhook è¿æ¥æµ‹è¯•æˆåŠŸ"}
    
    @staticmethod
    async def _test_database_connection(integration: IntegrationConfig) -> Dict[str, Any]:
        """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
        # å®ç°æ•°æ®åº“è¿æ¥æµ‹è¯•é€»è¾‘
        # ä¾‹å¦‚ï¼šä½¿ç”¨ SQLAlchemy æµ‹è¯•è¿æ¥
        return {"message": "æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ"}
```

---

## ğŸŒ API è®¾è®¡

### é›†æˆé…ç½® API

```python
# riveredge-backend/src/tree-root/api/integration_configs/integration_configs.py
from fastapi import APIRouter, Depends, Query
from typing import Optional, List
from uuid import UUID

from ....soil.api.deps import get_current_tenant
from ...schemas.integration_config import (
    IntegrationConfigCreate,
    IntegrationConfigUpdate,
    IntegrationConfigResponse
)
from ...services.integration_config_service import IntegrationConfigService

router = APIRouter(prefix="/integration-configs", tags=["é›†æˆè®¾ç½®"])


@router.post("", response_model=IntegrationConfigResponse, status_code=201)
async def create_integration(
    data: IntegrationConfigCreate,
    tenant_id: int = Depends(get_current_tenant)
):
    """åˆ›å»ºé›†æˆé…ç½®"""
    integration = await IntegrationConfigService.create_integration(tenant_id, data)
    return integration


@router.get("", response_model=List[IntegrationConfigResponse])
async def list_integrations(
    skip: int = Query(0, ge=0),
    limit: int = Query(100, ge=1, le=1000),
    type: Optional[str] = Query(None),
    is_active: Optional[bool] = Query(None),
    tenant_id: int = Depends(get_current_tenant)
):
    """è·å–é›†æˆé…ç½®åˆ—è¡¨"""
    # å®ç°åˆ—è¡¨æŸ¥è¯¢é€»è¾‘
    pass


@router.get("/{uuid}", response_model=IntegrationConfigResponse)
async def get_integration(
    uuid: UUID,
    tenant_id: int = Depends(get_current_tenant)
):
    """è·å–é›†æˆé…ç½®è¯¦æƒ…"""
    integration = await IntegrationConfig.get_or_none(
        tenant_id=tenant_id,
        uuid=uuid,
        deleted_at__isnull=True
    )
    if not integration:
        raise HTTPException(status_code=404, detail="é›†æˆé…ç½®ä¸å­˜åœ¨")
    return integration


@router.post("/{uuid}/test", response_model=Dict[str, Any])
async def test_connection(
    uuid: UUID,
    tenant_id: int = Depends(get_current_tenant)
):
    """æµ‹è¯•è¿æ¥"""
    result = await IntegrationConfigService.test_connection(tenant_id, uuid)
    return result
```

---

## ğŸ¨ å‰ç«¯é¡µé¢è®¾è®¡

**å‚è€ƒ**ï¼šå¤ç”¨ç¬¬ä¸€é˜¶æ®µçš„é¡µé¢å¸ƒå±€è§„èŒƒ

**åŠŸèƒ½**ï¼š
- é›†æˆé…ç½®åˆ—è¡¨ï¼ˆè¡¨æ ¼å±•ç¤ºï¼Œæ˜¾ç¤ºè¿æ¥çŠ¶æ€ï¼‰
- åˆ›å»ºé›†æˆé…ç½®ï¼ˆModalï¼Œæ ¹æ®ç±»å‹åŠ¨æ€é…ç½®è¡¨å•ï¼‰
- ç¼–è¾‘é›†æˆé…ç½®ï¼ˆModalï¼‰
- æµ‹è¯•è¿æ¥ï¼ˆæµ‹è¯•æŒ‰é’®ï¼Œæ˜¾ç¤ºè¿æ¥ç»“æœï¼‰
- è¿æ¥çŠ¶æ€æ˜¾ç¤ºï¼ˆæˆåŠŸ/å¤±è´¥æŒ‡ç¤ºå™¨ï¼‰

**é¡µé¢è·¯å¾„**ï¼š`riveredge-frontend/src/tree-stem/pages/system/integration-configs/list/index.tsx`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md](../ç³»ç»Ÿçº§åŠŸèƒ½å»ºè®¾è®¡åˆ’.md)
- [å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md](../sysç¬¬ä¸€é˜¶æ®µ/å‰ç«¯é¡µé¢å¸ƒå±€è§„èŒƒ.md)

---

**æœ€åæ›´æ–°**ï¼š2025-01-XX

