# 登录日志最佳实践

## 📋 模块概述

**模块名称**：登录日志（Login Log）  
**优先级**：⭐⭐⭐（中优先级）  
**预计时间**：1 周  
**依赖**：用户管理（需要用户信息）

**功能范围**：
- 登录日志记录（自动记录所有登录尝试）
- 登录日志查询（支持多维度查询和筛选）
- 登录日志导出（Excel、CSV）
- 登录统计（成功/失败统计、登录趋势图）

**核心特点**：
- ✅ **自动记录**：通过中间件自动记录所有登录尝试
- ✅ **详细记录**：记录登录用户、IP、设备、浏览器、登录状态等
- ✅ **安全监控**：支持登录失败统计、异常登录检测

---

## 🔍 库选择评估

### 登录日志实现方案

**结论**：✅ **使用独立登录日志表 + 自动记录中间件（推荐）**

#### 方案一：独立登录日志表 + 自动记录中间件 ⭐⭐⭐⭐⭐（强烈推荐）

**优势**：
- ✅ 数据分离，登录日志独立存储
- ✅ 自动记录，无需手动调用
- ✅ 详细记录，支持安全监控和问题排查
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）

**劣势**：
- ⚠️ 需要中间件实现，可能影响性能（需要异步记录）

**适用场景**：
- ✅ 需要登录安全监控
- ✅ 需要问题排查和追踪
- ✅ 需要多租户数据隔离

**实现复杂度**：⭐（简单，1 周可完成）

---

## 🗄️ 数据库设计

### 登录日志表（root_login_logs）

```sql
CREATE TABLE root_login_logs (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    user_id INTEGER,                          -- 登录用户ID（外键，登录失败时可能为空）
    
    -- 登录基本信息
    username VARCHAR(100),                    -- 登录账号（冗余字段，用于查询）
    login_ip VARCHAR(50) NOT NULL,           -- 登录IP
    login_location VARCHAR(200),              -- 登录地点（根据IP解析，可选）
    login_device VARCHAR(50),                 -- 登录设备（PC、Mobile等，可选）
    login_browser VARCHAR(200),               -- 登录浏览器（可选）
    
    -- 登录状态
    login_status VARCHAR(20) NOT NULL,       -- 登录状态（success、failed）
    failure_reason TEXT,                      -- 失败原因（登录失败时记录）
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_root_login_logs_tenant_id (tenant_id),
    INDEX idx_root_login_logs_user_id (user_id),
    INDEX idx_root_login_logs_uuid (uuid),
    INDEX idx_root_login_logs_username (username),
    INDEX idx_root_login_logs_login_ip (login_ip),
    INDEX idx_root_login_logs_login_status (login_status),
    INDEX idx_root_login_logs_created_at (created_at)
);
```

**设计要点**：
- ✅ **混合ID方案**：`id`（自增ID，内部使用）+ `uuid`（UUID，对外暴露）
- ✅ `user_id` 字段可能为空（登录失败时）
- ✅ `username` 字段冗余存储，用于查询（登录失败时也能查询）
- ✅ `login_status` 字段标识登录状态（success、failed）
- ✅ `failure_reason` 字段记录登录失败原因
- ✅ 不需要 `updated_at` 和 `deleted_at` 字段（日志不可修改和删除）

---

## 🔧 后端实现

### 1. 创建数据库模型

**文件位置**：`riveredge-backend/src/tree_root/models/login_log.py`

参考第四阶段的模型格式创建。

### 2. 创建 Schema

**文件位置**：`riveredge-backend/src/tree_root/schemas/login_log.py`

参考第四阶段的 Schema 格式创建。

### 3. 创建 Service

**文件位置**：`riveredge-backend/src/tree_root/services/login_log_service.py`

参考第四阶段的 Service 格式创建，包含：
- `create_login_log`：创建登录日志（由中间件调用）
- `list_login_logs`：获取登录日志列表（支持多维度筛选）
- `get_login_log_by_uuid`：获取登录日志详情
- `export_login_logs`：导出登录日志（Excel、CSV）
- `get_login_statistics`：获取登录统计（成功/失败统计、登录趋势）

### 4. 创建登录日志中间件

**文件位置**：`riveredge-backend/src/tree_root/middleware/login_log_middleware.py`

参考操作日志中间件的格式创建，在登录接口中记录登录日志。

### 5. 在登录接口中记录日志

**文件位置**：`riveredge-backend/src/soil/api/v1/auth.py`

```python
from tree_root.services.login_log_service import LoginLogService
from tree_root.schemas.login_log import LoginLogCreate

@router.post("/login")
async def login(
    form_data: OAuth2PasswordRequestForm = Depends(),
    request: Request = None,
):
    """
    用户登录
    
    记录登录日志（成功或失败）。
    """
    try:
        # 执行登录逻辑
        user = await authenticate_user(form_data.username, form_data.password)
        
        # 记录登录成功日志
        await LoginLogService.create_login_log(
            LoginLogCreate(
                tenant_id=user.tenant_id,
                user_id=user.id,
                username=form_data.username,
                login_ip=request.client.host if request.client else None,
                login_status="success",
                # ... 其他字段
            )
        )
        
        # 返回登录结果
        return {"access_token": token, "token_type": "bearer"}
    except Exception as e:
        # 记录登录失败日志
        await LoginLogService.create_login_log(
            LoginLogCreate(
                tenant_id=None,  # 登录失败时可能无法确定组织
                user_id=None,
                username=form_data.username,
                login_ip=request.client.host if request.client else None,
                login_status="failed",
                failure_reason=str(e),
                # ... 其他字段
            )
        )
        
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="用户名或密码错误"
        )
```

### 6. 创建 API

**文件位置**：`riveredge-backend/src/tree_root/api/login_logs/login_logs.py`

参考第四阶段的 API 格式创建，包含：
- `GET /`：获取登录日志列表（支持多维度筛选）
- `GET /{uuid}`：获取登录日志详情
- `GET /statistics`：获取登录统计（成功/失败统计、登录趋势）
- `GET /export`：导出登录日志（Excel、CSV）

### 7. 数据库迁移

**文件位置**：`riveredge-backend/migrations/models/XX_YYYYMMDDHHMMSS_create_login_logs.py`

参考第四阶段的迁移文件格式创建。

---

## 🌐 API 设计

### 登录日志管理 API

**路由前缀**：`/api/v1/system/login-logs`

**接口列表**：
1. `GET /` - 获取登录日志列表（支持多维度筛选）
2. `GET /{uuid}` - 获取登录日志详情
3. `GET /statistics` - 获取登录统计（成功/失败统计、登录趋势）
4. `GET /export` - 导出登录日志（Excel、CSV）

---

## 🎨 前端页面设计

### 登录日志页面

**页面路径**：`pages/system/login-logs/list/index.tsx`

**核心功能**：
1. 登录日志列表展示（UniTable，支持分页、排序）
2. 高级筛选（用户、登录状态、IP、时间范围）
3. 登录统计（成功/失败统计、登录趋势图）
4. 登录日志详情查看（Drawer 或 Modal）
5. 登录日志导出（Excel、CSV）

**布局规范**：
- ✅ 使用 `UniTable` 组件展示列表
- ✅ 使用高级搜索（`showAdvancedSearch={true}`）
- ✅ 使用 `searchFormValues` 获取搜索条件
- ✅ 登录统计使用 StatisticCard 或 Chart 组件展示
- ✅ 登录日志详情使用 Drawer 展示
- ✅ 导出功能使用 Button + Dropdown 实现

---

## ⚠️ 重要注意事项

### 1. 性能优化注意事项

**要点**：
- 登录日志记录应该异步执行，不阻塞登录请求
- 可以考虑批量写入日志，减少数据库压力
- 定期清理过期日志，避免数据量过大

### 2. 日志记录注意事项

**要点**：
- 记录所有登录尝试，包括成功和失败
- 记录登录环境信息（IP、设备、浏览器）
- 登录失败时记录失败原因
- 敏感信息（如密码）不应该记录

### 3. 安全监控注意事项

**要点**：
- 支持登录失败统计，检测暴力破解
- 支持异常登录检测（IP异常、设备异常等）
- 支持登录趋势分析，发现异常登录模式

### 4. 多租户支持

**要点**：
- 登录日志按组织隔离（tenant_id）
- 登录失败时可能无法确定组织（tenant_id 为空）
- 管理员可以查看组织内所有登录日志
- API 自动过滤当前组织，无需手动过滤

---

## 📚 相关文档

- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)

---

**最后更新**：2025-01-XX

