# 操作日志最佳实践

## 📋 模块概述

**模块名称**：操作日志（Operation Log）  
**优先级**：⭐⭐⭐（中优先级）  
**预计时间**：1 周  
**依赖**：无（独立功能）

**功能范围**：
- 操作日志记录（自动记录所有 API 操作）
- 操作日志查询（支持多维度查询和筛选）
- 操作日志导出（Excel、CSV）
- 操作日志统计（操作类型统计、操作模块统计）

**核心特点**：
- ✅ **自动记录**：通过中间件自动记录所有 API 操作
- ✅ **详细记录**：记录操作类型、操作模块、操作对象、操作内容等
- ✅ **多维度查询**：支持按用户、操作类型、操作模块、时间范围查询

---

## 🔍 库选择评估

### 操作日志实现方案

**结论**：✅ **使用独立操作日志表 + 自动记录中间件（推荐）**

#### 方案一：独立操作日志表 + 自动记录中间件 ⭐⭐⭐⭐⭐（强烈推荐）

**优势**：
- ✅ 数据分离，操作日志独立存储
- ✅ 自动记录，无需手动调用
- ✅ 详细记录，支持审计和问题排查
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）

**劣势**：
- ⚠️ 需要中间件实现，可能影响性能（需要异步记录）

**适用场景**：
- ✅ 需要完整的操作审计
- ✅ 需要问题排查和追踪
- ✅ 需要多租户数据隔离

**实现复杂度**：⭐⭐（简单，1 周可完成）

---

## 🗄️ 数据库设计

### 操作日志表（root_operation_logs）

```sql
CREATE TABLE root_operation_logs (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,                -- 操作用户ID（外键）
    
    -- 操作基本信息
    operation_type VARCHAR(50) NOT NULL,    -- 操作类型（create、update、delete、view等）
    operation_module VARCHAR(100),           -- 操作模块（用户管理、角色管理等）
    operation_object_type VARCHAR(100),      -- 操作对象类型（User、Role等）
    operation_object_id INTEGER,             -- 操作对象ID
    operation_object_uuid VARCHAR(36),      -- 操作对象UUID
    operation_content TEXT,                  -- 操作内容（操作描述）
    
    -- 操作环境信息
    ip_address VARCHAR(50),                 -- 操作IP
    user_agent TEXT,                         -- 用户代理（浏览器信息）
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_root_operation_logs_tenant_id (tenant_id),
    INDEX idx_root_operation_logs_user_id (user_id),
    INDEX idx_root_operation_logs_uuid (uuid),
    INDEX idx_root_operation_logs_operation_type (operation_type),
    INDEX idx_root_operation_logs_operation_module (operation_module),
    INDEX idx_root_operation_logs_operation_object_type (operation_object_type),
    INDEX idx_root_operation_logs_created_at (created_at)
);
```

**设计要点**：
- ✅ **混合ID方案**：`id`（自增ID，内部使用）+ `uuid`（UUID，对外暴露）
- ✅ `operation_type` 字段标识操作类型（create、update、delete、view等）
- ✅ `operation_module` 字段标识操作模块（用户管理、角色管理等）
- ✅ `operation_object_type` 和 `operation_object_id/uuid` 字段标识操作对象
- ✅ `ip_address` 和 `user_agent` 字段记录操作环境信息
- ✅ 不需要 `updated_at` 和 `deleted_at` 字段（日志不可修改和删除）

---

## 🔧 后端实现

### 1. 创建数据库模型

**文件位置**：`riveredge-backend/src/tree_root/models/operation_log.py`

参考第四阶段的模型格式创建。

### 2. 创建 Schema

**文件位置**：`riveredge-backend/src/tree_root/schemas/operation_log.py`

参考第四阶段的 Schema 格式创建。

### 3. 创建 Service

**文件位置**：`riveredge-backend/src/tree_root/services/operation_log_service.py`

参考第四阶段的 Service 格式创建，包含：
- `create_operation_log`：创建操作日志（由中间件调用）
- `list_operation_logs`：获取操作日志列表（支持多维度筛选）
- `get_operation_log_by_uuid`：获取操作日志详情
- `export_operation_logs`：导出操作日志（Excel、CSV）

### 4. 创建操作日志中间件

**文件位置**：`riveredge-backend/src/tree_root/middleware/operation_log_middleware.py`

```python
"""
操作日志中间件

自动记录所有 API 操作。
"""

from fastapi import Request, Response
from starlette.middleware.base import BaseHTTPMiddleware
from starlette.types import ASGIApp
import json
import asyncio

from tree_root.services.operation_log_service import OperationLogService
from tree_root.schemas.operation_log import OperationLogCreate


class OperationLogMiddleware(BaseHTTPMiddleware):
    """
    操作日志中间件
    
    自动记录所有 API 操作。
    """
    
    def __init__(self, app: ASGIApp):
        super().__init__(app)
        self.excluded_paths = [
            "/docs",
            "/redoc",
            "/openapi.json",
            "/health",
            "/operation-logs",  # 操作日志查询本身不记录
        ]
    
    async def dispatch(self, request: Request, call_next):
        """
        处理请求，记录操作日志
        
        Args:
            request: FastAPI 请求对象
            call_next: 下一个中间件或路由处理函数
            
        Returns:
            Response: FastAPI 响应对象
        """
        # 跳过排除的路径
        if any(request.url.path.startswith(path) for path in self.excluded_paths):
            return await call_next(request)
        
        # 获取当前用户和组织（从请求中提取）
        current_user = getattr(request.state, "current_user", None)
        tenant_id = getattr(request.state, "tenant_id", None)
        
        if not current_user or not tenant_id:
            return await call_next(request)
        
        # 执行请求
        response = await call_next(request)
        
        # 异步记录操作日志（不阻塞响应）
        asyncio.create_task(self._log_operation(
            request=request,
            response=response,
            user_id=current_user.id,
            tenant_id=tenant_id
        ))
        
        return response
    
    async def _log_operation(
        self,
        request: Request,
        response: Response,
        user_id: int,
        tenant_id: int
    ):
        """
        记录操作日志
        
        Args:
            request: FastAPI 请求对象
            response: FastAPI 响应对象
            user_id: 用户ID
            tenant_id: 组织ID
        """
        try:
            # 解析操作信息
            operation_type = self._parse_operation_type(request.method)
            operation_module = self._parse_operation_module(request.url.path)
            operation_object_type, operation_object_id, operation_object_uuid = self._parse_operation_object(request)
            
            # 获取操作内容
            operation_content = self._parse_operation_content(request, response)
            
            # 获取IP和用户代理
            ip_address = request.client.host if request.client else None
            user_agent = request.headers.get("user-agent")
            
            # 创建操作日志
            log_data = OperationLogCreate(
                tenant_id=tenant_id,
                user_id=user_id,
                operation_type=operation_type,
                operation_module=operation_module,
                operation_object_type=operation_object_type,
                operation_object_id=operation_object_id,
                operation_object_uuid=operation_object_uuid,
                operation_content=operation_content,
                ip_address=ip_address,
                user_agent=user_agent
            )
            
            await OperationLogService.create_operation_log(log_data)
        except Exception as e:
            # 记录日志失败不应该影响业务
            print(f"Failed to log operation: {e}")
    
    def _parse_operation_type(self, method: str) -> str:
        """解析操作类型"""
        method_map = {
            "GET": "view",
            "POST": "create",
            "PUT": "update",
            "PATCH": "update",
            "DELETE": "delete",
        }
        return method_map.get(method, "unknown")
    
    def _parse_operation_module(self, path: str) -> str:
        """解析操作模块"""
        # 从路径中提取模块名称
        # 例如：/api/v1/system/users -> 用户管理
        path_parts = path.split("/")
        if len(path_parts) >= 4:
            module_map = {
                "users": "用户管理",
                "roles": "角色管理",
                "departments": "部门管理",
                # ... 更多模块映射
            }
            return module_map.get(path_parts[3], path_parts[3])
        return "未知模块"
    
    def _parse_operation_object(self, request: Request) -> tuple:
        """解析操作对象"""
        # 从路径参数或请求体中提取操作对象信息
        # 例如：/api/v1/system/users/{uuid} -> (User, None, uuid)
        path_parts = request.url.path.split("/")
        if len(path_parts) >= 5:
            object_type = path_parts[3].capitalize()  # users -> User
            object_uuid = path_parts[4] if len(path_parts) > 4 else None
            return (object_type, None, object_uuid)
        return (None, None, None)
    
    def _parse_operation_content(self, request: Request, response: Response) -> str:
        """解析操作内容"""
        # 根据操作类型和模块生成操作描述
        operation_type = self._parse_operation_type(request.method)
        operation_module = self._parse_operation_module(request.url.path)
        return f"{operation_module} - {operation_type}"
```

### 5. 创建 API

**文件位置**：`riveredge-backend/src/tree_root/api/operation_logs/operation_logs.py`

参考第四阶段的 API 格式创建，包含：
- `GET /`：获取操作日志列表（支持多维度筛选）
- `GET /{uuid}`：获取操作日志详情
- `GET /export`：导出操作日志（Excel、CSV）

### 6. 注册中间件

**文件位置**：`riveredge-backend/src/maintree/main.py`

```python
from tree_root.middleware.operation_log_middleware import OperationLogMiddleware

app.add_middleware(OperationLogMiddleware)
```

### 7. 数据库迁移

**文件位置**：`riveredge-backend/migrations/models/XX_YYYYMMDDHHMMSS_create_operation_logs.py`

参考第四阶段的迁移文件格式创建。

---

## 🌐 API 设计

### 操作日志管理 API

**路由前缀**：`/api/v1/system/operation-logs`

**接口列表**：
1. `GET /` - 获取操作日志列表（支持多维度筛选）
2. `GET /{uuid}` - 获取操作日志详情
3. `GET /export` - 导出操作日志（Excel、CSV）

---

## 🎨 前端页面设计

### 操作日志页面

**页面路径**：`pages/system/operation-logs/list/index.tsx`

**核心功能**：
1. 操作日志列表展示（UniTable，支持分页、排序）
2. 高级筛选（用户、操作类型、操作模块、时间范围）
3. 操作日志详情查看（Drawer 或 Modal）
4. 操作日志导出（Excel、CSV）

**布局规范**：
- ✅ 使用 `UniTable` 组件展示列表
- ✅ 使用高级搜索（`showAdvancedSearch={true}`）
- ✅ 使用 `searchFormValues` 获取搜索条件
- ✅ 操作日志详情使用 Drawer 展示
- ✅ 导出功能使用 Button + Dropdown 实现

---

## ⚠️ 重要注意事项

### 1. 性能优化注意事项

**要点**：
- 操作日志记录应该异步执行，不阻塞业务请求
- 可以考虑批量写入日志，减少数据库压力
- 定期清理过期日志，避免数据量过大

### 2. 日志记录注意事项

**要点**：
- 记录所有 API 操作，包括查询操作
- 记录操作环境信息（IP、用户代理）
- 记录操作对象信息（对象类型、对象ID/UUID）
- 敏感操作需要记录详细内容

### 3. 多租户支持

**要点**：
- 操作日志按组织隔离（tenant_id）
- 管理员可以查看组织内所有操作日志
- API 自动过滤当前组织，无需手动过滤

---

## 📚 相关文档

- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)

---

**最后更新**：2025-01-XX

