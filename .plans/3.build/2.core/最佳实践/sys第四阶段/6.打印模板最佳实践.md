# 打印模板最佳实践

## 📋 模块概述

**模块名称**：打印模板（Print Template Management）  
**优先级**：⭐⭐（低优先级）  
**预计时间**：2-3 周  
**依赖**：无（独立功能）

**功能范围**：
- 打印模板定义（模板名称、类型、内容）
- 打印模板管理（CRUD、预览、打印）
- 打印模板设计器（可视化设计）
- 打印任务执行（可选集成 Inngest 异步执行）

**核心特点**：
- ✅ **可选集成 Inngest**：打印任务可以通过 Inngest 异步执行（可选）
- ✅ **支持多种模板类型**：PDF、HTML等

---

## 🔍 库选择评估

### 打印模板实现方案

**结论**：✅ **使用自定义实现 + reportlab + Inngest（可选）**

#### 方案一：自定义实现 + reportlab + Inngest ⭐⭐⭐⭐（推荐）

**优势**：
- ✅ 功能完整，支持 PDF 生成
- ✅ reportlab 支持 PDF 生成
- ✅ 可选集成 Inngest，支持异步打印任务
- ✅ 多租户隔离天然支持（tenant_id 字段）
- ✅ 完全符合框架规范（命名、注释、代码风格）

**实现复杂度**：⭐⭐⭐（中等，2-3 周可完成）

---

## 🗄️ 数据库设计

### 打印模板表（root_print_templates）

```sql
CREATE TABLE root_print_templates (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,        -- 业务ID（UUID，对外暴露，安全且唯一）
    tenant_id INTEGER NOT NULL,
    
    -- 模板基本信息
    name VARCHAR(100) NOT NULL,              -- 模板名称
    code VARCHAR(50) NOT NULL,                -- 模板代码（唯一，用于程序识别）
    description TEXT,                         -- 模板描述
    type VARCHAR(20) NOT NULL,               -- 模板类型（pdf、html等）
    
    -- 模板内容
    content TEXT NOT NULL,                   -- 模板内容（HTML 或 JSON）
    variables JSONB,                          -- 模板变量定义（JSON格式）
    
    -- 模板配置
    config JSONB,                             -- 模板配置（JSON格式，页面大小、边距等）
    
    -- 模板状态
    is_active BOOLEAN DEFAULT TRUE,          -- 是否启用
    
    -- 标准字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- 索引
    CONSTRAINT uk_root_print_templates_tenant_code UNIQUE (tenant_id, code),
    INDEX idx_root_print_templates_tenant_id (tenant_id),
    INDEX idx_root_print_templates_uuid (uuid),
    INDEX idx_root_print_templates_code (code),
    INDEX idx_root_print_templates_type (type),
    INDEX idx_root_print_templates_created_at (created_at)
);
```

---

## 🔧 PDF 生成

### 1. 使用 reportlab 生成 PDF

**文件位置**：`riveredge-backend/src/tree_root/services/print_template_service.py`

```python
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.units import mm

async def generate_pdf(template_content: str, variables: Dict[str, Any]) -> bytes:
    """
    生成 PDF
    
    Args:
        template_content: 模板内容
        variables: 模板变量
        
    Returns:
        PDF 字节流
    """
    # 创建 PDF 画布
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    
    # 渲染模板内容（根据模板内容生成 PDF）
    # ...
    
    # 保存 PDF
    c.save()
    buffer.seek(0)
    
    return buffer.getvalue()
```

### 2. 可选集成 Inngest（异步打印）

```python
from inngest import Event
from ..inngest.client import inngest_client

async def print_template_async(tenant_id: int, template_uuid: str, data: Dict[str, Any]) -> Dict[str, Any]:
    """
    异步打印模板（通过 Inngest）
    
    Args:
        tenant_id: 组织ID
        template_uuid: 模板UUID
        data: 打印数据
        
    Returns:
        打印任务ID（异步）
    """
    # 发送 Inngest 事件
    await inngest_client.send_event(
        event=Event(
            name="print/execute",
            data={
                "tenant_id": tenant_id,
                "template_uuid": template_uuid,
                "data": data
            }
        )
    )
    
    return {"success": True, "message": "打印任务已提交"}
```

---

## 🌐 API 设计

### 打印模板管理 API

**路由前缀**：`/api/tree-root/print-templates`

**接口列表**：
1. `POST /` - 创建打印模板
2. `GET /list` - 获取打印模板列表（分页、搜索、筛选）
3. `GET /{uuid}` - 获取打印模板详情
4. `PUT /{uuid}` - 更新打印模板
5. `DELETE /{uuid}` - 删除打印模板
6. `POST /{uuid}/preview` - 预览打印模板
7. `POST /{uuid}/print` - 打印模板（同步或异步）
8. `GET /{uuid}/print-tasks` - 获取打印任务列表

---

## 🎨 前端页面设计

### 打印模板管理页面

**页面路径**：`pages/system/print-templates/list/index.tsx`

**核心功能**：
1. 打印模板列表展示（UniTable，支持表格视图）
2. 打印模板创建/编辑（Modal + 模板设计器）
3. 打印模板预览（预览打印效果）
4. 打印模板打印（同步打印、异步打印）
5. 打印模板删除（单个删除、批量删除）
6. 打印模板搜索和筛选（按名称、类型）

### 打印模板设计器

**页面路径**：`pages/system/print-templates/designer/index.tsx`

**核心功能**：
1. 可视化模板设计器（拖拽组件、编辑属性）
2. 模板变量配置（定义模板变量）
3. 模板预览（实时预览打印效果）
4. 模板保存（保存到数据库）

---

## ⚠️ 重要注意事项

### 1. PDF 生成注意事项

**要点**：
- 使用 reportlab 生成 PDF，支持复杂布局
- 支持模板变量替换
- 支持页面大小、边距等配置

### 2. 多租户支持

**要点**：
- 打印模板按组织隔离
- 打印任务按组织隔离

---

## 📚 相关文档

- [Inngest 集成指南.md](./Inngest集成指南.md)
- [前端页面布局规范.md](./前端页面布局规范.md)
- [系统级功能文件结构规划.md](./系统级功能文件结构规划.md)
- [建设进度.md](./建设进度.md)

---

**最后更新**：2025-01-XX

