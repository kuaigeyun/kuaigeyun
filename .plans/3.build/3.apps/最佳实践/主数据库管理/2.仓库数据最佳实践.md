# 仓库数据最佳实践

## 📋 概述

本文档详细说明仓库数据模块（仓库、库区、库位）的开发最佳实践，结合 RiverEdge SaaS 框架规范和 DDD 应用层设计规范。

## 🎯 模块说明

仓库数据模块用于管理仓库的组织结构，采用三级层级结构：
- **仓库（Warehouse）**：仓库的最高层级组织单位
- **库区（Storage Area）**：仓库的子单位，属于某个仓库
- **库位（Storage Location）**：库区的子单位，属于某个库区

## 🏗️ 技术架构

### 后端架构（传统分层）

```
riveredge-backend/src/apps/master_data/
├── api/
│   └── warehouse.py                  # 仓库数据 API（仓库、库区、库位）
├── services/
│   └── warehouse_service.py         # 仓库数据服务
├── models/
│   └── warehouse.py                 # 仓库数据模型（仓库、库区、库位）
└── schemas/
    └── warehouse_schemas.py         # 仓库数据 Schema
```

### 前端架构

```
riveredge-frontend/src/apps/master_data/
├── pages/
│   └── warehouse/
│       ├── warehouses/              # 仓库管理页面
│       ├── storage-areas/          # 库区管理页面
│       └── storage-locations/      # 库位管理页面
├── services/
│   └── warehouse.ts                # 仓库数据 API 服务
└── types/
    └── warehouse.ts                # 仓库数据类型定义
```

## 📐 数据库设计规范

### 表命名规范

- ✅ **表名**：`seed_master_data_warehouses`、`seed_master_data_storage_areas`、`seed_master_data_storage_locations`
- ✅ **字段名**：`snake_case`（如 `warehouse_id`、`storage_area_id`）
- ✅ **索引名**：`idx_表名_字段名`（如 `idx_seed_master_data_warehouses_tenant_id`）

### 必须字段

所有表必须包含以下字段：

1. **组织隔离字段**
   - `tenant_id INTEGER NOT NULL` - 租户ID（必须）

2. **唯一标识字段**
   - `uuid VARCHAR(36) NOT NULL UNIQUE` - UUID（必须）
   - `id SERIAL PRIMARY KEY` - 自增主键（必须）

3. **编码字段**
   - `code VARCHAR(50) NOT NULL` - 编码（必须，组织内唯一）
   - `UNIQUE(tenant_id, code)` - 组织内编码唯一约束（必须）

4. **标准时间字段**
   - `created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP` - 创建时间（必须）
   - `updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP` - 更新时间（必须）
   - `deleted_at TIMESTAMP NULL` - 删除时间（软删除，可选）

5. **状态字段**
   - `is_active BOOLEAN DEFAULT TRUE` - 是否启用（必须）

### 外键关系

- **库区 → 仓库**：`storage_area.warehouse_id → warehouse.id`
- **库位 → 库区**：`storage_location.storage_area_id → storage_area.id`

### 索引设计

必须创建的索引：

1. **组织隔离索引**
   - `INDEX idx_tenant_id (tenant_id)` - 所有表必须

2. **唯一性索引**
   - `INDEX idx_uuid (uuid)` - 所有表必须
   - `INDEX idx_code (code)` - 所有表必须（配合唯一约束）

3. **外键索引**
   - `INDEX idx_warehouse_id (warehouse_id)` - 库区表必须
   - `INDEX idx_storage_area_id (storage_area_id)` - 库位表必须

## 💻 后端开发规范

### Model 层示例

```python
# models/warehouse.py
from tortoise.models import Model
from tortoise import fields
import uuid as uuid_lib


class Warehouse(Model):
    """仓库模型"""
    
    class Meta:
        table = "seed_master_data_warehouses"
        indexes = [
            ("tenant_id",),
            ("code",),
            ("uuid",),
        ]
    
    id = fields.IntField(pk=True, description="主键ID")
    uuid = fields.CharField(max_length=36, unique=True, default=lambda: str(uuid_lib.uuid4()), description="UUID")
    tenant_id = fields.IntField(description="租户ID")
    code = fields.CharField(max_length=50, description="仓库编码")
    name = fields.CharField(max_length=200, description="仓库名称")
    description = fields.TextField(null=True, description="描述")
    is_active = fields.BooleanField(default=True, description="是否启用")
    created_at = fields.DatetimeField(auto_now_add=True, description="创建时间")
    updated_at = fields.DatetimeField(auto_now=True, description="更新时间")
    deleted_at = fields.DatetimeField(null=True, description="删除时间")


class StorageArea(Model):
    """库区模型"""
    
    class Meta:
        table = "seed_master_data_storage_areas"
        indexes = [
            ("tenant_id",),
            ("code",),
            ("uuid",),
            ("warehouse_id",),
        ]
    
    id = fields.IntField(pk=True, description="主键ID")
    uuid = fields.CharField(max_length=36, unique=True, default=lambda: str(uuid_lib.uuid4()), description="UUID")
    tenant_id = fields.IntField(description="租户ID")
    code = fields.CharField(max_length=50, description="库区编码")
    name = fields.CharField(max_length=200, description="库区名称")
    warehouse_id = fields.IntField(description="所属仓库ID")
    description = fields.TextField(null=True, description="描述")
    is_active = fields.BooleanField(default=True, description="是否启用")
    created_at = fields.DatetimeField(auto_now_add=True, description="创建时间")
    updated_at = fields.DatetimeField(auto_now=True, description="更新时间")
    deleted_at = fields.DatetimeField(null=True, description="删除时间")
    
    warehouse = fields.ForeignKeyField(
        "models.Warehouse",
        related_name="storage_areas",
        description="所属仓库"
    )


class StorageLocation(Model):
    """库位模型"""
    
    class Meta:
        table = "seed_master_data_storage_locations"
        indexes = [
            ("tenant_id",),
            ("code",),
            ("uuid",),
            ("storage_area_id",),
        ]
    
    id = fields.IntField(pk=True, description="主键ID")
    uuid = fields.CharField(max_length=36, unique=True, default=lambda: str(uuid_lib.uuid4()), description="UUID")
    tenant_id = fields.IntField(description="租户ID")
    code = fields.CharField(max_length=50, description="库位编码")
    name = fields.CharField(max_length=200, description="库位名称")
    storage_area_id = fields.IntField(description="所属库区ID")
    description = fields.TextField(null=True, description="描述")
    is_active = fields.BooleanField(default=True, description="是否启用")
    created_at = fields.DatetimeField(auto_now_add=True, description="创建时间")
    updated_at = fields.DatetimeField(auto_now=True, description="更新时间")
    deleted_at = fields.DatetimeField(null=True, description="删除时间")
    
    storage_area = fields.ForeignKeyField(
        "models.StorageArea",
        related_name="storage_locations",
        description="所属库区"
    )
```

## ✅ 检查清单

### 开发前准备

- [ ] 确认数据库表结构设计
- [ ] 确认 API 接口设计
- [ ] 确认前端页面设计
- [ ] 确认权限设计

### 开发中

- [ ] 遵循命名规范
- [ ] 所有查询必须包含 `tenant_id` 过滤
- [ ] 所有表必须包含标准字段
- [ ] 所有编码字段必须组织内唯一
- [ ] 编写完整的注释（中文）
- [ ] 编写单元测试（覆盖率 > 80%）

### 开发后

- [ ] 完整功能测试
- [ ] 性能测试
- [ ] 文档完善
- [ ] 代码审查

## 📚 相关文档

- [主数据管理APP开发计划](./主数据管理APP开发计划.md)
- [工厂数据最佳实践](./1.工厂数据最佳实践.md)

---

**最后更新**：2025-01-11

