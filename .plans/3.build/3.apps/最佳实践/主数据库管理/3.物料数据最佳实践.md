# 物料数据最佳实践

## 📋 概述

本文档详细说明物料数据模块（物料分组、物料、BOM）的开发最佳实践，结合 RiverEdge SaaS 框架规范和 DDD 应用层设计规范。

## 🎯 模块说明

物料数据模块用于管理物料基础数据，包含：
- **物料分组（Material Group）**：物料的分类组织，支持层级结构
- **物料（Material）**：物料基础信息，支持多单位、批号、变体管理
- **BOM（Bill of Materials）**：物料清单，支持替代料管理

## 🏗️ 技术架构

### 后端架构（传统分层）

```
riveredge-backend/src/apps/master_data/
├── api/
│   └── material.py                   # 物料数据 API（分组、物料、BOM）
├── services/
│   └── material_service.py          # 物料数据服务
├── models/
│   └── material.py                  # 物料数据模型（分组、物料、BOM）
└── schemas/
    └── material_schemas.py          # 物料数据 Schema
```

## 📐 数据库设计规范

### 物料分组表（seed_master_data_material_groups）

```sql
CREATE TABLE seed_master_data_material_groups (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    parent_id INTEGER,                      -- 父分组ID（支持层级）
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE(tenant_id, code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_uuid (uuid),
    INDEX idx_parent_id (parent_id)
);
```

### 物料表（seed_master_data_materials）

```sql
CREATE TABLE seed_master_data_materials (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    group_id INTEGER,                       -- 物料分组ID
    specification VARCHAR(500),
    base_unit VARCHAR(20) NOT NULL,         -- 基础单位
    units JSONB,                            -- 多单位管理（JSON格式）
    batch_managed BOOLEAN DEFAULT FALSE,    -- 是否启用批号管理
    variant_managed BOOLEAN DEFAULT FALSE,   -- 是否启用变体管理
    variant_attributes JSONB,              -- 变体属性（JSON格式）
    description TEXT,
    brand VARCHAR(100),
    model VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    UNIQUE(tenant_id, code),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_uuid (uuid),
    INDEX idx_group_id (group_id)
);
```

### BOM表（seed_master_data_bom）

```sql
CREATE TABLE seed_master_data_bom (
    id SERIAL PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    tenant_id INTEGER NOT NULL,
    material_id INTEGER NOT NULL,          -- 主物料ID
    component_id INTEGER NOT NULL,          -- 子物料ID
    quantity DECIMAL(18, 4) NOT NULL,      -- 用量
    unit VARCHAR(20) NOT NULL,              -- 单位
    is_alternative BOOLEAN DEFAULT FALSE,   -- 是否为替代料
    alternative_group_id INTEGER,           -- 替代料组ID
    priority INTEGER DEFAULT 0,            -- 优先级
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_material_id (material_id),
    INDEX idx_component_id (component_id),
    INDEX idx_uuid (uuid),
    INDEX idx_alternative_group_id (alternative_group_id)
);
```

## 💻 后端开发规范

### Model 层示例

```python
# models/material.py
from tortoise.models import Model
from tortoise import fields
from tortoise.fields import JSONField
import uuid as uuid_lib


class MaterialGroup(Model):
    """物料分组模型（支持层级结构）"""
    
    class Meta:
        table = "seed_master_data_material_groups"
        indexes = [
            ("tenant_id",),
            ("code",),
            ("uuid",),
            ("parent_id",),
        ]
    
    id = fields.IntField(pk=True, description="主键ID")
    uuid = fields.CharField(max_length=36, unique=True, default=lambda: str(uuid_lib.uuid4()), description="UUID")
    tenant_id = fields.IntField(description="租户ID")
    code = fields.CharField(max_length=50, description="分组编码")
    name = fields.CharField(max_length=200, description="分组名称")
    parent_id = fields.IntField(null=True, description="父分组ID")
    description = fields.TextField(null=True, description="描述")
    is_active = fields.BooleanField(default=True, description="是否启用")
    created_at = fields.DatetimeField(auto_now_add=True, description="创建时间")
    updated_at = fields.DatetimeField(auto_now=True, description="更新时间")
    deleted_at = fields.DatetimeField(null=True, description="删除时间")
    
    parent = fields.ForeignKeyField(
        "models.MaterialGroup",
        related_name="children",
        null=True,
        description="父分组"
    )


class Material(Model):
    """物料模型"""
    
    class Meta:
        table = "seed_master_data_materials"
        indexes = [
            ("tenant_id",),
            ("code",),
            ("uuid",),
            ("group_id",),
        ]
    
    id = fields.IntField(pk=True, description="主键ID")
    uuid = fields.CharField(max_length=36, unique=True, default=lambda: str(uuid_lib.uuid4()), description="UUID")
    tenant_id = fields.IntField(description="租户ID")
    code = fields.CharField(max_length=50, description="物料编码")
    name = fields.CharField(max_length=200, description="物料名称")
    group_id = fields.IntField(null=True, description="物料分组ID")
    specification = fields.CharField(max_length=500, null=True, description="规格")
    base_unit = fields.CharField(max_length=20, description="基础单位")
    units = JSONField(null=True, description="多单位管理（JSON格式）")
    batch_managed = fields.BooleanField(default=False, description="是否启用批号管理")
    variant_managed = fields.BooleanField(default=False, description="是否启用变体管理")
    variant_attributes = JSONField(null=True, description="变体属性（JSON格式）")
    description = fields.TextField(null=True, description="描述")
    brand = fields.CharField(max_length=100, null=True, description="品牌")
    model = fields.CharField(max_length=100, null=True, description="型号")
    is_active = fields.BooleanField(default=True, description="是否启用")
    created_at = fields.DatetimeField(auto_now_add=True, description="创建时间")
    updated_at = fields.DatetimeField(auto_now=True, description="更新时间")
    deleted_at = fields.DatetimeField(null=True, description="删除时间")
    
    group = fields.ForeignKeyField(
        "models.MaterialGroup",
        related_name="materials",
        null=True,
        description="物料分组"
    )


class BOM(Model):
    """物料清单（BOM）模型"""
    
    class Meta:
        table = "seed_master_data_bom"
        indexes = [
            ("tenant_id",),
            ("material_id",),
            ("component_id",),
            ("uuid",),
            ("alternative_group_id",),
        ]
    
    id = fields.IntField(pk=True, description="主键ID")
    uuid = fields.CharField(max_length=36, unique=True, default=lambda: str(uuid_lib.uuid4()), description="UUID")
    tenant_id = fields.IntField(description="租户ID")
    material_id = fields.IntField(description="主物料ID")
    component_id = fields.IntField(description="子物料ID")
    quantity = fields.DecimalField(max_digits=18, decimal_places=4, description="用量")
    unit = fields.CharField(max_length=20, description="单位")
    is_alternative = fields.BooleanField(default=False, description="是否为替代料")
    alternative_group_id = fields.IntField(null=True, description="替代料组ID")
    priority = fields.IntField(default=0, description="优先级")
    description = fields.TextField(null=True, description="描述")
    is_active = fields.BooleanField(default=True, description="是否启用")
    created_at = fields.DatetimeField(auto_now_add=True, description="创建时间")
    updated_at = fields.DatetimeField(auto_now=True, description="更新时间")
    deleted_at = fields.DatetimeField(null=True, description="删除时间")
    
    material = fields.ForeignKeyField(
        "models.Material",
        related_name="bom_items",
        description="主物料"
    )
    
    component = fields.ForeignKeyField(
        "models.Material",
        related_name="used_in_bom",
        description="子物料"
    )
```

## ✅ 检查清单

### 开发前准备

- [ ] 确认数据库表结构设计
- [ ] 确认多单位管理数据结构（JSON格式）
- [ ] 确认变体管理数据结构（JSON格式）
- [ ] 确认BOM树形结构设计
- [ ] 确认替代料管理逻辑

### 开发中

- [ ] 遵循命名规范
- [ ] 所有查询必须包含 `tenant_id` 过滤
- [ ] 物料分组支持层级结构（parent_id）
- [ ] 物料支持多单位、批号、变体管理
- [ ] BOM支持替代料管理
- [ ] 编写完整的注释（中文）
- [ ] 编写单元测试（覆盖率 > 80%）

### 开发后

- [ ] 完整功能测试
- [ ] 性能测试（BOM树形查询）
- [ ] 文档完善
- [ ] 代码审查

## 📚 相关文档

- [主数据管理APP开发计划](./主数据管理APP开发计划.md)
- [工厂数据最佳实践](./1.工厂数据最佳实践.md)
- [仓库数据最佳实践](./2.仓库数据最佳实践.md)

---

**最后更新**：2025-01-11

