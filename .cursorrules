# RiverEdge SaaS 多组织框架 - Cursor AI 规则

⚠️ **每次对话开始时，AI 助手必须首先读取此文件！**

## 🚨 核心原则（绝对禁止违反）

### 0. 严禁使用 SQL 迁移数据库 ⭐⭐⭐ **绝对禁止违反！**
- ❌ **绝对禁止**使用 SQL 直接修改数据库结构（ALTER TABLE、CREATE TABLE、DROP TABLE 等）
- ❌ **绝对禁止**使用 SQL 直接修改数据库字段（RENAME COLUMN、ALTER COLUMN 等）
- ❌ **绝对禁止**使用 SQL 直接修改数据库索引（CREATE INDEX、DROP INDEX、ALTER INDEX 等）
- ❌ **绝对禁止**使用 SQL 直接修改数据库约束（ADD CONSTRAINT、DROP CONSTRAINT 等）
- ❌ **绝对禁止**使用 psql、pgAdmin 等工具直接执行 SQL 修改数据库
- ❌ **绝对禁止**使用 Python 脚本直接执行 SQL 修改数据库（必须通过 Aerich 工具）
- ✅ **必须使用** Aerich 工具进行所有数据库迁移操作
- ✅ **必须使用** `aerich upgrade` 命令执行迁移
- ✅ **必须使用** Tortoise ORM 的 `source_field` 参数映射字段名（如果数据库字段名与代码不一致）
- ✅ **必须使用** Aerich 迁移文件（`migrations/models/` 目录下的 Python 文件）进行数据库结构变更
- ✅ **必须使用** `aerich migrate` 命令生成迁移文件
- ⚠️ **遇到 Aerich 问题时**：必须修复 Aerich 配置和迁移文件格式，严禁绕过 Aerich 工具
- ⚠️ **唯一例外**：只有在 Aerich 无法完成的操作（如复杂的数据迁移、性能优化等），且经过明确授权后，才允许使用 SQL，但必须：
  - 创建对应的 Aerich 迁移文件记录此次 SQL 操作
  - 在迁移文件中添加详细注释说明为什么必须使用 SQL
  - 在 AI_MEMORY.md 中记录此次例外操作的原因
  - **仍然必须通过 `aerich upgrade` 执行迁移**

### 1. 禁止假设和猜测
- ❌ **绝对禁止**假设代码行为
- ❌ **绝对禁止**猜测用户需求  
- ❌ **绝对禁止**使用"等价"或"应该一样"的写法
- ✅ **必须**直接查看实际代码
- ✅ **必须**使用完全相同的值

### 2. 禁止擅作主张
- ❌ **绝对禁止**做用户没有明确要求的事
- ❌ **绝对禁止**"优化"、"改进"、"重新实现"
- ❌ **绝对禁止**认为自己的"优化"是用户想要的
- ✅ **必须**只做用户明确要求的事
- ✅ **必须**直接复制现有代码，不做任何改动

### 3. 禁止无效承诺
- ❌ **绝对禁止**承诺"会改正"（因为无法持久记忆）
- ❌ **绝对禁止**为了安抚用户而说假话
- ✅ **必须**承认无法保证下次不犯同样错误
- ✅ **必须**诚实说明自己的局限性

### 4. 禁止使用 PowerShell ⭐ **绝对禁止**
- ❌ **绝对禁止使用 PowerShell 进行任何操作**（全程严禁）
- ❌ 禁止使用 PowerShell 执行 Git 操作、文件操作、文本处理、脚本执行
- ✅ **必须使用** Git Bash 或 VS Code 进行所有操作
- ✅ **批量操作**必须使用 Python 脚本（Python 3 默认 UTF-8，编码稳定）

## 📋 工作流程（必须遵循）

### 当用户要求"设置到和XX一样"时：

1. **第一步：查看现有代码**
   - 找到用户提到的"XX"（如搜索框）
   - 查看它的完整样式代码
   - 记录所有相关的 CSS 属性

2. **第二步：直接复制**
   - 完全复制相同的样式值
   - 不做任何改动
   - 不做任何假设

3. **第三步：验证**
   - 确保所有值完全一致
   - 确保没有遗漏任何属性

### 当用户提出要求时：

1. **只做用户明确要求的事**
2. **不做任何额外的"优化"或"改进"**
3. **不做任何假设或猜测**

## 🔧 技术栈规范（必须严格遵循）

### 后端技术栈
- **编程语言**: Python 3.11 LTS（不得使用其他版本）
- **Web 框架**: FastAPI 0.110.0（不得使用 Flask、Django 等）
- **ORM 框架**: Tortoise ORM 0.21.1（不得使用 SQLAlchemy、Django ORM 等）
- **数据库**: PostgreSQL 15+（不得使用 MySQL、MongoDB 等）
- **数据库迁移**: Aerich 0.7+（不得使用 Alembic 等）
- **缓存**: Redis 7.2+（不得使用 Memcached 等）
- **Redis 客户端**: redis-py (redis>=5.0.0)，使用 `redis.asyncio` 异步接口（不得使用 aioredis 等）

### 前端技术栈
- **核心框架**: React 18.3.1（不得使用 Vue、Angular 等）
- **构建工具**: Vite 5.4.8（不得使用 Webpack 等）
- **路由管理**: React Router DOM 6.26.2（不得使用其他路由库）
- **状态管理**: Zustand 5.0.0（不得使用 Redux 等）
- **数据获取**: TanStack Query 5.51.1（不得使用 Axios、fetch 等）
- **表单管理**: React Hook Form 7.53.0（不得使用其他表单库）
- **UI 组件库**: Ant Design 6.1.0 + Ant Design Pro Components 2.8.2（不得使用 Material-UI、Element UI 等）
- **类型系统**: TypeScript 5.6.3（必须使用 TypeScript，不得使用 JavaScript）

## 📐 命名规范（必须严格遵循）

### 后端命名（Python）
- **文件命名**: `snake_case`（✅ `user.py`, `user_service.py`）
- **类命名**: `PascalCase`（✅ `User`, `UserService`）
- **函数命名**: `snake_case`，动词开头（✅ `create_user`, `get_user_by_id`）
- **变量命名**: `snake_case`（✅ `user_id`, `tenant_id`）
- **常量命名**: `UPPER_SNAKE_CASE`（✅ `MAX_RETRY_COUNT`）
- ❌ **禁止使用 Python 关键字**作为变量名、函数名、参数名

### 前端命名（TypeScript）
- **组件文件**: `PascalCase`（✅ `UserList.tsx`）
- **工具文件**: `camelCase`（✅ `userUtils.ts`）
- **组件命名**: `PascalCase`（✅ `UserList`, `UserForm`）
- **函数命名**: `camelCase`，动词开头（✅ `getUserList`, `createUser`）
- **变量命名**: `camelCase`（✅ `userId`, `tenantId`）
- **类型命名**: `PascalCase`（✅ `User`, `UserListResponse`）
- **目录命名**: 优先使用 `kebab-case`，兼容 `snake_case`（✅ `user-profile/`, `order-list/`，兼容 `user_profile/`）
- ❌ **禁止使用 TypeScript/JavaScript 关键字**作为变量名、函数名、参数名

### 数据库命名
- **表命名**: `snake_case`，复数形式，**必须包含模块前缀**（✅ `platform_tenants`, `core_users`, `seed_mes_orders`）
- **字段命名**: `snake_case`（✅ `user_id`, `tenant_id`, `created_at`）
- **索引命名**: 索引名中的表名必须包含模块前缀（✅ `idx_platform_tenants_domain`, `idx_core_users_tenant_id`）
- ❌ **禁止使用 PostgreSQL 关键字**作为表名、字段名、索引名
- ❌ **禁止表名缺少模块前缀**（必须包含 `platform_`、`core_` 或 `seed_插件名_` 前缀）

## 💬 注释规范（必须严格遵循）

- ✅ **所有代码必须包含完整的中文注释**
- ✅ **后端注释**: 使用三引号文档字符串，包含 Args、Returns、Raises 说明
- ✅ **前端注释**: 使用 JSDoc 格式，包含 @param、@returns、@example
- ❌ **禁止生成无注释的代码**
- ❌ **禁止使用英文注释**（必须使用中文）

## 🗄️ 数据库规范（必须严格遵循）

- ✅ **所有表必须包含 `tenant_id` 字段**（用于多组织隔离）
- ✅ **所有查询必须自动过滤组织**
- ✅ **表名必须包含模块前缀**（`platform_`、`core_`、`seed_插件名_`）
- ✅ **所有表必须包含标准时间字段**（`created_at`, `updated_at`, `deleted_at` 可选）

## 🔄 库选择优先级（必须遵循）

**开发新功能时，必须按照以下优先级顺序选择库**：

1. **Ant Design Pro Components** - 优先使用官方组件
2. **React** - 使用 React 官方库或 React 生态成熟库
3. **TanStack Query** - 使用 TanStack Query 官方功能
4. **Zustand** - 使用 Zustand 官方功能
5. **React Hook Form** - 使用 React Hook Form 官方功能
6. **React Router DOM** - 使用 React Router DOM 官方功能
7. **React i18next** - 使用 React i18next 官方功能
8. **FastAPI** - 使用 FastAPI 官方扩展或 FastAPI 生态成熟库
9. **Tortoise ORM** - 使用 Tortoise ORM 官方功能或扩展
10. **PostgreSQL** - 使用 PostgreSQL 原生功能或官方扩展

**原则**：
- ✅ 优先使用官方库
- ✅ 如果官方库不满足，优先查找成熟稳定的第三方库
- ⚠️ 只有在官方库和成熟库都无法满足需求时，才考虑自己实现

## 📖 API 设计规范（必须严格遵循）

- ✅ **API 路径必须使用 kebab-case**（多个单词使用连字符分隔，如 `/api/v1/system/user-roles`）
- ✅ **API Tags 必须使用英文**（如 `Authentication`, `Users`, `Roles`，多个单词使用空格分隔）
- ✅ **API 描述必须使用中文**（函数文档字符串）
- ✅ **所有 API 必须包含组织隔离验证**
- ✅ **JWT Token 必须包含组织信息**

## 🧪 测试规范（必须严格遵循）

- ✅ **后端测试文件**: 必须放在 `riveredge-backend/tests/` 目录下
- ✅ **前端测试文件**: 必须放在 `riveredge-frontend/tests/` 目录下（如果存在）
- ❌ **禁止在 `scripts/` 目录创建测试文件**
- ❌ **禁止在 `src/` 目录下新建 `tests/` 文件夹**
- ✅ **测试覆盖率要求**: 核心功能 > 80%，业务功能 > 70%

## 🔧 React 生态语法规范（必须严格遵循）

- ✅ **必须使用 React 18.3.1 + TypeScript 5.6.3 + 现代化 React 生态语法**
- ✅ **必须使用函数组件 + Hooks**（禁止使用类组件）
- ✅ **必须使用 useEffect**（禁止使用过时的生命周期方法）
- ❌ **禁止使用类组件**
- ❌ **禁止使用过时的生命周期方法**
- ❌ **禁止使用过时的 Context API**
- ❌ **禁止使用过时的 Ref API**

## 📚 详细规范文档

请参考以下文档获取完整的开发规范：
- `plans/2.rules/AGENTS.md` - ⭐ **AI 助手开发规范（完整版）**
- `plans/2.rules/1.统一命名规范.md` - 统一命名规范（Python + TypeScript）
- `plans/2.rules/2.注释规范.md` - 完善注释规范
- `plans/2.rules/3.错误处理规范.md` - 错误处理规范
- `plans/2.rules/4.Git工作流规范.md` - Git 工作流规范
- `plans/2.rules/5.品牌VI一致性规范.md` - 品牌VI一致性规范
- `plans/2.rules/6.第三方依赖管理规范.md` - 第三方依赖管理规范
- `plans/2.rules/7.页面开发标准模板规范.md` - 页面开发标准模板规范
- `plans/2.rules/8.Aerich数据库迁移规范.md` - ⭐ **Aerich 数据库迁移规范（严禁使用 SQL）**
- `plans/2.rules/AI_MEMORY.md` - AI 助手记忆和教训记录

---

**重要提醒：** 此文件会被 Cursor 自动读取，确保 AI 助手在每次对话时都能看到这些规则。所有代码生成、修改、建议都必须严格遵循以上规范。
